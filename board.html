<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOKLUCK ê²Œì‹œíŒ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        :root { --primary: #6366f1; --primary-light: #818cf8; --secondary: #06b6d4; --accent: #f59e0b; --success: #10b981; --danger: #ef4444; --pink: #ec4899; --bg-dark: #0a0a0f; --bg-card: #12121a; --bg-card-hover: #1a1a25; --border: #2a2a3a; --text: #f0f0f5; --text-muted: #8888a0; --gradient-primary: linear-gradient(135deg, #6366f1 0%, #06b6d4 100%); --gradient-gold: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%); }
        body { background-color: var(--bg-dark); color: var(--text); font-family: 'Noto Sans KR', sans-serif; min-height: 100vh; }
        .navbar { background: var(--bg-card); border-bottom: 1px solid var(--border); padding: 12px 20px; position: sticky; top: 0; z-index: 100; }
        .nav-container { max-width: 900px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 24px; font-weight: 900; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; cursor: pointer; text-decoration: none; }
        .wallet-badge { background: var(--bg-dark); padding: 8px 16px; border-radius: 50px; border: 1px solid var(--border); color: var(--secondary); font-weight: 700; font-size: 14px; }
        .container { max-width: 900px; margin: 0 auto; padding: 24px 20px; }
        .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 24px; margin-bottom: 20px; }
        button { cursor: pointer; border: none; border-radius: 10px; font-weight: 600; padding: 12px 20px; transition: all 0.2s; font-family: 'Noto Sans KR', sans-serif; font-size: 14px; }
        button:hover { transform: translateY(-1px); }
        button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-primary { background: var(--gradient-primary); color: white; }
        .btn-gold { background: var(--gradient-gold); color: #1a1a2e; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-sm { padding: 8px 14px; font-size: 13px; }
        .btn-block { width: 100%; }
        input, textarea, select { width: 100%; background: var(--bg-dark); border: 1px solid var(--border); color: var(--text); padding: 14px 16px; border-radius: 10px; font-size: 15px; font-family: 'Noto Sans KR', sans-serif; margin-bottom: 12px; }
        input:focus, textarea:focus { outline: none; border-color: var(--primary); }
        label { display: block; font-size: 13px; color: var(--text-muted); margin-bottom: 6px; }
        .back-btn { display: inline-flex; align-items: center; gap: 8px; color: var(--text-muted); text-decoration: none; font-size: 14px; margin-bottom: 20px; transition: color 0.2s; }
        .back-btn:hover { color: var(--text); }
        
        .board-header { display: flex; align-items: center; gap: 20px; margin-bottom: 24px; flex-wrap: wrap; }
        .board-icon { width: 64px; height: 64px; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 32px; flex-shrink: 0; }
        .board-title { font-size: 24px; font-weight: 900; margin-bottom: 4px; }
        .board-desc { color: var(--text-muted); font-size: 14px; }
        .board-meta { display: flex; gap: 16px; margin-top: 8px; font-size: 13px; color: var(--text-muted); }
        .board-actions { margin-left: auto; display: flex; gap: 8px; }

        .tabs { display: flex; gap: 4px; background: var(--bg-dark); padding: 4px; border-radius: 12px; margin-bottom: 20px; }
        .tab { flex: 1; padding: 10px; text-align: center; border-radius: 8px; font-weight: 600; font-size: 14px; cursor: pointer; color: var(--text-muted); transition: all 0.2s; }
        .tab.active { background: var(--bg-card); color: var(--text); }

        .post-item { display: flex; align-items: center; gap: 16px; padding: 16px; background: var(--bg-dark); border-radius: 12px; margin-bottom: 10px; cursor: pointer; border: 1px solid var(--border); transition: all 0.2s; }
        .post-item:hover { background: var(--bg-card-hover); border-color: var(--primary); }
        .post-thumb { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; background: var(--bg-card-hover); flex-shrink: 0; }
        .post-info { flex: 1; min-width: 0; }
        .post-title { font-weight: 700; margin-bottom: 4px; font-size: 15px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .post-meta { font-size: 12px; color: var(--text-muted); }
        .post-stats { display: flex; gap: 12px; font-size: 13px; color: var(--text-muted); flex-shrink: 0; }
        .post-stats span { display: flex; align-items: center; gap: 4px; }

        .post-content { line-height: 1.8; white-space: pre-wrap; margin: 24px 0; font-size: 15px; }
        .post-images { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; margin: 20px 0; }
        .post-images img { width: 100%; border-radius: 12px; cursor: pointer; transition: transform 0.2s; }
        .post-images img:hover { transform: scale(1.02); }
        .post-actions { display: flex; gap: 12px; padding: 16px 0; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); margin-bottom: 24px; flex-wrap: wrap; }
        .action-btn { display: flex; align-items: center; gap: 6px; padding: 8px 16px; background: var(--bg-dark); border-radius: 20px; font-size: 14px; cursor: pointer; transition: all 0.2s; border: 1px solid var(--border); }
        .action-btn:hover { background: var(--bg-card-hover); }
        .action-btn.liked { color: var(--danger); border-color: var(--danger); }

        .comment-section { margin-top: 24px; }
        .comment-input { display: flex; gap: 12px; margin-bottom: 20px; }
        .comment-input input { flex: 1; margin-bottom: 0; }
        .comment-item { display: flex; gap: 12px; padding: 16px; background: var(--bg-dark); border-radius: 12px; margin-bottom: 10px; }
        .comment-avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--gradient-primary); display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }
        .comment-content { flex: 1; }
        .comment-author { font-weight: 600; font-size: 14px; margin-bottom: 4px; }
        .comment-text { font-size: 14px; line-height: 1.5; }
        .comment-time { font-size: 12px; color: var(--text-muted); margin-top: 4px; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(8px); }
        .modal-content { background: var(--bg-card); padding: 32px; border-radius: 20px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; border: 1px solid var(--border); position: relative; }
        .modal-close { position: absolute; top: 16px; right: 16px; background: var(--bg-dark); border: none; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 18px; color: var(--text-muted); }
        .modal-title { font-size: 22px; font-weight: 900; margin-bottom: 20px; text-align: center; }

        .toggle-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border); }
        .toggle-switch { width: 48px; height: 26px; background: var(--bg-dark); border-radius: 13px; position: relative; cursor: pointer; transition: all 0.3s; }
        .toggle-switch.active { background: var(--success); }
        .toggle-switch::before { content: ''; position: absolute; top: 3px; left: 3px; width: 20px; height: 20px; background: white; border-radius: 50%; transition: all 0.3s; }
        .toggle-switch.active::before { left: 25px; }

        .hidden { display: none !important; }
        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-muted); }
        .empty-state .icon { font-size: 48px; margin-bottom: 16px; }

        .boost-badge { background: var(--gradient-gold); color: #1a1a2e; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 700; margin-left: 8px; }
        .has-image-badge { background: var(--secondary); color: white; padding: 2px 6px; border-radius: 8px; font-size: 10px; margin-left: 6px; }

        .entry-fee-notice { background: rgba(245,158,11,0.1); border: 1px solid rgba(245,158,11,0.3); border-radius: 12px; padding: 20px; text-align: center; margin-bottom: 20px; }
        .entry-fee-notice .amount { font-size: 24px; font-weight: 900; color: var(--accent); margin: 8px 0; }

        .image-upload-area { border: 2px dashed var(--border); border-radius: 12px; padding: 24px; text-align: center; cursor: pointer; transition: all 0.2s; margin-bottom: 12px; }
        .image-upload-area:hover { border-color: var(--primary); background: rgba(99,102,241,0.05); }
        .image-upload-area.dragover { border-color: var(--primary); background: rgba(99,102,241,0.1); }
        .image-preview-container { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 12px; }
        .image-preview-item { position: relative; width: 100px; height: 100px; }
        .image-preview-item img { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; }
        .image-preview-item .remove-btn { position: absolute; top: -8px; right: -8px; width: 24px; height: 24px; background: var(--danger); color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; }

        .image-viewer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .image-viewer img { max-width: 90%; max-height: 90%; object-fit: contain; }
        .image-viewer-close { position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.1); border: none; color: white; width: 48px; height: 48px; border-radius: 50%; font-size: 24px; cursor: pointer; }

        @media (max-width: 600px) {
            .board-header { flex-direction: column; text-align: center; }
            .board-actions { margin: 16px auto 0; }
            .post-thumb { width: 50px; height: 50px; }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="logo">BOKLUCK</a>
            <div class="wallet-badge" id="walletBadge">ğŸ’° ì—°ê²° í•„ìš”</div>
        </div>
    </nav>

    <div class="container">
        <a href="index.html" class="back-btn">â† ê²Œì‹œíŒ ëª©ë¡</a>

        <div class="entry-fee-notice hidden" id="entryFeeNotice">
            <p>ğŸ”’ ì´ ê²Œì‹œíŒì€ ì…ì¥ë£Œê°€ í•„ìš”í•©ë‹ˆë‹¤</p>
            <div class="amount" id="entryFeeAmount">0 BOK</div>
            <button class="btn-gold" onclick="payEntryFee()">ì…ì¥ë£Œ ì§€ë¶ˆí•˜ê¸°</button>
        </div>

        <div class="card" id="boardHeader">
            <div class="board-header">
                <div class="board-icon" id="boardIcon" style="background: #6366f1;">ğŸ“</div>
                <div style="flex: 1;">
                    <h1 class="board-title" id="boardTitle">ê²Œì‹œíŒ</h1>
                    <p class="board-desc" id="boardDesc">ì„¤ëª…</p>
                    <div class="board-meta">
                        <span>ğŸ‘¤ ë©¤ë²„ <strong id="memberCount">0</strong></span>
                        <span>ğŸ“ ê¸€ <strong id="postCount">0</strong></span>
                        <span id="ownerInfo">ì†Œìœ ì: -</span>
                    </div>
                </div>
                <div class="board-actions">
                    <button class="btn-sm btn-outline hidden" id="settingsBtn" onclick="openModal('settingsModal')">âš™ï¸</button>
                    <button class="btn-sm btn-primary" onclick="showWriteForm()">âœï¸ ê¸€ì“°ê¸°</button>
                </div>
            </div>
        </div>

        <div id="postListSection">
            <div class="tabs">
                <div class="tab active" data-sort="latest" onclick="changeSort('latest')">ìµœì‹ ìˆœ</div>
                <div class="tab" data-sort="popular" onclick="changeSort('popular')">ì¸ê¸°ìˆœ</div>
            </div>
            <div id="postList">
                <div class="empty-state"><div class="icon">â³</div><p>ë¡œë”© ì¤‘...</p></div>
            </div>
        </div>

        <div id="writeSection" class="hidden">
            <div class="card">
                <h3 style="margin-bottom: 20px;">ğŸ“ ìƒˆ ê¸€ ì‘ì„±</h3>
                <div id="writeFeeNotice" style="background: rgba(245,158,11,0.1); border: 1px solid rgba(245,158,11,0.3); border-radius: 10px; padding: 12px; margin-bottom: 16px; font-size: 14px; color: var(--accent); display: none;">
                    ğŸ’° ê¸€ì“°ê¸° ìˆ˜ìˆ˜ë£Œ <strong id="writeFeeAmount">0</strong> BOK
                </div>
                <label>ì œëª©</label>
                <input type="text" id="postTitle" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="100">
                
                <label>ğŸ“· ì´ë¯¸ì§€ ì²¨ë¶€ (ìµœëŒ€ 3ì¥)</label>
                <div class="image-preview-container" id="imagePreviewContainer"></div>
                <div class="image-upload-area" id="imageUploadArea" onclick="document.getElementById('imageInput').click()">
                    <div style="font-size: 32px; margin-bottom: 8px;">ğŸ“·</div>
                    <div style="color: var(--text-muted); font-size: 14px;">í´ë¦­í•˜ê±°ë‚˜ ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ì„¸ìš”</div>
                    <div style="color: var(--text-muted); font-size: 12px; margin-top: 4px;">JPG, PNG, GIF (ìµœëŒ€ 2MB)</div>
                </div>
                <input type="file" id="imageInput" accept="image/*" multiple style="display: none;" onchange="handleImageSelect(event)">
                
                <label>ë‚´ìš©</label>
                <textarea id="postContent" rows="8" placeholder="ë‚´ìš©ì„ ì‘ì„±í•˜ì„¸ìš” (ìµœì†Œ 10ì)"></textarea>
                <div style="display: flex; gap: 12px;">
                    <button class="btn-outline" style="flex: 1;" onclick="cancelWrite()">ì·¨ì†Œ</button>
                    <button class="btn-primary" style="flex: 2;" onclick="submitPost()">ë“±ë¡í•˜ê¸°</button>
                </div>
            </div>
        </div>

        <div id="viewSection" class="hidden">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px; flex-wrap: wrap; gap: 12px;">
                    <div style="flex: 1; min-width: 200px;">
                        <h2 id="viewTitle" style="font-size: 22px; margin-bottom: 8px;">ì œëª©</h2>
                        <div style="font-size: 13px; color: var(--text-muted);" id="viewMeta"></div>
                    </div>
                    <div id="viewControls"></div>
                </div>
                
                <div class="post-images" id="viewImages"></div>
                <div class="post-content" id="viewContent">ë‚´ìš©</div>
                
                <div class="post-actions">
                    <div class="action-btn" id="likeBtn" onclick="toggleLike()">â¤ï¸ <span id="likeCount">0</span></div>
                    <div class="action-btn">ğŸ’¬ <span id="commentCount">0</span></div>
                    <div class="action-btn" onclick="boostPost()">ğŸš€ ë¶€ìŠ¤íŠ¸</div>
                </div>

                <div class="comment-section" id="commentSection">
                    <h4 style="margin-bottom: 16px;">ğŸ’¬ ëŒ“ê¸€</h4>
                    <div class="comment-input">
                        <input type="text" id="commentInput" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" onkeypress="if(event.key==='Enter')submitComment()">
                        <button class="btn-primary" onclick="submitComment()">ë“±ë¡</button>
                    </div>
                    <div id="commentList"></div>
                </div>
            </div>
            <button class="btn-outline btn-block" onclick="backToList()">â† ëª©ë¡ìœ¼ë¡œ</button>
        </div>
    </div>

    <div class="image-viewer" id="imageViewer" onclick="closeImageViewer()">
        <button class="image-viewer-close">âœ•</button>
        <img id="viewerImage" src="" alt="">
    </div>

    <div class="modal-overlay" id="settingsModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('settingsModal')">âœ•</button>
            <h2 class="modal-title">âš™ï¸ ê²Œì‹œíŒ ì„¤ì •</h2>
            <label>ê²Œì‹œíŒ ì´ë¦„</label>
            <input type="text" id="editBoardName" maxlength="20">
            <label>ì„¤ëª…</label>
            <textarea id="editBoardDesc" rows="3"></textarea>
            <label>í…Œë§ˆ ìƒ‰ìƒ</label>
            <input type="color" id="editBoardColor" style="height: 50px;">
            <label>ì•„ì´ì½˜</label>
            <input type="text" id="editBoardIcon" maxlength="2" style="font-size: 24px; text-align: center;">
            <div style="border-top: 1px solid var(--border); margin: 20px 0; padding-top: 20px;">
                <h4 style="margin-bottom: 12px;">ğŸ’° ìˆ˜ìµí™”</h4>
                <label>ì…ì¥ë£Œ</label>
                <input type="number" id="editEntryFee" min="0" max="100">
                <label>ê¸€ì“°ê¸° ìˆ˜ìˆ˜ë£Œ</label>
                <input type="number" id="editWriteFee" min="0" max="50">
            </div>
            <div style="border-top: 1px solid var(--border); margin: 20px 0; padding-top: 20px;">
                <div class="toggle-row"><span>ìŠ¹ì¸ì œ</span><div class="toggle-switch" id="editToggleApproval" onclick="this.classList.toggle('active')"></div></div>
                <div class="toggle-row"><span>ëŒ“ê¸€ í—ˆìš©</span><div class="toggle-switch active" id="editToggleComments" onclick="this.classList.toggle('active')"></div></div>
            </div>
            <button class="btn-primary btn-block" onclick="saveSettings()">ì €ì¥</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, updateDoc, deleteDoc, onSnapshot, query, orderBy, where, increment, runTransaction, addDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyBwQjuqgWM4YKnqu_gzNbeCg5alrC-jVcQ", authDomain: "myco-737a0.firebaseapp.com", projectId: "myco-737a0", storageBucket: "myco-737a0.firebasestorage.app", messagingSenderId: "942571332540", appId: "1:942571332540:web:be0bb6fbdd32655501c1b9" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUser = null, userData = null, boardData = null, currentPostId = null;
        let currentSort = 'latest';
        let uploadedImages = [];
        const boardId = new URLSearchParams(window.location.search).get('id');

        if(!boardId) { location.href = 'index.html'; }

        // ì´ë¯¸ì§€ ì—…ë¡œë“œ
        const uploadArea = document.getElementById('imageUploadArea');
        uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
        uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
        uploadArea.addEventListener('drop', (e) => { e.preventDefault(); uploadArea.classList.remove('dragover'); handleFiles(e.dataTransfer.files); });

        window.handleImageSelect = (e) => handleFiles(e.target.files);

        function handleFiles(files) {
            if(uploadedImages.length >= 3) return alert('ìµœëŒ€ 3ì¥ê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥');
            Array.from(files).slice(0, 3 - uploadedImages.length).forEach(file => {
                if(!file.type.startsWith('image/')) return;
                if(file.size > 2 * 1024 * 1024) return alert('2MB ì´í•˜ë§Œ ê°€ëŠ¥');
                const reader = new FileReader();
                reader.onload = (e) => { uploadedImages.push(e.target.result); renderPreviews(); };
                reader.readAsDataURL(file);
            });
        }

        function renderPreviews() {
            const c = document.getElementById('imagePreviewContainer');
            c.innerHTML = uploadedImages.map((src, i) => `<div class="image-preview-item"><img src="${src}"><button class="remove-btn" onclick="removeImage(${i})">âœ•</button></div>`).join('');
        }

        window.removeImage = (i) => { uploadedImages.splice(i, 1); renderPreviews(); };
        window.openImageViewer = (src) => { document.getElementById('viewerImage').src = src; document.getElementById('imageViewer').style.display = 'flex'; };
        window.closeImageViewer = () => document.getElementById('imageViewer').style.display = 'none';

        onAuthStateChanged(auth, async (user) => {
            if(user) {
                currentUser = user;
                const userDoc = await getDoc(doc(db, "users", user.uid));
                userData = userDoc.data();
                document.getElementById("walletBadge").innerHTML = `ğŸ’° ${(userData?.coin||0).toLocaleString()} BOK`;
                loadBoard();
            } else { location.href = 'index.html'; }
        });

        async function loadBoard() {
            onSnapshot(doc(db, "boards", boardId), (docSnap) => {
                if(!docSnap.exists()) { alert("ê²Œì‹œíŒ ì—†ìŒ"); location.href = 'index.html'; return; }
                boardData = docSnap.data();
                document.getElementById("boardTitle").textContent = boardData.name;
                document.getElementById("boardDesc").textContent = boardData.description || '';
                document.getElementById("boardIcon").textContent = boardData.icon || 'ğŸ“';
                document.getElementById("boardIcon").style.background = boardData.color || '#6366f1';
                document.getElementById("memberCount").textContent = boardData.memberCount || 0;
                document.getElementById("postCount").textContent = boardData.postCount || 0;
                document.getElementById("ownerInfo").textContent = `ì†Œìœ ì: ${boardData.ownerName}`;
                
                if(currentUser && boardData.ownerUid === currentUser.uid) {
                    document.getElementById("settingsBtn").classList.remove("hidden");
                    document.getElementById("editBoardName").value = boardData.name;
                    document.getElementById("editBoardDesc").value = boardData.description || '';
                    document.getElementById("editBoardColor").value = boardData.color || '#6366f1';
                    document.getElementById("editBoardIcon").value = boardData.icon || 'ğŸ“';
                    document.getElementById("editEntryFee").value = boardData.entryFee || 0;
                    document.getElementById("editWriteFee").value = boardData.writeFee || 0;
                }
                
                if(boardData.entryFee > 0 && boardData.ownerUid !== currentUser?.uid) {
                    const paid = boardData.paidMembers || [];
                    if(!paid.includes(currentUser?.uid)) {
                        document.getElementById("entryFeeNotice").classList.remove("hidden");
                        document.getElementById("entryFeeAmount").textContent = `${boardData.entryFee} BOK`;
                        document.getElementById("boardHeader").classList.add("hidden");
                        document.getElementById("postListSection").classList.add("hidden");
                        return;
                    }
                }
                
                if(boardData.writeFee > 0) {
                    document.getElementById("writeFeeNotice").style.display = "block";
                    document.getElementById("writeFeeAmount").textContent = boardData.writeFee;
                }
                loadPosts();
            });
        }

        window.payEntryFee = async function() {
            if(!userData || userData.coin < boardData.entryFee) return alert("BOK ë¶€ì¡±");
            try {
                await runTransaction(db, async (t) => {
                    t.update(doc(db, "users", currentUser.uid), { coin: increment(-boardData.entryFee), totalSpent: increment(boardData.entryFee) });
                    t.update(doc(db, "users", boardData.ownerUid), { coin: increment(boardData.entryFee), totalEarned: increment(boardData.entryFee) });
                    t.update(doc(db, "boards", boardId), { paidMembers: arrayUnion(currentUser.uid), memberCount: increment(1) });
                });
                alert("ì…ì¥ ì™„ë£Œ!"); location.reload();
            } catch(e) { alert("ì˜¤ë¥˜: " + e); }
        };

        function loadPosts() {
            // ì¸ë±ìŠ¤ ì—†ì´ ì‘ë™í•˜ë„ë¡ whereë§Œ ì‚¬ìš©í•˜ê³  ì •ë ¬ì€ í´ë¼ì´ì–¸íŠ¸ì—ì„œ
            const q = query(collection(db, "posts"), where("boardId", "==", boardId));
            
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById("postList");
                list.innerHTML = "";
                if(snapshot.empty) { list.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“</div><p>ì•„ì§ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.<br>ì²« ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”!</p></div>'; return; }
                
                let posts = [];
                snapshot.forEach(d => posts.push({ id: d.id, ...d.data() }));
                
                // í´ë¼ì´ì–¸íŠ¸ ì¸¡ ì •ë ¬
                posts.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                if(currentSort === 'popular') posts.sort((a, b) => (b.likeCount||0) - (a.likeCount||0));
                // ë¶€ìŠ¤íŠ¸ëœ ê¸€ ìƒë‹¨
                posts.sort((a, b) => (b.boosted?1:0) - (a.boosted?1:0));
                
                posts.forEach(p => {
                    const boost = p.boosted ? '<span class="boost-badge">ğŸš€</span>' : '';
                    const imgBadge = (p.images?.length) ? '<span class="has-image-badge">ğŸ“·</span>' : '';
                    const title = p.authorTitle ? `<span style="font-size:10px;background:rgba(245,158,11,0.2);color:#f59e0b;padding:2px 6px;border-radius:10px;margin-right:4px;">${p.authorTitle}</span>` : '';
                    const flag = p.authorCountry || '';
                    const thumb = p.images?.length ? `<img class="post-thumb" src="${p.images[0]}">` : '';
                    list.innerHTML += `<div class="post-item" onclick="viewPost('${p.id}')">${thumb}<div class="post-info"><div class="post-title">${p.title}${boost}${imgBadge}</div><div class="post-meta">${flag} ${title}${p.authorName} Â· ${new Date(p.createdAt).toLocaleDateString()}</div></div><div class="post-stats"><span>â¤ï¸ ${p.likeCount||0}</span><span>ğŸ’¬ ${p.commentCount||0}</span></div></div>`;
                });
            }, (e) => { console.error("ê¸€ ë¡œë“œ ì˜¤ë¥˜:", e); document.getElementById("postList").innerHTML = `<div class="empty-state"><div class="icon">âš ï¸</div><p>ì˜¤ë¥˜: ${e.message}</p></div>`; });
        }
        }

        window.changeSort = (s) => { currentSort = s; document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); document.querySelector(`.tab[data-sort="${s}"]`).classList.add('active'); loadPosts(); };
        window.showWriteForm = () => { uploadedImages = []; renderPreviews(); document.getElementById("postTitle").value = ""; document.getElementById("postContent").value = ""; document.getElementById("postListSection").classList.add("hidden"); document.getElementById("writeSection").classList.remove("hidden"); };
        window.cancelWrite = () => { document.getElementById("writeSection").classList.add("hidden"); document.getElementById("postListSection").classList.remove("hidden"); };

        window.submitPost = async function() {
            const title = document.getElementById("postTitle").value.trim();
            const content = document.getElementById("postContent").value.trim();
            if(!title) return alert("ì œëª© ì…ë ¥");
            if(content.length < 10) return alert("10ì ì´ìƒ ì‘ì„±");
            const fee = boardData.writeFee || 0;
            if(userData.coin < fee) return alert("BOK ë¶€ì¡±");
            try {
                const isFirstPost = (userData.postCount || 0) === 0;
                
                await runTransaction(db, async (t) => {
                    if(fee > 0) {
                        t.update(doc(db, "users", currentUser.uid), { coin: increment(-fee), totalSpent: increment(fee) });
                        t.update(doc(db, "users", boardData.ownerUid), { coin: increment(fee), totalEarned: increment(fee) });
                    }
                    t.update(doc(db, "users", currentUser.uid), { coin: increment(100), totalEarned: increment(100), postCount: increment(1), exp: increment(10) });
                    t.set(doc(collection(db, "posts")), { boardId, title, content, images: uploadedImages, authorUid: currentUser.uid, authorName: currentUser.displayName, authorTitle: userData.title||'', authorCountry: userData.country||'', likeCount: 0, commentCount: 0, likes: [], boosted: false, createdAt: new Date().toISOString() });
                    t.update(doc(db, "boards", boardId), { postCount: increment(1) });
                });
                
                // ì²« ê¸€ ì‘ì„± ì‹œ ì´ˆëŒ€ 2ë‹¨ê³„ ë³´ìƒ
                if(isFirstPost && userData.invitedBy) {
                    try {
                        // ì´ˆëŒ€ìì—ê²Œ 2ë‹¨ê³„ ë³´ìƒ (300 BOK)
                        await updateDoc(doc(db, "users", userData.invitedBy), { 
                            coin: increment(300), 
                            totalEarned: increment(300),
                            inviteRewards: increment(300)
                        });
                        // ê°€ì…ìì—ê²Œ ì¶”ê°€ ë³´ìƒ (100 BOK) - ì´ë¯¸ ê¸€ì“°ê¸° ë³´ìƒ 100 ë°›ì•˜ìœ¼ë¯€ë¡œ ë³„ë„ ì§€ê¸‰ ì•ˆí•¨
                        // ì´ˆëŒ€ ê¸°ë¡ ì—…ë°ì´íŠ¸
                        const inviteQuery = query(collection(db, "invites"), where("inviteeUid", "==", currentUser.uid));
                        const inviteSnap = await getDocs(inviteQuery);
                        if(!inviteSnap.empty) {
                            await updateDoc(inviteSnap.docs[0].ref, { stage2: true, stage2At: new Date().toISOString() });
                        }
                    } catch(e) { console.log("ì´ˆëŒ€ ë³´ìƒ ì˜¤ë¥˜:", e); }
                }
                
                alert("ğŸ‰ ë“±ë¡ ì™„ë£Œ! +100 BOK"); uploadedImages = []; cancelWrite();
            } catch(e) { alert("ì˜¤ë¥˜: " + e); }
        };

        window.viewPost = async function(postId) {
            currentPostId = postId;
            const d = await getDoc(doc(db, "posts", postId));
            if(!d.exists()) return alert("ê¸€ ì—†ìŒ");
            const p = d.data();
            document.getElementById("viewTitle").textContent = p.title;
            const title = p.authorTitle ? `<span style="font-size:11px;background:rgba(245,158,11,0.2);color:#f59e0b;padding:2px 8px;border-radius:10px;margin-right:6px;">${p.authorTitle}</span>` : '';
            document.getElementById("viewMeta").innerHTML = `${p.authorCountry||''} ${title}${p.authorName} Â· ${new Date(p.createdAt).toLocaleString()}`;
            document.getElementById("viewContent").textContent = p.content;
            document.getElementById("likeCount").textContent = p.likeCount || 0;
            document.getElementById("commentCount").textContent = p.commentCount || 0;
            
            const imgs = document.getElementById("viewImages");
            imgs.innerHTML = (p.images||[]).map(s=>`<img src="${s}" onclick="openImageViewer('${s}')">`).join('');
            
            document.getElementById("likeBtn").classList.toggle("liked", (p.likes||[]).includes(currentUser?.uid));
            document.getElementById("viewControls").innerHTML = (currentUser && p.authorUid === currentUser.uid) ? '<button class="btn-sm btn-danger" onclick="deletePost()">ì‚­ì œ</button>' : '';
            
            if(boardData.allowComments === false) document.getElementById("commentSection").classList.add("hidden");
            else { document.getElementById("commentSection").classList.remove("hidden"); loadComments(postId); }
            
            document.getElementById("postListSection").classList.add("hidden");
            document.getElementById("viewSection").classList.remove("hidden");
        };

        window.backToList = () => { document.getElementById("viewSection").classList.add("hidden"); document.getElementById("postListSection").classList.remove("hidden"); };

        window.toggleLike = async function() {
            if(!currentUser) return;
            const ref = doc(db, "posts", currentPostId);
            const d = await getDoc(ref);
            const likes = d.data().likes || [];
            if(likes.includes(currentUser.uid)) {
                await updateDoc(ref, { likes: arrayRemove(currentUser.uid), likeCount: increment(-1) });
                document.getElementById("likeBtn").classList.remove("liked");
                document.getElementById("likeCount").textContent = parseInt(document.getElementById("likeCount").textContent) - 1;
            } else {
                await updateDoc(ref, { likes: arrayUnion(currentUser.uid), likeCount: increment(1) });
                await updateDoc(doc(db, "users", d.data().authorUid), { coin: increment(5), totalEarned: increment(5) });
                document.getElementById("likeBtn").classList.add("liked");
                document.getElementById("likeCount").textContent = parseInt(document.getElementById("likeCount").textContent) + 1;
            }
        };

        window.boostPost = async function() {
            if(!currentUser || userData.coin < 200) return alert("BOK ë¶€ì¡± (200 í•„ìš”)");
            if(!confirm("200 BOKìœ¼ë¡œ ë¶€ìŠ¤íŠ¸?")) return;
            await runTransaction(db, async (t) => {
                t.update(doc(db, "users", currentUser.uid), { coin: increment(-200), totalSpent: increment(200) });
                t.update(doc(db, "posts", currentPostId), { boosted: true });
            });
            alert("ğŸš€ ë¶€ìŠ¤íŠ¸ ì™„ë£Œ!");
        };

        window.deletePost = async function() {
            if(!confirm("ì‚­ì œ?")) return;
            await deleteDoc(doc(db, "posts", currentPostId));
            await updateDoc(doc(db, "boards", boardId), { postCount: increment(-1) });
            alert("ì‚­ì œë¨"); backToList();
        };

        function loadComments(postId) {
            // ì¸ë±ìŠ¤ ì—†ì´ ì‘ë™í•˜ë„ë¡ whereë§Œ ì‚¬ìš©
            const q = query(collection(db, "comments"), where("postId", "==", postId));
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById("commentList");
                list.innerHTML = snapshot.empty ? '<p style="text-align:center;color:var(--text-muted);padding:20px;">ëŒ“ê¸€ ì—†ìŒ</p>' : '';
                
                // í´ë¼ì´ì–¸íŠ¸ ì¸¡ ì •ë ¬ (ì˜¤ë˜ëœ ìˆœ)
                let comments = [];
                snapshot.forEach(d => comments.push({ id: d.id, ...d.data() }));
                comments.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
                
                comments.forEach(c => {
                    const t = c.authorTitle ? `<span style="font-size:10px;background:rgba(245,158,11,0.2);color:#f59e0b;padding:2px 6px;border-radius:10px;margin-right:4px;">${c.authorTitle}</span>` : '';
                    list.innerHTML += `<div class="comment-item"><div class="comment-avatar">ğŸ‘¤</div><div class="comment-content"><div class="comment-author">${c.authorCountry||''} ${t}${c.authorName}</div><div class="comment-text">${c.content}</div><div class="comment-time">${new Date(c.createdAt).toLocaleString()}</div></div></div>`;
                });
            }, (e) => { console.error("ëŒ“ê¸€ ë¡œë“œ ì˜¤ë¥˜:", e); });
        }

        window.submitComment = async function() {
            const content = document.getElementById("commentInput").value.trim();
            if(!content) return;
            await addDoc(collection(db, "comments"), { postId: currentPostId, content, authorUid: currentUser.uid, authorName: currentUser.displayName, authorTitle: userData?.title||'', authorCountry: userData?.country||'', createdAt: new Date().toISOString() });
            await updateDoc(doc(db, "posts", currentPostId), { commentCount: increment(1) });
            await updateDoc(doc(db, "users", currentUser.uid), { coin: increment(10), totalEarned: increment(10), commentCount: increment(1), exp: increment(2) });
            document.getElementById("commentInput").value = "";
            document.getElementById("commentCount").textContent = parseInt(document.getElementById("commentCount").textContent) + 1;
        };

        window.saveSettings = async function() {
            await updateDoc(doc(db, "boards", boardId), {
                name: document.getElementById("editBoardName").value.trim(),
                description: document.getElementById("editBoardDesc").value.trim(),
                color: document.getElementById("editBoardColor").value,
                icon: document.getElementById("editBoardIcon").value || 'ğŸ“',
                entryFee: parseInt(document.getElementById("editEntryFee").value) || 0,
                writeFee: parseInt(document.getElementById("editWriteFee").value) || 0,
                requireApproval: document.getElementById("editToggleApproval").classList.contains("active"),
                allowComments: document.getElementById("editToggleComments").classList.contains("active")
            });
            alert("ì €ì¥ë¨!"); closeModal('settingsModal');
        };

        window.openModal = (id) => document.getElementById(id).style.display = "flex";
        window.closeModal = (id) => document.getElementById(id).style.display = "none";
        document.addEventListener('keydown', (e) => { if(e.key === 'Escape') { closeModal('settingsModal'); closeImageViewer(); } });
    </script>
</body>
</html>
