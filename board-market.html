<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOKLUCK ê²Œì‹œíŒ ë§ˆì¼“</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        :root { --primary: #8b5cf6; --primary-light: #a78bfa; --secondary: #06b6d4; --accent: #f59e0b; --success: #10b981; --danger: #ef4444; --pink: #ec4899; --bg-dark: #0a0a0f; --bg-card: #12121a; --bg-card-hover: #1a1a25; --border: #2a2a3a; --text: #f0f0f5; --text-muted: #8888a0; --gradient-primary: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%); --gradient-gold: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%); }
        body { background-color: var(--bg-dark); background-image: radial-gradient(ellipse at top, rgba(139,92,246,0.1) 0%, transparent 50%); color: var(--text); font-family: 'Noto Sans KR', sans-serif; min-height: 100vh; }
        
        .navbar { background: var(--bg-card); border-bottom: 1px solid var(--border); padding: 12px 20px; position: sticky; top: 0; z-index: 100; }
        .nav-container { max-width: 1000px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 24px; font-weight: 900; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; cursor: pointer; text-decoration: none; }
        .nav-links { display: flex; gap: 8px; }
        .nav-link { padding: 8px 16px; border-radius: 8px; color: var(--text-muted); text-decoration: none; font-size: 14px; font-weight: 500; transition: all 0.2s; }
        .nav-link:hover, .nav-link.active { background: var(--bg-card-hover); color: var(--text); }
        
        .hamburger { display: none; flex-direction: column; gap: 5px; cursor: pointer; padding: 8px; }
        .hamburger span { width: 24px; height: 2px; background: var(--text); transition: all 0.3s; }
        .hamburger.active span:nth-child(1) { transform: rotate(45deg) translate(5px, 5px); }
        .hamburger.active span:nth-child(2) { opacity: 0; }
        .hamburger.active span:nth-child(3) { transform: rotate(-45deg) translate(5px, -5px); }
        
        .mobile-menu { display: none; position: fixed; top: 60px; left: 0; right: 0; bottom: 0; background: var(--bg-dark); z-index: 99; padding: 20px; flex-direction: column; gap: 8px; }
        .mobile-menu.active { display: flex; }
        .mobile-menu .nav-link { padding: 16px; font-size: 16px; border-radius: 12px; background: var(--bg-card); }
        
        .nav-right { display: flex; align-items: center; gap: 12px; }
        .wallet-badge { background: var(--bg-dark); padding: 8px 16px; border-radius: 50px; border: 1px solid var(--border); color: var(--primary); font-weight: 700; font-size: 14px; }
        
        .container { max-width: 1000px; margin: 0 auto; padding: 24px 20px; }
        .back-btn { display: inline-flex; align-items: center; gap: 8px; color: var(--text-muted); text-decoration: none; font-size: 14px; margin-bottom: 20px; }
        .back-btn:hover { color: var(--text); }
        
        button { cursor: pointer; border: none; border-radius: 10px; font-weight: 600; padding: 12px 20px; transition: all 0.2s; font-family: 'Noto Sans KR', sans-serif; font-size: 14px; }
        button:hover { transform: translateY(-1px); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: var(--gradient-primary); color: white; }
        .btn-gold { background: var(--gradient-gold); color: #1a1a2e; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .btn-sm { padding: 8px 14px; font-size: 13px; }
        .btn-block { width: 100%; }
        
        input, textarea, select { width: 100%; background: var(--bg-dark); border: 1px solid var(--border); color: var(--text); padding: 14px 16px; border-radius: 10px; font-size: 15px; font-family: 'Noto Sans KR', sans-serif; margin-bottom: 12px; }
        input:focus, select:focus { outline: none; border-color: var(--primary); }
        label { display: block; font-size: 13px; color: var(--text-muted); margin-bottom: 6px; }

        /* í—¤ë” */
        .page-header { background: var(--bg-card); border: 1px solid var(--border); border-radius: 20px; padding: 32px; margin-bottom: 24px; position: relative; overflow: hidden; }
        .page-header::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: var(--gradient-primary); }
        .page-title { font-size: 28px; font-weight: 900; margin-bottom: 8px; display: flex; align-items: center; gap: 12px; }
        .page-subtitle { color: var(--text-muted); font-size: 15px; }

        /* í†µê³„ */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 20px; text-align: center; }
        .stat-value { font-size: 28px; font-weight: 900; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .stat-label { font-size: 13px; color: var(--text-muted); margin-top: 4px; }

        /* í•„í„° & ê²€ìƒ‰ */
        .filter-bar { display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; }
        .filter-bar input { flex: 1; min-width: 200px; margin: 0; }
        .filter-bar select { width: auto; min-width: 120px; margin: 0; }

        /* íƒ­ */
        .tabs { display: flex; gap: 4px; background: var(--bg-dark); padding: 4px; border-radius: 12px; margin-bottom: 24px; }
        .tab { flex: 1; padding: 12px; text-align: center; border-radius: 8px; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s; color: var(--text-muted); }
        .tab.active { background: var(--bg-card); color: var(--text); }

        /* ê²Œì‹œíŒ ì¹´ë“œ */
        .board-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .board-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 20px; padding: 24px; transition: all 0.3s; position: relative; overflow: hidden; }
        .board-card:hover { border-color: var(--primary); transform: translateY(-4px); box-shadow: 0 10px 30px rgba(139,92,246,0.2); }
        .board-card.for-sale::before { content: 'ğŸ·ï¸ íŒë§¤ì¤‘'; position: absolute; top: 16px; right: 16px; background: var(--gradient-gold); color: #1a1a2e; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 700; }
        .board-card-header { display: flex; align-items: center; gap: 16px; margin-bottom: 16px; }
        .board-card-icon { width: 56px; height: 56px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 28px; }
        .board-card-name { font-size: 18px; font-weight: 700; margin-bottom: 4px; }
        .board-card-owner { font-size: 13px; color: var(--text-muted); }
        .board-card-desc { font-size: 14px; color: var(--text-muted); margin-bottom: 16px; line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .board-card-stats { display: flex; gap: 16px; margin-bottom: 16px; font-size: 13px; color: var(--text-muted); }
        .board-card-stats span { display: flex; align-items: center; gap: 4px; }
        .board-card-price { display: flex; justify-content: space-between; align-items: center; padding-top: 16px; border-top: 1px solid var(--border); }
        .price-tag { font-size: 20px; font-weight: 900; color: var(--accent); }
        .monthly-revenue { font-size: 12px; color: var(--success); background: rgba(16,185,129,0.1); padding: 4px 10px; border-radius: 20px; }

        /* ë‚´ ê²Œì‹œíŒ ê´€ë¦¬ */
        .my-boards-section { background: var(--bg-card); border: 1px solid var(--border); border-radius: 20px; padding: 24px; margin-bottom: 24px; }
        .my-boards-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .my-board-item { display: flex; align-items: center; gap: 16px; padding: 16px; background: var(--bg-dark); border-radius: 14px; margin-bottom: 12px; }
        .my-board-item:last-child { margin-bottom: 0; }
        .my-board-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .my-board-info { flex: 1; }
        .my-board-name { font-weight: 700; margin-bottom: 4px; }
        .my-board-meta { font-size: 12px; color: var(--text-muted); }
        .my-board-actions { display: flex; gap: 8px; }
        .sale-badge { background: var(--gradient-gold); color: #1a1a2e; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; }

        /* ê±°ë˜ ë‚´ì—­ */
        .history-item { display: flex; align-items: center; gap: 16px; padding: 16px; background: var(--bg-dark); border-radius: 14px; margin-bottom: 10px; }
        .history-icon { width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; background: var(--bg-card); }
        .history-info { flex: 1; }
        .history-title { font-weight: 600; font-size: 14px; margin-bottom: 4px; }
        .history-meta { font-size: 12px; color: var(--text-muted); }
        .history-price { font-weight: 700; color: var(--accent); }
        .history-price.buy { color: var(--danger); }
        .history-price.sell { color: var(--success); }

        /* ëª¨ë‹¬ */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(8px); padding: 20px; }
        .modal-content { background: var(--bg-card); border-radius: 20px; width: 100%; max-width: 480px; border: 1px solid var(--border); position: relative; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 24px 24px 0; }
        .modal-title { font-size: 22px; font-weight: 900; margin-bottom: 8px; }
        .modal-body { padding: 24px; }
        .modal-close { position: absolute; top: 16px; right: 16px; background: var(--bg-dark); border: none; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; font-size: 18px; color: var(--text-muted); }

        /* ê²Œì‹œíŒ ìƒì„¸ */
        .detail-board-header { display: flex; align-items: center; gap: 20px; padding: 24px; border-bottom: 1px solid var(--border); }
        .detail-board-icon { width: 72px; height: 72px; border-radius: 18px; display: flex; align-items: center; justify-content: center; font-size: 36px; }
        .detail-board-name { font-size: 22px; font-weight: 900; margin-bottom: 4px; }
        .detail-board-owner { font-size: 14px; color: var(--text-muted); }
        .detail-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; padding: 20px 24px; background: var(--bg-dark); }
        .detail-stat { text-align: center; }
        .detail-stat-value { font-size: 20px; font-weight: 700; color: var(--primary-light); }
        .detail-stat-label { font-size: 11px; color: var(--text-muted); }
        .detail-price-section { padding: 24px; }
        .detail-price { font-size: 32px; font-weight: 900; color: var(--accent); margin-bottom: 8px; }
        .detail-revenue { font-size: 14px; color: var(--success); margin-bottom: 20px; }

        /* êµ¬ë§¤ ì œì•ˆ */
        .offer-section { background: var(--bg-dark); border-radius: 12px; padding: 16px; margin-bottom: 16px; }
        .offer-input-group { display: flex; gap: 12px; }
        .offer-input-group input { flex: 1; margin: 0; }
        .pending-offers { margin-top: 16px; }
        .offer-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg-card); border-radius: 10px; margin-bottom: 8px; }
        .offer-item-info { flex: 1; }
        .offer-item-name { font-weight: 600; font-size: 14px; }
        .offer-item-price { color: var(--accent); font-weight: 700; }
        .offer-item-actions { display: flex; gap: 8px; }
        .offer-item-actions button { padding: 6px 12px; font-size: 12px; }

        .hidden { display: none !important; }

        @media (max-width: 768px) {
            .nav-links { display: none; }
            .hamburger { display: flex; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .board-grid { grid-template-columns: 1fr; }
            .filter-bar { flex-direction: column; }
            .filter-bar input, .filter-bar select { width: 100%; }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="logo">BOKLUCK MARKET</a>
            <div class="nav-links">
                <a href="index.html" class="nav-link">ğŸ  í™ˆ</a>
                <a href="index.html" class="nav-link">ğŸ“‚ ê²Œì‹œíŒ</a>
                <a href="market.html" class="nav-link">ğŸ—ºï¸ ë¶€ë™ì‚°</a>
                <a href="board-market.html" class="nav-link active">ğŸª ë§ˆì¼“</a>
            </div>
            <div class="nav-right">
                <div class="wallet-badge" id="walletBadge">ğŸ’° ì—°ê²° í•„ìš”</div>
                <div class="hamburger" id="hamburger" onclick="toggleMobileMenu()">
                    <span></span><span></span><span></span>
                </div>
            </div>
        </div>
    </nav>
    
    <div class="mobile-menu" id="mobileMenu">
        <a href="index.html" class="nav-link">ğŸ  í™ˆ</a>
        <a href="index.html" class="nav-link">ğŸ“‚ ê²Œì‹œíŒ</a>
        <a href="market.html" class="nav-link">ğŸ—ºï¸ ë¶€ë™ì‚°</a>
        <a href="board-market.html" class="nav-link">ğŸª ë§ˆì¼“</a>
    </div>

    <div class="container">
        <a href="index.html" class="back-btn">â† ë©”ì¸ìœ¼ë¡œ</a>

        <div class="page-header">
            <h1 class="page-title">ğŸª ê²Œì‹œíŒ ë§ˆì¼“</h1>
            <p class="page-subtitle">ìš´ì˜ ì¤‘ì¸ ê²Œì‹œíŒì„ ì‚¬ê³ íŒ”ê³ , ìƒˆë¡œìš´ ì»¤ë®¤ë‹ˆí‹°ë¥¼ ì¸ìˆ˜í•˜ì„¸ìš”!</p>
        </div>

        <!-- í†µê³„ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="statTotal">0</div>
                <div class="stat-label">ì „ì²´ ê²Œì‹œíŒ</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statForSale">0</div>
                <div class="stat-label">íŒë§¤ì¤‘</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statTrades">0</div>
                <div class="stat-label">ì´ ê±°ë˜</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statVolume">0</div>
                <div class="stat-label">ê±°ë˜ëŸ‰ (BOK)</div>
            </div>
        </div>

        <!-- ë‚´ ê²Œì‹œíŒ ê´€ë¦¬ -->
        <div class="my-boards-section" id="myBoardsSection">
            <div class="my-boards-header">
                <h3>ğŸ“‹ ë‚´ ê²Œì‹œíŒ</h3>
                <button class="btn-gold btn-sm" onclick="location.href='index.html'">+ ìƒˆ ê²Œì‹œíŒ</button>
            </div>
            <div id="myBoardsList">
                <p style="text-align: center; color: var(--text-muted); padding: 20px;">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
            </div>
        </div>

        <!-- í•„í„° & ê²€ìƒ‰ -->
        <div class="filter-bar">
            <input type="text" id="searchInput" placeholder="ğŸ” ê²Œì‹œíŒ ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰..." oninput="filterBoards()">
            <select id="categoryFilter" onchange="filterBoards()">
                <option value="">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
                <option value="general">ğŸ’¬ ììœ </option>
                <option value="investment">ğŸ’° íˆ¬ì</option>
                <option value="game">ğŸ® ê²Œì„</option>
                <option value="tech">ğŸ’» ê¸°ìˆ </option>
                <option value="life">ğŸŒ± ì¼ìƒ</option>
            </select>
            <select id="sortFilter" onchange="filterBoards()">
                <option value="latest">ìµœì‹ ìˆœ</option>
                <option value="price-low">ê°€ê²© ë‚®ì€ìˆœ</option>
                <option value="price-high">ê°€ê²© ë†’ì€ìˆœ</option>
                <option value="members">íšŒì› ë§ì€ìˆœ</option>
            </select>
        </div>

        <!-- íƒ­ -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('all')">ì „ì²´</div>
            <div class="tab" onclick="switchTab('sale')">íŒë§¤ì¤‘</div>
            <div class="tab" onclick="switchTab('history')">ê±°ë˜ ë‚´ì—­</div>
            <div class="tab" onclick="switchTab('offers')">ë°›ì€ ì œì•ˆ</div>
        </div>

        <!-- ê²Œì‹œíŒ ëª©ë¡ -->
        <div id="boardGrid" class="board-grid"></div>

        <!-- ê±°ë˜ ë‚´ì—­ -->
        <div id="historySection" class="hidden">
            <div id="historyList"></div>
        </div>

        <!-- ë°›ì€ ì œì•ˆ -->
        <div id="offersSection" class="hidden">
            <div id="offersList"></div>
        </div>
    </div>

    <!-- ê²Œì‹œíŒ ìƒì„¸ ëª¨ë‹¬ -->
    <div class="modal-overlay" id="boardDetailModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('boardDetailModal')">âœ•</button>
            
            <div class="detail-board-header">
                <div class="detail-board-icon" id="detailIcon">ğŸ“</div>
                <div>
                    <div class="detail-board-name" id="detailName">ê²Œì‹œíŒ ì´ë¦„</div>
                    <div class="detail-board-owner" id="detailOwner">ìš´ì˜ì</div>
                </div>
            </div>
            
            <div class="detail-stats">
                <div class="detail-stat">
                    <div class="detail-stat-value" id="detailMembers">0</div>
                    <div class="detail-stat-label">ë©¤ë²„</div>
                </div>
                <div class="detail-stat">
                    <div class="detail-stat-value" id="detailPosts">0</div>
                    <div class="detail-stat-label">ê²Œì‹œê¸€</div>
                </div>
                <div class="detail-stat">
                    <div class="detail-stat-value" id="detailEntry">0</div>
                    <div class="detail-stat-label">ì…ì¥ë£Œ</div>
                </div>
            </div>
            
            <div class="detail-price-section">
                <div id="forSaleInfo">
                    <div class="detail-price" id="detailPrice">0 BOK</div>
                    <div class="detail-revenue">ğŸ’° ì˜ˆìƒ ì›” ìˆ˜ìµ: <span id="detailRevenue">0 BOK</span></div>
                    <button class="btn-primary btn-block" onclick="buyBoard()">êµ¬ë§¤í•˜ê¸°</button>
                </div>
                
                <div id="notForSaleInfo" class="hidden">
                    <p style="color: var(--text-muted); margin-bottom: 16px;">ì´ ê²Œì‹œíŒì€ í˜„ì¬ íŒë§¤ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤.</p>
                    <div class="offer-section">
                        <h4 style="margin-bottom: 12px;">ğŸ’¬ êµ¬ë§¤ ì œì•ˆ ë³´ë‚´ê¸°</h4>
                        <div class="offer-input-group">
                            <input type="number" id="offerPrice" placeholder="ì œì•ˆ ê°€ê²© (BOK)" min="1000">
                            <button class="btn-gold" onclick="sendOffer()">ì œì•ˆ</button>
                        </div>
                    </div>
                </div>
                
                <div id="myBoardInfo" class="hidden" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
                    <h4 style="margin-bottom: 12px;">âš™ï¸ ë‚´ ê²Œì‹œíŒ ê´€ë¦¬</h4>
                    <label>íŒë§¤ ê°€ê²© ì„¤ì • (0 = ë¹„ë§¤í’ˆ)</label>
                    <input type="number" id="mySalePrice" placeholder="íŒë§¤ ê°€ê²©" min="0">
                    <button class="btn-gold btn-block" onclick="setForSale()">íŒë§¤ ì„¤ì •</button>
                </div>
            </div>
        </div>
    </div>

    <!-- íŒë§¤ ì„¤ì • ëª¨ë‹¬ -->
    <div class="modal-overlay" id="sellModal">
        <div class="modal-content" style="max-width: 400px;">
            <button class="modal-close" onclick="closeModal('sellModal')">âœ•</button>
            <div class="modal-header">
                <h2 class="modal-title">ğŸ·ï¸ íŒë§¤ ì„¤ì •</h2>
            </div>
            <div class="modal-body">
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 48px; margin-bottom: 8px;" id="sellBoardIcon">ğŸ“</div>
                    <div style="font-size: 18px; font-weight: 700;" id="sellBoardName">ê²Œì‹œíŒ ì´ë¦„</div>
                </div>
                <label>íŒë§¤ ê°€ê²©</label>
                <input type="number" id="sellPrice" placeholder="BOK ë‹¨ìœ„" min="1000">
                <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 16px;">ğŸ’¡ ê±°ë˜ ìˆ˜ìˆ˜ë£Œ: 5%</p>
                <button class="btn-gold btn-block" onclick="confirmSell()">íŒë§¤ ë“±ë¡</button>
                <button class="btn-outline btn-block" style="margin-top: 8px;" onclick="cancelSell()">íŒë§¤ ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, collection, doc, getDoc, getDocs, updateDoc, onSnapshot, query, orderBy, where, increment, runTransaction, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyBwQjuqgWM4YKnqu_gzNbeCg5alrC-jVcQ", authDomain: "myco-737a0.firebaseapp.com", projectId: "myco-737a0", storageBucket: "myco-737a0.firebasestorage.app", messagingSenderId: "942571332540", appId: "1:942571332540:web:be0bb6fbdd32655501c1b9" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUser = null, userData = null;
        let allBoards = [], selectedBoard = null, selectedBoardId = null;
        let currentTab = 'all';

        window.toggleMobileMenu = function() {
            document.getElementById("hamburger").classList.toggle("active");
            document.getElementById("mobileMenu").classList.toggle("active");
        };

        // ê²Œì‹œíŒ ë¡œë“œ
        function loadBoards() {
            const q = query(collection(db, "boards"), orderBy("createdAt", "desc"));
            
            onSnapshot(q, (snapshot) => {
                allBoards = [];
                let forSaleCount = 0;
                
                snapshot.forEach(docSnap => {
                    const data = { id: docSnap.id, ...docSnap.data() };
                    allBoards.push(data);
                    if(data.forSale && data.salePrice > 0) forSaleCount++;
                });
                
                document.getElementById("statTotal").textContent = allBoards.length;
                document.getElementById("statForSale").textContent = forSaleCount;
                
                renderBoards();
                loadMyBoards();
            });
        }

        // ê²Œì‹œíŒ ë Œë”ë§
        function renderBoards() {
            const grid = document.getElementById("boardGrid");
            const search = document.getElementById("searchInput").value.toLowerCase();
            const category = document.getElementById("categoryFilter").value;
            const sort = document.getElementById("sortFilter").value;
            
            let filtered = allBoards.filter(b => {
                if(currentTab === 'sale' && (!b.forSale || !b.salePrice)) return false;
                if(search && !b.name.toLowerCase().includes(search)) return false;
                if(category && b.category !== category) return false;
                return true;
            });
            
            // ì •ë ¬
            filtered.sort((a, b) => {
                if(sort === 'price-low') return (a.salePrice || 0) - (b.salePrice || 0);
                if(sort === 'price-high') return (b.salePrice || 0) - (a.salePrice || 0);
                if(sort === 'members') return (b.memberCount || 0) - (a.memberCount || 0);
                return new Date(b.createdAt) - new Date(a.createdAt);
            });
            
            if(filtered.length === 0) {
                grid.innerHTML = `<div style="grid-column: 1/-1; text-align: center; color: var(--text-muted); padding: 60px;">
                    <div style="font-size: 48px; margin-bottom: 16px;">ğŸª</div>
                    <p>ê²Œì‹œíŒì´ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>`;
                return;
            }
            
            grid.innerHTML = filtered.map(b => {
                const isForSale = b.forSale && b.salePrice > 0;
                const monthlyRevenue = Math.floor((b.memberCount || 0) * (b.entryFee || 0) * 0.3 + (b.postCount || 0) * (b.writeFee || 0) * 0.1);
                
                return `
                    <div class="board-card ${isForSale ? 'for-sale' : ''}" onclick="openBoardDetail('${b.id}')">
                        <div class="board-card-header">
                            <div class="board-card-icon" style="background: ${b.color || '#8b5cf6'};">${b.icon || 'ğŸ“'}</div>
                            <div>
                                <div class="board-card-name">${b.name}</div>
                                <div class="board-card-owner">${b.ownerName}</div>
                            </div>
                        </div>
                        <div class="board-card-desc">${b.description || 'ì„¤ëª… ì—†ìŒ'}</div>
                        <div class="board-card-stats">
                            <span>ğŸ‘¤ ${b.memberCount || 0}</span>
                            <span>ğŸ“ ${b.postCount || 0}</span>
                            <span>ğŸ’° ì…ì¥ë£Œ ${b.entryFee || 0}</span>
                        </div>
                        <div class="board-card-price">
                            ${isForSale ? 
                                `<span class="price-tag">${b.salePrice.toLocaleString()} BOK</span>` : 
                                `<span style="color: var(--text-muted);">ë¹„ë§¤í’ˆ</span>`
                            }
                            ${monthlyRevenue > 0 ? `<span class="monthly-revenue">ì›” ~${monthlyRevenue} BOK</span>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ë‚´ ê²Œì‹œíŒ ë¡œë“œ
        function loadMyBoards() {
            if(!currentUser) {
                document.getElementById("myBoardsList").innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 20px;">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>';
                return;
            }
            
            const myBoards = allBoards.filter(b => b.ownerUid === currentUser.uid);
            const list = document.getElementById("myBoardsList");
            
            if(myBoards.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 20px;">ì†Œìœ í•œ ê²Œì‹œíŒì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            list.innerHTML = myBoards.map(b => `
                <div class="my-board-item">
                    <div class="my-board-icon" style="background: ${b.color || '#8b5cf6'};">${b.icon || 'ğŸ“'}</div>
                    <div class="my-board-info">
                        <div class="my-board-name">${b.name}</div>
                        <div class="my-board-meta">ğŸ‘¤ ${b.memberCount || 0} Â· ğŸ“ ${b.postCount || 0}</div>
                    </div>
                    ${b.forSale && b.salePrice ? `<span class="sale-badge">${b.salePrice.toLocaleString()} BOK</span>` : ''}
                    <div class="my-board-actions">
                        <button class="btn-outline btn-sm" onclick="event.stopPropagation(); location.href='board.html?id=${b.id}'">ë³´ê¸°</button>
                        <button class="btn-gold btn-sm" onclick="event.stopPropagation(); openSellModal('${b.id}')">íŒë§¤</button>
                    </div>
                </div>
            `).join('');
        }

        // ê²Œì‹œíŒ ìƒì„¸
        window.openBoardDetail = function(boardId) {
            const board = allBoards.find(b => b.id === boardId);
            if(!board) return;
            
            selectedBoard = board;
            selectedBoardId = boardId;
            
            document.getElementById("detailIcon").textContent = board.icon || 'ğŸ“';
            document.getElementById("detailIcon").style.background = board.color || '#8b5cf6';
            document.getElementById("detailName").textContent = board.name;
            document.getElementById("detailOwner").textContent = board.ownerName;
            document.getElementById("detailMembers").textContent = board.memberCount || 0;
            document.getElementById("detailPosts").textContent = board.postCount || 0;
            document.getElementById("detailEntry").textContent = board.entryFee || 0;
            
            const isMine = currentUser && board.ownerUid === currentUser.uid;
            const isForSale = board.forSale && board.salePrice > 0;
            
            document.getElementById("forSaleInfo").classList.toggle("hidden", !isForSale || isMine);
            document.getElementById("notForSaleInfo").classList.toggle("hidden", isForSale || isMine);
            document.getElementById("myBoardInfo").classList.toggle("hidden", !isMine);
            
            if(isForSale) {
                document.getElementById("detailPrice").textContent = `${board.salePrice.toLocaleString()} BOK`;
                const monthlyRevenue = Math.floor((board.memberCount || 0) * (board.entryFee || 0) * 0.3);
                document.getElementById("detailRevenue").textContent = `${monthlyRevenue.toLocaleString()} BOK`;
            }
            
            if(isMine) {
                document.getElementById("mySalePrice").value = board.salePrice || '';
            }
            
            openModal('boardDetailModal');
        };

        // êµ¬ë§¤
        window.buyBoard = async function() {
            if(!currentUser) return alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            if(!selectedBoard || !selectedBoardId) return;
            if(selectedBoard.ownerUid === currentUser.uid) return alert("ìì‹ ì˜ ê²Œì‹œíŒì€ êµ¬ë§¤í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            
            const price = selectedBoard.salePrice;
            if(userData.coin < price) return alert(`BOKì´ ë¶€ì¡±í•©ë‹ˆë‹¤!\ní˜„ì¬: ${userData.coin.toLocaleString()}\ní•„ìš”: ${price.toLocaleString()}`);
            
            if(!confirm(`"${selectedBoard.name}" ê²Œì‹œíŒì„ ${price.toLocaleString()} BOKì— êµ¬ë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            
            try {
                const fee = Math.floor(price * 0.05);
                const sellerAmount = price - fee;
                
                await runTransaction(db, async (t) => {
                    const boardRef = doc(db, "boards", selectedBoardId);
                    const boardDoc = await t.get(boardRef);
                    if(!boardDoc.exists() || !boardDoc.data().forSale) throw "íŒë§¤ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤.";
                    
                    t.update(doc(db, "users", currentUser.uid), { 
                        coin: increment(-price), 
                        totalSpent: increment(price),
                        boardCount: increment(1)
                    });
                    
                    t.update(doc(db, "users", selectedBoard.ownerUid), { 
                        coin: increment(sellerAmount), 
                        totalEarned: increment(sellerAmount),
                        boardCount: increment(-1)
                    });
                    
                    t.update(boardRef, {
                        ownerUid: currentUser.uid,
                        ownerName: currentUser.displayName,
                        forSale: false,
                        salePrice: null
                    });
                });
                
                // ê±°ë˜ ê¸°ë¡
                await addDoc(collection(db, "boardTrades"), {
                    boardId: selectedBoardId,
                    boardName: selectedBoard.name,
                    sellerUid: selectedBoard.ownerUid,
                    sellerName: selectedBoard.ownerName,
                    buyerUid: currentUser.uid,
                    buyerName: currentUser.displayName,
                    price,
                    fee,
                    createdAt: new Date().toISOString()
                });
                
                // ì•Œë¦¼
                await addDoc(collection(db, "notifications"), {
                    userId: selectedBoard.ownerUid,
                    type: 'bok',
                    title: 'ê²Œì‹œíŒ íŒë§¤ ì™„ë£Œ',
                    message: `"${selectedBoard.name}" ê²Œì‹œíŒì´ ${price.toLocaleString()} BOKì— íŒë§¤ë˜ì—ˆìŠµë‹ˆë‹¤! (ìˆ˜ìˆ˜ë£Œ ì œì™¸ ${sellerAmount.toLocaleString()} BOK íšë“)`,
                    read: false,
                    createdAt: new Date().toISOString()
                });
                
                alert(`ğŸ‰ "${selectedBoard.name}" ê²Œì‹œíŒì„ êµ¬ë§¤í–ˆìŠµë‹ˆë‹¤!`);
                closeModal('boardDetailModal');
            } catch(e) { alert("ì˜¤ë¥˜: " + e); }
        };

        // êµ¬ë§¤ ì œì•ˆ
        window.sendOffer = async function() {
            if(!currentUser) return alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            if(!selectedBoard || !selectedBoardId) return;
            
            const price = parseInt(document.getElementById("offerPrice").value);
            if(!price || price < 1000) return alert("1,000 BOK ì´ìƒìœ¼ë¡œ ì œì•ˆí•˜ì„¸ìš”.");
            if(userData.coin < price) return alert("BOKì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");
            
            try {
                await addDoc(collection(db, "boardOffers"), {
                    boardId: selectedBoardId,
                    boardName: selectedBoard.name,
                    sellerUid: selectedBoard.ownerUid,
                    sellerName: selectedBoard.ownerName,
                    buyerUid: currentUser.uid,
                    buyerName: currentUser.displayName,
                    buyerCountry: userData?.country || '',
                    offerPrice: price,
                    status: 'pending',
                    createdAt: new Date().toISOString()
                });
                
                await addDoc(collection(db, "notifications"), {
                    userId: selectedBoard.ownerUid,
                    type: 'bok',
                    title: 'ê²Œì‹œíŒ êµ¬ë§¤ ì œì•ˆ',
                    message: `${currentUser.displayName}ë‹˜ì´ "${selectedBoard.name}" ê²Œì‹œíŒì— ${price.toLocaleString()} BOK êµ¬ë§¤ ì œì•ˆì„ ë³´ëƒˆìŠµë‹ˆë‹¤!`,
                    read: false,
                    createdAt: new Date().toISOString()
                });
                
                alert("ğŸ“¨ êµ¬ë§¤ ì œì•ˆì„ ë³´ëƒˆìŠµë‹ˆë‹¤!");
                document.getElementById("offerPrice").value = "";
                closeModal('boardDetailModal');
            } catch(e) { alert("ì˜¤ë¥˜: " + e); }
        };

        // íŒë§¤ ì„¤ì • ëª¨ë‹¬
        window.openSellModal = function(boardId) {
            const board = allBoards.find(b => b.id === boardId);
            if(!board) return;
            
            selectedBoard = board;
            selectedBoardId = boardId;
            
            document.getElementById("sellBoardIcon").textContent = board.icon || 'ğŸ“';
            document.getElementById("sellBoardName").textContent = board.name;
            document.getElementById("sellPrice").value = board.salePrice || '';
            
            openModal('sellModal');
        };

        window.confirmSell = async function() {
            const price = parseInt(document.getElementById("sellPrice").value);
            if(!price || price < 1000) return alert("1,000 BOK ì´ìƒìœ¼ë¡œ ì„¤ì •í•˜ì„¸ìš”.");
            
            await updateDoc(doc(db, "boards", selectedBoardId), {
                forSale: true,
                salePrice: price
            });
            
            alert(`ğŸ·ï¸ ${price.toLocaleString()} BOKì— íŒë§¤ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!`);
            closeModal('sellModal');
        };

        window.cancelSell = async function() {
            await updateDoc(doc(db, "boards", selectedBoardId), {
                forSale: false,
                salePrice: null
            });
            
            alert("íŒë§¤ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            closeModal('sellModal');
        };

        window.setForSale = async function() {
            const price = parseInt(document.getElementById("mySalePrice").value);
            
            await updateDoc(doc(db, "boards", selectedBoardId), {
                forSale: price > 0,
                salePrice: price || null
            });
            
            if(price > 0) {
                alert(`ğŸ·ï¸ ${price.toLocaleString()} BOKì— íŒë§¤ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!`);
            } else {
                alert("íŒë§¤ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
            closeModal('boardDetailModal');
        };

        // íƒ­ ì „í™˜
        window.switchTab = function(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById("boardGrid").classList.toggle("hidden", tab === 'history' || tab === 'offers');
            document.getElementById("historySection").classList.toggle("hidden", tab !== 'history');
            document.getElementById("offersSection").classList.toggle("hidden", tab !== 'offers');
            
            if(tab === 'history') loadHistory();
            else if(tab === 'offers') loadOffers();
            else renderBoards();
        };

        // ê±°ë˜ ë‚´ì—­
        async function loadHistory() {
            const q = query(collection(db, "boardTrades"), orderBy("createdAt", "desc"));
            const snapshot = await getDocs(q);
            
            const list = document.getElementById("historyList");
            if(snapshot.empty) {
                list.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 40px;">ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            let totalVolume = 0;
            list.innerHTML = "";
            
            snapshot.forEach(docSnap => {
                const t = docSnap.data();
                totalVolume += t.price;
                const isBuy = currentUser && t.buyerUid === currentUser.uid;
                const isSell = currentUser && t.sellerUid === currentUser.uid;
                
                list.innerHTML += `
                    <div class="history-item">
                        <div class="history-icon">ğŸª</div>
                        <div class="history-info">
                            <div class="history-title">${t.boardName}</div>
                            <div class="history-meta">${t.sellerName} â†’ ${t.buyerName} Â· ${new Date(t.createdAt).toLocaleDateString()}</div>
                        </div>
                        <div class="history-price ${isBuy ? 'buy' : ''} ${isSell ? 'sell' : ''}">${t.price.toLocaleString()} BOK</div>
                    </div>
                `;
            });
            
            document.getElementById("statTrades").textContent = snapshot.size;
            document.getElementById("statVolume").textContent = totalVolume.toLocaleString();
        }

        // ë°›ì€ ì œì•ˆ
        async function loadOffers() {
            if(!currentUser) {
                document.getElementById("offersList").innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 40px;">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>';
                return;
            }
            
            const q = query(collection(db, "boardOffers"), where("sellerUid", "==", currentUser.uid), where("status", "==", "pending"));
            
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById("offersList");
                if(snapshot.empty) {
                    list.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 40px;">ë°›ì€ ì œì•ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }
                
                list.innerHTML = "";
                snapshot.forEach(docSnap => {
                    const o = docSnap.data();
                    list.innerHTML += `
                        <div class="offer-item">
                            <div class="offer-item-info">
                                <div class="offer-item-name">${o.boardName}</div>
                                <div style="font-size: 12px; color: var(--text-muted);">${o.buyerCountry || ''} ${o.buyerName}</div>
                                <div class="offer-item-price">${o.offerPrice.toLocaleString()} BOK</div>
                            </div>
                            <div class="offer-item-actions">
                                <button class="btn-gold btn-sm" onclick="acceptOffer('${docSnap.id}', '${o.boardId}', '${o.buyerUid}', ${o.offerPrice})">ìˆ˜ë½</button>
                                <button class="btn-outline btn-sm" onclick="rejectOffer('${docSnap.id}')">ê±°ì ˆ</button>
                            </div>
                        </div>
                    `;
                });
            });
        }

        // ì œì•ˆ ìˆ˜ë½
        window.acceptOffer = async function(offerId, boardId, buyerUid, price) {
            if(!confirm(`${price.toLocaleString()} BOK ì œì•ˆì„ ìˆ˜ë½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            
            try {
                const fee = Math.floor(price * 0.05);
                const sellerAmount = price - fee;
                
                const buyerRef = doc(db, "users", buyerUid);
                const buyerSnap = await getDoc(buyerRef);
                if(buyerSnap.data().coin < price) throw "êµ¬ë§¤ìì˜ BOKì´ ë¶€ì¡±í•©ë‹ˆë‹¤.";
                
                const board = allBoards.find(b => b.id === boardId);
                
                await runTransaction(db, async (t) => {
                    t.update(buyerRef, { coin: increment(-price), totalSpent: increment(price), boardCount: increment(1) });
                    t.update(doc(db, "users", currentUser.uid), { coin: increment(sellerAmount), totalEarned: increment(sellerAmount), boardCount: increment(-1) });
                    t.update(doc(db, "boards", boardId), {
                        ownerUid: buyerUid,
                        ownerName: buyerSnap.data().name,
                        forSale: false,
                        salePrice: null
                    });
                    t.delete(doc(db, "boardOffers", offerId));
                });
                
                // ê±°ë˜ ê¸°ë¡
                await addDoc(collection(db, "boardTrades"), {
                    boardId,
                    boardName: board?.name || 'ê²Œì‹œíŒ',
                    sellerUid: currentUser.uid,
                    sellerName: currentUser.displayName,
                    buyerUid,
                    buyerName: buyerSnap.data().name,
                    price,
                    fee,
                    createdAt: new Date().toISOString()
                });
                
                await addDoc(collection(db, "notifications"), {
                    userId: buyerUid,
                    type: 'bok',
                    title: 'êµ¬ë§¤ ì œì•ˆ ìˆ˜ë½ë¨',
                    message: `"${board?.name || 'ê²Œì‹œíŒ'}" êµ¬ë§¤ ì œì•ˆì´ ìˆ˜ë½ë˜ì—ˆìŠµë‹ˆë‹¤!`,
                    read: false,
                    createdAt: new Date().toISOString()
                });
                
                alert("ğŸ‰ ê±°ë˜ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
            } catch(e) { alert("ì˜¤ë¥˜: " + e); }
        };

        // ì œì•ˆ ê±°ì ˆ
        window.rejectOffer = async function(offerId) {
            if(!confirm("ì´ ì œì•ˆì„ ê±°ì ˆí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            await deleteDoc(doc(db, "boardOffers", offerId));
            alert("ì œì•ˆì„ ê±°ì ˆí–ˆìŠµë‹ˆë‹¤.");
        };

        // í•„í„°
        window.filterBoards = function() {
            renderBoards();
        };

        // ì¸ì¦ ìƒíƒœ
        onAuthStateChanged(auth, (user) => {
            if(user) {
                currentUser = user;
                onSnapshot(doc(db, "users", user.uid), (d) => {
                    if(d.exists()) {
                        userData = d.data();
                        document.getElementById("walletBadge").innerText = `ğŸ’° ${(userData.coin||0).toLocaleString()} BOK`;
                        loadMyBoards();
                    }
                });
            } else {
                document.getElementById("walletBadge").innerText = "ğŸ’° ë¡œê·¸ì¸ í•„ìš”";
            }
        });

        window.openModal = (id) => document.getElementById(id).style.display = "flex";
        window.closeModal = (id) => document.getElementById(id).style.display = "none";

        loadBoards();
        loadHistory();
    </script>
</body>
</html>
