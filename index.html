<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BOKLUCK Universe v1.5</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üé≤</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
/* ========================================
   BOKLUCK Universe - Styles
======================================== */

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
    --void: #030308;
    --void-light: #0a0a1a;
    --void-surface: #12122a;
    --void-elevated: #1a1a3a;
    --neon-cyan: #00f5d4;
    --neon-pink: #f72585;
    --neon-purple: #7b2cbf;
    --neon-yellow: #fee440;
    --success: #10b981;
    --danger: #ef4444;
    --text-primary: #e8e8ff;
    --text-secondary: #9090b0;
    --text-muted: #606080;
    --border-subtle: rgba(255,255,255,0.06);
    --border-default: rgba(0,245,212,0.15);
    --gradient-energy: linear-gradient(135deg, #00f5d4, #fee440);
    --gradient-danger: linear-gradient(135deg, #ef4444, #f72585);
    --safe-top: env(safe-area-inset-top, 0px);
    --safe-bottom: env(safe-area-inset-bottom, 0px);
}

html, body { height: 100%; overflow: hidden; touch-action: manipulation; -webkit-tap-highlight-color: transparent; -webkit-user-select: none; user-select: none; }
body { background: var(--void); color: var(--text-primary); font-family: 'Noto Sans KR', sans-serif; font-size: 14px; }

/* Î≤ÑÌäº */
.btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 14px 28px; border: none; border-radius: 12px; font-family: inherit; font-size: 1rem; font-weight: 600; cursor: pointer; transition: transform 0.2s; }
.btn:active { transform: scale(0.96); }
.btn-energy { background: var(--gradient-energy); color: var(--void); }
.btn-outline { background: transparent; color: var(--text-primary); border: 1px solid var(--border-default); }
.btn-ghost { background: rgba(255,255,255,0.08); color: var(--text-primary); }
.btn-sm { padding: 10px 16px; font-size: 0.85rem; }
.btn-block { width: 100%; }

/* Ïï± Ïª®ÌÖåÏù¥ÎÑà */
#app { position: fixed; inset: 0; overflow: hidden; }
#stars-bg { position: fixed; inset: 0; z-index: 0; pointer-events: none; }
.star { position: absolute; background: white; border-radius: 50%; animation: twinkle var(--dur, 3s) ease-in-out infinite; }
@keyframes twinkle { 0%,100%{opacity:0.2} 50%{opacity:1} }
@keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }

/* ÌéòÏù¥ÏßÄ Î†àÏù¥ÏïÑÏõÉ */
.page-center { position: fixed; inset: 0; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 24px; background: linear-gradient(180deg, rgba(3,3,8,0.95), rgba(10,10,26,0.98)); }
.page-content { max-width: 400px; width: 100%; text-align: center; }
.page-icon { font-size: 4rem; margin-bottom: 16px; animation: float 3s ease-in-out infinite; }
.page-title { font-family: 'Orbitron', monospace; font-size: clamp(1.25rem,5vw,1.75rem); font-weight: 700; margin-bottom: 20px; background: var(--gradient-energy); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
.page-text { font-size: 1rem; line-height: 1.9; color: var(--text-secondary); margin-bottom: 28px; }
.page-text .hl { color: var(--neon-cyan); font-weight: 500; }
.page-text .gold { color: var(--neon-yellow); }
.page-text .danger { color: var(--neon-pink); }

/* ÎèÑÌä∏ Ïù∏ÎîîÏºÄÏù¥ÌÑ∞ */
.dots { display: flex; justify-content: center; gap: 8px; margin-bottom: 20px; }
.dot { width: 8px; height: 8px; border-radius: 50%; background: var(--void-elevated); transition: all 0.3s; }
.dot.active { background: var(--neon-cyan); width: 24px; border-radius: 4px; }
.dot.done { background: var(--text-muted); }

/* Ï£ºÏÇ¨ÏúÑ Î∞ïÏä§ */
.dice-box { width: 140px; height: 140px; margin: 24px auto; display: flex; align-items: center; justify-content: center; font-size: 5rem; background: var(--void-surface); border: 2px solid var(--border-default); border-radius: 20px; }
.dice-box.rolling { animation: shake 0.1s linear infinite; }
@keyframes shake { 0%,100%{transform:rotate(0) scale(1)} 25%{transform:rotate(-10deg) scale(1.05)} 50%{transform:rotate(10deg) scale(0.95)} }

/* Í≤åÏûÑ Ï∫îÎ≤ÑÏä§ */
#game-canvas { position: fixed; inset: 0; z-index: 1; touch-action: none; }

/* HUD ÏÉÅÎã® */
.hud-top { position: fixed; top: 0; left: 0; right: 0; z-index: 50; padding: 12px 16px; padding-top: calc(12px + var(--safe-top)); display: flex; justify-content: space-between; align-items: flex-start; gap: 8px; pointer-events: none; }
.hud-top > * { pointer-events: auto; }
.hud-panel { background: rgba(10,10,26,0.7); border: 1px solid var(--border-default); border-radius: 14px; padding: 10px 12px; backdrop-filter: blur(8px); opacity: 0.6; transition: opacity 0.2s; }
.hud-panel:hover { opacity: 1; }
.hud-name { font-family: 'Orbitron', monospace; font-size: 0.7rem; color: var(--neon-cyan); margin-bottom: 6px; }
.hud-row { display: flex; align-items: center; gap: 6px; font-size: 0.8rem; margin-bottom: 3px; }
.hud-val { font-family: 'Orbitron', monospace; font-weight: 700; color: var(--neon-yellow); }
.hud-label { color: var(--text-muted); font-size: 0.65rem; }

/* ÌÅ¨Í∏∞ Î∞î */
.size-bar { display: flex; align-items: center; gap: 6px; margin-top: 6px; padding-top: 6px; border-top: 1px solid var(--border-subtle); }
.size-track { flex: 1; height: 6px; background: var(--void-elevated); border-radius: 3px; overflow: hidden; }
.size-fill { height: 100%; background: var(--gradient-energy); border-radius: 3px; transition: width 0.2s; }
.size-num { font-family: 'Orbitron', monospace; font-size: 0.65rem; color: var(--text-muted); }

/* ÌååÏ∏† Í∑∏Î¶¨Îìú */
.parts-grid { display: flex; flex-wrap: wrap; gap: 3px; margin-bottom: 6px; }
.part-badge { display: flex; align-items: center; gap: 2px; background: var(--void-elevated); border: 1px solid var(--border-subtle); border-radius: 5px; padding: 2px 5px; font-size: 0.65rem; }
.part-badge.on { border-color: var(--neon-cyan); box-shadow: 0 0 4px rgba(0,245,212,0.3); }
.part-cnt { font-family: 'Orbitron', monospace; font-size: 0.55rem; color: var(--neon-yellow); }

/* ÏßÑÌñâ Î∞î */
.prog-section { margin-bottom: 6px; }
.prog-label { display: flex; justify-content: space-between; font-size: 0.6rem; margin-bottom: 2px; }
.prog-left { color: var(--text-muted); }
.prog-right { color: var(--neon-cyan); font-family: 'Orbitron', monospace; }
.prog-track { height: 6px; background: var(--void-elevated); border-radius: 3px; overflow: hidden; }
.prog-fill { height: 100%; border-radius: 3px; transition: width 0.2s; }
.prog-fill.evo { background: var(--gradient-energy); }
.prog-fill.stage { background: linear-gradient(90deg, var(--neon-purple), var(--neon-pink)); }

/* HUD Î≤ÑÌäº */
.hud-btns { display: flex; gap: 6px; }
.hud-btn { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; background: rgba(10,10,26,0.92); border: 1px solid var(--border-default); border-radius: 8px; font-size: 1rem; cursor: pointer; }

/* HUD ÌïòÎã® */
.hud-bottom { position: fixed; bottom: 0; left: 0; right: 0; z-index: 50; padding: 12px 16px; padding-bottom: calc(100px + var(--safe-bottom)); pointer-events: none; }
.stage-bar { background: rgba(10,10,26,0.85); border: 1px solid var(--border-default); border-radius: 12px; padding: 10px 14px; backdrop-filter: blur(8px); }
.stage-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
.stage-cur { font-family: 'Orbitron', monospace; font-size: 0.7rem; color: var(--neon-purple); }
.stage-next { font-size: 0.65rem; color: var(--text-muted); }

/* Ïª®Ìä∏Î°§ */
.controls { position: fixed; bottom: 0; left: 0; right: 0; z-index: 60; padding: 16px 24px; padding-bottom: calc(16px + var(--safe-bottom)); display: flex; justify-content: space-between; align-items: flex-end; }
.controls.joy-right { flex-direction: row-reverse; }

.joystick { position: relative; width: 110px; height: 110px; opacity: 0.5; transition: opacity 0.2s; }
.joystick:active, .joystick:hover { opacity: 0.9; }
.joy-base { position: absolute; inset: 0; background: rgba(10,10,26,0.5); border: 2px solid var(--border-default); border-radius: 50%; }
.joy-knob { position: absolute; top: 50%; left: 50%; width: 50px; height: 50px; margin: -25px 0 0 -25px; background: var(--gradient-energy); border-radius: 50%; box-shadow: 0 0 15px rgba(0,245,212,0.4); transition: transform 0.05s; }

.action-btn { width: 70px; height: 70px; display: flex; align-items: center; justify-content: center; background: rgba(10,10,26,0.6); border: 2px solid var(--neon-cyan); border-radius: 50%; font-size: 1.5rem; cursor: pointer; box-shadow: 0 0 20px rgba(0,245,212,0.25); transition: transform 0.15s, box-shadow 0.15s, opacity 0.2s; opacity: 0.5; }
.action-btn:hover { opacity: 0.9; }
.action-btn:active { transform: scale(0.92); box-shadow: 0 0 30px rgba(0,245,212,0.5); opacity: 1; }
.action-btn.disabled { opacity: 0.3; pointer-events: none; }

/* ÌÜ†Ïä§Ìä∏ */
.toast-box { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); z-index: 500; display: flex; flex-direction: column; gap: 8px; pointer-events: none; }
.toast { display: flex; align-items: center; gap: 8px; padding: 10px 18px; background: rgba(10,10,26,0.95); border: 1px solid var(--border-default); border-radius: 10px; font-size: 0.85rem; backdrop-filter: blur(8px); animation: toastIn 0.3s ease-out, toastOut 0.3s ease-in 2.7s forwards; }
.toast.success { border-color: var(--success); }
.toast.danger { border-color: var(--danger); }
@keyframes toastIn { from{opacity:0;transform:translateY(-10px)} to{opacity:1;transform:translateY(0)} }
@keyframes toastOut { to{opacity:0;transform:translateY(-10px)} }

/* ÏßÑÌôî ÌåùÏóÖ */
.evo-popup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.8); z-index: 300; background: rgba(10,10,26,0.98); border: 2px solid var(--neon-cyan); border-radius: 20px; padding: 28px 36px; text-align: center; opacity: 0; pointer-events: none; transition: all 0.4s; box-shadow: 0 0 40px rgba(0,245,212,0.4); }
.evo-popup.show { opacity: 1; transform: translate(-50%, -50%) scale(1); }
.evo-icon { font-size: 3.5rem; margin-bottom: 10px; animation: float 2s ease-in-out infinite; }
.evo-title { font-family: 'Orbitron', monospace; font-size: 1.3rem; font-weight: 700; color: var(--neon-cyan); margin-bottom: 6px; }
.evo-desc { color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 8px; }
.evo-fx { color: var(--neon-yellow); font-size: 0.8rem; font-weight: 600; }

/* Î™®Îã¨ */
.modal { position: fixed; inset: 0; z-index: 200; display: flex; align-items: center; justify-content: center; background: rgba(3,3,8,0.92); padding: 24px; }
.modal-box { background: var(--void-surface); border: 1px solid var(--border-default); border-radius: 20px; padding: 32px 28px; max-width: 340px; width: 100%; text-align: center; }
.modal-icon { font-size: 3.5rem; margin-bottom: 12px; }
.modal-title { font-family: 'Orbitron', monospace; font-size: 1.4rem; font-weight: 700; margin-bottom: 8px; background: var(--gradient-energy); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
.modal-title.fail { background: var(--gradient-danger); -webkit-background-clip: text; background-clip: text; }
.modal-title.win { background: var(--gradient-energy); -webkit-background-clip: text; background-clip: text; }
.modal-desc { color: var(--text-secondary); font-size: 0.95rem; margin-bottom: 20px; line-height: 1.6; }
.modal-stats { background: var(--void-elevated); border-radius: 12px; padding: 14px; margin-bottom: 20px; }
.stat-row { display: flex; justify-content: space-between; padding: 6px 0; }
.stat-row:not(:last-child) { border-bottom: 1px solid var(--border-subtle); }
.stat-label { color: var(--text-muted); font-size: 0.85rem; }
.stat-val { font-family: 'Orbitron', monospace; font-weight: 700; color: var(--neon-cyan); }

/* ÏÑ∏Ïù¥Î∏å ÌéòÏù¥ÏßÄ */
.save-page { position: fixed; inset: 0; z-index: 100; background: linear-gradient(180deg, rgba(3,3,8,0.98), rgba(10,10,26,1)); padding: 16px; padding-top: calc(16px + var(--safe-top)); overflow-y: auto; }
.save-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.save-title { font-family: 'Orbitron', monospace; font-size: 1.2rem; color: var(--neon-cyan); }
.slots { display: flex; flex-direction: column; gap: 12px; max-width: 400px; margin: 0 auto; }
.slot { background: var(--void-surface); border: 1px solid var(--border-default); border-radius: 14px; padding: 16px; }
.slot.empty { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100px; cursor: pointer; transition: border-color 0.2s; }
.slot.empty:hover { border-color: var(--neon-cyan); }
.slot-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
.slot-num { font-family: 'Orbitron', monospace; font-size: 0.7rem; color: var(--neon-purple); }
.slot-name { font-family: 'Orbitron', monospace; font-size: 1rem; font-weight: 700; color: var(--neon-cyan); margin-bottom: 4px; }
.slot-info { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 12px; }
.slot-actions { display: flex; gap: 8px; }
.del-btn { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; background: transparent; border: 1px solid var(--danger); border-radius: 8px; font-size: 0.9rem; cursor: pointer; }

/* Îì±Î∞ò HUD */
.climb-hud { position: fixed; top: 0; left: 0; right: 0; z-index: 50; padding: 12px 16px; padding-top: calc(12px + var(--safe-top)); display: flex; justify-content: space-between; align-items: flex-start; pointer-events: none; }
.climb-hud > * { pointer-events: auto; }
.climb-info { background: rgba(10,10,26,0.92); border: 1px solid var(--neon-cyan); border-radius: 12px; padding: 10px 16px; text-align: center; backdrop-filter: blur(8px); }
.climb-height { font-family: 'Orbitron', monospace; font-size: 1.4rem; font-weight: 900; color: var(--neon-cyan); }
.climb-label { font-size: 0.6rem; color: var(--text-muted); }
.climb-goal { background: rgba(10,10,26,0.92); border: 1px solid var(--success); border-radius: 12px; padding: 8px 12px; text-align: center; }
.climb-goal-text { font-size: 0.65rem; color: var(--text-muted); }
.climb-goal-val { font-family: 'Orbitron', monospace; font-size: 0.9rem; font-weight: 700; color: var(--success); }

/* Îü¨ÎÑà HUD */
.runner-hud { position: fixed; top: 0; left: 0; right: 0; z-index: 50; padding: 12px 16px; padding-top: calc(12px + var(--safe-top)); display: flex; justify-content: space-between; align-items: flex-start; pointer-events: none; }
.runner-hud > * { pointer-events: auto; }
.runner-stage { background: rgba(10,10,26,0.92); border: 1px solid var(--neon-purple); border-radius: 10px; padding: 8px 14px; text-align: center; }
.runner-stage-name { font-family: 'Orbitron', monospace; font-size: 0.75rem; color: var(--neon-purple); }
.runner-dist { font-family: 'Orbitron', monospace; font-size: 0.9rem; font-weight: 700; color: var(--neon-cyan); }
    </style>
</head>
<body>
    <div id="stars-bg"></div>
    <div id="app"></div>
    <div class="toast-box" id="toasts"></div>
    <div class="evo-popup" id="evo-popup">
        <div class="evo-icon" id="evo-icon">üß¨</div>
        <div class="evo-title" id="evo-title">ÏßÑÌôî!</div>
        <div class="evo-desc" id="evo-desc"></div>
        <div class="evo-fx" id="evo-fx"></div>
    </div>
<script>
// ========================================
// BOKLUCK Universe - Configuration
// ========================================

// Firebase Ï¥àÍ∏∞Ìôî
const firebaseConfig = {
    apiKey: "AIzaSyBwQjuqgWM4YKnqu_gzNbeCg5alrC-jVcQ",
    authDomain: "myco-737a0.firebaseapp.com",
    projectId: "myco-737a0",
    storageBucket: "myco-737a0.firebasestorage.app",
    messagingSenderId: "942571332540",
    appId: "1:942571332540:web:be0bb6fbdd32655501c1b9"
};

// Firebase Ïï± Ï¥àÍ∏∞Ìôî
let firebaseApp, auth, db;
try {
    firebaseApp = firebase.initializeApp(firebaseConfig);
    auth = firebase.auth();
    db = firebase.firestore();
    console.log('üî• Firebase Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
} catch (e) {
    console.warn('Firebase Ï¥àÍ∏∞Ìôî Ïã§Ìå®:', e);
}

// ÌòÑÏû¨ ÏÇ¨Ïö©Ïûê ÏÉÅÌÉú
const Auth = {
    user: null,
    isGuest: false,
    
    // Íµ¨Í∏Ä Î°úÍ∑∏Ïù∏
    async loginWithGoogle() {
        try {
            const provider = new firebase.auth.GoogleAuthProvider();
            const result = await auth.signInWithPopup(provider);
            this.user = result.user;
            this.isGuest = false;
            await this.saveUserToFirestore();
            return { success: true, user: this.user };
        } catch (e) {
            console.error('Íµ¨Í∏Ä Î°úÍ∑∏Ïù∏ Ïã§Ìå®:', e);
            return { success: false, error: e.message };
        }
    },
    
    // Í≤åÏä§Ìä∏ Î°úÍ∑∏Ïù∏
    loginAsGuest() {
        this.user = { 
            uid: 'guest_' + Date.now(),
            displayName: 'Í≤åÏä§Ìä∏',
            isGuest: true
        };
        this.isGuest = true;
        return { success: true, user: this.user };
    },
    
    // Î°úÍ∑∏ÏïÑÏõÉ
    async logout() {
        try {
            if (!this.isGuest) await auth.signOut();
            this.user = null;
            this.isGuest = false;
            return { success: true };
        } catch (e) {
            return { success: false, error: e.message };
        }
    },
    
    // FirestoreÏóê ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Ï†ÄÏû•
    async saveUserToFirestore() {
        if (!this.user || this.isGuest || !db) return;
        try {
            await db.collection('users').doc(this.user.uid).set({
                uid: this.user.uid,
                displayName: this.user.displayName,
                email: this.user.email,
                photoURL: this.user.photoURL,
                lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
        } catch (e) {
            console.error('ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Ï†ÄÏû• Ïã§Ìå®:', e);
        }
    },
    
    // Í≤åÏûÑ ÏßÑÌñâÏÉÅÌô© Ï†ÄÏû•
    async saveProgress(data) {
        if (!this.user || this.isGuest || !db) return;
        try {
            await db.collection('users').doc(this.user.uid).collection('saves').doc('current').set({
                ...data,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            // ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
            await db.collection('users').doc(this.user.uid).update({
                lastStage: data.stage,
                lastRunnerStage: data.runnerStage || 0,
                totalScore: data.score || 0,
                lastPlayed: firebase.firestore.FieldValue.serverTimestamp()
            });
        } catch (e) {
            console.error('ÏßÑÌñâÏÉÅÌô© Ï†ÄÏû• Ïã§Ìå®:', e);
        }
    },
    
    // Í≤åÏûÑ ÏßÑÌñâÏÉÅÌô© Î∂àÎü¨Ïò§Í∏∞
    async loadProgress() {
        if (!this.user || this.isGuest || !db) return null;
        try {
            const doc = await db.collection('users').doc(this.user.uid).collection('saves').doc('current').get();
            return doc.exists ? doc.data() : null;
        } catch (e) {
            console.error('ÏßÑÌñâÏÉÅÌô© Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®:', e);
            return null;
        }
    }
};

// Ïù∏Ï¶ù ÏÉÅÌÉú Í∞êÏãú
if (auth) {
    auth.onAuthStateChanged(user => {
        if (user) {
            Auth.user = user;
            Auth.isGuest = false;
            console.log('üîê Î°úÍ∑∏Ïù∏Îê®:', user.displayName);
        }
    });
}

const CONFIG = {
    // Safari Ïù¥Î™®ÏßÄ Ìò∏Ìôò Ìè∞Ìä∏
    EMOJI_FONT: '"Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", Arial',
    GROWTH_THRESHOLD: 15,
    STAGE_THRESHOLD: 2000,
    LAND_HEIGHT: 3000,
    INITIAL_SIZE: 12,
    MAX_SIZE: 80,
    ENEMY_INTERVAL: 3500,
    MAX_ENEMIES: 7,
    MAX_FOODS: 35,
    SAVE_INTERVAL: 20000,
    RUNNER_STAGE_DIST: 350
};

// Í∏∞Î≥∏ Ïä§ÌÖü Ï†ïÏùò
const BASE_STATS = {
    speed: 3,       // Í∏∞Î≥∏ Ïù¥Îèô ÏÜçÎèÑ
    jump: 18,       // Í∏∞Î≥∏ Ï†êÌîÑÎ†•
    defense: 0,     // Í∏∞Î≥∏ Î∞©Ïñ¥Î†•
    attack: 1,      // Í∏∞Î≥∏ Í≥µÍ≤©Î†•
    score: 1,       // Ï†êÏàò Î∞∞Ïú®
    magnet: 0,      // ÏûêÏÑù Î≤îÏúÑ
    vision: 100     // ÏãúÏïº Î≤îÏúÑ (%)
};

// ÌååÏ∏†Î≥Ñ Ïä§ÌÖü Î≥¥ÎÑàÏä§ (Î™®Îì† Ìö®Í≥º)
const TRAIT_STATS = {
    // ÏÜçÎèÑ Í¥ÄÎ†®
    'ÏÜçÎèÑ +10%': { speed: 0.3 },
    'ÏÜçÎèÑ +15%': { speed: 0.5 },
    'ÏÜçÎèÑ +20%': { speed: 0.6 },
    'ÏÜçÎèÑ +25%': { speed: 0.8 },
    'ÏÜçÎèÑ +30%': { speed: 1.0 },
    'ÏÜçÎèÑ +40%': { speed: 1.2 },
    'ÏÜçÎèÑ +100%': { speed: 3.0 },
    'ÏÜçÎèÑ +200%': { speed: 6.0 },
    
    // Ï†êÌîÑ Í¥ÄÎ†®
    'Ï†êÌîÑÎ†• +20%': { jump: 4 },
    '2Îã®Ï†êÌîÑ': { jump: 6, doubleJump: true },
    'Î¨¥Ìïú Ï†êÌîÑ': { jump: 10, infiniteJump: true },
    'ÌôúÍ≥µ': { jump: 3, glide: true },
    'ÌôúÍ≥µ+ÏÜçÎèÑ': { jump: 3, glide: true, speed: 0.5 },
    'ÌôúÍ≥µ+Î∞©Ïñ¥': { jump: 3, glide: true, defense: 0.5 },
    
    // Î∞©Ïñ¥ Í¥ÄÎ†®
    'Î∞©Ïñ¥Î†• +0.5': { defense: 0.5 },
    'Î∞©Ïñ¥Î†• +0.8': { defense: 0.8 },
    'Î∞©Ïñ¥Î†• +1': { defense: 1.0 },
    'Î∞©Ïñ¥Î†• +1.2': { defense: 1.2 },
    'Î∞©Ïñ¥Î†• +1.5': { defense: 1.5 },
    'Î¨¥Ï†Å 1Ï¥à': { defense: 2, invincible: 1 },
    'Î¨¥Ï†Å ÏßÄÏÜç': { defense: 5, invincible: 999 },
    'Î¨¥Ìïú Ï≤¥Î†•': { defense: 10 },
    'Î∞òÏÇ¨ Îç∞ÎØ∏ÏßÄ': { defense: 0.5, reflect: true },
    'ÌöåÌîºÏú® +20%': { defense: 0.3, dodge: 20 },
    
    // Í≥µÍ≤© Í¥ÄÎ†®
    'Í≥µÍ≤©Î†• +1': { attack: 1.0 },
    'Í≥µÍ≤©Î†• +1.2': { attack: 1.2 },
    'Í≥µÍ≤©Î†• +1.3': { attack: 1.3 },
    'Í≥µÍ≤©Î†• +1.5': { attack: 1.5 },
    'Î≤îÏúÑ Í≥µÍ≤©': { attack: 0.8, aoe: true },
    'Í¥ÄÌÜµ Í≥µÍ≤©': { attack: 1.0, pierce: true },
    'ÌôîÏóº Í≥µÍ≤©': { attack: 1.2, fire: true },
    'ÎπôÍ≤∞ Í≥µÍ≤©': { attack: 1.0, freeze: true },
    'Í∞êÏ†Ñ Í≥µÍ≤©': { attack: 1.3, shock: true },
    'Ï†Å ÏûêÎèô ÌååÍ¥¥': { attack: 2.0, autoDestroy: true },
    
    // Ï†êÏàò/Í≤ΩÌóòÏπò
    'Ï†êÏàò +20%': { score: 0.2 },
    'Ï†êÏàò +50%': { score: 0.5 },
    'Í≤ΩÌóòÏπò +30%': { score: 0.3 },
    
    // ÏãúÏïº
    'ÏãúÏïº +25%': { vision: 25 },
    'ÏãúÏïº +30%': { vision: 30 },
    'ÏãúÏïº +40%': { vision: 40 },
    'ÏãúÏïº +50%': { vision: 50 },
    'Ï†Å ÌÉêÏßÄ': { vision: 30, detectEnemy: true },
    'Ïû•Ïï†Î¨º ÏòàÏ∏°': { vision: 50, predict: true },
    
    // ÏûêÏÑù/ÏàòÏßë
    'ÏïÑÏù¥ÌÖú ÎÅåÏñ¥ÎãπÍπÄ': { magnet: 100 },
    'ÏûêÎèô ÏïÑÏù¥ÌÖú ÏàòÏßë': { magnet: 200 },
    
    // ÌäπÏàò Ìö®Í≥º
    'ÏùÄÏã†': { speed: 0.3, stealth: true },
    'Ïä¨Î°úÏö∞ Î™®ÏÖò': { speed: 0.5, slowTime: true },
    'Î∞òÏùëÏÜçÎèÑ +50%': { speed: 0.5, reaction: 50 },
    'ÌååÏ∏† 2Î∞∞ ÌöçÎìù': { score: 0.5, doubleParts: true },
    'Ï≤¥Î†• ÌöåÎ≥µ': { defense: 0.5, regen: true },
    
    // ÎèÖ Í≥ÑÏó¥
    'ÎèÖ Î©¥Ïó≠': { defense: 0.5, poisonImmune: true },
    'ÎèÖ Ïò§Îùº': { attack: 0.8, poisonAura: true },
    'ÎèÖ Í∞ïÌôî': { attack: 1.0, poisonBoost: true },
    'ÎèÖ+Í≥µÍ≤©Î†•': { attack: 1.5, poison: true },
    
    // ÌôîÏóº Í≥ÑÏó¥
    'ÌôîÏóº Î©¥Ïó≠': { defense: 0.5, fireImmune: true },
    'ÌôîÏóº Ïò§Îùº': { attack: 1.0, fireAura: true },
    'ÌôîÏóº+Í≥µÍ≤©Î†•': { attack: 1.5, fire: true },
    
    // ÏÉÅÌÉúÏù¥ÏÉÅ
    'ÎëîÌôî Ìö®Í≥º': { attack: 0.5, slow: true },
    'ÎëîÌôî Ïò§Îùº': { attack: 0.5, slowAura: true },
    'ÎëîÌôî Î©¥Ïó≠': { speed: 0.3, slowImmune: true },
    'ÏÜçÎ∞ï Ìö®Í≥º': { attack: 0.5, bind: true },
    'Í≥µÌè¨ Ìö®Í≥º': { attack: 0.5, fear: true },
    'Ìï®Ï†ï ÏÑ§Ïπò': { attack: 1.0, trap: true }
};

// ÌòÑÏû¨ Ï¥ù Ïä§ÌÖü Í≥ÑÏÇ∞
const calculateStats = () => {
    const stats = { ...BASE_STATS };
    const traits = G.data?.evoTraits || [];
    
    traits.forEach(et => {
        const trait = getTraitById(et.id);
        if (trait && TRAIT_STATS[trait.effect]) {
            const bonus = TRAIT_STATS[trait.effect];
            Object.keys(bonus).forEach(key => {
                if (typeof bonus[key] === 'number') {
                    stats[key] = (stats[key] || 0) + bonus[key];
                } else {
                    stats[key] = bonus[key];
                }
            });
        }
    });
    
    return stats;
};

// Ïä§ÌÖåÏù¥ÏßÄ 1,2Ïö© Í∏∞Î≥∏ ÌååÏ∏†
const BODY_PARTS = {
    eye: { icon: 'üëÅÔ∏è', name: 'Îàà', max: 3, fx: 'ÏãúÏïº +20%' },
    mouth: { icon: 'üëÑ', name: 'ÏûÖ', max: 2, fx: 'Ï†êÏàò +15%' },
    arm: { icon: 'ü¶æ', name: 'Ìåî', max: 4, fx: 'ÏûêÏÑù Ìö®Í≥º' },
    leg: { icon: 'ü¶ø', name: 'Îã§Î¶¨', max: 4, fx: 'ÏÜçÎèÑ +10%' },
    tail: { icon: 'üêç', name: 'Íº¨Î¶¨', max: 2, fx: 'ÎåÄÏãú' },
    ear: { icon: 'üëÇ', name: 'Í∑Ä', max: 2, fx: 'Ï†Å Í∞êÏßÄ' },
    nose: { icon: 'üëÉ', name: 'ÏΩî', max: 2, fx: 'Î®πÏù¥ ÌÉêÏßÄ' },
    antenna: { icon: 'üì°', name: 'ÎçîÎì¨Ïù¥', max: 2, fx: 'Î≤îÏúÑ +15%' }
};

// ÌôòÍ≤Ω (Ï∂úÏÉùÏßÄ)
const ENVS = [
    { id: 'ocean', name: 'ÏõêÏãú Ìï¥Ïñë', icon: 'üåä', range: [1,16], colors: { bg1: '#001a33', bg2: '#003366', particle: '#00aaff', food: '#00ff88', enemy: '#ff4444' }, desc: 'Î∞îÎã§Îäî ÏÉùÎ™ÖÏùò ÏöîÎûå.', weak: 'Í±¥Ï°∞Ìï®ÏùÄ ÏπòÎ™ÖÏ†Å.', creatures: ['ü¶†','ü´ß','üíß','üåÄ'] },
    { id: 'hydrothermal', name: 'Ïó¥ÏàòÍµ¨', icon: 'üî•', range: [17,32], colors: { bg1: '#1a0a00', bg2: '#4d1a00', particle: '#ff6600', food: '#ffaa00', enemy: '#00ffff' }, desc: 'Í∑πÌïú ÌôòÍ≤ΩÏù¥ ÏùºÏÉÅ.', weak: 'ÌèâÏò®Ìï®Ïù¥ Î∂àÏïà.', creatures: ['üî¥','üü†','üí•','‚ö°'] },
    { id: 'ice', name: 'ÏñºÏùå Î∞îÎã§', icon: 'üßä', range: [33,48], colors: { bg1: '#0a1a2e', bg2: '#1a3a5e', particle: '#88ddff', food: '#aaeeff', enemy: '#ff6666' }, desc: 'Ìö®Ïú®Ïùò Îã¨Ïù∏.', weak: 'Îú®Í±∞ÏõÄÏùÄ ÏπòÎ™ÖÏ†Å.', creatures: ['‚ùÑÔ∏è','üîµ','üí†','ü´ß'] },
    { id: 'magma', name: 'ÎßàÍ∑∏Îßà Ìò∏Ïàò', icon: 'üåã', range: [49,64], colors: { bg1: '#1a0000', bg2: '#4d0000', particle: '#ff3300', food: '#ffff00', enemy: '#00aaff' }, desc: 'Ïö©ÏïîÏù¥ ÎÜÄÏù¥ÌÑ∞.', weak: 'ÏñºÏùåÏù¥ Î¨¥Îç§.', creatures: ['üî•','üü°','‚≠ê','üíõ'] },
    { id: 'atmosphere', name: 'ÎåÄÍ∏∞ Î∂ÄÏú†', icon: '‚òÅÔ∏è', range: [65,80], colors: { bg1: '#1a1033', bg2: '#2d1a4d', particle: '#cc88ff', food: '#ffaaff', enemy: '#ff4444' }, desc: 'ÌïòÎäòÏùÑ ÎÇòÎäî Ïûê.', weak: 'Î¨¥Í±∞ÏõÄÏù¥ Ï†Å.', creatures: ['üíú','üü£','‚ú®','üí´'] },
    { id: 'toxic', name: 'ÎèÖÏÑ± Îä™', icon: 'üíÄ', range: [81,100], colors: { bg1: '#0a1a0a', bg2: '#1a3a1a', particle: '#88ff00', food: '#aaff44', enemy: '#ff00ff' }, desc: 'ÎèÖÏù¥ Í≥ß ÏïΩ.', weak: 'Íπ®ÎÅóÌï®Ïù¥ Î∂àÌé∏.', creatures: ['üü¢','üíö','üß™','‚ò¢Ô∏è'] }
];

// Îü¨ÎÑà Ïä§ÌÖåÏù¥ÏßÄ (7Îã®Í≥Ñ)
const RUNNER_STAGES = [
    { id: 'forest', name: 'üå≤ ÏõêÏãúÏùò Ïà≤', dist: 350, bgColors: ['#1a3a1a', '#0a2a0a'], groundColor: '#3d2817', obstacles: ['ü™®', 'üå≥'], baseSpeed: 2 },
    { id: 'fire', name: 'üî• Î∂àÏùò Î∞úÍ≤¨', dist: 400, bgColors: ['#2a1a1a', '#1a0a0a'], groundColor: '#4a3020', obstacles: ['üåã', 'üíÄ'], baseSpeed: 2.5 },
    { id: 'tools', name: 'üîß ÎèÑÍµ¨Ïùò ÏãúÎåÄ', dist: 450, bgColors: ['#2a2a2a', '#1a1a1a'], groundColor: '#3a3a3a', obstacles: ['üóø', 'ü™®'], baseSpeed: 3 },
    { id: 'civilization', name: 'üèõÔ∏è Í≥†ÎåÄ Î¨∏Î™Ö', dist: 500, bgColors: ['#3a2a1a', '#2a1a0a'], groundColor: '#5a4a3a', obstacles: ['üèõÔ∏è', 'üè∫'], baseSpeed: 3.5 },
    { id: 'industry', name: 'üè≠ ÏÇ∞ÏóÖ ÌòÅÎ™Ö', dist: 550, bgColors: ['#2a2a3a', '#1a1a2a'], groundColor: '#4a4a5a', obstacles: ['‚öôÔ∏è', 'üèóÔ∏è'], baseSpeed: 4 },
    { id: 'modern', name: 'üåÜ ÌòÑÎåÄ ÏÇ¨Ìöå', dist: 600, bgColors: ['#1a2a3a', '#0a1a2a'], groundColor: '#3a4a5a', obstacles: ['üöó', 'üöß'], baseSpeed: 4.5 },
    { id: 'future', name: 'üõ∏ Ï¥àÏ≤®Îã® ÎØ∏Îûò', dist: 650, bgColors: ['#0a0a2a', '#050515'], groundColor: '#1a1a3a', obstacles: ['ü§ñ', '‚ö°'], baseSpeed: 5 }
];

// Ìó¨Ìçº Ìï®ÏàòÎì§
const envByRoll = r => ENVS.find(e => r >= e.range[0] && r <= e.range[1]);
const envById = id => ENVS.find(e => e.id === id);
// ========================================
// BOKLUCK Universe - Audio System
// Ï§ëÏ†ÄÏùå Í∏∞Î∞ò, Ï§ëÎèÖÏÑ± ÏûàÎäî ÏÇ¨Ïö¥Îìú
// ========================================

const Audio = (() => {
    let ctx = null;
    const settings = { master: 0.7, sfx: 0.8, on: true };
    
    const init = () => {
        if (!ctx) ctx = new (window.AudioContext || window.webkitAudioContext)();
        if (ctx.state === 'suspended') ctx.resume();
    };
    
    // Í∏∞Î≥∏ ÌÜ§ (Ï§ëÏ†ÄÏùå Í∏∞Î∞ò)
    const tone = (freq, dur, type = 'sine', v = 0.3) => {
        if (!settings.on || !ctx) return;
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.type = type;
        osc.frequency.value = freq;
        gain.gain.setValueAtTime(settings.master * settings.sfx * v, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + dur);
        osc.start();
        osc.stop(ctx.currentTime + dur);
    };
    
    // Î®πÍ∏∞ - Îë•Í∏ÄÍ≥† ÍπäÏùÄ ÏÜåÎ¶¨
    const playEat = () => {
        tone(120, 0.12, 'sine', 0.4);
        setTimeout(() => tone(180, 0.1, 'sine', 0.3), 60);
    };
    
    // Ï†êÌîÑ - ÌÉÑÎ†•ÏûàÎäî Ï†ÄÏùå
    const playJump = () => {
        tone(80, 0.08, 'triangle', 0.35);
        setTimeout(() => tone(150, 0.12, 'sine', 0.25), 40);
    };
    
    // Î∞îÎûå/ÌÜ†ÎÑ§Ïù¥ÎèÑ - ÏõÖÏû•Ìïú Ïä§Ïúï
    const playWind = () => {
        for (let i = 0; i < 5; i++) {
            setTimeout(() => tone(100 + i * 30, 0.15, 'sine', 0.2), i * 40);
        }
    };
    
    // ÌÅ∞ Î®πÏù¥ - ÍπäÍ≥† ÎßåÏ°±Ïä§Îü¨Ïö¥ ÏÜåÎ¶¨
    const playEatBig = () => {
        tone(80, 0.15, 'sine', 0.5);
        setTimeout(() => tone(120, 0.12, 'triangle', 0.4), 80);
        setTimeout(() => tone(160, 0.15, 'sine', 0.3), 160);
    };
    
    // ÌÅ¥Î¶≠ - ÏßßÍ≥† ÍπîÎÅîÌïú Ï†ÄÏùå
    const playClick = () => {
        tone(150, 0.05, 'sine', 0.2);
    };
    
    // Ï£ºÏÇ¨ÏúÑ Íµ¥Î¶¨Í∏∞ - Î¶¨ÎìúÎØ∏Ïª¨Ìïú Ï§ëÏ†ÄÏùå
    const playDice = () => {
        for (let i = 0; i < 10; i++) {
            setTimeout(() => {
                tone(80 + Math.random() * 100, 0.06, 'triangle', 0.15);
            }, i * 45);
        }
    };
    
    // Ï£ºÏÇ¨ÏúÑ Í≤∞Í≥º - ÎìúÎùºÎßàÌã±Ìïú Ï†ÄÏùå
    const playResult = () => {
        tone(60, 0.2, 'sine', 0.4);
        setTimeout(() => tone(90, 0.15, 'triangle', 0.35), 100);
        setTimeout(() => tone(120, 0.2, 'sine', 0.3), 200);
    };
    
    // ÏßÑÌôî - ÏÉÅÏäπÌïòÎäî ÏõÖÏû•Ìïú Î©úÎ°úÎîî (Ï§ëÏ†ÄÏùå Í∏∞Î∞ò)
    const playEvolve = () => {
        const notes = [130, 165, 196, 262]; // C3, E3, G3, C4
        notes.forEach((f, i) => setTimeout(() => {
            tone(f, 0.3, 'sine', 0.4);
            tone(f * 0.5, 0.35, 'triangle', 0.2); // Ïò•ÌÉÄÎ∏å ÏïÑÎûò Î†àÏù¥Ïñ¥
        }, i * 120));
    };
    
    // Ïã§Ìå®/ÍΩù - ÎÇÆÍ≥† ÎëîÌÉÅÌïú ÏÜåÎ¶¨
    const playFail = () => {
        tone(100, 0.2, 'sawtooth', 0.25);
        setTimeout(() => tone(70, 0.25, 'sawtooth', 0.2), 120);
    };
    
    // Ï£ΩÏùå - Î¨¥Í±∞Ïö¥ ÌïòÍ∞ï
    const playDeath = () => {
        [150, 100, 70, 50].forEach((f, i) => 
            setTimeout(() => tone(f, 0.25, 'sawtooth', 0.3), i * 100)
        );
    };
    
    // ÏäπÎ¶¨ - ÏõÖÏû•Ìïú Ìå°ÌååÎ†à (Ï†ÄÏùå Í∏∞Î∞ò)
    const playWin = () => {
        const notes = [130, 165, 196, 262, 330]; // C3-E4
        notes.forEach((f, i) => setTimeout(() => {
            tone(f, 0.4, 'sine', 0.4);
            tone(f * 0.5, 0.45, 'triangle', 0.25);
        }, i * 150));
    };
    
    // ÎåÄÏãú - Îπ†Î•¥Í≥† Í∞ïÎ†¨Ìïú Ï†ÄÏùå
    const playDash = () => {
        tone(100, 0.06, 'sawtooth', 0.3);
        tone(150, 0.08, 'triangle', 0.25);
    };
    
    // Ï∞©ÏßÄ - Î¨µÏßÅÌïú Ïøµ
    const playLand = () => {
        tone(60, 0.12, 'sine', 0.35);
    };
    
    // ÏïÑÏù¥ÌÖú ÏàòÏßë - Í∏∞Î∂Ñ Ï¢ãÏùÄ Ï†ÄÏ§ëÏùå
    const playCollect = () => {
        tone(150, 0.08, 'sine', 0.3);
        setTimeout(() => tone(200, 0.1, 'triangle', 0.25), 50);
    };
    
    // Íµ¨Î¶Ñ ÏïÑÏù¥ÌÖú - Î∂ÄÎìúÎü¨Ïö¥ ÏÉÅÏäπ
    const playCloud = () => {
        tone(120, 0.15, 'sine', 0.3);
        setTimeout(() => tone(180, 0.12, 'sine', 0.25), 80);
    };
    
    const load = () => {
        try {
            Object.assign(settings, JSON.parse(localStorage.getItem('bokluck_audio') || '{}'));
        } catch {}
    };
    
    const save = () => {
        localStorage.setItem('bokluck_audio', JSON.stringify(settings));
    };
    
    load();
    
    return {
        init, settings, save,
        playEat, playJump, playWind, playEatBig, playClick,
        playDice, playResult, playEvolve, playFail, playDeath,
        playWin, playDash, playLand, playCollect, playCloud
    };
})();
// ========================================
// BOKLUCK Universe - Storage System
// ========================================

const Settings = (() => {
    const defaults = { joyRight: true };
    let current = { ...defaults };
    
    const load = () => {
        try {
            Object.assign(current, JSON.parse(localStorage.getItem('bokluck_settings') || '{}'));
        } catch {}
    };
    
    const save = () => {
        localStorage.setItem('bokluck_settings', JSON.stringify(current));
    };
    
    const get = k => current[k];
    const set = (k, v) => { current[k] = v; save(); };
    
    load();
    return { get, set, save };
})();

const Save = (() => {
    const KEY = 'bokluck_save_';
    const MAX = 5;
    
    const create = () => ({
        v: 8,
        created: Date.now(),
        updated: Date.now(),
        playTime: 0,
        stage: 0,
        tutDone: false,
        name: null,
        score: 0,
        dna: { origin: null },
        design: null,
        parts: { eye: 0, mouth: 0, arm: 0, leg: 0, tail: 0, ear: 0, nose: 0, antenna: 0 },
        stats: { size: CONFIG.INITIAL_SIZE, speed: 3, eaten: 0, deaths: 0, maxSize: CONFIG.INITIAL_SIZE, maxH: 0 },
        runnerStage: 0,
        runnerDist: 0,      // Îü¨ÎÑà ÎàÑÏ†Å Í±∞Î¶¨
        charScale: 1,       // Ï∫êÎ¶≠ÌÑ∞ ÌÅ¨Í∏∞ Î∞∞Ïú®
        evoTraits: [],      // Ïä§ÌÖåÏù¥ÏßÄ3 ÏßÑÌôî ÌäπÏÑ± [{id, x, y, scale, rotation}]
        climbItem: null     // Ïä§ÌÖåÏù¥ÏßÄ2 ÏïÑÏù¥ÌÖú ('tornado', 'cloud', null)
    });
    
    const get = i => {
        try { return JSON.parse(localStorage.getItem(KEY + i)); }
        catch { return null; }
    };
    
    const set = (i, d) => {
        d.updated = Date.now();
        localStorage.setItem(KEY + i, JSON.stringify(d));
    };
    
    const del = i => localStorage.removeItem(KEY + i);
    
    const all = () => Array.from({ length: MAX }, (_, i) => get(i));
    
    const fmt = ts => ts ? new Date(ts).toLocaleDateString('ko-KR', {
        month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
    }) : '-';
    
    return { MAX, create, get, set, del, all, fmt };
})();

// Í≤åÏûÑ ÏÉÅÌÉú
let G = { slot: null, data: null, start: 0 };

const load = i => {
    G.slot = i;
    G.data = Save.get(i);
    G.start = Date.now();
};

const saveGame = () => {
    if (G.slot !== null && G.data) {
        G.data.playTime += Date.now() - G.start;
        G.start = Date.now();
        Save.set(G.slot, G.data);
        
        // FirebaseÏóêÎèÑ Ï†ÄÏû• (Î°úÍ∑∏Ïù∏ ÏÇ¨Ïö©ÏûêÎßå)
        if (Auth && Auth.user && !Auth.isGuest) {
            Auth.saveProgress(G.data);
        }
    }
};

const newGame = i => {
    G.slot = i;
    G.data = Save.create();
    G.start = Date.now();
    Save.set(i, G.data);
};

// Ìó¨Ìçº Ìï®ÏàòÎì§
const totalParts = () => G.data?.parts ? Object.values(G.data.parts).reduce((a, b) => a + b, 0) : 0;
const hasPart = k => (G.data?.parts?.[k] || 0) > 0;
const partCnt = k => G.data?.parts?.[k] || 0;
const nextPartThreshold = () => (totalParts() + 1) * CONFIG.GROWTH_THRESHOLD;

const addRandomPart = () => {
    const avail = Object.keys(BODY_PARTS).filter(k => G.data.parts[k] < BODY_PARTS[k].max);
    if (!avail.length) return null;
    const k = avail[Math.floor(Math.random() * avail.length)];
    G.data.parts[k]++;
    return { key: k, ...BODY_PARTS[k], cnt: G.data.parts[k] };
};

const genName = id => {
    const pre = {
        ocean: ['Ìë∏Î•∏','ÍπäÏùÄ','ÌùêÎ•¥Îäî'],
        hydrothermal: ['Îú®Í±∞Ïö¥','ÌÉÄÏò§Î•¥Îäî','Î∂àÍΩÉ'],
        ice: ['Ï∞®Í∞ÄÏö¥','ÏñºÏñ¥Î∂ôÏùÄ','ÏÑúÎ¶¨'],
        magma: ['ÏûëÏó¥ÌïòÎäî','Ïö©Ïïî','Î∂âÏùÄ'],
        atmosphere: ['Îñ†ÎèÑÎäî','Î∞îÎûåÏùò','ÌïòÎäò'],
        toxic: ['ÎèÖÏùò','ÎßπÎèÖ','ÏÇ∞ÏÑ±']
    };
    const suf = ['ÏùòÏãù','ÏÑ∏Ìè¨','Ï°¥Ïû¨','ÏòÅÌòº','ÌååÎèô'];
    const p = pre[id] || pre.ocean;
    return p[Math.floor(Math.random() * p.length)] + ' ' + suf[Math.floor(Math.random() * suf.length)];
};

const genDesign = id => {
    const cols = {
        ocean: ['#00b4d8','#0077b6'],
        hydrothermal: ['#ff6b35','#d62828'],
        ice: ['#a8dadc','#457b9d'],
        magma: ['#ff4800','#ff8500'],
        atmosphere: ['#e0aaff','#9d4edd'],
        toxic: ['#70e000','#38b000']
    };
    const c = cols[id] || cols.ocean;
    return { primary: c[0], secondary: c[1], wobble: 0.5 + Math.random() * 0.5 };
};
// ========================================
// BOKLUCK Universe - UI Helpers
// ========================================

const app = document.getElementById('app');
let canvas, ctx, gameLoop = null;
let cleanupFns = [];

const addCleanup = fn => cleanupFns.push(fn);
const cleanup = () => { cleanupFns.forEach(fn => fn()); cleanupFns = []; };

const createStars = () => {
    const c = document.getElementById('stars-bg');
    c.innerHTML = '';
    for (let i = 0; i < 60; i++) {
        const s = document.createElement('div');
        s.className = 'star';
        const size = Math.random() * 2 + 1;
        s.style.cssText = `left:${Math.random()*100}%;top:${Math.random()*100}%;width:${size}px;height:${size}px;--dur:${Math.random()*3+2}s;animation-delay:${Math.random()*3}s;`;
        c.appendChild(s);
    }
};

const toast = (msg, type = 'info') => {
    const c = document.getElementById('toasts');
    const t = document.createElement('div');
    t.className = `toast ${type}`;
    const icons = { success: '‚úÖ', danger: 'üíÄ', info: '‚ÑπÔ∏è', warning: '‚ö†Ô∏è' };
    t.innerHTML = `<span>${icons[type] || '‚ÑπÔ∏è'}</span><span>${msg}</span>`;
    c.appendChild(t);
    setTimeout(() => t.remove(), 3000);
};

const showEvo = (icon, title, desc, fx) => {
    const el = document.getElementById('evo-popup');
    document.getElementById('evo-icon').textContent = icon;
    document.getElementById('evo-title').textContent = title;
    document.getElementById('evo-desc').textContent = desc;
    document.getElementById('evo-fx').textContent = fx;
    el.classList.add('show');
    Audio.playEvolve();
    setTimeout(() => el.classList.remove('show'), 2000);
};

const resize = () => {
    if (canvas) {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
};

// ÏÉâÏÉÅ Î≥¥Í∞Ñ
const lerpCol = (a, b, t) => {
    const ah = parseInt(a.replace('#', ''), 16);
    const bh = parseInt(b.replace('#', ''), 16);
    const ar = ah >> 16, ag = (ah >> 8) & 0xff, ab = ah & 0xff;
    const br = bh >> 16, bg = (bh >> 8) & 0xff, bb = bh & 0xff;
    const rr = Math.round(ar + (br - ar) * t);
    const rg = Math.round(ag + (bg - ag) * t);
    const rb = Math.round(ab + (bb - ab) * t);
    return `#${((rr << 16) | (rg << 8) | rb).toString(16).padStart(6, '0')}`;
};
// ========================================
// BOKLUCK Universe - Region Traits
// Ïä§ÌÖåÏù¥ÏßÄ3 ÏßÑÌôî ÌäπÏÑ± (Î∂ÄÏúÑ Ï§ëÏã¨!)
// ÏÉùÎ¨º Ï†ÑÏ≤¥Í∞Ä ÏïÑÎãå ÌäπÏ†ï Î∂ÄÏúÑÎßå ÌëúÌòÑ
// ========================================

const REGION_TRAITS = {
    // ÏõêÏãú Ìï¥Ïñë - ÏàòÏ§ë Ï†ÅÏùë
    ocean: [
        { id: 'o1', icon: 'üî∫', name: 'ÏÉÅÏñ¥ ÏßÄÎäêÎü¨ÎØ∏', desc: 'ÎÇ†Ïπ¥Î°úÏö¥ Îì±ÏßÄÎäêÎü¨ÎØ∏', effect: 'ÏÜçÎèÑ +15%' },
        { id: 'o2', icon: 'üåÄ', name: 'Ìù°Î∞ò Ï¥âÏàò', desc: 'Î¨∏Ïñ¥Ïùò Ìù°Ï∞© Ï¥âÏàò', effect: 'Ï†êÌîÑÎ†• +20%' },
        { id: 'o3', icon: 'üíú', name: 'Î®πÎ¨º Ï£ºÎ®∏Îãà', desc: 'Ïò§ÏßïÏñ¥Ïùò Î®πÎ¨º Í∏∞Í¥Ä', effect: 'Î¨¥Ï†Å 1Ï¥à' },
        { id: 'o4', icon: 'üîµ', name: 'Ï°∞Í∞ú ÍªçÏßà', desc: 'Îã®Îã®Ìïú ÍªçÏßà Ï°∞Í∞Å', effect: 'Î∞©Ïñ¥Î†• +1' },
        { id: 'o5', icon: 'ü¶ê', name: 'ÏÉàÏö∞ Íº¨Î¶¨', desc: 'ÌÉÑÎ†•ÏûàÎäî Íº¨Î¶¨ Í∑ºÏú°', effect: '2Îã®Ï†êÌîÑ' },
        { id: 'o6', icon: 'üìç', name: 'Î≥µÏñ¥ Í∞ÄÏãú', desc: 'Îæ∞Ï°±Ìïú Î∞©Ïñ¥ Í∞ÄÏãú', effect: 'Î∞òÏÇ¨ Îç∞ÎØ∏ÏßÄ' },
        { id: 'o7', icon: 'ü™®', name: 'ÏÇ∞Ìò∏ Í∞ëÏò∑', desc: 'ÏÇ∞Ìò∏Ïßà Ïô∏Ìîº', effect: 'Î∞©Ïñ¥Î†• +0.5' },
        { id: 'o8', icon: '‚ö™', name: 'ÏßÑÏ£º ÏΩîÏñ¥', desc: 'ÏßÑÏ£ºÎ°ú Îêú Ìïµ', effect: 'Ï†êÏàò +20%' },
        { id: 'o9', icon: '„Ä∞Ô∏è', name: 'Î¨ºÍ≤∞ ÎπÑÎäò', desc: 'Î¨ºÍ≤∞ Î¨¥Îä¨ ÎπÑÎäò', effect: 'ÏùÄÏã†' },
        { id: 'o10', icon: 'üëÅÔ∏è', name: 'Ïã¨Ìï¥Ïñ¥ Îàà', desc: 'ÌÅ¨Í≥† Ìà¨Î™ÖÌïú Îàà', effect: 'ÏãúÏïº +25%' },
        { id: 'o11', icon: 'üèä', name: 'Í≥†Îûò Íº¨Î¶¨ÏßÄÎäêÎü¨ÎØ∏', desc: 'Í∞ïÎ†•Ìïú Íº¨Î¶¨ ÎÇ†Í∞ú', effect: 'ÏÜçÎèÑ +25%' }
    ],
    
    // Ïó¥ÏàòÍµ¨ - Í∑πÌïú ÎÇ¥Ïó¥
    hydrothermal: [
        { id: 'h1', icon: 'üî•', name: 'ÌôîÏóº ÏûÖ', desc: 'Î∂àÏùÑ ÎÇ¥ÎøúÎäî ÏûÖ', effect: 'ÌôîÏóº Í≥µÍ≤©' },
        { id: 'h2', icon: 'üü§', name: 'Ïö©Ïïî ÍªçÏßà', desc: 'Íµ≥ÏùÄ Ïö©Ïïî Í∞ëÌîº', effect: 'Î∞©Ïñ¥Î†• +1.5' },
        { id: 'h3', icon: '‚ô®Ô∏è', name: 'Ï¶ùÍ∏∞ Î∂ÑÏ∂úÍµ¨', desc: 'Îú®Í±∞Ïö¥ Ï¶ùÍ∏∞ Íµ¨Î©ç', effect: 'ÏÜçÎèÑ +20%' },
        { id: 'h4', icon: 'üå°Ô∏è', name: 'Ïó¥ Í∞êÏßÄ Ï¥âÍ∞Å', desc: 'Ïò®ÎèÑ Í∞êÏßÄ ÎçîÎì¨Ïù¥', effect: 'Ï†Å ÌÉêÏßÄ' },
        { id: 'h5', icon: '‚¨õ', name: 'ÌùëÏöîÏÑù Î∞úÌÜ±', desc: 'ÎÇ†Ïπ¥Î°úÏö¥ Í≤ÄÏùÄ Î∞úÌÜ±', effect: 'Í≥µÍ≤©Î†• +1.5' },
        { id: 'h6', icon: 'üî¥', name: 'Ïö©Ïïî Îàà', desc: 'Î∂âÍ≤å ÎπõÎÇòÎäî ÎààÏïå', effect: 'ÏãúÏïº +30%' },
        { id: 'h7', icon: 'üí•', name: 'Ìè≠Î∞ú Ï£ºÎ®∏Îãà', desc: 'ÌÑ∞ÏßÄÎäî Í∏∞Í¥Ä', effect: 'Î≤îÏúÑ Í≥µÍ≤©' },
        { id: 'h8', icon: 'üü´', name: 'ÎÇ¥Ïó¥ Í∞ÄÏ£Ω', desc: 'ÎëêÍ∫ºÏö¥ Î∞©Ïó¥ ÌîºÎ∂Ä', effect: 'Î∞©Ïñ¥Î†• +1' },
        { id: 'h9', icon: 'ü¶á', name: 'ÌôîÏÇ∞Ïû¨ ÎÇ†Í∞ú', desc: 'Ïû¨Î°ú ÎçÆÏù∏ ÎßâÎÇ†Í∞ú', effect: 'ÌôúÍ≥µ' },
        { id: 'h10', icon: '‚ö°', name: 'Î∞©Ï†Ñ Í∏∞Í¥Ä', desc: 'Ï†ÑÍ∏∞ Î∞úÏÉù Í∏∞Í¥Ä', effect: 'Í∞êÏ†Ñ Í≥µÍ≤©' },
        { id: 'h11', icon: 'üß°', name: 'ÎßàÍ∑∏Îßà Ïã¨Ïû•', desc: 'ÎÅìÎäî Ïö©Ïïî Ïã¨Ïû•', effect: 'Ï≤¥Î†• ÌöåÎ≥µ' }
    ],
    
    // ÏñºÏùå Î∞îÎã§ - ÎÉâÍ∏∞ Ï†ÅÏùë
    ice: [
        { id: 'i1', icon: '‚ùÑÔ∏è', name: 'ÏñºÏùå Í∞ëÌîº', desc: 'ÏñºÏùå Í≤∞Ï†ï ÍªçÏßà', effect: 'Î∞©Ïñ¥Î†• +1.5' },
        { id: 'i2', icon: 'üßä', name: 'ÎÉâÍ∏∞ ÏûÖ', desc: 'ÏñºÏùåÏùÑ ÎÇ¥ÎøúÎäî ÏûÖ', effect: 'ÎπôÍ≤∞ Í≥µÍ≤©' },
        { id: 'i3', icon: 'üíé', name: 'Í≤∞Ï†ï Îøî', desc: 'Ìà¨Î™ÖÌïú ÏñºÏùå Îøî', effect: 'Í≥µÍ≤©Î†• +1.5' },
        { id: 'i4', icon: 'üå®Ô∏è', name: 'ÎààÍΩÉ ÎÇ†Í∞úÎßâ', desc: 'ÏñºÏùå Í≤∞Ï†ï ÎÇ†Í∞ú', effect: 'ÌôúÍ≥µ' },
        { id: 'i5', icon: 'üîπ', name: 'Î¨ºÎ≤î Íº¨Î¶¨ÏßÄÎäêÎü¨ÎØ∏', desc: 'ÎëêÍ∫ºÏö¥ ÏßÄÎ∞© Íº¨Î¶¨', effect: 'ÏÜçÎèÑ +10%' },
        { id: 'i6', icon: 'üêæ', name: 'Î∂ÅÍ∑πÍ≥∞ Î∞úÎ∞îÎã•', desc: 'ÌÑ∏ Îã¨Î¶∞ ÌÅ∞ Î∞ú', effect: 'Í≥µÍ≤©Î†• +1.3' },
        { id: 'i7', icon: 'üí†', name: 'Îã§Ïù¥ÏïÑÎ™¨Îìú Îàà', desc: 'ÎπõÎÇòÎäî Î≥¥ÏÑù Îàà', effect: 'ÏãúÏïº +40%' },
        { id: 'i8', icon: 'üå¨Ô∏è', name: 'ÌïúÌåå Î∂ÑÏ∂úÍµ¨', desc: 'ÎÉâÍ∏∞ Î∞©Ï∂ú Íµ¨Î©ç', effect: 'ÎëîÌôî Ïò§Îùº' },
        { id: 'i9', icon: '‚ö™', name: 'ÎààÎç©Ïù¥ Î™∏ÌÜµ', desc: 'Îë•Í∏ÄÍ≥† Ìù∞ Î™∏Ï≤¥', effect: 'Î∞©Ïñ¥Î†• +1' },
        { id: 'i10', icon: 'üî∑', name: 'ÎπôÏÇ∞ Îì±Ìåê', desc: 'Îæ∞Ï°±Ìïú ÏñºÏùå Îì±', effect: 'Î∞òÏÇ¨ Îç∞ÎØ∏ÏßÄ' },
        { id: 'i11', icon: 'ü©µ', name: 'ÏÑúÎ¶¨ Ïã¨Ïû•', desc: 'Ï∞®Í∞ÄÏö¥ ÏñºÏùå Ïã¨Ïû•', effect: 'ÎëîÌôî Î©¥Ïó≠' }
    ],
    
    // ÎßàÍ∑∏Îßà Ìò∏Ïàò - ÌôîÏóº ÏßÑÌôî
    magma: [
        { id: 'm1', icon: 'üê≤', name: 'Ïö©Ïùò Îøî', desc: 'Ïö©Ï≤òÎüº ÏÉùÍ∏¥ Î®∏Î¶¨Îøî', effect: 'ÌôîÏóº+Í≥µÍ≤©Î†•' },
        { id: 'm2', icon: 'üî•', name: 'Î∂àÍΩÉ Í∞àÍ∏∞', desc: 'ÌÉÄÏò§Î•¥Îäî Î™©ÌÑ∏', effect: 'ÌôîÏóº Ïò§Îùº' },
        { id: 'm3', icon: '‚≠ê', name: 'Î≥ÑÏùò ÏΩîÏñ¥', desc: 'ÌÉúÏñëÍ∞ôÏùÄ Ìïµ Í∏∞Í¥Ä', effect: 'Ï†êÏàò +50%' },
        { id: 'm4', icon: 'üü†', name: 'Ïö©Ïïî ÌîºÎ∂Ä', desc: 'Îú®Í±∞Ïö¥ Ï£ºÌô© ÌîºÎ∂Ä', effect: 'ÌôîÏóº Î©¥Ïó≠' },
        { id: 'm5', icon: 'üü°', name: 'Ìô©Í∏à ÎπÑÎäò', desc: 'ÎπõÎÇòÎäî Í∏àÎπõ ÎπÑÎäò', effect: 'Î∞©Ïñ¥Î†• +1.2' },
        { id: 'm6', icon: 'üå∫', name: 'ÌôîÏóº ÍΩÉÍ¥Ä', desc: 'Î∂àÍΩÉ Î™®Ïñë Ïû•Ïãù', effect: 'Í≥µÍ≤©Î†• +1' },
        { id: 'm7', icon: 'üåü', name: 'ÌÉúÏñë ÎààÏïå', desc: 'ÎààÎ∂ÄÏã† ÎπõÏùò Îàà', effect: 'ÏãúÏïº +50%' },
        { id: 'm8', icon: 'üî∏', name: 'Î£®ÎπÑ Î∞úÌÜ±', desc: 'Î∂âÏùÄ Î≥¥ÏÑù Î∞úÌÜ±', effect: 'Í≥µÍ≤©Î†• +1.3' },
        { id: 'm9', icon: '‚ù§Ô∏è‚Äçüî•', name: 'Ïö©Ïïî Ïã¨Ïû•', desc: 'ÎÅìÏñ¥Ïò§Î•¥Îäî Ïã¨Ïû•', effect: 'Ï≤¥Î†• ÌöåÎ≥µ' },
        { id: 'm10', icon: 'üî∂', name: 'ÏÉàÎ≤Ω ÎÇ†Í∞úÎßâ', desc: 'ÎπõÎÇòÎäî Îßâ ÎÇ†Í∞ú', effect: 'ÌôúÍ≥µ+ÏÜçÎèÑ' },
        { id: 'm11', icon: 'üí´', name: 'ÌòúÏÑ± Íº¨Î¶¨', desc: 'Î∂àÌÉÄÎäî Í∏¥ Íº¨Î¶¨', effect: 'ÏÜçÎèÑ +30%' }
    ],
    
    // ÎåÄÍ∏∞ Î∂ÄÏú† - ÎπÑÌñâ ÌäπÌôî
    atmosphere: [
        { id: 'a1', icon: 'ü¶ã', name: 'ÎÇòÎπÑ ÎÇ†Í∞ú', desc: 'Î¨¥ÏßÄÍ∞úÎπõ Î∞ïÎßâ ÎÇ†Í∞ú', effect: 'ÌôúÍ≥µ+ÏÜçÎèÑ' },
        { id: 'a2', icon: 'üåà', name: 'Î¨¥ÏßÄÍ∞ú ÎπÑÎäò', desc: 'ÎπõÏùÑ Î∞òÏÇ¨ÌïòÎäî ÎπÑÎäò', effect: 'ÏùÄÏã†' },
        { id: 'a3', icon: '‚òÅÔ∏è', name: 'Íµ¨Î¶Ñ Íº¨Î¶¨', desc: 'Î≠âÍ≤åÍµ¨Î¶Ñ Í∞ôÏùÄ Íº¨Î¶¨', effect: 'ÌôúÍ≥µ' },
        { id: 'a4', icon: 'üíú', name: 'Î≥¥Îùº ÌõÑÍ¥ë', desc: 'Ïã†ÎπÑÎ°úÏö¥ Îπõ Í≥†Î¶¨', effect: 'Í≤ΩÌóòÏπò +30%' },
        { id: 'a5', icon: 'üå∏', name: 'ÍΩÉÏûé Í∞ëÌîº', desc: 'ÍΩÉÏûé Î™®Ïñë ÍªçÏßà', effect: 'Î∞©Ïñ¥Î†• +0.8' },
        { id: 'a6', icon: '‚ú®', name: 'Î≥ÑÎπõ Îàà', desc: 'Î∞òÏßùÏù¥Îäî ÌÅ∞ Îàà', effect: 'ÏãúÏïº +40%' },
        { id: 'a7', icon: 'üéê', name: 'Î∞îÎûå Ï¢Ö ÎçîÎì¨Ïù¥', desc: 'ÏÜåÎ¶¨ÎÇòÎäî ÎçîÎì¨Ïù¥', effect: 'Ï†Å ÌÉêÏßÄ' },
        { id: 'a8', icon: 'üåô', name: 'Îã¨Îπõ Îøî', desc: 'Ï¥àÏäπÎã¨ Î™®Ïñë Îøî', effect: 'Í≥µÍ≤©Î†• +1.2' },
        { id: 'a9', icon: 'üí´', name: 'Ïú†ÏÑ± Íº¨Î¶¨', desc: 'ÎπõÎÇòÎäî ÏûîÏÉÅ Íº¨Î¶¨', effect: 'ÏÜçÎèÑ +25%' },
        { id: 'a10', icon: 'üîÆ', name: 'ÏàòÏ†ï ÎààÏïå', desc: 'ÏòàÏßÄÎ†• ÏûàÎäî Îàà', effect: 'ÌöåÌîºÏú® +20%' },
        { id: 'a11', icon: 'ü™Ω', name: 'Ï≤úÏÇ¨ ÍπÉÌÑ∏', desc: 'ÏàúÎ∞±Ïùò ÌÅ∞ ÍπÉÌÑ∏', effect: 'ÌôúÍ≥µ+Î∞©Ïñ¥' }
    ],
    
    // ÎèÖÏÑ± Îä™ - ÎèÖ/ÏÇ∞ÏÑ± ÌäπÌôî
    toxic: [
        { id: 't1', icon: 'ü¶∑', name: 'ÎèÖÎãà', desc: 'ÎèÖÏù¥ Îì† ÏÜ°Í≥≥Îãà', effect: 'ÎèÖ+Í≥µÍ≤©Î†•' },
        { id: 't2', icon: 'üü¢', name: 'ÎèÖÍ∞úÍµ¨Î¶¨ ÌîºÎ∂Ä', desc: 'ÎèÖ Î∂ÑÎπÑ ÌîºÎ∂Ä', effect: 'ÎèÖ Ïò§Îùº' },
        { id: 't3', icon: 'üß™', name: 'ÏÇ∞ÏÑ± Ïπ®ÏÉò', desc: 'ÎÖπÏù¥Îäî Ïπ® Í∏∞Í¥Ä', effect: 'Í¥ÄÌÜµ Í≥µÍ≤©' },
        { id: 't4', icon: '‚ò¢Ô∏è', name: 'Î∞©ÏÇ¨Îä• Îàà', desc: 'ÌòïÍ¥ëÎπõ ÎààÏïå', effect: 'ÏãúÏïº +30%' },
        { id: 't5', icon: 'üçÑ', name: 'Î≤ÑÏÑØ Í∞ì', desc: 'Ìè¨Ïûê Î∞©Ï∂ú Í∞ì', effect: 'ÎëîÌôî Ìö®Í≥º' },
        { id: 't6', icon: 'ü¶µ', name: 'ÏßÄÎÑ§ Îã§Î¶¨', desc: 'ÏàòÎßéÏùÄ ÎßàÎîî Îã§Î¶¨', effect: 'ÏÜçÎèÑ +40%' },
        { id: 't7', icon: 'üï∏Ô∏è', name: 'Í±∞ÎØ∏ Ïã§ÏÉò', desc: 'Í±∞ÎØ∏Ï§Ñ Î∂ÑÎπÑ Í∏∞Í¥Ä', effect: 'Ìï®Ï†ï ÏÑ§Ïπò' },
        { id: 't8', icon: 'üíö', name: 'ÎèÖ Ïã¨Ïû•', desc: 'ÎßπÎèÖ Ï†ÄÏû• Ïã¨Ïû•', effect: 'ÎèÖ Î©¥Ïó≠' },
        { id: 't9', icon: 'ü´ß', name: 'ÎèÖ Ï£ºÎ®∏Îãà', desc: 'ÎèÖÏï° Ï†ÄÏû• Í∏∞Í¥Ä', effect: 'ÎèÖ Í∞ïÌôî' },
        { id: 't10', icon: 'üåø', name: 'Îç©Íµ¥ Ï¥âÏàò', desc: 'Í∞êÏïÑÎ∂ôÎäî Îç©Íµ¥Ìåî', effect: 'ÏÜçÎ∞ï Ìö®Í≥º' },
        { id: 't11', icon: 'üíÄ', name: 'Ìï¥Í≥® Í∞ÄÎ©¥', desc: 'ÎºàÎ°ú Îêú ÏñºÍµ¥Ìåê', effect: 'Í≥µÌè¨ Ìö®Í≥º' }
    ],
    
    // Ï¥àÏ≤®Îã® ÎØ∏Îûò - Í≥µÌÜµ Í∏∞Ïà† ÌååÏ∏† (ÎßàÏßÄÎßâ Ïä§ÌÖåÏù¥ÏßÄ)
    future: [
        { id: 'f1', icon: 'ü¶ø', name: 'ÏñëÏûê Îã§Î¶¨', desc: 'ÏàúÍ∞ÑÏù¥Îèô Í∞ÄÎä•Ìïú Îã§Î¶¨', effect: 'ÏÜçÎèÑ +100%' },
        { id: 'f2', icon: 'üß†', name: 'Îâ¥Îü¥ÎßÅÌÅ¨', desc: 'ÎëêÎáå ÏßÅÍ≤∞ Ïù∏ÌÑ∞ÌéòÏù¥Ïä§', effect: 'Î∞òÏùëÏÜçÎèÑ +50%' },
        { id: 'f3', icon: 'üõ∏', name: 'Î∞òÏ§ëÎ†• Î™®Îìà', desc: 'Ï§ëÎ†• Î¨¥Ïãú Ïû•Ïπò', effect: 'Î¨¥Ìïú Ï†êÌîÑ' },
        { id: 'f4', icon: 'üëÅÔ∏è', name: 'ÌÄÄÌÖÄ ÏïÑÏù¥', desc: 'ÎØ∏ÎûòÎ•º Î≥¥Îäî Îàà', effect: 'Ïû•Ïï†Î¨º ÏòàÏ∏°' },
        { id: 'f5', icon: 'üí†', name: 'ÌîåÎùºÏ¶àÎßà ÏΩîÏñ¥', desc: 'ÌÉúÏñë ÏóêÎÑàÏßÄ Ïã¨Ïû•', effect: 'Î¨¥Ìïú Ï≤¥Î†•' },
        { id: 'f6', icon: 'üåÄ', name: 'ÏõúÌôÄ Ìåî', desc: 'Í≥µÍ∞ÑÏùÑ ÏôúÍ≥°ÌïòÎäî Ìåî', effect: 'ÏïÑÏù¥ÌÖú ÎÅåÏñ¥ÎãπÍπÄ' },
        { id: 'f7', icon: '‚ö°', name: 'ÌÖåÏä¨Îùº ÏΩîÏùº', desc: 'Ï†ÑÍ∏∞Ïû• ÏÉùÏÑ±Í∏∞', effect: 'Ï†Å ÏûêÎèô ÌååÍ¥¥' },
        { id: 'f8', icon: 'üîÆ', name: 'ÌÉÄÏûÑ ÌÅ¨Î¶¨Ïä§ÌÉà', desc: 'ÏãúÍ∞ÑÏùÑ Îä¶Ï∂îÎäî Ïû•Ïπò', effect: 'Ïä¨Î°úÏö∞ Î™®ÏÖò' },
        { id: 'f9', icon: 'üåå', name: 'Îã§ÌÅ¨Îß§ÌÑ∞ Í∞ëÏò∑', desc: 'ÏïîÌùëÎ¨ºÏßà Î≥¥Ìò∏Îßâ', effect: 'Î¨¥Ï†Å ÏßÄÏÜç' },
        { id: 'f10', icon: '‚òÑÔ∏è', name: 'ÌïòÏù¥Ìçº Î∂ÄÏä§ÌÑ∞', desc: 'Í¥ëÏÜç Ï∂îÏßÑÍ∏∞', effect: 'ÏÜçÎèÑ +200%' },
        { id: 'f11', icon: 'üß¨', name: 'ÏßÑÌôî Ï¥âÎß§', desc: 'Ï¶âÍ∞Å Î≥ÄÏù¥ Ïû•Ïπò', effect: 'ÌååÏ∏† 2Î∞∞ ÌöçÎìù' },
        { id: 'f12', icon: 'ü§ñ', name: 'AI ÎèôÎ∞òÏûê', desc: 'ÏûêÏú® Ï†ÑÌà¨ ÎìúÎ°†', effect: 'ÏûêÎèô ÏïÑÏù¥ÌÖú ÏàòÏßë' }
    ]
};

// ÌòÑÏû¨ ÏßÄÏó≠Ïùò ÌäπÏÑ± Í∞ÄÏ†∏Ïò§Í∏∞ (ÎßàÏßÄÎßâ Ïä§ÌÖåÏù¥ÏßÄÎäî future)
const getRegionTraits = () => {
    if (G.data?.runnerStage >= 6) return REGION_TRAITS.future;
    return REGION_TRAITS[G.data?.dna?.origin] || REGION_TRAITS.ocean;
};

// IDÎ°ú ÌäπÏÑ± Ï∞æÍ∏∞ (Î™®Îì† ÏßÄÏó≠ÏóêÏÑú)
const getTraitById = id => {
    for (const region of Object.values(REGION_TRAITS)) {
        const t = region.find(tr => tr.id === id);
        if (t) return t;
    }
    return null;
};
// ========================================
// BOKLUCK Universe - Cell World (Stage 1)
// Í∏∞Ï°¥ ÌååÏ∏† ÏãúÏä§ÌÖú Ïú†ÏßÄ (Ï£ºÏÇ¨ÏúÑ ÏóÜÏùå)
// ========================================

let player, foods = [], enemies = [], particles = [];
let joyPos = { x: 0, y: 0 }, joyActive = false, keys = {};
let lastSpawn = 0, dashCD = 0, dashing = false;

const startCellWorld = () => {
    cleanup();
    const env = envById(G.data.dna.origin);
    const joyRight = Settings.get('joyRight');
    
    app.innerHTML = `
        <canvas id="game-canvas"></canvas>
        <div class="hud-top">
            <div class="hud-panel" style="min-width:120px">
                <div class="hud-name">${G.data.name}</div>
                <div class="hud-row"><span>‚ö°</span><span class="hud-val" id="h-score">${G.data.score}</span><span class="hud-label">Ï†êÏàò</span></div>
                <div class="hud-row"><span>üç¥</span><span class="hud-val" id="h-eaten">${G.data.stats.eaten}</span><span class="hud-label">ÏÑ≠Ï∑®</span></div>
                <div class="size-bar">
                    <span style="font-size:0.6rem">üìè</span>
                    <div class="size-track"><div class="size-fill" id="h-size" style="width:${(G.data.stats.size/CONFIG.MAX_SIZE)*100}%"></div></div>
                    <span class="size-num" id="h-sizeN">${Math.round(G.data.stats.size)}</span>
                </div>
            </div>
            <div class="hud-panel" style="max-width:150px">
                <div style="font-family:Orbitron;font-size:0.55rem;color:var(--text-muted);margin-bottom:4px;">üß¨ Ïã†Ï≤¥ ÌååÏ∏†</div>
                <div class="parts-grid" id="h-parts"></div>
                <div class="prog-section">
                    <div class="prog-label"><span class="prog-left">Îã§Ïùå ÌååÏ∏†</span><span class="prog-right" id="h-partP">0/${CONFIG.GROWTH_THRESHOLD}</span></div>
                    <div class="prog-track"><div class="prog-fill evo" id="h-partB" style="width:0%"></div></div>
                </div>
            </div>
            <div class="hud-btns">
                <button class="hud-btn" id="btn-clear" title="ÌÖåÏä§Ìä∏ ÌÅ¥Î¶¨Ïñ¥" style="background:var(--success);color:white;">‚úì</button>
                <button class="hud-btn" id="btn-home">üè†</button>
                <button class="hud-btn" id="btn-pause">‚è∏Ô∏è</button>
            </div>
        </div>
        <div class="hud-bottom">
            <div class="stage-bar">
                <div class="stage-row">
                    <span class="stage-cur">ü¶† ÏÑ∏Ìè¨</span>
                    <span class="stage-next">Îã§ÏÑ∏Ìè¨: <span id="h-stageP">${G.data.score}/${CONFIG.STAGE_THRESHOLD}</span></span>
                </div>
                <div class="prog-track"><div class="prog-fill stage" id="h-stageB" style="width:${(G.data.score/CONFIG.STAGE_THRESHOLD)*100}%"></div></div>
            </div>
        </div>
        <div class="controls ${joyRight ? 'joy-right' : ''}">
            <div class="joystick" id="joy"><div class="joy-base"></div><div class="joy-knob" id="joy-knob"></div></div>
            <button class="action-btn ${hasPart('tail')?'':'disabled'}" id="btn-dash">üí®</button>
        </div>
    `;
    
    updatePartsUI();
    canvas = document.getElementById('game-canvas');
    ctx = canvas.getContext('2d');
    resize();
    
    window.addEventListener('resize', resize);
    addCleanup(() => window.removeEventListener('resize', resize));
    
    player = { x: canvas.width / 2, y: canvas.height / 2, size: G.data.stats.size, vx: 0, vy: 0 };
    foods = []; enemies = []; particles = [];
    spawnFoods(CONFIG.MAX_FOODS);
    
    setupCellControls();
    setupCellHUD();
    
    lastSpawn = Date.now();
    gameLoop = requestAnimationFrame(updateCell);
};

const updatePartsUI = () => {
    const el = document.getElementById('h-parts');
    if (!el) return;
    let html = '';
    Object.keys(BODY_PARTS).forEach(k => {
        const cnt = G.data.parts[k] || 0;
        if (cnt > 0) html += `<div class="part-badge on"><span>${BODY_PARTS[k].icon}</span><span class="part-cnt">√ó${cnt}</span></div>`;
    });
    el.innerHTML = html || '<span style="font-size:0.6rem;color:var(--text-muted)">ÏóÜÏùå</span>';
};

const spawnFoods = n => {
    const env = envById(G.data.dna.origin);
    for (let i = 0; i < n; i++) {
        foods.push({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height,
            size: 4 + Math.random() * 8,
            color: env.colors.food,
            vx: (Math.random() - 0.5) * 0.3,
            vy: (Math.random() - 0.5) * 0.3,
            type: env.creatures[Math.floor(Math.random() * env.creatures.length)]
        });
    }
};

const spawnEnemy = () => {
    const ps = player.size;
    const smaller = Math.random() < 0.4;
    let sz = smaller ? ps * (0.3 + Math.random() * 0.5) : ps * (1.2 + Math.random() * 0.8);
    sz = Math.max(8, Math.min(sz, 100));
    
    let x, y;
    const side = Math.floor(Math.random() * 4);
    if (side === 0) { x = -50; y = Math.random() * canvas.height; }
    else if (side === 1) { x = canvas.width + 50; y = Math.random() * canvas.height; }
    else if (side === 2) { x = Math.random() * canvas.width; y = -50; }
    else { x = Math.random() * canvas.width; y = canvas.height + 50; }
    
    enemies.push({ x, y, size: sz, speed: 1 + Math.random() * 1.5, angle: Math.random() * Math.PI * 2, wobble: Math.random() });
};

const setupCellControls = () => {
    const joy = document.getElementById('joy');
    const knob = document.getElementById('joy-knob');
    
    const move = (cx, cy) => {
        const r = joy.getBoundingClientRect();
        const cX = r.left + r.width / 2;
        const cY = r.top + r.height / 2;
        const maxD = r.width / 2 - 20;
        let dx = cx - cX, dy = cy - cY;
        const dist = Math.sqrt(dx * dx + dy * dy);
        if (dist > maxD) { dx = dx / dist * maxD; dy = dy / dist * maxD; }
        knob.style.transform = `translate(${dx}px, ${dy}px)`;
        joyPos = { x: dx / maxD, y: dy / maxD };
    };
    
    const end = () => { joyActive = false; knob.style.transform = ''; joyPos = { x: 0, y: 0 }; };
    
    joy.addEventListener('touchstart', e => { e.preventDefault(); joyActive = true; move(e.touches[0].clientX, e.touches[0].clientY); }, { passive: false });
    joy.addEventListener('touchmove', e => { e.preventDefault(); if (joyActive) move(e.touches[0].clientX, e.touches[0].clientY); }, { passive: false });
    joy.addEventListener('touchend', end);
    joy.addEventListener('mousedown', e => { joyActive = true; move(e.clientX, e.clientY); });
    window.addEventListener('mousemove', e => { if (joyActive) move(e.clientX, e.clientY); });
    window.addEventListener('mouseup', end);
    
    window.addEventListener('keydown', e => { keys[e.key.toLowerCase()] = true; if (e.key === ' ') tryDash(); });
    window.addEventListener('keyup', e => { keys[e.key.toLowerCase()] = false; });
    
    document.getElementById('btn-dash').onclick = tryDash;
};

const tryDash = () => {
    if (!hasPart('tail') || dashCD > 0 || dashing) return;
    dashing = true; dashCD = 3000;
    Audio.playDash();
    const spd = 15;
    const dir = { x: joyPos.x || (keys.d ? 1 : keys.a ? -1 : 0), y: joyPos.y || (keys.s ? 1 : keys.w ? -1 : 0) };
    const len = Math.sqrt(dir.x * dir.x + dir.y * dir.y) || 1;
    player.vx = dir.x / len * spd;
    player.vy = dir.y / len * spd;
    setTimeout(() => { dashing = false; }, 200);
};

const setupCellHUD = () => {
    document.getElementById('btn-clear').onclick = () => {
        Audio.playClick();
        // ÌÖåÏä§Ìä∏Ïö© Ï¶âÏãú ÏßÑÌôî
        G.data.score = CONFIG.STAGE_THRESHOLD;
        while (totalParts() < 5) addRandomPart();
        cellEvolve();
    };
    document.getElementById('btn-home').onclick = () => {
        Audio.playClick();
        if (confirm('ÌôàÏúºÎ°ú?')) { cancelAnimationFrame(gameLoop); gameLoop = null; saveGame(); renderSaves(); }
    };
    document.getElementById('btn-pause').onclick = () => {
        Audio.playClick();
        const btn = document.getElementById('btn-pause');
        if (gameLoop) { cancelAnimationFrame(gameLoop); gameLoop = null; btn.textContent = '‚ñ∂Ô∏è'; }
        else { gameLoop = requestAnimationFrame(updateCell); btn.textContent = '‚è∏Ô∏è'; }
    };
};

const updateCell = () => {
    if (!canvas || !ctx) return;
    const env = envById(G.data.dna.origin);
    
    if (dashCD > 0) dashCD -= 16;
    
    let ix = joyPos.x, iy = joyPos.y;
    if (keys.w || keys.arrowup) iy = -1;
    if (keys.s || keys.arrowdown) iy = 1;
    if (keys.a || keys.arrowleft) ix = -1;
    if (keys.d || keys.arrowright) ix = 1;
    
    const spd = G.data.stats.speed + partCnt('leg') * 0.4;
    if (!dashing) { player.vx = ix * spd; player.vy = iy * spd; }
    else { player.vx *= 0.95; player.vy *= 0.95; }
    
    player.x += player.vx; player.y += player.vy;
    player.x = Math.max(player.size, Math.min(canvas.width - player.size, player.x));
    player.y = Math.max(player.size, Math.min(canvas.height - player.size, player.y));
    
    // Ï†Å Ïä§Ìè∞
    if (Date.now() - lastSpawn > CONFIG.ENEMY_INTERVAL && enemies.length < CONFIG.MAX_ENEMIES) {
        spawnEnemy(); lastSpawn = Date.now();
    }
    
    // ÏûêÏÑù Ìö®Í≥º
    const magnet = hasPart('arm') ? 70 + partCnt('arm') * 18 : 0;
    
    // Î®πÏù¥ Ï≤òÎ¶¨
    for (let i = foods.length - 1; i >= 0; i--) {
        const f = foods[i];
        f.x += f.vx; f.y += f.vy;
        if (f.x < -30) f.x = canvas.width + 30; if (f.x > canvas.width + 30) f.x = -30;
        if (f.y < -30) f.y = canvas.height + 30; if (f.y > canvas.height + 30) f.y = -30;
        
        const dx = player.x - f.x, dy = player.y - f.y;
        const dist = Math.sqrt(dx * dx + dy * dy);
        
        if (magnet && dist < magnet) { f.x += dx * 0.03; f.y += dy * 0.03; }
        
        if (dist < player.size + f.size * 0.4) {
            Audio.playEat();
            player.size = Math.min(CONFIG.MAX_SIZE, player.size + f.size * 0.12);
            G.data.stats.size = player.size;
            G.data.stats.eaten++;
            G.data.score += Math.floor(f.size * 2 * (1 + partCnt('mouth') * 0.15));
            checkCellEvo();
            foods.splice(i, 1);
            setTimeout(() => { if (foods.length < CONFIG.MAX_FOODS) spawnFoods(1); }, 400);
        }
    }
    
    // Ï†Å Ï≤òÎ¶¨
    for (let i = enemies.length - 1; i >= 0; i--) {
        const e = enemies[i];
        const dx = player.x - e.x, dy = player.y - e.y;
        const dist = Math.sqrt(dx * dx + dy * dy);
        const danger = e.size > player.size;
        
        if (danger) { e.x += dx / dist * e.speed * 0.45; e.y += dy / dist * e.speed * 0.45; }
        else { e.x -= dx / dist * e.speed * 0.25; e.y -= dy / dist * e.speed * 0.25; }
        
        e.angle += (Math.random() - 0.5) * 0.08;
        e.x += Math.cos(e.angle) * e.speed * 0.25;
        e.y += Math.sin(e.angle) * e.speed * 0.25;
        
        if (e.x < -200 || e.x > canvas.width + 200 || e.y < -200 || e.y > canvas.height + 200) {
            enemies.splice(i, 1); continue;
        }
        
        if (dist < player.size + e.size * 0.55) {
            if (danger) { gameOverCell(); return; }
            else {
                Audio.playEatBig();
                player.size = Math.min(CONFIG.MAX_SIZE, player.size + e.size * 0.2);
                G.data.stats.size = player.size;
                G.data.stats.eaten++;
                G.data.score += Math.floor(e.size * 4 * (1 + partCnt('mouth') * 0.15));
                checkCellEvo();
                enemies.splice(i, 1);
            }
        }
    }
    
    renderCell(env);
    updateCellHUD();
    
    // Îã§ÏÑ∏Ìè¨ ÏßÑÌôî Ï≤¥ÌÅ¨
    if (G.data.stage === 1 && G.data.score >= CONFIG.STAGE_THRESHOLD && totalParts() >= 5) {
        evolveMulti();
        return;
    }
    
    gameLoop = requestAnimationFrame(updateCell);
};

const checkCellEvo = () => {
    const threshold = nextPartThreshold();
    if (G.data.stats.eaten >= threshold) {
        const part = addRandomPart();
        if (part) {
            showEvo(part.icon, `${part.name} ÌöçÎìù!`, `${part.name} √ó${part.cnt}`, part.fx);
            updatePartsUI();
            if (part.key === 'tail') document.getElementById('btn-dash')?.classList.remove('disabled');
            saveGame();
        }
    }
};

const updateCellHUD = () => {
    const $ = id => document.getElementById(id);
    if (!$('h-score')) return;
    $('h-score').textContent = G.data.score;
    $('h-eaten').textContent = G.data.stats.eaten;
    $('h-size').style.width = `${(player.size / CONFIG.MAX_SIZE) * 100}%`;
    $('h-sizeN').textContent = Math.round(player.size);
    
    const base = totalParts() * CONFIG.GROWTH_THRESHOLD;
    const prog = ((G.data.stats.eaten - base) / CONFIG.GROWTH_THRESHOLD) * 100;
    $('h-partB').style.width = `${Math.min(100, Math.max(0, prog))}%`;
    $('h-partP').textContent = `${Math.max(0, G.data.stats.eaten - base)}/${CONFIG.GROWTH_THRESHOLD}`;
    $('h-stageB').style.width = `${Math.min(100, (G.data.score / CONFIG.STAGE_THRESHOLD) * 100)}%`;
    $('h-stageP').textContent = `${G.data.score}/${CONFIG.STAGE_THRESHOLD}`;
};

const renderCell = env => {
    const w = canvas.width, h = canvas.height;
    const bg = ctx.createLinearGradient(0, 0, 0, h);
    bg.addColorStop(0, env.colors.bg1);
    bg.addColorStop(1, env.colors.bg2);
    ctx.fillStyle = bg;
    ctx.fillRect(0, 0, w, h);
    
    foods.forEach(f => {
        ctx.font = `${f.size * 1.6}px ${CONFIG.EMOJI_FONT}`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(f.type, f.x, f.y);
    });
    
    enemies.forEach(e => drawCreature(e, e.size > player.size, env));
    drawPlayer();
};

const drawCreature = (e, danger, env) => {
    const t = Date.now() * 0.003;
    ctx.save();
    ctx.translate(e.x, e.y);
    ctx.shadowColor = danger ? '#ff4444' : '#44ff88';
    ctx.shadowBlur = 10;
    ctx.beginPath();
    for (let i = 0; i < 8; i++) {
        const ang = (i / 8) * Math.PI * 2;
        const w = Math.sin(t + i + e.wobble * 10) * 2;
        const r = e.size + w;
        i === 0 ? ctx.moveTo(Math.cos(ang) * r, Math.sin(ang) * r) : ctx.lineTo(Math.cos(ang) * r, Math.sin(ang) * r);
    }
    ctx.closePath();
    ctx.fillStyle = danger ? env.colors.enemy : env.colors.food;
    ctx.fill();
    ctx.shadowBlur = 0;
    ctx.beginPath(); ctx.arc(0, -e.size * 0.2, e.size * 0.15, 0, Math.PI * 2); ctx.fillStyle = 'white'; ctx.fill();
    ctx.beginPath(); ctx.arc(e.size * 0.03, -e.size * 0.2, e.size * 0.07, 0, Math.PI * 2); ctx.fillStyle = '#222'; ctx.fill();
    ctx.restore();
};

const drawPlayer = () => {
    const d = G.data.design, p = G.data.parts, t = Date.now() * 0.003, s = player.size;
    ctx.save();
    ctx.translate(player.x, player.y);
    ctx.shadowColor = d.primary;
    ctx.shadowBlur = 18;
    
    // Íº¨Î¶¨
    if (p.tail > 0) {
        ctx.strokeStyle = d.primary; ctx.lineWidth = Math.max(3, s * 0.07); ctx.lineCap = 'round';
        for (let i = 0; i < p.tail; i++) {
            const tw = Math.sin(t * 2 + i) * s * 0.25;
            const oy = (i - (p.tail - 1) / 2) * s * 0.1;
            ctx.beginPath();
            ctx.moveTo(-s * 0.7, oy);
            ctx.bezierCurveTo(-s * 1.1, tw + oy, -s * 1.4, -tw * 0.4 + oy, -s * 1.7, tw * 0.3 + oy);
            ctx.stroke();
        }
    }
    
    // Ìåî
    if (p.arm > 0) {
        ctx.strokeStyle = d.primary; ctx.lineWidth = Math.max(2, s * 0.06); ctx.lineCap = 'round';
        for (let i = 0; i < p.arm; i++) {
            const ba = (0.2 + i * 0.18) * (i % 2 === 0 ? 1 : -1) * Math.PI;
            const w = Math.sin(t * 2 + i) * 0.15;
            ctx.beginPath();
            ctx.moveTo(Math.cos(ba) * s * 0.85, Math.sin(ba) * s * 0.85);
            ctx.quadraticCurveTo(Math.cos(ba) * s * 1.3, Math.sin(ba + w) * s * 1.1, Math.cos(ba) * s * 1.5, Math.sin(ba + w * 2) * s * 0.85);
            ctx.stroke();
        }
    }
    
    // Îã§Î¶¨
    if (p.leg > 0) {
        ctx.strokeStyle = d.secondary; ctx.lineWidth = Math.max(2, s * 0.05);
        for (let i = 0; i < p.leg; i++) {
            const ba = Math.PI * 0.5 + (i - (p.leg - 1) / 2) * 0.2;
            const w = Math.sin(t * 3 + i) * 0.12;
            ctx.beginPath();
            ctx.moveTo(Math.cos(ba) * s * 0.7, Math.sin(ba) * s * 0.7);
            ctx.lineTo(Math.cos(ba + w) * s * 1.3, Math.sin(ba) * s * 1.2);
            ctx.stroke();
        }
    }
    
    // ÎçîÎì¨Ïù¥
    if (p.antenna > 0) {
        ctx.strokeStyle = d.primary; ctx.lineWidth = 2;
        for (let i = 0; i < p.antenna; i++) {
            const aa = -Math.PI * 0.35 + i * 0.3;
            ctx.beginPath();
            ctx.moveTo(Math.cos(aa) * s * 0.6, Math.sin(aa) * s * 0.6);
            ctx.quadraticCurveTo(Math.cos(aa) * s * 1.1, Math.sin(aa) * s * 1.0, Math.cos(aa) * s * 1.4, Math.sin(aa + Math.sin(t*3)*0.1) * s * 1.1);
            ctx.stroke();
            ctx.beginPath();
            ctx.arc(Math.cos(aa) * s * 1.4, Math.sin(aa + Math.sin(t*3)*0.1) * s * 1.1, 4, 0, Math.PI * 2);
            ctx.fillStyle = d.primary;
            ctx.fill();
        }
    }
    
    // Î™∏ÌÜµ
    ctx.beginPath();
    for (let i = 0; i < 10; i++) {
        const ang = (i / 10) * Math.PI * 2;
        const w = Math.sin(t + i) * 2.5 * d.wobble;
        const r = s + w;
        i === 0 ? ctx.moveTo(Math.cos(ang) * r, Math.sin(ang) * r) : ctx.lineTo(Math.cos(ang) * r, Math.sin(ang) * r);
    }
    ctx.closePath();
    const grad = ctx.createRadialGradient(-s * 0.25, -s * 0.25, 0, 0, 0, s);
    grad.addColorStop(0, d.primary);
    grad.addColorStop(1, d.secondary);
    ctx.fillStyle = grad;
    ctx.fill();
    ctx.shadowBlur = 0;
    
    // Í∑Ä
    if (p.ear > 0) {
        for (let i = 0; i < p.ear; i++) {
            const side = i % 2 === 0 ? 1 : -1;
            ctx.beginPath();
            ctx.ellipse(side * s * 0.7, -s * 0.4, s * 0.12, s * 0.2, side * 0.3, 0, Math.PI * 2);
            ctx.fillStyle = d.primary;
            ctx.fill();
        }
    }
    
    // Îàà
    const eyeCnt = p.eye || 1;
    for (let i = 0; i < eyeCnt; i++) {
        const eX = (i - (eyeCnt - 1) / 2) * 0.3 * s * 0.7;
        const eY = -s * 0.2;
        ctx.beginPath(); ctx.arc(eX, eY, s * 0.2, 0, Math.PI * 2); ctx.fillStyle = 'white'; ctx.fill();
        ctx.beginPath(); ctx.arc(eX + s * 0.03, eY, s * 0.1, 0, Math.PI * 2); ctx.fillStyle = '#222'; ctx.fill();
        ctx.beginPath(); ctx.arc(eX - s * 0.04, eY - s * 0.05, s * 0.04, 0, Math.PI * 2); ctx.fillStyle = 'rgba(255,255,255,0.8)'; ctx.fill();
    }
    
    // ÏΩî
    if (p.nose > 0) {
        ctx.fillStyle = '#ffcc99';
        ctx.beginPath();
        ctx.moveTo(0, 0);
        ctx.lineTo(-s * 0.08, s * 0.12);
        ctx.lineTo(s * 0.08, s * 0.12);
        ctx.closePath();
        ctx.fill();
    }
    
    // ÏûÖ
    if (p.mouth > 0) {
        ctx.strokeStyle = d.secondary;
        ctx.lineWidth = 2.5;
        ctx.lineCap = 'round';
        ctx.beginPath();
        ctx.arc(0, s * 0.25, s * 0.12, 0.2, Math.PI - 0.2);
        ctx.stroke();
    }
    
    ctx.restore();
};

const gameOverCell = () => {
    cancelAnimationFrame(gameLoop);
    gameLoop = null;
    Audio.playDeath();
    G.data.stats.deaths++;
    saveGame();
    
    app.innerHTML = `
        <div class="modal"><div class="modal-box">
            <div class="modal-icon">üíÄ</div>
            <h1 class="modal-title fail">Ïû°ÏïÑÎ®πÌòîÎã§!</h1>
            <p class="modal-desc">Îçî ÌÅ∞ Ï°¥Ïû¨ÏóêÍ≤å Ìè¨ÏãùÎãπÌñàÏäµÎãàÎã§.</p>
            <div style="display:flex;flex-direction:column;gap:10px;">
                <button class="btn btn-energy btn-block" id="btn-retry">üé≤ Îã§Ïãú ÏãúÏûë</button>
                <button class="btn btn-outline btn-block" id="btn-home">üè† ÌôàÏúºÎ°ú</button>
            </div>
        </div></div>
    `;
    
    document.getElementById('btn-retry').onclick = () => { Audio.playClick(); G.data.stage = 0; G.data.tutDone = false; G.data.score = 0; saveGame(); renderDice(); };
    document.getElementById('btn-home').onclick = () => { Audio.playClick(); renderSaves(); };
};

const evolveMulti = () => {
    cancelAnimationFrame(gameLoop);
    gameLoop = null;
    G.data.stage = 2;
    saveGame();
    Audio.playEvolve();
    renderStory('multi');
};
// ========================================
// BOKLUCK Universe - Climb Game (Stage 2)
// ÏãúÏûë Ï†Ñ Ï£ºÏÇ¨ÏúÑ: 80+ ÌÜ†ÎÑ§Ïù¥ÎèÑ, 60-79 Íµ¨Î¶Ñ, 59- ÏóÜÏùå
// Ïú°ÏßÄÎ•º Î∞üÍ±∞ÎÇò ÏßÄÎÇòÍ∞ÄÎ©¥ ÌÅ¥Î¶¨Ïñ¥
// ========================================

let climber, platforms = [], climbItems = [];
let camY = 0, curH = 0, canDblJump = false, wasOnGround = true;
let deathLineY = 0, landY = 0, shownOvershootWarning = false;
let landPlatform = null;

const showClimbDice = () => {
    app.innerHTML = `
        <div class="page-center">
            <div class="page-content">
                <h2 class="page-title">üé≤ ÏïÑÏù¥ÌÖú Ï£ºÏÇ¨ÏúÑ</h2>
                <p style="color:var(--text-secondary);margin-bottom:16px;">
                    80+ üå™Ô∏è ÌÜ†ÎÑ§Ïù¥ÎèÑ<br>
                    60-79 ‚òÅÔ∏è Íµ¨Î¶Ñ<br>
                    59- ÏóÜÏùå
                </p>
                <div class="dice-box" id="dice">üé≤</div>
                <div id="result"></div>
                <button class="btn btn-energy btn-block" id="btn-roll">Ï£ºÏÇ¨ÏúÑ ÎçòÏßÄÍ∏∞</button>
            </div>
        </div>
    `;
    
    const dice = document.getElementById('dice');
    const result = document.getElementById('result');
    const btn = document.getElementById('btn-roll');
    
    btn.onclick = () => {
        btn.disabled = true;
        btn.textContent = 'Í≤∞Ï†ï Ï§ë...';
        dice.classList.add('rolling');
        Audio.playDice();
        
        const anim = setInterval(() => {
            dice.textContent = Math.floor(Math.random() * 100) + 1;
        }, 50);
        
        setTimeout(() => {
            clearInterval(anim);
            dice.classList.remove('rolling');
            
            const roll = Math.floor(Math.random() * 100) + 1;
            dice.textContent = roll;
            
            let item = null, icon = '', msg = '';
            
            if (roll >= 80) {
                item = 'tornado';
                icon = 'üå™Ô∏è';
                msg = 'ÌÜ†ÎÑ§Ïù¥ÎèÑÏùò ÌûòÏùÑ ÏñªÏóàÎã§!';
                dice.style.cssText = 'font-size:3rem;font-family:Orbitron;font-weight:900;color:var(--success);text-shadow:0 0 25px var(--success);';
                Audio.playEvolve();
            } else if (roll >= 60) {
                item = 'cloud';
                icon = '‚òÅÔ∏è';
                msg = 'Íµ¨Î¶ÑÏùò ÌûòÏùÑ ÏñªÏóàÎã§! (ÌÜ†ÎÑ§Ïù¥ÎèÑÏùò Ï†àÎ∞ò)';
                dice.style.cssText = 'font-size:3rem;font-family:Orbitron;font-weight:900;color:var(--neon-cyan);text-shadow:0 0 20px var(--neon-cyan);';
                Audio.playCloud();
            } else {
                item = null;
                icon = 'üò¢';
                msg = 'ÏïÑÎ¨¥Í≤ÉÎèÑ ÏñªÏßÄ Î™ªÌñàÎã§...';
                dice.style.cssText = 'font-size:3rem;font-family:Orbitron;font-weight:900;color:var(--danger);text-shadow:0 0 15px var(--danger);';
                Audio.playFail();
            }
            
            G.data.climbItem = item;
            saveGame();
            
            result.innerHTML = `
                <div style="text-align:center;margin:16px 0;">
                    <div style="font-size:3rem;margin-bottom:6px;">${icon}</div>
                    <div style="color:var(--text-secondary);font-size:0.9rem;">${msg}</div>
                </div>
            `;
            
            btn.disabled = false;
            btn.textContent = 'üèîÔ∏è Îì±Î∞ò ÏãúÏûë!';
            btn.onclick = () => { Audio.playClick(); startClimb(); };
        }, 1500);
    };
};

const startClimb = () => {
    cleanup();
    const env = envById(G.data.dna.origin);
    const joyRight = Settings.get('joyRight');
    const itemType = G.data.climbItem;
    
    app.innerHTML = `
        <canvas id="game-canvas"></canvas>
        <div class="climb-hud">
            <div class="climb-info">
                <div class="climb-height" id="c-height">0m</div>
                <div class="climb-label">ÌòÑÏû¨ ÎÜíÏù¥</div>
            </div>
            <div class="hud-btns">
                <button class="hud-btn" id="btn-clear" title="ÌÖåÏä§Ìä∏ ÌÅ¥Î¶¨Ïñ¥" style="background:var(--success);color:white;">‚úì</button>
                <button class="hud-btn" id="btn-restart">üîÑ</button>
                <button class="hud-btn" id="btn-home">üè†</button>
                <button class="hud-btn" id="btn-pause">‚è∏Ô∏è</button>
            </div>
            <div class="climb-goal">
                <div class="climb-goal-text">üèîÔ∏è Ïú°ÏßÄ</div>
                <div class="climb-goal-val">${CONFIG.LAND_HEIGHT}m</div>
                ${itemType ? `<div style="font-size:0.6rem;color:var(--neon-yellow);margin-top:2px;">${itemType === 'tornado' ? 'üå™Ô∏è' : '‚òÅÔ∏è'} ÏïÑÏù¥ÌÖú ÏûàÏùå</div>` : ''}
            </div>
        </div>
        <div class="controls ${joyRight ? 'joy-right' : ''}">
            <div class="joystick" id="joy"><div class="joy-base"></div><div class="joy-knob" id="joy-knob"></div></div>
            <button class="action-btn" id="btn-jump">‚¨ÜÔ∏è</button>
        </div>
    `;
    
    canvas = document.getElementById('game-canvas');
    ctx = canvas.getContext('2d');
    resize();
    
    window.addEventListener('resize', resize);
    addCleanup(() => window.removeEventListener('resize', resize));
    
    const pSize = 28 + totalParts() * 2;
    climber = { x: canvas.width / 2, y: canvas.height - 80, w: pSize, h: pSize, vx: 0, vy: 0, onGround: true };
    wasOnGround = true;
    shownOvershootWarning = false;
    
    platforms = [];
    climbItems = [];
    deathLineY = canvas.height + 100;
    landY = -CONFIG.LAND_HEIGHT * 10 - 40;
    
    genPlats(canvas.height - 50, landY - 200, itemType);
    
    platforms.push({ x: canvas.width / 2 - 70, y: canvas.height - 40, w: 140, h: 18, type: 'normal' });
    
    landPlatform = { x: 0, y: landY, w: canvas.width, h: 150, type: 'land' };
    platforms.push(landPlatform);
    
    camY = 0;
    curH = 0;
    
    setupClimbControls();
    setupClimbHUD();
    
    gameLoop = requestAnimationFrame(updateClimb);
};

const genPlats = (fromY, toY, itemType) => {
    let y = fromY - 50;
    
    while (y > toY) {
        const num = 1 + Math.floor(Math.random() * 2);
        
        for (let i = 0; i < num; i++) {
            const w = 70 + Math.random() * 50;
            const x = Math.random() * (canvas.width - w);
            let type = 'normal';
            
            const hr = Math.abs(y) / (CONFIG.LAND_HEIGHT * 10);
            if (hr > 0.3 && Math.random() < 0.1) type = 'moving';
            if (hr > 0.5 && Math.random() < 0.06) type = 'breaking';
            if (hr > 0.6 && Math.random() < 0.1) type = 'bouncy';
            
            platforms.push({
                x, y, w, h: 14, type,
                dir: Math.random() < 0.5 ? 1 : -1,
                spd: 1 + Math.random() * 1.2,
                broken: false, timer: 0
            });
            
            if (itemType && Math.random() < 0.12) {
                climbItems.push({ x: x + w / 2, y: y - 45, type: itemType, collected: false });
            }
        }
        y -= 45 + Math.random() * 25;
    }
};

const setupClimbControls = () => {
    const joy = document.getElementById('joy');
    const knob = document.getElementById('joy-knob');
    
    const move = (cx, cy) => {
        const r = joy.getBoundingClientRect();
        const cX = r.left + r.width / 2;
        const cY = r.top + r.height / 2;
        const maxD = r.width / 2 - 20;
        let dx = cx - cX, dy = cy - cY;
        const dist = Math.sqrt(dx * dx + dy * dy);
        if (dist > maxD) { dx = dx / dist * maxD; dy = dy / dist * maxD; }
        knob.style.transform = `translate(${dx}px, ${dy}px)`;
        joyPos = { x: dx / maxD, y: dy / maxD };
    };
    
    const end = () => { joyActive = false; knob.style.transform = ''; joyPos = { x: 0, y: 0 }; };
    
    const jump = () => {
        if (climber.onGround) {
            climber.vy = -16;
            climber.onGround = false;
            wasOnGround = false;
            canDblJump = hasPart('leg') && partCnt('leg') >= 2;
            Audio.playJump();
        } else if (canDblJump) {
            climber.vy = -13;
            canDblJump = false;
            Audio.playJump();
        }
    };
    
    joy.addEventListener('touchstart', e => { e.preventDefault(); joyActive = true; move(e.touches[0].clientX, e.touches[0].clientY); }, { passive: false });
    joy.addEventListener('touchmove', e => { e.preventDefault(); if (joyActive) move(e.touches[0].clientX, e.touches[0].clientY); }, { passive: false });
    joy.addEventListener('touchend', end);
    joy.addEventListener('mousedown', e => { joyActive = true; move(e.clientX, e.clientY); });
    window.addEventListener('mousemove', e => { if (joyActive) move(e.clientX, e.clientY); });
    window.addEventListener('mouseup', end);
    
    window.addEventListener('keydown', e => {
        keys[e.key.toLowerCase()] = true;
        if (e.key === ' ' || e.key === 'ArrowUp' || e.key.toLowerCase() === 'w') jump();
    });
    window.addEventListener('keyup', e => { keys[e.key.toLowerCase()] = false; });
    
    document.getElementById('btn-jump').onclick = jump;
    document.getElementById('btn-jump').ontouchstart = e => { e.preventDefault(); jump(); };
};

const setupClimbHUD = () => {
    document.getElementById('btn-clear').onclick = () => {
        Audio.playClick();
        climbWin(); // ÌÖåÏä§Ìä∏Ïö© Ï¶âÏãú ÌÅ¥Î¶¨Ïñ¥
    };
    document.getElementById('btn-restart').onclick = () => {
        Audio.playClick();
        if (confirm('Ï≤òÏùåÎ∂ÄÌÑ∞?')) { cancelAnimationFrame(gameLoop); gameLoop = null; showClimbDice(); }
    };
    document.getElementById('btn-home').onclick = () => {
        Audio.playClick();
        if (confirm('ÌôàÏúºÎ°ú?')) { cancelAnimationFrame(gameLoop); gameLoop = null; saveGame(); renderSaves(); }
    };
    document.getElementById('btn-pause').onclick = () => {
        Audio.playClick();
        const btn = document.getElementById('btn-pause');
        if (gameLoop) { cancelAnimationFrame(gameLoop); gameLoop = null; btn.textContent = '‚ñ∂Ô∏è'; }
        else { gameLoop = requestAnimationFrame(updateClimb); btn.textContent = '‚è∏Ô∏è'; }
    };
};

const updateClimb = () => {
    if (!canvas || !ctx) return;
    const env = envById(G.data.dna.origin);
    
    let mx = joyPos.x;
    if (keys.a || keys.arrowleft) mx = -1;
    if (keys.d || keys.arrowright) mx = 1;
    
    const spd = 5 + partCnt('leg') * 0.4;
    climber.vx = mx * spd;
    climber.vy += 0.55;
    if (climber.vy > 14) climber.vy = 14;
    
    climber.x += climber.vx;
    climber.y += climber.vy;
    
    if (climber.x < 0) climber.x = 0;
    if (climber.x + climber.w > canvas.width) climber.x = canvas.width - climber.w;
    
    // ‚òÖ Ïú°ÏßÄ ÎèÑÎã¨ Ï≤¥ÌÅ¨ - Ï∫êÎ¶≠ÌÑ∞Í∞Ä Ïú°ÏßÄ ÎÜíÏù¥Î≥¥Îã§ ÏúÑÏóê ÏûàÏúºÎ©¥ ÌÅ¥Î¶¨Ïñ¥!
    if (landPlatform && climber.y + climber.h < landPlatform.y + 50) {
        climbWin();
        return;
    }
    
    const wasOnGroundBefore = climber.onGround;
    climber.onGround = false;
    
    for (const p of platforms) {
        if (p.broken) continue;
        
        if (p.type === 'moving') {
            p.x += p.dir * p.spd;
            if (p.x <= 0 || p.x + p.w >= canvas.width) p.dir *= -1;
        }
        
        if (climber.vy >= 0 &&
            climber.x + climber.w > p.x + 4 &&
            climber.x < p.x + p.w - 4 &&
            climber.y + climber.h >= p.y &&
            climber.y + climber.h <= p.y + p.h + 16) {
            
            climber.y = p.y - climber.h;
            climber.vy = 0;
            climber.onGround = true;
            canDblJump = hasPart('leg') && partCnt('leg') >= 2;
            
            if (p.type === 'bouncy') {
                climber.vy = -20;
                climber.onGround = false;
                Audio.playJump();
            } else if (p.type === 'breaking') {
                p.timer++;
                if (p.timer > 25) p.broken = true;
            } else if (p.type === 'land') {
                climbWin();
                return;
            } else if (!wasOnGroundBefore && !wasOnGround) {
                Audio.playLand();
            }
            
            if (p.type === 'moving') climber.x += p.dir * p.spd;
        }
    }
    
    wasOnGround = climber.onGround;
    
    for (const item of climbItems) {
        if (item.collected) continue;
        const dx = (climber.x + climber.w / 2) - item.x;
        const dy = (climber.y + climber.h / 2) - item.y;
        if (Math.sqrt(dx * dx + dy * dy) < 35) {
            item.collected = true;
            if (item.type === 'tornado') {
                Audio.playWind();
                climber.vy = -48;
                toast('üå™Ô∏è ÌÜ†ÎÑ§Ïù¥ÎèÑÏùò Ìûò!', 'success');
            } else if (item.type === 'cloud') {
                Audio.playCloud();
                climber.vy = -24;
                toast('‚òÅÔ∏è Íµ¨Î¶ÑÏùò Ìûò!', 'success');
            }
        }
    }
    
    const targetCam = -climber.y + canvas.height * 0.6;
    camY += (targetCam - camY) * 0.1;
    
    curH = Math.max(0, Math.floor(-climber.y / 10));
    G.data.stats.maxH = Math.max(G.data.stats.maxH, curH);
    
    if (climber.y < landY - 200 && !shownOvershootWarning) {
        shownOvershootWarning = true;
        toast('‚ö†Ô∏è ÎÑàÎ¨¥ Ïò¨ÎùºÏôîÎã§! Ïú°ÏßÄÎ°ú ÎÇ¥Î†§Í∞ÄÏûê!', 'warning');
    }
    if (climber.y > landY - 100) shownOvershootWarning = false;
    
    const highest = Math.min(...platforms.filter(p => p.type !== 'land').map(p => p.y));
    if (-camY - canvas.height < highest + 400) {
        genPlats(highest, highest - canvas.height * 2, G.data.climbItem);
    }
    
    if (climber.y > deathLineY || climber.y > -camY + canvas.height + 80) {
        climbFail();
        return;
    }
    
    renderClimb(env);
    document.getElementById('c-height').textContent = curH + 'm';
    
    gameLoop = requestAnimationFrame(updateClimb);
};

const renderClimb = env => {
    const w = canvas.width, h = canvas.height;
    const hr = Math.min(1, curH / CONFIG.LAND_HEIGHT);
    const t = Date.now() * 0.005;
    
    const bg = ctx.createLinearGradient(0, 0, 0, h);
    if (hr < 0.5) {
        bg.addColorStop(0, lerpCol(env.colors.bg1, '#1a3a5e', hr * 2));
        bg.addColorStop(1, lerpCol(env.colors.bg2, '#0a2040', hr * 2));
    } else {
        bg.addColorStop(0, lerpCol('#1a3a5e', '#87CEEB', (hr - 0.5) * 2));
        bg.addColorStop(1, lerpCol('#0a2040', '#E0F7FA', (hr - 0.5) * 2));
    }
    ctx.fillStyle = bg;
    ctx.fillRect(0, 0, w, h);
    
    ctx.save();
    ctx.translate(0, camY);
    
    for (const p of platforms) {
        if (p.broken) continue;
        const sy = p.y + camY;
        if (sy < -40 || sy > h + 40) continue;
        
        ctx.fillStyle = platCol(p.type, hr, env);
        
        if (p.type === 'land') {
            ctx.fillStyle = '#8B4513';
            ctx.fillRect(p.x, p.y, p.w, p.h);
            ctx.fillStyle = '#228B22';
            ctx.fillRect(p.x, p.y, p.w, 20);
            for (let i = 0; i < 6; i++) {
                const tx = 30 + i * (p.w / 6);
                ctx.fillStyle = '#654321';
                ctx.fillRect(tx, p.y - 40, 10, 40);
                ctx.fillStyle = '#228B22';
                ctx.beginPath();
                ctx.arc(tx + 5, p.y - 50, 25, 0, Math.PI * 2);
                ctx.fill();
            }
        } else {
            ctx.beginPath();
            ctx.roundRect(p.x, p.y, p.w, p.h, 5);
            ctx.fill();
        }
    }
    
    for (const item of climbItems) {
        if (item.collected) continue;
        const sy = item.y + camY;
        if (sy < -40 || sy > h + 40) continue;
        
        ctx.save();
        ctx.translate(item.x, item.y + Math.sin(t) * 5);
        ctx.rotate(-Math.PI / 2);
        ctx.font = `28px ${CONFIG.EMOJI_FONT}`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(item.type === 'tornado' ? 'üå™Ô∏è' : '‚òÅÔ∏è', 0, 0);
        ctx.restore();
    }
    
    drawClimber();
    ctx.restore();
    
    const gH = h - 90, gX = w - 25;
    const prog = Math.min(1, curH / CONFIG.LAND_HEIGHT);
    ctx.fillStyle = 'rgba(0,0,0,0.25)';
    ctx.fillRect(gX - 4, 45, 16, gH);
    const gFill = ctx.createLinearGradient(0, 45 + gH, 0, 45);
    gFill.addColorStop(0, '#00f5d4');
    gFill.addColorStop(1, '#fee440');
    ctx.fillStyle = gFill;
    ctx.fillRect(gX - 2, 45 + gH * (1 - prog), 12, gH * prog);
    ctx.fillStyle = '#228B22';
    ctx.fillRect(gX - 6, 40, 20, 8);
};

const platCol = (type, hr, env) => {
    if (type === 'moving') return '#9d4edd';
    if (type === 'breaking') return '#ef4444';
    if (type === 'bouncy') return '#10b981';
    return hr < 0.5 ? lerpCol(env.colors.food, '#48cae4', hr * 2) : lerpCol('#48cae4', '#caf0f8', (hr - 0.5) * 2);
};

const drawClimber = () => {
    const d = G.data.design, t = Date.now() * 0.005, s = climber.w / 2;
    const p = G.data.parts;
    
    ctx.save();
    ctx.translate(climber.x + climber.w / 2, climber.y + climber.h / 2);
    ctx.shadowColor = d.primary;
    ctx.shadowBlur = 12;
    
    ctx.beginPath();
    for (let i = 0; i < 8; i++) {
        const ang = (i / 8) * Math.PI * 2;
        const w = Math.sin(t + i) * 1.8;
        const r = s + w;
        i === 0 ? ctx.moveTo(Math.cos(ang) * r, Math.sin(ang) * r) : ctx.lineTo(Math.cos(ang) * r, Math.sin(ang) * r);
    }
    ctx.closePath();
    
    const grad = ctx.createRadialGradient(-s * 0.2, -s * 0.2, 0, 0, 0, s);
    grad.addColorStop(0, d.primary);
    grad.addColorStop(1, d.secondary);
    ctx.fillStyle = grad;
    ctx.fill();
    ctx.shadowBlur = 0;
    
    const eyeCnt = Math.max(1, p.eye || 1);
    for (let i = 0; i < eyeCnt; i++) {
        const eA = (i - (eyeCnt - 1) / 2) * 0.35;
        const eX = eA * s * 0.7;
        const eY = -s * 0.25;
        ctx.beginPath(); ctx.arc(eX, eY, s * 0.22, 0, Math.PI * 2); ctx.fillStyle = 'white'; ctx.fill();
        ctx.beginPath(); ctx.arc(eX + s * 0.03, eY, s * 0.1, 0, Math.PI * 2); ctx.fillStyle = '#222'; ctx.fill();
    }
    
    ctx.restore();
};

const climbFail = () => {
    cancelAnimationFrame(gameLoop);
    gameLoop = null;
    Audio.playDeath();
    saveGame();
    
    app.innerHTML = `
        <div class="modal"><div class="modal-box">
            <div class="modal-icon">üíß</div>
            <h1 class="modal-title fail">Ï∂îÎùΩ!</h1>
            <p class="modal-desc">Î∞îÎã§Î°ú Îñ®Ïñ¥Ï°åÏäµÎãàÎã§...</p>
            <div class="modal-stats">
                <div class="stat-row"><span class="stat-label">ÎèÑÎã¨ ÎÜíÏù¥</span><span class="stat-val">${curH}m</span></div>
                <div class="stat-row"><span class="stat-label">ÏµúÍ≥† Í∏∞Î°ù</span><span class="stat-val">${G.data.stats.maxH}m</span></div>
            </div>
            <div style="display:flex;flex-direction:column;gap:10px;">
                <button class="btn btn-energy btn-block" id="btn-retry">üîÑ Îã§Ïãú</button>
                <button class="btn btn-outline btn-block" id="btn-home">üè† Ìôà</button>
            </div>
        </div></div>
    `;
    
    document.getElementById('btn-retry').onclick = () => { Audio.playClick(); showClimbDice(); };
    document.getElementById('btn-home').onclick = () => { Audio.playClick(); renderSaves(); };
};

const climbWin = () => {
    cancelAnimationFrame(gameLoop);
    gameLoop = null;
    Audio.playWin();
    G.data.stage = 3;
    G.data.runnerStage = 0;
    G.data.evoTraits = [];
    G.data.runnerDist = 0;
    G.data.charScale = 1;
    saveGame();
    renderStory('runner');
};
// ========================================
// BOKLUCK Universe - Runner Game (Stage 3)
// Îã§ÏñëÌïú ÏïÑÏù¥ÌÖú + Ï£ºÏÇ¨ÏúÑ ÏßÑÌôî + ÌÅ¨Í∏∞ Ï°∞Ï†à
// ========================================

let runner, runnerDist, runnerStage, obstacles, items, runnerParticles;
let runnerSpeed, bgOffset;
let lastObstacleTime = 0;
let activeEffects = {}; // ÌòÑÏû¨ ÌôúÏÑ±ÌôîÎêú Ìö®Í≥ºÎì§
const MIN_OBSTACLE_GAP = 1500;

// ÏïÑÏù¥ÌÖú Ï¢ÖÎ•ò Ï†ïÏùò (Ï£ºÏÇ¨ÏúÑÏùò Ï†àÎ∞ò Ï†ïÎèÑ ÎπÑÏ§ë)
const RUNNER_ITEMS = {
    dice: { icon: 'üé≤', name: 'ÏßÑÌôî Ï£ºÏÇ¨ÏúÑ', rate: 0.003, duration: 0 },
    jump: { icon: 'ü¶ò', name: 'Ï†êÌîÑÎ†• Ìñ•ÏÉÅ', rate: 0.0015, duration: 5000 },
    speed: { icon: '‚ö°', name: 'ÏÜçÎèÑ Ï¶ùÍ∞Ä', rate: 0.0015, duration: 4000 },
    slow: { icon: 'üê¢', name: 'ÏÜçÎèÑ Í∞êÏÜå', rate: 0.001, duration: 4000 },
    shield: { icon: 'üõ°Ô∏è', name: 'Î¨¥Ï†Å', rate: 0.001, duration: 3000 },
    magnet: { icon: 'üß≤', name: 'ÏûêÏÑù', rate: 0.001, duration: 5000 },
    shrink: { icon: 'üîª', name: 'Î™∏ Ï∂ïÏÜå', rate: 0.001, duration: 4000 },
    coin: { icon: 'üíé', name: 'Î≥¥ÎÑàÏä§ Ï†êÏàò', rate: 0.002, duration: 0 }
};

const startRunner = () => {
    cleanup();
    const joyRight = Settings.get('joyRight');
    
    if (!G.data.evoTraits) G.data.evoTraits = [];
    if (!G.data.charScale) G.data.charScale = 1;
    if (!G.data.runnerDist) G.data.runnerDist = 0;
    
    runnerStage = G.data.runnerStage || 0;
    runnerDist = G.data.runnerDist || 0; // Ï†ÄÏû•Îêú Í±∞Î¶¨Î∂ÄÌÑ∞ ÏãúÏûë
    bgOffset = 0;
    lastObstacleTime = 0;
    activeEffects = {};
    
    const stage = RUNNER_STAGES[runnerStage];
    runnerSpeed = stage.baseSpeed;
    
    const charScale = G.data.charScale || 1;
    const evoBonus = (G.data.evoTraits?.length || 0) * 0.02;
    const totalScale = charScale + evoBonus;
    
    runner = { 
        x: 100, y: 0, 
        w: 45 * totalScale, h: 55 * totalScale, 
        baseW: 45, baseH: 55,
        vy: 0, onGround: true, ducking: false 
    };
    obstacles = [];
    items = [];
    runnerParticles = [];
    
    app.innerHTML = `
        <canvas id="game-canvas"></canvas>
        <div class="runner-hud">
            <div class="runner-stage">
                <div class="runner-stage-name">${stage.name}</div>
                <div class="runner-dist" id="r-dist">${Math.floor(runnerDist)}m / ${stage.dist}m</div>
                <div style="font-size:0.6rem;color:var(--neon-yellow);margin-top:2px;">üß¨ ÏßÑÌôî: ${G.data.evoTraits?.length || 0}Í∞ú</div>
            </div>
            <div class="hud-btns">
                <button class="hud-btn" id="btn-stats" title="Ïä§ÌÖü Î≥¥Í∏∞">üìä</button>
                <button class="hud-btn" id="btn-clear" title="ÌÖåÏä§Ìä∏ ÌÅ¥Î¶¨Ïñ¥" style="background:var(--success);color:white;">‚úì</button>
                <button class="hud-btn" id="btn-edit" title="ÌååÏ∏† Î∞∞Ïπò">‚úã</button>
                <button class="hud-btn" id="btn-home">üè†</button>
                <button class="hud-btn" id="btn-pause">‚è∏Ô∏è</button>
            </div>
        </div>
        <div id="effect-icons" style="position:fixed;top:80px;left:16px;display:flex;gap:6px;flex-wrap:wrap;max-width:150px;z-index:50;"></div>
        <div class="controls ${joyRight ? 'joy-right' : ''}">
            <button class="action-btn" id="btn-duck" style="font-size:1rem;">‚¨áÔ∏è</button>
            <button class="action-btn" id="btn-jump">‚¨ÜÔ∏è</button>
        </div>
    `;
    
    canvas = document.getElementById('game-canvas');
    ctx = canvas.getContext('2d');
    resize();
    
    window.addEventListener('resize', resize);
    addCleanup(() => window.removeEventListener('resize', resize));
    
    setupRunnerControls();
    setupRunnerHUD();
    
    gameLoop = requestAnimationFrame(updateRunner);
};

// Îü¨ÎÑà Ïû¨Í∞ú (Ï£ºÏÇ¨ÏúÑ Î®πÏùÄ ÌõÑ)
const resumeRunner = () => {
    const joyRight = Settings.get('joyRight');
    
    runnerStage = G.data.runnerStage || 0;
    // runnerDistÎäî Ïú†ÏßÄ!
    
    const stage = RUNNER_STAGES[runnerStage];
    runnerSpeed = stage.baseSpeed + runnerDist * 0.002;
    runnerSpeed = Math.min(runnerSpeed, stage.baseSpeed + 3);
    
    const charScale = G.data.charScale || 1;
    const evoBonus = (G.data.evoTraits?.length || 0) * 0.02;
    const totalScale = charScale + evoBonus;
    
    runner = { 
        x: 100, y: 0, 
        w: 45 * totalScale, h: 55 * totalScale, 
        baseW: 45, baseH: 55,
        vy: 0, onGround: true, ducking: false 
    };
    obstacles = [];
    items = [];
    
    app.innerHTML = `
        <canvas id="game-canvas"></canvas>
        <div class="runner-hud">
            <div class="runner-stage">
                <div class="runner-stage-name">${stage.name}</div>
                <div class="runner-dist" id="r-dist">${Math.floor(runnerDist)}m / ${stage.dist}m</div>
                <div style="font-size:0.6rem;color:var(--neon-yellow);margin-top:2px;">üß¨ ÏßÑÌôî: ${G.data.evoTraits?.length || 0}Í∞ú</div>
            </div>
            <div class="hud-btns">
                <button class="hud-btn" id="btn-stats" title="Ïä§ÌÖü Î≥¥Í∏∞">üìä</button>
                <button class="hud-btn" id="btn-clear" title="ÌÖåÏä§Ìä∏ ÌÅ¥Î¶¨Ïñ¥" style="background:var(--success);color:white;">‚úì</button>
                <button class="hud-btn" id="btn-edit" title="ÌååÏ∏† Î∞∞Ïπò">‚úã</button>
                <button class="hud-btn" id="btn-home">üè†</button>
                <button class="hud-btn" id="btn-pause">‚è∏Ô∏è</button>
            </div>
        </div>
        <div id="effect-icons" style="position:fixed;top:80px;left:16px;display:flex;gap:6px;flex-wrap:wrap;max-width:150px;z-index:50;"></div>
        <div class="controls ${joyRight ? 'joy-right' : ''}">
            <button class="action-btn" id="btn-duck" style="font-size:1rem;">‚¨áÔ∏è</button>
            <button class="action-btn" id="btn-jump">‚¨ÜÔ∏è</button>
        </div>
    `;
    
    canvas = document.getElementById('game-canvas');
    ctx = canvas.getContext('2d');
    resize();
    
    window.addEventListener('resize', resize);
    addCleanup(() => window.removeEventListener('resize', resize));
    
    setupRunnerControls();
    setupRunnerHUD();
    
    gameLoop = requestAnimationFrame(updateRunner);
};

const setupRunnerControls = () => {
    const charScale = G.data.charScale || 1;
    const evoBonus = (G.data.evoTraits?.length || 0) * 0.02;
    const totalScale = charScale + evoBonus;
    
    const jump = () => {
        if (runner.onGround && !runner.ducking) {
            let jumpPower = -18;
            if (activeEffects.jump) jumpPower = -25;
            runner.vy = jumpPower;
            runner.onGround = false;
            Audio.playJump();
        }
    };
    
    const duckStart = () => { 
        if (runner.onGround) { 
            runner.ducking = true; 
            runner.h = 25 * totalScale; 
        } 
    };
    const duckEnd = () => { 
        runner.ducking = false; 
        runner.h = runner.baseH * totalScale; 
    };
    
    document.getElementById('btn-jump').onclick = jump;
    document.getElementById('btn-jump').ontouchstart = e => { e.preventDefault(); jump(); };
    
    document.getElementById('btn-duck').ontouchstart = e => { e.preventDefault(); duckStart(); };
    document.getElementById('btn-duck').ontouchend = duckEnd;
    document.getElementById('btn-duck').onmousedown = duckStart;
    document.getElementById('btn-duck').onmouseup = duckEnd;
    
    const onKeyDown = e => {
        if (e.key === ' ' || e.key === 'ArrowUp' || e.key.toLowerCase() === 'w') jump();
        if (e.key === 'ArrowDown' || e.key.toLowerCase() === 's') duckStart();
    };
    const onKeyUp = e => {
        if (e.key === 'ArrowDown' || e.key.toLowerCase() === 's') duckEnd();
    };
    
    window.addEventListener('keydown', onKeyDown);
    window.addEventListener('keyup', onKeyUp);
    addCleanup(() => {
        window.removeEventListener('keydown', onKeyDown);
        window.removeEventListener('keyup', onKeyUp);
    });
};

const setupRunnerHUD = () => {
    document.getElementById('btn-stats').onclick = () => {
        Audio.playClick();
        cancelAnimationFrame(gameLoop);
        gameLoop = null;
        showStatsPanel();
    };
    document.getElementById('btn-clear').onclick = () => {
        Audio.playClick();
        runnerStageComplete(); // ÌÖåÏä§Ìä∏Ïö© Ï¶âÏãú ÌÅ¥Î¶¨Ïñ¥
    };
    document.getElementById('btn-edit').onclick = () => {
        Audio.playClick();
        cancelAnimationFrame(gameLoop);
        gameLoop = null;
        G.data.runnerDist = runnerDist; // Í±∞Î¶¨ Ï†ÄÏû•
        saveGame();
        openEvoEditor();
    };
    document.getElementById('btn-home').onclick = () => {
        Audio.playClick();
        if (confirm('ÌôàÏúºÎ°ú?')) {
            cancelAnimationFrame(gameLoop);
            gameLoop = null;
            G.data.runnerDist = runnerDist;
            saveGame();
            renderSaves();
        }
    };
    document.getElementById('btn-pause').onclick = () => {
        Audio.playClick();
        const btn = document.getElementById('btn-pause');
        if (gameLoop) { cancelAnimationFrame(gameLoop); gameLoop = null; btn.textContent = '‚ñ∂Ô∏è'; }
        else { gameLoop = requestAnimationFrame(updateRunner); btn.textContent = '‚è∏Ô∏è'; }
    };
};

// Ïä§ÌÖü Ìå®ÎÑê ÌëúÏãú
const showStatsPanel = () => {
    const stats = calculateStats();
    const traits = G.data.evoTraits || [];
    
    // Ïä§ÌÉØ Ïù¥Î¶Ñ ÌïúÍ∏Ä Îß§Ìïë
    const statNames = {
        speed: 'ÏÜçÎèÑ', jump: 'Ï†êÌîÑ', defense: 'Î∞©Ïñ¥', attack: 'Í≥µÍ≤©',
        score: 'Ï†êÏàò', magnet: 'ÏûêÏÑù', vision: 'ÏãúÏïº',
        doubleJump: '2Îã®Ï†êÌîÑ', infiniteJump: 'Î¨¥ÌïúÏ†êÌîÑ', glide: 'ÌôúÍ≥µ',
        reflect: 'Î∞òÏÇ¨', stealth: 'ÏùÄÏã†', detectEnemy: 'Ï†ÅÌÉêÏßÄ',
        predict: 'ÏòàÏ∏°', doubleParts: '2Î∞∞ÌöçÎìù', regen: 'ÌöåÎ≥µ',
        invincible: 'Î¨¥Ï†Å', dodge: 'ÌöåÌîº', aoe: 'Î≤îÏúÑ', pierce: 'Í¥ÄÌÜµ',
        fire: 'ÌôîÏóº', freeze: 'ÎπôÍ≤∞', shock: 'Í∞êÏ†Ñ', autoDestroy: 'ÏûêÎèôÌååÍ¥¥',
        poison: 'ÎèÖ', poisonImmune: 'ÎèÖÎ©¥Ïó≠', poisonAura: 'ÎèÖÏò§Îùº',
        fireImmune: 'ÌôîÎ©¥Ïó≠', fireAura: 'ÌôîÏò§Îùº', slow: 'ÎëîÌôî',
        slowAura: 'ÎëîÌôîÏò§Îùº', slowImmune: 'ÎëîÌôîÎ©¥Ïó≠', bind: 'ÏÜçÎ∞ï',
        fear: 'Í≥µÌè¨', trap: 'Ìï®Ï†ï', slowTime: 'ÏãúÍ∞ÑÍ∞êÏÜç', reaction: 'Î∞òÏùë'
    };
    
    // ÌååÏ∏†Î≥Ñ Îä•Î†•Ïπò Î™©Î°ù
    let partsHtml = '';
    traits.forEach(et => {
        const trait = getTraitById(et.id);
        if (trait) {
            const bonus = TRAIT_STATS[trait.effect] || {};
            let bonusText = Object.entries(bonus).map(([k, v]) => {
                const name = statNames[k] || k;
                if (typeof v === 'boolean') return name;
                return `${name}+${v}`;
            }).join(', ') || trait.effect;
            
            partsHtml += `<div style="display:flex;align-items:center;gap:8px;padding:8px;background:var(--void-elevated);border-radius:8px;margin:4px 0;">
                <span style="font-size:1.5rem;">${trait.icon}</span>
                <div style="flex:1;">
                    <div style="font-weight:600;color:var(--text-primary);font-size:0.85rem;">${trait.name}</div>
                    <div style="font-size:0.7rem;color:var(--neon-yellow);">${bonusText}</div>
                </div>
            </div>`;
        }
    });
    
    if (partsHtml === '') partsHtml = '<div style="color:var(--text-muted);padding:20px;text-align:center;">Î≥¥Ïú†Ìïú ÌååÏ∏†Í∞Ä ÏóÜÏäµÎãàÎã§</div>';
    
    app.innerHTML = `
        <div class="page-center"><div class="page-content" style="max-width:380px;max-height:85vh;overflow-y:auto;">
            <h2 class="page-title">üìä Ïä§ÌÖü Ï†ïÎ≥¥</h2>
            
            <div style="background:var(--void-surface);border-radius:12px;padding:16px;margin-bottom:16px;">
                <div style="font-size:0.75rem;color:var(--text-muted);margin-bottom:10px;">Í∏∞Î≥∏ Ïä§ÌÖü + ÌååÏ∏† Î≥¥ÎÑàÏä§</div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                    <div style="padding:8px;background:var(--void-elevated);border-radius:8px;">
                        <div style="font-size:0.7rem;color:var(--text-muted);">üèÉ ÏÜçÎèÑ</div>
                        <div style="font-family:Orbitron;font-size:1rem;color:var(--neon-cyan);">${BASE_STATS.speed} <span style="color:var(--success);">+${(stats.speed - BASE_STATS.speed).toFixed(1)}</span></div>
                    </div>
                    <div style="padding:8px;background:var(--void-elevated);border-radius:8px;">
                        <div style="font-size:0.7rem;color:var(--text-muted);">‚¨ÜÔ∏è Ï†êÌîÑ</div>
                        <div style="font-family:Orbitron;font-size:1rem;color:var(--neon-cyan);">${BASE_STATS.jump} <span style="color:var(--success);">+${(stats.jump - BASE_STATS.jump).toFixed(0)}</span></div>
                    </div>
                    <div style="padding:8px;background:var(--void-elevated);border-radius:8px;">
                        <div style="font-size:0.7rem;color:var(--text-muted);">üõ°Ô∏è Î∞©Ïñ¥</div>
                        <div style="font-family:Orbitron;font-size:1rem;color:var(--neon-cyan);">${BASE_STATS.defense} <span style="color:var(--success);">+${(stats.defense - BASE_STATS.defense).toFixed(1)}</span></div>
                    </div>
                    <div style="padding:8px;background:var(--void-elevated);border-radius:8px;">
                        <div style="font-size:0.7rem;color:var(--text-muted);">‚öîÔ∏è Í≥µÍ≤©</div>
                        <div style="font-family:Orbitron;font-size:1rem;color:var(--neon-cyan);">${BASE_STATS.attack} <span style="color:var(--success);">+${(stats.attack - BASE_STATS.attack).toFixed(1)}</span></div>
                    </div>
                    <div style="padding:8px;background:var(--void-elevated);border-radius:8px;">
                        <div style="font-size:0.7rem;color:var(--text-muted);">‚≠ê Ï†êÏàò</div>
                        <div style="font-family:Orbitron;font-size:1rem;color:var(--neon-cyan);">x${BASE_STATS.score} <span style="color:var(--success);">+${(stats.score - BASE_STATS.score).toFixed(1)}</span></div>
                    </div>
                    <div style="padding:8px;background:var(--void-elevated);border-radius:8px;">
                        <div style="font-size:0.7rem;color:var(--text-muted);">üß≤ ÏûêÏÑù</div>
                        <div style="font-family:Orbitron;font-size:1rem;color:var(--neon-cyan);">${BASE_STATS.magnet} <span style="color:var(--success);">+${(stats.magnet - BASE_STATS.magnet).toFixed(0)}</span></div>
                    </div>
                    <div style="padding:8px;background:var(--void-elevated);border-radius:8px;grid-column:span 2;">
                        <div style="font-size:0.7rem;color:var(--text-muted);">üëÅÔ∏è ÏãúÏïº</div>
                        <div style="font-family:Orbitron;font-size:1rem;color:var(--neon-cyan);">${BASE_STATS.vision}% <span style="color:var(--success);">+${(stats.vision - BASE_STATS.vision).toFixed(0)}%</span></div>
                    </div>
                </div>
            </div>
            
            <div style="background:var(--void-surface);border-radius:12px;padding:16px;margin-bottom:16px;">
                <div style="font-size:0.75rem;color:var(--text-muted);margin-bottom:10px;">üß¨ Î≥¥Ïú† ÌååÏ∏† (${traits.length}Í∞ú)</div>
                ${partsHtml}
            </div>
            
            <button class="btn btn-energy btn-block" id="btn-close">ÌôïÏù∏</button>
        </div></div>
    `;
    
    document.getElementById('btn-close').onclick = () => {
        Audio.playClick();
        resumeRunner();
    };
};

const updateRunner = () => {
    if (!canvas || !ctx) return;
    
    const stage = RUNNER_STAGES[runnerStage];
    const groundY = canvas.height - 80;
    const now = Date.now();
    
    // Ìö®Í≥º ÎßåÎ£å Ï≤¥ÌÅ¨
    Object.keys(activeEffects).forEach(key => {
        if (activeEffects[key] && now > activeEffects[key]) {
            delete activeEffects[key];
            updateEffectIcons();
        }
    });
    
    // Ï§ëÎ†•
    runner.vy += 0.8;
    runner.y += runner.vy;
    
    if (runner.y >= groundY - runner.h) {
        runner.y = groundY - runner.h;
        runner.vy = 0;
        runner.onGround = true;
    }
    
    // Í±∞Î¶¨ Ï¶ùÍ∞Ä
    let speedMod = 1;
    if (activeEffects.speed) speedMod = 1.5;
    if (activeEffects.slow) speedMod = 0.6;
    
    runnerDist += runnerSpeed * 0.08 * speedMod;
    runnerSpeed = stage.baseSpeed + runnerDist * 0.002;
    runnerSpeed = Math.min(runnerSpeed, stage.baseSpeed + 3);
    
    bgOffset += runnerSpeed * speedMod;
    
    // Ïû•Ïï†Î¨º ÏÉùÏÑ±
    if (now - lastObstacleTime > MIN_OBSTACLE_GAP && Math.random() < 0.012) {
        const type = stage.obstacles[Math.floor(Math.random() * stage.obstacles.length)];
        const tall = Math.random() < 0.2;
        obstacles.push({
            x: canvas.width + 50,
            y: tall ? groundY - 65 : groundY - 40,
            w: 40,
            h: tall ? 30 : 40,
            type,
            tall
        });
        lastObstacleTime = now;
    }
    
    // ÏïÑÏù¥ÌÖú ÏÉùÏÑ± (Îã§ÏñëÌïú ÏïÑÏù¥ÌÖú)
    Object.entries(RUNNER_ITEMS).forEach(([key, item]) => {
        if (Math.random() < item.rate) {
            items.push({
                x: canvas.width + 50,
                y: groundY - 90 - Math.random() * 40,
                type: key,
                collected: false
            });
        }
    });
    
    // Ïû•Ïï†Î¨º Ï≤òÎ¶¨
    for (let i = obstacles.length - 1; i >= 0; i--) {
        const o = obstacles[i];
        o.x -= runnerSpeed * 1.5 * speedMod;
        
        if (o.x < -60) { obstacles.splice(i, 1); continue; }
        
        // Î¨¥Ï†ÅÏù¥ ÏïÑÎãê ÎïåÎßå Ï∂©Îèå Ï≤¥ÌÅ¨
        if (!activeEffects.shield) {
            // Ï∂ïÏÜå Ìö®Í≥º Ï†ÅÏö©
            const hitScale = activeEffects.shrink ? 0.5 : 1;
            const hs = 10;
            if (runner.x + runner.w * hitScale - hs > o.x + hs &&
                runner.x + hs < o.x + o.w - hs &&
                runner.y + runner.h > o.y + hs &&
                runner.y < o.y + o.h - hs) {
                runnerFail();
                return;
            }
        }
    }
    
    // ÏïÑÏù¥ÌÖú ÏàòÏßë
    for (let i = items.length - 1; i >= 0; i--) {
        const item = items[i];
        item.x -= runnerSpeed * 1.5 * speedMod;
        
        if (item.x < -50) { items.splice(i, 1); continue; }
        
        if (!item.collected) {
            let collectRange = 45;
            if (activeEffects.magnet) collectRange = 120;
            
            const dx = (runner.x + runner.w / 2) - item.x;
            const dy = (runner.y + runner.h / 2) - item.y;
            const dist = Math.sqrt(dx * dx + dy * dy);
            
            // ÏûêÏÑù Ìö®Í≥º: ÏïÑÏù¥ÌÖúÏù¥ ÌîåÎ†àÏù¥Ïñ¥ÏóêÍ≤å ÎÅåÎ†§Ïò¥
            if (activeEffects.magnet && dist < collectRange) {
                item.x += dx * 0.1;
                item.y += dy * 0.1;
            }
            
            if (dist < 45) {
                item.collected = true;
                items.splice(i, 1);
                collectItem(item.type);
                if (item.type === 'dice') return; // Ï£ºÏÇ¨ÏúÑÎäî ÌôîÎ©¥ Ï†ÑÌôò
            }
        }
    }
    
    // ÌååÌã∞ÌÅ¥
    runnerParticles = runnerParticles.filter(p => {
        p.x += p.vx; p.y += p.vy; p.life--;
        return p.life > 0;
    });
    
    renderRunner(stage, groundY);
    
    const distEl = document.getElementById('r-dist');
    if (distEl) distEl.textContent = `${Math.floor(runnerDist)}m / ${stage.dist}m`;
    
    if (runnerDist >= stage.dist) {
        runnerStageComplete();
        return;
    }
    
    gameLoop = requestAnimationFrame(updateRunner);
};

// ÏïÑÏù¥ÌÖú ÏàòÏßë Ï≤òÎ¶¨
const collectItem = type => {
    const item = RUNNER_ITEMS[type];
    const now = Date.now();
    
    switch (type) {
        case 'dice':
            // Ï£ºÏÇ¨ÏúÑ: ÏßÑÌôî Ï£ºÏÇ¨ÏúÑ ÌôîÎ©¥ÏúºÎ°ú
            cancelAnimationFrame(gameLoop);
            gameLoop = null;
            G.data.runnerDist = runnerDist; // Í±∞Î¶¨ Ï†ÄÏû•!
            saveGame();
            rollEvoDice();
            break;
        case 'jump':
            activeEffects.jump = now + item.duration;
            Audio.playCollect();
            toast('ü¶ò Ï†êÌîÑÎ†• Ìñ•ÏÉÅ!', 'success');
            break;
        case 'speed':
            activeEffects.speed = now + item.duration;
            delete activeEffects.slow;
            Audio.playCollect();
            toast('‚ö° ÏÜçÎèÑ Ï¶ùÍ∞Ä!', 'success');
            break;
        case 'slow':
            activeEffects.slow = now + item.duration;
            delete activeEffects.speed;
            Audio.playCollect();
            toast('üê¢ Ï≤úÏ≤úÌûà...', 'info');
            break;
        case 'shield':
            activeEffects.shield = now + item.duration;
            Audio.playCollect();
            toast('üõ°Ô∏è Î¨¥Ï†Å!', 'success');
            break;
        case 'magnet':
            activeEffects.magnet = now + item.duration;
            Audio.playCollect();
            toast('üß≤ ÏûêÏÑù ÌôúÏÑ±Ìôî!', 'success');
            break;
        case 'shrink':
            activeEffects.shrink = now + item.duration;
            Audio.playCollect();
            toast('üîª Î™∏Ïù¥ ÏûëÏïÑÏ°åÎã§!', 'info');
            break;
        case 'coin':
            G.data.score = (G.data.score || 0) + 100;
            Audio.playEatBig();
            toast('üíé +100Ï†ê!', 'success');
            break;
    }
    
    updateEffectIcons();
};

const updateEffectIcons = () => {
    const el = document.getElementById('effect-icons');
    if (!el) return;
    
    let html = '';
    Object.keys(activeEffects).forEach(key => {
        const item = RUNNER_ITEMS[key];
        if (item) {
            const remaining = Math.ceil((activeEffects[key] - Date.now()) / 1000);
            html += `<div style="background:rgba(0,0,0,0.7);border-radius:8px;padding:4px 8px;font-size:0.8rem;">${item.icon} ${remaining}s</div>`;
        }
    });
    el.innerHTML = html;
};

// üé≤ ÏßÑÌôî Ï£ºÏÇ¨ÏúÑ
const rollEvoDice = () => {
    const traits = getRegionTraits();
    
    app.innerHTML = `
        <div class="page-center">
            <div class="page-content">
                <h2 class="page-title">üé≤ ÏßÑÌôî Ï£ºÏÇ¨ÏúÑ!</h2>
                <p style="color:var(--text-secondary);margin-bottom:16px;">51 Ïù¥ÏÉÅÏù¥Î©¥ ÏÉàÎ°úÏö¥ ÌäπÏÑ±!</p>
                <div class="dice-box" id="dice">üé≤</div>
                <div id="result"></div>
            </div>
        </div>
    `;
    
    const dice = document.getElementById('dice');
    const result = document.getElementById('result');
    
    dice.classList.add('rolling');
    Audio.playDice();
    
    const anim = setInterval(() => {
        dice.textContent = Math.floor(Math.random() * 100) + 1;
    }, 50);
    
    setTimeout(() => {
        clearInterval(anim);
        dice.classList.remove('rolling');
        
        const roll = Math.floor(Math.random() * 100) + 1;
        dice.textContent = roll;
        
        if (roll >= 51) {
            dice.style.cssText = 'font-size:3rem;font-family:Orbitron;font-weight:900;color:var(--success);text-shadow:0 0 25px var(--success);';
            Audio.playEvolve();
            
            const owned = G.data.evoTraits?.map(t => t.id) || [];
            const available = traits.filter(t => !owned.includes(t.id));
            
            if (available.length > 0) {
                const trait = available[Math.floor(Math.random() * available.length)];
                const randX = 0.4 + Math.random() * 0.2;
                const randY = 0.3 + Math.random() * 0.4;
                const newTrait = {
                    id: trait.id,
                    x: randX,
                    y: randY,
                    scale: 1,
                    rotation: 0,
                    // bodySize Í∏∞Ï§Ä ÏÉÅÎåÄÏ¢åÌëú (0.15 = ÏóêÎîîÌÑ∞ Í∏∞Î≥∏ ÎπÑÏú®)
                    relX: (randX - 0.5) / 0.15,
                    relY: (randY - 0.5) / 0.15
                };
                if (!G.data.evoTraits) G.data.evoTraits = [];
                G.data.evoTraits.push(newTrait);
                saveGame();
                
                result.innerHTML = `
                    <div style="text-align:center;margin:16px 0;">
                        <div style="font-size:3rem;margin-bottom:6px;">${trait.icon}</div>
                        <div style="font-family:Orbitron;font-size:1.1rem;font-weight:700;color:var(--success);margin-bottom:4px;">${trait.name}</div>
                        <div style="color:var(--text-secondary);font-size:0.85rem;">${trait.desc}</div>
                        <div style="color:var(--neon-yellow);font-size:0.75rem;margin-top:4px;">‚ú® ${trait.effect}</div>
                    </div>
                    <button class="btn btn-energy btn-block" id="btn-continue">ÌååÏ∏† Î∞∞ÏπòÌïòÍ∏∞ ‚úã</button>
                `;
                document.getElementById('btn-continue').onclick = () => { Audio.playClick(); openEvoEditor(true); };
            } else {
                result.innerHTML = `<p style="color:var(--text-secondary);margin:16px 0;">Ïù¥ÎØ∏ Î™®Îì† ÌäπÏÑ±ÏùÑ ÌöçÎìù!</p><button class="btn btn-energy btn-block" id="btn-continue">Í≥ÑÏÜç</button>`;
                document.getElementById('btn-continue').onclick = () => { Audio.playClick(); resumeRunner(); };
            }
        } else {
            dice.style.cssText = 'font-size:3rem;font-family:Orbitron;font-weight:900;color:var(--danger);text-shadow:0 0 25px var(--danger);';
            Audio.playFail();
            
            result.innerHTML = `
                <div style="text-align:center;margin:16px 0;">
                    <div style="font-size:3rem;margin-bottom:6px;">üò¢</div>
                    <div style="font-family:Orbitron;font-size:1.1rem;font-weight:700;color:var(--danger);">ÏïÑÏâΩÎã§!</div>
                    <div style="color:var(--text-secondary);font-size:0.85rem;">Îã§Ïùå Ï£ºÏÇ¨ÏúÑÎ•º ÎÖ∏Î†§Î≥¥Ïûê</div>
                </div>
                <button class="btn btn-outline btn-block" id="btn-continue">Í≥ÑÏÜç Îã¨Î¶¨Í∏∞</button>
            `;
            document.getElementById('btn-continue').onclick = () => { Audio.playClick(); resumeRunner(); };
        }
    }, 1500);
};

// ÏßÑÌôî Ìé∏ÏßëÍ∏∞ (Ï∫êÎ¶≠ÌÑ∞ + ÌååÏ∏† ÌÅ¨Í∏∞/ÌöåÏ†Ñ/ÏÇ≠Ï†ú)
const openEvoEditor = (isNew = false) => {
    const charScale = G.data.charScale || 1;
    const stats = calculateStats();
    
    app.innerHTML = `
        <div style="position:fixed;inset:0;z-index:400;background:rgba(3,3,8,0.98);display:flex;flex-direction:column;">
            <div style="padding:12px 16px;padding-top:calc(12px + var(--safe-top));text-align:center;border-bottom:1px solid var(--border-default);">
                <div style="font-family:Orbitron;font-size:1.1rem;color:var(--neon-cyan);">‚úã ÌååÏ∏† Î∞∞Ïπò & Ìé∏Ïßë</div>
            </div>
            
            <!-- Ïä§ÌÖü ÏöîÏïΩ -->
            <div id="stats-summary" style="padding:8px 16px;background:var(--void-elevated);border-bottom:1px solid var(--border-subtle);display:flex;gap:8px;flex-wrap:wrap;justify-content:center;">
                <span style="font-size:0.7rem;color:var(--text-muted);">üèÉ${stats.speed.toFixed(1)}</span>
                <span style="font-size:0.7rem;color:var(--text-muted);">‚¨ÜÔ∏è${stats.jump.toFixed(0)}</span>
                <span style="font-size:0.7rem;color:var(--text-muted);">üõ°Ô∏è${stats.defense.toFixed(1)}</span>
                <span style="font-size:0.7rem;color:var(--text-muted);">‚öîÔ∏è${stats.attack.toFixed(1)}</span>
                <span style="font-size:0.7rem;color:var(--text-muted);">‚≠êx${stats.score.toFixed(1)}</span>
                <span style="font-size:0.7rem;color:var(--text-muted);">üß≤${stats.magnet.toFixed(0)}</span>
            </div>
            
            <div style="padding:10px 16px;border-bottom:1px solid var(--border-subtle);background:var(--void-surface);">
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px;">
                    <span style="font-size:0.75rem;color:var(--text-secondary);min-width:55px;">Ï∫êÎ¶≠ÌÑ∞</span>
                    <input type="range" id="char-scale" min="50" max="200" value="${charScale * 100}" style="flex:1;">
                    <span id="char-scale-val" style="font-family:Orbitron;font-size:0.7rem;color:var(--neon-cyan);min-width:30px;">${Math.round(charScale * 100)}%</span>
                </div>
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px;">
                    <span style="font-size:0.75rem;color:var(--text-secondary);min-width:55px;">ÌååÏ∏†ÌÅ¨Í∏∞</span>
                    <input type="range" id="part-scale" min="30" max="250" value="100" style="flex:1;">
                    <span id="part-scale-val" style="font-family:Orbitron;font-size:0.7rem;color:var(--neon-yellow);min-width:30px;">100%</span>
                </div>
                <div style="display:flex;align-items:center;gap:10px;">
                    <span style="font-size:0.75rem;color:var(--text-secondary);min-width:55px;">ÌöåÏ†Ñ</span>
                    <input type="range" id="part-rotation" min="-180" max="180" value="0" style="flex:1;">
                    <span id="part-rotation-val" style="font-family:Orbitron;font-size:0.7rem;color:var(--neon-purple);min-width:30px;">0¬∞</span>
                </div>
            </div>
            
            <div id="selected-info" style="padding:8px 16px;background:var(--void-elevated);display:none;align-items:center;gap:8px;">
                <span id="selected-icon" style="font-size:1.3rem;"></span>
                <div style="flex:1;">
                    <div id="selected-name" style="font-size:0.8rem;color:var(--text-primary);"></div>
                    <div id="selected-effect" style="font-size:0.65rem;color:var(--neon-yellow);"></div>
                </div>
                <button id="btn-flip" style="background:var(--neon-purple);color:white;border:none;border-radius:6px;padding:5px 10px;font-size:0.7rem;cursor:pointer;">‚ÜîÔ∏è Î∞òÏ†Ñ</button>
                <button id="btn-delete-part" style="background:var(--danger);color:white;border:none;border-radius:6px;padding:5px 10px;font-size:0.7rem;cursor:pointer;">üóëÔ∏è</button>
            </div>
            
            <div style="flex:1;position:relative;overflow:hidden;" id="editor-wrap">
                <canvas id="editor-canvas"></canvas>
            </div>
            <div style="padding:12px 16px;padding-bottom:calc(12px + var(--safe-bottom));display:flex;gap:10px;justify-content:center;border-top:1px solid var(--border-default);">
                <button class="btn btn-outline" id="btn-cancel">${isNew ? 'ÎÇòÏ§ëÏóê' : 'Ï∑®ÏÜå'}</button>
                <button class="btn btn-energy" id="btn-save">ÏôÑÎ£å</button>
            </div>
        </div>
    `;
    
    const wrap = document.getElementById('editor-wrap');
    const cvs = document.getElementById('editor-canvas');
    cvs.width = wrap.clientWidth;
    cvs.height = wrap.clientHeight;
    const ectx = cvs.getContext('2d');
    
    let selectedPart = null;
    let dragOffset = { x: 0, y: 0 };
    let isDragging = false;
    
    const updateSelectedInfo = () => {
        const infoEl = document.getElementById('selected-info');
        if (selectedPart !== null && G.data.evoTraits[selectedPart]) {
            const et = G.data.evoTraits[selectedPart];
            const traits = getRegionTraits();
            const trait = traits.find(t => t.id === et.id) || getTraitById(et.id);
            if (trait) {
                document.getElementById('selected-icon').textContent = trait.icon;
                document.getElementById('selected-name').textContent = trait.name;
                document.getElementById('selected-effect').textContent = trait.effect || '';
                infoEl.style.display = 'flex';
                
                // Ïä¨ÎùºÏù¥Îçî ÏóÖÎç∞Ïù¥Ìä∏
                document.getElementById('part-scale').value = (et.scale || 1) * 100;
                document.getElementById('part-scale-val').textContent = `${Math.round((et.scale || 1) * 100)}%`;
                document.getElementById('part-rotation').value = ((et.rotation || 0) * 180 / Math.PI);
                document.getElementById('part-rotation-val').textContent = `${Math.round((et.rotation || 0) * 180 / Math.PI)}¬∞`;
            }
        } else {
            infoEl.style.display = 'none';
        }
        
        // Ïä§ÌÖü ÏöîÏïΩ ÏóÖÎç∞Ïù¥Ìä∏
        const stats = calculateStats();
        const summaryEl = document.getElementById('stats-summary');
        if (summaryEl) {
            summaryEl.innerHTML = `
                <span style="font-size:0.7rem;color:var(--text-muted);">üèÉ${stats.speed.toFixed(1)}</span>
                <span style="font-size:0.7rem;color:var(--text-muted);">‚¨ÜÔ∏è${stats.jump.toFixed(0)}</span>
                <span style="font-size:0.7rem;color:var(--text-muted);">üõ°Ô∏è${stats.defense.toFixed(1)}</span>
                <span style="font-size:0.7rem;color:var(--text-muted);">‚öîÔ∏è${stats.attack.toFixed(1)}</span>
                <span style="font-size:0.7rem;color:var(--text-muted);">‚≠êx${stats.score.toFixed(1)}</span>
                <span style="font-size:0.7rem;color:var(--text-muted);">üß≤${stats.magnet.toFixed(0)}</span>
            `;
        }
    };
    
    // Ï∫êÎ¶≠ÌÑ∞ ÌÅ¨Í∏∞ Ïä¨ÎùºÏù¥Îçî
    document.getElementById('char-scale').oninput = e => {
        G.data.charScale = e.target.value / 100;
        document.getElementById('char-scale-val').textContent = `${e.target.value}%`;
    };
    
    // ÌååÏ∏† ÌÅ¨Í∏∞ Ïä¨ÎùºÏù¥Îçî
    document.getElementById('part-scale').oninput = e => {
        document.getElementById('part-scale-val').textContent = `${e.target.value}%`;
        if (selectedPart !== null && G.data.evoTraits[selectedPart]) {
            G.data.evoTraits[selectedPart].scale = e.target.value / 100;
        }
    };
    
    // ÌååÏ∏† ÌöåÏ†Ñ Ïä¨ÎùºÏù¥Îçî
    document.getElementById('part-rotation').oninput = e => {
        document.getElementById('part-rotation-val').textContent = `${e.target.value}¬∞`;
        if (selectedPart !== null && G.data.evoTraits[selectedPart]) {
            G.data.evoTraits[selectedPart].rotation = e.target.value * Math.PI / 180;
        }
    };
    
    // Ï¢åÏö∞ Î∞òÏ†Ñ Î≤ÑÌäº
    document.getElementById('btn-flip').onclick = () => {
        if (selectedPart !== null && G.data.evoTraits[selectedPart]) {
            const et = G.data.evoTraits[selectedPart];
            et.flipX = !et.flipX;
            Audio.playClick();
        }
    };
    
    // ÏÇ≠Ï†ú Î≤ÑÌäº
    document.getElementById('btn-delete-part').onclick = () => {
        if (selectedPart !== null && G.data.evoTraits[selectedPart]) {
            if (confirm('Ïù¥ ÌååÏ∏†Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                G.data.evoTraits.splice(selectedPart, 1);
                selectedPart = null;
                updateSelectedInfo();
                Audio.playClick();
            }
        }
    };
    
    const drawEditor = () => {
        const w = cvs.width, h = cvs.height;
        ectx.fillStyle = '#0a0a1a';
        ectx.fillRect(0, 0, w, h);
        
        const d = G.data.design;
        const cx = w / 2, cy = h / 2;
        const baseSize = Math.min(w, h) * 0.15;
        // Í≤åÏûÑÍ≥º ÎèôÏùºÌïòÍ≤å evoBonus Ï†ÅÏö©
        const evoBonus = (G.data.evoTraits?.length || 0) * 0.02;
        const totalScale = (G.data.charScale || 1) + evoBonus;
        const bodySize = baseSize * totalScale;
        const t = Date.now() * 0.002;
        
        // Í∏∞Î≥∏ Îã§Î¶¨ (ÏµúÏÜå 2Í∞úÎäî Ìï≠ÏÉÅ ÌëúÏãú)
        const legCnt = Math.max(2, G.data.parts?.leg || 0);
        ectx.strokeStyle = d.secondary;
        ectx.lineWidth = 5;
        ectx.lineCap = 'round';
        for (let i = 0; i < Math.min(legCnt, 4); i++) {
            const legPhase = Math.sin(t * 2 + i) * 0.3;
            const baseAngle = Math.PI * 0.5 + (i - (legCnt - 1) / 2) * 0.25;
            ectx.beginPath();
            ectx.moveTo(cx + Math.cos(baseAngle) * bodySize * 0.8, cy + Math.sin(baseAngle) * bodySize * 0.8);
            ectx.lineTo(cx + Math.cos(baseAngle + legPhase) * bodySize * 1.4, cy + bodySize * 1.2);
            ectx.stroke();
        }
        
        // Í∏∞Î≥∏ Ìåî
        const armCnt = G.data.parts?.arm || 0;
        if (armCnt > 0) {
            ectx.strokeStyle = d.primary;
            ectx.lineWidth = 4;
            for (let i = 0; i < Math.min(armCnt, 4); i++) {
                const side = i % 2 === 0 ? 1 : -1;
                const armWave = Math.sin(t * 2 + i) * 0.2;
                ectx.beginPath();
                ectx.moveTo(cx + side * bodySize * 0.7, cy);
                ectx.quadraticCurveTo(cx + side * bodySize * 1.2, cy + armWave * bodySize, cx + side * bodySize * 1.5, cy + bodySize * 0.3);
                ectx.stroke();
            }
        }
        
        // Íº¨Î¶¨
        const tailCnt = G.data.parts?.tail || 0;
        if (tailCnt > 0) {
            ectx.strokeStyle = d.primary;
            ectx.lineWidth = 4;
            const tailWave = Math.sin(t * 3) * bodySize * 0.3;
            ectx.beginPath();
            ectx.moveTo(cx - bodySize * 0.8, cy);
            ectx.bezierCurveTo(cx - bodySize * 1.3, cy + tailWave, cx - bodySize * 1.6, cy - tailWave * 0.5, cx - bodySize * 2, cy + tailWave * 0.3);
            ectx.stroke();
        }
        
        // Î™∏ÌÜµ
        ectx.shadowColor = d.primary;
        ectx.shadowBlur = 20;
        ectx.beginPath();
        for (let i = 0; i < 10; i++) {
            const ang = (i / 10) * Math.PI * 2;
            const wobble = Math.sin(t + i) * 5;
            const r = bodySize + wobble;
            i === 0 ? ectx.moveTo(cx + Math.cos(ang) * r, cy + Math.sin(ang) * r) : ectx.lineTo(cx + Math.cos(ang) * r, cy + Math.sin(ang) * r);
        }
        ectx.closePath();
        const grad = ectx.createRadialGradient(cx - bodySize * 0.2, cy - bodySize * 0.2, 0, cx, cy, bodySize);
        grad.addColorStop(0, d.primary);
        grad.addColorStop(1, d.secondary);
        ectx.fillStyle = grad;
        ectx.fill();
        ectx.shadowBlur = 0;
        
        // Í∑Ä
        const earCnt = G.data.parts?.ear || 0;
        if (earCnt > 0) {
            for (let i = 0; i < Math.min(earCnt, 2); i++) {
                const side = i === 0 ? 1 : -1;
                ectx.beginPath();
                ectx.ellipse(cx + side * bodySize * 0.7, cy - bodySize * 0.5, bodySize * 0.15, bodySize * 0.25, side * 0.3, 0, Math.PI * 2);
                ectx.fillStyle = d.primary;
                ectx.fill();
            }
        }
        
        // Í∏∞Î≥∏ Îàà
        const eyeCnt = Math.max(1, G.data.parts?.eye || 1);
        for (let i = 0; i < eyeCnt; i++) {
            const ex = cx + (i - (eyeCnt - 1) / 2) * bodySize * 0.4;
            const ey = cy - bodySize * 0.2;
            ectx.beginPath();
            ectx.arc(ex, ey, bodySize * 0.18, 0, Math.PI * 2);
            ectx.fillStyle = 'white';
            ectx.fill();
            ectx.beginPath();
            ectx.arc(ex + bodySize * 0.03, ey, bodySize * 0.08, 0, Math.PI * 2);
            ectx.fillStyle = '#222';
            ectx.fill();
        }
        
        // ÏΩî
        if (G.data.parts?.nose > 0) {
            ectx.fillStyle = '#ffcc99';
            ectx.beginPath();
            ectx.moveTo(cx, cy + bodySize * 0.1);
            ectx.lineTo(cx - bodySize * 0.08, cy + bodySize * 0.25);
            ectx.lineTo(cx + bodySize * 0.08, cy + bodySize * 0.25);
            ectx.closePath();
            ectx.fill();
        }
        
        // ÏûÖ
        if (G.data.parts?.mouth > 0) {
            ectx.strokeStyle = d.secondary;
            ectx.lineWidth = 3;
            ectx.lineCap = 'round';
            ectx.beginPath();
            ectx.arc(cx, cy + bodySize * 0.35, bodySize * 0.15, 0.2, Math.PI - 0.2);
            ectx.stroke();
        }
        
        // ÎçîÎì¨Ïù¥
        const antCnt = G.data.parts?.antenna || 0;
        if (antCnt > 0) {
            ectx.strokeStyle = d.primary;
            ectx.lineWidth = 2;
            for (let i = 0; i < Math.min(antCnt, 2); i++) {
                const side = i === 0 ? 1 : -1;
                const wave = Math.sin(t * 3) * 0.1;
                ectx.beginPath();
                ectx.moveTo(cx + side * bodySize * 0.3, cy - bodySize * 0.8);
                ectx.quadraticCurveTo(cx + side * bodySize * 0.5, cy - bodySize * 1.3, cx + side * bodySize * 0.7, cy - bodySize * 1.2 + wave * bodySize);
                ectx.stroke();
                ectx.beginPath();
                ectx.arc(cx + side * bodySize * 0.7, cy - bodySize * 1.2 + wave * bodySize, 5, 0, Math.PI * 2);
                ectx.fillStyle = d.primary;
                ectx.fill();
            }
        }
        
        // ÏßÑÌôî ÌååÏ∏†Îì§ (Ïä§ÌÖåÏù¥ÏßÄ3)
        const traits = getRegionTraits();
        (G.data.evoTraits || []).forEach((et, idx) => {
            const trait = traits.find(t => t.id === et.id) || getTraitById(et.id);
            if (!trait) return;
            
            // relX, relYÍ∞Ä ÏûàÏúºÎ©¥ bodySize Í∏∞Ï§Ä Ï¢åÌëú ÏÇ¨Ïö© (Ï∫êÎ¶≠ÌÑ∞ ÌÅ¨Í∏∞ Î≥ÄÌï¥ÎèÑ Ï†ïÌôï)
            let px, py;
            if (et.relX !== undefined && et.relY !== undefined) {
                px = cx + et.relX * bodySize;
                py = cy + et.relY * bodySize;
            } else {
                px = et.x * w;
                py = et.y * h;
            }
            const scale = et.scale || 1;
            const flipX = et.flipX ? -1 : 1;
            
            ectx.save();
            ectx.translate(px, py);
            ectx.rotate(et.rotation || 0);
            ectx.scale(scale * flipX, scale);
            
            ectx.font = `40px ${CONFIG.EMOJI_FONT}`;
            ectx.textAlign = 'center';
            ectx.textBaseline = 'middle';
            ectx.fillText(trait.icon, 0, 0);
            
            // ÏÑ†ÌÉùÎêú ÌååÏ∏† Í∞ïÏ°∞
            if (selectedPart === idx) {
                ectx.strokeStyle = '#00f5d4';
                ectx.lineWidth = 3 / scale;
                ectx.setLineDash([5 / scale, 5 / scale]);
                ectx.strokeRect(-28, -28, 56, 56);
                ectx.setLineDash([]);
            }
            
            ectx.restore();
        });
        
        // ÏïàÎÇ¥
        ectx.font = '11px Arial';
        ectx.fillStyle = 'rgba(255,255,255,0.4)';
        ectx.textAlign = 'center';
        ectx.fillText('ÌååÏ∏† ÌÑ∞Ïπò ‚Üí ÎìúÎûòÍ∑∏Î°ú Ïù¥Îèô / ÏÉÅÎã® Ïä¨ÎùºÏù¥ÎçîÎ°ú ÌÅ¨Í∏∞¬∑ÌöåÏ†Ñ', w / 2, h - 15);
    };
    
    const getPartAt = (x, y) => {
        const traits = G.data.evoTraits || [];
        const cx = cvs.width / 2;
        const cy = cvs.height / 2;
        const bodySize = getEditorBodySize();
        
        for (let i = traits.length - 1; i >= 0; i--) {
            const et = traits[i];
            // relX, relY Ïö∞ÏÑ† ÏÇ¨Ïö©
            let px, py;
            if (et.relX !== undefined && et.relY !== undefined) {
                px = cx + et.relX * bodySize;
                py = cy + et.relY * bodySize;
            } else {
                px = et.x * cvs.width;
                py = et.y * cvs.height;
            }
            const scale = et.scale || 1;
            if (Math.abs(x - px) < 30 * scale && Math.abs(y - py) < 30 * scale) return i;
        }
        return null;
    };
    
    const onPointerDown = e => {
        const rect = cvs.getBoundingClientRect();
        const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
        const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
        
        const idx = getPartAt(x, y);
        if (idx !== null) {
            selectedPart = idx;
            isDragging = true;
            const et = G.data.evoTraits[idx];
            const cx = cvs.width / 2;
            const cy = cvs.height / 2;
            const bodySize = getEditorBodySize();
            // relX, relY Í∏∞Ï§ÄÏúºÎ°ú Ïò§ÌîÑÏÖã Í≥ÑÏÇ∞
            let px, py;
            if (et.relX !== undefined && et.relY !== undefined) {
                px = cx + et.relX * bodySize;
                py = cy + et.relY * bodySize;
            } else {
                px = et.x * cvs.width;
                py = et.y * cvs.height;
            }
            dragOffset.x = x - px;
            dragOffset.y = y - py;
            updateSelectedInfo();
        } else {
            selectedPart = null;
            isDragging = false;
            updateSelectedInfo();
        }
    };
    
    // ÏóêÎîîÌÑ∞ bodySize Í≥ÑÏÇ∞ (Í≤åÏûÑÍ≥º ÏùºÏπòÏãúÌÇ§Í∏∞ ÏúÑÌï¥)
    const getEditorBodySize = () => {
        const baseSize = Math.min(cvs.width, cvs.height) * 0.15;
        const evoBonus = (G.data.evoTraits?.length || 0) * 0.02;
        const totalScale = (G.data.charScale || 1) + evoBonus;
        return baseSize * totalScale;
    };
    
    const onPointerMove = e => {
        if (!isDragging || selectedPart === null) return;
        const rect = cvs.getBoundingClientRect();
        const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
        const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
        
        const et = G.data.evoTraits[selectedPart];
        if (et) {
            const newX = x - dragOffset.x;
            const newY = y - dragOffset.y;
            
            // Ï∫îÎ≤ÑÏä§ ÎπÑÏú® Ï†ÄÏû• (Ìò∏ÌôòÏÑ±)
            et.x = Math.max(0.05, Math.min(0.95, newX / cvs.width));
            et.y = Math.max(0.05, Math.min(0.95, newY / cvs.height));
            
            // bodySize Í∏∞Ï§Ä ÏÉÅÎåÄÏ¢åÌëú Ï†ÄÏû• (Ï†ïÌôïÌïú ÏúÑÏπò)
            const cx = cvs.width / 2;
            const cy = cvs.height / 2;
            const bodySize = getEditorBodySize();
            et.relX = (newX - cx) / bodySize;
            et.relY = (newY - cy) / bodySize;
        }
    };
    
    const onPointerUp = () => {
        isDragging = false;
    };
    
    cvs.addEventListener('mousedown', onPointerDown);
    cvs.addEventListener('mousemove', onPointerMove);
    cvs.addEventListener('mouseup', onPointerUp);
    cvs.addEventListener('mouseleave', onPointerUp);
    cvs.addEventListener('touchstart', e => { e.preventDefault(); onPointerDown(e); }, { passive: false });
    cvs.addEventListener('touchmove', e => { e.preventDefault(); onPointerMove(e); }, { passive: false });
    cvs.addEventListener('touchend', onPointerUp);
    
    document.getElementById('btn-cancel').onclick = () => { resumeRunner(); };
    document.getElementById('btn-save').onclick = () => { 
        Audio.playClick(); 
        saveGame(); 
        resumeRunner(); 
    };
    
    const animLoop = () => {
        if (document.getElementById('editor-canvas')) {
            drawEditor();
            requestAnimationFrame(animLoop);
        }
    };
    animLoop();
};

// Î¨∏Î™Ö Î∞úÏ†Ñ Î∞∞Í≤Ω Í∑∏Î¶¨Í∏∞
// Î¨∏Î™Ö Î∞úÏ†Ñ Î∞∞Í≤Ω Í∑∏Î¶¨Í∏∞ (7Îã®Í≥Ñ)
const drawCivilizationBg = (w, h, groundY, t) => {
    const farSpeed = 0.1;
    const midSpeed = 0.2;
    const nearSpeed = 0.3;
    
    if (runnerStage === 0) {
        // üå≤ ÏõêÏãúÏùò Ïà≤
        for (let i = 0; i < 6; i++) {
            const tx = ((w + 200) - (bgOffset * farSpeed + i * 250) % (w + 200));
            ctx.fillStyle = '#0d2d0d';
            ctx.beginPath();
            ctx.moveTo(tx, groundY);
            ctx.lineTo(tx + 40, groundY - 150);
            ctx.lineTo(tx + 80, groundY);
            ctx.fill();
        }
        for (let i = 0; i < 8; i++) {
            const tx = ((w + 150) - (bgOffset * nearSpeed + i * 180) % (w + 150));
            ctx.fillStyle = '#1a4a1a';
            ctx.beginPath();
            ctx.moveTo(tx, groundY); ctx.lineTo(tx + 25, groundY - 100); ctx.lineTo(tx + 50, groundY);
            ctx.fill();
            ctx.fillStyle = '#3d2817';
            ctx.fillRect(tx + 20, groundY - 30, 10, 30);
        }
    } else if (runnerStage === 1) {
        // üî• Î∂àÏùò Î∞úÍ≤¨ (Î≤àÍ∞ú+Î∂à)
        // Î≤àÍ∞ú
        if (Math.sin(t * 2) > 0.9) {
            ctx.strokeStyle = '#ffff00';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(w * 0.7, 0);
            ctx.lineTo(w * 0.65, h * 0.3);
            ctx.lineTo(w * 0.72, h * 0.35);
            ctx.lineTo(w * 0.68, groundY - 50);
            ctx.stroke();
        }
        // ÎèôÍµ¥
        for (let i = 0; i < 2; i++) {
            const cx = ((w + 500) - (bgOffset * midSpeed + i * 600) % (w + 500));
            ctx.fillStyle = '#2a1a0a';
            ctx.beginPath(); ctx.arc(cx + 50, groundY, 60, Math.PI, 0); ctx.fill();
            ctx.fillStyle = '#0a0500';
            ctx.beginPath(); ctx.arc(cx + 50, groundY, 40, Math.PI, 0); ctx.fill();
            ctx.fillStyle = `rgba(255,100,0,${0.3 + Math.sin(t * 5) * 0.2})`;
            ctx.beginPath(); ctx.arc(cx + 50, groundY - 20, 25, 0, Math.PI * 2); ctx.fill();
        }
        // Î™®Îã•Î∂à
        for (let i = 0; i < 3; i++) {
            const fx = ((w + 300) - (bgOffset * nearSpeed + i * 350) % (w + 300));
            ctx.fillStyle = `rgba(255,${100 + Math.sin(t * 8 + i) * 50},0,0.8)`;
            ctx.beginPath();
            ctx.moveTo(fx, groundY);
            ctx.quadraticCurveTo(fx + 10, groundY - 30 - Math.sin(t * 10) * 10, fx + 20, groundY);
            ctx.fill();
            ctx.fillStyle = '#1a0a00';
            ctx.beginPath(); ctx.arc(fx + 40, groundY - 35, 8, 0, Math.PI * 2); ctx.fill();
            ctx.fillRect(fx + 36, groundY - 27, 8, 27);
        }
    } else if (runnerStage === 2) {
        // üîß ÎèÑÍµ¨Ïùò ÏãúÎåÄ
        for (let i = 0; i < 3; i++) {
            const hx = ((w + 350) - (bgOffset * midSpeed + i * 400) % (w + 350));
            ctx.fillStyle = '#4a3a2a';
            ctx.beginPath();
            ctx.moveTo(hx, groundY); ctx.lineTo(hx + 35, groundY - 50); ctx.lineTo(hx + 70, groundY);
            ctx.fill();
            ctx.fillStyle = '#1a1a1a';
            ctx.beginPath(); ctx.arc(hx + 35, groundY, 15, Math.PI, 0); ctx.fill();
        }
        for (let i = 0; i < 4; i++) {
            const px = ((w + 200) - (bgOffset * nearSpeed + i * 250) % (w + 200));
            ctx.fillStyle = '#5a4a3a';
            ctx.beginPath(); ctx.arc(px, groundY - 40, 10, 0, Math.PI * 2); ctx.fill();
            ctx.fillRect(px - 5, groundY - 30, 10, 30);
            ctx.strokeStyle = '#8a7a6a'; ctx.lineWidth = 2;
            ctx.beginPath(); ctx.moveTo(px + 8, groundY - 25); ctx.lineTo(px + 25, groundY - 40); ctx.stroke();
        }
    } else if (runnerStage === 3) {
        // üèõÔ∏è Í≥†ÎåÄ Î¨∏Î™Ö
        for (let i = 0; i < 4; i++) {
            const bx = ((w + 250) - (bgOffset * farSpeed + i * 300) % (w + 250));
            const bh = 80 + i * 20;
            ctx.fillStyle = '#2a1a0a';
            ctx.fillRect(bx, groundY - bh, 60, bh);
            ctx.fillStyle = '#3a2a1a';
            for (let j = 0; j < 3; j++) ctx.fillRect(bx + 5 + j * 20, groundY - bh, 8, bh);
            ctx.fillStyle = '#4a3a2a';
            ctx.beginPath();
            ctx.moveTo(bx - 5, groundY - bh); ctx.lineTo(bx + 30, groundY - bh - 25); ctx.lineTo(bx + 65, groundY - bh);
            ctx.fill();
        }
        for (let i = 0; i < 6; i++) {
            const px = ((w + 120) - (bgOffset * nearSpeed + i * 150) % (w + 120));
            ctx.fillStyle = '#6a5a4a';
            ctx.beginPath(); ctx.arc(px, groundY - 35, 8, 0, Math.PI * 2); ctx.fill();
            ctx.fillRect(px - 4, groundY - 27, 8, 27);
        }
    } else if (runnerStage === 4) {
        // üè≠ ÏÇ∞ÏóÖ ÌòÅÎ™Ö
        // Í≥µÏû•
        for (let i = 0; i < 3; i++) {
            const fx = ((w + 300) - (bgOffset * farSpeed + i * 350) % (w + 300));
            ctx.fillStyle = '#3a3a4a';
            ctx.fillRect(fx, groundY - 80, 80, 80);
            // Íµ¥Îöù
            ctx.fillStyle = '#2a2a3a';
            ctx.fillRect(fx + 60, groundY - 120, 15, 40);
            ctx.fillRect(fx + 10, groundY - 110, 12, 30);
            // Ïó∞Í∏∞
            for (let s = 0; s < 3; s++) {
                ctx.fillStyle = `rgba(100,100,100,${0.3 - s * 0.1})`;
                ctx.beginPath();
                ctx.arc(fx + 67 + Math.sin(t * 2 + s) * 10, groundY - 130 - s * 20, 10 + s * 5, 0, Math.PI * 2);
                ctx.fill();
            }
            // Ï∞ΩÎ¨∏
            ctx.fillStyle = '#ffaa00';
            for (let r = 0; r < 2; r++) {
                for (let c = 0; c < 3; c++) {
                    ctx.fillRect(fx + 10 + c * 22, groundY - 70 + r * 25, 15, 12);
                }
            }
        }
        // Í∏∞Ï∞®
        const trainX = ((w + 400) - (bgOffset * nearSpeed * 2) % (w + 400));
        ctx.fillStyle = '#2a2a2a';
        ctx.fillRect(trainX, groundY - 35, 60, 30);
        ctx.fillRect(trainX + 60, groundY - 25, 30, 20);
        ctx.fillStyle = '#1a1a1a';
        for (let wh = 0; wh < 4; wh++) {
            ctx.beginPath(); ctx.arc(trainX + 10 + wh * 18, groundY - 5, 8, 0, Math.PI * 2); ctx.fill();
        }
        // Ï¶ùÍ∏∞
        ctx.fillStyle = 'rgba(200,200,200,0.5)';
        ctx.beginPath(); ctx.arc(trainX + 75, groundY - 40, 8 + Math.sin(t * 5) * 3, 0, Math.PI * 2); ctx.fill();
    } else if (runnerStage === 5) {
        // üåÜ ÌòÑÎåÄ ÏÇ¨Ìöå
        // ÎπåÎî©
        for (let i = 0; i < 5; i++) {
            const bx = ((w + 200) - (bgOffset * farSpeed * 0.5 + i * 220) % (w + 200));
            const bh = 100 + (i % 3) * 30;
            ctx.fillStyle = '#2a3a4a';
            ctx.fillRect(bx, groundY - bh, 50, bh);
            // Ï∞ΩÎ¨∏
            for (let r = 0; r < Math.floor(bh / 18); r++) {
                for (let c = 0; c < 3; c++) {
                    ctx.fillStyle = Math.random() > 0.3 ? '#ffdd88' : '#1a2a3a';
                    ctx.fillRect(bx + 5 + c * 15, groundY - bh + 8 + r * 18, 10, 12);
                }
            }
        }
        // ÏûêÎèôÏ∞®
        for (let i = 0; i < 4; i++) {
            const cx = ((w + 250) - (bgOffset * nearSpeed * 1.5 + i * 280) % (w + 250));
            ctx.fillStyle = ['#cc3333', '#3333cc', '#33cc33', '#cccc33'][i % 4];
            ctx.fillRect(cx, groundY - 18, 30, 12);
            ctx.fillRect(cx + 5, groundY - 26, 20, 8);
            ctx.fillStyle = '#111';
            ctx.beginPath();
            ctx.arc(cx + 7, groundY - 5, 5, 0, Math.PI * 2);
            ctx.arc(cx + 23, groundY - 5, 5, 0, Math.PI * 2);
            ctx.fill();
        }
        // ÏÇ¨ÎûåÎì§
        for (let i = 0; i < 5; i++) {
            const px = ((w + 150) - (bgOffset * nearSpeed + i * 170) % (w + 150));
            ctx.fillStyle = '#ddd';
            ctx.beginPath(); ctx.arc(px, groundY - 35, 6, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = ['#333', '#444', '#555'][i % 3];
            ctx.fillRect(px - 4, groundY - 29, 8, 18);
            ctx.fillRect(px - 3, groundY - 11, 2, 11);
            ctx.fillRect(px + 1, groundY - 11, 2, 11);
        }
    } else if (runnerStage === 6) {
        // üõ∏ Ï¥àÏ≤®Îã® ÎØ∏Îûò
        // ÌôÄÎ°úÍ∑∏Îû® ÎπåÎî©
        for (let i = 0; i < 4; i++) {
            const bx = ((w + 250) - (bgOffset * farSpeed * 0.3 + i * 280) % (w + 250));
            const bh = 150 + (i % 2) * 50;
            // ÎπåÎî© Ïô∏Í≥Ω (ÎÑ§Ïò®)
            ctx.strokeStyle = `hsl(${(t * 30 + i * 90) % 360}, 100%, 60%)`;
            ctx.lineWidth = 2;
            ctx.strokeRect(bx, groundY - bh, 60, bh);
            // ÎÇ¥Î∂Ä ÌôÄÎ°úÍ∑∏Îû®
            ctx.fillStyle = `rgba(${100 + i * 30}, 200, 255, 0.1)`;
            ctx.fillRect(bx + 2, groundY - bh + 2, 56, bh - 4);
            // ÎÑ§Ïò® Ï∞ΩÎ¨∏
            for (let r = 0; r < 5; r++) {
                ctx.fillStyle = `hsl(${(t * 50 + r * 40 + i * 60) % 360}, 100%, 50%)`;
                ctx.fillRect(bx + 10, groundY - bh + 20 + r * 28, 40, 3);
            }
        }
        // UFO / ÎπÑÌñâÏ≤¥
        for (let i = 0; i < 2; i++) {
            const ux = ((w + 350) - (bgOffset * midSpeed * 0.8 + i * 400) % (w + 350));
            const uy = 50 + Math.sin(t * 2 + i) * 30;
            ctx.fillStyle = '#6666aa';
            ctx.beginPath();
            ctx.ellipse(ux, uy, 25, 8, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#aaaaff';
            ctx.beginPath();
            ctx.ellipse(ux, uy - 5, 12, 6, 0, Math.PI, 0);
            ctx.fill();
            // Îπî
            ctx.fillStyle = `rgba(100, 200, 255, ${0.2 + Math.sin(t * 5) * 0.1})`;
            ctx.beginPath();
            ctx.moveTo(ux - 15, uy + 8);
            ctx.lineTo(ux + 15, uy + 8);
            ctx.lineTo(ux + 25, groundY);
            ctx.lineTo(ux - 25, groundY);
            ctx.fill();
        }
        // Î°úÎ¥á/ÏïàÎìúÎ°úÏù¥Îìú
        for (let i = 0; i < 3; i++) {
            const rx = ((w + 180) - (bgOffset * nearSpeed + i * 200) % (w + 180));
            // Î®∏Î¶¨ (LED)
            ctx.fillStyle = '#666';
            ctx.fillRect(rx - 6, groundY - 42, 12, 12);
            ctx.fillStyle = `hsl(${(t * 100 + i * 120) % 360}, 100%, 50%)`;
            ctx.fillRect(rx - 4, groundY - 40, 3, 3);
            ctx.fillRect(rx + 1, groundY - 40, 3, 3);
            // Î™∏
            ctx.fillStyle = '#555';
            ctx.fillRect(rx - 7, groundY - 30, 14, 20);
            // Îã§Î¶¨
            ctx.fillStyle = '#444';
            ctx.fillRect(rx - 5, groundY - 10, 4, 10);
            ctx.fillRect(rx + 1, groundY - 10, 4, 10);
        }
        // Ìè¨ÌÉà
        const portalX = ((w + 500) - (bgOffset * midSpeed + 250) % (w + 500));
        ctx.strokeStyle = `hsl(${t * 60 % 360}, 100%, 60%)`;
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.ellipse(portalX, groundY - 50, 30 + Math.sin(t * 3) * 5, 50 + Math.sin(t * 3) * 8, 0, 0, Math.PI * 2);
        ctx.stroke();
        ctx.fillStyle = `rgba(100, 50, 200, 0.3)`;
        ctx.beginPath();
        ctx.ellipse(portalX, groundY - 50, 25, 45, 0, 0, Math.PI * 2);
        ctx.fill();
    }
};


const renderRunner = (stage, groundY) => {
    const w = canvas.width, h = canvas.height, t = Date.now() * 0.001;
    
    // Î∞∞Í≤Ω
    const bg = ctx.createLinearGradient(0, 0, 0, h);
    bg.addColorStop(0, stage.bgColors[0]);
    bg.addColorStop(1, stage.bgColors[1]);
    ctx.fillStyle = bg;
    ctx.fillRect(0, 0, w, h);
    
    // Î∞∞Í≤Ω Ïû•Ïãù (Ïä§ÌÖåÏù¥ÏßÄÎ≥Ñ Î¨∏Î™Ö Î∞úÏ†Ñ)
    drawCivilizationBg(w, h, groundY, t);
    
    // ÎïÖ
    ctx.fillStyle = stage.groundColor;
    ctx.fillRect(0, groundY, w, h - groundY);
    
    ctx.strokeStyle = 'rgba(255,255,255,0.2)';
    ctx.lineWidth = 2;
    ctx.setLineDash([20, 15]);
    ctx.lineDashOffset = -bgOffset;
    ctx.beginPath();
    ctx.moveTo(0, groundY + 10);
    ctx.lineTo(w, groundY + 10);
    ctx.stroke();
    ctx.setLineDash([]);
    
    // Ïû•Ïï†Î¨º
    obstacles.forEach(o => {
        ctx.font = `${o.h}px ${CONFIG.EMOJI_FONT}`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'bottom';
        ctx.fillText(o.type, o.x + o.w / 2, o.y + o.h);
    });
    
    // ÏïÑÏù¥ÌÖú
    items.forEach(item => {
        if (item.collected) return;
        const itemData = RUNNER_ITEMS[item.type];
        ctx.save();
        ctx.translate(item.x, item.y + Math.sin(t * 5) * 5);
        if (item.type === 'dice') ctx.rotate(t * 2);
        ctx.font = `32px ${CONFIG.EMOJI_FONT}`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(itemData.icon, 0, 0);
        
        // Ï£ºÏÇ¨ÏúÑÎäî ÌäπÎ≥ÑÌûà Î∞òÏßùÏûÑ
        if (item.type === 'dice') {
            ctx.strokeStyle = 'rgba(254,228,64,0.6)';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(0, 0, 25 + Math.sin(t * 8) * 3, 0, Math.PI * 2);
            ctx.stroke();
        }
        ctx.restore();
    });
    
    // ÌååÌã∞ÌÅ¥
    runnerParticles.forEach(p => {
        ctx.globalAlpha = p.life / 20;
        ctx.fillStyle = p.color;
        ctx.beginPath();
        ctx.arc(p.x, p.y, 4, 0, Math.PI * 2);
        ctx.fill();
    });
    ctx.globalAlpha = 1;
    
    // Ï∫êÎ¶≠ÌÑ∞
    drawRunnerChar(groundY);
    
    // Î¨¥Ï†Å Ìö®Í≥º
    if (activeEffects.shield) {
        ctx.strokeStyle = 'rgba(0,245,212,0.5)';
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.arc(runner.x + runner.w / 2, runner.y + runner.h / 2, runner.w * 0.8, 0, Math.PI * 2);
        ctx.stroke();
    }
};

const drawRunnerChar = groundY => {
    const d = G.data.design, t = Date.now() * 0.01;
    const evoTraits = G.data.evoTraits || [];
    const charScale = G.data.charScale || 1;
    const evoBonus = evoTraits.length * 0.02;
    const totalScale = charScale + evoBonus;
    
    // Ï∂ïÏÜå Ìö®Í≥º
    const shrinkMod = activeEffects.shrink ? 0.5 : 1;
    
    ctx.save();
    ctx.translate(runner.x + runner.w / 2, runner.y + runner.h / 2);
    ctx.scale(shrinkMod, shrinkMod);
    
    const legPhase = Math.sin(t * 2) * 0.4;
    const bodyW = runner.baseW / 2 * totalScale;
    const bodyH = runner.baseH / 2 * totalScale;
    
    // Í∏∞Î≥∏ Îã§Î¶¨
    const legCnt = G.data.parts?.leg || 0;
    ctx.strokeStyle = d.secondary;
    ctx.lineWidth = 5;
    ctx.lineCap = 'round';
    
    // ÏµúÏÜå 2Í∞ú Îã§Î¶¨Îäî Í∏∞Î≥∏ÏúºÎ°ú
    for (let i = 0; i < Math.max(2, legCnt); i++) {
        const baseX = (i % 2 === 0 ? -1 : 1) * bodyW * 0.4;
        const phase = i % 2 === 0 ? legPhase : -legPhase;
        ctx.beginPath();
        ctx.moveTo(baseX, bodyH * 0.6);
        ctx.lineTo(baseX + Math.sin(phase) * 15, bodyH + 10);
        ctx.stroke();
    }
    
    // Íº¨Î¶¨
    if (G.data.parts?.tail > 0) {
        ctx.strokeStyle = d.primary;
        ctx.lineWidth = 4;
        const tailWave = Math.sin(t * 3) * bodyW * 0.3;
        ctx.beginPath();
        ctx.moveTo(-bodyW * 0.8, 0);
        ctx.bezierCurveTo(-bodyW * 1.2, tailWave, -bodyW * 1.4, -tailWave * 0.5, -bodyW * 1.8, tailWave * 0.3);
        ctx.stroke();
    }
    
    // Ìåî
    if (G.data.parts?.arm > 0) {
        ctx.strokeStyle = d.primary;
        ctx.lineWidth = 4;
        for (let i = 0; i < Math.min(G.data.parts.arm, 4); i++) {
            const side = i % 2 === 0 ? 1 : -1;
            const wave = Math.sin(t * 2 + i) * 0.2;
            ctx.beginPath();
            ctx.moveTo(side * bodyW * 0.7, -bodyH * 0.2);
            ctx.quadraticCurveTo(side * bodyW * 1.2, wave * bodyH, side * bodyW * 1.4, bodyH * 0.2);
            ctx.stroke();
        }
    }
    
    // Î™∏ÌÜµ
    ctx.shadowColor = d.primary;
    ctx.shadowBlur = 15;
    
    ctx.beginPath();
    for (let i = 0; i < 10; i++) {
        const ang = (i / 10) * Math.PI * 2;
        const wobble = Math.sin(t * 0.5 + i) * 3;
        const rx = bodyW + wobble;
        const ry = bodyH + wobble * 0.5;
        i === 0 ? ctx.moveTo(Math.cos(ang) * rx, Math.sin(ang) * ry) : ctx.lineTo(Math.cos(ang) * rx, Math.sin(ang) * ry);
    }
    ctx.closePath();
    
    const grad = ctx.createRadialGradient(-bodyW * 0.2, -bodyH * 0.2, 0, 0, 0, Math.max(bodyW, bodyH));
    grad.addColorStop(0, d.primary);
    grad.addColorStop(1, d.secondary);
    ctx.fillStyle = grad;
    ctx.fill();
    ctx.shadowBlur = 0;
    
    // Í∑Ä
    if (G.data.parts?.ear > 0) {
        for (let i = 0; i < Math.min(G.data.parts.ear, 2); i++) {
            const side = i === 0 ? 1 : -1;
            ctx.beginPath();
            ctx.ellipse(side * bodyW * 0.7, -bodyH * 0.5, bodyW * 0.12, bodyH * 0.2, side * 0.3, 0, Math.PI * 2);
            ctx.fillStyle = d.primary;
            ctx.fill();
        }
    }
    
    // Í∏∞Î≥∏ Îàà
    const eyeCnt = Math.max(1, G.data.parts?.eye || 1);
    for (let i = 0; i < eyeCnt; i++) {
        const ex = (i - (eyeCnt - 1) / 2) * bodyW * 0.5;
        const ey = -bodyH * 0.2;
        ctx.beginPath();
        ctx.arc(ex, ey, bodyW * 0.2, 0, Math.PI * 2);
        ctx.fillStyle = 'white';
        ctx.fill();
        ctx.beginPath();
        ctx.arc(ex + bodyW * 0.04, ey, bodyW * 0.1, 0, Math.PI * 2);
        ctx.fillStyle = '#222';
        ctx.fill();
    }
    
    // ÏΩî
    if (G.data.parts?.nose > 0) {
        ctx.fillStyle = '#ffcc99';
        ctx.beginPath();
        ctx.moveTo(0, bodyH * 0.05);
        ctx.lineTo(-bodyW * 0.08, bodyH * 0.2);
        ctx.lineTo(bodyW * 0.08, bodyH * 0.2);
        ctx.closePath();
        ctx.fill();
    }
    
    // ÏûÖ
    if (G.data.parts?.mouth > 0) {
        ctx.strokeStyle = d.secondary;
        ctx.lineWidth = 2.5;
        ctx.lineCap = 'round';
        ctx.beginPath();
        ctx.arc(0, bodyH * 0.3, bodyW * 0.12, 0.2, Math.PI - 0.2);
        ctx.stroke();
    }
    
    // ÎçîÎì¨Ïù¥
    if (G.data.parts?.antenna > 0) {
        ctx.strokeStyle = d.primary;
        ctx.lineWidth = 2;
        for (let i = 0; i < Math.min(G.data.parts.antenna, 2); i++) {
            const side = i === 0 ? 1 : -1;
            const wave = Math.sin(t * 3) * 0.1;
            ctx.beginPath();
            ctx.moveTo(side * bodyW * 0.3, -bodyH * 0.9);
            ctx.quadraticCurveTo(side * bodyW * 0.5, -bodyH * 1.3, side * bodyW * 0.6, -bodyH * 1.2);
            ctx.stroke();
            ctx.beginPath();
            ctx.arc(side * bodyW * 0.6, -bodyH * 1.2, 4, 0, Math.PI * 2);
            ctx.fillStyle = d.primary;
            ctx.fill();
        }
    }
    
    // ÏßÑÌôî ÌååÏ∏†Îì§ (Ïä§ÌÖåÏù¥ÏßÄ3)
    const traits = getRegionTraits();
    
    evoTraits.forEach(et => {
        const trait = traits.find(t => t.id === et.id) || getTraitById(et.id);
        if (!trait) return;
        
        // relX, relYÍ∞Ä ÏûàÏúºÎ©¥ bodySize Í∏∞Ï§Ä ÏÉÅÎåÄÏ¢åÌëú ÏÇ¨Ïö© (Ï†ïÌôïÌï®)
        // ÏóÜÏúºÎ©¥ Í∏∞Ï°¥ Ï∫îÎ≤ÑÏä§ ÎπÑÏú® Î∞©Ïãù ÏÇ¨Ïö© (Ìò∏ÌôòÏÑ±)
        let px, py;
        if (et.relX !== undefined && et.relY !== undefined) {
            px = et.relX * bodyW;
            py = et.relY * bodyH;
        } else {
            // Í∏∞Ï°¥ Î∞©Ïãù (Ìò∏ÌôòÏÑ±)
            const editorBodyRatio = 0.15;
            px = (et.x - 0.5) / (editorBodyRatio * totalScale) * bodyW;
            py = (et.y - 0.5) / (editorBodyRatio * totalScale) * bodyH;
        }
        
        const scale = et.scale || 1;
        const flipX = et.flipX ? -1 : 1;
        
        ctx.save();
        ctx.translate(px, py);
        ctx.rotate(et.rotation || 0);
        ctx.scale(scale * flipX, scale);
        
        ctx.font = `24px ${CONFIG.EMOJI_FONT}`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(trait.icon, 0, 0);
        
        ctx.restore();
    });
    
    ctx.restore();
};

const runnerFail = () => {
    cancelAnimationFrame(gameLoop);
    gameLoop = null;
    Audio.playDeath();
    
    const currentDist = Math.floor(runnerDist);
    const traits = G.data.evoTraits || [];
    
    // ÌååÏ∏†Í∞Ä ÏûàÏúºÎ©¥ ÌïòÎÇò Ï†úÍ±∞ ÏÑ†ÌÉù
    if (traits.length > 0) {
        let traitList = '';
        traits.forEach((et, idx) => {
            const trait = getTraitById(et.id);
            if (trait) {
                traitList += `<button class="trait-remove-btn" data-idx="${idx}" style="display:flex;align-items:center;gap:8px;padding:10px;margin:5px 0;width:100%;background:rgba(255,100,100,0.2);border:1px solid var(--danger);border-radius:8px;cursor:pointer;">
                    <span style="font-size:1.5rem;">${trait.icon}</span>
                    <div style="text-align:left;flex:1;">
                        <div style="font-weight:700;color:var(--text-primary);">${trait.name}</div>
                        <div style="font-size:0.7rem;color:var(--neon-yellow);">${trait.effect}</div>
                    </div>
                    <span style="color:var(--danger);">‚ùå</span>
                </button>`;
            }
        });
        
        app.innerHTML = `
            <div class="modal"><div class="modal-box" style="max-height:80vh;overflow-y:auto;">
                <div class="modal-icon">üí•</div>
                <h1 class="modal-title fail">Ï∂©Îèå!</h1>
                <p class="modal-desc">ÌååÏ∏† ÌïòÎÇòÎ•º ÏûÉÏäµÎãàÎã§.<br><span style="color:var(--danger);">Ï†úÍ±∞Ìï† ÌååÏ∏†Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî:</span></p>
                <div style="margin:15px 0;">${traitList}</div>
                <div class="modal-stats">
                    <div class="stat-row"><span class="stat-label">ÏßÑÌñâ Í±∞Î¶¨</span><span class="stat-val">${currentDist}m ‚Üí 0m</span></div>
                </div>
            </div></div>
        `;
        
        document.querySelectorAll('.trait-remove-btn').forEach(btn => {
            btn.onclick = () => {
                const idx = parseInt(btn.dataset.idx);
                const removed = G.data.evoTraits.splice(idx, 1)[0];
                const trait = getTraitById(removed.id);
                G.data.runnerDist = 0;
                saveGame();
                Audio.playClick();
                
                app.innerHTML = `
                    <div class="modal"><div class="modal-box">
                        <div class="modal-icon">üò¢</div>
                        <h1 class="modal-title" style="color:var(--danger);">ÌååÏ∏† ÏÉÅÏã§</h1>
                        <p class="modal-desc"><span style="font-size:2rem;">${trait?.icon || '?'}</span><br>${trait?.name || 'Ïïå Ïàò ÏóÜÏùå'}ÏùÑ(Î•º) ÏûÉÏóàÏäµÎãàÎã§.</p>
                        <div style="display:flex;flex-direction:column;gap:10px;margin-top:15px;">
                            <button class="btn btn-energy btn-block" id="btn-retry">üîÑ Îã§Ïãú ÎèÑÏ†Ñ</button>
                            <button class="btn btn-outline btn-block" id="btn-home">üè† Ìôà</button>
                        </div>
                    </div></div>
                `;
                document.getElementById('btn-retry').onclick = () => { Audio.playClick(); startRunner(); };
                document.getElementById('btn-home').onclick = () => { Audio.playClick(); renderSaves(); };
            };
        });
    } else {
        G.data.runnerDist = 0;
        saveGame();
        
        app.innerHTML = `
            <div class="modal"><div class="modal-box">
                <div class="modal-icon">üí•</div>
                <h1 class="modal-title fail">Ï∂©Îèå!</h1>
                <p class="modal-desc">Ïû•Ïï†Î¨ºÏóê Î∂ÄÎî™ÌòîÏäµÎãàÎã§.<br><span style="color:var(--neon-yellow);">Í±∞Î¶¨Í∞Ä Ï¥àÍ∏∞ÌôîÎê©ÎãàÎã§!</span></p>
                <div class="modal-stats">
                    <div class="stat-row"><span class="stat-label">ÏßÑÌñâ Í±∞Î¶¨</span><span class="stat-val">${currentDist}m ‚Üí 0m</span></div>
                </div>
                <div style="display:flex;flex-direction:column;gap:10px;">
                    <button class="btn btn-energy btn-block" id="btn-retry">üîÑ Îã§Ïãú</button>
                    <button class="btn btn-outline btn-block" id="btn-home">üè† Ìôà</button>
                </div>
            </div></div>
        `;
        
        document.getElementById('btn-retry').onclick = () => { Audio.playClick(); startRunner(); };
        document.getElementById('btn-home').onclick = () => { Audio.playClick(); renderSaves(); };
    }
};

const runnerStageComplete = () => {
    cancelAnimationFrame(gameLoop);
    gameLoop = null;
    Audio.playEvolve();
    
    const stage = RUNNER_STAGES[runnerStage];
    const isLast = runnerStage >= RUNNER_STAGES.length - 1;
    
    if (!isLast) {
        G.data.runnerStage = runnerStage + 1;
        G.data.runnerDist = 0; // Îã§Ïùå Ïä§ÌÖåÏù¥ÏßÄÎäî 0Î∂ÄÌÑ∞
        saveGame();
        showEvo('üß¨', 'Ïä§ÌÖåÏù¥ÏßÄ ÌÅ¥Î¶¨Ïñ¥!', `${stage.name} ÏôÑÎ£å!`, `${runnerStage + 2}Îã®Í≥ÑÎ°ú...`);
        setTimeout(() => startRunner(), 2500);
    } else {
        // ÎßàÏßÄÎßâ Ïä§ÌÖåÏù¥ÏßÄ ÌÅ¥Î¶¨Ïñ¥ - ÏóîÎî© Ïä§ÌÜ†Î¶¨Î°ú
        saveGame();
        showEvo('üéâ', 'Î¨∏Î™Ö ÏôÑÏÑ±!', 'Î™®Îì† ÏßÑÌôîÎ•º ÎßàÏ≥§ÏäµÎãàÎã§!', '');
        setTimeout(() => renderStory('ending'), 2500);
    }
};
// ========================================
// BOKLUCK Universe - Main Entry Point
// ========================================

// Ïä§ÌÜ†Î¶¨ Îç∞Ïù¥ÌÑ∞
const STORIES = {
    intro: [
        { icon: 'üåå', title: 'ÌÉúÏ¥àÏóê...', text: 'ÎÅùÏóÜÏù¥ ÌéºÏ≥êÏßÑ <span class="hl">Ïö∞Ï£ºÏùò Ïã¨Ïó∞</span>...<br>ÏïÑÏ£º ÏûëÏùÄ <span class="gold">Î∂àÍΩÉ</span>Ïù¥ ÌîºÏñ¥Ïò§Î•¥Î†§ ÌïúÎã§.' },
        { icon: '‚ú®', title: 'ÏùòÏãùÏùò ÌÉÑÏÉù', text: 'ÎãπÏã†ÏùÄ ÏïÑÏßÅ <span class="hl">ÏïÑÎ¨¥Í≤ÉÎèÑ ÏïÑÎãàÎã§</span>.<br>Ïò§ÏßÅ <span class="gold">Ï°¥Ïû¨ÌïòÍ≥†Ïûê ÌïòÎäî ÏùòÏßÄ</span>ÎßåÏù¥ ÍπúÎπ°Ïù∏Îã§.' },
        { icon: 'üé≤', title: 'Ïö¥Î™ÖÏùò Ï£ºÏÇ¨ÏúÑ', text: '<span class="hl">BOK(Î≥µ)</span>Í≥º <span class="danger">LUCK(Ïö¥)</span>Ïù¥ Î™®Îì† Í≤ÉÏùÑ Í≤∞Ï†ïÌïúÎã§.<br>ÎãπÏã†Ïùò Ïö¥Î™ÖÏùÄ <span class="gold">Ï£ºÏÇ¨ÏúÑ</span>Ïóê Îã¨Î†∏Îã§.' }
    ],
    afterBirth: env => [
        { icon: env.icon, title: env.name, text: `<span class="hl">${env.name}</span>ÏóêÏÑú ÌÉúÏñ¥ÎÇ¨Îã§.<br><span class="gold">"${env.desc}"</span><br><span class="danger">‚ö†Ô∏è ${env.weak}</span>` },
        { icon: 'ü¶†', title: 'Ï≤´ Î≤àÏß∏ ÏÉùÎ™Ö', text: 'ÏïÑÏ£º ÏûëÏùÄ <span class="hl">ÌïòÎÇòÏùò ÏÑ∏Ìè¨</span>.<br>ÏÇ¥ÏïÑÎÇ®ÏúºÎ†§Î©¥ <span class="gold">Î®πÏñ¥Ïïº ÌïúÎã§</span>.' },
        { icon: '‚öîÔ∏è', title: 'Í≤ΩÏüÅÍ≥º ÏÉùÏ°¥', text: '<span class="danger">Îçî ÌÅ∞ Ï°¥Ïû¨</span>Îì§Ïù¥ ÎãπÏã†ÏùÑ ÎÖ∏Î¶∞Îã§.<br><span class="hl">ÏûëÏùÄ Í≤É</span>ÏùÑ Î®πÍ≥† <span class="gold">Ïª§Ï†∏Ïïº</span> ÏÇ¥ÏïÑÎÇ®ÎäîÎã§.' }
    ],
    multi: [
        { icon: 'üß¨', title: 'Îã§ÏÑ∏Ìè¨ ÏßÑÌôî!', text: 'ÎßàÏπ®ÎÇ¥ <span class="hl">Îã®Ïùº ÏÑ∏Ìè¨</span>Ïùò ÌïúÍ≥ÑÎ•º ÎÑòÏñ¥ÏÑ∞Îã§!' },
        { icon: 'üèîÔ∏è', title: 'ÏÉàÎ°úÏö¥ ÎèÑÏ†Ñ', text: 'Î∞îÎã§ ÍπäÏùÄ Í≥≥ÏóêÏÑú <span class="gold">Ïú°ÏßÄ</span>ÍπåÏßÄ Ïò¨ÎùºÍ∞ÄÏïº ÌïúÎã§.' },
        { icon: '‚¨ÜÔ∏è', title: 'Ï†êÌîÑ!', text: '<span class="hl">Î∞úÌåê</span>ÏùÑ Î∞üÍ≥† ÏúÑÎ°ú!<br>üé≤ Ï£ºÏÇ¨ÏúÑÎ°ú ÏïÑÏù¥ÌÖúÏùÑ ÏñªÏûê!' }
    ],
    runner: [
        { icon: 'üèÉ', title: 'Ïú°ÏßÄ ÎèÑÏ∞©!', text: 'ÎßàÏπ®ÎÇ¥ <span class="hl">Ïú°ÏßÄ</span>Ïóê ÎèÑÏ∞©ÌñàÎã§!' },
        { icon: 'üé≤', title: 'ÏßÑÌôîÏùò Ï£ºÏÇ¨ÏúÑ', text: 'Îã¨Î¶¨Î©¥ÏÑú <span class="gold">üé≤ Ï£ºÏÇ¨ÏúÑ</span>Î•º Î™®ÏïÑÎùº!<br>51 Ïù¥ÏÉÅÏù¥Î©¥ <span class="hl">ÏÉàÎ°úÏö¥ ÌäπÏÑ±</span>ÏùÑ ÏñªÎäîÎã§!' },
        { icon: '‚úã', title: 'Ïª§Ïä§ÌÑ∞ÎßàÏù¥Ï¶à', text: 'ÌöçÎìùÌïú ÌååÏ∏†Îäî <span class="gold">ÎìúÎûòÍ∑∏</span>Ìï¥ÏÑú<br>ÏõêÌïòÎäî ÏúÑÏπòÏóê Î∞∞ÏπòÌï† Ïàò ÏûàÎã§!' }
    ],
    ending: [
        { icon: 'üõ∏', title: 'Ï¥àÏ≤®Îã® Î¨∏Î™Ö Îã¨ÏÑ±!', text: 'ÎãπÏã†ÏùÄ <span class="hl">ÌïòÎÇòÏùò ÏÑ∏Ìè¨</span>ÏóêÏÑú ÏãúÏûëÌï¥<br><span class="gold">Î≥ÑÏùÑ ÎÑòÎÇòÎìúÎäî Î¨∏Î™Ö</span>ÏùÑ Ïù¥Î£©ÌñàÎã§.' },
        { icon: 'üìñ', title: 'ÌîÑÎ°§Î°úÍ∑∏Ïùò ÎÅù', text: 'ÌïòÏßÄÎßå ÏßÄÍ∏àÍπåÏßÄÏùò Ïó¨Ï†ïÏùÄ...<br><span class="hl">ÏßÑÏßú ÏãúÏûëÏùÑ ÏúÑÌïú Ïù¥ÏïºÍ∏∞</span>Ïóê Î∂àÍ≥ºÌñàÎã§.' },
        { icon: 'üöÄ', title: 'Ïö∞Ï£ºÏÑ† ÌÉëÏäπ', text: 'Ïù¥Ï†ú <span class="gold">Ïö∞Ï£ºÏÑ†</span>ÏùÑ ÌÉÄÍ≥†<br>Í¥ëÌôúÌïú Ïö∞Ï£ºÎ°ú ÎÇòÏïÑÍ∞à ÏãúÍ∞Ñ.' },
        { icon: '‚ú®', title: 'ÎãπÏã†Ïùò Ïù¥ÏïºÍ∏∞', text: 'ÏïûÏúºÎ°úÏùò Ïó¨ÌñâÏùÄ<br><span class="hl">Ïó¨Îü¨Î∂ÑÏù¥ ÏßÅÏ†ë</span> ÎßåÎì§Ïñ¥ ÎÇòÍ∞ëÎãàÎã§.' },
        { icon: 'üåå', title: 'BOKLUCK Universe', text: '<span class="gold">Ïö¥</span>Í≥º <span class="hl">Î≥µ</span>Ïù¥ Ìï®ÍªòÌïòÎäî<br>ÎãπÏã†ÎßåÏùò Ïö∞Ï£º Ïù¥ÏïºÍ∏∞Í∞Ä ÏãúÏûëÎê©ÎãàÎã§.' }
    ]
};

const renderStory = (id, done = null) => {
    let seq = STORIES[id];
    if (typeof seq === 'function') seq = seq(envById(G.data?.dna?.origin));
    let idx = 0;
    
    const render = () => {
        const s = seq[idx], last = idx === seq.length - 1;
        let btnText = 'Îã§Ïùå ‚Üí';
        if (last) {
            if (id === 'multi') btnText = 'üé≤ ÏïÑÏù¥ÌÖú Ï£ºÏÇ¨ÏúÑ!';
            else if (id === 'runner') btnText = 'üèÉ Îã¨Î¶¨Í∏∞!';
            else if (id === 'ending') btnText = 'üöÄ Ïö∞Ï£ºÎ°ú Ï∂úÎ∞ú!';
            else btnText = 'ÏãúÏûëÌïòÍ∏∞ ‚Üí';
        }
        
        app.innerHTML = `
            <div class="page-center"><div class="page-content">
                <div class="page-icon">${s.icon}</div>
                <h2 class="page-title">${s.title}</h2>
                <div class="page-text">${s.text}</div>
                <div class="dots">${seq.map((_, i) => `<div class="dot ${i < idx ? 'done' : ''} ${i === idx ? 'active' : ''}"></div>`).join('')}</div>
                <button class="btn btn-energy" id="btn-next">${btnText}</button>
            </div></div>
        `;
        
        document.getElementById('btn-next').onclick = () => {
            Audio.playClick();
            if (last) {
                if (done) done();
                else if (id === 'intro') renderDice();
                else if (id === 'afterBirth') { G.data.tutDone = true; saveGame(); startCellWorld(); }
                else if (id === 'multi') showClimbDice(); // Ïä§ÌÖåÏù¥ÏßÄ2 Ï£ºÏÇ¨ÏúÑ
                else if (id === 'runner') startRunner();
                else if (id === 'ending') { G.data.stage = 4; G.data.endingCleared = true; saveGame(); renderSpaceHub(); }
            } else {
                idx++;
                render();
            }
        };
    };
    render();
};

// Ï∂úÏÉùÏßÄ Ï£ºÏÇ¨ÏúÑ
const renderDice = () => {
    let rolling = false;
    
    app.innerHTML = `
        <div class="page-center"><div class="page-content">
            <h2 class="page-title">üé≤ Ïö¥Î™ÖÏùò Ï£ºÏÇ¨ÏúÑ</h2>
            <p style="color:var(--text-secondary);margin-bottom:16px;">ÌÉúÏñ¥ÎÇ† Í≥≥Ïù¥ Í≤∞Ï†ïÎê©ÎãàÎã§</p>
            <div class="dice-box" id="dice">üé≤</div>
            <div id="result"></div>
            <button class="btn btn-energy btn-block" id="btn-roll">Ïö¥Î™ÖÏùÑ Î∞õÏïÑÎì§Ïù∏Îã§</button>
        </div></div>
    `;
    
    const dice = document.getElementById('dice');
    const result = document.getElementById('result');
    const btn = document.getElementById('btn-roll');
    
    btn.onclick = () => {
        if (rolling) return;
        rolling = true;
        btn.disabled = true;
        btn.textContent = 'Í≤∞Ï†ï Ï§ë...';
        dice.classList.add('rolling');
        Audio.playDice();
        
        const anim = setInterval(() => { dice.textContent = Math.floor(Math.random() * 100) + 1; }, 50);
        
        setTimeout(() => {
            clearInterval(anim);
            dice.classList.remove('rolling');
            const roll = Math.floor(Math.random() * 100) + 1;
            const env = envByRoll(roll);
            
            dice.textContent = roll;
            dice.style.cssText = 'font-size:3rem;font-family:Orbitron;font-weight:900;color:var(--neon-cyan);text-shadow:0 0 25px var(--neon-cyan);';
            Audio.playResult();
            
            result.innerHTML = `
                <div style="text-align:center;margin:16px 0;">
                    <div style="font-size:3rem;margin-bottom:6px;">${env.icon}</div>
                    <div style="font-family:Orbitron;font-size:1.2rem;font-weight:700;margin-bottom:4px;">${env.name}</div>
                    <div style="color:var(--text-secondary);font-size:0.85rem;">${env.desc}</div>
                </div>
            `;
            
            btn.disabled = false;
            btn.textContent = 'Ïù¥ Ïö¥Î™ÖÏùÑ Î∞õÏïÑÎì§Ïù∏Îã§';
            btn.onclick = () => {
                Audio.playClick();
                G.data.dna.origin = env.id;
                G.data.stage = 1;
                G.data.score = 0;
                G.data.name = genName(env.id);
                G.data.design = genDesign(env.id);
                G.data.parts = { eye: 0, mouth: 0, arm: 0, leg: 0, tail: 0, ear: 0, nose: 0, antenna: 0 };
                G.data.stats = { size: CONFIG.INITIAL_SIZE, speed: 3, eaten: 0, deaths: G.data.stats?.deaths || 0, maxSize: CONFIG.INITIAL_SIZE, maxH: 0 };
                G.data.evoTraits = [];
                G.data.climbItem = null;
                saveGame();
                renderStory('afterBirth');
            };
        }, 1500);
    };
};

// ÌÉÄÏù¥ÌãÄ ÌôîÎ©¥
const renderTitle = () => {
    app.innerHTML = `
        <div class="page-center"><div class="page-content">
            <div class="page-icon">üé≤</div>
            <h1 style="font-family:Orbitron;font-size:clamp(2rem,8vw,3rem);font-weight:900;background:var(--gradient-energy);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:4px;">BOKLUCK</h1>
            <h2 style="font-family:Orbitron;font-size:1rem;color:var(--text-secondary);margin-bottom:24px;">Universe</h2>
            <p style="font-size:0.85rem;color:var(--text-muted);line-height:1.7;max-width:260px;margin:0 auto 32px;">
                <strong style="color:var(--neon-cyan)">BOK(Î≥µ)</strong> ÎòêÎäî <strong style="color:var(--neon-pink)">LUCK(Ïö¥)</strong>ÏúºÎ°ú<br>ÎßåÎì§Ïñ¥Í∞ÄÎäî ÎãπÏã†ÎßåÏùò Ïö∞Ï£º
            </p>
            <div style="display:flex;flex-direction:column;gap:10px;max-width:240px;margin:0 auto;">
                <button class="btn btn-energy btn-block" id="btn-start">üöÄ Í≤åÏûÑ ÏãúÏûë</button>
                <button class="btn btn-outline btn-block" id="btn-settings">‚öôÔ∏è ÏÑ§Ï†ï</button>
            </div>
        </div></div>
    `;
    
    document.getElementById('btn-start').onclick = () => { Audio.init(); Audio.playClick(); renderSaves(); };
    document.getElementById('btn-settings').onclick = () => { Audio.init(); Audio.playClick(); renderSettings(); };
};

// ÏÑ∏Ïù¥Î∏å Ïä¨Î°Ø
const renderSaves = () => {
    const slots = Save.all();
    let html = '';
    
    for (let i = 0; i < Save.MAX; i++) {
        const s = slots[i];
        if (s) {
            const stageNames = ['ÏãúÏûëÏ†Ñ', 'ÏÑ∏Ìè¨', 'Îã§ÏÑ∏Ìè¨', 'Ïú°ÏßÄ', 'Î¨∏Î™Ö'];
            const st = stageNames[s.stage] || 'ÏãúÏûëÏ†Ñ';
            html += `
                <div class="slot">
                    <div class="slot-head">
                        <span class="slot-num">Ïä¨Î°Ø ${i + 1}</span>
                        <span style="font-size:0.6rem;color:var(--text-muted)">${Save.fmt(s.updated)}</span>
                    </div>
                    <div class="slot-name">${s.name || 'Ïù¥Î¶ÑÏóÜÏùå'}</div>
                    <div class="slot-info">${s.dna?.origin ? envById(s.dna.origin)?.icon : '‚ùì'} ${st} ¬∑ Ï†êÏàò: ${s.score || 0} ¬∑ ÌäπÏÑ±: ${s.evoTraits?.length || 0}Í∞ú</div>
                    <div class="slot-actions">
                        <button class="btn btn-energy btn-sm" style="flex:1" onclick="handleLoad(${i})">‚ñ∂Ô∏è Í≥ÑÏÜç</button>
                        <button class="btn btn-ghost btn-sm" onclick="showStageSelect(${i})">üìç</button>
                        <button class="del-btn" onclick="handleDel(${i})">üóëÔ∏è</button>
                    </div>
                </div>
            `;
        } else {
            html += `<div class="slot empty" onclick="handleNew(${i})"><span style="font-size:1.6rem;opacity:0.5">‚ûï</span><p style="color:var(--text-muted);margin-top:6px;font-size:0.8rem;">Ïä¨Î°Ø ${i + 1} - ÏÉà Í≤åÏûÑ</p></div>`;
        }
    }
    
    app.innerHTML = `
        <div class="save-page">
            <div class="save-header">
                <button class="btn btn-ghost btn-sm" id="btn-back">‚Üê Îí§Î°ú</button>
                <h1 class="save-title">üíæ Ï†ÄÏû• Ïä¨Î°Ø</h1>
                <div style="width:55px"></div>
            </div>
            <div class="slots">${html}</div>
        </div>
    `;
    
    document.getElementById('btn-back').onclick = () => { Audio.playClick(); renderTitle(); };
};

// Ïä§ÌÖåÏù¥ÏßÄ ÏÑ†ÌÉù ÌôîÎ©¥
window.showStageSelect = (slotIdx) => {
    Audio.playClick();
    load(slotIdx);
    
    if (!G.data.dna?.origin) {
        toast('Î®ºÏ†Ä Ï∫êÎ¶≠ÌÑ∞Î•º ÏÉùÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî!', 'error');
        return;
    }
    
    const stages = [
        { id: 1, icon: 'ü¶†', name: 'ÏÑ∏Ìè¨ Ïä§ÌÖåÏù¥ÏßÄ', desc: 'ÏûëÏùÄ ÏÑ∏Ìè¨Î°ú ÏãúÏûë' },
        { id: 2, icon: 'üèîÔ∏è', name: 'Ï†êÌîÑ Ïä§ÌÖåÏù¥ÏßÄ', desc: 'Ïú°ÏßÄÎ°ú Ïò¨ÎùºÍ∞ÄÍ∏∞' },
        { id: 3, icon: 'üèÉ', name: 'Îü¨ÎÑà Ïä§ÌÖåÏù¥ÏßÄ', desc: 'Î¨∏Î™ÖÏùÑ Ìñ•Ìï¥ Îã¨Î¶¨Í∏∞', sub: true }
    ];
    
    const runnerStages = RUNNER_STAGES.map((s, idx) => ({
        idx,
        icon: s.name.split(' ')[0],
        name: s.name.split(' ').slice(1).join(' '),
        dist: s.dist
    }));
    
    let stagesHtml = stages.map(s => `
        <button class="stage-sel-btn" data-stage="${s.id}" style="display:flex;align-items:center;gap:12px;padding:12px;margin:6px 0;width:100%;background:var(--void-surface);border:1px solid var(--border-default);border-radius:10px;cursor:pointer;text-align:left;">
            <span style="font-size:2rem;">${s.icon}</span>
            <div>
                <div style="font-weight:700;color:var(--text-primary);">${s.name}</div>
                <div style="font-size:0.75rem;color:var(--text-muted);">${s.desc}</div>
            </div>
        </button>
    `).join('');
    
    let runnerHtml = runnerStages.map(s => `
        <button class="runner-sel-btn" data-ridx="${s.idx}" style="display:flex;align-items:center;gap:10px;padding:10px;margin:4px 0;width:100%;background:rgba(0,245,212,0.1);border:1px solid var(--neon-cyan);border-radius:8px;cursor:pointer;text-align:left;">
            <span style="font-size:1.5rem;">${s.icon}</span>
            <div style="flex:1;">
                <div style="font-weight:600;color:var(--neon-cyan);font-size:0.9rem;">${s.name}</div>
            </div>
            <span style="font-size:0.7rem;color:var(--text-muted);">${s.idx + 1}/7</span>
        </button>
    `).join('');
    
    app.innerHTML = `
        <div class="page-center"><div class="page-content" style="max-width:360px;max-height:85vh;overflow-y:auto;">
            <h2 class="page-title">üìç Ïä§ÌÖåÏù¥ÏßÄ ÏÑ†ÌÉù</h2>
            <p style="color:var(--text-secondary);font-size:0.85rem;margin-bottom:12px;">ÏõêÌïòÎäî Ïä§ÌÖåÏù¥ÏßÄÎ°ú Ïù¥ÎèôÌï©ÎãàÎã§</p>
            <div style="margin-bottom:16px;">${stagesHtml}</div>
            <div style="border-top:1px solid var(--border-subtle);padding-top:12px;">
                <div style="font-size:0.75rem;color:var(--text-muted);margin-bottom:8px;">üèÉ Îü¨ÎÑà ÏÑ∏Î∂Ä Ïä§ÌÖåÏù¥ÏßÄ</div>
                ${runnerHtml}
            </div>
            <button class="btn btn-outline btn-block" id="btn-back" style="margin-top:16px;">‚Üê Îí§Î°ú</button>
        </div></div>
    `;
    
    document.querySelectorAll('.stage-sel-btn').forEach(btn => {
        btn.onclick = () => {
            const stageId = parseInt(btn.dataset.stage);
            G.data.stage = stageId;
            if (stageId === 3) G.data.runnerStage = 0;
            G.data.runnerDist = 0;
            saveGame();
            Audio.playClick();
            
            if (stageId === 1) startCellWorld();
            else if (stageId === 2) showClimbDice();
            else if (stageId === 3) startRunner();
        };
    });
    
    document.querySelectorAll('.runner-sel-btn').forEach(btn => {
        btn.onclick = () => {
            const ridx = parseInt(btn.dataset.ridx);
            G.data.stage = 3;
            G.data.runnerStage = ridx;
            G.data.runnerDist = 0;
            saveGame();
            Audio.playClick();
            startRunner();
        };
    });
    
    document.getElementById('btn-back').onclick = () => { Audio.playClick(); renderSaves(); };
};

window.handleNew = i => { Audio.playClick(); newGame(i); renderStory('intro'); };
window.handleLoad = i => {
    Audio.playClick();
    load(i);
    if (!G.data.tutDone) renderStory('intro');
    else if (G.data.stage === 1) startCellWorld();
    else if (G.data.stage === 2) showClimbDice();
    else if (G.data.stage === 3) startRunner();
    else if (G.data.stage === 4) renderSpaceHub();
    else renderDice();
};
window.handleDel = i => { Audio.playClick(); if (confirm('Ï†ïÎßê ÏÇ≠Ï†ú?')) { Save.del(i); renderSaves(); } };

// ÏÑ§Ï†ï
const renderSettings = () => {
    const joyRight = Settings.get('joyRight');
    
    app.innerHTML = `
        <div class="page-center"><div class="page-content" style="max-width:340px;">
            <h2 class="page-title">‚öôÔ∏è ÏÑ§Ï†ï</h2>
            <div style="background:var(--void-surface);border-radius:12px;padding:16px;margin-bottom:16px;text-align:left;">
                <div style="font-size:0.7rem;color:var(--text-muted);margin-bottom:8px;">üîä ÏÇ¨Ïö¥Îìú</div>
                <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border-subtle);">
                    <span>ÎßàÏä§ÌÑ∞</span>
                    <input type="range" id="vol-m" min="0" max="100" value="${Audio.settings.master * 100}" style="width:80px;">
                </div>
                <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;">
                    <span>Ìö®Í≥ºÏùå</span>
                    <div style="display:flex;gap:8px;align-items:center;">
                        <input type="range" id="vol-s" min="0" max="100" value="${Audio.settings.sfx * 100}" style="width:80px;">
                        <button class="btn btn-ghost btn-sm" id="toggle-sfx">${Audio.settings.on ? 'üîä' : 'üîá'}</button>
                    </div>
                </div>
            </div>
            <div style="background:var(--void-surface);border-radius:12px;padding:16px;margin-bottom:16px;text-align:left;">
                <div style="font-size:0.7rem;color:var(--text-muted);margin-bottom:8px;">üïπÔ∏è Ï°∞Ïûë</div>
                <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;">
                    <span>Ï°∞Ïù¥Ïä§Ìã±</span>
                    <div style="display:flex;gap:6px;">
                        <button class="btn btn-sm ${!joyRight ? 'btn-energy' : 'btn-ghost'}" id="joy-left">‚¨ÖÔ∏è ÏôºÏ™Ω</button>
                        <button class="btn btn-sm ${joyRight ? 'btn-energy' : 'btn-ghost'}" id="joy-right">‚û°Ô∏è Ïò§Î•∏Ï™Ω</button>
                    </div>
                </div>
            </div>
            <button class="btn btn-energy btn-block" id="btn-close">ÌôïÏù∏</button>
        </div></div>
    `;
    
    document.getElementById('vol-m').oninput = e => { Audio.settings.master = e.target.value / 100; Audio.save(); };
    document.getElementById('vol-s').oninput = e => { Audio.settings.sfx = e.target.value / 100; Audio.save(); };
    document.getElementById('toggle-sfx').onclick = e => { Audio.settings.on = !Audio.settings.on; e.target.textContent = Audio.settings.on ? 'üîä' : 'üîá'; Audio.save(); };
    document.getElementById('joy-left').onclick = () => { Settings.set('joyRight', false); renderSettings(); };
    document.getElementById('joy-right').onclick = () => { Settings.set('joyRight', true); renderSettings(); };
    document.getElementById('btn-close').onclick = () => { Audio.playClick(); renderTitle(); };
};

// Ïö∞Ï£º Í∏∞ÏßÄ (ÏóîÎî© ÌõÑ Î©îÏù∏ ÌéòÏù¥ÏßÄ)
const renderSpaceHub = () => {
    const points = G.data.points || 0;
    const name = G.data.name || 'ÌÉêÌóòÍ∞Ä';
    
    app.innerHTML = `
        <div style="position:fixed;inset:0;display:flex;flex-direction:column;overflow:hidden;">
            <!-- ÏÉÅÎã® Î∞î -->
            <div style="padding:calc(12px + var(--safe-top)) 16px 12px;background:linear-gradient(180deg, rgba(0,0,0,0.8) 0%, transparent 100%);display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <div style="font-family:Orbitron;font-size:0.9rem;color:var(--neon-cyan);">${name}</div>
                    <div style="font-size:0.7rem;color:var(--text-muted);">Ïö∞Ï£º ÌÉêÌóòÍ∞Ä</div>
                </div>
                <div style="text-align:right;">
                    <div style="font-family:Orbitron;font-size:1.1rem;color:var(--neon-pink);">üíé ${points.toLocaleString()}</div>
                    <div style="font-size:0.65rem;color:var(--text-muted);">Ìè¨Ïù∏Ìä∏</div>
                </div>
            </div>
            
            <!-- Ïö∞Ï£º Í∏∞ÏßÄ Ïù¥ÎØ∏ÏßÄ ÏòÅÏó≠ -->
            <div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;">
                <div style="font-size:5rem;margin-bottom:16px;filter:drop-shadow(0 0 30px rgba(0,245,212,0.5));">üõ∏</div>
                <h1 style="font-family:Orbitron;font-size:1.5rem;color:var(--text-primary);margin-bottom:8px;">Ïö∞Ï£º Ï†ïÍ±∞Ïû•</h1>
                <p style="color:var(--text-secondary);font-size:0.85rem;text-align:center;max-width:280px;line-height:1.6;">
                    ÌîÑÎ°§Î°úÍ∑∏Î•º ÏôÑÎ£åÌñàÏäµÎãàÎã§!<br>
                    <span style="color:var(--neon-cyan);">Î≥∏Ìé∏ ÏΩòÌÖêÏ∏†</span>Í∞Ä Í≥ß ÏóÖÎç∞Ïù¥Ìä∏Îê©ÎãàÎã§.
                </p>
            </div>
            
            <!-- Î©îÎâ¥ Î≤ÑÌäºÎì§ -->
            <div style="padding:16px;padding-bottom:calc(16px + var(--safe-bottom));display:flex;flex-direction:column;gap:10px;max-width:320px;margin:0 auto;width:100%;">
                <button class="btn btn-energy btn-block" id="btn-minigame" style="opacity:0.5;" disabled>üéÆ ÎØ∏ÎãàÍ≤åÏûÑ (Ï§ÄÎπÑÏ§ë)</button>
                <button class="btn btn-outline btn-block" id="btn-invite" style="opacity:0.5;" disabled>üë• ÏπúÍµ¨ Ï¥àÎåÄ (Ï§ÄÎπÑÏ§ë)</button>
                <button class="btn btn-outline btn-block" id="btn-shop" style="opacity:0.5;" disabled>üè™ ÏÉÅÏ†ê (Ï§ÄÎπÑÏ§ë)</button>
                <button class="btn btn-ghost btn-block" id="btn-back">‚Üê ÌÉÄÏù¥ÌãÄÎ°ú</button>
            </div>
            
            <!-- ÌïòÎã® ÏïàÎÇ¥ -->
            <div style="text-align:center;padding:12px;font-size:0.7rem;color:var(--text-muted);">
                üöß Ïö∞Ï£ºÏÑ† ÌÉëÏäπ, Ìï®ÎåÄ ÏßÄÌúò, PvP Îì± Î≥∏Ìé∏ ÏΩòÌÖêÏ∏† Í∞úÎ∞ú Ï§ë
            </div>
        </div>
    `;
    
    document.getElementById('btn-back').onclick = () => { Audio.playClick(); renderTitle(); };
};

// Î°úÍ∑∏Ïù∏ ÌôîÎ©¥
const renderLogin = () => {
    app.innerHTML = `
        <div class="page-center"><div class="page-content" style="max-width:320px;">
            <div class="page-icon">üé≤</div>
            <h1 style="font-family:Orbitron;font-size:clamp(2rem,8vw,2.5rem);font-weight:900;background:var(--gradient-energy);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:4px;">BOKLUCK</h1>
            <h2 style="font-family:Orbitron;font-size:0.9rem;color:var(--text-secondary);margin-bottom:32px;">Universe</h2>
            
            <div style="display:flex;flex-direction:column;gap:12px;width:100%;">
                <button class="btn btn-block" id="btn-google" style="background:#4285f4;border:none;display:flex;align-items:center;justify-content:center;gap:10px;padding:14px;">
                    <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#fff" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#fff" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#fff" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#fff" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                    GoogleÎ°ú ÏãúÏûëÌïòÍ∏∞
                </button>
                
                <button class="btn btn-outline btn-block" id="btn-guest" style="padding:14px;">
                    üë§ Í≤åÏä§Ìä∏Î°ú ÏãúÏûëÌïòÍ∏∞
                </button>
            </div>
            
            <div style="margin-top:24px;padding:16px;background:rgba(255,255,255,0.05);border-radius:12px;border:1px solid var(--border-subtle);">
                <div style="font-size:0.75rem;color:var(--text-muted);line-height:1.6;">
                    <div style="margin-bottom:8px;color:var(--neon-cyan);">‚ú® Google Î°úÍ∑∏Ïù∏</div>
                    ‚Ä¢ ÏßÑÌñâ ÏÉÅÌô© ÌÅ¥ÎùºÏö∞Îìú Ï†ÄÏû•<br>
                    ‚Ä¢ Îã§Î•∏ Í∏∞Í∏∞ÏóêÏÑú Ïù¥Ïñ¥ÌïòÍ∏∞<br>
                    ‚Ä¢ Îû≠ÌÇπ Ï∞∏Ïó¨ Í∞ÄÎä•
                </div>
                <div style="font-size:0.75rem;color:var(--text-muted);line-height:1.6;margin-top:12px;">
                    <div style="margin-bottom:8px;color:var(--neon-pink);">üë§ Í≤åÏä§Ìä∏ Î™®Îìú</div>
                    ‚Ä¢ Î°úÍ∑∏Ïù∏ ÏóÜÏù¥ Î∞îÎ°ú ÏãúÏûë<br>
                    ‚Ä¢ ‚ö†Ô∏è ÏßÑÌñâ ÏÉÅÌô© Ï†ÄÏû• ÏïàÎê®<br>
                    ‚Ä¢ Î∏åÎùºÏö∞Ï†Ä Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú Ïãú Ï¥àÍ∏∞Ìôî
                </div>
            </div>
            
            <div style="margin-top:20px;font-size:0.65rem;color:var(--text-muted);text-align:center;">
                v1.5 | ¬© 2024 BOKLUCK Universe
            </div>
        </div></div>
    `;
    
    document.getElementById('btn-google').onclick = async () => {
        Audio.init();
        Audio.playClick();
        const btn = document.getElementById('btn-google');
        btn.disabled = true;
        btn.innerHTML = 'Î°úÍ∑∏Ïù∏ Ï§ë...';
        
        const result = await Auth.loginWithGoogle();
        if (result.success) {
            toast(`ÌôòÏòÅÌï©ÎãàÎã§, ${result.user.displayName}Îãò!`, 'success');
            renderTitle();
        } else {
            toast('Î°úÍ∑∏Ïù∏ Ïã§Ìå®: ' + result.error, 'error');
            btn.disabled = false;
            btn.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24"><path fill="#fff" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#fff" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#fff" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#fff" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg> GoogleÎ°ú ÏãúÏûëÌïòÍ∏∞`;
        }
    };
    
    document.getElementById('btn-guest').onclick = () => {
        Audio.init();
        Audio.playClick();
        Auth.loginAsGuest();
        toast('Í≤åÏä§Ìä∏ Î™®ÎìúÎ°ú ÏãúÏûëÌï©ÎãàÎã§', 'info');
        renderTitle();
    };
};

// Ï¥àÍ∏∞Ìôî
document.addEventListener('DOMContentLoaded', () => {
    createStars();
    
    // Ïù¥ÎØ∏ Î°úÍ∑∏Ïù∏ÎêòÏñ¥ ÏûàÏúºÎ©¥ ÌÉÄÏù¥ÌãÄÎ°ú, ÏïÑÎãàÎ©¥ Î°úÍ∑∏Ïù∏ ÌôîÎ©¥
    if (auth) {
        auth.onAuthStateChanged(user => {
            if (user) {
                Auth.user = user;
                Auth.isGuest = false;
                renderTitle();
            } else if (!Auth.user) {
                renderLogin();
            }
        });
        // 1Ï¥à ÌõÑÏóêÎèÑ ÏÉÅÌÉú Î≥ÄÌôî ÏóÜÏúºÎ©¥ Î°úÍ∑∏Ïù∏ ÌôîÎ©¥
        setTimeout(() => {
            if (!Auth.user) renderLogin();
        }, 1000);
    } else {
        renderLogin();
    }
    
    setInterval(saveGame, CONFIG.SAVE_INTERVAL);
    window.addEventListener('beforeunload', saveGame);
    console.log('üé≤ BOKLUCK Universe v1.5.0');
});
</script>
</body>
</html>
