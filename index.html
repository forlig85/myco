<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BOKLUCK Universe: Genesis</title>
    <meta name="theme-color" content="#0a0a1a">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üåå</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
    * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; -webkit-user-select: none; }
    :root {
        --primary: #00f5d4; --secondary: #7b2cbf; --accent: #f72585; --energy: #fee440;
        --success: #10b981; --danger: #ff4d6d;
        --bg-space: #0a0a1a; --bg-card: rgba(20, 20, 40, 0.85); --bg-input: rgba(10, 10, 30, 0.8);
        --border: rgba(0, 245, 212, 0.3); --text: #e0e0ff; --text-muted: #8080a0;
        --gradient-energy: linear-gradient(135deg, #00f5d4 0%, #fee440 100%);
        --gradient-evolution: linear-gradient(135deg, #7b2cbf 0%, #f72585 100%);
    }
    body { background: var(--bg-space); color: var(--text); font-family: 'Noto Sans KR', sans-serif; min-height: 100vh; overflow: hidden; touch-action: none; }
    .font-display { font-family: 'Orbitron', sans-serif; }
    
    #stars { position: fixed; inset: 0; z-index: -1; }
    .star { position: absolute; background: white; border-radius: 50%; animation: twinkle 3s infinite; }
    @keyframes twinkle { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }
    
    /* Loading */
    .loading-screen { position: fixed; inset: 0; background: var(--bg-space); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 3000; }
    .loading-screen.hidden { display: none; }
    .loading-spinner { width: 60px; height: 60px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* UI Components */
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 24px; border: none; border-radius: 12px; font-size: 14px; font-weight: 700; cursor: pointer; transition: 0.2s; font-family: 'Noto Sans KR'; }
    .btn:active { transform: scale(0.95); }
    .btn:disabled { opacity: 0.5; filter: grayscale(1); cursor: not-allowed; }
    .btn-primary { background: var(--gradient-evolution); color: white; box-shadow: 0 4px 15px rgba(123, 44, 191, 0.4); }
    .btn-energy { background: var(--gradient-energy); color: #1a1a2e; box-shadow: 0 4px 15px rgba(0, 245, 212, 0.4); }
    .btn-outline { background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: var(--text); }
    
    /* Navbar & Layout */
    .navbar { position: fixed; top: 0; left: 0; right: 0; height: 60px; background: rgba(10,10,26,0.9); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border); z-index: 1000; display: flex; align-items: center; padding: 0 20px; justify-content: space-between; }
    .nav-logo { font-family: 'Orbitron'; font-weight: 900; font-size: 20px; background: var(--gradient-energy); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .nav-right { display: flex; gap: 10px; align-items: center; }
    .entropy-badge { background: rgba(0,0,0,0.5); padding: 6px 12px; border-radius: 20px; border: 1px solid var(--border); font-family: 'Orbitron'; font-weight: 700; color: var(--energy); display: flex; gap: 6px; align-items: center; }
    
    .main-content { padding-top: 80px; padding-bottom: 40px; height: 100vh; overflow-y: auto; }
    .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }

    /* Dashboard Cards */
    .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 20px; padding: 24px; margin-bottom: 20px; position: relative; overflow: hidden; }
    .card::before { content:''; position:absolute; top:0; left:0; width:100%; height:2px; background: linear-gradient(90deg, transparent, var(--primary), transparent); }
    
    .entity-visual { width: 180px; height: 180px; margin: 0 auto 20px; position: relative; }
    .entity-name { text-align: center; font-family: 'Orbitron'; font-size: 20px; font-weight: 700; margin-bottom: 10px; }
    
    .grid-menu { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
    .menu-item { background: rgba(255,255,255,0.03); border: 1px solid var(--border); padding: 20px; border-radius: 16px; text-align: center; cursor: pointer; transition: 0.2s; }
    .menu-item:hover { background: rgba(0, 245, 212, 0.1); border-color: var(--primary); }
    .menu-icon { font-size: 32px; margin-bottom: 8px; display: block; }
    .menu-label { font-size: 14px; color: var(--text-muted); font-weight: 600; }

    /* Login Page */
    .login-wrapper { height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; }
    .login-cell-anim { width: 120px; height: 120px; background: radial-gradient(circle, var(--primary), var(--secondary)); border-radius: 50%; margin-bottom: 30px; box-shadow: 0 0 50px var(--primary); animation: pulse 2s infinite; }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

    /* Game World UI */
    #worldCanvas { position: fixed; inset: 0; z-index: 500; display: none; }
    #worldCanvas.active { display: block; }
    
    .hud-layer { position: fixed; inset: 0; z-index: 600; pointer-events: none; display: none; flex-direction: column; justify-content: space-between; padding: 20px; }
    .hud-layer.active { display: flex; }
    .hud-top { display: flex; justify-content: space-between; align-items: flex-start; }
    .hud-stats { pointer-events: auto; background: rgba(0,0,0,0.6); padding: 10px 15px; border-radius: 12px; border: 1px solid var(--border); backdrop-filter: blur(5px); }
    .hud-label { font-size: 10px; color: var(--text-muted); font-family: 'Orbitron'; letter-spacing: 1px; }
    .hud-value { font-size: 24px; font-weight: 900; color: var(--energy); font-family: 'Orbitron'; }
    
    .goal-tracker { margin-top: 8px; font-size: 12px; color: white; display: flex; align-items: center; gap: 6px; }
    .goal-bar-bg { width: 100px; height: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; overflow: hidden; }
    .goal-bar-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.3s; }

    .hud-controls { pointer-events: auto; display: flex; justify-content: space-between; align-items: flex-end; padding-bottom: 20px; }
    
    /* üïπÔ∏è Mobile Joystick */
    .joystick-area { width: 120px; height: 120px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 50%; position: relative; pointer-events: auto; touch-action: none; }
    .joystick-knob { width: 50px; height: 50px; background: rgba(0, 245, 212, 0.5); border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 20px var(--primary); pointer-events: none; transition: transform 0.1s; }
    
    .action-btn-group { display: flex; gap: 12px; }
    .game-btn { width: 60px; height: 60px; border-radius: 50%; border: none; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; font-size: 24px; cursor: pointer; pointer-events: auto; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
    .game-btn:active { background: var(--primary); color: black; transform: scale(0.9); }
    .game-btn.dash { border-color: var(--accent); color: var(--accent); }
    
    /* Modals & Popups */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
    .modal-overlay.active { display: flex; }
    .modal-box { background: var(--bg-card); border: 1px solid var(--border); border-radius: 24px; padding: 30px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 0 50px rgba(0,0,0,0.5); }
    
    .evo-alert { position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%) scale(0); background: rgba(16, 16, 32, 0.95); border: 2px solid var(--secondary); padding: 30px; border-radius: 20px; z-index: 2500; text-align: center; pointer-events: none; opacity: 0; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    .evo-alert.show { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    
    /* Utilities */
    .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="stars"></div>
    <div class="loading-screen" id="loadingScreen"><div class="loading-spinner"></div></div>

    <div id="app"></div>

    <canvas id="worldCanvas"></canvas>

    <div class="hud-layer" id="gameHUD">
        <div class="hud-top">
            <div class="hud-stats">
                <div class="hud-label">ENTROPY</div>
                <div class="hud-value" id="hudEntropy">0</div>
                <div class="goal-tracker">
                    <span id="goalText">Next: Eye (100)</span>
                    <div class="goal-bar-bg"><div class="goal-bar-fill" id="goalBar" style="width: 0%"></div></div>
                </div>
            </div>
            <button class="game-btn" onclick="window.exitWorld()">üè†</button>
        </div>

        <div class="hud-controls">
            <div class="joystick-area" id="joystickBase">
                <div class="joystick-knob" id="joystickKnob"></div>
            </div>
            <div class="action-btn-group">
                <button class="game-btn dash" id="dashBtn" ontouchstart="window.triggerDash()">üöÄ</button>
            </div>
        </div>
    </div>

    <div class="evo-alert" id="evoPopup">
        <div style="font-size:50px; margin-bottom:10px" id="evoIcon">üß¨</div>
        <h2 style="font-family:'Orbitron'; color:var(--primary); margin-bottom:5px" id="evoTitle">EVOLUTION</h2>
        <p style="color:var(--text-muted); font-size:14px" id="evoDesc">New organ acquired</p>
    </div>

    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = { apiKey: "AIzaSyBwQjuqgWM4YKnqu_gzNbeCg5alrC-jVcQ", authDomain: "myco-737a0.firebaseapp.com", projectId: "myco-737a0", storageBucket: "myco-737a0.firebasestorage.app", messagingSenderId: "942571332540", appId: "1:942571332540:web:be0bb6fbdd32655501c1b9" };
    const fbApp = initializeApp(firebaseConfig);
    const db = getFirestore(fbApp);
    const auth = getAuth(fbApp);
    
    // --- State Management ---
    const State = {
        user: null,
        game: {
            entropy: 0,
            stage: 1,
            evolution: { eye: false, arm: false, leg: false, brain: false, wing: false },
            stats: { speed: 3, vision: 300, collect: 50, multi: 1 }
        },
        async sync() {
            if(!this.user) return;
            await updateDoc(doc(db, 'users', this.user.uid), { game: this.game, lastActive: serverTimestamp() });
        },
        async load() {
            if(!this.user) return;
            const snap = await getDoc(doc(db, 'users', this.user.uid));
            if(snap.exists()) {
                const data = snap.data();
                if(data.game) this.game = { ...this.game, ...data.game };
            }
        }
    };

    // --- Visuals ---
    function createStars() {
        const c = document.getElementById('stars');
        c.innerHTML = '';
        for(let i=0; i<100; i++){
            const s = document.createElement('div');
            s.className = 'star';
            s.style.left = Math.random()*100 + '%';
            s.style.top = Math.random()*100 + '%';
            s.style.width = Math.random()*2 + 'px';
            s.style.height = s.style.width;
            s.style.animationDelay = Math.random()*3 + 's';
            c.appendChild(s);
        }
    }

    // --- Navigation & Rendering ---
    function navigate(page) {
        const app = document.getElementById('app');
        if(page === 'login') {
            app.innerHTML = `
                <div class="login-wrapper">
                    <h1 style="font-family:'Orbitron'; font-size:40px; margin-bottom:10px; background:var(--gradient-energy); -webkit-background-clip:text; -webkit-text-fill-color:transparent;">BOKLUCK</h1>
                    <p style="color:var(--text-muted); margin-bottom:40px;">GENESIS PROJECT</p>
                    <div class="login-cell-anim"></div>
                    <button class="btn btn-energy" onclick="window.googleLogin()">Google Í≥ÑÏ†ïÏúºÎ°ú ÏãúÏûë</button>
                </div>
            `;
        } else if(page === 'dashboard') {
            const g = State.game;
            const evoCount = Object.values(g.evolution).filter(x=>x).length;
            app.innerHTML = `
                <nav class="navbar">
                    <div class="nav-logo">BOKLUCK</div>
                    <div class="nav-right">
                        <div class="entropy-badge">‚ö° ${g.entropy.toLocaleString()}</div>
                        <button class="btn btn-outline btn-sm" onclick="window.logout()">Î°úÍ∑∏ÏïÑÏõÉ</button>
                    </div>
                </nav>
                <div class="main-content container">
                    <div class="card text-center">
                        <div class="entity-visual">
                            <canvas id="dashCanvas" width="180" height="180"></canvas>
                        </div>
                        <h2 class="entity-name">Entity #${State.user.uid.slice(0,5)}</h2>
                        <div style="font-family:'Orbitron'; color:var(--accent); font-size:12px; margin-bottom:20px;">STAGE ${g.stage}: CELLULAR</div>
                        
                        <button class="btn btn-primary" style="width:100%; padding:16px; font-size:18px;" onclick="window.startCellGame()">
                            üåå ÏÑ∏Ìè¨ ÏÑ∏Í≥Ñ ÏßÑÏûÖ
                        </button>
                    </div>

                    <div class="grid-menu">
                        <div class="menu-item">
                            <span class="menu-icon">üß¨</span>
                            <div class="menu-label">ÏßÑÌôî (${evoCount}/5)</div>
                        </div>
                        <div class="menu-item" style="opacity:0.5">
                            <span class="menu-icon">ü™ê</span>
                            <div class="menu-label">ÌñâÏÑ± (Ïû†ÍπÄ)</div>
                        </div>
                    </div>
                </div>
            `;
            setTimeout(startDashAnim, 100);
        }
    }

    // --- Dashboard Animation ---
    function startDashAnim() {
        const canvas = document.getElementById('dashCanvas');
        if(!canvas) return;
        const ctx = canvas.getContext('2d');
        let t = 0;
        function loop() {
            if(!document.getElementById('dashCanvas')) return;
            t += 0.05;
            ctx.clearRect(0,0,180,180);
            drawCell(ctx, 90, 90, 40, State.game.evolution, t);
            requestAnimationFrame(loop);
        }
        loop();
    }

    function drawCell(ctx, x, y, r, evo, t) {
        ctx.save();
        ctx.translate(x, y);
        
        // Body (Wobble)
        ctx.beginPath();
        for(let i=0; i<12; i++){
            const ang = (i/12)*Math.PI*2;
            const rad = r + Math.sin(t + i)*3;
            ctx.lineTo(Math.cos(ang)*rad, Math.sin(ang)*rad);
        }
        ctx.closePath();
        const g = ctx.createRadialGradient(-10,-10,0,0,0,r);
        g.addColorStop(0, '#00f5d4');
        g.addColorStop(1, '#7b2cbf');
        ctx.fillStyle = g;
        ctx.fill();
        ctx.shadowBlur = 15; ctx.shadowColor = '#00f5d4';

        // Parts
        if(evo.eye) {
            ctx.fillStyle = 'white'; ctx.beginPath(); ctx.arc(10, -5, 12, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = 'black'; ctx.beginPath(); ctx.arc(10 + Math.sin(t)*2, -5, 5, 0, Math.PI*2); ctx.fill();
        }
        if(evo.brain) {
            ctx.fillStyle = 'rgba(254, 228, 64, 0.5)';
            ctx.beginPath(); ctx.arc(0, -r*0.5, r*0.4, 0, Math.PI*2); ctx.fill();
        }
        if(evo.wing) {
            ctx.fillStyle = 'rgba(255,255,255,0.3)';
            ctx.save(); ctx.rotate(Math.sin(t*2)*0.2);
            ctx.beginPath(); ctx.ellipse(-20, -10, 20, 10, -0.5, 0, Math.PI*2); ctx.fill();
            ctx.restore();
        }

        ctx.restore();
    }

    // --- GAME LOOP: Cell World ---
    let gameLoopId;
    let particles = [];
    let floatingTexts = []; // ‚ú® ÏãúÍ∞ÅÏ†Å Ìö®Í≥º: ÌîåÎ°úÌåÖ ÌÖçÏä§Ìä∏
    let player = { x:0, y:0, vx:0, vy:0, size:30 };
    let cam = { x:0, y:0 };
    let joystick = { active: false, dx: 0, dy: 0 }; // üïπÔ∏è Ï°∞Ïù¥Ïä§Ìã± ÏÉÅÌÉú

    window.startCellGame = function() {
        document.getElementById('app').innerHTML = ''; // Clear UI
        const canvas = document.getElementById('worldCanvas');
        const ctx = canvas.getContext('2d');
        canvas.classList.add('active');
        document.getElementById('gameHUD').classList.add('active');
        
        // Init Game
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        player.x = 0; player.y = 0;
        particles = [];
        for(let i=0; i<80; i++) spawnParticle();

        // üïπÔ∏è Joystick Setup
        const base = document.getElementById('joystickBase');
        const knob = document.getElementById('joystickKnob');
        
        base.addEventListener('touchstart', e => {
            e.preventDefault();
            joystick.active = true;
            updateJoystick(e.touches[0]);
        }, {passive: false});
        
        base.addEventListener('touchmove', e => {
            e.preventDefault();
            if(joystick.active) updateJoystick(e.touches[0]);
        }, {passive: false});
        
        const endJoystick = () => {
            joystick.active = false;
            joystick.dx = 0; joystick.dy = 0;
            knob.style.transform = `translate(-50%, -50%)`;
        };
        base.addEventListener('touchend', endJoystick);
        base.addEventListener('touchcancel', endJoystick);

        function updateJoystick(touch) {
            const rect = base.getBoundingClientRect();
            const centerX = rect.left + rect.width/2;
            const centerY = rect.top + rect.height/2;
            
            let dx = touch.clientX - centerX;
            let dy = touch.clientY - centerY;
            const dist = Math.sqrt(dx*dx + dy*dy);
            const maxDist = rect.width/2 - 25; // Knob radius limit
            
            if(dist > maxDist) {
                dx = (dx/dist) * maxDist;
                dy = (dy/dist) * maxDist;
            }
            
            knob.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
            
            // Normalize -1 to 1
            joystick.dx = dx / maxDist;
            joystick.dy = dy / maxDist;
        }

        // ‚å®Ô∏è Keyboard Fallback
        const keys = {};
        window.onkeydown = e => keys[e.key.toLowerCase()] = true;
        window.onkeyup = e => keys[e.key.toLowerCase()] = false;

        let time = 0;
        function loop() {
            time += 0.05;
            ctx.fillStyle = '#0a0a1a';
            ctx.fillRect(0,0,canvas.width, canvas.height);

            // 1. Movement Logic (Joystick + Keyboard)
            let mx = joystick.dx;
            let my = joystick.dy;
            
            if(!joystick.active) {
                if(keys['w']) my = -1;
                if(keys['s']) my = 1;
                if(keys['a']) mx = -1;
                if(keys['d']) mx = 1;
            }

            // Apply Stats
            const speed = State.game.stats.speed * (joystick.active ? 1.5 : 1); // Slight boost for touch
            player.x += mx * speed;
            player.y += my * speed;

            // Camera follow
            cam.x += (player.x - cam.x) * 0.1;
            cam.y += (player.y - cam.y) * 0.1;

            // 2. Draw Stars (Background)
            ctx.fillStyle = 'rgba(255,255,255,0.3)';
            for(let i=0; i<50; i++) {
                const px = ((i*100 - cam.x*0.5)%canvas.width + canvas.width)%canvas.width;
                const py = ((i*70 - cam.y*0.5)%canvas.height + canvas.height)%canvas.height;
                ctx.beginPath(); ctx.arc(px, py, 1, 0, Math.PI*2); ctx.fill();
            }

            // 3. Draw Particles (Food)
            const cx = canvas.width/2;
            const cy = canvas.height/2;

            particles.forEach((p, idx) => {
                const drawX = cx + (p.x - cam.x);
                const drawY = cy + (p.y - cam.y);
                
                // Collect Check
                const dist = Math.hypot(p.x - player.x, p.y - player.y);
                if(dist < player.size + p.size + State.game.stats.collect) {
                    // Eat!
                    const gain = p.val * State.game.stats.multi;
                    State.game.entropy += gain;
                    particles.splice(idx, 1);
                    spawnParticle();
                    updateHUD();
                    checkEvolution();
                    
                    // ‚ú® Floating Text Spawn
                    floatingTexts.push({
                        x: p.x, y: p.y, 
                        text: `+${gain}`, 
                        life: 1.0, 
                        color: gain > 1 ? '#fee440' : '#fff'
                    });
                } else {
                    // Draw
                    if(drawX > -20 && drawX < canvas.width+20 && drawY > -20 && drawY < canvas.height+20) {
                        ctx.beginPath();
                        ctx.arc(drawX, drawY, p.size + Math.sin(time + idx)*2, 0, Math.PI*2);
                        ctx.fillStyle = p.color;
                        ctx.fill();
                    }
                }
            });

            // 4. Draw Player
            drawCell(ctx, cx, cy, player.size, State.game.evolution, time);

            // 5. ‚ú® Draw Floating Texts
            floatingTexts.forEach((ft, idx) => {
                const fx = cx + (ft.x - cam.x);
                const fy = cy + (ft.y - cam.y);
                
                ft.y -= 1; // Move up
                ft.life -= 0.02; // Fade out
                
                ctx.globalAlpha = Math.max(0, ft.life);
                ctx.fillStyle = ft.color;
                ctx.font = "bold 16px 'Orbitron'";
                ctx.fillText(ft.text, fx, fy);
                ctx.globalAlpha = 1.0;

                if(ft.life <= 0) floatingTexts.splice(idx, 1);
            });

            gameLoopId = requestAnimationFrame(loop);
        }
        loop();
    };

    function spawnParticle() {
        const ang = Math.random() * Math.PI * 2;
        const dist = 300 + Math.random() * 500;
        particles.push({
            x: player.x + Math.cos(ang) * dist,
            y: player.y + Math.sin(ang) * dist,
            size: 5 + Math.random()*5,
            val: 1 + Math.floor(Math.random()*3),
            color: `hsl(${Math.random()*360}, 70%, 60%)`
        });
    }

    window.triggerDash = function() {
        // Dash logic (simple speed boost)
        // Ïã§Ï†ú Íµ¨ÌòÑÏóêÏÑúÎäî Ïø®ÌÉÄÏûÑ Îì±ÏùÑ Ï∂îÍ∞Ä
        if(State.game.evolution.wing) {
            // Wing effect
        }
    };

    window.exitWorld = function() {
        cancelAnimationFrame(gameLoopId);
        document.getElementById('worldCanvas').classList.remove('active');
        document.getElementById('gameHUD').classList.remove('active');
        State.sync();
        navigate('dashboard');
    }

    // --- UI & Logic Helpers ---
    function updateHUD() {
        const e = State.game.entropy;
        document.getElementById('hudEntropy').innerText = e.toLocaleString();
        
        // Goal Logic
        let nextGoal = { text: "Max Evolution", pct: 100 };
        if(!State.game.evolution.eye) nextGoal = { text: "Next: Eye (100 E)", pct: (e/100)*100 };
        else if(!State.game.evolution.arm) nextGoal = { text: "Next: Arm (300 E)", pct: (e/300)*100 };
        else if(!State.game.evolution.leg) nextGoal = { text: "Next: Leg (600 E)", pct: (e/600)*100 };
        else if(!State.game.evolution.brain) nextGoal = { text: "Next: Brain (1000 E)", pct: (e/1000)*100 };
        
        document.getElementById('goalText').innerText = nextGoal.text;
        document.getElementById('goalBar').style.width = Math.min(100, nextGoal.pct) + "%";
    }

    function checkEvolution() {
        const e = State.game.entropy;
        const ev = State.game.evolution;
        let newEvo = null;

        if(!ev.eye && e >= 100) { ev.eye=true; State.game.stats.vision=500; newEvo="üëÅÔ∏è Vision"; }
        else if(!ev.arm && e >= 300) { ev.arm=true; State.game.stats.collect=80; newEvo="ü¶æ Tentacle"; }
        else if(!ev.leg && e >= 600) { ev.leg=true; State.game.stats.speed=5; newEvo="ü¶µ Movement"; }
        else if(!ev.brain && e >= 1000) { ev.brain=true; State.game.stats.multi=2; newEvo="üß† Intelligence"; }

        if(newEvo) {
            const alert = document.getElementById('evoPopup');
            document.getElementById('evoDesc').innerText = newEvo + " Acquired!";
            alert.classList.add('show');
            setTimeout(()=>alert.classList.remove('show'), 3000);
            State.sync();
        }
    }

    // --- Auth ---
    window.googleLogin = () => signInWithPopup(auth, new GoogleAuthProvider());
    window.logout = () => signOut(auth).then(()=>navigate('login'));

    // --- Init ---
    createStars();
    onAuthStateChanged(auth, user => {
        if(user) {
            State.user = user;
            State.load().then(() => {
                document.getElementById('loadingScreen').classList.add('hidden');
                navigate('dashboard');
            });
        } else {
            document.getElementById('loadingScreen').classList.add('hidden');
            navigate('login');
        }
    });

    </script>
</body>
</html>
