<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOKLUCK Universe</title>
    <meta name="description" content="ìš°ì£¼ì—ì„œ ê¹¨ì–´ë‚œ ì˜ì‹, ì‚´ì•„ë‚¨ì•„ ì§„í™”í•˜ë¼">
    <meta name="theme-color" content="#0a0a1a">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸŒŒ</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    :root {
        --primary: #00f5d4;
        --secondary: #7b2cbf;
        --accent: #f72585;
        --energy: #fee440;
        --success: #10b981;
        --danger: #ff4d6d;
        --bg-space: #0a0a1a;
        --bg-card: rgba(20, 20, 40, 0.9);
        --bg-card-solid: #14142a;
        --bg-hover: rgba(30, 30, 60, 0.9);
        --bg-input: rgba(10, 10, 30, 0.8);
        --border: rgba(0, 245, 212, 0.2);
        --text: #e0e0ff;
        --text-muted: #8080a0;
        --text-dark: #4a4a6a;
        --gradient-cosmic: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f72585 100%);
        --gradient-energy: linear-gradient(135deg, #00f5d4 0%, #fee440 100%);
        --gradient-evolution: linear-gradient(135deg, #7b2cbf 0%, #f72585 100%);
        --nav-height: 60px;
    }
    
    body {
        background: var(--bg-space);
        color: var(--text);
        font-family: 'Noto Sans KR', sans-serif;
        min-height: 100vh;
        overflow-x: hidden;
    }
    
    .font-display { font-family: 'Orbitron', sans-serif; }
    
    #space-bg {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: 
            radial-gradient(ellipse at 20% 80%, rgba(123, 44, 191, 0.15) 0%, transparent 50%),
            radial-gradient(ellipse at 80% 20%, rgba(247, 37, 133, 0.1) 0%, transparent 50%),
            var(--bg-space);
        z-index: -2;
    }
    
    #stars {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        z-index: -1;
        pointer-events: none;
    }
    
    .star {
        position: absolute;
        background: white;
        border-radius: 50%;
        animation: twinkle 3s infinite;
    }
    
    @keyframes twinkle {
        0%, 100% { opacity: 0.3; }
        50% { opacity: 1; }
    }
    
    .loading-screen {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: var(--bg-space);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 3000;
    }
    
    .loading-screen.hidden { display: none; }
    
    .loading-spinner {
        width: 60px; height: 60px;
        border: 3px solid var(--border);
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
    }
    
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .loading-text {
        font-family: 'Orbitron', sans-serif;
        font-size: 14px;
        color: var(--text-muted);
        letter-spacing: 2px;
    }
    
    /* Navbar */
    .navbar {
        position: fixed;
        top: 0; left: 0; right: 0;
        height: var(--nav-height);
        background: rgba(10, 10, 26, 0.95);
        backdrop-filter: blur(20px);
        border-bottom: 1px solid var(--border);
        z-index: 1000;
        display: flex;
        align-items: center;
        padding: 0 24px;
    }
    
    .nav-logo {
        font-family: 'Orbitron', sans-serif;
        font-size: 22px;
        font-weight: 900;
        background: var(--gradient-energy);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        cursor: pointer;
        margin-right: 40px;
    }
    
    .nav-links { display: flex; gap: 8px; flex: 1; }
    
    .nav-link {
        padding: 10px 18px;
        border-radius: 10px;
        color: var(--text-muted);
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: 0.2s;
    }
    
    .nav-link:hover { color: var(--text); background: var(--bg-hover); }
    .nav-link.active { color: var(--primary); background: rgba(0, 245, 212, 0.1); }
    .nav-link.locked { opacity: 0.4; cursor: not-allowed; }
    
    .nav-right { display: flex; align-items: center; gap: 16px; }
    
    .entropy-badge {
        display: flex;
        align-items: center;
        gap: 10px;
        background: var(--bg-card);
        border: 1px solid var(--border);
        padding: 8px 16px;
        border-radius: 25px;
    }
    
    .entropy-icon {
        width: 24px; height: 24px;
        background: var(--gradient-energy);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
    }
    
    .entropy-value {
        font-family: 'Orbitron', sans-serif;
        font-size: 16px;
        font-weight: 700;
        color: var(--energy);
    }
    
    .user-menu {
        position: relative;
    }
    
    .user-profile {
        display: flex;
        align-items: center;
        gap: 12px;
        cursor: pointer;
        padding: 6px 12px;
        border-radius: 25px;
    }
    
    .user-profile:hover { background: var(--bg-hover); }
    
    .user-avatar {
        width: 36px; height: 36px;
        border-radius: 50%;
        border: 2px solid var(--primary);
    }
    
    .user-name { font-size: 14px; font-weight: 600; }
    
    .user-dropdown {
        position: absolute;
        top: 100%;
        right: 0;
        margin-top: 8px;
        background: var(--bg-card-solid);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 8px;
        min-width: 160px;
        display: none;
        z-index: 1001;
    }
    
    .user-dropdown.show { display: block; }
    
    .dropdown-item {
        padding: 10px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .dropdown-item:hover { background: var(--bg-hover); }
    .dropdown-item.danger { color: var(--danger); }
    
    .main-content {
        padding-top: var(--nav-height);
        min-height: 100vh;
    }
    
    .page-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 24px;
    }
    
    /* Buttons */
    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 12px 24px;
        border: none;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: 0.2s;
    }
    
    .btn:hover { transform: translateY(-2px); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    
    .btn-primary { background: var(--gradient-cosmic); color: white; }
    .btn-energy { background: var(--gradient-energy); color: #1a1a2e; }
    .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
    .btn-outline:hover { border-color: var(--primary); color: var(--primary); }
    .btn-danger { background: var(--danger); color: white; }
    
    .btn-google {
        background: white;
        color: #333;
        padding: 14px 32px;
        font-size: 15px;
    }
    .btn-google img { width: 20px; height: 20px; }
    
    .btn-lg { padding: 16px 40px; font-size: 16px; }
    .btn-sm { padding: 8px 16px; font-size: 13px; }
    .btn-block { width: 100%; }
    
    /* Cards */
    .card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 20px;
        padding: 24px;
    }
    
    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--border);
    }
    
    .card-title {
        font-family: 'Orbitron', sans-serif;
        font-size: 16px;
        font-weight: 700;
    }
    
    /* Progress */
    .progress-bar {
        height: 8px;
        background: rgba(123, 44, 191, 0.2);
        border-radius: 4px;
        overflow: hidden;
    }
    
    .progress-fill {
        height: 100%;
        background: var(--gradient-evolution);
        border-radius: 4px;
        transition: width 0.3s;
    }
    
    .stage-progress {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 16px 24px;
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 30px;
    }
    
    .stage-dot {
        width: 32px; height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        background: var(--bg-input);
        border: 2px solid var(--border);
    }
    
    .stage-dot.completed { background: var(--gradient-energy); border-color: var(--energy); }
    .stage-dot.current { background: var(--gradient-evolution); border-color: var(--accent); }
    .stage-dot.locked { opacity: 0.4; }
    
    .stage-line {
        flex: 1;
        height: 2px;
        background: var(--border);
        max-width: 40px;
    }
    
    .stage-line.completed { background: var(--gradient-energy); }
    
    /* Toast */
    .toast-container {
        position: fixed;
        top: 80px;
        right: 24px;
        z-index: 2000;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    
    .toast {
        background: var(--bg-card-solid);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px 20px;
        display: flex;
        align-items: center;
        gap: 12px;
        min-width: 300px;
        animation: slideIn 0.3s ease;
    }
    
    .toast.success { border-color: var(--success); }
    .toast.error { border-color: var(--danger); }
    
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    
    /* Login */
    .login-page {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 40px 20px;
        text-align: center;
    }
    
    .login-logo {
        font-family: 'Orbitron', sans-serif;
        font-size: 56px;
        font-weight: 900;
        background: var(--gradient-energy);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 8px;
    }
    
    .login-subtitle {
        font-size: 18px;
        color: var(--text-muted);
        margin-bottom: 40px;
    }
    
    .login-cell {
        width: 150px; height: 150px;
        background: radial-gradient(circle at 30% 30%, var(--primary), var(--secondary));
        border-radius: 50%;
        margin-bottom: 40px;
        box-shadow: 0 0 80px rgba(0, 245, 212, 0.4);
        animation: pulse 3s ease-in-out infinite;
    }
    
    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }
    
    .login-story {
        max-width: 400px;
        font-size: 15px;
        color: var(--text-muted);
        line-height: 1.8;
        margin-bottom: 40px;
    }
    
    .login-story strong { color: var(--primary); }
    
    .login-divider {
        display: flex;
        align-items: center;
        gap: 16px;
        margin: 24px 0;
        color: var(--text-dark);
        font-size: 13px;
    }
    
    .login-divider::before,
    .login-divider::after {
        content: '';
        flex: 1;
        height: 1px;
        background: var(--border);
    }
    
    /* Dashboard */
    .dashboard-grid {
        display: grid;
        grid-template-columns: 320px 1fr;
        gap: 24px;
    }
    
    @media (max-width: 1024px) {
        .dashboard-grid { grid-template-columns: 1fr; }
    }
    
    .entity-card { position: relative; overflow: hidden; }
    .entity-card::before {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0;
        height: 3px;
        background: var(--gradient-evolution);
    }
    
    .entity-visual {
        width: 180px; height: 180px;
        margin: 0 auto 24px;
    }
    
    .entity-stage-label {
        font-family: 'Orbitron', sans-serif;
        font-size: 11px;
        color: var(--accent);
        letter-spacing: 2px;
        text-align: center;
        margin-bottom: 8px;
    }
    
    .entity-name {
        font-family: 'Orbitron', sans-serif;
        font-size: 18px;
        font-weight: 700;
        text-align: center;
        margin-bottom: 20px;
    }
    
    .entity-stats {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }
    
    .stat-box {
        background: rgba(0, 245, 212, 0.05);
        border: 1px solid rgba(0, 245, 212, 0.1);
        border-radius: 12px;
        padding: 12px;
        text-align: center;
    }
    
    .stat-value {
        font-family: 'Orbitron', sans-serif;
        font-size: 20px;
        font-weight: 700;
        color: var(--primary);
    }
    
    .stat-label {
        font-size: 11px;
        color: var(--text-muted);
        margin-top: 4px;
    }
    
    .quick-actions {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
        margin-bottom: 24px;
    }
    
    @media (max-width: 768px) {
        .quick-actions { grid-template-columns: repeat(2, 1fr); }
    }
    
    .quick-action {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: 0.2s;
    }
    
    .quick-action:hover {
        border-color: var(--primary);
        transform: translateY(-4px);
    }
    
    .quick-action.locked {
        opacity: 0.4;
        cursor: not-allowed;
    }
    
    .quick-action.locked:hover {
        transform: none;
        border-color: var(--border);
    }
    
    .quick-action-icon { font-size: 28px; margin-bottom: 8px; }
    .quick-action-label { font-size: 12px; color: var(--text-muted); }
    
    /* History */
    .history-entry {
        background: var(--bg-input);
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 12px;
        border-left: 3px solid var(--secondary);
    }
    
    .history-chapter {
        font-family: 'Orbitron', sans-serif;
        font-size: 11px;
        color: var(--accent);
        margin-bottom: 6px;
    }
    
    .history-title { font-weight: 700; margin-bottom: 8px; }
    .history-content { font-size: 13px; color: var(--text-muted); line-height: 1.6; }
    .history-time { font-size: 11px; color: var(--text-dark); margin-top: 8px; }
    
    /* World Canvas */
    #worldCanvas {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: 500;
        display: none;
    }
    
    #worldCanvas.active { display: block; }
    
    /* World UI */
    .world-ui {
        position: fixed;
        top: 0; left: 0; right: 0;
        padding: 20px;
        display: none;
        justify-content: space-between;
        align-items: flex-start;
        z-index: 600;
        pointer-events: none;
    }
    
    .world-ui.active { display: flex; }
    .world-ui > * { pointer-events: auto; }
    
    .world-left {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    
    .world-entropy-box {
        background: rgba(10, 10, 26, 0.9);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 16px 24px;
        backdrop-filter: blur(10px);
    }
    
    .world-entropy-label {
        font-family: 'Orbitron', sans-serif;
        font-size: 11px;
        color: var(--text-muted);
        letter-spacing: 2px;
    }
    
    .world-entropy-value {
        font-family: 'Orbitron', sans-serif;
        font-size: 32px;
        font-weight: 900;
        background: var(--gradient-energy);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    
    .world-nav-buttons {
        display: flex;
        gap: 8px;
    }
    
    .world-nav-btn {
        background: rgba(10, 10, 26, 0.9);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 10px 16px;
        color: var(--text);
        font-size: 13px;
        cursor: pointer;
        backdrop-filter: blur(10px);
        display: flex;
        align-items: center;
        gap: 6px;
        transition: 0.2s;
    }
    
    .world-nav-btn:hover {
        border-color: var(--primary);
        color: var(--primary);
    }
    
    .world-nav-btn.next-stage {
        background: var(--gradient-energy);
        color: #1a1a2e;
        border: none;
        font-weight: 700;
    }
    
    .world-nav-btn.next-stage:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .world-evo-panel {
        background: rgba(10, 10, 26, 0.9);
        border: 1px solid rgba(123, 44, 191, 0.3);
        border-radius: 16px;
        padding: 16px 20px;
        backdrop-filter: blur(10px);
        min-width: 200px;
    }
    
    .world-evo-title {
        font-family: 'Orbitron', sans-serif;
        font-size: 12px;
        color: var(--secondary);
        margin-bottom: 12px;
    }
    
    .world-evo-item {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 8px;
        opacity: 0.4;
    }
    
    .world-evo-item.unlocked { opacity: 1; }
    .world-evo-item.next { opacity: 0.7; }
    
    .world-evo-icon {
        width: 28px; height: 28px;
        background: rgba(123, 44, 191, 0.2);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
    }
    
    .world-evo-item.unlocked .world-evo-icon {
        background: var(--gradient-evolution);
    }
    
    .world-evo-name { font-size: 12px; font-weight: 600; }
    .world-evo-req { font-size: 10px; color: var(--text-muted); }
    
    .world-controls {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: rgba(10, 10, 26, 0.9);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px 16px;
        font-size: 11px;
        color: var(--text-dark);
        z-index: 600;
        display: none;
    }
    
    .world-controls.active { display: block; }
    .world-controls div { margin-bottom: 4px; }
    .world-controls .key {
        display: inline-block;
        padding: 2px 8px;
        background: var(--bg-input);
        border-radius: 4px;
        margin-right: 4px;
    }
    
    /* Stage 2 - Planet Landing */
    .landing-ui {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 600;
        pointer-events: none;
    }
    
    .landing-ui.active { display: flex; }
    .landing-ui > * { pointer-events: auto; }
    
    .landing-score {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(10, 10, 26, 0.9);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 16px 32px;
        text-align: center;
    }
    
    .landing-score-label {
        font-family: 'Orbitron', sans-serif;
        font-size: 11px;
        color: var(--text-muted);
        letter-spacing: 2px;
    }
    
    .landing-score-value {
        font-family: 'Orbitron', sans-serif;
        font-size: 28px;
        font-weight: 900;
        color: var(--primary);
    }
    
    .landing-health {
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(10, 10, 26, 0.9);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 16px 24px;
    }
    
    .landing-health-label {
        font-family: 'Orbitron', sans-serif;
        font-size: 11px;
        color: var(--text-muted);
        margin-bottom: 8px;
    }
    
    .landing-health-bar {
        width: 120px;
        height: 12px;
        background: rgba(255, 77, 109, 0.2);
        border-radius: 6px;
        overflow: hidden;
    }
    
    .landing-health-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--danger), var(--accent));
        transition: width 0.3s;
    }
    
    .landing-planet-info {
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(10, 10, 26, 0.9);
        border: 1px solid var(--secondary);
        border-radius: 16px;
        padding: 20px 40px;
        text-align: center;
    }
    
    .landing-planet-name {
        font-family: 'Orbitron', sans-serif;
        font-size: 24px;
        font-weight: 900;
        background: var(--gradient-evolution);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 4px;
    }
    
    .landing-planet-desc {
        font-size: 13px;
        color: var(--text-muted);
    }
    
    .landing-start-btn {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
    }
    
    /* Evolution Alert */
    .evo-alert {
        position: fixed;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%) scale(0);
        background: rgba(10, 10, 26, 0.95);
        border: 2px solid var(--secondary);
        border-radius: 24px;
        padding: 40px 60px;
        text-align: center;
        z-index: 700;
        opacity: 0;
        transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    
    .evo-alert.show {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
    }
    
    .evo-alert-icon { font-size: 64px; margin-bottom: 16px; }
    
    .evo-alert-title {
        font-family: 'Orbitron', sans-serif;
        font-size: 24px;
        font-weight: 900;
        background: var(--gradient-energy);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 8px;
    }
    
    .evo-alert-desc {
        font-size: 14px;
        color: var(--text-muted);
        margin-bottom: 12px;
    }
    
    .evo-alert-effect {
        padding: 10px 20px;
        background: rgba(0, 245, 212, 0.1);
        border-radius: 20px;
        font-size: 13px;
        color: var(--primary);
    }
    
    /* Result Modal */
    .result-modal {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 800;
    }
    
    .result-modal.active { display: flex; }
    
    .result-content {
        background: var(--bg-card-solid);
        border: 2px solid var(--primary);
        border-radius: 24px;
        padding: 40px 60px;
        text-align: center;
        max-width: 500px;
    }
    
    .result-icon { font-size: 80px; margin-bottom: 20px; }
    
    .result-title {
        font-family: 'Orbitron', sans-serif;
        font-size: 28px;
        font-weight: 900;
        margin-bottom: 12px;
    }
    
    .result-desc {
        font-size: 15px;
        color: var(--text-muted);
        margin-bottom: 24px;
        line-height: 1.6;
    }
    
    .result-planet {
        background: var(--bg-input);
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 24px;
    }
    
    .result-planet-name {
        font-family: 'Orbitron', sans-serif;
        font-size: 20px;
        font-weight: 700;
        color: var(--primary);
        margin-bottom: 4px;
    }
    
    .result-planet-type {
        font-size: 13px;
        color: var(--text-muted);
    }
    
    .result-buttons {
        display: flex;
        gap: 12px;
        justify-content: center;
    }
    
    /* Utilities */
    .hidden { display: none !important; }
    .text-center { text-align: center; }
    .text-muted { color: var(--text-muted); }
    .mb-8 { margin-bottom: 8px; }
    .mb-16 { margin-bottom: 16px; }
    .mb-24 { margin-bottom: 24px; }
    .mt-24 { margin-top: 24px; }
    </style>
</head>
<body>
    <div id="space-bg"></div>
    <div id="stars"></div>
    
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
        <div class="loading-text">INITIALIZING...</div>
    </div>
    
    <div id="app"></div>
    
    <canvas id="worldCanvas"></canvas>
    
    <!-- Cell World UI -->
    <div class="world-ui" id="cellUI">
        <div class="world-left">
            <div class="world-entropy-box">
                <div class="world-entropy-label">ENTROPY</div>
                <div class="world-entropy-value" id="cellEntropyValue">0</div>
            </div>
            <div class="world-nav-buttons">
                <button class="world-nav-btn" onclick="window.exitWorld()">ğŸ  í™ˆ</button>
                <button class="world-nav-btn next-stage" id="nextStageBtn" onclick="window.goToStage2()" disabled>ğŸš€ í–‰ì„± ë‚™í•˜</button>
            </div>
        </div>
        <div class="world-evo-panel" id="cellEvoPanel"></div>
    </div>
    
    <div class="world-controls" id="cellControls">
        <div><span class="key">W A S D</span> ì´ë™</div>
        <div><span class="key">ë§ˆìš°ìŠ¤</span> ë°©í–¥</div>
        <div><span class="key">SPACE</span> ëŒ€ì‹œ</div>
        <div><span class="key">ESC</span> í™ˆìœ¼ë¡œ</div>
    </div>
    
    <!-- Landing UI -->
    <div class="landing-ui" id="landingUI">
        <div class="landing-score">
            <div class="landing-score-label">DISTANCE</div>
            <div class="landing-score-value" id="landingDistance">0m</div>
        </div>
        <div class="landing-health">
            <div class="landing-health-label">SHIELD</div>
            <div class="landing-health-bar">
                <div class="landing-health-fill" id="landingHealthBar" style="width: 100%"></div>
            </div>
        </div>
        <div class="landing-planet-info" id="landingPlanetInfo">
            <div class="landing-planet-name" id="landingPlanetName">í–‰ì„± Q-7</div>
            <div class="landing-planet-desc">ëª©í‘œê¹Œì§€ ì§„ì…í•˜ì„¸ìš”</div>
        </div>
    </div>
    
    <!-- Result Modal -->
    <div class="result-modal" id="resultModal">
        <div class="result-content">
            <div class="result-icon" id="resultIcon">ğŸª</div>
            <div class="result-title" id="resultTitle">ì°©ë¥™ ì„±ê³µ!</div>
            <div class="result-desc" id="resultDesc">ìƒˆë¡œìš´ í–‰ì„±ì— ë„ì°©í–ˆìŠµë‹ˆë‹¤.</div>
            <div class="result-planet">
                <div class="result-planet-name" id="resultPlanetName">í–‰ì„± Q-7</div>
                <div class="result-planet-type" id="resultPlanetType">ìƒëª…ì²´ ì„œì‹ ê°€ëŠ¥ í–‰ì„±</div>
            </div>
            <div class="result-buttons">
                <button class="btn btn-primary" onclick="window.explorePlanet()">ğŸŒ í–‰ì„± íƒí—˜</button>
            </div>
        </div>
    </div>
    
    <div class="toast-container" id="toastContainer"></div>
    
    <div class="evo-alert" id="evoAlert">
        <div class="evo-alert-icon" id="evoAlertIcon">ğŸ‘ï¸</div>
        <div class="evo-alert-title" id="evoAlertTitle">ì§„í™”!</div>
        <div class="evo-alert-desc" id="evoAlertDesc">ìƒˆë¡œìš´ ëŠ¥ë ¥</div>
        <div class="evo-alert-effect" id="evoAlertEffect">íš¨ê³¼</div>
    </div>
    
    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    
    const firebaseConfig = {
        apiKey: "AIzaSyBwQjuqgWM4YKnqu_gzNbeCg5alrC-jVcQ",
        authDomain: "myco-737a0.firebaseapp.com",
        projectId: "myco-737a0",
        storageBucket: "myco-737a0.firebasestorage.app",
        messagingSenderId: "942571332540",
        appId: "1:942571332540:web:be0bb6fbdd32655501c1b9"
    };
    
    const fbApp = initializeApp(firebaseConfig);
    const db = getFirestore(fbApp);
    const auth = getAuth(fbApp);
    const googleProvider = new GoogleAuthProvider();
    
    // State
    const State = {
        user: null,
        userData: null,
        currentPage: 'login',
        game: {
            entropy: 0,
            stage: 1,
            evolution: { eye: false, arm: false, leg: false, brain: false, wing: false },
            currentPlanet: null,
            territories: [],
            history: []
        },
        
        async sync() {
            if (!this.user) return;
            try {
                await updateDoc(doc(db, 'users', this.user.uid), {
                    game: this.game,
                    updatedAt: serverTimestamp()
                });
            } catch (e) { console.error('Sync error:', e); }
        },
        
        async load() {
            if (!this.user) return;
            try {
                const snap = await getDoc(doc(db, 'users', this.user.uid));
                if (snap.exists()) {
                    const data = snap.data();
                    this.userData = data;
                    if (data.game) this.game = { ...this.game, ...data.game };
                }
            } catch (e) { console.error('Load error:', e); }
        }
    };
    
    // Planet Names
    const PLANET_NAMES = [
        'Kepler-22b', 'Proxima-B', 'Trappist-1e', 'Gliese-581g', 
        'HD-40307g', 'Tau-Ceti-e', 'Wolf-1061c', 'Ross-128b',
        'Luyten-B', 'K2-18b', 'TOI-700d', 'Teegarden-B'
    ];
    
    const PLANET_TYPES = [
        'ìƒëª…ì²´ ì„œì‹ ê°€ëŠ¥ í–‰ì„±', 'ì–¼ìŒ í–‰ì„±', 'ì‚¬ë§‰ í–‰ì„±', 'í•´ì–‘ í–‰ì„±',
        'í™”ì‚° í–‰ì„±', 'ê°€ìŠ¤ ê±°ì¸ì˜ ìœ„ì„±', 'ê³ ëŒ€ ë¬¸ëª… í”ì  í–‰ì„±'
    ];
    
    // Utils
    function createStars() {
        const c = document.getElementById('stars');
        c.innerHTML = '';
        for (let i = 0; i < 150; i++) {
            const s = document.createElement('div');
            s.className = 'star';
            s.style.cssText = `left:${Math.random()*100}%;top:${Math.random()*100}%;width:${Math.random()*2+1}px;height:${s.style.width};animation-delay:${Math.random()*3}s`;
            c.appendChild(s);
        }
    }
    
    function showToast(msg, type = 'info') {
        const c = document.getElementById('toastContainer');
        const icons = { success: 'âœ…', error: 'âŒ', info: 'â„¹ï¸' };
        const t = document.createElement('div');
        t.className = `toast ${type}`;
        t.innerHTML = `<span>${icons[type]}</span><span style="flex:1">${msg}</span>`;
        c.appendChild(t);
        setTimeout(() => t.remove(), 4000);
    }
    
    function showEvoAlert(icon, title, desc, effect) {
        const a = document.getElementById('evoAlert');
        document.getElementById('evoAlertIcon').textContent = icon;
        document.getElementById('evoAlertTitle').textContent = title;
        document.getElementById('evoAlertDesc').textContent = desc;
        document.getElementById('evoAlertEffect').textContent = effect;
        a.classList.add('show');
        setTimeout(() => a.classList.remove('show'), 2500);
    }
    
    function hideLoading() {
        document.getElementById('loadingScreen').classList.add('hidden');
    }
    
    function navigate(page) {
        State.currentPage = page;
        render();
    }
    
    function render() {
        const p = State.currentPage;
        if (p === 'login') renderLogin();
        else if (p === 'dashboard') renderDashboard();
        else if (p === 'cell-world') startCellWorld();
        else if (p === 'planet-landing') startPlanetLanding();
        else if (p === 'history') renderHistory();
        else if (p === 'planet') renderPlanet();
        else renderPlaceholder(p);
    }
    
    // Navbar
    function navbar() {
        const s = State.game.stage;
        return `
            <nav class="navbar">
                <div class="nav-logo" onclick="window.nav('dashboard')">BOKLUCK</div>
                <div class="nav-links">
                    <div class="nav-link ${State.currentPage==='dashboard'?'active':''}" onclick="window.nav('dashboard')">ğŸ  ëŒ€ì‹œë³´ë“œ</div>
                    <div class="nav-link ${s<2?'locked':''}" onclick="${s>=2?"window.nav('planet')":""}">ğŸª í–‰ì„± ${s<2?'ğŸ”’':''}</div>
                    <div class="nav-link ${s<3?'locked':''}">ğŸŒŒ ì€í•˜ ${s<3?'ğŸ”’':''}</div>
                    <div class="nav-link ${State.currentPage==='history'?'active':''}" onclick="window.nav('history')">ğŸ“œ ì—­ì‚¬ì„œ</div>
                </div>
                <div class="nav-right">
                    <div class="entropy-badge">
                        <div class="entropy-icon">âš¡</div>
                        <span class="entropy-value">${State.game.entropy.toLocaleString()}</span>
                    </div>
                    <div class="user-menu">
                        <div class="user-profile" onclick="toggleUserMenu()">
                            <img class="user-avatar" src="${State.user?.photoURL||'https://via.placeholder.com/36'}">
                            <span class="user-name">${State.user?.displayName||'User'}</span>
                        </div>
                        <div class="user-dropdown" id="userDropdown">
                            <div class="dropdown-item" onclick="window.nav('history')">ğŸ“œ ë‚´ ì—­ì‚¬ì„œ</div>
                            <div class="dropdown-item danger" onclick="window.logout()">ğŸšª ë¡œê·¸ì•„ì›ƒ</div>
                        </div>
                    </div>
                </div>
            </nav>
        `;
    }
    
    function toggleUserMenu() {
        document.getElementById('userDropdown').classList.toggle('show');
    }
    
    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.user-menu')) {
            const dropdown = document.getElementById('userDropdown');
            if (dropdown) dropdown.classList.remove('show');
        }
    });
    
    // Login
    function renderLogin() {
        document.getElementById('app').innerHTML = `
            <div class="login-page">
                <h1 class="login-logo">BOKLUCK</h1>
                <p class="login-subtitle">Universe</p>
                <div class="login-cell"></div>
                <p class="login-story">
                    ì–¸ì œì¸ì§€, ì™œì¸ì§€ ì•Œ ìˆ˜ ì—†ë‹¤.<br>
                    ë‚˜ëŠ” ê´‘í™œí•œ ìš°ì£¼ ì–´ë”˜ê°€ì—ì„œ<br>
                    í•˜ë‚˜ì˜ <strong>ì„¸í¬</strong>ë¡œ íƒœì–´ë‚¬ë‹¤.<br><br>
                    ì‚´ì•„ë‚¨ìœ¼ë ¤ë©´ <strong>ì—”íŠ¸ë¡œí”¼</strong>ë¥¼ ëª¨ì•„ì•¼ í•œë‹¤.
                </p>
                <button class="btn btn-google btn-lg" onclick="window.googleLogin()">
                    <img src="https://www.google.com/favicon.ico"> Googleë¡œ ì‹œì‘í•˜ê¸°
                </button>
                <div class="login-divider">ë˜ëŠ”</div>
                <p class="text-muted" style="font-size:13px">ê³„ì •ì´ ì—†ì–´ë„ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤</p>
            </div>
        `;
    }
    
    // Dashboard
    function renderDashboard() {
        const { stage, entropy, evolution, history } = State.game;
        const evoCount = Object.values(evolution).filter(v => v).length;
        
        document.getElementById('app').innerHTML = `
            ${navbar()}
            <main class="main-content">
                <div class="page-container">
                    <div class="stage-progress mb-24">
                        <div class="stage-dot ${stage>=1?(stage===1?'current':'completed'):'locked'}">ğŸ¦ </div>
                        <div class="stage-line ${stage>1?'completed':''}"></div>
                        <div class="stage-dot ${stage>=2?(stage===2?'current':'completed'):'locked'}">ğŸš€</div>
                        <div class="stage-line ${stage>2?'completed':''}"></div>
                        <div class="stage-dot ${stage>=3?(stage===3?'current':'completed'):'locked'}">ğŸ•ï¸</div>
                        <div class="stage-line ${stage>3?'completed':''}"></div>
                        <div class="stage-dot ${stage>=4?(stage===4?'current':'completed'):'locked'}">ğŸ›ï¸</div>
                        <div class="stage-line ${stage>4?'completed':''}"></div>
                        <div class="stage-dot ${stage>=5?'current':'locked'}">âš”ï¸</div>
                    </div>
                    
                    <div class="dashboard-grid">
                        <div class="card entity-card">
                            <div class="entity-visual"><canvas id="entityCanvas" width="180" height="180"></canvas></div>
                            <div class="entity-stage-label">STAGE ${stage} Â· ${['','ì„¸í¬','ì •ì°©','íƒí—˜','ë¬¸ëª…','ì •ë³µ'][stage]}</div>
                            <div class="entity-name">Entity #${State.user?.uid?.slice(-4)||'0000'}</div>
                            <div class="progress-bar mb-16"><div class="progress-fill" style="width:${Math.min(entropy/800*100,100)}%"></div></div>
                            <p class="text-muted text-center mb-24" style="font-size:12px">${stage===1?(entropy<800?`ë‹¤ìŒ ë‹¨ê³„ê¹Œì§€ ${800-entropy} ì—”íŠ¸ë¡œí”¼`:'ğŸ‰ í–‰ì„± ë‚™í•˜ ì¤€ë¹„ ì™„ë£Œ!'):'í–‰ì„±ì— ì •ì°©í–ˆìŠµë‹ˆë‹¤'}</p>
                            <div class="entity-stats">
                                <div class="stat-box"><div class="stat-value">${evoCount}/5</div><div class="stat-label">ì§„í™”</div></div>
                                <div class="stat-box"><div class="stat-value">${State.game.territories?.length||0}</div><div class="stat-label">ì˜í† </div></div>
                                <div class="stat-box"><div class="stat-value">+${(State.game.territories?.length||0)*5}</div><div class="stat-label">ì„¸ê¸ˆ</div></div>
                                <div class="stat-box"><div class="stat-value">1</div><div class="stat-label">ìƒì¡´</div></div>
                            </div>
                            ${stage===1?`
                                <button class="btn btn-primary btn-block mt-24" onclick="window.nav('cell-world')">ğŸŒŒ ì„¸í¬ ì„¸ê³„ë¡œ ì§„ì…</button>
                                ${entropy>=800?`<button class="btn btn-energy btn-block mt-24" onclick="window.nav('planet-landing')">ğŸš€ í–‰ì„±ìœ¼ë¡œ ë– ë‚˜ê¸°</button>`:''}
                            `:''}
                            ${stage>=2?`<button class="btn btn-primary btn-block mt-24" onclick="window.nav('planet')">ğŸª í–‰ì„± íƒí—˜</button>`:''}
                        </div>
                        
                        <div>
                            <div class="quick-actions">
                                <div class="quick-action" onclick="window.nav('cell-world')"><div class="quick-action-icon">ğŸ¦ </div><div class="quick-action-label">ì„¸í¬ ì„¸ê³„</div></div>
                                <div class="quick-action ${stage<2&&entropy<800?'locked':''}" onclick="${stage>=2||entropy>=800?"window.nav(stage>=2?'planet':'planet-landing')":""}"><div class="quick-action-icon">${stage>=2?'ğŸª':'ğŸš€'}</div><div class="quick-action-label">${stage>=2?'í–‰ì„±':'í–‰ì„± ë‚™í•˜'}</div></div>
                                <div class="quick-action ${stage<3?'locked':''}"><div class="quick-action-icon">ğŸŒŒ</div><div class="quick-action-label">ì€í•˜</div></div>
                                <div class="quick-action" onclick="window.nav('history')"><div class="quick-action-icon">ğŸ“œ</div><div class="quick-action-label">ì—­ì‚¬ì„œ</div></div>
                            </div>
                            <div class="card">
                                <div class="card-header">
                                    <span class="card-title">ğŸ“œ ë‚˜ì˜ ì—­ì‚¬ì„œ</span>
                                    <button class="btn btn-outline btn-sm" onclick="window.nav('history')">ì „ì²´</button>
                                </div>
                                ${(history||[]).length===0?`
                                    <div class="text-center text-muted" style="padding:40px">
                                        <p style="font-size:32px;margin-bottom:12px">ğŸ“œ</p>
                                        <p>ì•„ì§ ê¸°ë¡ëœ ì—­ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                                    </div>
                                `:(history||[]).slice(-3).reverse().map(e=>`
                                    <div class="history-entry">
                                        <div class="history-chapter">ì œ${e.chapter}ì¥</div>
                                        <div class="history-title">${e.title}</div>
                                        <div class="history-content">${e.content}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        `;
        
        animateEntity();
    }
    
    function animateEntity() {
        const canvas = document.getElementById('entityCanvas');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        const evo = State.game.evolution;
        let t = 0;
        
        function draw() {
            if (!document.getElementById('entityCanvas')) return;
            t += 0.05;
            ctx.clearRect(0, 0, 180, 180);
            const cx = 90, cy = 90, r = 35;
            
            ctx.beginPath();
            for (let i = 0; i < 12; i++) {
                const a = (i / 12) * Math.PI * 2;
                const w = Math.sin(t * 2 + i) * 5;
                const x = cx + Math.cos(a) * (r + w);
                const y = cy + Math.sin(a) * (r + w);
                i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
            }
            ctx.closePath();
            const g = ctx.createRadialGradient(cx - 15, cy - 15, 0, cx, cy, r + 10);
            g.addColorStop(0, '#00f5d4');
            g.addColorStop(0.6, '#7b2cbf');
            g.addColorStop(1, '#4c1d95');
            ctx.fillStyle = g;
            ctx.fill();
            
            if (evo.eye) {
                ctx.beginPath();
                ctx.arc(cx + 12, cy - 5, 10, 0, Math.PI * 2);
                ctx.fillStyle = 'white';
                ctx.fill();
                ctx.beginPath();
                ctx.arc(cx + 14, cy - 3, 5, 0, Math.PI * 2);
                ctx.fillStyle = '#1a1a2e';
                ctx.fill();
            }
            
            if (evo.arm) {
                ctx.strokeStyle = '#7b2cbf';
                ctx.lineWidth = 6;
                ctx.lineCap = 'round';
                ctx.beginPath();
                ctx.moveTo(cx + 35, cy);
                ctx.quadraticCurveTo(cx + 55, cy + Math.sin(t * 3) * 10, cx + 65, cy + 5);
                ctx.stroke();
            }
            
            if (evo.leg) {
                const lw = Math.sin(t * 4) * 8;
                ctx.strokeStyle = '#5b21b6';
                ctx.lineWidth = 8;
                ctx.beginPath();
                ctx.moveTo(cx - 10, cy + 35);
                ctx.lineTo(cx - 15 + lw, cy + 60);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(cx + 10, cy + 35);
                ctx.lineTo(cx + 15 - lw, cy + 60);
                ctx.stroke();
            }
            
            if (evo.brain) {
                ctx.beginPath();
                ctx.arc(cx, cy - 30, 12, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(254, 228, 64, ${Math.sin(t * 2) * 0.3 + 0.7})`;
                ctx.fill();
            }
            
            if (evo.wing) {
                const wf = Math.sin(t * 5) * 0.3;
                ctx.fillStyle = 'rgba(139, 92, 246, 0.6)';
                ctx.save();
                ctx.translate(cx, cy - 10);
                ctx.rotate(wf);
                ctx.beginPath();
                ctx.moveTo(5, 0);
                ctx.quadraticCurveTo(40, -30, 60, -10);
                ctx.quadraticCurveTo(40, 10, 5, 0);
                ctx.fill();
                ctx.restore();
                ctx.save();
                ctx.translate(cx, cy - 10);
                ctx.rotate(-wf);
                ctx.beginPath();
                ctx.moveTo(-5, 0);
                ctx.quadraticCurveTo(-40, -30, -60, -10);
                ctx.quadraticCurveTo(-40, 10, -5, 0);
                ctx.fill();
                ctx.restore();
            }
            
            requestAnimationFrame(draw);
        }
        draw();
    }
    
    // History
    function renderHistory() {
        const h = State.game.history || [];
        document.getElementById('app').innerHTML = `
            ${navbar()}
            <main class="main-content">
                <div class="page-container" style="max-width:800px">
                    <h1 class="font-display text-center mb-8" style="font-size:32px">ğŸ“œ ë‚˜ì˜ ì—­ì‚¬ì„œ</h1>
                    <p class="text-muted text-center mb-24">Entity #${State.user?.uid?.slice(-4)||'0000'}ì˜ ì—¬ì •</p>
                    ${h.length===0?`
                        <div class="card text-center" style="padding:60px">
                            <p style="font-size:48px;margin-bottom:16px">ğŸ“œ</p>
                            <p class="mb-8">ì•„ì§ ê¸°ë¡ëœ ì—­ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                            <button class="btn btn-primary mt-24" onclick="window.nav('cell-world')">ì„¸í¬ ì„¸ê³„ ì§„ì…</button>
                        </div>
                    `:h.map(e=>`
                        <div class="card mb-16">
                            <div class="history-chapter">ì œ${e.chapter}ì¥</div>
                            <h3 style="font-size:18px;font-weight:700">${e.title}</h3>
                            <p style="margin-top:12px;line-height:1.8;color:var(--text-muted)">${e.content}</p>
                        </div>
                    `).join('')}
                </div>
            </main>
        `;
    }
    
    // Planet Page
    function renderPlanet() {
        const planet = State.game.currentPlanet;
        document.getElementById('app').innerHTML = `
            ${navbar()}
            <main class="main-content">
                <div class="page-container">
                    <div class="card text-center" style="padding:60px;max-width:600px;margin:0 auto;">
                        <h1 style="font-size:64px;margin-bottom:24px">ğŸª</h1>
                        <h2 class="font-display mb-16" style="font-size:28px">${planet?.name || 'í–‰ì„±'}</h2>
                        <p class="text-muted mb-24">${planet?.type || 'ë¯¸ì§€ì˜ í–‰ì„±'}</p>
                        <div class="card mb-24" style="background:var(--bg-input)">
                            <p style="font-size:14px;line-height:1.8">
                                ë‹¹ì‹ ì€ ì´ í–‰ì„±ì˜ ì²« ë²ˆì§¸ ì •ì°©ìì…ë‹ˆë‹¤.<br>
                                ì˜í† ë¥¼ í™•ì¥í•˜ê³  ë¬¸ëª…ì„ ê±´ì„¤í•˜ì„¸ìš”.
                            </p>
                        </div>
                        <p class="text-muted" style="font-size:13px">ğŸš§ í–‰ì„± ì‹œìŠ¤í…œ ê°œë°œ ì¤‘...</p>
                        <button class="btn btn-outline mt-24" onclick="window.nav('dashboard')">ëŒ€ì‹œë³´ë“œë¡œ</button>
                    </div>
                </div>
            </main>
        `;
    }
    
    // Placeholder
    function renderPlaceholder(p) {
        document.getElementById('app').innerHTML = `
            ${navbar()}
            <main class="main-content">
                <div class="page-container text-center" style="padding-top:100px">
                    <h1 style="font-size:48px;margin-bottom:24px">ğŸ”’</h1>
                    <h2 class="font-display mb-16">${p}</h2>
                    <p class="text-muted mb-24">ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤...</p>
                    <button class="btn btn-outline" onclick="window.nav('dashboard')">ëŒ€ì‹œë³´ë“œë¡œ</button>
                </div>
            </main>
        `;
    }
    
    // ========================================
    // CELL WORLD
    // ========================================
    let worldRunning = false;
    
    function exitWorld() {
        worldRunning = false;
        document.getElementById('worldCanvas').classList.remove('active');
        document.getElementById('cellUI').classList.remove('active');
        document.getElementById('cellControls').classList.remove('active');
        document.getElementById('landingUI').classList.remove('active');
        navigate('dashboard');
    }
    
    function goToStage2() {
        if (State.game.entropy < 800) return;
        worldRunning = false;
        document.getElementById('worldCanvas').classList.remove('active');
        document.getElementById('cellUI').classList.remove('active');
        document.getElementById('cellControls').classList.remove('active');
        navigate('planet-landing');
    }
    
    function startCellWorld() {
        console.log('Starting Cell World');
        
        document.getElementById('app').innerHTML = '';
        
        const canvas = document.getElementById('worldCanvas');
        const ctx = canvas.getContext('2d');
        
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        canvas.classList.add('active');
        
        document.getElementById('cellUI').classList.add('active');
        document.getElementById('cellControls').classList.add('active');
        
        worldRunning = true;
        
        const player = {
            x: 0, y: 0,
            vx: 0, vy: 0,
            baseSize: 30,
            size: 30 + State.game.entropy * 0.03,
            speed: State.game.evolution.leg ? 5 : 3,
            visionRange: State.game.evolution.eye ? 500 : 300,
            collectRange: State.game.evolution.arm ? 100 : 50,
            multiplier: State.game.evolution.brain ? 2 : 1,
            wobblePoints: [],
            wobblePhase: 0,
            dashing: false,
            dashCD: 0
        };
        
        for (let i = 0; i < 12; i++) {
            player.wobblePoints.push({
                angle: (i / 12) * Math.PI * 2,
                offset: 0,
                speed: 0.5 + Math.random() * 0.5
            });
        }
        
        let particles = [];
        const camera = { x: 0, y: 0 };
        const keys = {};
        let mouseX = canvas.width / 2, mouseY = canvas.height / 2;
        let useMouse = false;
        let time = 0;
        
        function onKeyDown(e) {
            keys[e.key.toLowerCase()] = true;
            useMouse = false;
            if (e.code === 'Space' && State.game.evolution.wing && player.dashCD <= 0) {
                player.dashing = true;
                player.dashCD = 60;
                setTimeout(() => player.dashing = false, 200);
            }
            if (e.key === 'Escape') exitWorld();
        }
        
        function onKeyUp(e) { keys[e.key.toLowerCase()] = false; }
        function onMouseMove(e) { mouseX = e.clientX; mouseY = e.clientY; useMouse = true; }
        function onResize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        
        window.addEventListener('keydown', onKeyDown);
        window.addEventListener('keyup', onKeyUp);
        window.addEventListener('mousemove', onMouseMove);
        window.addEventListener('resize', onResize);
        
        function cleanup() {
            window.removeEventListener('keydown', onKeyDown);
            window.removeEventListener('keyup', onKeyUp);
            window.removeEventListener('mousemove', onMouseMove);
            window.removeEventListener('resize', onResize);
        }
        
        function updateEvoPanel() {
            const evo = State.game.evolution;
            const e = State.game.entropy;
            document.getElementById('cellEvoPanel').innerHTML = `
                <div class="world-evo-title">ğŸ§¬ ì§„í™” ë‹¨ê³„</div>
                <div class="world-evo-item ${evo.eye?'unlocked':(e>=80?'next':'')}"><div class="world-evo-icon">ğŸ‘ï¸</div><div><div class="world-evo-name">ì‹œê°</div><div class="world-evo-req">${evo.eye?'âœ“':'100'}</div></div></div>
                <div class="world-evo-item ${evo.arm?'unlocked':(e>=180&&evo.eye?'next':'')}"><div class="world-evo-icon">ğŸ¦¾</div><div><div class="world-evo-name">íŒ”</div><div class="world-evo-req">${evo.arm?'âœ“':'200'}</div></div></div>
                <div class="world-evo-item ${evo.leg?'unlocked':(e>=280&&evo.arm?'next':'')}"><div class="world-evo-icon">ğŸ¦µ</div><div><div class="world-evo-name">ë‹¤ë¦¬</div><div class="world-evo-req">${evo.leg?'âœ“':'300'}</div></div></div>
                <div class="world-evo-item ${evo.brain?'unlocked':(e>=480&&evo.leg?'next':'')}"><div class="world-evo-icon">ğŸ§ </div><div><div class="world-evo-name">ë‘ë‡Œ</div><div class="world-evo-req">${evo.brain?'âœ“':'500'}</div></div></div>
                <div class="world-evo-item ${evo.wing?'unlocked':(e>=780&&evo.brain?'next':'')}"><div class="world-evo-icon">ğŸª½</div><div><div class="world-evo-name">ë‚ ê°œ</div><div class="world-evo-req">${evo.wing?'âœ“':'800'}</div></div></div>
            `;
            
            // Update next stage button
            const btn = document.getElementById('nextStageBtn');
            if (State.game.entropy >= 800) {
                btn.disabled = false;
            }
        }
        updateEvoPanel();
        
        function spawn() {
            const count = State.game.evolution.eye ? 150 : 80;
            while (particles.length < count) {
                const a = Math.random() * Math.PI * 2;
                const d = 100 + Math.random() * (player.visionRange + 300);
                particles.push({
                    x: player.x + Math.cos(a) * d,
                    y: player.y + Math.sin(a) * d,
                    size: 5 + Math.random() * 12,
                    value: 1 + Math.floor(Math.random() * 3),
                    pulse: Math.random() * Math.PI * 2,
                    hue: 160 + Math.random() * 60
                });
            }
        }
        
        async function checkEvo() {
            const e = State.game.entropy;
            const evo = State.game.evolution;
            
            if (!evo.eye && e >= 100) {
                State.game.evolution.eye = true;
                player.visionRange = 500;
                showEvoAlert('ğŸ‘ï¸', 'ì‹œê° ê¸°ê´€ ì§„í™”!', 'ëˆˆì´ ìƒê²¨ë‚¬ìŠµë‹ˆë‹¤', 'ì‹œì•¼ +66%');
                State.game.history = State.game.history || [];
                State.game.history.push({ chapter: 1, title: 'ì²« ë²ˆì§¸ ëˆˆ', content: '100 ì—”íŠ¸ë¡œí”¼ë¥¼ í¡ìˆ˜í•˜ì, ì„¸ìƒì´ ë³´ì´ê¸° ì‹œì‘í–ˆë‹¤.', timestamp: new Date().toISOString() });
                updateEvoPanel();
            }
            if (!evo.arm && e >= 200) {
                State.game.evolution.arm = true;
                player.collectRange = 100;
                showEvoAlert('ğŸ¦¾', 'ìˆ˜ì§‘ íŒ” ì§„í™”!', 'íŒ”ì´ ìƒê²¨ë‚¬ìŠµë‹ˆë‹¤', 'ìˆ˜ì§‘ +100%');
                State.game.history.push({ chapter: 2, title: 'ì²« ë²ˆì§¸ íŒ”', content: '200 ì—”íŠ¸ë¡œí”¼ì˜ í˜ìœ¼ë¡œ ì´‰ìˆ˜ê°€ ìë¼ë‚¬ë‹¤.', timestamp: new Date().toISOString() });
                updateEvoPanel();
            }
            if (!evo.leg && e >= 300) {
                State.game.evolution.leg = true;
                player.speed = 5;
                showEvoAlert('ğŸ¦µ', 'ì´ë™ ê¸°ê´€ ì§„í™”!', 'ë‹¤ë¦¬ê°€ ìƒê²¨ë‚¬ìŠµë‹ˆë‹¤', 'ì†ë„ +66%');
                State.game.history.push({ chapter: 3, title: 'ì´ë™ì˜ ììœ ', content: '300 ì—”íŠ¸ë¡œí”¼ê°€ ëª¨ì´ì ë‹¤ë¦¬ê°€ ìƒê²¨ë‚¬ë‹¤.', timestamp: new Date().toISOString() });
                updateEvoPanel();
            }
            if (!evo.brain && e >= 500) {
                State.game.evolution.brain = true;
                player.multiplier = 2;
                showEvoAlert('ğŸ§ ', 'ë‘ë‡Œ ì§„í™”!', 'ì§€ëŠ¥ì´ ë°œë‹¬í–ˆìŠµë‹ˆë‹¤', 'íšë“ 2ë°°');
                State.game.history.push({ chapter: 4, title: 'ì§€ì„±ì˜ ë¶ˆê½ƒ', content: '500 ì—”íŠ¸ë¡œí”¼... ì˜ì‹ì´ í™•ì¥ë˜ì—ˆë‹¤.', timestamp: new Date().toISOString() });
                updateEvoPanel();
            }
            if (!evo.wing && e >= 800) {
                State.game.evolution.wing = true;
                showEvoAlert('ğŸª½', 'ë‚ ê°œ ì§„í™”!', 'ë‚ ê°œê°€ ìƒê²¨ë‚¬ìŠµë‹ˆë‹¤', 'SPACE ëŒ€ì‹œ');
                State.game.history.push({ chapter: 5, title: 'ìš°ì£¼ë¥¼ í–¥í•´', content: '800 ì—”íŠ¸ë¡œí”¼ì˜ ì •ì ì—ì„œ ë‚ ê°œê°€ í¼ì³ì¡Œë‹¤. ì´ì œ ìƒˆë¡œìš´ ì„¸ê³„ë¡œ ë– ë‚  ì¤€ë¹„ê°€ ë˜ì—ˆë‹¤.', timestamp: new Date().toISOString() });
                updateEvoPanel();
                showToast('ğŸ‰ ëª¨ë“  ì§„í™” ì™„ë£Œ! í–‰ì„±ìœ¼ë¡œ ë– ë‚  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'success');
            }
            
            player.size = player.baseSize + e * 0.03;
            if (player.size > 80) player.size = 80;
            
            await State.sync();
        }
        
        function update() {
            let mx = 0, my = 0;
            
            if (useMouse) {
                const dx = mouseX - canvas.width / 2;
                const dy = mouseY - canvas.height / 2;
                const d = Math.sqrt(dx * dx + dy * dy);
                if (d > 30) { mx = dx / d; my = dy / d; }
            } else {
                if (keys['w'] || keys['arrowup']) my = -1;
                if (keys['s'] || keys['arrowdown']) my = 1;
                if (keys['a'] || keys['arrowleft']) mx = -1;
                if (keys['d'] || keys['arrowright']) mx = 1;
                if (mx && my) { mx *= 0.707; my *= 0.707; }
            }
            
            let spd = player.speed;
            if (player.dashing) spd *= 3;
            
            player.vx = mx * spd;
            player.vy = my * spd;
            player.x += player.vx;
            player.y += player.vy;
            
            if (player.dashCD > 0) player.dashCD--;
            
            camera.x += (player.x - camera.x) * 0.1;
            camera.y += (player.y - camera.y) * 0.1;
            
            player.wobblePhase += 0.1;
            player.wobblePoints.forEach((p, i) => {
                const mf = Math.sqrt(player.vx * player.vx + player.vy * player.vy) * 0.5;
                p.offset = Math.sin(player.wobblePhase * p.speed + i) * (5 + mf);
            });
        }
        
        function collect() {
            particles = particles.filter(p => {
                const dx = p.x - player.x;
                const dy = p.y - player.y;
                const d = Math.sqrt(dx * dx + dy * dy);
                
                if (d < player.collectRange + p.size) {
                    State.game.entropy += p.value * player.multiplier;
                    document.getElementById('cellEntropyValue').textContent = State.game.entropy;
                    checkEvo();
                    return false;
                }
                
                if (State.game.evolution.arm && d < player.collectRange * 2) {
                    p.x -= dx * 0.05;
                    p.y -= dy * 0.05;
                }
                
                return true;
            });
        }
        
        function drawBg() {
            const g = ctx.createRadialGradient(canvas.width/2, canvas.height/2, 0, canvas.width/2, canvas.height/2, canvas.width);
            g.addColorStop(0, '#0a0a1a');
            g.addColorStop(1, '#050510');
            ctx.fillStyle = g;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = 'rgba(255,255,255,0.5)';
            for (let i = 0; i < 100; i++) {
                const x = ((i * 137.5 + camera.x * 0.1) % canvas.width + canvas.width) % canvas.width;
                const y = ((i * 73.7 + camera.y * 0.1) % canvas.height + canvas.height) % canvas.height;
                ctx.beginPath();
                ctx.arc(x, y, (Math.sin(time * 0.02 + i) + 1) * 1.2, 0, Math.PI * 2);
                ctx.fill();
            }
        }
        
        function drawParticles() {
            particles.forEach(p => {
                const sx = canvas.width / 2 + (p.x - camera.x);
                const sy = canvas.height / 2 + (p.y - camera.y);
                const d = Math.sqrt((p.x - player.x) ** 2 + (p.y - player.y) ** 2);
                
                if (d > player.visionRange && !State.game.evolution.eye) return;
                ctx.globalAlpha = d > player.visionRange ? 0.3 : 1;
                
                p.pulse += 0.05;
                const sz = p.size * (Math.sin(p.pulse) * 0.3 + 1);
                
                const g = ctx.createRadialGradient(sx, sy, 0, sx, sy, sz);
                g.addColorStop(0, `hsla(${p.hue}, 100%, 70%, 1)`);
                g.addColorStop(0.5, `hsla(${p.hue}, 100%, 50%, 0.8)`);
                g.addColorStop(1, `hsla(${p.hue}, 100%, 50%, 0)`);
                
                ctx.beginPath();
                ctx.arc(sx, sy, sz, 0, Math.PI * 2);
                ctx.fillStyle = g;
                ctx.fill();
                ctx.globalAlpha = 1;
            });
        }
        
        function drawPlayer() {
            const sx = canvas.width / 2;
            const sy = canvas.height / 2;
            
            ctx.save();
            ctx.translate(sx, sy);
            
            if (player.dashing) { ctx.shadowColor = '#00f5d4'; ctx.shadowBlur = 50; }
            
            ctx.beginPath();
            player.wobblePoints.forEach((p, i) => {
                const r = player.size + p.offset;
                const x = Math.cos(p.angle) * r;
                const y = Math.sin(p.angle) * r;
                i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
            });
            ctx.closePath();
            
            const g = ctx.createRadialGradient(-player.size * 0.3, -player.size * 0.3, 0, 0, 0, player.size * 1.2);
            g.addColorStop(0, '#00f5d4');
            g.addColorStop(0.5, '#7b2cbf');
            g.addColorStop(1, '#4c1d95');
            ctx.fillStyle = g;
            ctx.fill();
            
            ctx.beginPath();
            ctx.arc(-player.size * 0.2, -player.size * 0.2, player.size * 0.2, 0, Math.PI * 2);
            ctx.fillStyle = 'rgba(255,255,255,0.2)';
            ctx.fill();
            
            if (State.game.evolution.eye) {
                const ex = player.size * 0.3, ey = -player.size * 0.1, es = player.size * 0.22;
                ctx.beginPath();
                ctx.arc(ex, ey, es, 0, Math.PI * 2);
                ctx.fillStyle = '#fff';
                ctx.fill();
                ctx.beginPath();
                ctx.arc(ex + player.vx * 2, ey + player.vy * 2, es * 0.5, 0, Math.PI * 2);
                ctx.fillStyle = '#1a1a2e';
                ctx.fill();
            }
            
            if (State.game.evolution.arm) {
                ctx.strokeStyle = '#7b2cbf';
                ctx.lineWidth = player.size * 0.12;
                ctx.lineCap = 'round';
                ctx.beginPath();
                ctx.moveTo(player.size * 0.7, player.size * 0.1);
                ctx.quadraticCurveTo(player.size * 1.2, player.size * 0.3 + Math.sin(time * 0.15) * 8, player.size * 1.4, player.size * 0.2);
                ctx.stroke();
            }
            
            if (State.game.evolution.leg) {
                const lw = Math.sin(time * 0.2) * 10;
                ctx.strokeStyle = '#5b21b6';
                ctx.lineWidth = player.size * 0.15;
                ctx.beginPath();
                ctx.moveTo(player.size * 0.2, player.size * 0.7);
                ctx.lineTo(player.size * 0.15 + lw, player.size * 1.3);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(-player.size * 0.2, player.size * 0.7);
                ctx.lineTo(-player.size * 0.15 - lw, player.size * 1.3);
                ctx.stroke();
            }
            
            if (State.game.evolution.brain) {
                ctx.beginPath();
                ctx.arc(0, -player.size * 0.45, player.size * 0.2, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(254, 228, 64, ${Math.sin(time * 0.1) * 0.3 + 0.7})`;
                ctx.fill();
            }
            
            if (State.game.evolution.wing) {
                const wf = Math.sin(time * 0.3) * 0.3;
                ctx.fillStyle = 'rgba(139, 92, 246, 0.5)';
                ctx.save();
                ctx.rotate(wf - 0.4);
                ctx.beginPath();
                ctx.moveTo(player.size * 0.4, -player.size * 0.2);
                ctx.quadraticCurveTo(player.size * 1.3, -player.size * 0.7, player.size * 1.8, -player.size * 0.15);
                ctx.quadraticCurveTo(player.size * 1.3, player.size * 0.1, player.size * 0.4, -player.size * 0.05);
                ctx.fill();
                ctx.restore();
                ctx.save();
                ctx.scale(-1, 1);
                ctx.rotate(wf - 0.4);
                ctx.beginPath();
                ctx.moveTo(player.size * 0.4, -player.size * 0.2);
                ctx.quadraticCurveTo(player.size * 1.3, -player.size * 0.7, player.size * 1.8, -player.size * 0.15);
                ctx.quadraticCurveTo(player.size * 1.3, player.size * 0.1, player.size * 0.4, -player.size * 0.05);
                ctx.fill();
                ctx.restore();
            }
            
            ctx.restore();
        }
        
        function loop() {
            if (!worldRunning) { cleanup(); return; }
            time++;
            update();
            spawn();
            collect();
            drawBg();
            drawParticles();
            drawPlayer();
            requestAnimationFrame(loop);
        }
        
        // Initial particles
        for (let i = 0; i < 60; i++) {
            const a = Math.random() * Math.PI * 2;
            const d = 50 + Math.random() * 300;
            particles.push({
                x: Math.cos(a) * d,
                y: Math.sin(a) * d,
                size: 5 + Math.random() * 12,
                value: 1 + Math.floor(Math.random() * 3),
                pulse: Math.random() * Math.PI * 2,
                hue: 160 + Math.random() * 60
            });
        }
        
        document.getElementById('cellEntropyValue').textContent = State.game.entropy;
        loop();
    }
    
    // ========================================
    // PLANET LANDING (Stage 2)
    // ========================================
    function startPlanetLanding() {
        console.log('Starting Planet Landing');
        
        document.getElementById('app').innerHTML = '';
        
        const canvas = document.getElementById('worldCanvas');
        const ctx = canvas.getContext('2d');
        
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        canvas.classList.add('active');
        
        document.getElementById('landingUI').classList.add('active');
        
        worldRunning = true;
        
        // Generate random planet
        const targetPlanet = {
            name: PLANET_NAMES[Math.floor(Math.random() * PLANET_NAMES.length)],
            type: PLANET_TYPES[Math.floor(Math.random() * PLANET_TYPES.length)]
        };
        
        document.getElementById('landingPlanetName').textContent = targetPlanet.name;
        
        // Player
        const player = {
            x: canvas.width / 2,
            y: 100,
            size: 30,
            health: 100,
            speed: 8
        };
        
        // Obstacles
        let obstacles = [];
        let distance = 0;
        let targetDistance = 3000;
        let gameOver = false;
        let success = false;
        let time = 0;
        
        const keys = {};
        
        function onKeyDown(e) {
            keys[e.key.toLowerCase()] = true;
            if (e.key === 'Escape') {
                worldRunning = false;
                exitLanding();
            }
        }
        
        function onKeyUp(e) { keys[e.key.toLowerCase()] = false; }
        
        function onResize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            player.x = Math.min(player.x, canvas.width - 50);
        }
        
        window.addEventListener('keydown', onKeyDown);
        window.addEventListener('keyup', onKeyUp);
        window.addEventListener('resize', onResize);
        
        function cleanup() {
            window.removeEventListener('keydown', onKeyDown);
            window.removeEventListener('keyup', onKeyUp);
            window.removeEventListener('resize', onResize);
        }
        
        function exitLanding() {
            cleanup();
            canvas.classList.remove('active');
            document.getElementById('landingUI').classList.remove('active');
            document.getElementById('resultModal').classList.remove('active');
            navigate('dashboard');
        }
        
        function spawnObstacle() {
            const type = Math.random();
            let obstacle;
            
            if (type < 0.4) {
                // Asteroid
                obstacle = {
                    type: 'asteroid',
                    x: Math.random() * (canvas.width - 60) + 30,
                    y: canvas.height + 50,
                    size: 20 + Math.random() * 30,
                    speed: 3 + Math.random() * 3,
                    rotation: 0,
                    rotSpeed: (Math.random() - 0.5) * 0.1
                };
            } else if (type < 0.7) {
                // Energy barrier
                const width = 100 + Math.random() * 200;
                obstacle = {
                    type: 'barrier',
                    x: Math.random() * (canvas.width - width),
                    y: canvas.height + 30,
                    width: width,
                    height: 20,
                    speed: 4 + Math.random() * 2
                };
            } else {
                // Debris field
                obstacle = {
                    type: 'debris',
                    x: Math.random() * canvas.width,
                    y: canvas.height + 50,
                    particles: Array(5).fill(0).map(() => ({
                        ox: (Math.random() - 0.5) * 100,
                        oy: (Math.random() - 0.5) * 50,
                        size: 5 + Math.random() * 10
                    })),
                    speed: 5 + Math.random() * 3
                };
            }
            
            obstacles.push(obstacle);
        }
        
        function update() {
            if (gameOver) return;
            
            // Player movement
            if (keys['a'] || keys['arrowleft']) {
                player.x -= player.speed;
            }
            if (keys['d'] || keys['arrowright']) {
                player.x += player.speed;
            }
            
            player.x = Math.max(player.size, Math.min(canvas.width - player.size, player.x));
            
            // Update distance
            distance += 5;
            document.getElementById('landingDistance').textContent = `${Math.floor(distance)}m / ${targetDistance}m`;
            
            // Spawn obstacles
            if (Math.random() < 0.03 + (distance / targetDistance) * 0.02) {
                spawnObstacle();
            }
            
            // Update obstacles
            obstacles = obstacles.filter(o => {
                o.y -= o.speed;
                if (o.rotation !== undefined) o.rotation += o.rotSpeed;
                
                // Collision check
                let hit = false;
                
                if (o.type === 'asteroid') {
                    const dx = player.x - o.x;
                    const dy = player.y - o.y;
                    if (Math.sqrt(dx*dx + dy*dy) < player.size + o.size) {
                        hit = true;
                    }
                } else if (o.type === 'barrier') {
                    if (player.x > o.x - player.size && 
                        player.x < o.x + o.width + player.size &&
                        player.y > o.y - player.size &&
                        player.y < o.y + o.height + player.size) {
                        hit = true;
                    }
                } else if (o.type === 'debris') {
                    o.particles.forEach(p => {
                        const dx = player.x - (o.x + p.ox);
                        const dy = player.y - (o.y + p.oy);
                        if (Math.sqrt(dx*dx + dy*dy) < player.size + p.size) {
                            hit = true;
                        }
                    });
                }
                
                if (hit) {
                    player.health -= 20;
                    document.getElementById('landingHealthBar').style.width = player.health + '%';
                    
                    if (player.health <= 0) {
                        gameOver = true;
                        success = false;
                        showResult(false, targetPlanet);
                    }
                    return false;
                }
                
                return o.y > -100;
            });
            
            // Check success
            if (distance >= targetDistance) {
                gameOver = true;
                success = true;
                showResult(true, targetPlanet);
            }
        }
        
        function showResult(isSuccess, planet) {
            setTimeout(() => {
                const modal = document.getElementById('resultModal');
                
                if (isSuccess) {
                    document.getElementById('resultIcon').textContent = 'ğŸª';
                    document.getElementById('resultTitle').textContent = 'ì°©ë¥™ ì„±ê³µ!';
                    document.getElementById('resultDesc').textContent = 'ìƒˆë¡œìš´ í–‰ì„±ì— ë¬´ì‚¬íˆ ë„ì°©í–ˆìŠµë‹ˆë‹¤. ì´ì œ ì´ í–‰ì„±ì„ íƒí—˜í•˜ê³  ì •ì°©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
                    document.getElementById('resultPlanetName').textContent = planet.name;
                    document.getElementById('resultPlanetType').textContent = planet.type;
                    
                    // Save planet
                    State.game.currentPlanet = planet;
                    State.game.stage = 2;
                    State.game.history.push({
                        chapter: State.game.history.length + 1,
                        title: 'ìƒˆë¡œìš´ ì„¸ê³„',
                        content: `ì˜¤ëœ ì—¬ì • ëì— ${planet.name}ì— ì°©ë¥™í–ˆë‹¤. ${planet.type}... ì´ê³³ì—ì„œ ìƒˆë¡œìš´ ì‚¶ì´ ì‹œì‘ëœë‹¤.`,
                        timestamp: new Date().toISOString()
                    });
                    State.sync();
                } else {
                    document.getElementById('resultIcon').textContent = 'ğŸ’¥';
                    document.getElementById('resultTitle').textContent = 'ì°©ë¥™ ì‹¤íŒ¨';
                    document.getElementById('resultDesc').textContent = 'ì¥ì• ë¬¼ì— ë¶€ë”ªí˜€ ì¶”ë½í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.';
                    document.getElementById('resultPlanetName').textContent = '???';
                    document.getElementById('resultPlanetType').textContent = 'ë‹¤ì‹œ ë„ì „í•˜ì„¸ìš”';
                }
                
                modal.classList.add('active');
            }, 500);
        }
        
        function drawBackground() {
            // Space gradient
            const g = ctx.createLinearGradient(0, 0, 0, canvas.height);
            g.addColorStop(0, '#050510');
            g.addColorStop(0.7, '#0a0a2a');
            g.addColorStop(1, '#1a1a4a');
            ctx.fillStyle = g;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Stars (moving down)
            ctx.fillStyle = 'rgba(255,255,255,0.6)';
            for (let i = 0; i < 50; i++) {
                const x = (i * 137.5) % canvas.width;
                const y = ((i * 73.7 + distance * 0.5) % canvas.height);
                ctx.beginPath();
                ctx.arc(x, y, 1 + Math.random(), 0, Math.PI * 2);
                ctx.fill();
            }
            
            // Planet at bottom
            const planetProgress = Math.min(distance / targetDistance, 1);
            const planetSize = 200 + planetProgress * 300;
            const planetY = canvas.height + 200 - planetProgress * 300;
            
            const pg = ctx.createRadialGradient(
                canvas.width/2 - planetSize * 0.2, planetY - planetSize * 0.2, 0,
                canvas.width/2, planetY, planetSize
            );
            pg.addColorStop(0, '#4ade80');
            pg.addColorStop(0.5, '#22c55e');
            pg.addColorStop(0.8, '#15803d');
            pg.addColorStop(1, '#14532d');
            
            ctx.beginPath();
            ctx.arc(canvas.width/2, planetY, planetSize, 0, Math.PI * 2);
            ctx.fillStyle = pg;
            ctx.fill();
            
            // Atmosphere glow
            ctx.beginPath();
            ctx.arc(canvas.width/2, planetY, planetSize + 30, 0, Math.PI * 2);
            const ag = ctx.createRadialGradient(
                canvas.width/2, planetY, planetSize,
                canvas.width/2, planetY, planetSize + 30
            );
            ag.addColorStop(0, 'rgba(74, 222, 128, 0.3)');
            ag.addColorStop(1, 'rgba(74, 222, 128, 0)');
            ctx.fillStyle = ag;
            ctx.fill();
        }
        
        function drawObstacles() {
            obstacles.forEach(o => {
                if (o.type === 'asteroid') {
                    ctx.save();
                    ctx.translate(o.x, o.y);
                    ctx.rotate(o.rotation);
                    
                    const ag = ctx.createRadialGradient(0, 0, 0, 0, 0, o.size);
                    ag.addColorStop(0, '#6b7280');
                    ag.addColorStop(0.7, '#4b5563');
                    ag.addColorStop(1, '#374151');
                    
                    ctx.beginPath();
                    for (let i = 0; i < 8; i++) {
                        const angle = (i / 8) * Math.PI * 2;
                        const r = o.size * (0.8 + Math.sin(i * 2.5) * 0.2);
                        const x = Math.cos(angle) * r;
                        const y = Math.sin(angle) * r;
                        i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
                    }
                    ctx.closePath();
                    ctx.fillStyle = ag;
                    ctx.fill();
                    ctx.restore();
                    
                } else if (o.type === 'barrier') {
                    const bg = ctx.createLinearGradient(o.x, o.y, o.x + o.width, o.y);
                    bg.addColorStop(0, 'rgba(239, 68, 68, 0.8)');
                    bg.addColorStop(0.5, 'rgba(248, 113, 113, 0.9)');
                    bg.addColorStop(1, 'rgba(239, 68, 68, 0.8)');
                    
                    ctx.fillStyle = bg;
                    ctx.fillRect(o.x, o.y, o.width, o.height);
                    
                    // Glow
                    ctx.shadowColor = '#ef4444';
                    ctx.shadowBlur = 20;
                    ctx.fillRect(o.x, o.y, o.width, o.height);
                    ctx.shadowBlur = 0;
                    
                } else if (o.type === 'debris') {
                    o.particles.forEach(p => {
                        ctx.beginPath();
                        ctx.arc(o.x + p.ox, o.y + p.oy, p.size, 0, Math.PI * 2);
                        ctx.fillStyle = '#78716c';
                        ctx.fill();
                    });
                }
            });
        }
        
        function drawPlayer() {
            const wobble = Math.sin(time * 0.2) * 2;
            
            ctx.save();
            ctx.translate(player.x, player.y);
            
            // Glow
            ctx.shadowColor = '#00f5d4';
            ctx.shadowBlur = 30;
            
            // Body
            ctx.beginPath();
            for (let i = 0; i < 12; i++) {
                const angle = (i / 12) * Math.PI * 2;
                const r = player.size + Math.sin(time * 0.3 + i) * 3;
                const x = Math.cos(angle) * r;
                const y = Math.sin(angle) * r;
                i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
            }
            ctx.closePath();
            
            const g = ctx.createRadialGradient(-10, -10, 0, 0, 0, player.size);
            g.addColorStop(0, '#00f5d4');
            g.addColorStop(0.6, '#7b2cbf');
            g.addColorStop(1, '#4c1d95');
            ctx.fillStyle = g;
            ctx.fill();
            
            ctx.shadowBlur = 0;
            
            // Eye
            ctx.beginPath();
            ctx.arc(8, -3, 8, 0, Math.PI * 2);
            ctx.fillStyle = 'white';
            ctx.fill();
            ctx.beginPath();
            ctx.arc(10, -2, 4, 0, Math.PI * 2);
            ctx.fillStyle = '#1a1a2e';
            ctx.fill();
            
            // Wings (flapping)
            const wingFlap = Math.sin(time * 0.5) * 0.4;
            ctx.fillStyle = 'rgba(139, 92, 246, 0.6)';
            
            ctx.save();
            ctx.rotate(wingFlap - 0.5);
            ctx.beginPath();
            ctx.moveTo(10, -5);
            ctx.quadraticCurveTo(40, -25, 55, -5);
            ctx.quadraticCurveTo(40, 5, 10, 0);
            ctx.fill();
            ctx.restore();
            
            ctx.save();
            ctx.scale(-1, 1);
            ctx.rotate(wingFlap - 0.5);
            ctx.beginPath();
            ctx.moveTo(10, -5);
            ctx.quadraticCurveTo(40, -25, 55, -5);
            ctx.quadraticCurveTo(40, 5, 10, 0);
            ctx.fill();
            ctx.restore();
            
            ctx.restore();
            
            // Trail effect
            ctx.globalAlpha = 0.3;
            for (let i = 1; i <= 3; i++) {
                ctx.beginPath();
                ctx.arc(player.x, player.y + i * 20, player.size - i * 5, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(0, 245, 212, ${0.3 - i * 0.1})`;
                ctx.fill();
            }
            ctx.globalAlpha = 1;
        }
        
        function loop() {
            if (!worldRunning) { cleanup(); return; }
            
            time++;
            
            if (!gameOver) {
                update();
            }
            
            drawBackground();
            drawObstacles();
            drawPlayer();
            
            requestAnimationFrame(loop);
        }
        
        loop();
    }
    
    function explorePlanet() {
        document.getElementById('resultModal').classList.remove('active');
        worldRunning = false;
        document.getElementById('worldCanvas').classList.remove('active');
        document.getElementById('landingUI').classList.remove('active');
        navigate('planet');
    }
    
    // Auth
    async function googleLogin() {
        try {
            document.getElementById('loadingScreen').classList.remove('hidden');
            const result = await signInWithPopup(auth, googleProvider);
            const user = result.user;
            
            const snap = await getDoc(doc(db, 'users', user.uid));
            if (!snap.exists()) {
                await setDoc(doc(db, 'users', user.uid), {
                    displayName: user.displayName,
                    email: user.email,
                    photoURL: user.photoURL,
                    game: { entropy: 0, stage: 1, evolution: { eye: false, arm: false, leg: false, brain: false, wing: false }, currentPlanet: null, territories: [], history: [] },
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                });
                showToast('ğŸ‰ ìš°ì£¼ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!', 'success');
            }
        } catch (e) {
            console.error('Login error:', e);
            showToast('ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + e.message, 'error');
            hideLoading();
        }
    }
    
    async function logout() {
        await signOut(auth);
        State.user = null;
        navigate('login');
    }
    
    // Init
    async function init() {
        createStars();
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                State.user = user;
                await State.load();
                hideLoading();
                navigate('dashboard');
            } else {
                State.user = null;
                hideLoading();
                navigate('login');
            }
        });
        
        window.nav = navigate;
        window.googleLogin = googleLogin;
        window.logout = logout;
        window.exitWorld = exitWorld;
        window.goToStage2 = goToStage2;
        window.explorePlanet = explorePlanet;
        window.toggleUserMenu = toggleUserMenu;
    }
    
    init();
    </script>
</body>
</html>
