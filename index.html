<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>BOKLUCK Universe</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üé≤</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Noto+Sans+KR:wght@300;400;500;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
/* ========================================
   CSS Variables & Reset
======================================== */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
    /* Core Colors */
    --void: #030308;
    --void-light: #0a0a1a;
    --void-surface: #12122a;
    --void-elevated: #1a1a3a;
    
    /* Neon Palette */
    --neon-cyan: #00f5d4;
    --neon-pink: #f72585;
    --neon-purple: #7b2cbf;
    --neon-yellow: #fee440;
    --neon-orange: #ff6b35;
    --neon-blue: #4361ee;
    
    /* Semantic */
    --success: #10b981;
    --danger: #ef4444;
    --warning: #f59e0b;
    
    /* Rarity */
    --legendary: #ffd700;
    --epic: #a855f7;
    --rare: #3b82f6;
    --common: #6b7280;
    
    /* Text */
    --text-primary: #e8e8ff;
    --text-secondary: #9090b0;
    --text-muted: #606080;
    
    /* Borders */
    --border-subtle: rgba(255, 255, 255, 0.06);
    --border-default: rgba(0, 245, 212, 0.15);
    --border-active: rgba(0, 245, 212, 0.4);
    
    /* Gradients */
    --gradient-cosmic: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f72585 100%);
    --gradient-energy: linear-gradient(135deg, #00f5d4 0%, #fee440 100%);
    --gradient-fire: linear-gradient(135deg, #ff6b35 0%, #f72585 100%);
    --gradient-ice: linear-gradient(135deg, #00f5d4 0%, #4361ee 100%);
    --gradient-void: linear-gradient(180deg, #030308 0%, #0a0a1a 50%, #12122a 100%);
    
    /* Shadows */
    --glow-cyan: 0 0 20px rgba(0, 245, 212, 0.3);
    --glow-pink: 0 0 20px rgba(247, 37, 133, 0.3);
    --glow-yellow: 0 0 20px rgba(254, 228, 64, 0.3);
    
    /* Spacing */
    --space-xs: 4px;
    --space-sm: 8px;
    --space-md: 16px;
    --space-lg: 24px;
    --space-xl: 32px;
    --space-2xl: 48px;
    
    /* Radius */
    --radius-sm: 8px;
    --radius-md: 12px;
    --radius-lg: 16px;
    --radius-xl: 24px;
    --radius-full: 9999px;
    
    /* Transitions */
    --transition-fast: 0.15s ease;
    --transition-normal: 0.25s ease;
    --transition-slow: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

html, body {
    height: 100%;
    overflow: hidden;
}

body {
    background: var(--void);
    color: var(--text-primary);
    font-family: 'Noto Sans KR', sans-serif;
    font-size: 14px;
    line-height: 1.5;
    -webkit-font-smoothing: antialiased;
}

.font-display { font-family: 'Orbitron', monospace; }
.font-mono { font-family: 'Space Mono', monospace; }

/* ========================================
   Scrollbar
======================================== */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: var(--void-light); }
::-webkit-scrollbar-thumb { background: var(--void-elevated); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--neon-cyan); }

/* ========================================
   Stars Background
======================================== */
#stars-container {
    position: fixed;
    inset: 0;
    z-index: 0;
    overflow: hidden;
    pointer-events: none;
}

.star {
    position: absolute;
    background: white;
    border-radius: 50%;
    animation: twinkle var(--duration) ease-in-out infinite;
}

@keyframes twinkle {
    0%, 100% { opacity: 0.2; transform: scale(1); }
    50% { opacity: 1; transform: scale(1.2); }
}

.shooting-star {
    position: absolute;
    width: 2px;
    height: 2px;
    background: linear-gradient(90deg, white, transparent);
    animation: shoot 3s linear infinite;
}

@keyframes shoot {
    0% { transform: translateX(0) translateY(0); opacity: 1; }
    70% { opacity: 1; }
    100% { transform: translateX(300px) translateY(300px); opacity: 0; }
}

/* ========================================
   Layout
======================================== */
#app {
    position: relative;
    z-index: 1;
    height: 100vh;
    overflow-y: auto;
}

.page {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
}

.page-center {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--space-lg);
}

.container {
    width: 100%;
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 var(--space-md);
}

.container-sm { max-width: 600px; }
.container-md { max-width: 800px; }

/* ========================================
   Typography
======================================== */
.title-xl {
    font-family: 'Orbitron', monospace;
    font-size: clamp(2rem, 6vw, 3.5rem);
    font-weight: 900;
    letter-spacing: 0.05em;
    background: var(--gradient-energy);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    text-shadow: 0 0 60px rgba(0, 245, 212, 0.5);
}

.title-lg {
    font-family: 'Orbitron', monospace;
    font-size: clamp(1.25rem, 4vw, 1.75rem);
    font-weight: 700;
    letter-spacing: 0.03em;
}

.title-md {
    font-family: 'Orbitron', monospace;
    font-size: 1rem;
    font-weight: 600;
    letter-spacing: 0.02em;
}

.text-gradient-energy {
    background: var(--gradient-energy);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.text-gradient-cosmic {
    background: var(--gradient-cosmic);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.text-center { text-align: center; }
.text-muted { color: var(--text-muted); }
.text-secondary { color: var(--text-secondary); }
.text-sm { font-size: 0.85rem; }
.text-xs { font-size: 0.75rem; }

/* ========================================
   Buttons
======================================== */
.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-sm);
    padding: 12px 24px;
    border: none;
    border-radius: var(--radius-md);
    font-family: inherit;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-normal);
    position: relative;
    overflow: hidden;
}

.btn:hover { transform: translateY(-2px); }
.btn:active { transform: translateY(0); }
.btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

.btn-primary {
    background: var(--gradient-cosmic);
    color: white;
    box-shadow: 0 4px 20px rgba(123, 44, 191, 0.3);
}

.btn-primary:hover { box-shadow: 0 6px 30px rgba(123, 44, 191, 0.5); }

.btn-energy {
    background: var(--gradient-energy);
    color: var(--void);
    box-shadow: 0 4px 20px rgba(0, 245, 212, 0.3);
}

.btn-energy:hover { box-shadow: var(--glow-cyan); }

.btn-danger {
    background: var(--gradient-fire);
    color: white;
    box-shadow: 0 4px 20px rgba(239, 68, 68, 0.3);
}

.btn-outline {
    background: transparent;
    color: var(--text-primary);
    border: 1px solid var(--border-default);
}

.btn-outline:hover {
    border-color: var(--neon-cyan);
    background: rgba(0, 245, 212, 0.05);
}

.btn-ghost {
    background: transparent;
    color: var(--text-secondary);
}

.btn-ghost:hover { color: var(--text-primary); background: rgba(255, 255, 255, 0.05); }

.btn-sm { padding: 8px 16px; font-size: 0.8rem; }
.btn-lg { padding: 16px 32px; font-size: 1rem; }
.btn-block { width: 100%; }
.btn-icon { padding: 10px; aspect-ratio: 1; }

/* ========================================
   Cards
======================================== */
.card {
    background: var(--void-surface);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    transition: all var(--transition-normal);
}

.card:hover {
    border-color: var(--border-default);
}

.card-elevated {
    background: var(--void-elevated);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.card-glow {
    border-color: var(--border-active);
    box-shadow: var(--glow-cyan), inset 0 0 30px rgba(0, 245, 212, 0.03);
}

.card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--space-md);
    padding-bottom: var(--space-md);
    border-bottom: 1px solid var(--border-subtle);
}

/* ========================================
   Forms
======================================== */
.input {
    width: 100%;
    padding: 12px 16px;
    background: var(--void-light);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-family: inherit;
    font-size: 0.9rem;
    transition: all var(--transition-fast);
    outline: none;
}

.input:focus {
    border-color: var(--neon-cyan);
    box-shadow: 0 0 0 3px rgba(0, 245, 212, 0.1);
}

.input::placeholder { color: var(--text-muted); }

/* ========================================
   Modal
======================================== */
.modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(3, 3, 8, 0.9);
    backdrop-filter: blur(8px);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--space-md);
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: all var(--transition-normal);
}

.modal-overlay.active {
    opacity: 1;
    visibility: visible;
}

.modal {
    background: var(--void-surface);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-xl);
    padding: var(--space-xl);
    max-width: 500px;
    width: 100%;
    max-height: 85vh;
    overflow-y: auto;
    transform: scale(0.95) translateY(20px);
    transition: all var(--transition-slow);
}

.modal-overlay.active .modal {
    transform: scale(1) translateY(0);
}

.modal-title {
    font-family: 'Orbitron', monospace;
    font-size: 1.25rem;
    font-weight: 700;
    text-align: center;
    margin-bottom: var(--space-sm);
}

.modal-desc {
    color: var(--text-secondary);
    text-align: center;
    margin-bottom: var(--space-lg);
}

.modal-actions {
    display: flex;
    gap: var(--space-sm);
    justify-content: center;
    flex-wrap: wrap;
    margin-top: var(--space-lg);
}

/* ========================================
   Toast
======================================== */
.toast-container {
    position: fixed;
    top: var(--space-lg);
    right: var(--space-lg);
    z-index: 2000;
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
}

.toast {
    background: var(--void-elevated);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-md);
    padding: 12px 16px;
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    min-width: 280px;
    animation: toastIn 0.3s ease, toastOut 0.3s ease 3s forwards;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.toast.success { border-color: var(--success); }
.toast.error { border-color: var(--danger); }
.toast.legendary { 
    border-color: var(--legendary); 
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), rgba(255, 140, 0, 0.1));
}

@keyframes toastIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

@keyframes toastOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
}

/* ========================================
   Save Slots
======================================== */
.save-slots {
    display: grid;
    gap: var(--space-md);
}

.save-slot {
    background: var(--void-light);
    border: 2px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    cursor: pointer;
    transition: all var(--transition-normal);
    position: relative;
    overflow: hidden;
}

.save-slot:hover {
    border-color: var(--border-default);
    transform: translateY(-2px);
}

.save-slot.empty {
    border-style: dashed;
    opacity: 0.6;
}

.save-slot.empty:hover { opacity: 1; }

.save-slot.selected {
    border-color: var(--neon-cyan);
    box-shadow: var(--glow-cyan);
}

.save-slot-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--space-sm);
}

.save-slot-number {
    font-family: 'Orbitron', monospace;
    font-size: 0.75rem;
    color: var(--text-muted);
    background: var(--void-surface);
    padding: 4px 8px;
    border-radius: var(--radius-sm);
}

.save-slot-name {
    font-family: 'Orbitron', monospace;
    font-weight: 600;
    font-size: 1rem;
    margin-bottom: var(--space-xs);
}

.save-slot-info {
    font-size: 0.8rem;
    color: var(--text-secondary);
}

.save-slot-preview {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    margin-top: var(--space-md);
    padding-top: var(--space-md);
    border-top: 1px solid var(--border-subtle);
}

.save-slot-actions {
    display: flex;
    gap: var(--space-sm);
    margin-top: var(--space-md);
}

/* ========================================
   Dice System
======================================== */
.dice-container {
    text-align: center;
}

.dice-3d {
    width: 120px;
    height: 120px;
    margin: var(--space-xl) auto;
    perspective: 600px;
}

.dice-cube {
    width: 100%;
    height: 100%;
    position: relative;
    transform-style: preserve-3d;
    transition: transform 0.1s ease;
}

.dice-cube.rolling {
    animation: diceRoll 0.1s linear infinite;
}

@keyframes diceRoll {
    0% { transform: rotateX(0deg) rotateY(0deg) rotateZ(0deg); }
    25% { transform: rotateX(90deg) rotateY(45deg) rotateZ(90deg); }
    50% { transform: rotateX(180deg) rotateY(90deg) rotateZ(180deg); }
    75% { transform: rotateX(270deg) rotateY(135deg) rotateZ(270deg); }
    100% { transform: rotateX(360deg) rotateY(180deg) rotateZ(360deg); }
}

.dice-face {
    position: absolute;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'Orbitron', monospace;
    font-size: 2.5rem;
    font-weight: 900;
    background: linear-gradient(135deg, var(--void-elevated), var(--void-surface));
    border: 2px solid var(--neon-cyan);
    border-radius: var(--radius-md);
    box-shadow: inset 0 0 30px rgba(0, 245, 212, 0.1);
    color: var(--neon-cyan);
    backface-visibility: hidden;
}

.dice-face.front { transform: rotateY(0deg) translateZ(60px); }
.dice-face.back { transform: rotateY(180deg) translateZ(60px); }
.dice-face.right { transform: rotateY(90deg) translateZ(60px); }
.dice-face.left { transform: rotateY(-90deg) translateZ(60px); }
.dice-face.top { transform: rotateX(90deg) translateZ(60px); }
.dice-face.bottom { transform: rotateX(-90deg) translateZ(60px); }

.dice-result-display {
    font-family: 'Orbitron', monospace;
    font-size: 4rem;
    font-weight: 900;
    margin: var(--space-lg) 0;
    animation: resultPop 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.dice-result-display.success { color: var(--success); text-shadow: 0 0 30px var(--success); }
.dice-result-display.fail { color: var(--danger); text-shadow: 0 0 30px var(--danger); }
.dice-result-display.critical { color: var(--legendary); text-shadow: 0 0 40px var(--legendary); }

@keyframes resultPop {
    0% { transform: scale(0); opacity: 0; }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); opacity: 1; }
}

.dice-stats {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-md);
    margin: var(--space-lg) 0;
}

.dice-stat {
    background: var(--void-light);
    border-radius: var(--radius-md);
    padding: var(--space-md);
}

.dice-stat-label {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-bottom: var(--space-xs);
}

.dice-stat-value {
    font-family: 'Orbitron', monospace;
    font-size: 1.25rem;
    font-weight: 700;
}

.dice-hint {
    background: var(--void-light);
    border-radius: var(--radius-md);
    padding: var(--space-md);
    font-size: 0.85rem;
    color: var(--text-secondary);
    margin-top: var(--space-lg);
}

/* ========================================
   Cell Renderer
======================================== */
.cell-canvas {
    border-radius: var(--radius-lg);
    background: radial-gradient(circle at center, var(--void-surface), var(--void));
}

.cell-preview {
    width: 180px;
    height: 180px;
    margin: 0 auto;
}

.cell-preview-sm {
    width: 60px;
    height: 60px;
}

/* ========================================
   Environment Cards
======================================== */
.environment-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: var(--space-md);
    margin: var(--space-lg) 0;
}

.environment-card {
    background: var(--void-light);
    border: 2px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    text-align: center;
    transition: all var(--transition-normal);
    cursor: pointer;
}

.environment-card:hover {
    border-color: var(--border-active);
    transform: translateY(-4px);
}

.environment-card.selected {
    border-color: var(--neon-cyan);
    box-shadow: var(--glow-cyan);
}

.environment-icon {
    font-size: 3rem;
    margin-bottom: var(--space-sm);
}

.environment-name {
    font-family: 'Orbitron', monospace;
    font-weight: 600;
    font-size: 0.9rem;
}

/* ========================================
   DNA Display
======================================== */
.dna-card {
    background: linear-gradient(135deg, var(--void-surface), var(--void-elevated));
    border: 1px solid var(--border-default);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    margin-bottom: var(--space-md);
}

.dna-header {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    margin-bottom: var(--space-md);
}

.dna-icon {
    font-size: 2rem;
}

.dna-name {
    font-family: 'Orbitron', monospace;
    font-weight: 700;
    font-size: 1rem;
}

.dna-trait {
    display: flex;
    align-items: flex-start;
    gap: var(--space-sm);
    padding: var(--space-sm);
    background: var(--void-light);
    border-radius: var(--radius-sm);
    margin-bottom: var(--space-xs);
    font-size: 0.85rem;
}

.dna-trait-strength { border-left: 3px solid var(--success); }
.dna-trait-weakness { border-left: 3px solid var(--danger); }

/* ========================================
   Settings Panel
======================================== */
.settings-section {
    margin-bottom: var(--space-xl);
}

.settings-section-title {
    font-family: 'Orbitron', monospace;
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: var(--space-md);
    text-transform: uppercase;
    letter-spacing: 0.1em;
}

.settings-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-md) 0;
    border-bottom: 1px solid var(--border-subtle);
}

.settings-label {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}

.settings-label-icon { font-size: 1.25rem; }

/* Volume Slider */
.volume-slider {
    -webkit-appearance: none;
    appearance: none;
    width: 120px;
    height: 6px;
    background: var(--void-light);
    border-radius: 3px;
    outline: none;
}

.volume-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 18px;
    height: 18px;
    background: var(--gradient-energy);
    border-radius: 50%;
    cursor: pointer;
    transition: transform var(--transition-fast);
}

.volume-slider::-webkit-slider-thumb:hover {
    transform: scale(1.2);
}

/* Toggle Switch */
.toggle {
    position: relative;
    width: 50px;
    height: 26px;
    background: var(--void-light);
    border-radius: var(--radius-full);
    cursor: pointer;
    transition: background var(--transition-fast);
}

.toggle.active { background: var(--neon-cyan); }

.toggle-knob {
    position: absolute;
    top: 3px;
    left: 3px;
    width: 20px;
    height: 20px;
    background: white;
    border-radius: 50%;
    transition: transform var(--transition-fast);
}

.toggle.active .toggle-knob {
    transform: translateX(24px);
}

/* ========================================
   Progress & Stats
======================================== */
.progress-bar {
    height: 8px;
    background: var(--void-light);
    border-radius: var(--radius-full);
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: var(--gradient-energy);
    border-radius: var(--radius-full);
    transition: width var(--transition-normal);
}

.stat-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-sm);
}

.stat-box {
    background: var(--void-light);
    border-radius: var(--radius-md);
    padding: var(--space-md);
    text-align: center;
}

.stat-value {
    font-family: 'Orbitron', monospace;
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--neon-cyan);
}

.stat-label {
    font-size: 0.7rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-top: var(--space-xs);
}

/* ========================================
   Utility Classes
======================================== */
.mb-xs { margin-bottom: var(--space-xs); }
.mb-sm { margin-bottom: var(--space-sm); }
.mb-md { margin-bottom: var(--space-md); }
.mb-lg { margin-bottom: var(--space-lg); }
.mb-xl { margin-bottom: var(--space-xl); }
.mt-md { margin-top: var(--space-md); }
.mt-lg { margin-top: var(--space-lg); }

.flex { display: flex; }
.flex-col { flex-direction: column; }
.items-center { align-items: center; }
.justify-center { justify-content: center; }
.justify-between { justify-content: space-between; }
.gap-sm { gap: var(--space-sm); }
.gap-md { gap: var(--space-md); }

.hidden { display: none !important; }

/* ========================================
   Animations
======================================== */
@keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

@keyframes glow {
    0%, 100% { box-shadow: 0 0 20px rgba(0, 245, 212, 0.3); }
    50% { box-shadow: 0 0 40px rgba(0, 245, 212, 0.6); }
}

.animate-float { animation: float 3s ease-in-out infinite; }
.animate-pulse { animation: pulse 2s ease-in-out infinite; }
.animate-glow { animation: glow 2s ease-in-out infinite; }

/* ========================================
   Responsive
======================================== */
@media (max-width: 600px) {
    .modal { padding: var(--space-lg); }
    .environment-grid { grid-template-columns: repeat(2, 1fr); }
    .dice-stats { grid-template-columns: 1fr; }
    .save-slot-preview { flex-direction: column; text-align: center; }
}
    </style>
</head>
<body>
    <!-- Stars Background -->
    <div id="stars-container"></div>
    
    <!-- Main App -->
    <div id="app"></div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>
    
    <!-- Dice Modal -->
    <div class="modal-overlay" id="dice-modal">
        <div class="modal" id="dice-modal-content"></div>
    </div>
    
    <!-- Settings Modal -->
    <div class="modal-overlay" id="settings-modal">
        <div class="modal" id="settings-modal-content"></div>
    </div>
    
    <!-- Generic Modal -->
    <div class="modal-overlay" id="generic-modal">
        <div class="modal" id="generic-modal-content"></div>
    </div>

<script>
/* ========================================
   Module: Audio System
======================================== */
const AudioSystem = (() => {
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    
    let settings = {
        masterVolume: 0.7,
        sfxVolume: 0.8,
        bgmVolume: 0.5,
        sfxEnabled: true,
        bgmEnabled: true
    };
    
    // BGM Í¥ÄÎ†®
    let bgmOscillator = null;
    let bgmGain = null;
    
    // ÏÑ§Ï†ï Î°úÎìú
    const loadSettings = () => {
        const saved = localStorage.getItem('bokluck_audio_settings');
        if (saved) {
            settings = { ...settings, ...JSON.parse(saved) };
        }
    };
    
    // ÏÑ§Ï†ï Ï†ÄÏû•
    const saveSettings = () => {
        localStorage.setItem('bokluck_audio_settings', JSON.stringify(settings));
    };
    
    // Î≥ºÎ•® Í≥ÑÏÇ∞
    const getVolume = (type) => {
        const baseVol = type === 'bgm' ? settings.bgmVolume : settings.sfxVolume;
        const enabled = type === 'bgm' ? settings.bgmEnabled : settings.sfxEnabled;
        return enabled ? baseVol * settings.masterVolume : 0;
    };
    
    // Ìö®Í≥ºÏùå: Ï£ºÏÇ¨ÏúÑ Íµ¥Î¶º
    const playDiceRoll = () => {
        if (!settings.sfxEnabled) return;
        const vol = getVolume('sfx');
        
        // Ï£ºÏÇ¨ÏúÑ Íµ¥Î¶¨Îäî ÏÜåÎ¶¨ (Ïó¨Îü¨ ÏùåÏù¥ Îπ†Î•¥Í≤å)
        for (let i = 0; i < 8; i++) {
            setTimeout(() => {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                
                osc.connect(gain);
                gain.connect(audioContext.destination);
                
                osc.type = 'square';
                osc.frequency.value = 200 + Math.random() * 400;
                
                gain.gain.setValueAtTime(vol * 0.3, audioContext.currentTime);
                gain.gain.exponentialDecayTo?.(0.01, audioContext.currentTime + 0.05) ||
                    gain.gain.setValueAtTime(0.01, audioContext.currentTime + 0.05);
                
                osc.start();
                osc.stop(audioContext.currentTime + 0.05);
            }, i * 50);
        }
    };
    
    // Ìö®Í≥ºÏùå: Ï£ºÏÇ¨ÏúÑ Í≤∞Í≥º
    const playDiceResult = (success) => {
        if (!settings.sfxEnabled) return;
        const vol = getVolume('sfx');
        
        const osc = audioContext.createOscillator();
        const gain = audioContext.createGain();
        
        osc.connect(gain);
        gain.connect(audioContext.destination);
        
        if (success) {
            // ÏÑ±Í≥µ ÏÇ¨Ïö¥Îìú (ÏÉÅÏäπÌïòÎäî Ïùå)
            osc.type = 'sine';
            osc.frequency.setValueAtTime(400, audioContext.currentTime);
            osc.frequency.linearRampToValueAtTime(800, audioContext.currentTime + 0.2);
            gain.gain.setValueAtTime(vol * 0.4, audioContext.currentTime);
            gain.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.3);
            osc.start();
            osc.stop(audioContext.currentTime + 0.3);
        } else {
            // Ïã§Ìå® ÏÇ¨Ïö¥Îìú (ÌïòÍ∞ïÌïòÎäî Ïùå)
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(400, audioContext.currentTime);
            osc.frequency.linearRampToValueAtTime(150, audioContext.currentTime + 0.3);
            gain.gain.setValueAtTime(vol * 0.3, audioContext.currentTime);
            gain.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.4);
            osc.start();
            osc.stop(audioContext.currentTime + 0.4);
        }
    };
    
    // Ìö®Í≥ºÏùå: ÌÅ¥Î¶≠
    const playClick = () => {
        if (!settings.sfxEnabled) return;
        const vol = getVolume('sfx');
        
        const osc = audioContext.createOscillator();
        const gain = audioContext.createGain();
        
        osc.connect(gain);
        gain.connect(audioContext.destination);
        
        osc.type = 'sine';
        osc.frequency.value = 600;
        gain.gain.setValueAtTime(vol * 0.2, audioContext.currentTime);
        gain.gain.exponentialDecayTo?.(0.01, audioContext.currentTime + 0.08) ||
            gain.gain.setValueAtTime(0.01, audioContext.currentTime + 0.08);
        
        osc.start();
        osc.stop(audioContext.currentTime + 0.08);
    };
    
    // Ìö®Í≥ºÏùå: ÏÑ±Í≥µ/ÌöçÎìù
    const playSuccess = () => {
        if (!settings.sfxEnabled) return;
        const vol = getVolume('sfx');
        
        const notes = [523, 659, 784]; // C5, E5, G5
        notes.forEach((freq, i) => {
            setTimeout(() => {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                
                osc.connect(gain);
                gain.connect(audioContext.destination);
                
                osc.type = 'sine';
                osc.frequency.value = freq;
                gain.gain.setValueAtTime(vol * 0.3, audioContext.currentTime);
                gain.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.2);
                
                osc.start();
                osc.stop(audioContext.currentTime + 0.2);
            }, i * 100);
        });
    };
    
    // Ìö®Í≥ºÏùå: ÏóêÎü¨
    const playError = () => {
        if (!settings.sfxEnabled) return;
        const vol = getVolume('sfx');
        
        const osc = audioContext.createOscillator();
        const gain = audioContext.createGain();
        
        osc.connect(gain);
        gain.connect(audioContext.destination);
        
        osc.type = 'square';
        osc.frequency.value = 150;
        gain.gain.setValueAtTime(vol * 0.3, audioContext.currentTime);
        gain.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.3);
        
        osc.start();
        osc.stop(audioContext.currentTime + 0.3);
    };
    
    // Ìö®Í≥ºÏùå: Ï†ÑÏÑ§ Îì±Í∏â
    const playLegendary = () => {
        if (!settings.sfxEnabled) return;
        const vol = getVolume('sfx');
        
        const notes = [523, 659, 784, 1047]; // C5, E5, G5, C6
        notes.forEach((freq, i) => {
            setTimeout(() => {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                
                osc.connect(gain);
                gain.connect(audioContext.destination);
                
                osc.type = 'sine';
                osc.frequency.value = freq;
                gain.gain.setValueAtTime(vol * 0.4, audioContext.currentTime);
                gain.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.4);
                
                osc.start();
                osc.stop(audioContext.currentTime + 0.4);
            }, i * 150);
        });
    };
    
    // BGM ÏãúÏûë
    const startBGM = () => {
        if (!settings.bgmEnabled || bgmOscillator) return;
        
        // Í∞ÑÎã®Ìïú Ïï∞ÎπÑÏñ∏Ìä∏ BGM
        bgmGain = audioContext.createGain();
        bgmGain.connect(audioContext.destination);
        bgmGain.gain.value = getVolume('bgm') * 0.1;
        
        // Ï†ÄÏùå ÎìúÎ°†
        bgmOscillator = audioContext.createOscillator();
        bgmOscillator.type = 'sine';
        bgmOscillator.frequency.value = 55; // A1
        bgmOscillator.connect(bgmGain);
        bgmOscillator.start();
        
        // LFO for subtle movement
        const lfo = audioContext.createOscillator();
        const lfoGain = audioContext.createGain();
        lfo.type = 'sine';
        lfo.frequency.value = 0.1;
        lfoGain.gain.value = 5;
        lfo.connect(lfoGain);
        lfoGain.connect(bgmOscillator.frequency);
        lfo.start();
    };
    
    // BGM Ï†ïÏßÄ
    const stopBGM = () => {
        if (bgmOscillator) {
            bgmOscillator.stop();
            bgmOscillator = null;
        }
    };
    
    // BGM Î≥ºÎ•® ÏóÖÎç∞Ïù¥Ìä∏
    const updateBGMVolume = () => {
        if (bgmGain) {
            bgmGain.gain.value = getVolume('bgm') * 0.1;
        }
    };
    
    // Ïò§ÎîîÏò§ Ïª®ÌÖçÏä§Ìä∏ resume (ÏÇ¨Ïö©Ïûê ÏÉÅÌò∏ÏûëÏö© ÌõÑ)
    const resume = () => {
        if (audioContext.state === 'suspended') {
            audioContext.resume();
        }
    };
    
    // Ï¥àÍ∏∞Ìôî
    loadSettings();
    
    return {
        settings,
        saveSettings,
        loadSettings,
        resume,
        playDiceRoll,
        playDiceResult,
        playClick,
        playSuccess,
        playError,
        playLegendary,
        startBGM,
        stopBGM,
        updateBGMVolume,
        setMasterVolume: (v) => { settings.masterVolume = v; saveSettings(); updateBGMVolume(); },
        setSfxVolume: (v) => { settings.sfxVolume = v; saveSettings(); },
        setBgmVolume: (v) => { settings.bgmVolume = v; saveSettings(); updateBGMVolume(); },
        setSfxEnabled: (v) => { settings.sfxEnabled = v; saveSettings(); },
        setBgmEnabled: (v) => { 
            settings.bgmEnabled = v; 
            saveSettings(); 
            if (v) startBGM(); else stopBGM();
        }
    };
})();


/* ========================================
   Module: Save System
======================================== */
const SaveSystem = (() => {
    const SAVE_KEY_PREFIX = 'bokluck_save_';
    const MAX_SLOTS = 5;
    
    // ÏÉà Í≤åÏûÑ Îç∞Ïù¥ÌÑ∞ ÌÖúÌîåÎ¶ø
    const createNewGameData = () => ({
        version: 1,
        createdAt: Date.now(),
        updatedAt: Date.now(),
        playTime: 0,
        
        // Í∏∞Î≥∏ Ï†ïÎ≥¥
        cellName: null,
        
        // ÏßÑÌñâ ÏÉÅÌÉú
        stage: 0, // 0: ÎØ∏ÏãúÏûë, 1: ÏÑ∏Ìè¨, 2: Îã§ÏÑ∏Ìè¨, 3: Î¨∏Î™Ö, 4: Ïö∞Ï£º
        entropy: 0,
        
        // DNA ÏãúÏä§ÌÖú
        dna: {
            origin: null,
            traits: [],
            evolutionPath: []
        },
        
        // ÏÑ∏Ìè¨ ÎîîÏûêÏù∏
        cellDesign: null,
        
        // ÏßÑÌôî ÏÉÅÌÉú
        evolution: {
            eye: false,
            arm: false,
            leg: false,
            brain: false,
            wing: false
        },
        
        // NPC Í¥ÄÍ≥Ñ
        npcRelations: {
            blueLight: 0,
            redShadow: 0,
            grayElder: 0,
            goldMerchant: 0,
            blackFang: 0
        },
        
        // Ïó≠ÏÇ¨
        history: [],
        
        // Ïª¨Î†âÏÖò
        collection: {
            creatures: [],
            artifacts: [],
            planets: []
        },
        
        // Í∏∞ÌÉÄ ÌÜµÍ≥Ñ
        stats: {
            totalDiceRolls: 0,
            criticalHits: 0,
            deaths: 0,
            npcsMet: 0
        }
    });
    
    // Ïä¨Î°Ø Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
    const getSlotInfo = (slotIndex) => {
        const data = localStorage.getItem(SAVE_KEY_PREFIX + slotIndex);
        if (!data) return null;
        
        try {
            return JSON.parse(data);
        } catch (e) {
            console.error('Failed to parse save data:', e);
            return null;
        }
    };
    
    // Î™®Îì† Ïä¨Î°Ø Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
    const getAllSlots = () => {
        const slots = [];
        for (let i = 0; i < MAX_SLOTS; i++) {
            slots.push(getSlotInfo(i));
        }
        return slots;
    };
    
    // Ï†ÄÏû•
    const saveToSlot = (slotIndex, data) => {
        data.updatedAt = Date.now();
        localStorage.setItem(SAVE_KEY_PREFIX + slotIndex, JSON.stringify(data));
        return true;
    };
    
    // Î∂àÎü¨Ïò§Í∏∞
    const loadFromSlot = (slotIndex) => {
        return getSlotInfo(slotIndex);
    };
    
    // ÏÇ≠Ï†ú
    const deleteSlot = (slotIndex) => {
        localStorage.removeItem(SAVE_KEY_PREFIX + slotIndex);
        return true;
    };
    
    // ÏÉà Í≤åÏûÑ ÏãúÏûë
    const startNewGame = (slotIndex) => {
        const newData = createNewGameData();
        saveToSlot(slotIndex, newData);
        return newData;
    };
    
    // Ìè¨Îß∑ÌåÖÎêú ÎÇ†Ïßú
    const formatDate = (timestamp) => {
        if (!timestamp) return '-';
        const date = new Date(timestamp);
        return date.toLocaleDateString('ko-KR', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    };
    
    // ÌîåÎ†àÏù¥ ÏãúÍ∞Ñ Ìè¨Îß∑
    const formatPlayTime = (ms) => {
        if (!ms) return '0Î∂Ñ';
        const hours = Math.floor(ms / 3600000);
        const minutes = Math.floor((ms % 3600000) / 60000);
        if (hours > 0) return `${hours}ÏãúÍ∞Ñ ${minutes}Î∂Ñ`;
        return `${minutes}Î∂Ñ`;
    };
    
    return {
        MAX_SLOTS,
        createNewGameData,
        getSlotInfo,
        getAllSlots,
        saveToSlot,
        loadFromSlot,
        deleteSlot,
        startNewGame,
        formatDate,
        formatPlayTime
    };
})();


/* ========================================
   Module: Game State
======================================== */
const GameState = (() => {
    let currentSlot = null;
    let data = null;
    let lastSaveTime = 0;
    let sessionStartTime = 0;
    
    // ÏûêÎèô Ï†ÄÏû• Í∞ÑÍ≤© (30Ï¥à)
    const AUTO_SAVE_INTERVAL = 30000;
    
    // ÌòÑÏû¨ Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
    const get = () => data;
    
    // Îç∞Ïù¥ÌÑ∞ ÏÑ§Ï†ï
    const set = (newData) => {
        data = newData;
    };
    
    // Ïä¨Î°Ø Î°úÎìú
    const loadSlot = (slotIndex) => {
        currentSlot = slotIndex;
        data = SaveSystem.loadFromSlot(slotIndex);
        sessionStartTime = Date.now();
        return data;
    };
    
    // ÏÉà Í≤åÏûÑ ÏãúÏûë
    const startNew = (slotIndex) => {
        currentSlot = slotIndex;
        data = SaveSystem.startNewGame(slotIndex);
        sessionStartTime = Date.now();
        return data;
    };
    
    // Ï†ÄÏû•
    const save = () => {
        if (currentSlot === null || !data) return false;
        
        // ÌîåÎ†àÏù¥ ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏
        const sessionTime = Date.now() - sessionStartTime;
        data.playTime = (data.playTime || 0) + sessionTime;
        sessionStartTime = Date.now();
        
        SaveSystem.saveToSlot(currentSlot, data);
        lastSaveTime = Date.now();
        return true;
    };
    
    // ÏûêÎèô Ï†ÄÏû•
    const autoSave = () => {
        if (Date.now() - lastSaveTime > AUTO_SAVE_INTERVAL) {
            save();
        }
    };
    
    // ÏóîÌä∏Î°úÌîº Ï∂îÍ∞Ä
    const addEntropy = (amount) => {
        if (!data) return;
        data.entropy = Math.max(0, (data.entropy || 0) + amount);
    };
    
    // DNA ÌäπÏÑ± Ï∂îÍ∞Ä
    const addTrait = (trait) => {
        if (!data || !data.dna) return;
        if (!data.dna.traits.includes(trait)) {
            data.dna.traits.push(trait);
        }
    };
    
    // Ïó≠ÏÇ¨ Ï∂îÍ∞Ä
    const addHistory = (title, content) => {
        if (!data) return;
        data.history.push({
            chapter: data.history.length + 1,
            title,
            content,
            timestamp: Date.now()
        });
    };
    
    // NPC Í¥ÄÍ≥Ñ Î≥ÄÍ≤Ω
    const changeNpcRelation = (npcId, amount) => {
        if (!data || !data.npcRelations) return;
        data.npcRelations[npcId] = Math.max(-100, Math.min(100, 
            (data.npcRelations[npcId] || 0) + amount
        ));
    };
    
    return {
        get,
        set,
        loadSlot,
        startNew,
        save,
        autoSave,
        addEntropy,
        addTrait,
        addHistory,
        changeNpcRelation,
        getCurrentSlot: () => currentSlot
    };
})();


/* ========================================
   Module: Stars Background
======================================== */
const StarsBackground = (() => {
    const create = () => {
        const container = document.getElementById('stars-container');
        if (!container) return;
        
        container.innerHTML = '';
        
        // Î≥Ñ ÏÉùÏÑ±
        for (let i = 0; i < 150; i++) {
            const star = document.createElement('div');
            star.className = 'star';
            star.style.cssText = `
                left: ${Math.random() * 100}%;
                top: ${Math.random() * 100}%;
                width: ${Math.random() * 2 + 1}px;
                height: ${star.style.width};
                --duration: ${Math.random() * 3 + 2}s;
                animation-delay: ${Math.random() * 3}s;
            `;
            container.appendChild(star);
        }
        
        // Ïú†ÏÑ± ÏÉùÏÑ±
        for (let i = 0; i < 3; i++) {
            const shootingStar = document.createElement('div');
            shootingStar.className = 'shooting-star';
            shootingStar.style.cssText = `
                left: ${Math.random() * 50}%;
                top: ${Math.random() * 50}%;
                animation-delay: ${Math.random() * 10 + i * 5}s;
            `;
            container.appendChild(shootingStar);
        }
    };
    
    return { create };
})();


/* ========================================
   Module: Toast Notifications
======================================== */
const Toast = (() => {
    const show = (message, type = 'info') => {
        const container = document.getElementById('toast-container');
        if (!container) return;
        
        const icons = {
            success: '‚úÖ',
            error: '‚ùå',
            info: '‚ÑπÔ∏è',
            legendary: '‚≠ê',
            warning: '‚ö†Ô∏è'
        };
        
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `
            <span>${icons[type] || '‚ÑπÔ∏è'}</span>
            <span style="flex:1">${message}</span>
        `;
        
        container.appendChild(toast);
        
        // Ìö®Í≥ºÏùå
        if (type === 'success') AudioSystem.playSuccess();
        else if (type === 'error') AudioSystem.playError();
        else if (type === 'legendary') AudioSystem.playLegendary();
        
        // 3.5Ï¥à ÌõÑ Ï†úÍ±∞
        setTimeout(() => toast.remove(), 3500);
    };
    
    return { show };
})();


/* ========================================
   Module: Modal System
======================================== */
const Modal = (() => {
    const show = (modalId) => {
        document.getElementById(modalId)?.classList.add('active');
    };
    
    const hide = (modalId) => {
        document.getElementById(modalId)?.classList.remove('active');
    };
    
    const setContent = (modalId, contentId, html) => {
        const content = document.getElementById(contentId);
        if (content) content.innerHTML = html;
    };
    
    return { show, hide, setContent };
})();


/* ========================================
   Module: Dice System
======================================== */
const DiceSystem = (() => {
    let onCompleteCallback = null;
    let isRolling = false;
    
    // Ï£ºÏÇ¨ÏúÑ UI ÌëúÏãú
    const show = (config) => {
        const { situation, playerStat, opponentStat, onComplete } = config;
        onCompleteCallback = onComplete;
        
        const hint = getHint(playerStat, opponentStat);
        
        const html = `
            <div class="dice-container">
                <h2 class="title-lg text-gradient-energy mb-sm">üé≤ Ïö¥Î™ÖÏùò Ï£ºÏÇ¨ÏúÑ</h2>
                <p class="text-secondary text-center mb-lg">${situation}</p>
                
                <div class="dice-stats">
                    <div class="dice-stat">
                        <div class="dice-stat-label">ÎãπÏã†</div>
                        <div class="dice-stat-value text-gradient-energy">${playerStat} + üé≤</div>
                    </div>
                    <div class="dice-stat">
                        <div class="dice-stat-label">ÏÉÅÎåÄ</div>
                        <div class="dice-stat-value">${opponentStat} + üé≤</div>
                    </div>
                </div>
                
                <div class="dice-3d" id="dice-visual">
                    <div class="dice-cube" id="dice-cube">
                        <div class="dice-face front">?</div>
                        <div class="dice-face back">?</div>
                        <div class="dice-face right">?</div>
                        <div class="dice-face left">?</div>
                        <div class="dice-face top">?</div>
                        <div class="dice-face bottom">?</div>
                    </div>
                </div>
                
                <button class="btn btn-energy btn-lg btn-block" id="roll-dice-btn">
                    ÌÑ∞ÏπòÌïòÏó¨ Íµ¥Î¶¨Í∏∞
                </button>
                
                <div class="dice-hint">
                    üí° ${hint}
                </div>
            </div>
        `;
        
        Modal.setContent('dice-modal', 'dice-modal-content', html);
        Modal.show('dice-modal');
        
        document.getElementById('roll-dice-btn').onclick = () => roll(playerStat, opponentStat);
    };
    
    // ÌûåÌä∏ ÏÉùÏÑ±
    const getHint = (playerStat, opponentStat) => {
        const diff = playerStat - opponentStat;
        if (diff > 30) return "ÏïïÎèÑÏ†Å Ïö∞ÏúÑ! Í±∞Ïùò ÌôïÏã§Ìïú ÏäπÎ¶¨.";
        if (diff > 15) return "Ïú†Î¶¨Ìïú ÏÉÅÌô©. ÌèâÍ∑†Îßå ÎÇòÏôÄÎèÑ Ïù¥Í∏¥Îã§.";
        if (diff > 0) return "ÏïΩÍ∞Ñ Ïú†Î¶¨. ÌïòÏßÄÎßå Ïö¥Ïù¥ ÌïÑÏöîÌïòÎã§.";
        if (diff > -15) return "ÏïΩÍ∞Ñ Î∂àÎ¶¨. ÌñâÏö¥ÏùÑ ÎπåÏñ¥Ïïº ÌïúÎã§.";
        if (diff > -30) return "Î∂àÎ¶¨Ìïú ÏÉÅÌô©. Í∏∞Ï†ÅÏù¥ ÌïÑÏöîÌïòÎã§.";
        return "Îß§Ïö∞ Î∂àÎ¶¨. ÌïòÏßÄÎßå Í∞ÄÎä•ÏÑ±ÏùÄ ÏûàÎã§...";
    };
    
    // Ï£ºÏÇ¨ÏúÑ Íµ¥Î¶¨Í∏∞
    const roll = (playerStat, opponentStat) => {
        if (isRolling) return;
        isRolling = true;
        
        const cube = document.getElementById('dice-cube');
        const btn = document.getElementById('roll-dice-btn');
        
        btn.disabled = true;
        btn.textContent = 'Íµ¥Î¶¨Îäî Ï§ë...';
        cube.classList.add('rolling');
        
        // Ìö®Í≥ºÏùå
        AudioSystem.playDiceRoll();
        
        // 1.5Ï¥à ÌõÑ Í≤∞Í≥º
        setTimeout(() => {
            cube.classList.remove('rolling');
            showResult(playerStat, opponentStat);
        }, 1500);
    };
    
    // Í≤∞Í≥º ÌëúÏãú
    const showResult = (playerStat, opponentStat) => {
        const playerRoll = Math.floor(Math.random() * 100) + 1;
        const opponentRoll = Math.floor(Math.random() * 100) + 1;
        
        const playerTotal = playerStat + playerRoll;
        const opponentTotal = opponentStat + opponentRoll;
        
        const won = playerTotal > opponentTotal;
        const critical = playerRoll >= 91;
        const fumble = playerRoll <= 10;
        
        // ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
        const gameData = GameState.get();
        if (gameData) {
            gameData.stats.totalDiceRolls++;
            if (critical) gameData.stats.criticalHits++;
        }
        
        // Ìö®Í≥ºÏùå
        AudioSystem.playDiceResult(won);
        if (critical) AudioSystem.playLegendary();
        
        let resultClass = won ? 'success' : 'fail';
        if (critical) resultClass = 'critical';
        
        let resultText = won ? 'ÏÑ±Í≥µ!' : 'Ïã§Ìå®...';
        if (critical) resultText = 'üí• ÌÅ¨Î¶¨Ìã∞Ïª¨!';
        if (fumble) resultText = 'üò± ÎåÄÏã§Ìå®...';
        
        const resultHtml = `
            <div class="dice-container">
                <div class="dice-result-display ${resultClass}">${playerRoll}</div>
                
                <h3 class="title-md text-center mb-lg">${resultText}</h3>
                
                <div class="dice-stats mb-lg">
                    <div class="dice-stat">
                        <div class="dice-stat-label">ÎãπÏã†</div>
                        <div class="dice-stat-value" style="color: var(--neon-cyan)">
                            ${playerStat} + ${playerRoll} = <strong>${playerTotal}</strong>
                        </div>
                    </div>
                    <div class="dice-stat">
                        <div class="dice-stat-label">ÏÉÅÎåÄ</div>
                        <div class="dice-stat-value">
                            ${opponentStat} + ${opponentRoll} = <strong>${opponentTotal}</strong>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-primary btn-lg btn-block" id="dice-continue-btn">
                    Í≥ÑÏÜç
                </button>
            </div>
        `;
        
        document.getElementById('dice-modal-content').innerHTML = resultHtml;
        
        document.getElementById('dice-continue-btn').onclick = () => {
            isRolling = false;
            Modal.hide('dice-modal');
            
            if (onCompleteCallback) {
                onCompleteCallback({
                    playerRoll,
                    opponentRoll,
                    playerTotal,
                    opponentTotal,
                    won,
                    critical,
                    fumble
                });
            }
        };
    };
    
    return { show };
})();


/* ========================================
   Module: Cell Renderer
======================================== */
const CellRenderer = (() => {
    // Í∏∞Î≥∏ ÏÑ∏Ìè¨ ÎîîÏûêÏù∏ ÏÉùÏÑ±
    const generateDesign = (environment = null) => {
        const envColors = {
            ocean: ['#00b4d8', '#0077b6'],
            hydrothermal: ['#ff6b35', '#f72585'],
            ice: ['#a8dadc', '#457b9d'],
            magma: ['#ff4800', '#ff6000'],
            atmosphere: ['#e0aaff', '#c77dff'],
            toxic: ['#70e000', '#38b000']
        };
        
        let h1 = Math.floor(Math.random() * 360);
        let h2 = (h1 + 60 + Math.floor(Math.random() * 120)) % 360;
        
        let primaryColor = `hsl(${h1}, 80%, 60%)`;
        let secondaryColor = `hsl(${h2}, 70%, 40%)`;
        
        if (environment && envColors[environment]) {
            primaryColor = envColors[environment][0];
            secondaryColor = envColors[environment][1];
        }
        
        const patterns = ['none', 'spots', 'stripes', 'glow'];
        const adj = ['ÎπõÎÇòÎäî', 'Ïñ¥Îë†Ïùò', 'Í≥†ÎåÄÏùò', 'Ïã†ÎπÑÎ°úÏö¥', 'ÏòÅÏõêÌïú', 'Íπ®Ïñ¥ÎÇú', 'Îñ†ÎèÑÎäî', 'Ïã¨Ïó∞Ïùò'];
        const noun = ['ÏùòÏãù', 'ÏÑ∏Ìè¨', 'Ï°¥Ïû¨', 'ÏòÅÌòº', 'ÌååÎèô', 'ÏÉùÎ™ÖÏ≤¥', 'ÌÉêÌóòÍ∞Ä', 'Î∞©ÎûëÏûê'];
        
        return {
            name: adj[Math.floor(Math.random() * adj.length)] + ' ' + 
                  noun[Math.floor(Math.random() * noun.length)],
            primaryColor,
            secondaryColor,
            pattern: patterns[Math.floor(Math.random() * patterns.length)],
            wobblePoints: 8 + Math.floor(Math.random() * 6),
            wobbleIntensity: 0.5 + Math.random() * 0.5,
            glowIntensity: 0.3 + Math.random() * 0.5
        };
    };
    
    // ÏÑ∏Ìè¨ Í∑∏Î¶¨Í∏∞
    const draw = (ctx, x, y, size, design, evolution = {}, time = 0) => {
        const d = design || generateDesign();
        const points = d.wobblePoints || 12;
        
        ctx.save();
        ctx.translate(x, y);
        
        // Í∏ÄÎ°úÏö∞ Ìö®Í≥º
        if (d.pattern === 'glow' || d.glowIntensity > 0.5) {
            ctx.shadowColor = d.primaryColor;
            ctx.shadowBlur = 20 * (d.glowIntensity || 0.5);
        }
        
        // Î™∏Ï≤¥ Í∑∏Î¶¨Í∏∞
        ctx.beginPath();
        for (let i = 0; i < points; i++) {
            const angle = (i / points) * Math.PI * 2;
            const wobble = Math.sin(time * 0.05 + i * 0.5) * 5 * (d.wobbleIntensity || 1);
            const r = size + wobble;
            const px = Math.cos(angle) * r;
            const py = Math.sin(angle) * r;
            
            if (i === 0) ctx.moveTo(px, py);
            else ctx.lineTo(px, py);
        }
        ctx.closePath();
        
        // Í∑∏ÎùºÎîîÏñ∏Ìä∏ Ï±ÑÏö∞Í∏∞
        const gradient = ctx.createRadialGradient(-size * 0.3, -size * 0.3, 0, 0, 0, size * 1.2);
        gradient.addColorStop(0, d.primaryColor);
        gradient.addColorStop(0.6, d.secondaryColor);
        gradient.addColorStop(1, d.secondaryColor);
        ctx.fillStyle = gradient;
        ctx.fill();
        
        ctx.shadowBlur = 0;
        
        // Ìå®ÌÑ¥
        if (d.pattern === 'spots') {
            ctx.fillStyle = 'rgba(255,255,255,0.3)';
            for (let i = 0; i < 5; i++) {
                const angle = (i / 5) * Math.PI * 2 + time * 0.02;
                ctx.beginPath();
                ctx.arc(Math.cos(angle) * size * 0.5, Math.sin(angle) * size * 0.5, size * 0.1, 0, Math.PI * 2);
                ctx.fill();
            }
        }
        
        // ÌïòÏù¥ÎùºÏù¥Ìä∏
        ctx.beginPath();
        ctx.arc(-size * 0.25, -size * 0.25, size * 0.2, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(255,255,255,0.25)';
        ctx.fill();
        
        // ÏßÑÌôîÎêú ÌååÏ∏†
        if (evolution.eye) {
            ctx.beginPath();
            ctx.arc(size * 0.3, -size * 0.2, size * 0.15, 0, Math.PI * 2);
            ctx.fillStyle = 'white';
            ctx.fill();
            ctx.beginPath();
            ctx.arc(size * 0.32, -size * 0.22, size * 0.08, 0, Math.PI * 2);
            ctx.fillStyle = '#1a1a2e';
            ctx.fill();
        }
        
        if (evolution.arm) {
            ctx.strokeStyle = d.primaryColor;
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            for (let i = 0; i < 2; i++) {
                const baseAngle = (i === 0 ? 0.3 : -0.3) * Math.PI;
                ctx.beginPath();
                ctx.moveTo(Math.cos(baseAngle) * size, Math.sin(baseAngle) * size);
                const wobble = Math.sin(time * 0.1 + i) * 0.2;
                ctx.quadraticCurveTo(
                    Math.cos(baseAngle) * size * 1.5,
                    Math.sin(baseAngle + wobble) * size * 1.2,
                    Math.cos(baseAngle) * size * 1.8,
                    Math.sin(baseAngle + wobble * 2) * size
                );
                ctx.stroke();
            }
        }
        
        if (evolution.wing) {
            ctx.fillStyle = `${d.primaryColor}66`;
            for (let i = 0; i < 2; i++) {
                const dir = i === 0 ? 1 : -1;
                const flapAngle = Math.sin(time * 0.15) * 0.3;
                ctx.beginPath();
                ctx.ellipse(
                    dir * size * 0.8, 0,
                    size * 0.6, size * 0.3,
                    dir * (0.3 + flapAngle),
                    0, Math.PI * 2
                );
                ctx.fill();
            }
        }
        
        ctx.restore();
    };
    
    // Ï∫îÎ≤ÑÏä§ Ïï†ÎãàÎ©îÏù¥ÏÖò ÏãúÏûë
    const animate = (canvasId, design, evolution = {}) => {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return null;
        
        const ctx = canvas.getContext('2d');
        let time = 0;
        let animationId = null;
        
        const render = () => {
            time++;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            draw(ctx, canvas.width / 2, canvas.height / 2, Math.min(canvas.width, canvas.height) * 0.3, design, evolution, time);
            animationId = requestAnimationFrame(render);
        };
        
        render();
        
        return () => {
            if (animationId) cancelAnimationFrame(animationId);
        };
    };
    
    return { generateDesign, draw, animate };
})();


/* ========================================
   Module: Environments
======================================== */
const Environments = (() => {
    const list = [
        {
            id: 'ocean',
            name: 'ÏõêÏãú Ìï¥Ïñë',
            icon: 'üåä',
            range: [1, 16],
            color: '#00b4d8',
            description: '"Î∞îÎã§Îäî ÏÉùÎ™ÖÏùò ÏöîÎûå. Ïñ¥ÎîîÏÑúÎì† Ï†ÅÏùëÌïúÎã§."',
            weakness: '"Í±¥Ï°∞Ìïú ÌôòÍ≤ΩÏùÄ ÏπòÎ™ÖÏ†ÅÏù¥Îã§."',
            stats: { adaptation: 90, photosynthesis: 70, heatResist: 30, coldResist: 50 }
        },
        {
            id: 'hydrothermal',
            name: 'Ïó¥ÏàòÍµ¨',
            icon: 'üî•',
            range: [17, 32],
            color: '#ff6b35',
            description: '"Í∑πÌïú ÌôòÍ≤Ω? ÎãπÏã†Ïùò ÏùºÏÉÅÏù¥Îã§."',
            weakness: '"ÌèâÏò®Ìïú Í≥≥ÏóêÏÑúÎäî Ïò§ÌûàÎ†§ Î∂àÏïàÌïòÎã§."',
            stats: { adaptation: 40, chemosynthesis: 80, heatResist: 85, coldResist: 20 }
        },
        {
            id: 'ice',
            name: 'ÏñºÏùå Î∞îÎã§',
            icon: 'üßä',
            range: [33, 48],
            color: '#457b9d',
            description: '"Ï†ÅÏùÄ Í≤ÉÏúºÎ°ú Ïò§Îûò Î≤ÑÌã¥Îã§. Ìö®Ïú®Ïùò Îã¨Ïù∏."',
            weakness: '"Îú®Í±∞Ïö¥ ÌôòÍ≤ΩÏùÄ ÎãπÏã†ÏùÑ ÎÖπÏù∏Îã§."',
            stats: { adaptation: 60, efficiency: 90, heatResist: 15, coldResist: 90 }
        },
        {
            id: 'magma',
            name: 'ÎßàÍ∑∏Îßà Ìò∏Ïàò',
            icon: 'üåã',
            range: [49, 64],
            color: '#ff4800',
            description: '"Ïö©Ïïî ÌñâÏÑ±? ÎãπÏã†ÎßåÏùò ÎÜÄÏù¥ÌÑ∞."',
            weakness: '"ÏñºÏùå ÏÑ∏Í≥ÑÎäî ÎãπÏã†Ïùò Î¨¥Îç§."',
            stats: { adaptation: 30, energyAbsorb: 85, heatResist: 95, coldResist: 10 }
        },
        {
            id: 'atmosphere',
            name: 'ÎåÄÍ∏∞ Î∂ÄÏú†',
            icon: '‚òÅÔ∏è',
            range: [65, 80],
            color: '#c77dff',
            description: '"ÌïòÎäòÏùÑ ÎÇòÎäî Ïûê, ÏÑ∏ÏÉÅÏùÑ Î≥∏Îã§."',
            weakness: '"Î¨¥Í±∞Ïö¥ Í≤ÉÏùÄ ÎãπÏã†Ïùò Ï†ÅÏù¥Îã§."',
            stats: { adaptation: 70, flight: 90, heatResist: 50, coldResist: 50 }
        },
        {
            id: 'toxic',
            name: 'ÎèÖÏÑ± Îä™',
            icon: 'üíÄ',
            range: [81, 100],
            color: '#70e000',
            description: '"ÎèÖÏùÄ ÏïΩÏù¥ ÎêòÍ≥†, ÏïΩÏùÄ Î¨¥Í∏∞Í∞Ä ÎêúÎã§."',
            weakness: '"Íπ®ÎÅóÌïú ÌôòÍ≤ΩÏù¥ Ïò§ÌûàÎ†§ Î∂àÌé∏ÌïòÎã§."',
            stats: { adaptation: 75, toxicResist: 95, heatResist: 60, coldResist: 40 }
        }
    ];
    
    const getById = (id) => list.find(e => e.id === id);
    
    const getByRoll = (roll) => list.find(e => roll >= e.range[0] && roll <= e.range[1]);
    
    return { list, getById, getByRoll };
})();


/* ========================================
   Module: Settings UI
======================================== */
const SettingsUI = (() => {
    const show = () => {
        const settings = AudioSystem.settings;
        
        const html = `
            <h2 class="modal-title">‚öôÔ∏è ÏÑ§Ï†ï</h2>
            
            <div class="settings-section">
                <div class="settings-section-title">üîä ÏÇ¨Ïö¥Îìú</div>
                
                <div class="settings-row">
                    <div class="settings-label">
                        <span class="settings-label-icon">üîà</span>
                        <span>ÎßàÏä§ÌÑ∞ Î≥ºÎ•®</span>
                    </div>
                    <input type="range" class="volume-slider" id="master-volume" 
                           min="0" max="100" value="${settings.masterVolume * 100}">
                </div>
                
                <div class="settings-row">
                    <div class="settings-label">
                        <span class="settings-label-icon">üéµ</span>
                        <span>Î∞∞Í≤ΩÏùåÏïÖ</span>
                    </div>
                    <div class="flex items-center gap-md">
                        <input type="range" class="volume-slider" id="bgm-volume" 
                               min="0" max="100" value="${settings.bgmVolume * 100}"
                               ${!settings.bgmEnabled ? 'disabled' : ''}>
                        <div class="toggle ${settings.bgmEnabled ? 'active' : ''}" id="bgm-toggle">
                            <div class="toggle-knob"></div>
                        </div>
                    </div>
                </div>
                
                <div class="settings-row">
                    <div class="settings-label">
                        <span class="settings-label-icon">üîî</span>
                        <span>Ìö®Í≥ºÏùå</span>
                    </div>
                    <div class="flex items-center gap-md">
                        <input type="range" class="volume-slider" id="sfx-volume" 
                               min="0" max="100" value="${settings.sfxVolume * 100}"
                               ${!settings.sfxEnabled ? 'disabled' : ''}>
                        <div class="toggle ${settings.sfxEnabled ? 'active' : ''}" id="sfx-toggle">
                            <div class="toggle-knob"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="settings-section">
                <div class="settings-section-title">üé≤ ÌÖåÏä§Ìä∏</div>
                
                <div class="settings-row">
                    <span>Ï£ºÏÇ¨ÏúÑ Ìö®Í≥ºÏùå ÌÖåÏä§Ìä∏</span>
                    <button class="btn btn-outline btn-sm" id="test-dice-sound">üé≤ Ïû¨ÏÉù</button>
                </div>
                
                <div class="settings-row">
                    <span>ÏÑ±Í≥µ Ìö®Í≥ºÏùå ÌÖåÏä§Ìä∏</span>
                    <button class="btn btn-outline btn-sm" id="test-success-sound">‚úÖ Ïû¨ÏÉù</button>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-primary" id="settings-close">ÌôïÏù∏</button>
            </div>
        `;
        
        Modal.setContent('settings-modal', 'settings-modal-content', html);
        Modal.show('settings-modal');
        
        // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
        document.getElementById('master-volume').oninput = (e) => {
            AudioSystem.setMasterVolume(e.target.value / 100);
        };
        
        document.getElementById('bgm-volume').oninput = (e) => {
            AudioSystem.setBgmVolume(e.target.value / 100);
        };
        
        document.getElementById('sfx-volume').oninput = (e) => {
            AudioSystem.setSfxVolume(e.target.value / 100);
        };
        
        document.getElementById('bgm-toggle').onclick = (e) => {
            const toggle = e.currentTarget;
            const isActive = toggle.classList.toggle('active');
            AudioSystem.setBgmEnabled(isActive);
            document.getElementById('bgm-volume').disabled = !isActive;
        };
        
        document.getElementById('sfx-toggle').onclick = (e) => {
            const toggle = e.currentTarget;
            const isActive = toggle.classList.toggle('active');
            AudioSystem.setSfxEnabled(isActive);
            document.getElementById('sfx-volume').disabled = !isActive;
        };
        
        document.getElementById('test-dice-sound').onclick = () => {
            AudioSystem.playDiceRoll();
        };
        
        document.getElementById('test-success-sound').onclick = () => {
            AudioSystem.playSuccess();
        };
        
        document.getElementById('settings-close').onclick = () => {
            Modal.hide('settings-modal');
        };
    };
    
    return { show };
})();


/* ========================================
   Module: Pages
======================================== */
const Pages = (() => {
    let currentPage = 'title';
    let cleanupFunctions = [];
    
    // ÌéòÏù¥ÏßÄ Ï†ïÎ¶¨
    const cleanup = () => {
        cleanupFunctions.forEach(fn => fn());
        cleanupFunctions = [];
    };
    
    // ÌÉÄÏù¥ÌãÄ ÌéòÏù¥ÏßÄ
    const renderTitle = () => {
        const app = document.getElementById('app');
        app.innerHTML = `
            <div class="page page-center">
                <div class="container container-sm text-center">
                    <div class="animate-float mb-xl">
                        <span style="font-size: 5rem;">üé≤</span>
                    </div>
                    
                    <h1 class="title-xl mb-sm">BOKLUCK</h1>
                    <h2 class="title-md text-secondary mb-lg">Universe</h2>
                    
                    <p class="text-secondary mb-xl" style="max-width: 320px; margin: 0 auto var(--space-xl);">
                        <strong class="text-gradient-energy">BOK(Î≥µ)</strong> ÎòêÎäî 
                        <strong class="text-gradient-cosmic">LUCK(Ïö¥)</strong>ÏúºÎ°ú<br>
                        ÎßåÎì§Ïñ¥Í∞ÄÎäî ÎãπÏã†ÎßåÏùò Ïö∞Ï£º Ïù¥ÏïºÍ∏∞
                    </p>
                    
                    <div class="flex flex-col gap-md" style="max-width: 280px; margin: 0 auto;">
                        <button class="btn btn-energy btn-lg btn-block" id="btn-start">
                            üöÄ Í≤åÏûÑ ÏãúÏûë
                        </button>
                        <button class="btn btn-outline btn-block" id="btn-settings">
                            ‚öôÔ∏è ÏÑ§Ï†ï
                        </button>
                    </div>
                    
                    <p class="text-muted text-xs mt-xl">
                        v0.1.0 | ÌÖåÏä§Ìä∏ Î≤ÑÏ†Ñ
                    </p>
                </div>
            </div>
        `;
        
        document.getElementById('btn-start').onclick = () => {
            AudioSystem.resume();
            AudioSystem.playClick();
            navigate('saveSelect');
        };
        
        document.getElementById('btn-settings').onclick = () => {
            AudioSystem.resume();
            AudioSystem.playClick();
            SettingsUI.show();
        };
    };
    
    // Ï†ÄÏû• Ïä¨Î°Ø ÏÑ†ÌÉù ÌéòÏù¥ÏßÄ
    const renderSaveSelect = () => {
        const slots = SaveSystem.getAllSlots();
        
        const app = document.getElementById('app');
        app.innerHTML = `
            <div class="page" style="padding: var(--space-xl) var(--space-md);">
                <div class="container container-sm">
                    <div class="flex items-center justify-between mb-lg">
                        <button class="btn btn-ghost btn-sm" id="btn-back">
                            ‚Üê Îí§Î°ú
                        </button>
                        <h1 class="title-md">üíæ Ï†ÄÏû• Ïä¨Î°Ø</h1>
                        <div style="width: 60px;"></div>
                    </div>
                    
                    <div class="save-slots">
                        ${slots.map((slot, i) => renderSaveSlot(slot, i)).join('')}
                    </div>
                </div>
            </div>
        `;
        
        document.getElementById('btn-back').onclick = () => {
            AudioSystem.playClick();
            navigate('title');
        };
        
        // Ïä¨Î°Ø ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
        slots.forEach((slot, i) => {
            const slotEl = document.getElementById(`save-slot-${i}`);
            
            if (slot) {
                // Í∏∞Ï°¥ ÏÑ∏Ïù¥Î∏å - Î∂àÎü¨Ïò§Í∏∞ ÎòêÎäî ÏÇ≠Ï†ú
                slotEl.querySelector('.btn-load')?.addEventListener('click', (e) => {
                    e.stopPropagation();
                    AudioSystem.playClick();
                    loadGame(i);
                });
                
                slotEl.querySelector('.btn-delete')?.addEventListener('click', (e) => {
                    e.stopPropagation();
                    AudioSystem.playClick();
                    confirmDelete(i);
                });
            } else {
                // Îπà Ïä¨Î°Ø - ÏÉà Í≤åÏûÑ
                slotEl.onclick = () => {
                    AudioSystem.playClick();
                    startNewGame(i);
                };
            }
        });
    };
    
    // Ï†ÄÏû• Ïä¨Î°Ø HTML ÏÉùÏÑ±
    const renderSaveSlot = (slot, index) => {
        if (!slot) {
            return `
                <div class="save-slot empty" id="save-slot-${index}">
                    <div class="save-slot-header">
                        <span class="save-slot-number">Ïä¨Î°Ø ${index + 1}</span>
                    </div>
                    <div class="text-center" style="padding: var(--space-lg) 0;">
                        <span style="font-size: 2rem; opacity: 0.5;">‚ûï</span>
                        <p class="text-muted mt-md">ÏÉà Í≤åÏûÑ ÏãúÏûë</p>
                    </div>
                </div>
            `;
        }
        
        const stageName = ['ÎØ∏ÏãúÏûë', 'ÏÑ∏Ìè¨', 'Îã§ÏÑ∏Ìè¨', 'Î¨∏Î™Ö', 'Ïö∞Ï£º'][slot.stage] || '???';
        const envIcon = slot.dna?.origin ? Environments.getById(slot.dna.origin)?.icon : '‚ùì';
        
        return `
            <div class="save-slot" id="save-slot-${index}">
                <div class="save-slot-header">
                    <span class="save-slot-number">Ïä¨Î°Ø ${index + 1}</span>
                    <span class="text-xs text-muted">${SaveSystem.formatDate(slot.updatedAt)}</span>
                </div>
                
                <div class="save-slot-name">${slot.cellName || 'Ïù¥Î¶Ñ ÏóÜÏùå'}</div>
                <div class="save-slot-info">
                    <span>${envIcon} ${stageName} Îã®Í≥Ñ</span>
                    <span style="margin-left: var(--space-md);">‚ö° ${slot.entropy?.toLocaleString() || 0}</span>
                </div>
                
                <div class="save-slot-preview">
                    <canvas class="cell-canvas cell-preview-sm" 
                            id="slot-preview-${index}" 
                            width="60" height="60"></canvas>
                    <div style="flex: 1;">
                        <div class="text-xs text-muted">ÌîåÎ†àÏù¥ ÏãúÍ∞Ñ</div>
                        <div class="text-sm">${SaveSystem.formatPlayTime(slot.playTime)}</div>
                    </div>
                </div>
                
                <div class="save-slot-actions">
                    <button class="btn btn-energy btn-sm btn-load" style="flex: 1;">
                        ‚ñ∂Ô∏è Î∂àÎü¨Ïò§Í∏∞
                    </button>
                    <button class="btn btn-outline btn-sm btn-delete">
                        üóëÔ∏è
                    </button>
                </div>
            </div>
        `;
    };
    
    // ÏÉà Í≤åÏûÑ ÏãúÏûë
    const startNewGame = (slotIndex) => {
        GameState.startNew(slotIndex);
        navigate('birth');
    };
    
    // Í≤åÏûÑ Î∂àÎü¨Ïò§Í∏∞
    const loadGame = (slotIndex) => {
        const data = GameState.loadSlot(slotIndex);
        if (!data) {
            Toast.show('Ï†ÄÏû• Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.', 'error');
            return;
        }
        
        Toast.show('Í≤åÏûÑÏùÑ Î∂àÎü¨ÏôîÏäµÎãàÎã§!', 'success');
        
        // Îã®Í≥ÑÏóê Îî∞Îùº Ï†ÅÏ†àÌïú ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
        if (data.stage === 0) {
            navigate('birth');
        } else {
            navigate('dashboard');
        }
    };
    
    // ÏÇ≠Ï†ú ÌôïÏù∏
    const confirmDelete = (slotIndex) => {
        const html = `
            <h2 class="modal-title">üóëÔ∏è ÏÇ≠Ï†ú ÌôïÏù∏</h2>
            <p class="modal-desc">
                Ïä¨Î°Ø ${slotIndex + 1}Ïùò Îç∞Ïù¥ÌÑ∞Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?<br>
                <strong style="color: var(--danger);">Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§!</strong>
            </p>
            <div class="modal-actions">
                <button class="btn btn-outline" id="cancel-delete">Ï∑®ÏÜå</button>
                <button class="btn btn-danger" id="confirm-delete">ÏÇ≠Ï†ú</button>
            </div>
        `;
        
        Modal.setContent('generic-modal', 'generic-modal-content', html);
        Modal.show('generic-modal');
        
        document.getElementById('cancel-delete').onclick = () => {
            Modal.hide('generic-modal');
        };
        
        document.getElementById('confirm-delete').onclick = () => {
            SaveSystem.deleteSlot(slotIndex);
            Modal.hide('generic-modal');
            Toast.show('ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.', 'info');
            navigate('saveSelect');
        };
    };
    
    // ÌÉÑÏÉù ÌéòÏù¥ÏßÄ
    const renderBirth = () => {
        const app = document.getElementById('app');
        app.innerHTML = `
            <div class="page page-center">
                <div class="container container-sm text-center">
                    <div class="animate-float mb-lg">
                        <span style="font-size: 4rem;">üåå</span>
                    </div>
                    
                    <h1 class="title-lg text-gradient-cosmic mb-md">ÏùòÏãùÏù¥ Íπ®Ïñ¥ÎÇúÎã§</h1>
                    
                    <p class="text-secondary mb-xl" style="line-height: 1.8;">
                        ÎãπÏã†ÏùÄ Î¨¥ÏóáÏù∏Í∞Ä?<br>
                        ÏïÑÏßÅÏùÄ ÏïÑÎ¨¥Í≤ÉÎèÑ ÏïÑÎãàÎã§.<br>
                        ÌïòÎÇòÏùò Í∞ÄÎä•ÏÑ±Ïùº Îøê.<br><br>
                        <em class="text-muted">Ïö∞Ï£ºÍ∞Ä ÎãπÏã†Ïùò Ïö¥Î™ÖÏùÑ Í≤∞Ï†ïÌïúÎã§...</em>
                    </p>
                    
                    <button class="btn btn-energy btn-lg" id="btn-roll-birth">
                        üé≤ Ïö¥Î™ÖÏùò Ï£ºÏÇ¨ÏúÑÎ•º Íµ¥Î¶∞Îã§
                    </button>
                </div>
            </div>
        `;
        
        document.getElementById('btn-roll-birth').onclick = () => {
            AudioSystem.playClick();
            rollBirthEnvironment();
        };
    };
    
    // ÌôòÍ≤Ω Ï£ºÏÇ¨ÏúÑ
    const rollBirthEnvironment = () => {
        const roll = Math.floor(Math.random() * 100) + 1;
        const env = Environments.getByRoll(roll);
        
        // Ï£ºÏÇ¨ÏúÑ Î™®Îã¨ ÌëúÏãú (ÌäπÎ≥Ñ Î≤ÑÏ†Ñ)
        const html = `
            <div class="dice-container">
                <h2 class="title-lg text-gradient-energy mb-md">üé≤ ÌôòÍ≤Ω Ï∂îÏ≤®</h2>
                <p class="text-secondary mb-lg">ÎãπÏã†Ïù¥ ÌÉúÏñ¥ÎÇ† Í≥≥Ïù¥ Í≤∞Ï†ïÎê©ÎãàÎã§</p>
                
                <div class="environment-grid mb-lg">
                    ${Environments.list.map(e => `
                        <div class="environment-card" id="env-card-${e.id}" style="opacity: 0.3;">
                            <div class="environment-icon">${e.icon}</div>
                            <div class="environment-name">${e.name}</div>
                        </div>
                    `).join('')}
                </div>
                
                <button class="btn btn-energy btn-lg btn-block" id="btn-roll-env">
                    Ïö¥Î™ÖÏùÑ Î∞õÏïÑÎì§Ïù∏Îã§
                </button>
            </div>
        `;
        
        Modal.setContent('dice-modal', 'dice-modal-content', html);
        Modal.show('dice-modal');
        
        document.getElementById('btn-roll-env').onclick = () => {
            const btn = document.getElementById('btn-roll-env');
            btn.disabled = true;
            btn.textContent = 'Ïö¥Î™ÖÏùÑ Í≤∞Ï†ïÌïòÎäî Ï§ë...';
            
            AudioSystem.playDiceRoll();
            
            // ÌôòÍ≤Ω ÏàúÌôò Ïï†ÎãàÎ©îÏù¥ÏÖò
            let currentIndex = 0;
            const envList = Environments.list;
            const intervalId = setInterval(() => {
                envList.forEach((e, i) => {
                    const card = document.getElementById(`env-card-${e.id}`);
                    card.style.opacity = i === currentIndex ? '1' : '0.3';
                    card.style.transform = i === currentIndex ? 'scale(1.1)' : 'scale(1)';
                });
                currentIndex = (currentIndex + 1) % envList.length;
            }, 100);
            
            // 1.5Ï¥à ÌõÑ Í≤∞Í≥º
            setTimeout(() => {
                clearInterval(intervalId);
                showBirthResult(roll, env);
            }, 1500);
        };
    };
    
    // ÌÉÑÏÉù Í≤∞Í≥º ÌëúÏãú
    const showBirthResult = (roll, env) => {
        AudioSystem.playLegendary();
        
        const html = `
            <div class="text-center">
                <div class="dice-result-display critical mb-md">${roll}</div>
                
                <div class="animate-float mb-lg">
                    <span style="font-size: 5rem;">${env.icon}</span>
                </div>
                
                <h2 class="title-lg mb-md" style="color: ${env.color};">${env.name}</h2>
                
                <div class="dna-card">
                    <div class="dna-trait dna-trait-strength">
                        <span>‚ú®</span>
                        <span>${env.description}</span>
                    </div>
                    <div class="dna-trait dna-trait-weakness">
                        <span>‚ö†Ô∏è</span>
                        <span>${env.weakness}</span>
                    </div>
                </div>
                
                <button class="btn btn-energy btn-lg btn-block mt-lg" id="btn-accept-birth">
                    Ïù¥ Ïö¥Î™ÖÏùÑ Î∞õÏïÑÎì§Ïù∏Îã§
                </button>
            </div>
        `;
        
        document.getElementById('dice-modal-content').innerHTML = html;
        
        document.getElementById('btn-accept-birth').onclick = () => {
            completeBirth(env);
        };
    };
    
    // ÌÉÑÏÉù ÏôÑÎ£å
    const completeBirth = (env) => {
        const gameData = GameState.get();
        
        // ÏÑ∏Ìè¨ ÎîîÏûêÏù∏ ÏÉùÏÑ±
        gameData.cellDesign = CellRenderer.generateDesign(env.id);
        gameData.cellName = gameData.cellDesign.name;
        
        // DNA ÏÑ§Ï†ï
        gameData.dna = {
            origin: env.id,
            traits: [`${env.id.toUpperCase()}_NATIVE`],
            evolutionPath: []
        };
        
        // Ïä§ÌÖåÏù¥ÏßÄ ÏÑ§Ï†ï
        gameData.stage = 1;
        gameData.entropy = 100;
        
        // Ïó≠ÏÇ¨ Í∏∞Î°ù
        gameData.history.push({
            chapter: 1,
            title: 'ÌÉÑÏÉù',
            content: `${env.name}ÏóêÏÑú ÌïòÎÇòÏùò ÏÉùÎ™ÖÏù¥ Íπ®Ïñ¥ÎÇ¨Îã§. ${env.description.replace(/"/g, '')}`,
            timestamp: Date.now()
        });
        
        GameState.save();
        
        Modal.hide('dice-modal');
        Toast.show('üéâ ÏÉàÎ°úÏö¥ ÏÉùÎ™ÖÏù¥ ÌÉÑÏÉùÌñàÏäµÎãàÎã§!', 'legendary');
        navigate('dashboard');
    };
    
    // ÎåÄÏãúÎ≥¥Îìú ÌéòÏù¥ÏßÄ
    const renderDashboard = () => {
        const gameData = GameState.get();
        if (!gameData) {
            navigate('saveSelect');
            return;
        }
        
        const env = Environments.getById(gameData.dna?.origin);
        const stageName = ['ÎØ∏ÏãúÏûë', 'ü¶† ÏÑ∏Ìè¨', 'ü¶é Îã§ÏÑ∏Ìè¨', 'üèõÔ∏è Î¨∏Î™Ö', 'üöÄ Ïö∞Ï£º'][gameData.stage] || '???';
        
        const app = document.getElementById('app');
        app.innerHTML = `
            <div class="page" style="padding: var(--space-md);">
                <div class="container">
                    <!-- Ìó§Îçî -->
                    <div class="flex items-center justify-between mb-lg">
                        <div>
                            <h1 class="title-md text-gradient-energy">${gameData.cellName || 'Ïù¥Î¶Ñ ÏóÜÏùå'}</h1>
                            <p class="text-xs text-muted">${stageName} Îã®Í≥Ñ</p>
                        </div>
                        <div class="flex gap-sm">
                            <button class="btn btn-ghost btn-icon" id="btn-settings">‚öôÔ∏è</button>
                            <button class="btn btn-ghost btn-icon" id="btn-save">üíæ</button>
                            <button class="btn btn-outline btn-sm" id="btn-exit">ÎÇòÍ∞ÄÍ∏∞</button>
                        </div>
                    </div>
                    
                    <!-- Î©îÏù∏ Í∑∏Î¶¨Îìú -->
                    <div style="display: grid; grid-template-columns: 280px 1fr; gap: var(--space-lg);">
                        <!-- Ï¢åÏ∏°: ÏÑ∏Ìè¨ Ï†ïÎ≥¥ -->
                        <div>
                            <div class="card card-glow mb-md">
                                <div class="text-center">
                                    <canvas class="cell-canvas cell-preview" 
                                            id="cell-canvas" 
                                            width="180" height="180"></canvas>
                                    <h2 class="title-md mt-md">${gameData.cellName}</h2>
                                    <p class="text-sm text-muted">${env?.icon} ${env?.name || '???'}</p>
                                </div>
                                
                                <div class="stat-grid mt-lg">
                                    <div class="stat-box">
                                        <div class="stat-value">${gameData.entropy?.toLocaleString() || 0}</div>
                                        <div class="stat-label">ÏóîÌä∏Î°úÌîº</div>
                                    </div>
                                    <div class="stat-box">
                                        <div class="stat-value">${Object.values(gameData.evolution || {}).filter(v => v).length}</div>
                                        <div class="stat-label">ÏßÑÌôî</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- DNA ÌäπÏÑ± -->
                            <div class="card">
                                <div class="card-header">
                                    <span class="title-md">üß¨ DNA</span>
                                </div>
                                ${(gameData.dna?.traits || []).map(trait => `
                                    <div class="dna-trait dna-trait-strength">
                                        <span>üîπ</span>
                                        <span>${trait.replace('_', ' ')}</span>
                                    </div>
                                `).join('') || '<p class="text-muted text-center">ÌäπÏÑ± ÏóÜÏùå</p>'}
                            </div>
                        </div>
                        
                        <!-- Ïö∞Ï∏°: Ïï°ÏÖò & Ï†ïÎ≥¥ -->
                        <div>
                            <!-- Îπ†Î•∏ Ïï°ÏÖò -->
                            <div class="card mb-md">
                                <div class="card-header">
                                    <span class="title-md">‚ö° ÌñâÎèô</span>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--space-sm);">
                                    <button class="btn btn-outline" id="btn-explore" style="flex-direction: column; padding: var(--space-md);">
                                        <span style="font-size: 1.5rem;">üîç</span>
                                        <span class="text-xs mt-sm">ÌÉêÌóò</span>
                                    </button>
                                    <button class="btn btn-outline" id="btn-evolve" style="flex-direction: column; padding: var(--space-md);">
                                        <span style="font-size: 1.5rem;">üß¨</span>
                                        <span class="text-xs mt-sm">ÏßÑÌôî</span>
                                    </button>
                                    <button class="btn btn-outline" id="btn-dice-test" style="flex-direction: column; padding: var(--space-md);">
                                        <span style="font-size: 1.5rem;">üé≤</span>
                                        <span class="text-xs mt-sm">Ï£ºÏÇ¨ÏúÑ</span>
                                    </button>
                                    <button class="btn btn-outline" id="btn-history" style="flex-direction: column; padding: var(--space-md);">
                                        <span style="font-size: 1.5rem;">üìú</span>
                                        <span class="text-xs mt-sm">Ïó≠ÏÇ¨</span>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Ïó≠ÏÇ¨ -->
                            <div class="card">
                                <div class="card-header">
                                    <span class="title-md">üìú ÏµúÍ∑º Ïó≠ÏÇ¨</span>
                                </div>
                                ${(gameData.history || []).length === 0 
                                    ? '<p class="text-muted text-center">ÏïÑÏßÅ Í∏∞Î°ùÎêú Ïó≠ÏÇ¨Í∞Ä ÏóÜÏäµÎãàÎã§.</p>'
                                    : (gameData.history || []).slice(-3).reverse().map(h => `
                                        <div style="background: var(--void-light); border-radius: var(--radius-md); padding: var(--space-md); margin-bottom: var(--space-sm); border-left: 3px solid var(--neon-purple);">
                                            <div class="text-xs text-muted mb-xs">Ï†ú${h.chapter}Ïû•</div>
                                            <div class="text-sm font-bold mb-xs">${h.title}</div>
                                            <div class="text-xs text-secondary">${h.content}</div>
                                        </div>
                                    `).join('')
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // ÏÑ∏Ìè¨ Ïï†ÎãàÎ©îÏù¥ÏÖò
        const stopAnimation = CellRenderer.animate('cell-canvas', gameData.cellDesign, gameData.evolution);
        cleanupFunctions.push(stopAnimation);
        
        // Ïù¥Î≤§Ìä∏
        document.getElementById('btn-settings').onclick = () => {
            AudioSystem.playClick();
            SettingsUI.show();
        };
        
        document.getElementById('btn-save').onclick = () => {
            AudioSystem.playClick();
            GameState.save();
            Toast.show('Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!', 'success');
        };
        
        document.getElementById('btn-exit').onclick = () => {
            AudioSystem.playClick();
            GameState.save();
            navigate('saveSelect');
        };
        
        document.getElementById('btn-dice-test').onclick = () => {
            AudioSystem.playClick();
            testDiceRoll();
        };
        
        document.getElementById('btn-explore').onclick = () => {
            AudioSystem.playClick();
            doExplore();
        };
        
        document.getElementById('btn-evolve').onclick = () => {
            AudioSystem.playClick();
            Toast.show('ÏßÑÌôî Í∏∞Îä• Ï§ÄÎπÑ Ï§ë...', 'info');
        };
        
        document.getElementById('btn-history').onclick = () => {
            AudioSystem.playClick();
            Toast.show('Ïó≠ÏÇ¨ Í∏∞Îä• Ï§ÄÎπÑ Ï§ë...', 'info');
        };
    };
    
    // Ï£ºÏÇ¨ÏúÑ ÌÖåÏä§Ìä∏
    const testDiceRoll = () => {
        const gameData = GameState.get();
        const playerStat = 50 + Object.values(gameData?.evolution || {}).filter(v => v).length * 10;
        const opponentStat = 30 + Math.floor(Math.random() * 40);
        
        DiceSystem.show({
            situation: 'ÎØ∏ÏßÄÏùò Ï°¥Ïû¨ÏôÄ ÎßàÏ£ºÏ≥§Îã§!',
            playerStat,
            opponentStat,
            onComplete: (result) => {
                if (result.won) {
                    const reward = result.critical ? 200 : 100;
                    GameState.addEntropy(reward);
                    Toast.show(`ÏäπÎ¶¨! +${reward}‚ö°`, result.critical ? 'legendary' : 'success');
                } else {
                    Toast.show('Ìå®Î∞∞...', 'error');
                }
                GameState.save();
                navigate('dashboard');
            }
        });
    };
    
    // ÌÉêÌóò
    const doExplore = () => {
        const gameData = GameState.get();
        const cost = 30;
        
        if (gameData.entropy < cost) {
            Toast.show(`ÏóîÌä∏Î°úÌîºÍ∞Ä Î∂ÄÏ°±Ìï©ÎãàÎã§! (${cost}‚ö° ÌïÑÏöî)`, 'error');
            return;
        }
        
        GameState.addEntropy(-cost);
        
        // ÎûúÎç§ Ïù¥Î≤§Ìä∏
        const roll = Math.random();
        let reward = 0;
        let message = '';
        let type = 'info';
        
        if (roll < 0.05) {
            // Ï†ÑÏÑ§Í∏â Î∞úÍ≤¨
            reward = 300;
            message = '‚≠ê Ï†ÑÏÑ§Ï†ÅÏù∏ ÏóêÎÑàÏßÄÏõêÏùÑ Î∞úÍ≤¨ÌñàÎã§!';
            type = 'legendary';
            GameState.addHistory('Ï†ÑÏÑ§ Î∞úÍ≤¨', 'Ïö∞Ï£ºÏùò Ïã†ÎπÑÎ°úÏö¥ ÏóêÎÑàÏßÄÍ∞Ä ÎãπÏã†ÏùÑ ÏÑ†ÌÉùÌñàÎã§.');
        } else if (roll < 0.2) {
            // Ï¢ãÏùÄ Î∞úÍ≤¨
            reward = 100;
            message = '‚ú® ÌíçÎ∂ÄÌïú ÏûêÏõêÏùÑ Î∞úÍ≤¨ÌñàÎã§!';
            type = 'success';
        } else if (roll < 0.5) {
            // Î≥¥ÌÜµ Î∞úÍ≤¨
            reward = 50;
            message = 'Î∞úÍ≤¨: ÏïΩÍ∞ÑÏùò ÏóêÎÑàÏßÄÎ•º Ìù°ÏàòÌñàÎã§.';
            type = 'info';
        } else if (roll < 0.8) {
            // ÎπàÏÜê
            reward = 10;
            message = 'Ìô©Î¨¥ÏßÄ... Í±∞Ïùò ÏïÑÎ¨¥Í≤ÉÎèÑ ÏóÜÎã§.';
            type = 'info';
        } else {
            // ÏúÑÌóò
            reward = -20;
            message = '‚ö†Ô∏è ÏúÑÌóò! ÎèÖÏÑ± Î¨ºÏßàÏóê ÎÖ∏Ï∂úÎêòÏóàÎã§.';
            type = 'error';
        }
        
        GameState.addEntropy(reward);
        Toast.show(`${message} (${reward >= 0 ? '+' : ''}${reward}‚ö°)`, type);
        GameState.save();
        navigate('dashboard');
    };
    
    // ÌéòÏù¥ÏßÄ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò
    const navigate = (page) => {
        cleanup();
        currentPage = page;
        
        switch (page) {
            case 'title':
                renderTitle();
                break;
            case 'saveSelect':
                renderSaveSelect();
                break;
            case 'birth':
                renderBirth();
                break;
            case 'dashboard':
                renderDashboard();
                break;
            default:
                renderTitle();
        }
    };
    
    return { navigate, getCurrentPage: () => currentPage };
})();


/* ========================================
   Initialization
======================================== */
document.addEventListener('DOMContentLoaded', () => {
    // Î≥Ñ Î∞∞Í≤Ω ÏÉùÏÑ±
    StarsBackground.create();
    
    // Ïò§ÎîîÏò§ ÏÑ§Ï†ï Î°úÎìú
    AudioSystem.loadSettings();
    
    // ÌÉÄÏù¥ÌãÄ ÌéòÏù¥ÏßÄÎ°ú ÏãúÏûë
    Pages.navigate('title');
    
    // ÏûêÎèô Ï†ÄÏû• (30Ï¥àÎßàÎã§)
    setInterval(() => {
        GameState.autoSave();
    }, 30000);
    
    // Ï∞Ω Îã´Í∏∞ Ï†Ñ Ï†ÄÏû•
    window.addEventListener('beforeunload', () => {
        GameState.save();
    });
    
    console.log('üé≤ BOKLUCK Universe v0.1.0 loaded!');
});
</script>
</body>
</html>
