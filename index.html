<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bokluck Protocol (Mainnet)</title>
    <style>
        /* ë¹„íŠ¸ì½”ì¸ ê±°ë˜ì†Œ ìŠ¤íƒ€ì¼ (ë‹¤í¬ & ê³¨ë“œ) */
        body { font-family: 'Pretendard', sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background: #0b0e11; color: #eaecef; }
        
        /* í—¤ë” */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #2d3136; padding-bottom: 15px; }
        .logo { font-size: 22px; font-weight: 800; color: #F7931A; letter-spacing: -0.5px; } /* ë¹„íŠ¸ì½”ì¸ ì»¬ëŸ¬ */
        .wallet-badge { background: #1e2329; padding: 8px 16px; border-radius: 4px; border: 1px solid #474d57; font-size: 14px; font-family: monospace; display: none; }
        .coin-text { color: #F7931A; font-weight: bold; }

        /* í˜„í™©íŒ (ëŒ€ì‹œë³´ë“œ) */
        .dashboard { background: #1e2329; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #2d3136; }
        .dash-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; color: #848e9c; }
        .dash-val { color: #eaecef; font-weight: bold; font-family: monospace; font-size: 16px; }
        .progress-bg { background: #2d3136; height: 10px; border-radius: 5px; overflow: hidden; margin-top: 5px; }
        .progress-bar { background: #F7931A; height: 100%; width: 0%; transition: width 0.5s; }
        .halving-info { text-align: center; margin-top: 15px; padding-top: 15px; border-top: 1px dashed #2d3136; font-size: 13px; color: #F7931A; }

        /* ë¡œê·¸ì¸ ë²„íŠ¼ */
        #loginBtn { background: #F7931A; color: white; border: none; padding: 12px; width: 100%; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 16px; margin-bottom: 20px; }
        #loginBtn:hover { background: #e08312; }

        /* ì±„êµ´ê¸° (ê¸€ì“°ê¸°) */
        .mining-area { display: none; margin-bottom: 30px; }
        input, textarea { width: 100%; padding: 15px; margin-bottom: 10px; border: 1px solid #474d57; background: #0b0e11; color: white; border-radius: 4px; box-sizing: border-box; font-family: inherit; }
        input:focus, textarea:focus { outline: none; border-color: #F7931A; }
        
        button.mine-btn { width: 100%; padding: 15px; background: #20b26c; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 16px; transition: 0.2s; }
        button.mine-btn:hover { background: #0e9656; }
        button:disabled { background: #474d57; cursor: not-allowed; }

        /* ë¸”ë¡ ë¦¬ìŠ¤íŠ¸ */
        .block-list { border-top: 1px solid #2d3136; padding-top: 20px; }
        .block-item { background: #161a1e; padding: 15px; border-bottom: 1px solid #2d3136; }
        .block-header { display: flex; justify-content: space-between; font-size: 12px; color: #848e9c; margin-bottom: 5px; }
        .block-reward { color: #20b26c; font-weight: bold; font-family: monospace; }
        .block-title { font-size: 16px; font-weight: bold; margin-bottom: 5px; }
        
        .loading { text-align: center; color: #848e9c; padding: 20px; }
    </style>
</head>
<body>

    <header>
        <div class="logo">BOKLUCK NETWORK</div>
        <div id="wallet" class="wallet-badge">
            <span id="userCoin" class="coin-text">0</span> BOK
        </div>
    </header>

    <div class="dashboard">
        <div class="dash-row">
            <span>â›ï¸ í˜„ì¬ ë¸”ë¡ ë³´ìƒ (Current Reward)</span>
            <span class="dash-val"><span id="currentReward">100</span> BOK</span>
        </div>
        <div class="dash-row">
            <span>ğŸ“Š ì´ ì±„êµ´ëŸ‰ (Total Mined)</span>
            <span class="dash-val"><span id="totalMined">0</span> / 1,000,000</span>
        </div>
        <div class="progress-bg">
            <div id="miningProgress" class="progress-bar"></div>
        </div>
        <div class="halving-info">
            âš ï¸ ë‹¤ìŒ ë°˜ê°ê¸°ê¹Œì§€ <span id="blocksToHalving" style="font-weight:bold; color:white;">5</span>ê°œì˜ ë¸”ë¡(ê¸€) ë‚¨ìŒ
        </div>
    </div>

    <button id="loginBtn">ì§€ê°‘ ì—°ê²° (Google Login)</button>

    <div id="miningArea" class="mining-area">
        <input type="text" id="title" placeholder="ë¸”ë¡ ë°ì´í„° ì…ë ¥ (ì œëª©)">
        <textarea id="content" rows="3" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì—¬ í•´ì‹œë¥¼ ìƒì„±í•˜ì„¸ìš”."></textarea>
        <button id="mineBtn" class="mine-btn">ì±„êµ´ ì‹œì‘ (ê¸€ì“°ê¸°)</button>
    </div>

    <h4 style="color:#848e9c; margin-bottom:10px;">RECENT BLOCKS</h4>
    <div id="blockList" class="block-list">
        <div class="loading">ë„¤íŠ¸ì›Œí¬ ë™ê¸°í™” ì¤‘...</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, getDoc, setDoc, runTransaction, increment } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

        // ============================================================
        // ğŸš¨ ì—¬ê¸°ì— ë³¸ì¸ì˜ í‚¤ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”! (ì•ˆ í•˜ë©´ ì‘ë™ ì•ˆ í•¨)
        // ============================================================
        const firebaseConfig = {
          apiKey: "AIzaSyBwQjuqgWM4YKnqu_gzNbeCg5alrC-jVcQ",
          authDomain: "myco-737a0.firebaseapp.com",
          projectId: "myco-737a0",
          storageBucket: "myco-737a0.firebasestorage.app",
          messagingSenderId: "942571332540",
          appId: "1:942571332540:web:be0bb6fbdd32655501c1b9"
        };
        // ============================================================

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        // âš™ï¸ [ì„¤ì •] ë°˜ê°ê¸° ê·œì¹™ (í…ŒìŠ¤íŠ¸ìš©)
        // ì‹¤ì œ ìš´ì˜ì‹œëŠ” HALVING_INTERVALì„ 1000 ë“±ìœ¼ë¡œ ëŠ˜ë¦¬ì„¸ìš”.
        const HALVING_INTERVAL = 5; // ê¸€ 5ê°œë§ˆë‹¤ ë³´ìƒ ì ˆë°˜
        const INITIAL_REWARD = 100; // ì´ˆê¸° ë³´ìƒ
        const MAX_SUPPLY = 1000000; // ì´ ë°œí–‰ëŸ‰

        let currentUser = null;

        // UI ìš”ì†Œ
        const loginBtn = document.getElementById("loginBtn");
        const wallet = document.getElementById("wallet");
        const miningArea = document.getElementById("miningArea");
        const mineBtn = document.getElementById("mineBtn");

        // 1. ì‹œìŠ¤í…œ í†µê³„ ì´ˆê¸°í™” ë° ì‹¤ì‹œê°„ ê°ì‹œ
        const statsRef = doc(db, "system", "miningStats");
        
        onSnapshot(statsRef, (docSnap) => {
            let totalMined = 0;
            let currentBlockHeight = 0;

            if (docSnap.exists()) {
                const data = docSnap.data();
                totalMined = data.totalMined || 0;
                currentBlockHeight = data.totalBlocks || 0;
            }

            // ë°˜ê°ê¸° ê³„ì‚° ë¡œì§
            const halvingCount = Math.floor(currentBlockHeight / HALVING_INTERVAL);
            // ë³´ìƒ ê³„ì‚°: 100 -> 50 -> 25 ... (ìµœì†Œ 1)
            let currentReward = Math.floor(INITIAL_REWARD / Math.pow(2, halvingCount));
            if (currentReward < 1) currentReward = 1;

            // ë‹¤ìŒ ë°˜ê°ê¸°ê¹Œì§€ ë‚¨ì€ ë¸”ë¡
            const nextHalvingBlock = (halvingCount + 1) * HALVING_INTERVAL;
            const blocksLeft = nextHalvingBlock - currentBlockHeight;

            // UI ì—…ë°ì´íŠ¸
            document.getElementById("totalMined").innerText = totalMined.toLocaleString();
            document.getElementById("currentReward").innerText = currentReward;
            document.getElementById("blocksToHalving").innerText = blocksLeft;
            
            // ì§„í–‰ë¥  ë°”
            const percent = (totalMined / MAX_SUPPLY) * 100;
            document.getElementById("miningProgress").style.width = percent + "%";

            // ë²„íŠ¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            if(mineBtn.disabled === false) {
                 mineBtn.innerText = `ì±„êµ´ ì‹œì‘ (+${currentReward} BOK)`;
            }
        });

        // 2. ë¡œê·¸ì¸ ë¡œì§
        loginBtn.addEventListener("click", () => signInWithPopup(auth, provider));
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                loginBtn.style.display = "none";
                wallet.style.display = "block";
                miningArea.style.display = "block";

                // ì‚¬ìš©ì ì§€ê°‘ ê°ì‹œ
                onSnapshot(doc(db, "users", user.uid), (doc) => {
                    const coin = doc.exists() ? doc.data().coin : 0;
                    document.getElementById("userCoin").innerText = coin.toLocaleString();
                });
            }
        });

        // 3. ì±„êµ´ (íŠ¸ëœì­ì…˜ ì ìš© - ë™ì‹œì— ëˆŒëŸ¬ë„ ì˜¤ë¥˜ ì—†ê²Œ)
        mineBtn.addEventListener("click", async () => {
            if (!currentUser) return;
            const title = document.getElementById("title").value;
            const content = document.getElementById("content").value;
            if (!title || !content) return alert("ë°ì´í„°ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

            mineBtn.disabled = true;
            mineBtn.innerText = "â›ï¸ ì±„êµ´ ì—°ì‚° ì¤‘...";

            try {
                await runTransaction(db, async (transaction) => {
                    // (1) ì¤‘ì•™ í†µê³„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                    const statsDoc = await transaction.get(statsRef);
                    let currentStats = { totalBlocks: 0, totalMined: 0 };
                    
                    if (statsDoc.exists()) {
                        currentStats = statsDoc.data();
                    }

                    // (2) í˜„ì¬ ì‹œì ì˜ ë³´ìƒ ê³„ì‚°
                    const halvingCount = Math.floor(currentStats.totalBlocks / HALVING_INTERVAL);
                    let reward = Math.floor(INITIAL_REWARD / Math.pow(2, halvingCount));
                    if (reward < 1) reward = 1;

                    // (3) ì´ëŸ‰ ì œí•œ ì²´í¬
                    if (currentStats.totalMined + reward > MAX_SUPPLY) {
                        throw "ì±„êµ´ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! (ì´ ë°œí–‰ëŸ‰ ë„ë‹¬)";
                    }

                    // (4) ê¸€ ì €ì¥ (Posts ì»¬ë ‰ì…˜)
                    const newPostRef = doc(collection(db, "posts"));
                    transaction.set(newPostRef, {
                        title: title,
                        content: content,
                        author: currentUser.displayName,
                        reward: reward,
                        date: new Date().toISOString()
                    });

                    // (5) ì‚¬ìš©ì ì§€ê°‘ ì—…ë°ì´íŠ¸
                    const userRef = doc(db, "users", currentUser.uid);
                    transaction.set(userRef, { 
                        coin: increment(reward),
                        email: currentUser.email,
                        name: currentUser.displayName
                    }, { merge: true });

                    // (6) ì¤‘ì•™ í†µê³„ ì—…ë°ì´íŠ¸
                    transaction.set(statsRef, {
                        totalBlocks: increment(1),
                        totalMined: increment(reward)
                    }, { merge: true });
                });

                alert("ë¸”ë¡ ìƒì„± ì„±ê³µ! ë³´ìƒì´ ì§€ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤.");
                document.getElementById("title").value = "";
                document.getElementById("content").value = "";

            } catch (e) {
                console.error(e);
                alert("ì±„êµ´ ì‹¤íŒ¨: " + e);
            } finally {
                mineBtn.disabled = false;
            }
        });

        // 4. ë¸”ë¡ ë¦¬ìŠ¤íŠ¸
        const q = query(collection(db, "posts"), orderBy("date", "desc"));
        onSnapshot(q, (snapshot) => {
            const list = document.getElementById("blockList");
            list.innerHTML = "";
            snapshot.forEach((doc) => {
                const data = doc.data();
                const hash = doc.id.substring(0, 8).toUpperCase();
                const reward = data.reward ? `+${data.reward} BOK` : "Genesis";
                
                list.innerHTML += `
                    <div class="block-item">
                        <div class="block-header">
                            <span>ğŸ“¦ BLOCK #${hash}</span>
                            <span>${new Date(data.date).toLocaleTimeString()}</span>
                        </div>
                        <div class="block-title">${data.title}</div>
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span style="font-size:12px; color:#848e9c;">Miner: ${data.author}</span>
                            <span class="block-reward">${reward}</span>
                        </div>
                    </div>
                `;
            });
        });
    </script>
</body>
</html>
