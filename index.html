<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOKLUCK Universe</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸŒŒ</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
        --primary: #00f5d4; --secondary: #7b2cbf; --accent: #f72585; --energy: #fee440;
        --success: #10b981; --danger: #ff4d6d; --warning: #f59e0b;
        --bg-space: #0a0a1a; --bg-card: rgba(20, 20, 40, 0.9); --bg-card-solid: #14142a;
        --bg-hover: rgba(30, 30, 60, 0.9); --bg-input: rgba(10, 10, 30, 0.8);
        --border: rgba(0, 245, 212, 0.2); --text: #e0e0ff; --text-muted: #8080a0;
        --gradient-cosmic: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f72585 100%);
        --gradient-energy: linear-gradient(135deg, #00f5d4 0%, #fee440 100%);
        --gradient-evolution: linear-gradient(135deg, #7b2cbf 0%, #f72585 100%);
    }
    body { background: var(--bg-space); color: var(--text); font-family: 'Noto Sans KR', sans-serif; min-height: 100vh; }
    .font-display { font-family: 'Orbitron', sans-serif; }
    #stars { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: -1; }
    .star { position: absolute; background: white; border-radius: 50%; animation: twinkle 3s infinite; }
    @keyframes twinkle { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }
    
    .loading-screen { position: fixed; inset: 0; background: var(--bg-space); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 3000; }
    .loading-screen.hidden { display: none; }
    .loading-spinner { width: 60px; height: 60px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .navbar { position: fixed; top: 0; left: 0; right: 0; height: 60px; background: rgba(10,10,26,0.95); backdrop-filter: blur(20px); border-bottom: 1px solid var(--border); z-index: 1000; display: flex; align-items: center; padding: 0 24px; }
    .nav-logo { font-family: 'Orbitron', sans-serif; font-size: 22px; font-weight: 900; background: var(--gradient-energy); -webkit-background-clip: text; -webkit-text-fill-color: transparent; cursor: pointer; margin-right: 40px; }
    .nav-links { display: flex; gap: 8px; flex: 1; }
    .nav-link { padding: 10px 18px; border-radius: 10px; color: var(--text-muted); font-size: 14px; cursor: pointer; transition: 0.2s; }
    .nav-link:hover { color: var(--text); background: var(--bg-hover); }
    .nav-link.active { color: var(--primary); background: rgba(0,245,212,0.1); }
    .nav-link.locked { opacity: 0.4; cursor: not-allowed; }
    .nav-right { display: flex; align-items: center; gap: 16px; }
    .entropy-badge { display: flex; align-items: center; gap: 10px; background: var(--bg-card); border: 1px solid var(--border); padding: 8px 16px; border-radius: 25px; }
    .entropy-value { font-family: 'Orbitron', sans-serif; font-size: 16px; font-weight: 700; color: var(--energy); }
    .user-menu { position: relative; }
    .user-avatar { width: 36px; height: 36px; border-radius: 50%; border: 2px solid var(--primary); cursor: pointer; }
    .user-dropdown { position: absolute; top: 100%; right: 0; margin-top: 8px; background: var(--bg-card-solid); border: 1px solid var(--border); border-radius: 12px; padding: 8px; min-width: 160px; display: none; }
    .user-dropdown.show { display: block; }
    .dropdown-item { padding: 10px 16px; border-radius: 8px; cursor: pointer; font-size: 14px; }
    .dropdown-item:hover { background: var(--bg-hover); }
    .dropdown-item.danger { color: var(--danger); }
    
    .main-content { padding-top: 60px; min-height: 100vh; }
    .page-container { max-width: 1400px; margin: 0 auto; padding: 24px; }
    
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 24px; border: none; border-radius: 12px; font-size: 14px; font-weight: 600; cursor: pointer; transition: 0.2s; font-family: inherit; }
    .btn:hover { transform: translateY(-2px); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .btn-primary { background: var(--gradient-cosmic); color: white; }
    .btn-energy { background: var(--gradient-energy); color: #1a1a2e; }
    .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
    .btn-outline:hover { border-color: var(--primary); color: var(--primary); }
    .btn-danger { background: var(--danger); color: white; }
    .btn-success { background: var(--success); color: white; }
    .btn-google { background: white; color: #333; padding: 14px 32px; font-size: 15px; }
    .btn-lg { padding: 16px 40px; font-size: 16px; }
    .btn-sm { padding: 8px 16px; font-size: 13px; }
    .btn-block { width: 100%; }
    
    .input { width: 100%; padding: 12px 16px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 12px; color: var(--text); font-size: 14px; outline: none; }
    .input:focus { border-color: var(--primary); }
    
    .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 20px; padding: 24px; }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid var(--border); }
    .card-title { font-family: 'Orbitron', sans-serif; font-size: 16px; font-weight: 700; }
    
    .progress-bar { height: 8px; background: rgba(123,44,191,0.2); border-radius: 4px; overflow: hidden; }
    .progress-fill { height: 100%; background: var(--gradient-evolution); border-radius: 4px; transition: width 0.3s; }
    
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 2000; }
    .modal-overlay.active { display: flex; }
    .modal { background: var(--bg-card-solid); border: 1px solid var(--border); border-radius: 24px; padding: 32px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; }
    .modal-title { font-family: 'Orbitron', sans-serif; font-size: 20px; font-weight: 700; margin-bottom: 8px; text-align: center; }
    .modal-desc { color: var(--text-muted); font-size: 14px; margin-bottom: 24px; text-align: center; line-height: 1.6; }
    .modal-actions { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }
    
    .toast-container { position: fixed; top: 80px; right: 24px; z-index: 2000; display: flex; flex-direction: column; gap: 12px; }
    .toast { background: var(--bg-card-solid); border: 1px solid var(--border); border-radius: 12px; padding: 16px 20px; display: flex; align-items: center; gap: 12px; min-width: 300px; animation: slideIn 0.3s ease; }
    .toast.success { border-color: var(--success); }
    .toast.error { border-color: var(--danger); }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    
    .login-page { min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px 20px; text-align: center; }
    .login-logo { font-family: 'Orbitron', sans-serif; font-size: 56px; font-weight: 900; background: var(--gradient-energy); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 8px; }
    .login-subtitle { font-size: 18px; color: var(--text-muted); margin-bottom: 40px; }
    .login-story { max-width: 400px; font-size: 15px; color: var(--text-muted); line-height: 1.8; margin-bottom: 40px; }
    .login-story strong { color: var(--primary); }
    
    .dashboard-grid { display: grid; grid-template-columns: 350px 1fr; gap: 24px; }
    @media (max-width: 1024px) { .dashboard-grid { grid-template-columns: 1fr; } }
    
    .entity-card { position: relative; overflow: hidden; }
    .entity-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: var(--gradient-evolution); }
    .entity-visual { width: 200px; height: 200px; margin: 0 auto 16px; cursor: pointer; }
    .entity-name { font-family: 'Orbitron', sans-serif; font-size: 18px; font-weight: 700; text-align: center; margin-bottom: 8px; }
    .entity-stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
    .stat-box { background: rgba(0,245,212,0.05); border: 1px solid rgba(0,245,212,0.1); border-radius: 12px; padding: 12px; text-align: center; }
    .stat-value { font-family: 'Orbitron', sans-serif; font-size: 20px; font-weight: 700; color: var(--primary); }
    .stat-label { font-size: 11px; color: var(--text-muted); margin-top: 4px; }
    
    .quick-actions { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 24px; }
    @media (max-width: 768px) { .quick-actions { grid-template-columns: repeat(2, 1fr); } }
    .quick-action { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 20px; text-align: center; cursor: pointer; transition: 0.2s; }
    .quick-action:hover { border-color: var(--primary); transform: translateY(-4px); }
    .quick-action.locked { opacity: 0.4; cursor: not-allowed; }
    .quick-action.locked:hover { transform: none; border-color: var(--border); }
    .quick-action-icon { font-size: 28px; margin-bottom: 8px; }
    .quick-action-label { font-size: 12px; color: var(--text-muted); }
    
    .history-entry { background: var(--bg-input); border-radius: 12px; padding: 16px; margin-bottom: 12px; border-left: 3px solid var(--secondary); }
    .history-chapter { font-family: 'Orbitron', sans-serif; font-size: 11px; color: var(--accent); margin-bottom: 6px; }
    .history-title { font-weight: 700; margin-bottom: 8px; }
    .history-content { font-size: 13px; color: var(--text-muted); line-height: 1.6; }
    
    .parts-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-bottom: 24px; }
    .part-item { background: var(--bg-input); border: 2px solid var(--border); border-radius: 12px; padding: 16px; text-align: center; cursor: pointer; transition: 0.2s; }
    .part-item:hover { border-color: var(--primary); }
    .part-item.selected { border-color: var(--primary); background: rgba(0,245,212,0.1); }
    .part-item.locked { opacity: 0.5; cursor: not-allowed; }
    .part-icon { font-size: 32px; margin-bottom: 8px; }
    .part-name { font-size: 12px; font-weight: 600; }
    .part-style { font-size: 10px; color: var(--text-muted); margin-top: 4px; }
    
    .style-options { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 16px; }
    .style-option { padding: 12px; background: var(--bg-input); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; text-align: center; font-size: 12px; }
    .style-option:hover { border-color: var(--primary); }
    .style-option.selected { border-color: var(--primary); background: rgba(0,245,212,0.1); }
    
    .cost-badge { display: inline-flex; align-items: center; gap: 4px; background: rgba(254,228,64,0.2); color: var(--energy); padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; }
    
    .planet-map { display: grid; grid-template-columns: repeat(10, 1fr); gap: 4px; background: var(--bg-input); padding: 16px; border-radius: 16px; margin-bottom: 16px; }
    .map-cell { aspect-ratio: 1; background: rgba(0,245,212,0.05); border: 1px solid var(--border); border-radius: 4px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; font-size: 12px; }
    .map-cell:hover { border-color: var(--primary); background: rgba(0,245,212,0.1); }
    .map-cell.explored { background: rgba(0,245,212,0.2); border-color: var(--primary); }
    .map-cell.owned-other { background: rgba(247,37,133,0.2); border-color: var(--accent); }
    .map-cell.home { background: rgba(254,228,64,0.3); border-color: var(--energy); }
    
    .tech-tree { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
    @media (max-width: 768px) { .tech-tree { grid-template-columns: 1fr; } }
    .tech-item { background: var(--bg-input); border: 2px solid var(--border); border-radius: 16px; padding: 20px; text-align: center; transition: 0.2s; }
    .tech-item.unlocked { border-color: var(--success); background: rgba(16,185,129,0.1); }
    .tech-item.available { border-color: var(--primary); cursor: pointer; }
    .tech-item.available:hover { transform: translateY(-4px); }
    .tech-item.locked { opacity: 0.5; }
    .tech-icon { font-size: 40px; margin-bottom: 12px; }
    .tech-name { font-weight: 700; margin-bottom: 4px; }
    .tech-desc { font-size: 12px; color: var(--text-muted); margin-bottom: 12px; }
    .tech-cost { font-size: 13px; color: var(--energy); }
    
    .tax-info { background: rgba(247,37,133,0.1); border: 1px solid var(--accent); border-radius: 12px; padding: 16px; margin-top: 16px; }
    .tax-info-title { font-size: 14px; font-weight: 600; color: var(--accent); margin-bottom: 8px; }
    .tax-info-desc { font-size: 12px; color: var(--text-muted); }
    
    #worldCanvas { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 500; display: none; }
    #worldCanvas.active { display: block; }
    
    .world-ui { position: fixed; top: 0; left: 0; right: 0; padding: 20px; display: none; justify-content: space-between; align-items: flex-start; z-index: 600; pointer-events: none; }
    .world-ui.active { display: flex; }
    .world-ui > * { pointer-events: auto; }
    .world-left { display: flex; flex-direction: column; gap: 12px; }
    .world-entropy-box { background: rgba(10,10,26,0.9); border: 1px solid var(--border); border-radius: 16px; padding: 16px 24px; backdrop-filter: blur(10px); }
    .world-entropy-label { font-family: 'Orbitron', sans-serif; font-size: 11px; color: var(--text-muted); }
    .world-entropy-value { font-family: 'Orbitron', sans-serif; font-size: 32px; font-weight: 900; background: var(--gradient-energy); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .world-nav-buttons { display: flex; gap: 8px; flex-wrap: wrap; }
    .world-nav-btn { background: rgba(10,10,26,0.9); border: 1px solid var(--border); border-radius: 12px; padding: 10px 16px; color: var(--text); font-size: 13px; cursor: pointer; backdrop-filter: blur(10px); transition: 0.2s; }
    .world-nav-btn:hover { border-color: var(--primary); color: var(--primary); }
    .world-nav-btn.next-stage { background: var(--gradient-energy); color: #1a1a2e; border: none; font-weight: 700; }
    .world-nav-btn.next-stage:disabled { opacity: 0.5; cursor: not-allowed; }
    .world-info-panel { background: rgba(10,10,26,0.9); border: 1px solid var(--border); border-radius: 16px; padding: 16px 20px; backdrop-filter: blur(10px); min-width: 200px; }
    .world-info-title { font-family: 'Orbitron', sans-serif; font-size: 12px; color: var(--secondary); margin-bottom: 12px; }
    .world-controls { position: fixed; bottom: 20px; right: 20px; background: rgba(10,10,26,0.9); border: 1px solid var(--border); border-radius: 12px; padding: 12px 16px; font-size: 11px; color: var(--text-muted); z-index: 600; display: none; }
    .world-controls.active { display: block; }
    .world-controls .key { display: inline-block; padding: 2px 8px; background: var(--bg-input); border-radius: 4px; margin-right: 4px; }
    
    .encounter-dialog { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: rgba(10,10,26,0.95); border: 2px solid var(--secondary); border-radius: 20px; padding: 24px 32px; text-align: center; z-index: 700; min-width: 400px; display: none; }
    .encounter-dialog.active { display: block; }
    .encounter-title { font-family: 'Orbitron', sans-serif; font-size: 16px; margin-bottom: 8px; }
    .encounter-desc { font-size: 14px; color: var(--text-muted); margin-bottom: 16px; }
    .encounter-choices { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .encounter-choice { padding: 12px 16px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 10px; cursor: pointer; transition: 0.2s; font-size: 13px; }
    .encounter-choice:hover { border-color: var(--primary); background: rgba(0,245,212,0.1); }
    .choice-title { font-weight: 700; margin-bottom: 4px; }
    .choice-effect { font-size: 11px; color: var(--text-muted); }
    
    .story-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 800; }
    .story-overlay.active { display: flex; }
    .story-content { max-width: 600px; text-align: center; padding: 40px; }
    .story-icon { font-size: 80px; margin-bottom: 24px; }
    .story-title { font-family: 'Orbitron', sans-serif; font-size: 32px; font-weight: 900; margin-bottom: 16px; background: var(--gradient-energy); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .story-text { font-size: 16px; line-height: 1.8; color: var(--text-muted); margin-bottom: 32px; }
    .story-text strong { color: var(--primary); }
    
    .evo-alert { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); background: rgba(10,10,26,0.95); border: 2px solid var(--secondary); border-radius: 24px; padding: 40px 60px; text-align: center; z-index: 700; opacity: 0; transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); }
    .evo-alert.show { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    .evo-alert-icon { font-size: 64px; margin-bottom: 16px; }
    .evo-alert-title { font-family: 'Orbitron', sans-serif; font-size: 24px; font-weight: 900; background: var(--gradient-energy); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 8px; }
    .evo-alert-desc { font-size: 14px; color: var(--text-muted); margin-bottom: 12px; }
    .evo-alert-effect { padding: 10px 20px; background: rgba(0,245,212,0.1); border-radius: 20px; font-size: 13px; color: var(--primary); }
    
    .hidden { display: none !important; }
    .text-center { text-align: center; }
    .text-muted { color: var(--text-muted); }
    .mb-8 { margin-bottom: 8px; }
    .mb-16 { margin-bottom: 16px; }
    .mb-24 { margin-bottom: 24px; }
    .mt-16 { margin-top: 16px; }
    .mt-24 { margin-top: 24px; }
    </style>
</head>
<body>
    <div id="stars"></div>
    <div class="loading-screen" id="loadingScreen"><div class="loading-spinner"></div></div>
    <div id="app"></div>
    <canvas id="worldCanvas"></canvas>
    
    <div class="world-ui" id="worldUI">
        <div class="world-left">
            <div class="world-entropy-box">
                <div class="world-entropy-label" id="worldStatLabel">ENTROPY</div>
                <div class="world-entropy-value" id="worldStatValue">0</div>
            </div>
            <div class="world-nav-buttons" id="worldNavButtons"></div>
        </div>
        <div class="world-info-panel" id="worldInfoPanel"></div>
    </div>
    <div class="world-controls" id="worldControls"></div>
    
    <div class="encounter-dialog" id="encounterDialog">
        <div class="encounter-title" id="encounterTitle">ì¡°ìš°</div>
        <div class="encounter-desc" id="encounterDesc">ì„¤ëª…</div>
        <div class="encounter-choices" id="encounterChoices"></div>
    </div>
    
    <div class="story-overlay" id="storyOverlay">
        <div class="story-content">
            <div class="story-icon" id="storyIcon">ğŸŒŒ</div>
            <div class="story-title" id="storyTitle">ì œëª©</div>
            <div class="story-text" id="storyText">ë‚´ìš©</div>
            <button class="btn btn-energy btn-lg" onclick="window.closeStory()">ê³„ì†</button>
        </div>
    </div>
    
    <div class="modal-overlay" id="editCellModal">
        <div class="modal" style="max-width:700px">
            <h2 class="modal-title">ğŸ§¬ ì„¸í¬ ì»¤ìŠ¤í„°ë§ˆì´ì§•</h2>
            <p class="modal-desc">íŒŒì¸  ë³€ê²½: <span class="cost-badge">âš¡ 1000</span> / íŒŒì¸ ë‹¹</p>
            <div style="display:flex;justify-content:center;margin-bottom:24px"><canvas id="cellPreview" width="180" height="180"></canvas></div>
            <div style="margin-bottom:16px">
                <label style="font-size:13px;color:var(--text-muted);display:block;margin-bottom:8px">ì„¸í¬ ì´ë¦„ (ë¬´ë£Œ)</label>
                <input type="text" class="input" id="cellNameInput" placeholder="ì´ë¦„ ì…ë ¥" maxlength="20">
            </div>
            <div class="parts-grid" id="partsGrid"></div>
            <div id="styleSelector" style="display:none">
                <h3 style="font-size:14px;margin-bottom:12px" id="styleTitle">ìŠ¤íƒ€ì¼ ì„ íƒ</h3>
                <div class="style-options" id="styleOptions"></div>
            </div>
            <div class="modal-actions mt-24">
                <button class="btn btn-outline" onclick="window.closeEditModal()">ì·¨ì†Œ</button>
                <button class="btn btn-outline" onclick="window.randomizeCellDesign()">ğŸ² ëœë¤ (ë¬´ë£Œ)</button>
                <button class="btn btn-primary" onclick="window.saveCellDesign()">ì €ì¥</button>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="exploreModal">
        <div class="modal">
            <h2 class="modal-title" id="exploreTitle">ğŸ” íƒí—˜ ê²°ê³¼</h2>
            <p class="modal-desc" id="exploreDesc">ë‚´ìš©</p>
            <div class="modal-actions"><button class="btn btn-primary" onclick="window.closeExploreModal()">í™•ì¸</button></div>
        </div>
    </div>
    
    <div class="modal-overlay" id="inviteModal">
        <div class="modal">
            <h2 class="modal-title">ğŸ“¡ ì´ˆëŒ€ì¥ ë°œì†¡</h2>
            <p class="modal-desc">ë‹¤ë¥¸ íƒí—˜ê°€ë¥¼ ë‹¹ì‹ ì˜ í–‰ì„±ìœ¼ë¡œ ì´ˆëŒ€í•©ë‹ˆë‹¤</p>
            <div style="margin-bottom:16px">
                <label style="font-size:13px;color:var(--text-muted);display:block;margin-bottom:8px">ì´ˆëŒ€í•  ì‚¬ìš©ì ì´ë©”ì¼</label>
                <input type="email" class="input" id="inviteEmailInput" placeholder="example@email.com">
            </div>
            <div class="modal-actions">
                <button class="btn btn-outline" onclick="window.closeInviteModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="window.sendInvite()">ğŸ“¡ ë°œì†¡</button>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="resultModal">
        <div class="modal">
            <div style="text-align:center;margin-bottom:24px"><span style="font-size:80px" id="resultIcon">ğŸª</span></div>
            <h2 class="modal-title" id="resultTitle">ê²°ê³¼</h2>
            <p class="modal-desc" id="resultDesc">ì„¤ëª…</p>
            <div class="modal-actions" id="resultActions"></div>
        </div>
    </div>
    
    <div class="toast-container" id="toastContainer"></div>
    <div class="evo-alert" id="evoAlert">
        <div class="evo-alert-icon" id="evoAlertIcon">ğŸ‘ï¸</div>
        <div class="evo-alert-title" id="evoAlertTitle">ì§„í™”!</div>
        <div class="evo-alert-desc" id="evoAlertDesc">ì„¤ëª…</div>
        <div class="evo-alert-effect" id="evoAlertEffect">íš¨ê³¼</div>
    </div>

    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, addDoc, query, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    
    const firebaseConfig = { apiKey: "AIzaSyBwQjuqgWM4YKnqu_gzNbeCg5alrC-jVcQ", authDomain: "myco-737a0.firebaseapp.com", projectId: "myco-737a0", storageBucket: "myco-737a0.firebasestorage.app", messagingSenderId: "942571332540", appId: "1:942571332540:web:be0bb6fbdd32655501c1b9" };
    const fbApp = initializeApp(firebaseConfig);
    const db = getFirestore(fbApp);
    const auth = getAuth(fbApp);
    const googleProvider = new GoogleAuthProvider();
    
    const PART_STYLES = {
        eye: [{ id: 'normal', name: 'ê¸°ë³¸', icon: 'ğŸ‘ï¸' }, { id: 'big', name: 'í° ëˆˆ', icon: 'ğŸ‘€' }, { id: 'multiple', name: 'ë³µì•ˆ', icon: 'ğŸ•·ï¸' }, { id: 'glow', name: 'ë°œê´‘', icon: 'âœ¨' }],
        arm: [{ id: 'tentacle', name: 'ì´‰ìˆ˜', icon: 'ğŸ¦‘' }, { id: 'claw', name: 'ì§‘ê²Œ', icon: 'ğŸ¦€' }, { id: 'long', name: 'ê¸´ íŒ”', icon: 'ğŸ¦' }, { id: 'multiple', name: 'ë‹¤ì¤‘', icon: 'ğŸ™' }],
        leg: [{ id: 'normal', name: 'ê¸°ë³¸', icon: 'ğŸ¦µ' }, { id: 'tentacle', name: 'ì´‰ìˆ˜', icon: 'ğŸ¦‘' }, { id: 'multiple', name: 'ë‹¤ì¤‘', icon: 'ğŸ•·ï¸' }, { id: 'fin', name: 'ì§€ëŠëŸ¬ë¯¸', icon: 'ğŸ ' }],
        brain: [{ id: 'normal', name: 'ê¸°ë³¸', icon: 'ğŸ§ ' }, { id: 'large', name: 'ëŒ€í˜•', icon: 'ğŸ”®' }, { id: 'antenna', name: 'ì•ˆí…Œë‚˜', icon: 'ğŸ“¡' }, { id: 'halo', name: 'í—¤ì¼ë¡œ', icon: 'ğŸ‘¼' }],
        wing: [{ id: 'normal', name: 'ê¸°ë³¸', icon: 'ğŸª½' }, { id: 'butterfly', name: 'ë‚˜ë¹„', icon: 'ğŸ¦‹' }, { id: 'bat', name: 'ë°•ì¥', icon: 'ğŸ¦‡' }, { id: 'energy', name: 'ì—ë„ˆì§€', icon: 'âš¡' }]
    };
    
    const TECH_TREE = [
        { id: 'fire', name: 'ë¶ˆ', icon: 'ğŸ”¥', cost: 500, requires: [], desc: 'ë¬¸ëª…ì˜ ì‹œì‘' },
        { id: 'tools', name: 'ë„êµ¬', icon: 'ğŸ”§', cost: 800, requires: ['fire'], desc: 'ë„êµ¬ ì œì‘' },
        { id: 'wheel', name: 'ë°”í€´', icon: 'âš™ï¸', cost: 1000, requires: ['tools'], desc: 'ì´ë™ ê¸°ìˆ ' },
        { id: 'writing', name: 'ë¬¸ì', icon: 'ğŸ“œ', cost: 1200, requires: ['tools'], desc: 'ì§€ì‹ ê¸°ë¡' },
        { id: 'radio', name: 'ë¬´ì„  í†µì‹ ', icon: 'ğŸ“¡', cost: 2000, requires: ['writing'], desc: 'ì´ˆëŒ€ ì‹ í˜¸ ë°œì†¡' },
        { id: 'rocket', name: 'ë¡œì¼“', icon: 'ğŸš€', cost: 3000, requires: ['wheel'], desc: 'ë‹¤ë¥¸ í–‰ì„± ì´ë™' },
        { id: 'warp', name: 'ì›Œí”„', icon: 'ğŸŒ€', cost: 5000, requires: ['rocket'], desc: 'ì€í•˜ ê°„ ì´ë™' },
        { id: 'dyson', name: 'ë‹¤ì´ìŠ¨ ìŠ¤í”¼ì–´', icon: 'â˜€ï¸', cost: 10000, requires: ['warp'], desc: 'ë¬´í•œ ì—ë„ˆì§€' },
        { id: 'singularity', name: 'íŠ¹ì´ì ', icon: 'ğŸ•³ï¸', cost: 50000, requires: ['dyson'], desc: 'ìš°ì£¼ì˜ ì§€ë°°ì' }
    ];
    
    const EXPLORE_EVENTS = [
        { type: 'resource', title: 'ìì› ë°œê²¬!', desc: 'í’ë¶€í•œ ê´‘ë¬¼ì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤.', entropy: 100, icon: 'ğŸ’' },
        { type: 'resource', title: 'ì—ë„ˆì§€ì›!', desc: 'ì—ë„ˆì§€ ê²°ì •ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤.', entropy: 150, icon: 'âš¡' },
        { type: 'creature', title: 'ìƒëª…ì²´ ë°œê²¬!', desc: 'ì‘ì€ ìƒëª…ì²´ê°€ ì‚´ê³  ìˆìŠµë‹ˆë‹¤.', entropy: 50, icon: 'ğŸ¦ ' },
        { type: 'creature', title: 'ì§€ì  ìƒëª…ì²´!', desc: 'ì›ì‹œ ë¬¸ëª…ì˜ í”ì ì…ë‹ˆë‹¤.', entropy: 200, icon: 'ğŸ—¿' },
        { type: 'danger', title: 'ìœ„í—˜ ì§€ì—­!', desc: 'ë…ì„± ê°€ìŠ¤! ì—ë„ˆì§€ ì†ì‹¤.', entropy: -50, icon: 'â˜ ï¸' },
        { type: 'danger', title: 'ì§€ì§„!', desc: 'ì§€ê°ì´ ë¶ˆì•ˆì •í•©ë‹ˆë‹¤.', entropy: -30, icon: 'ğŸŒ‹' },
        { type: 'artifact', title: 'ê³ ëŒ€ ìœ ë¬¼!', desc: 'ë¯¸ì§€ ë¬¸ëª…ì˜ ìœ ë¬¼ì…ë‹ˆë‹¤.', entropy: 300, icon: 'ğŸº' },
        { type: 'artifact', title: 'ê¸°ìˆ  ì”í•´!', desc: 'ê³ ëŒ€ ê¸°ê³„ì—ì„œ ê¸°ìˆ  ìŠµë“.', entropy: 250, icon: 'âš™ï¸' },
        { type: 'empty', title: 'í™©ë¬´ì§€', desc: 'íŠ¹ë³„í•œ ê²ƒ ì—†ìŒ.', entropy: 10, icon: 'ğŸœï¸' },
        { type: 'portal', title: 'ì°¨ì›ë¬¸!', desc: 'ì—ë„ˆì§€ê°€ í˜ëŸ¬ë‚˜ì˜µë‹ˆë‹¤!', entropy: 500, icon: 'ğŸŒ€' }
    ];
    
    const PLANET_NAMES = ['Kepler-22b', 'Proxima-B', 'Trappist-1e', 'Gliese-581g', 'HD-40307g', 'Tau-Ceti-e'];
    const PLANET_TYPES = ['ìƒëª…ì²´ ì„œì‹ ê°€ëŠ¥', 'ì–¼ìŒ í–‰ì„±', 'ì‚¬ë§‰ í–‰ì„±', 'í•´ì–‘ í–‰ì„±', 'í™”ì‚° í–‰ì„±', 'ê³ ëŒ€ ë¬¸ëª… í”ì '];
    
    function randomPartStyle(part) { const s = PART_STYLES[part]; return s[Math.floor(Math.random() * s.length)].id; }
    
    function generateCellDesign() {
        const h1 = Math.floor(Math.random() * 360), h2 = (h1 + 60 + Math.floor(Math.random() * 120)) % 360;
        const patterns = ['none', 'spots', 'stripes', 'glow'];
        const adj = ['ë¹›ë‚˜ëŠ”', 'ì–´ë‘ ì˜', 'ê³ ëŒ€ì˜', 'ì‹ ë¹„ë¡œìš´', 'ì˜ì›í•œ', 'ê¹¨ì–´ë‚œ', 'ë– ë„ëŠ”'];
        const noun = ['ì˜ì‹', 'ì„¸í¬', 'ì¡´ì¬', 'ì˜í˜¼', 'íŒŒë™', 'ìƒëª…ì²´', 'íƒí—˜ê°€'];
        return {
            name: adj[Math.floor(Math.random() * adj.length)] + ' ' + noun[Math.floor(Math.random() * noun.length)],
            primaryColor: `hsl(${h1}, 80%, 60%)`, secondaryColor: `hsl(${h2}, 70%, 40%)`,
            pattern: patterns[Math.floor(Math.random() * patterns.length)],
            wobblePoints: 8 + Math.floor(Math.random() * 6), wobbleIntensity: 0.5 + Math.random() * 0.5, glowIntensity: 0.3 + Math.random() * 0.5,
            parts: { eye: randomPartStyle('eye'), arm: randomPartStyle('arm'), leg: randomPartStyle('leg'), brain: randomPartStyle('brain'), wing: randomPartStyle('wing') }
        };
    }
    
    function hslToHex(hsl) {
        const m = hsl.match(/hsl\((\d+),\s*(\d+)%,\s*(\d+)%\)/);
        if (!m) return hsl;
        let h = parseInt(m[1]) / 360, s = parseInt(m[2]) / 100, l = parseInt(m[3]) / 100;
        let r, g, b;
        if (s === 0) { r = g = b = l; }
        else {
            const hue2rgb = (p, q, t) => { if (t < 0) t += 1; if (t > 1) t -= 1; if (t < 1/6) return p + (q - p) * 6 * t; if (t < 1/2) return q; if (t < 2/3) return p + (q - p) * (2/3 - t) * 6; return p; };
            const q = l < 0.5 ? l * (1 + s) : l + s - l * s, p = 2 * l - q;
            r = hue2rgb(p, q, h + 1/3); g = hue2rgb(p, q, h); b = hue2rgb(p, q, h - 1/3);
        }
        const toHex = x => { const hex = Math.round(x * 255).toString(16); return hex.length === 1 ? '0' + hex : hex; };
        return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
    }
    
    const State = {
        user: null, userData: null, currentPage: 'login',
        game: {
            entropy: 0, stage: 1,
            evolution: { eye: false, arm: false, leg: false, brain: false, wing: false },
            currentPlanet: null, explored: [], ownedTerritories: [], history: [], cellDesign: null,
            driftProgress: 0, mergedCells: 0, tech: [], taxRate: 5, lastTaxTime: null
        },
        async sync() { if (!this.user) return; try { await updateDoc(doc(db, 'users', this.user.uid), { game: this.game, updatedAt: serverTimestamp() }); } catch (e) { console.error(e); } },
        async load() { if (!this.user) return; try { const snap = await getDoc(doc(db, 'users', this.user.uid)); if (snap.exists()) { const d = snap.data(); this.userData = d; if (d.game) this.game = { ...this.game, ...d.game }; } } catch (e) { console.error(e); } }
    };
    
    function createStars() { const c = document.getElementById('stars'); c.innerHTML = ''; for (let i = 0; i < 150; i++) { const s = document.createElement('div'); s.className = 'star'; s.style.cssText = `left:${Math.random()*100}%;top:${Math.random()*100}%;width:${Math.random()*2+1}px;height:${s.style.width};animation-delay:${Math.random()*3}s`; c.appendChild(s); } }
    function showToast(msg, type = 'info') { const c = document.getElementById('toastContainer'); const icons = { success: 'âœ…', error: 'âŒ', info: 'â„¹ï¸' }; const t = document.createElement('div'); t.className = `toast ${type}`; t.innerHTML = `<span>${icons[type]}</span><span style="flex:1">${msg}</span>`; c.appendChild(t); setTimeout(() => t.remove(), 4000); }
    function showEvoAlert(icon, title, desc, effect) { const a = document.getElementById('evoAlert'); document.getElementById('evoAlertIcon').textContent = icon; document.getElementById('evoAlertTitle').textContent = title; document.getElementById('evoAlertDesc').textContent = desc; document.getElementById('evoAlertEffect').textContent = effect; a.classList.add('show'); setTimeout(() => a.classList.remove('show'), 2500); }
    function showStory(icon, title, text, callback) { document.getElementById('storyIcon').textContent = icon; document.getElementById('storyTitle').textContent = title; document.getElementById('storyText').innerHTML = text; document.getElementById('storyOverlay').classList.add('active'); window.storyCallback = callback; }
    function closeStory() { document.getElementById('storyOverlay').classList.remove('active'); if (window.storyCallback) window.storyCallback(); }
    function hideLoading() { document.getElementById('loadingScreen').classList.add('hidden'); }
    function navigate(page) { State.currentPage = page; render(); }
    function render() { const p = State.currentPage; if (p === 'login') renderLogin(); else if (p === 'dashboard') renderDashboard(); else if (p === 'cell-world') startCellWorld(); else if (p === 'drift') startCosmicDrift(); else if (p === 'landing') startPlanetLanding(); else if (p === 'planet') renderPlanet(); else if (p === 'tech') renderTech(); else if (p === 'history') renderHistory(); else renderPlaceholder(p); }
    
    function calculateTax() { const owned = State.game.ownedTerritories || []; return owned.filter(t => t.originalOwner).length * State.game.taxRate; }
    async function collectTax() { const now = Date.now(); const last = State.game.lastTaxTime || 0; if ((now - last) / 3600000 >= 1) { const tax = calculateTax(); if (tax > 0 && State.game.entropy >= tax) { State.game.entropy -= tax; State.game.lastTaxTime = now; await State.sync(); showToast(`ğŸ’° ì„¸ê¸ˆ ${tax} ì—”íŠ¸ë¡œí”¼ ë‚©ë¶€`, 'info'); } } }
    
    function drawCell(ctx, x, y, size, design, evolution, time = 0) {
        const d = design || generateCellDesign();
        const points = d.wobblePoints || 12;
        const parts = d.parts || { eye: 'normal', arm: 'tentacle', leg: 'normal', brain: 'normal', wing: 'normal' };
        ctx.save(); ctx.translate(x, y);
        if (d.pattern === 'glow' || d.glowIntensity > 0.5) { ctx.shadowColor = d.primaryColor; ctx.shadowBlur = 20 * (d.glowIntensity || 0.5); }
        ctx.beginPath();
        for (let i = 0; i < points; i++) { const angle = (i / points) * Math.PI * 2; const wobble = Math.sin(time * 0.1 + i * 0.5) * 5 * (d.wobbleIntensity || 1); const r = size + wobble; const px = Math.cos(angle) * r, py = Math.sin(angle) * r; i === 0 ? ctx.moveTo(px, py) : ctx.lineTo(px, py); }
        ctx.closePath();
        const g = ctx.createRadialGradient(-size * 0.3, -size * 0.3, 0, 0, 0, size * 1.2); g.addColorStop(0, d.primaryColor); g.addColorStop(0.6, d.secondaryColor); g.addColorStop(1, d.secondaryColor); ctx.fillStyle = g; ctx.fill(); ctx.shadowBlur = 0;
        if (d.pattern === 'spots') { ctx.fillStyle = 'rgba(255,255,255,0.3)'; for (let i = 0; i < 5; i++) { const angle = (i / 5) * Math.PI * 2 + time * 0.02; ctx.beginPath(); ctx.arc(Math.cos(angle) * size * 0.5, Math.sin(angle) * size * 0.5, size * 0.12, 0, Math.PI * 2); ctx.fill(); } }
        else if (d.pattern === 'stripes') { ctx.strokeStyle = 'rgba(255,255,255,0.2)'; ctx.lineWidth = 3; for (let i = -2; i <= 2; i++) { ctx.beginPath(); ctx.moveTo(i * size * 0.3, -size); ctx.lineTo(i * size * 0.3, size); ctx.stroke(); } }
        ctx.beginPath(); ctx.arc(-size * 0.25, -size * 0.25, size * 0.2, 0, Math.PI * 2); ctx.fillStyle = 'rgba(255,255,255,0.25)'; ctx.fill();
        
        if (evolution) {
            if (evolution.eye) {
                const st = parts.eye;
                if (st === 'normal') { ctx.beginPath(); ctx.arc(size * 0.35, -size * 0.1, size * 0.22, 0, Math.PI * 2); ctx.fillStyle = '#fff'; ctx.fill(); ctx.beginPath(); ctx.arc(size * 0.38, -size * 0.08, size * 0.11, 0, Math.PI * 2); ctx.fillStyle = '#1a1a2e'; ctx.fill(); }
                else if (st === 'big') { ctx.beginPath(); ctx.arc(size * 0.3, -size * 0.1, size * 0.35, 0, Math.PI * 2); ctx.fillStyle = '#fff'; ctx.fill(); ctx.beginPath(); ctx.arc(size * 0.35, -size * 0.05, size * 0.18, 0, Math.PI * 2); ctx.fillStyle = '#1a1a2e'; ctx.fill(); }
                else if (st === 'multiple') { for (let i = 0; i < 3; i++) { const ey = -size * 0.3 + i * size * 0.25; ctx.beginPath(); ctx.arc(size * 0.4, ey, size * 0.12, 0, Math.PI * 2); ctx.fillStyle = '#fff'; ctx.fill(); ctx.beginPath(); ctx.arc(size * 0.42, ey, size * 0.06, 0, Math.PI * 2); ctx.fillStyle = '#f00'; ctx.fill(); } }
                else if (st === 'glow') { ctx.shadowColor = '#0ff'; ctx.shadowBlur = 15; ctx.beginPath(); ctx.arc(size * 0.35, -size * 0.1, size * 0.2, 0, Math.PI * 2); ctx.fillStyle = '#0ff'; ctx.fill(); ctx.shadowBlur = 0; }
            }
            if (evolution.arm) {
                const st = parts.arm; ctx.strokeStyle = d.secondaryColor; ctx.lineWidth = size * 0.12; ctx.lineCap = 'round';
                if (st === 'tentacle') { ctx.beginPath(); ctx.moveTo(size * 0.7, size * 0.1); ctx.quadraticCurveTo(size * 1.2, size * 0.3 + Math.sin(time * 0.15) * 8, size * 1.4, size * 0.2); ctx.stroke(); }
                else if (st === 'claw') { ctx.beginPath(); ctx.moveTo(size * 0.7, size * 0.1); ctx.lineTo(size * 1.2, size * 0.1); ctx.stroke(); ctx.beginPath(); ctx.moveTo(size * 1.2, size * 0.1); ctx.lineTo(size * 1.4, -size * 0.1); ctx.lineTo(size * 1.4, size * 0.3); ctx.closePath(); ctx.fillStyle = d.secondaryColor; ctx.fill(); }
                else if (st === 'long') { ctx.beginPath(); ctx.moveTo(size * 0.7, size * 0.1); ctx.bezierCurveTo(size * 1.5, size * 0.5, size * 1.8, 0, size * 2, size * 0.3 + Math.sin(time * 0.1) * 10); ctx.stroke(); }
                else if (st === 'multiple') { for (let i = 0; i < 3; i++) { ctx.beginPath(); ctx.moveTo(size * 0.7, size * 0.1); ctx.quadraticCurveTo(size * 1.1, size * (0.1 - 0.3 + i * 0.3) + Math.sin(time * 0.15 + i) * 5, size * 1.3, size * (0.1 - 0.3 + i * 0.3)); ctx.stroke(); } }
            }
            if (evolution.leg) {
                const st = parts.leg; const lw = Math.sin(time * 0.2) * 10; ctx.strokeStyle = d.secondaryColor; ctx.lineWidth = size * 0.12;
                if (st === 'normal') { ctx.beginPath(); ctx.moveTo(size * 0.2, size * 0.7); ctx.lineTo(size * 0.15 + lw, size * 1.3); ctx.stroke(); ctx.beginPath(); ctx.moveTo(-size * 0.2, size * 0.7); ctx.lineTo(-size * 0.15 - lw, size * 1.3); ctx.stroke(); }
                else if (st === 'tentacle') { ctx.beginPath(); ctx.moveTo(size * 0.15, size * 0.7); ctx.quadraticCurveTo(size * 0.3 + lw * 0.5, size * 1.1, size * 0.1 + lw, size * 1.4); ctx.stroke(); ctx.beginPath(); ctx.moveTo(-size * 0.15, size * 0.7); ctx.quadraticCurveTo(-size * 0.3 - lw * 0.5, size * 1.1, -size * 0.1 - lw, size * 1.4); ctx.stroke(); }
                else if (st === 'multiple') { for (let i = 0; i < 4; i++) { const lx = -size * 0.3 + i * size * 0.2; ctx.beginPath(); ctx.moveTo(lx, size * 0.7); ctx.lineTo(lx + Math.sin(time * 0.2 + i) * 5, size * 1.2); ctx.stroke(); } }
                else if (st === 'fin') { ctx.fillStyle = d.secondaryColor + '88'; ctx.beginPath(); ctx.moveTo(0, size * 0.6); ctx.quadraticCurveTo(size * 0.5, size * 1.2 + lw * 0.5, 0, size * 1.5); ctx.quadraticCurveTo(-size * 0.5, size * 1.2 - lw * 0.5, 0, size * 0.6); ctx.fill(); }
            }
            if (evolution.brain) {
                const st = parts.brain;
                if (st === 'normal') { ctx.beginPath(); ctx.arc(0, -size * 0.5, size * 0.2, 0, Math.PI * 2); ctx.fillStyle = `rgba(254,228,64,${Math.sin(time * 0.1) * 0.3 + 0.7})`; ctx.fill(); }
                else if (st === 'large') { ctx.beginPath(); ctx.ellipse(0, -size * 0.6, size * 0.35, size * 0.25, 0, 0, Math.PI * 2); ctx.fillStyle = `rgba(200,100,255,${Math.sin(time * 0.1) * 0.3 + 0.7})`; ctx.fill(); }
                else if (st === 'antenna') { ctx.strokeStyle = '#fee440'; ctx.lineWidth = 3; ctx.beginPath(); ctx.moveTo(-size * 0.15, -size * 0.4); ctx.lineTo(-size * 0.25, -size * 0.8); ctx.stroke(); ctx.beginPath(); ctx.moveTo(size * 0.15, -size * 0.4); ctx.lineTo(size * 0.25, -size * 0.8); ctx.stroke(); ctx.fillStyle = '#fee440'; ctx.beginPath(); ctx.arc(-size * 0.25, -size * 0.8, 5, 0, Math.PI * 2); ctx.fill(); ctx.beginPath(); ctx.arc(size * 0.25, -size * 0.8, 5, 0, Math.PI * 2); ctx.fill(); }
                else if (st === 'halo') { ctx.strokeStyle = `rgba(254,228,64,${Math.sin(time * 0.15) * 0.3 + 0.7})`; ctx.lineWidth = 3; ctx.beginPath(); ctx.ellipse(0, -size * 0.6, size * 0.4, size * 0.15, 0, 0, Math.PI * 2); ctx.stroke(); }
            }
            if (evolution.wing) {
                const st = parts.wing; const wf = Math.sin(time * 0.3) * 0.3;
                if (st === 'normal') { ctx.fillStyle = `${d.primaryColor}88`; ctx.save(); ctx.rotate(wf - 0.4); ctx.beginPath(); ctx.moveTo(size * 0.4, -size * 0.2); ctx.quadraticCurveTo(size * 1.3, -size * 0.7, size * 1.8, -size * 0.15); ctx.quadraticCurveTo(size * 1.3, size * 0.1, size * 0.4, -size * 0.05); ctx.fill(); ctx.restore(); ctx.save(); ctx.scale(-1, 1); ctx.rotate(wf - 0.4); ctx.beginPath(); ctx.moveTo(size * 0.4, -size * 0.2); ctx.quadraticCurveTo(size * 1.3, -size * 0.7, size * 1.8, -size * 0.15); ctx.quadraticCurveTo(size * 1.3, size * 0.1, size * 0.4, -size * 0.05); ctx.fill(); ctx.restore(); }
                else if (st === 'butterfly') { ctx.fillStyle = `${d.primaryColor}aa`; ctx.save(); ctx.rotate(wf - 0.5); ctx.beginPath(); ctx.ellipse(size * 0.9, -size * 0.4, size * 0.6, size * 0.4, 0.3, 0, Math.PI * 2); ctx.fill(); ctx.restore(); ctx.save(); ctx.scale(-1, 1); ctx.rotate(wf - 0.5); ctx.beginPath(); ctx.ellipse(size * 0.9, -size * 0.4, size * 0.6, size * 0.4, 0.3, 0, Math.PI * 2); ctx.fill(); ctx.restore(); }
                else if (st === 'bat') { ctx.fillStyle = `${d.secondaryColor}cc`; ctx.save(); ctx.rotate(wf - 0.3); ctx.beginPath(); ctx.moveTo(size * 0.3, -size * 0.1); ctx.lineTo(size * 0.8, -size * 0.6); ctx.lineTo(size * 1.2, -size * 0.3); ctx.lineTo(size * 1.5, -size * 0.5); ctx.lineTo(size * 1.3, 0); ctx.lineTo(size * 0.3, size * 0.1); ctx.fill(); ctx.restore(); ctx.save(); ctx.scale(-1, 1); ctx.rotate(wf - 0.3); ctx.beginPath(); ctx.moveTo(size * 0.3, -size * 0.1); ctx.lineTo(size * 0.8, -size * 0.6); ctx.lineTo(size * 1.2, -size * 0.3); ctx.lineTo(size * 1.5, -size * 0.5); ctx.lineTo(size * 1.3, 0); ctx.lineTo(size * 0.3, size * 0.1); ctx.fill(); ctx.restore(); }
                else if (st === 'energy') { ctx.strokeStyle = `rgba(0,245,212,${Math.sin(time * 0.2) * 0.3 + 0.7})`; ctx.lineWidth = 3; ctx.shadowColor = '#00f5d4'; ctx.shadowBlur = 10; for (let i = 0; i < 3; i++) { ctx.save(); ctx.rotate(wf - 0.4 - i * 0.15); ctx.beginPath(); ctx.moveTo(size * 0.4, -size * 0.1); ctx.lineTo(size * (1.2 + i * 0.2), -size * (0.3 + i * 0.1)); ctx.stroke(); ctx.restore(); ctx.save(); ctx.scale(-1, 1); ctx.rotate(wf - 0.4 - i * 0.15); ctx.beginPath(); ctx.moveTo(size * 0.4, -size * 0.1); ctx.lineTo(size * (1.2 + i * 0.2), -size * (0.3 + i * 0.1)); ctx.stroke(); ctx.restore(); } ctx.shadowBlur = 0; }
            }
        }
        ctx.restore();
    }
    
    function navbar() {
        const s = State.game.stage; const tax = calculateTax();
        return `<nav class="navbar">
            <div class="nav-logo" onclick="window.nav('dashboard')">BOKLUCK</div>
            <div class="nav-links">
                <div class="nav-link ${State.currentPage==='dashboard'?'active':''}" onclick="window.nav('dashboard')">ğŸ  ëŒ€ì‹œë³´ë“œ</div>
                <div class="nav-link ${s<3?'locked':''}" onclick="${s>=3?"window.nav('planet')":""}">ğŸª í–‰ì„± ${s<3?'ğŸ”’':''}</div>
                <div class="nav-link ${s<3?'locked':''}" onclick="${s>=3?"window.nav('tech')":""}">ğŸ”¬ ê¸°ìˆ  ${s<3?'ğŸ”’':''}</div>
                <div class="nav-link" onclick="window.nav('history')">ğŸ“œ ì—­ì‚¬ì„œ</div>
            </div>
            <div class="nav-right">
                ${tax > 0 ? `<span style="font-size:12px;color:var(--accent)">ğŸ’° ì„¸ê¸ˆ: ${tax}/ì‹œê°„</span>` : ''}
                <div class="entropy-badge"><span>âš¡</span><span class="entropy-value">${State.game.entropy.toLocaleString()}</span></div>
                <div class="user-menu">
                    <img class="user-avatar" src="${State.user?.photoURL||'https://via.placeholder.com/36'}" onclick="toggleUserMenu()">
                    <div class="user-dropdown" id="userDropdown">
                        <div class="dropdown-item" onclick="window.openEditModal()">ğŸ§¬ ì„¸í¬ ì»¤ìŠ¤í…€</div>
                        <div class="dropdown-item danger" onclick="window.logout()">ğŸšª ë¡œê·¸ì•„ì›ƒ</div>
                    </div>
                </div>
            </div>
        </nav>`;
    }
    function toggleUserMenu() { document.getElementById('userDropdown').classList.toggle('show'); }
    document.addEventListener('click', (e) => { if (!e.target.closest('.user-menu')) { const dd = document.getElementById('userDropdown'); if (dd) dd.classList.remove('show'); } });
    
    function renderLogin() {
        document.getElementById('app').innerHTML = `<div class="login-page">
            <h1 class="login-logo">BOKLUCK</h1>
            <p class="login-subtitle">Universe</p>
            <div style="width:150px;height:150px;margin-bottom:40px"><canvas id="loginCellCanvas" width="150" height="150"></canvas></div>
            <p class="login-story">ì–¸ì œì¸ì§€, ì™œì¸ì§€ ì•Œ ìˆ˜ ì—†ë‹¤.<br>ë‚˜ëŠ” ê´‘í™œí•œ ìš°ì£¼ ì–´ë”˜ê°€ì—ì„œ<br>í•˜ë‚˜ì˜ <strong>ì„¸í¬</strong>ë¡œ íƒœì–´ë‚¬ë‹¤.<br><br>ì‚´ì•„ë‚¨ìœ¼ë ¤ë©´ <strong>ì—”íŠ¸ë¡œí”¼</strong>ë¥¼ ëª¨ì•„ì•¼ í•œë‹¤.</p>
            <button class="btn btn-google btn-lg" onclick="window.googleLogin()"><img src="https://www.google.com/favicon.ico" style="width:20px;height:20px;margin-right:8px"> Googleë¡œ ì‹œì‘í•˜ê¸°</button>
        </div>`;
        const canvas = document.getElementById('loginCellCanvas');
        if (canvas) { const ctx = canvas.getContext('2d'); let t = 0; const rd = generateCellDesign(); function animate() { if (!document.getElementById('loginCellCanvas')) return; t++; ctx.clearRect(0, 0, 150, 150); drawCell(ctx, 75, 75, 40, rd, { eye: true, arm: true, leg: true, brain: true, wing: true }, t); requestAnimationFrame(animate); } animate(); }
    }
    
    function renderDashboard() {
        const { stage, entropy, evolution, history, cellDesign } = State.game;
        const evoCount = Object.values(evolution).filter(v => v).length;
        const design = cellDesign || generateCellDesign();
        const stageLabels = { 1: 'ì„¸í¬', 2: 'ë‚™í•˜', 3: 'ì •ì°©', 4: 'ì€í•˜', 5: 'ì •ë³µ' };
        const stageNum = Math.floor(stage);
        let nextAction = '';
        if (stage === 1 && entropy < 800) nextAction = `<button class="btn btn-primary btn-block mt-24" onclick="window.nav('cell-world')">ğŸŒŒ ì„¸í¬ ì„¸ê³„ ì§„ì…</button>`;
        else if (stage === 1 && entropy >= 800) nextAction = `<button class="btn btn-energy btn-block mt-24" onclick="window.nav('drift')">ğŸŒ  ìš°ì£¼ í‘œë¥˜</button>`;
        else if (stage === 1.5) nextAction = `<button class="btn btn-energy btn-block mt-24" onclick="window.nav('drift')">ğŸŒ  í‘œë¥˜ ê³„ì†</button>`;
        else if (stage === 2) nextAction = `<button class="btn btn-energy btn-block mt-24" onclick="window.nav('landing')">ğŸš€ í–‰ì„± ì°©ë¥™</button>`;
        else if (stage >= 3) nextAction = `<button class="btn btn-primary btn-block mt-24" onclick="window.nav('planet')">ğŸª í–‰ì„± íƒí—˜</button>`;
        
        document.getElementById('app').innerHTML = `${navbar()}<main class="main-content"><div class="page-container">
            <div class="dashboard-grid">
                <div class="card entity-card">
                    <div class="entity-visual" onclick="window.openEditModal()"><canvas id="entityCanvas" width="200" height="200"></canvas></div>
                    <div style="font-family:'Orbitron',sans-serif;font-size:11px;color:var(--accent);text-align:center;margin-bottom:8px">STAGE ${stageNum} Â· ${stageLabels[stageNum] || ''}</div>
                    <div class="entity-name">${design.name || 'Entity'} <button style="background:none;border:none;color:var(--text-muted);cursor:pointer" onclick="window.openEditModal()">âœï¸</button></div>
                    <div style="font-size:12px;color:var(--text-muted);text-align:center;margin-bottom:20px">#${State.user?.uid?.slice(-6) || '000000'}</div>
                    <div class="entity-stats">
                        <div class="stat-box"><div class="stat-value">${evoCount}/5</div><div class="stat-label">ì§„í™”</div></div>
                        <div class="stat-box"><div class="stat-value">${State.game.mergedCells||0}</div><div class="stat-label">í•©ì²´</div></div>
                        <div class="stat-box"><div class="stat-value">${(State.game.explored||[]).length}</div><div class="stat-label">íƒí—˜</div></div>
                        <div class="stat-box"><div class="stat-value">${(State.game.tech||[]).length}</div><div class="stat-label">ê¸°ìˆ </div></div>
                    </div>
                    ${nextAction}
                </div>
                <div>
                    <div class="quick-actions">
                        <div class="quick-action" onclick="window.nav('cell-world')"><div class="quick-action-icon">ğŸ¦ </div><div class="quick-action-label">ì„¸í¬ ì„¸ê³„</div></div>
                        <div class="quick-action ${stage<1.5&&entropy<800?'locked':''}" onclick="${stage>=1.5||entropy>=800?"window.nav('drift')":""}"><div class="quick-action-icon">ğŸŒ </div><div class="quick-action-label">ìš°ì£¼ í‘œë¥˜</div></div>
                        <div class="quick-action ${stage<3?'locked':''}" onclick="${stage>=3?"window.nav('planet')":""}"><div class="quick-action-icon">ğŸª</div><div class="quick-action-label">í–‰ì„±</div></div>
                        <div class="quick-action ${stage<3?'locked':''}" onclick="${stage>=3?"window.nav('tech')":""}"><div class="quick-action-icon">ğŸ”¬</div><div class="quick-action-label">ê¸°ìˆ </div></div>
                    </div>
                    <div class="card">
                        <div class="card-header"><span class="card-title">ğŸ“œ ë‚˜ì˜ ì—­ì‚¬ì„œ</span><button class="btn btn-outline btn-sm" onclick="window.nav('history')">ì „ì²´</button></div>
                        ${(history||[]).length===0?`<div class="text-center text-muted" style="padding:40px"><p style="font-size:32px;margin-bottom:12px">ğŸ“œ</p><p>ì•„ì§ ê¸°ë¡ëœ ì—­ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤</p></div>`:(history||[]).slice(-3).reverse().map(e=>`<div class="history-entry"><div class="history-chapter">ì œ${e.chapter}ì¥</div><div class="history-title">${e.title}</div><div class="history-content">${e.content}</div></div>`).join('')}
                    </div>
                </div>
            </div>
        </div></main>`;
        animateEntityCanvas();
    }
    
    function animateEntityCanvas() { const canvas = document.getElementById('entityCanvas'); if (!canvas) return; const ctx = canvas.getContext('2d'); let t = 0; function draw() { if (!document.getElementById('entityCanvas')) return; t++; ctx.clearRect(0, 0, 200, 200); drawCell(ctx, 100, 100, 45, State.game.cellDesign, State.game.evolution, t); requestAnimationFrame(draw); } draw(); }
    
    function renderHistory() {
        const h = State.game.history || [];
        document.getElementById('app').innerHTML = `${navbar()}<main class="main-content"><div class="page-container" style="max-width:800px">
            <h1 class="font-display text-center mb-8" style="font-size:32px">ğŸ“œ ë‚˜ì˜ ì—­ì‚¬ì„œ</h1>
            <p class="text-muted text-center mb-24">${State.game.cellDesign?.name || 'Entity'}ì˜ ì—¬ì •</p>
            ${h.length===0?`<div class="card text-center" style="padding:60px"><p style="font-size:48px;margin-bottom:16px">ğŸ“œ</p><p>ì•„ì§ ê¸°ë¡ëœ ì—­ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤</p></div>`:h.map(e=>`<div class="card mb-16"><div class="history-chapter">ì œ${e.chapter}ì¥</div><h3 style="font-size:18px;font-weight:700">${e.title}</h3><p style="margin-top:12px;line-height:1.8;color:var(--text-muted)">${e.content}</p></div>`).join('')}
        </div></main>`;
    }
    
    function renderPlanet() {
        const planet = State.game.currentPlanet || { name: 'ë¯¸ì§€ì˜ í–‰ì„±', type: 'íƒí—˜ í•„ìš”' };
        const explored = State.game.explored || [];
        const hasRadio = (State.game.tech || []).includes('radio');
        const hasRocket = (State.game.tech || []).includes('rocket');
        
        document.getElementById('app').innerHTML = `${navbar()}<main class="main-content"><div class="page-container">
            <div class="card mb-24" style="display:flex;align-items:center;gap:24px;padding:24px;flex-wrap:wrap">
                <span style="font-size:64px">ğŸª</span>
                <div style="flex:1;min-width:200px"><h1 class="font-display" style="font-size:28px">${planet.name}</h1><p class="text-muted">${planet.type}</p></div>
                <div style="display:flex;gap:8px;flex-wrap:wrap">
                    ${hasRadio ? `<button class="btn btn-outline" onclick="window.openInviteModal()">ğŸ“¡ ì´ˆëŒ€ ì‹ í˜¸</button>` : ''}
                    ${hasRocket ? `<button class="btn btn-primary">ğŸš€ ë‹¤ë¥¸ í–‰ì„±</button>` : ''}
                </div>
            </div>
            <div class="dashboard-grid">
                <div>
                    <div class="card mb-24">
                        <div class="card-header"><span class="card-title">ğŸ—ºï¸ í–‰ì„± ì§€ë„</span><span class="text-muted" style="font-size:12px">íƒí—˜: ${explored.length}/100</span></div>
                        <div class="planet-map" id="planetMap"></div>
                        <p class="text-muted text-center" style="font-size:12px">í´ë¦­í•˜ì—¬ íƒí—˜ (50âš¡) | ğŸŸ¢íƒí—˜ì™„ë£Œ ğŸŸ¡í™ˆ ğŸ”´íƒ€ì¸ì˜í† </p>
                        ${calculateTax() > 0 ? `<div class="tax-info"><div class="tax-info-title">ğŸ’° ì ë ¹ì§€ ì„¸ê¸ˆ</div><div class="tax-info-desc">${calculateTax()} ì—”íŠ¸ë¡œí”¼/ì‹œê°„</div></div>` : ''}
                    </div>
                </div>
                <div>
                    <div class="card mb-24">
                        <div class="card-header"><span class="card-title">ğŸ“Š íƒí—˜ í†µê³„</span></div>
                        <div class="entity-stats">
                            <div class="stat-box"><div class="stat-value">${explored.length}</div><div class="stat-label">íƒí—˜ ì§€ì—­</div></div>
                            <div class="stat-box"><div class="stat-value">${(State.game.ownedTerritories||[]).length}</div><div class="stat-label">ì†Œìœ  ì˜í† </div></div>
                            <div class="stat-box"><div class="stat-value">${explored.filter(e=>e.type==='creature').length}</div><div class="stat-label">ë°œê²¬ ìƒëª…ì²´</div></div>
                            <div class="stat-box"><div class="stat-value">${explored.filter(e=>e.type==='artifact').length}</div><div class="stat-label">ë°œê²¬ ìœ ë¬¼</div></div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header"><span class="card-title">ğŸ“œ ìµœê·¼ íƒí—˜</span></div>
                        ${explored.length === 0 ? `<p class="text-muted text-center">ì•„ì§ íƒí—˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</p>` : explored.slice(-5).reverse().map(e => `<div style="display:flex;align-items:center;gap:12px;padding:12px;background:var(--bg-input);border-radius:8px;margin-bottom:8px"><span style="font-size:24px">${e.icon}</span><div style="flex:1"><div style="font-weight:600;font-size:13px">${e.title}</div><div style="font-size:11px;color:var(--text-muted)">(${e.x}, ${e.y})</div></div><span style="color:${e.entropy >= 0 ? 'var(--success)' : 'var(--danger)'};font-size:13px">${e.entropy >= 0 ? '+' : ''}${e.entropy}âš¡</span></div>`).join('')}
                    </div>
                </div>
            </div>
        </div></main>`;
        renderPlanetMap();
    }
    
    async function renderPlanetMap() {
        const map = document.getElementById('planetMap'); if (!map) return;
        const explored = State.game.explored || [];
        const owned = State.game.ownedTerritories || [];
        const exploredSet = new Set(explored.map(e => `${e.x},${e.y}`));
        const ownedSet = new Set(owned.map(t => `${t.x},${t.y}`));
        
        let otherTerritories = new Map();
        try { const q = query(collection(db, 'territories'), where('planetName', '==', State.game.currentPlanet?.name)); const snap = await getDocs(q); snap.forEach(doc => { const t = doc.data(); if (t.ownerId !== State.user.uid) otherTerritories.set(`${t.x},${t.y}`, t); }); } catch (e) { console.error(e); }
        
        let html = '';
        for (let y = 0; y < 10; y++) {
            for (let x = 0; x < 10; x++) {
                const key = `${x},${y}`; const isExplored = exploredSet.has(key); const isOwned = ownedSet.has(key); const isHome = x === 5 && y === 5; const otherOwner = otherTerritories.get(key);
                let cls = 'map-cell', content = '';
                if (isHome) { cls += ' home'; content = 'ğŸ '; }
                else if (otherOwner) { cls += ' owned-other'; content = 'ğŸ‘¤'; }
                else if (isOwned) { cls += ' explored'; content = 'ğŸ´'; }
                else if (isExplored) { cls += ' explored'; content = 'âœ“'; }
                html += `<div class="${cls}" onclick="window.exploreCell(${x}, ${y}, ${otherOwner ? `'${otherOwner.ownerId}'` : 'null'})">${content}</div>`;
            }
        }
        map.innerHTML = html;
    }
    
    async function exploreCell(x, y, otherOwnerId) {
        const key = `${x},${y}`; const explored = State.game.explored || []; const owned = State.game.ownedTerritories || [];
        const alreadyExplored = explored.some(e => e.x === x && e.y === y);
        if (x === 5 && y === 5) { showToast('ğŸ  ì—¬ê¸°ëŠ” í™ˆë² ì´ìŠ¤ì…ë‹ˆë‹¤', 'info'); return; }
        
        if (otherOwnerId) {
            const conquerCost = 200;
            if (State.game.entropy < conquerCost) { showToast(`ì ë ¹ì— ${conquerCost}âš¡ í•„ìš”`, 'error'); return; }
            if (confirm(`${conquerCost}âš¡ë¡œ ì ë ¹í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì ë ¹ í›„ ì„¸ê¸ˆì´ ë¶€ê³¼ë©ë‹ˆë‹¤.`)) {
                State.game.entropy -= conquerCost;
                State.game.ownedTerritories.push({ x, y, originalOwner: otherOwnerId });
                await setDoc(doc(db, 'territories', `${State.game.currentPlanet.name}_${x}_${y}`), { planetName: State.game.currentPlanet.name, x, y, ownerId: State.user.uid, ownerName: State.game.cellDesign?.name, conqueredFrom: otherOwnerId, timestamp: serverTimestamp() });
                State.game.history.push({ chapter: State.game.history.length + 1, title: 'ì˜í†  ì ë ¹', content: `ì¢Œí‘œ (${x}, ${y})ì˜ ì˜í† ë¥¼ ì ë ¹í–ˆë‹¤.`, timestamp: new Date().toISOString() });
                await State.sync(); showToast(`âš”ï¸ ì ë ¹ ì„±ê³µ! (ì„¸ê¸ˆ +${State.game.taxRate}/ì‹œê°„)`, 'success'); renderPlanetMap();
            }
            return;
        }
        
        if (alreadyExplored) {
            const alreadyOwned = owned.some(t => t.x === x && t.y === y);
            if (alreadyOwned) { showToast('ì´ë¯¸ ì†Œìœ í•œ ì˜í† ì…ë‹ˆë‹¤', 'info'); return; }
            const claimCost = 100;
            if (State.game.entropy < claimCost) { showToast(`ì†Œìœ ì— ${claimCost}âš¡ í•„ìš”`, 'error'); return; }
            State.game.entropy -= claimCost;
            State.game.ownedTerritories.push({ x, y });
            await setDoc(doc(db, 'territories', `${State.game.currentPlanet.name}_${x}_${y}`), { planetName: State.game.currentPlanet.name, x, y, ownerId: State.user.uid, ownerName: State.game.cellDesign?.name, timestamp: serverTimestamp() });
            await State.sync(); showToast(`ğŸ´ ì˜í†  (${x}, ${y}) ì†Œìœ  ì™„ë£Œ!`, 'success'); renderPlanetMap(); return;
        }
        
        const exploreCost = 50;
        if (State.game.entropy < exploreCost) { showToast(`íƒí—˜ì— ${exploreCost}âš¡ í•„ìš”`, 'error'); return; }
        State.game.entropy -= exploreCost;
        const event = EXPLORE_EVENTS[Math.floor(Math.random() * EXPLORE_EVENTS.length)];
        State.game.entropy += event.entropy;
        State.game.explored.push({ x, y, ...event, timestamp: new Date().toISOString() });
        await State.sync();
        document.getElementById('exploreTitle').textContent = `${event.icon} ${event.title}`;
        document.getElementById('exploreDesc').innerHTML = `<p style="margin-bottom:16px">${event.desc}</p><p style="color:${event.entropy >= 0 ? 'var(--success)' : 'var(--danger)'}">${event.entropy >= 0 ? '+' : ''}${event.entropy}âš¡ (íƒí—˜ë¹„ -${exploreCost})</p>`;
        document.getElementById('exploreModal').classList.add('active');
        render();
    }
    function closeExploreModal() { document.getElementById('exploreModal').classList.remove('active'); }
    
    function renderTech() {
        const unlockedTech = State.game.tech || [];
        document.getElementById('app').innerHTML = `${navbar()}<main class="main-content"><div class="page-container">
            <h1 class="font-display text-center mb-8" style="font-size:32px">ğŸ”¬ ë¬¸ëª… ê¸°ìˆ </h1>
            <p class="text-muted text-center mb-24">ê¸°ìˆ ì„ ì—°êµ¬í•˜ì—¬ ë¬¸ëª…ì„ ë°œì „ì‹œí‚¤ì„¸ìš”</p>
            <div class="tech-tree">
                ${TECH_TREE.map(tech => {
                    const isUnlocked = unlockedTech.includes(tech.id);
                    const canUnlock = !isUnlocked && tech.requires.every(r => unlockedTech.includes(r)) && State.game.entropy >= tech.cost;
                    const isLocked = !isUnlocked && !canUnlock;
                    return `<div class="tech-item ${isUnlocked ? 'unlocked' : canUnlock ? 'available' : 'locked'}" onclick="${canUnlock ? `window.unlockTech('${tech.id}')` : ''}">
                        <div class="tech-icon">${tech.icon}</div>
                        <div class="tech-name">${tech.name}</div>
                        <div class="tech-desc">${tech.desc}</div>
                        ${isUnlocked ? '<div style="color:var(--success)">âœ“ ì™„ë£Œ</div>' : `<div class="tech-cost">âš¡ ${tech.cost.toLocaleString()}</div>`}
                        ${isLocked && tech.requires.length > 0 ? `<div style="font-size:11px;color:var(--text-muted);margin-top:8px">í•„ìš”: ${tech.requires.join(', ')}</div>` : ''}
                    </div>`;
                }).join('')}
            </div>
        </div></main>`;
    }
    
    async function unlockTech(techId) {
        const tech = TECH_TREE.find(t => t.id === techId); if (!tech) return;
        if (State.game.entropy < tech.cost) { showToast('ì—”íŠ¸ë¡œí”¼ ë¶€ì¡±', 'error'); return; }
        State.game.entropy -= tech.cost;
        State.game.tech = State.game.tech || [];
        State.game.tech.push(techId);
        State.game.history.push({ chapter: State.game.history.length + 1, title: `ê¸°ìˆ : ${tech.name}`, content: `${tech.desc} ë¬¸ëª…ì´ ë°œì „í–ˆë‹¤.`, timestamp: new Date().toISOString() });
        await State.sync(); showEvoAlert(tech.icon, `${tech.name} ì—°êµ¬ ì™„ë£Œ!`, tech.desc, 'ìƒˆë¡œìš´ ê¸°ëŠ¥ í•´ê¸ˆ'); render();
    }
    
    function openInviteModal() { document.getElementById('inviteModal').classList.add('active'); }
    function closeInviteModal() { document.getElementById('inviteModal').classList.remove('active'); }
    async function sendInvite() {
        const email = document.getElementById('inviteEmailInput').value.trim();
        if (!email) { showToast('ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”', 'error'); return; }
        try {
            await addDoc(collection(db, 'invitations'), { fromId: State.user.uid, fromName: State.game.cellDesign?.name || State.user.displayName, toEmail: email, planetName: State.game.currentPlanet?.name, status: 'pending', createdAt: serverTimestamp() });
            showToast('ğŸ“¡ ì´ˆëŒ€ ì‹ í˜¸ ë°œì†¡!', 'success'); closeInviteModal();
        } catch (e) { console.error(e); showToast('ë°œì†¡ ì‹¤íŒ¨', 'error'); }
    }
    
    function renderPlaceholder(p) { document.getElementById('app').innerHTML = `${navbar()}<main class="main-content"><div class="page-container text-center" style="padding-top:100px"><h1 style="font-size:48px;margin-bottom:24px">ğŸ”’</h1><h2 class="font-display mb-16">${p}</h2><p class="text-muted mb-24">ì¤€ë¹„ ì¤‘...</p><button class="btn btn-outline" onclick="window.nav('dashboard')">ëŒ€ì‹œë³´ë“œë¡œ</button></div></main>`; }
    
    let worldRunning = false;
    function exitWorld() { worldRunning = false; document.getElementById('worldCanvas').classList.remove('active'); document.getElementById('worldUI').classList.remove('active'); document.getElementById('worldControls').classList.remove('active'); document.getElementById('encounterDialog').classList.remove('active'); navigate('dashboard'); }
    
    function startCellWorld() {
        document.getElementById('app').innerHTML = '';
        const canvas = document.getElementById('worldCanvas'); const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        canvas.classList.add('active'); document.getElementById('worldUI').classList.add('active'); document.getElementById('worldControls').classList.add('active');
        document.getElementById('worldControls').innerHTML = `<div><span class="key">W A S D</span> ì´ë™</div><div><span class="key">SPACE</span> ëŒ€ì‹œ</div><div><span class="key">ESC</span> í™ˆ</div>`;
        document.getElementById('worldStatLabel').textContent = 'ENTROPY';
        document.getElementById('worldNavButtons').innerHTML = `<button class="world-nav-btn" onclick="window.exitWorld()">ğŸ  í™ˆ</button><button class="world-nav-btn next-stage" id="nextStageBtn" onclick="window.goToDrift()" disabled>ğŸŒ  ìš°ì£¼ í‘œë¥˜</button>`;
        worldRunning = true;
        const design = State.game.cellDesign || generateCellDesign();
        const player = { x: 0, y: 0, size: 30 + State.game.entropy * 0.02, speed: State.game.evolution.leg ? 5 : 3, visionRange: State.game.evolution.eye ? 500 : 300, collectRange: State.game.evolution.arm ? 100 : 50, multiplier: State.game.evolution.brain ? 2 : 1, dashing: false, dashCD: 0 };
        let particles = []; const camera = { x: 0, y: 0 }; const keys = {}; let time = 0;
        
        function onKeyDown(e) { keys[e.key.toLowerCase()] = true; if (e.code === 'Space' && State.game.evolution.wing && player.dashCD <= 0) { player.dashing = true; player.dashCD = 60; setTimeout(() => player.dashing = false, 200); } if (e.key === 'Escape') exitWorld(); }
        function onKeyUp(e) { keys[e.key.toLowerCase()] = false; }
        function onResize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.addEventListener('keydown', onKeyDown); window.addEventListener('keyup', onKeyUp); window.addEventListener('resize', onResize);
        function cleanup() { window.removeEventListener('keydown', onKeyDown); window.removeEventListener('keyup', onKeyUp); window.removeEventListener('resize', onResize); }
        
        function updateEvoPanel() {
            const evo = State.game.evolution; const e = State.game.entropy;
            document.getElementById('worldInfoPanel').innerHTML = `<div class="world-info-title">ğŸ§¬ ì§„í™”</div>${[['eye','ğŸ‘ï¸','ì‹œê°',100],['arm','ğŸ¦¾','íŒ”',200],['leg','ğŸ¦µ','ë‹¤ë¦¬',300],['brain','ğŸ§ ','ë‘ë‡Œ',500],['wing','ğŸª½','ë‚ ê°œ',800]].map(([k,icon,name,req])=>`<div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;opacity:${evo[k]?1:0.4}"><div style="width:24px;height:24px;background:${evo[k]?'var(--gradient-evolution)':'var(--bg-input)'};border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:12px">${icon}</div><div style="font-size:12px">${name} ${evo[k]?'âœ“':req}</div></div>`).join('')}`;
            document.getElementById('nextStageBtn').disabled = State.game.entropy < 800;
        }
        updateEvoPanel();
        
        function spawn() { while (particles.length < 100) { const a = Math.random() * Math.PI * 2, d = 100 + Math.random() * 400; particles.push({ x: player.x + Math.cos(a) * d, y: player.y + Math.sin(a) * d, size: 5 + Math.random() * 12, value: 1 + Math.floor(Math.random() * 3), pulse: Math.random() * Math.PI * 2, hue: 160 + Math.random() * 60 }); } }
        
        async function checkEvo() {
            const e = State.game.entropy; const evo = State.game.evolution;
            const evos = [['eye',100,'ğŸ‘ï¸','ì‹œê° ì§„í™”!','ëˆˆ ìƒì„±','ì‹œì•¼+','ì²« ëˆˆ','ì„¸ìƒì´ ë³´ì´ê¸° ì‹œì‘í–ˆë‹¤.'],['arm',200,'ğŸ¦¾','íŒ” ì§„í™”!','íŒ” ìƒì„±','ìˆ˜ì§‘+','ì²« íŒ”','ì´‰ìˆ˜ê°€ ìë¼ë‚¬ë‹¤.'],['leg',300,'ğŸ¦µ','ë‹¤ë¦¬ ì§„í™”!','ë‹¤ë¦¬ ìƒì„±','ì†ë„+','ì´ë™','ë‹¤ë¦¬ê°€ ìƒê²¼ë‹¤.'],['brain',500,'ğŸ§ ','ë‘ë‡Œ ì§„í™”!','ì§€ëŠ¥ ë°œë‹¬','2ë°°','ì§€ì„±','ì˜ì‹ì´ í™•ì¥ë˜ì—ˆë‹¤.'],['wing',800,'ğŸª½','ë‚ ê°œ ì§„í™”!','ë‚ ê°œ ìƒì„±','ëŒ€ì‹œ','ë‚ ê°œ','ë‚ ê°œê°€ í¼ì³ì¡Œë‹¤.']];
            for (const [k,req,icon,title,desc,effect,hTitle,hContent] of evos) { if (!evo[k] && e >= req) { State.game.evolution[k] = true; if (k === 'eye') player.visionRange = 500; if (k === 'arm') player.collectRange = 100; if (k === 'leg') player.speed = 5; if (k === 'brain') player.multiplier = 2; showEvoAlert(icon, title, desc, effect); State.game.history.push({ chapter: State.game.history.length + 1, title: hTitle, content: hContent, timestamp: new Date().toISOString() }); updateEvoPanel(); } }
            player.size = Math.min(30 + e * 0.02, 80); await State.sync();
        }
        
        function update() {
            let mx = 0, my = 0;
            if (keys['w'] || keys['arrowup']) my = -1; if (keys['s'] || keys['arrowdown']) my = 1; if (keys['a'] || keys['arrowleft']) mx = -1; if (keys['d'] || keys['arrowright']) mx = 1;
            if (mx && my) { mx *= 0.707; my *= 0.707; }
            let spd = player.speed; if (player.dashing) spd *= 3;
            player.x += mx * spd; player.y += my * spd;
            if (player.dashCD > 0) player.dashCD--;
            camera.x += (player.x - camera.x) * 0.1; camera.y += (player.y - camera.y) * 0.1;
        }
        
        function collect() { particles = particles.filter(p => { const dx = p.x - player.x, dy = p.y - player.y; const d = Math.sqrt(dx * dx + dy * dy); if (d < player.collectRange + p.size) { State.game.entropy += p.value * player.multiplier; document.getElementById('worldStatValue').textContent = State.game.entropy; checkEvo(); return false; } if (State.game.evolution.arm && d < player.collectRange * 2) { p.x -= dx * 0.05; p.y -= dy * 0.05; } return true; }); }
        
        function drawBg() { const g = ctx.createRadialGradient(canvas.width/2, canvas.height/2, 0, canvas.width/2, canvas.height/2, canvas.width); g.addColorStop(0, '#0a0a1a'); g.addColorStop(1, '#050510'); ctx.fillStyle = g; ctx.fillRect(0, 0, canvas.width, canvas.height); ctx.fillStyle = 'rgba(255,255,255,0.5)'; for (let i = 0; i < 100; i++) { const x = ((i * 137.5 + camera.x * 0.1) % canvas.width + canvas.width) % canvas.width; const y = ((i * 73.7 + camera.y * 0.1) % canvas.height + canvas.height) % canvas.height; ctx.beginPath(); ctx.arc(x, y, (Math.sin(time * 0.02 + i) + 1) * 1.2, 0, Math.PI * 2); ctx.fill(); } }
        function drawParticles() { particles.forEach(p => { const sx = canvas.width / 2 + (p.x - camera.x); const sy = canvas.height / 2 + (p.y - camera.y); p.pulse += 0.05; const sz = p.size * (Math.sin(p.pulse) * 0.3 + 1); const g = ctx.createRadialGradient(sx, sy, 0, sx, sy, sz); g.addColorStop(0, `hsla(${p.hue}, 100%, 70%, 1)`); g.addColorStop(1, `hsla(${p.hue}, 100%, 50%, 0)`); ctx.beginPath(); ctx.arc(sx, sy, sz, 0, Math.PI * 2); ctx.fillStyle = g; ctx.fill(); }); }
        function drawPlayer() { if (player.dashing) { ctx.shadowColor = design.primaryColor; ctx.shadowBlur = 50; } drawCell(ctx, canvas.width / 2, canvas.height / 2, player.size, design, State.game.evolution, time); ctx.shadowBlur = 0; }
        
        function loop() { if (!worldRunning) { cleanup(); return; } time++; update(); spawn(); collect(); drawBg(); drawParticles(); drawPlayer(); requestAnimationFrame(loop); }
        for (let i = 0; i < 60; i++) { const a = Math.random() * Math.PI * 2, d = 50 + Math.random() * 300; particles.push({ x: Math.cos(a) * d, y: Math.sin(a) * d, size: 5 + Math.random() * 12, value: 1 + Math.floor(Math.random() * 3), pulse: Math.random() * Math.PI * 2, hue: 160 + Math.random() * 60 }); }
        document.getElementById('worldStatValue').textContent = State.game.entropy;
        loop();
    }
    
    function goToDrift() {
        if (State.game.entropy < 800) return;
        if (State.game.stage < 1.5) { State.game.stage = 1.5; State.game.history.push({ chapter: State.game.history.length + 1, title: 'íƒˆì¶œ', content: 'ê³µê°„ì„ ë²—ì–´ë‚¬ë‹¤.', timestamp: new Date().toISOString() }); State.sync(); }
        worldRunning = false; document.getElementById('worldCanvas').classList.remove('active'); document.getElementById('worldUI').classList.remove('active'); document.getElementById('worldControls').classList.remove('active');
        showStory('ğŸŒ ', 'ìš°ì£¼ í‘œë¥˜', 'ê´‘í™œí•œ <strong>ìš°ì£¼</strong>ë¡œ ë‚˜ì™”ìŠµë‹ˆë‹¤.<br>ë‹¤ë¥¸ <strong>ì˜ì‹</strong>ë“¤ì´ ë– ëŒê³  ìˆìŠµë‹ˆë‹¤...', () => navigate('drift'));
    }
    
    function startCosmicDrift() {
        document.getElementById('app').innerHTML = '';
        const canvas = document.getElementById('worldCanvas'); const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        canvas.classList.add('active'); document.getElementById('worldUI').classList.add('active'); document.getElementById('worldControls').classList.add('active');
        document.getElementById('worldControls').innerHTML = `<div><span class="key">W A S D</span> ì´ë™</div><div><span class="key">ESC</span> í™ˆ</div>`;
        document.getElementById('worldStatLabel').textContent = 'DISTANCE';
        document.getElementById('worldNavButtons').innerHTML = `<button class="world-nav-btn" onclick="window.exitWorld()">ğŸ  í™ˆ</button>`;
        worldRunning = true;
        const design = State.game.cellDesign || generateCellDesign();
        let driftProgress = State.game.driftProgress || 0; const targetDistance = 1000;
        const player = { x: canvas.width / 2, y: canvas.height / 2, speed: 4 };
        let driftingCells = []; let encounterActive = false; let currentEncounter = null; let time = 0; const keys = {};
        
        function onKeyDown(e) { keys[e.key.toLowerCase()] = true; if (e.key === 'Escape') exitWorld(); }
        function onKeyUp(e) { keys[e.key.toLowerCase()] = false; }
        function onResize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.addEventListener('keydown', onKeyDown); window.addEventListener('keyup', onKeyUp); window.addEventListener('resize', onResize);
        function cleanup() { window.removeEventListener('keydown', onKeyDown); window.removeEventListener('keyup', onKeyUp); window.removeEventListener('resize', onResize); }
        
        function updateInfoPanel() { const progress = Math.min(driftProgress / targetDistance * 100, 100); document.getElementById('worldInfoPanel').innerHTML = `<div class="world-info-title">ğŸŒŒ í‘œë¥˜</div><div class="progress-bar mb-8"><div class="progress-fill" style="width:${progress}%"></div></div><div style="font-size:11px;color:var(--text-muted)">${Math.floor(driftProgress)} / ${targetDistance}m</div>`; }
        updateInfoPanel();
        
        function spawnDriftingCell() { if (driftingCells.length >= 5 || encounterActive) return; const side = Math.floor(Math.random() * 4); let x, y; if (side === 0) { x = -50; y = Math.random() * canvas.height; } else if (side === 1) { x = canvas.width + 50; y = Math.random() * canvas.height; } else if (side === 2) { x = Math.random() * canvas.width; y = -50; } else { x = Math.random() * canvas.width; y = canvas.height + 50; } const types = ['friendly', 'hostile', 'neutral', 'mysterious']; driftingCells.push({ x, y, vx: (Math.random() - 0.5) * 2, vy: (Math.random() - 0.5) * 2, size: 20 + Math.random() * 20, type: types[Math.floor(Math.random() * types.length)], design: generateCellDesign() }); }
        
        function showEncounter(cell) { encounterActive = true; currentEncounter = cell; const titles = { friendly: 'ìš°í˜¸ì  ì˜ì‹', hostile: 'ì ëŒ€ì  ì˜ì‹', neutral: 'ì¤‘ë¦½ì  ì˜ì‹', mysterious: 'ì‹ ë¹„ë¡œìš´ ì˜ì‹' }; document.getElementById('encounterTitle').textContent = titles[cell.type]; document.getElementById('encounterDesc').textContent = 'ì–´ë–»ê²Œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?'; document.getElementById('encounterChoices').innerHTML = [{id:'absorb',title:'í¡ìˆ˜',effect:'+50âš¡'},{id:'merge',title:'í•©ì²´',effect:'ëŠ¥ë ¥â†‘'},{id:'ignore',title:'ë¬´ì‹œ',effect:'ì•ˆì „ í†µê³¼'},{id:'talk',title:'ëŒ€í™”',effect:'ëœë¤'}].map(c=>`<div class="encounter-choice" onclick="window.makeChoice('${c.id}')"><div class="choice-title">${c.title}</div><div class="choice-effect">${c.effect}</div></div>`).join(''); document.getElementById('encounterDialog').classList.add('active'); }
        
        async function makeChoiceHandler(choice) { document.getElementById('encounterDialog').classList.remove('active'); if (choice === 'absorb') { State.game.entropy += 50; showToast('âš¡ +50!', 'success'); } else if (choice === 'merge') { State.game.mergedCells = (State.game.mergedCells || 0) + 1; State.game.entropy += 100; showToast('ğŸ§¬ +100!', 'success'); } else if (choice === 'ignore') { showToast('ë¬´ì‚¬ í†µê³¼', 'info'); } else if (choice === 'talk') { const r = Math.random() > 0.5 ? 30 : -30; State.game.entropy = Math.max(0, State.game.entropy + r); showToast(r > 0 ? 'ğŸ’¬ ì •ë³´ íšë“!' : 'âš ï¸ í•¨ì •!', r > 0 ? 'info' : 'error'); } driftingCells = driftingCells.filter(c => c !== currentEncounter); encounterActive = false; currentEncounter = null; await State.sync(); }
        window.makeChoice = makeChoiceHandler;
        
        function update() { if (encounterActive) return; let mx = 0, my = 0; if (keys['w'] || keys['arrowup']) my = -1; if (keys['s'] || keys['arrowdown']) my = 1; if (keys['a'] || keys['arrowleft']) mx = -1; if (keys['d'] || keys['arrowright']) mx = 1; if (mx && my) { mx *= 0.707; my *= 0.707; } player.x += mx * player.speed; player.y += my * player.speed; player.x = Math.max(40, Math.min(canvas.width - 40, player.x)); player.y = Math.max(40, Math.min(canvas.height - 40, player.y)); if (mx !== 0 || my !== 0) { driftProgress += 0.5; State.game.driftProgress = driftProgress; document.getElementById('worldStatValue').textContent = Math.floor(driftProgress) + 'm'; updateInfoPanel(); } if (driftProgress >= targetDistance) { worldRunning = false; cleanup(); canvas.classList.remove('active'); document.getElementById('worldUI').classList.remove('active'); document.getElementById('worldControls').classList.remove('active'); State.game.stage = 2; State.game.history.push({ chapter: State.game.history.length + 1, title: 'í–‰ì„± ë°œê²¬', content: 'ë“œë””ì–´ í–‰ì„±ì´ ë³´ì¸ë‹¤.', timestamp: new Date().toISOString() }); State.sync(); showStory('ğŸŒ', 'í–‰ì„± ë°œê²¬!', '<strong>í–‰ì„±</strong>ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤!', () => navigate('landing')); return; } if (Math.random() < 0.01) spawnDriftingCell(); driftingCells.forEach(cell => { cell.x += cell.vx; cell.y += cell.vy; const dx = player.x - cell.x, dy = player.y - cell.y; const d = Math.sqrt(dx * dx + dy * dy); if (d < 60 && !encounterActive) showEncounter(cell); }); driftingCells = driftingCells.filter(c => c.x > -100 && c.x < canvas.width + 100 && c.y > -100 && c.y < canvas.height + 100); }
        
        function drawBg() { ctx.fillStyle = '#030308'; ctx.fillRect(0, 0, canvas.width, canvas.height); ctx.fillStyle = 'rgba(255,255,255,0.6)'; for (let i = 0; i < 200; i++) { const x = (i * 137.5 + time * 0.5) % canvas.width; const y = (i * 73.7) % canvas.height; ctx.beginPath(); ctx.arc(x, y, ((i % 3) + 1) * 0.8, 0, Math.PI * 2); ctx.fill(); } }
        function drawDriftingCells() { driftingCells.forEach(cell => { const colors = { friendly: '#4ade80', hostile: '#f87171', neutral: '#a3a3a3', mysterious: '#c084fc' }; ctx.globalAlpha = 0.8; const tempDesign = { ...cell.design, primaryColor: colors[cell.type] }; drawCell(ctx, cell.x, cell.y, cell.size, tempDesign, { eye: true, arm: true }, time); ctx.globalAlpha = 1; }); }
        function drawPlayer() { drawCell(ctx, player.x, player.y, 35, design, State.game.evolution, time); }
        function loop() { if (!worldRunning) { cleanup(); return; } time++; update(); drawBg(); drawDriftingCells(); drawPlayer(); requestAnimationFrame(loop); }
        document.getElementById('worldStatValue').textContent = Math.floor(driftProgress) + 'm';
        loop();
    }
    
    function startPlanetLanding() {
        document.getElementById('app').innerHTML = '';
        const canvas = document.getElementById('worldCanvas'); const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        canvas.classList.add('active'); document.getElementById('worldUI').classList.add('active');
        document.getElementById('worldStatLabel').textContent = 'DISTANCE';
        document.getElementById('worldNavButtons').innerHTML = '<button class="world-nav-btn" onclick="window.exitWorld()">ğŸ  í¬ê¸°</button>';
        document.getElementById('worldInfoPanel').innerHTML = `<div class="world-info-title">ğŸ›¡ï¸ ì‹¤ë“œ</div><div class="progress-bar"><div class="progress-fill" id="healthBar" style="width:100%;background:linear-gradient(90deg, var(--danger), var(--accent))"></div></div>`;
        worldRunning = true;
        const design = State.game.cellDesign || generateCellDesign();
        const targetPlanet = { name: PLANET_NAMES[Math.floor(Math.random() * PLANET_NAMES.length)], type: PLANET_TYPES[Math.floor(Math.random() * PLANET_TYPES.length)] };
        const player = { x: canvas.width / 2, y: 100, size: 30, health: 100, speed: 8 };
        let obstacles = []; let distance = 0; const targetDistance = 3000; let gameOver = false; let time = 0; const keys = {};
        
        function onKeyDown(e) { keys[e.key.toLowerCase()] = true; if (e.key === 'Escape') { worldRunning = false; exitLanding(); } }
        function onKeyUp(e) { keys[e.key.toLowerCase()] = false; }
        function onResize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.addEventListener('keydown', onKeyDown); window.addEventListener('keyup', onKeyUp); window.addEventListener('resize', onResize);
        function cleanup() { window.removeEventListener('keydown', onKeyDown); window.removeEventListener('keyup', onKeyUp); window.removeEventListener('resize', onResize); }
        function exitLanding() { cleanup(); canvas.classList.remove('active'); document.getElementById('worldUI').classList.remove('active'); document.getElementById('resultModal').classList.remove('active'); navigate('dashboard'); }
        
        function spawnObstacle() { if (Math.random() < 0.5) { obstacles.push({ type: 'asteroid', x: Math.random() * (canvas.width - 60) + 30, y: canvas.height + 50, size: 20 + Math.random() * 30, speed: 3 + Math.random() * 3, rotation: 0, rotSpeed: (Math.random() - 0.5) * 0.1 }); } else { const width = 100 + Math.random() * 200; obstacles.push({ type: 'barrier', x: Math.random() * (canvas.width - width), y: canvas.height + 30, width, height: 20, speed: 4 + Math.random() * 2 }); } }
        
        function update() { if (gameOver) return; if (keys['a'] || keys['arrowleft']) player.x -= player.speed; if (keys['d'] || keys['arrowright']) player.x += player.speed; player.x = Math.max(player.size, Math.min(canvas.width - player.size, player.x)); distance += 5; document.getElementById('worldStatValue').textContent = `${Math.floor(distance)}m / ${targetDistance}m`; if (Math.random() < 0.03 + (distance / targetDistance) * 0.02) spawnObstacle(); obstacles = obstacles.filter(o => { o.y -= o.speed; if (o.rotation !== undefined) o.rotation += o.rotSpeed; let hit = false; if (o.type === 'asteroid') { if (Math.sqrt((player.x - o.x)**2 + (player.y - o.y)**2) < player.size + o.size) hit = true; } else if (o.type === 'barrier') { if (player.x > o.x - player.size && player.x < o.x + o.width + player.size && player.y > o.y - player.size && player.y < o.y + o.height + player.size) hit = true; } if (hit) { player.health -= 20; document.getElementById('healthBar').style.width = player.health + '%'; if (player.health <= 0) { gameOver = true; showLandingResult(false, targetPlanet); } return false; } return o.y > -100; }); if (distance >= targetDistance) { gameOver = true; showLandingResult(true, targetPlanet); } }
        
        async function showLandingResult(success, planet) { setTimeout(async () => { document.getElementById('resultIcon').textContent = success ? 'ğŸª' : 'ğŸ’¥'; document.getElementById('resultTitle').textContent = success ? 'ì°©ë¥™ ì„±ê³µ!' : 'ì°©ë¥™ ì‹¤íŒ¨'; document.getElementById('resultDesc').textContent = success ? `${planet.name}ì— ë„ì°©!` : 'ì¶”ë½í–ˆìŠµë‹ˆë‹¤.'; if (success) { State.game.currentPlanet = planet; State.game.stage = 3; State.game.explored = []; State.game.ownedTerritories = [{ x: 5, y: 5 }]; State.game.history.push({ chapter: State.game.history.length + 1, title: 'ìƒˆë¡œìš´ ì„¸ê³„', content: `${planet.name}ì— ì°©ë¥™. ìƒˆ ë¬¸ëª… ì‹œì‘.`, timestamp: new Date().toISOString() }); await State.sync(); document.getElementById('resultActions').innerHTML = '<button class="btn btn-primary" onclick="window.explorePlanet()">ğŸŒ í–‰ì„± íƒí—˜</button>'; } else { document.getElementById('resultActions').innerHTML = '<button class="btn btn-outline" onclick="window.retryLanding()">ë‹¤ì‹œ ì‹œë„</button><button class="btn btn-primary" onclick="window.goHome()">í™ˆìœ¼ë¡œ</button>'; } document.getElementById('resultModal').classList.add('active'); }, 500); }
        
        function drawBg() { const g = ctx.createLinearGradient(0, 0, 0, canvas.height); g.addColorStop(0, '#050510'); g.addColorStop(1, '#1a1a4a'); ctx.fillStyle = g; ctx.fillRect(0, 0, canvas.width, canvas.height); ctx.fillStyle = 'rgba(255,255,255,0.6)'; for (let i = 0; i < 50; i++) { const x = (i * 137.5) % canvas.width; const y = ((i * 73.7 + distance * 0.5) % canvas.height); ctx.beginPath(); ctx.arc(x, y, 1 + Math.random(), 0, Math.PI * 2); ctx.fill(); } const progress = Math.min(distance / targetDistance, 1); const planetSize = 200 + progress * 300; const planetY = canvas.height + 200 - progress * 300; const pg = ctx.createRadialGradient(canvas.width/2 - planetSize * 0.2, planetY - planetSize * 0.2, 0, canvas.width/2, planetY, planetSize); pg.addColorStop(0, '#4ade80'); pg.addColorStop(0.5, '#22c55e'); pg.addColorStop(1, '#14532d'); ctx.beginPath(); ctx.arc(canvas.width/2, planetY, planetSize, 0, Math.PI * 2); ctx.fillStyle = pg; ctx.fill(); }
        function drawObstacles() { obstacles.forEach(o => { if (o.type === 'asteroid') { ctx.save(); ctx.translate(o.x, o.y); ctx.rotate(o.rotation); ctx.beginPath(); for (let i = 0; i < 8; i++) { const angle = (i / 8) * Math.PI * 2; const r = o.size * (0.8 + Math.sin(i * 2.5) * 0.2); i === 0 ? ctx.moveTo(Math.cos(angle) * r, Math.sin(angle) * r) : ctx.lineTo(Math.cos(angle) * r, Math.sin(angle) * r); } ctx.closePath(); ctx.fillStyle = '#4b5563'; ctx.fill(); ctx.restore(); } else if (o.type === 'barrier') { ctx.fillStyle = 'rgba(239,68,68,0.8)'; ctx.shadowColor = '#ef4444'; ctx.shadowBlur = 20; ctx.fillRect(o.x, o.y, o.width, o.height); ctx.shadowBlur = 0; } }); }
        function drawPlayer() { drawCell(ctx, player.x, player.y, player.size, design, State.game.evolution, time); }
        function loop() { if (!worldRunning) { cleanup(); return; } time++; if (!gameOver) update(); drawBg(); drawObstacles(); drawPlayer(); requestAnimationFrame(loop); }
        loop();
    }
    
    function explorePlanet() { document.getElementById('resultModal').classList.remove('active'); worldRunning = false; document.getElementById('worldCanvas').classList.remove('active'); document.getElementById('worldUI').classList.remove('active'); navigate('planet'); }
    function retryLanding() { document.getElementById('resultModal').classList.remove('active'); startPlanetLanding(); }
    function goHome() { document.getElementById('resultModal').classList.remove('active'); worldRunning = false; document.getElementById('worldCanvas').classList.remove('active'); document.getElementById('worldUI').classList.remove('active'); navigate('dashboard'); }
    
    let previewAnimationId = null; let tempDesign = null; let selectedPart = null; let changedParts = new Set();
    
    function openEditModal() {
        document.getElementById('editCellModal').classList.add('active');
        tempDesign = JSON.parse(JSON.stringify(State.game.cellDesign || generateCellDesign()));
        changedParts = new Set(); selectedPart = null;
        document.getElementById('cellNameInput').value = tempDesign.name || '';
        renderPartsGrid(); startPreviewAnimation();
    }
    
    function renderPartsGrid() {
        const parts = tempDesign.parts || {}; const evo = State.game.evolution;
        document.getElementById('partsGrid').innerHTML = Object.entries(PART_STYLES).map(([part, styles]) => {
            const currentStyle = styles.find(s => s.id === parts[part]) || styles[0];
            const isUnlocked = evo[part]; const isSelected = selectedPart === part;
            return `<div class="part-item ${isSelected ? 'selected' : ''} ${!isUnlocked ? 'locked' : ''}" onclick="${isUnlocked ? `window.selectPart('${part}')` : ''}"><div class="part-icon">${currentStyle.icon}</div><div class="part-name">${part === 'eye' ? 'ëˆˆ' : part === 'arm' ? 'íŒ”' : part === 'leg' ? 'ë‹¤ë¦¬' : part === 'brain' ? 'ë‡Œ' : 'ë‚ ê°œ'}</div><div class="part-style">${isUnlocked ? currentStyle.name : 'ğŸ”’'}</div></div>`;
        }).join('');
        
        document.getElementById('styleSelector').style.display = selectedPart ? 'block' : 'none';
        if (selectedPart) {
            const styles = PART_STYLES[selectedPart]; const currentStyle = tempDesign.parts[selectedPart];
            document.getElementById('styleTitle').textContent = `ìŠ¤íƒ€ì¼ ì„ íƒ (1000âš¡/ê°œ)`;
            document.getElementById('styleOptions').innerHTML = styles.map(s => `<div class="style-option ${s.id === currentStyle ? 'selected' : ''}" onclick="window.selectStyle('${s.id}')"><div style="font-size:24px;margin-bottom:4px">${s.icon}</div><div>${s.name}</div></div>`).join('');
        }
    }
    
    function selectPart(part) { selectedPart = selectedPart === part ? null : part; renderPartsGrid(); }
    function selectStyle(styleId) { if (!selectedPart) return; const originalStyle = (State.game.cellDesign?.parts || {})[selectedPart]; if (styleId !== originalStyle) { changedParts.add(selectedPart); } else { changedParts.delete(selectedPart); } tempDesign.parts[selectedPart] = styleId; renderPartsGrid(); }
    function closeEditModal() { document.getElementById('editCellModal').classList.remove('active'); if (previewAnimationId) cancelAnimationFrame(previewAnimationId); }
    function startPreviewAnimation() { const canvas = document.getElementById('cellPreview'); if (!canvas) return; const ctx = canvas.getContext('2d'); let t = 0; function animate() { t++; ctx.clearRect(0, 0, 180, 180); drawCell(ctx, 90, 90, 40, tempDesign, State.game.evolution, t); previewAnimationId = requestAnimationFrame(animate); } animate(); }
    function randomizeCellDesign() { tempDesign = generateCellDesign(); document.getElementById('cellNameInput').value = tempDesign.name; changedParts = new Set(); selectedPart = null; renderPartsGrid(); }
    
    async function saveCellDesign() {
        const cost = changedParts.size * 1000;
        if (cost > 0) {
            if (State.game.entropy < cost) { showToast(`íŒŒì¸  ë³€ê²½ì— ${cost}âš¡ í•„ìš”`, 'error'); return; }
            if (!confirm(`${changedParts.size}ê°œ íŒŒì¸  ë³€ê²½ì— ${cost}âš¡ ì‚¬ìš©?`)) return;
            State.game.entropy -= cost;
        }
        tempDesign.name = document.getElementById('cellNameInput').value || tempDesign.name;
        State.game.cellDesign = { ...tempDesign };
        await State.sync(); closeEditModal(); showToast(`âœ¨ ì„¸í¬ ì—…ë°ì´íŠ¸!${cost > 0 ? ` (-${cost}âš¡)` : ''}`, 'success'); render();
    }
    
    async function googleLogin() {
        try {
            document.getElementById('loadingScreen').classList.remove('hidden');
            const result = await signInWithPopup(auth, googleProvider); const user = result.user;
            const snap = await getDoc(doc(db, 'users', user.uid));
            if (!snap.exists()) {
                const newDesign = generateCellDesign();
                await setDoc(doc(db, 'users', user.uid), { displayName: user.displayName, email: user.email, photoURL: user.photoURL, game: { entropy: 0, stage: 1, evolution: { eye: false, arm: false, leg: false, brain: false, wing: false }, currentPlanet: null, explored: [], ownedTerritories: [], history: [], cellDesign: newDesign, driftProgress: 0, mergedCells: 0, tech: [], taxRate: 5, lastTaxTime: null }, createdAt: serverTimestamp(), updatedAt: serverTimestamp() });
                showToast('ğŸ‰ ìš°ì£¼ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!', 'success');
            }
        } catch (e) { console.error(e); showToast('ë¡œê·¸ì¸ ì‹¤íŒ¨', 'error'); hideLoading(); }
    }
    async function logout() { await signOut(auth); State.user = null; navigate('login'); }
    
    async function init() {
        createStars();
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                State.user = user; await State.load();
                if (!State.game.cellDesign) { State.game.cellDesign = generateCellDesign(); await State.sync(); }
                collectTax(); hideLoading(); navigate('dashboard');
            } else { State.user = null; hideLoading(); navigate('login'); }
        });
        setInterval(() => { if (State.user) collectTax(); }, 60000);
        
        window.nav = navigate; window.googleLogin = googleLogin; window.logout = logout; window.exitWorld = exitWorld; window.goToDrift = goToDrift;
        window.openEditModal = openEditModal; window.closeEditModal = closeEditModal; window.randomizeCellDesign = randomizeCellDesign; window.saveCellDesign = saveCellDesign;
        window.selectPart = selectPart; window.selectStyle = selectStyle;
        window.exploreCell = exploreCell; window.closeExploreModal = closeExploreModal;
        window.unlockTech = unlockTech; window.openInviteModal = openInviteModal; window.closeInviteModal = closeInviteModal; window.sendInvite = sendInvite;
        window.explorePlanet = explorePlanet; window.retryLanding = retryLanding; window.goHome = goHome; window.closeStory = closeStory; window.toggleUserMenu = toggleUserMenu;
    }
    init();
    </script>
</body>
</html>
