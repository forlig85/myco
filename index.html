<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#020010">
    <title>AROA - A Road Of Adventure</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸš€</text></svg>">
    <style>
/* ========================================
   AROA - Global Styles
======================================== */
*, *::before, *::after {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

:root {
    --bg-dark: #020010;
    --bg-surface: #0a0a1a;
    --primary: #4fc3f7;
    --secondary: #ab47bc;
    --accent: #ffd700;
    --success: #44ff88;
    --danger: #ff4466;
    --text: #e8e8ff;
    --text-muted: #888;
    --border: rgba(79, 195, 247, 0.3);
    --safe-top: env(safe-area-inset-top, 0px);
    --safe-bottom: env(safe-area-inset-bottom, 0px);
}

html, body {
    width: 100%;
    height: 100%;
    overflow: hidden;
    background: var(--bg-dark);
    color: var(--text);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    touch-action: none;
    position: fixed;
    -webkit-tap-highlight-color: transparent;
    -webkit-user-select: none;
    user-select: none;
}

#app {
    position: fixed;
    inset: 0;
    overflow: hidden;
    z-index: 100;
}

#game-container {
    position: fixed;
    inset: 0;
    z-index: 1;
}

/* ========================================
   Common Components
======================================== */
.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 14px 32px;
    border: none;
    border-radius: 30px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    font-family: inherit;
}
.btn:active { transform: scale(0.96); }
.btn-primary {
    background: linear-gradient(135deg, var(--primary), #2196f3);
    color: #fff;
    box-shadow: 0 4px 20px rgba(33, 150, 243, 0.4);
}
.btn-primary:hover {
    box-shadow: 0 6px 25px rgba(33, 150, 243, 0.6);
    transform: translateY(-2px);
}
.btn-secondary {
    background: linear-gradient(135deg, var(--secondary), #7b1fa2);
    color: #fff;
}
.btn-outline {
    background: transparent;
    color: var(--text);
    border: 1px solid var(--border);
}
.btn-ghost {
    background: rgba(255,255,255,0.1);
    color: var(--text);
}
.btn-block { width: 100%; }
.btn-sm { padding: 10px 20px; font-size: 0.9rem; }

/* Page Layout */
.page-center {
    position: relative;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 24px;
    padding-top: calc(24px + var(--safe-top));
    padding-bottom: calc(24px + var(--safe-bottom));
}
.page-content {
    max-width: 400px;
    width: 100%;
    text-align: center;
}
.page-icon {
    font-size: 4rem;
    margin-bottom: 16px;
    animation: float 3s ease-in-out infinite;
}
@keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}

/* ========================================
   Title Screen Styles
======================================== */
.title-screen {
    position: relative;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 20px;
    padding-top: env(safe-area-inset-top, 20px);
    padding-bottom: env(safe-area-inset-bottom, 20px);
}

.logo-section {
    text-align: center;
    margin-bottom: 50px;
}

.logo-icon {
    font-size: 60px;
    margin-bottom: 10px;
    animation: float 3s ease-in-out infinite;
}

.logo-title {
    font-size: 52px;
    font-weight: bold;
    background: linear-gradient(135deg, #4fc3f7 0%, #ab47bc 50%, #ff6b9d 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    letter-spacing: 8px;
    margin-bottom: 8px;
    animation: glow 2s ease-in-out infinite alternate;
}

@keyframes glow {
    from { filter: drop-shadow(0 0 10px rgba(79, 195, 247, 0.5)); }
    to { filter: drop-shadow(0 0 20px rgba(171, 71, 188, 0.8)); }
}

.logo-subtitle {
    font-size: 14px;
    color: #888;
    letter-spacing: 3px;
    text-transform: uppercase;
}

.button-section {
    width: 100%;
    max-width: 300px;
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-bottom: 40px;
}

.login-btn {
    width: 100%;
    padding: 16px 24px;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    font-family: inherit;
}

.login-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s ease;
}

.login-btn:hover::before {
    left: 100%;
}

.login-btn:active {
    transform: scale(0.98);
}

.btn-google {
    background: #ffffff;
    color: #333;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.btn-google:hover {
    box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    transform: translateY(-2px);
}

.google-icon {
    width: 20px;
    height: 20px;
}

.btn-guest {
    background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
    color: #fff;
    border: 1px solid rgba(255,255,255,0.2);
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.btn-guest:hover {
    background: linear-gradient(135deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.08) 100%);
    border-color: rgba(255,255,255,0.3);
    transform: translateY(-2px);
}

.settings-section {
    position: absolute;
    bottom: calc(env(safe-area-inset-bottom, 20px) + 60px);
    left: 0;
    right: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 30px;
}

.setting-btn {
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.2);
    color: #fff;
    padding: 10px 16px;
    border-radius: 25px;
    font-size: 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
    font-family: inherit;
}

.setting-btn:hover {
    background: rgba(255,255,255,0.15);
    border-color: rgba(255,255,255,0.3);
}

.setting-btn:active {
    transform: scale(0.95);
}

.version-info {
    position: absolute;
    bottom: calc(env(safe-area-inset-bottom, 10px) + 20px);
    left: 50%;
    transform: translateX(-50%);
    color: #444;
    font-size: 11px;
}

/* Guest Warning Modal */
.guest-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    z-index: 200;
    display: none;
    justify-content: center;
    align-items: center;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.guest-modal-overlay.show {
    display: flex;
    opacity: 1;
}

.guest-modal-content {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 20px;
    padding: 30px;
    width: 90%;
    max-width: 320px;
    text-align: center;
    transform: scale(0.9);
    transition: transform 0.3s ease;
}

.guest-modal-overlay.show .guest-modal-content {
    transform: scale(1);
}

.warning-icon {
    font-size: 50px;
    margin-bottom: 15px;
    animation: shake 0.5s ease-in-out;
}

@keyframes shake {
    0%, 100% { transform: rotate(0deg); }
    25% { transform: rotate(-10deg); }
    75% { transform: rotate(10deg); }
}

.warning-title {
    color: #ffcc00;
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 20px;
}

.warning-text {
    color: #ccc;
    font-size: 14px;
    line-height: 1.8;
    margin-bottom: 25px;
}

.warning-text strong {
    color: #ff6b6b;
}

.warning-buttons {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.warning-btn {
    width: 100%;
    padding: 14px 20px;
    border: none;
    border-radius: 10px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    font-family: inherit;
}

.warning-btn:active {
    transform: scale(0.98);
}

.btn-recommend {
    background: linear-gradient(135deg, #4fc3f7 0%, #2196f3 100%);
    color: #fff;
    box-shadow: 0 4px 15px rgba(33, 150, 243, 0.4);
}

.btn-recommend:hover {
    box-shadow: 0 6px 20px rgba(33, 150, 243, 0.6);
    transform: translateY(-2px);
}

.btn-continue {
    background: rgba(255,255,255,0.1);
    color: #888;
    border: 1px solid rgba(255,255,255,0.1);
}

.btn-continue:hover {
    background: rgba(255,255,255,0.15);
    color: #aaa;
}

/* Language Modal */
.lang-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    z-index: 200;
    display: none;
    justify-content: center;
    align-items: center;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.lang-modal-overlay.show {
    display: flex;
    opacity: 1;
}

.lang-modal-content {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 20px;
    padding: 30px;
    width: 90%;
    max-width: 320px;
    transform: scale(0.9);
    transition: transform 0.3s ease;
}

.lang-modal-overlay.show .lang-modal-content {
    transform: scale(1);
}

.lang-modal-title {
    color: #fff;
    font-size: 20px;
    font-weight: 600;
    text-align: center;
    margin-bottom: 25px;
}

.language-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.language-btn {
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    color: #fff;
    padding: 14px 20px;
    border-radius: 10px;
    font-size: 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 12px;
    transition: all 0.3s ease;
    font-family: inherit;
}

.language-btn:hover {
    background: rgba(79, 195, 247, 0.2);
    border-color: rgba(79, 195, 247, 0.5);
}

.language-btn.active {
    background: linear-gradient(135deg, rgba(79, 195, 247, 0.3) 0%, rgba(171, 71, 188, 0.3) 100%);
    border-color: #4fc3f7;
}

.language-btn .flag {
    font-size: 24px;
}

.lang-modal-close {
    margin-top: 20px;
    width: 100%;
    padding: 14px;
    background: rgba(255,255,255,0.1);
    border: none;
    border-radius: 10px;
    color: #888;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-family: inherit;
}

.lang-modal-close:hover {
    background: rgba(255,255,255,0.15);
    color: #fff;
}

/* PC ë°˜ì‘í˜• */
@media (min-width: 769px) {
    .logo-title {
        font-size: 72px;
        letter-spacing: 12px;
    }
    .logo-subtitle {
        font-size: 16px;
        letter-spacing: 5px;
    }
    .logo-icon {
        font-size: 80px;
    }
    .button-section {
        max-width: 350px;
    }
    .login-btn {
        padding: 18px 28px;
        font-size: 17px;
    }
}

.page-title {
    font-size: 1.5rem;
    font-weight: bold;
    margin-bottom: 20px;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}
.page-text {
    font-size: 1rem;
    line-height: 1.9;
    color: var(--text-muted);
    margin-bottom: 30px;
}
.page-text .hl { color: var(--primary); font-weight: 500; }
.page-text .gold { color: var(--accent); }
.page-text .danger { color: var(--danger); }

/* Dots Indicator */
.dots {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-bottom: 25px;
}
.dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: rgba(255,255,255,0.2);
    transition: all 0.3s;
}
.dot.active {
    background: var(--primary);
    width: 24px;
    border-radius: 4px;
}
.dot.done { background: rgba(255,255,255,0.4); }

/* Dice */
.dice-box {
    width: 140px;
    height: 140px;
    margin: 24px auto;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 4rem;
    background: rgba(255,255,255,0.05);
    border: 2px solid var(--border);
    border-radius: 20px;
    transition: all 0.3s;
}
.dice-box.rolling { animation: shake 0.1s linear infinite; }
@keyframes shake {
    0%, 100% { transform: rotate(0deg) scale(1); }
    25% { transform: rotate(-10deg) scale(1.05); }
    50% { transform: rotate(10deg) scale(0.95); }
    75% { transform: rotate(-5deg) scale(1.02); }
}

.env-ranges {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
    margin: 20px 0;
    font-size: 0.75rem;
}
.env-range {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    background: rgba(255,255,255,0.05);
    border-radius: 8px;
    color: var(--text-muted);
}

.dice-result { margin: 20px 0; min-height: 100px; }
.result-icon { font-size: 3rem; margin-bottom: 8px; }
.result-name { font-size: 1.3rem; font-weight: bold; color: var(--primary); margin-bottom: 6px; }
.result-desc { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 4px; }
.result-weak { font-size: 0.8rem; color: var(--danger); }

/* Skip Button */
.skip-btn {
    position: absolute;
    top: calc(var(--safe-top) + 15px);
    right: 20px;
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.2);
    color: var(--text-muted);
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 13px;
    cursor: pointer;
    z-index: 200;
    transition: all 0.3s;
}
.skip-btn:hover { background: rgba(255,255,255,0.15); color: #aaa; }

/* ========================================
   Game HUD
======================================== */
.hud-top {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 50;
    padding: 12px 16px;
    padding-top: calc(12px + var(--safe-top));
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    pointer-events: none;
}
.hud-top > * { pointer-events: auto; }

.hud-panel {
    background: rgba(0, 20, 40, 0.85);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 10px 14px;
    backdrop-filter: blur(8px);
}
.hud-name { font-size: 0.75rem; color: var(--primary); margin-bottom: 6px; font-weight: 600; }
.hud-row { display: flex; align-items: center; gap: 6px; font-size: 0.8rem; margin-bottom: 4px; }
.hud-val { font-weight: 700; color: var(--accent); }
.hud-label { color: var(--text-muted); font-size: 0.65rem; }

.size-bar { display: flex; align-items: center; gap: 6px; margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1); }
.size-track { flex: 1; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; }
.size-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--accent)); border-radius: 3px; transition: width 0.3s; }
.size-num { font-size: 0.7rem; color: var(--text-muted); min-width: 24px; text-align: right; }

.parts-panel { max-width: 140px; }
.parts-title { font-size: 0.65rem; color: var(--text-muted); margin-bottom: 6px; }
.parts-grid { display: flex; flex-wrap: wrap; gap: 4px; }
.part-badge { display: flex; align-items: center; gap: 2px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.15); border-radius: 6px; padding: 3px 6px; font-size: 0.7rem; }
.part-badge.active { border-color: var(--primary); box-shadow: 0 0 8px rgba(79, 195, 247, 0.3); }
.part-cnt { font-size: 0.6rem; color: var(--accent); }

.progress-section { margin-top: 8px; }
.progress-label { display: flex; justify-content: space-between; font-size: 0.6rem; margin-bottom: 3px; }
.progress-left { color: var(--text-muted); }
.progress-right { color: var(--primary); }
.progress-track { height: 5px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; }
.progress-fill { height: 100%; border-radius: 3px; transition: width 0.3s; }
.progress-fill.evo { background: linear-gradient(90deg, var(--primary), var(--secondary)); }
.progress-fill.stage { background: linear-gradient(90deg, var(--secondary), var(--danger)); }

.hud-btns { display: flex; gap: 8px; }
.hud-btn { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: rgba(0, 20, 40, 0.9); border: 1px solid var(--border); border-radius: 10px; font-size: 1.1rem; cursor: pointer; transition: all 0.2s; }
.hud-btn:hover { border-color: var(--primary); box-shadow: 0 0 10px rgba(79, 195, 247, 0.3); }

.hud-bottom {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 40;
    padding: 12px 16px;
    padding-bottom: calc(100px + var(--safe-bottom));
    pointer-events: none;
}
.stage-bar { background: rgba(0, 20, 40, 0.9); border: 1px solid rgba(171, 71, 188, 0.3); border-radius: 12px; padding: 10px 14px; backdrop-filter: blur(8px); }
.stage-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
.stage-cur { font-size: 0.75rem; color: var(--secondary); font-weight: 600; }
.stage-next { font-size: 0.65rem; color: var(--text-muted); }

/* Controls */
.controls {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 60;
    padding: 16px 24px;
    padding-bottom: calc(16px + var(--safe-bottom));
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    pointer-events: none;
}
.controls > * { pointer-events: auto; }

.joystick { position: relative; width: 120px; height: 120px; opacity: 0.6; transition: opacity 0.2s; }
.joystick:active, .joystick.active { opacity: 1; }
.joy-base { position: absolute; inset: 0; background: rgba(0, 20, 40, 0.5); border: 2px solid rgba(79, 195, 247, 0.4); border-radius: 50%; }
.joy-knob { position: absolute; top: 50%; left: 50%; width: 50px; height: 50px; margin: -25px 0 0 -25px; background: linear-gradient(135deg, var(--primary), #2196f3); border-radius: 50%; box-shadow: 0 0 20px rgba(79, 195, 247, 0.5); transition: transform 0.05s; }

.action-btn { width: 75px; height: 75px; display: flex; align-items: center; justify-content: center; background: rgba(0, 20, 40, 0.6); border: 2px solid var(--primary); border-radius: 50%; font-size: 1.6rem; cursor: pointer; box-shadow: 0 0 25px rgba(79, 195, 247, 0.3); opacity: 0.6; transition: all 0.2s; }
.action-btn:hover { opacity: 0.9; }
.action-btn:active { transform: scale(0.92); opacity: 1; box-shadow: 0 0 35px rgba(79, 195, 247, 0.6); }
.action-btn.disabled { opacity: 0.3; pointer-events: none; }

/* Evolution Popup */
.evo-popup {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.8);
    z-index: 200;
    background: rgba(0, 20, 40, 0.98);
    border: 2px solid var(--primary);
    border-radius: 20px;
    padding: 30px 40px;
    text-align: center;
    opacity: 0;
    pointer-events: none;
    transition: all 0.4s;
    box-shadow: 0 0 50px rgba(79, 195, 247, 0.5);
}
.evo-popup.show { opacity: 1; transform: translate(-50%, -50%) scale(1); }
.evo-icon { font-size: 4rem; margin-bottom: 12px; animation: float 2s ease-in-out infinite; }
.evo-title { font-size: 1.4rem; font-weight: bold; color: var(--primary); margin-bottom: 8px; }
.evo-desc { color: var(--text-muted); font-size: 0.9rem; margin-bottom: 6px; }
.evo-fx { color: var(--accent); font-size: 0.85rem; font-weight: 600; }

/* Modal */
.modal {
    position: fixed;
    inset: 0;
    z-index: 300;
    display: none;
    align-items: center;
    justify-content: center;
    background: rgba(0, 10, 20, 0.95);
    padding: 24px;
}
.modal.show { display: flex; }
.modal-box { background: rgba(0, 30, 60, 0.95); border: 1px solid var(--border); border-radius: 20px; padding: 32px 28px; max-width: 340px; width: 100%; text-align: center; }
.modal-icon { font-size: 4rem; margin-bottom: 16px; }
.modal-title { font-size: 1.5rem; font-weight: bold; margin-bottom: 12px; }
.modal-title.fail { background: linear-gradient(135deg, #ff6b6b, var(--danger)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
.modal-title.win { background: linear-gradient(135deg, var(--primary), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
.modal-desc { color: var(--text-muted); font-size: 0.95rem; margin-bottom: 24px; line-height: 1.6; }
.modal-stats { background: rgba(0, 20, 40, 0.5); border-radius: 12px; padding: 14px; margin-bottom: 20px; }
.stat-row { display: flex; justify-content: space-between; padding: 6px 0; }
.stat-row:not(:last-child) { border-bottom: 1px solid rgba(255,255,255,0.1); }
.stat-label { color: var(--text-muted); font-size: 0.85rem; }
.stat-val { font-weight: 700; color: var(--primary); }
.modal-btns { display: flex; flex-direction: column; gap: 10px; }

/* Loading */
#loading {
    position: fixed;
    inset: 0;
    background: var(--bg-dark);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 500;
    transition: opacity 0.5s;
}
#loading.fade-out { opacity: 0; pointer-events: none; }
.spinner { width: 50px; height: 50px; border: 3px solid rgba(255,255,255,0.1); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
@keyframes spin { to { transform: rotate(360deg); } }
#loading p { color: var(--text-muted); font-size: 14px; }

/* Language Modal */
.lang-modal {
    position: fixed;
    inset: 0;
    z-index: 400;
    display: none;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.8);
    padding: 24px;
}
.lang-modal.show { display: flex; }
.lang-options { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 20px; }
.lang-btn { padding: 16px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 12px; font-size: 1.1rem; cursor: pointer; transition: all 0.2s; }
.lang-btn:hover { border-color: var(--primary); background: rgba(79, 195, 247, 0.1); }
.lang-btn.active { border-color: var(--primary); background: rgba(79, 195, 247, 0.2); }
    </style>
</head>
<body>
    <div id="loading">
        <div class="spinner"></div>
        <p>Loading AROA...</p>
    </div>
    
    <div id="game-container"></div>
    <div id="app"></div>
    
    <!-- Evolution Popup -->
    <div class="evo-popup" id="evo-popup">
        <div class="evo-icon" id="evo-icon">ğŸ§¬</div>
        <div class="evo-title" id="evo-title">ì§„í™”!</div>
        <div class="evo-desc" id="evo-desc"></div>
        <div class="evo-fx" id="evo-fx"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.3.2/pixi.min.js"></script>
    
    <script>
// ========================================
// AROA - Configuration
// ========================================
const CONFIG = {
    // Phase 1
    GROWTH_THRESHOLD: 15,
    STAGE_THRESHOLD: 2000,
    INITIAL_SIZE: 12,
    MAX_SIZE: 80,
    MAX_FOODS: 40,
    MAX_ENEMIES: 8,
    ENEMY_SPAWN_INTERVAL: 3000,
    DASH_COOLDOWN: 2500,
    DASH_DURATION: 200,
    DASH_SPEED: 18,
    
    // Phase 2
    P2_GRAVITY: 0.6,
    P2_JUMP_FORCE: -14,
    P2_MOVE_SPEED: 5,
    P2_PLATFORM_SPEED: 2,
    P2_STAGE_THRESHOLD: 3000,
    P2_PART_THRESHOLD: 500
};

// í™˜ê²½ ì •ì˜
const ENVIRONMENTS = [
    { id: 'ocean', name: 'ì›ì‹œ í•´ì–‘', icon: 'ğŸŒŠ', range: [1, 16], 
      colors: { bg1: '#001a33', bg2: '#003366', particle: '#00aaff', primary: '#00b4d8', secondary: '#0077b6' },
      desc: 'ë°”ë‹¤ëŠ” ìƒëª…ì˜ ìš”ëŒ.', weak: 'ê±´ì¡°í•¨ì€ ì¹˜ëª…ì .', creatures: ['ğŸ¦ ','ğŸ«§','ğŸ’§','ğŸŒ€'] },
    { id: 'hydrothermal', name: 'ì—´ìˆ˜êµ¬', icon: 'ğŸ”¥', range: [17, 32],
      colors: { bg1: '#1a0a00', bg2: '#4d1a00', particle: '#ff6600', primary: '#ff6b35', secondary: '#d62828' },
      desc: 'ê·¹í•œ í™˜ê²½ì´ ì¼ìƒ.', weak: 'í‰ì˜¨í•¨ì´ ë¶ˆì•ˆ.', creatures: ['ğŸ”´','ğŸŸ ','ğŸ’¥','âš¡'] },
    { id: 'ice', name: 'ì–¼ìŒ ë°”ë‹¤', icon: 'ğŸ§Š', range: [33, 48],
      colors: { bg1: '#0a1a2e', bg2: '#1a3a5e', particle: '#88ddff', primary: '#a8dadc', secondary: '#457b9d' },
      desc: 'íš¨ìœ¨ì˜ ë‹¬ì¸.', weak: 'ëœ¨ê±°ì›€ì€ ì¹˜ëª…ì .', creatures: ['â„ï¸','ğŸ”µ','ğŸ’ ','ğŸ«§'] },
    { id: 'magma', name: 'ë§ˆê·¸ë§ˆ í˜¸ìˆ˜', icon: 'ğŸŒ‹', range: [49, 64],
      colors: { bg1: '#1a0000', bg2: '#4d0000', particle: '#ff3300', primary: '#ff4800', secondary: '#ff8500' },
      desc: 'ìš©ì•”ì´ ë†€ì´í„°.', weak: 'ì–¼ìŒì´ ë¬´ë¤.', creatures: ['ğŸ”¥','ğŸŸ¡','â­','ğŸ’›'] },
    { id: 'atmosphere', name: 'ëŒ€ê¸° ë¶€ìœ ', icon: 'â˜ï¸', range: [65, 80],
      colors: { bg1: '#1a1033', bg2: '#2d1a4d', particle: '#cc88ff', primary: '#e0aaff', secondary: '#9d4edd' },
      desc: 'í•˜ëŠ˜ì„ ë‚˜ëŠ” ì.', weak: 'ë¬´ê±°ì›€ì´ ì .', creatures: ['ğŸ’œ','ğŸŸ£','âœ¨','ğŸ’«'] },
    { id: 'toxic', name: 'ë…ì„± ëŠª', icon: 'ğŸ’€', range: [81, 100],
      colors: { bg1: '#0a1a0a', bg2: '#1a3a1a', particle: '#88ff00', primary: '#70e000', secondary: '#38b000' },
      desc: 'ë…ì´ ê³§ ì•½.', weak: 'ê¹¨ë—í•¨ì´ ë¶ˆí¸.', creatures: ['ğŸŸ¢','ğŸ’š','ğŸ§ª','â˜¢ï¸'] }
];

const getEnvByRoll = roll => ENVIRONMENTS.find(e => roll >= e.range[0] && roll <= e.range[1]);
const getEnvById = id => ENVIRONMENTS.find(e => e.id === id) || ENVIRONMENTS[0];

// íŒŒì¸  ì •ì˜
const BODY_PARTS = {
    // Phase 1
    eye: { icon: 'ğŸ‘ï¸', name: 'ëˆˆ', max: 3, fx: 'ì‹œì•¼ +20%' },
    mouth: { icon: 'ğŸ‘„', name: 'ì…', max: 2, fx: 'ì ìˆ˜ +15%' },
    arm: { icon: 'ğŸ¦¾', name: 'íŒ”', max: 4, fx: 'ìì„ íš¨ê³¼' },
    leg: { icon: 'ğŸ¦¿', name: 'ë‹¤ë¦¬', max: 4, fx: 'ì†ë„ +10%' },
    tail: { icon: 'ğŸ', name: 'ê¼¬ë¦¬', max: 2, fx: 'ëŒ€ì‹œ ì‚¬ìš©' },
    antenna: { icon: 'ğŸ“¡', name: 'ë”ë“¬ì´', max: 2, fx: 'ë²”ìœ„ +15%' },
    // Phase 2
    wing: { icon: 'ğŸª½', name: 'ë‚ ê°œ', max: 2, fx: 'ë”ë¸”ì í”„' },
    shell: { icon: 'ğŸ›¡ï¸', name: 'ê»ì§ˆ', max: 2, fx: 'í”¼í•´ ê°ì†Œ' },
    claw: { icon: 'ğŸ¦€', name: 'ë°œí†±', max: 2, fx: 'ë²½íƒ€ê¸°' },
    lung: { icon: 'ğŸ«', name: 'í—ˆíŒŒ', max: 1, fx: 'ìœ¡ìƒ ì ì‘' }
};

// ë‹¤êµ­ì–´
const TRANSLATIONS = {
    ko: {
        title: 'AROA',
        subtitle: 'A Road Of Adventure',
        startGame: 'ê²Œì„ ì‹œì‘',
        continueGame: 'ì´ì–´í•˜ê¸°',
        settings: 'ì„¤ì •',
        language: 'ì–¸ì–´',
        sound: 'ì‚¬ìš´ë“œ',
        skip: 'ê±´ë„ˆë›°ê¸° â€º',
        next: 'ë‹¤ìŒ',
        intro: [
            { icon: 'ğŸŒŒ', title: 'íƒœì´ˆì—...', text: 'ëì—†ì´ í¼ì³ì§„ <span class="hl">ìš°ì£¼ì˜ ì‹¬ì—°</span>...<br>ì•„ì£¼ ì‘ì€ <span class="gold">ë¶ˆê½ƒ</span>ì´ í”¼ì–´ì˜¤ë¥´ë ¤ í•œë‹¤.' },
            { icon: 'âœ¨', title: 'ì˜ì‹ì˜ íƒ„ìƒ', text: 'ë‹¹ì‹ ì€ ì•„ì§ <span class="hl">ì•„ë¬´ê²ƒë„ ì•„ë‹ˆë‹¤</span>.<br>ì˜¤ì§ <span class="gold">ì¡´ì¬í•˜ê³ ì í•˜ëŠ” ì˜ì§€</span>ë§Œì´ ê¹œë¹¡ì¸ë‹¤.' }
        ],
        dice: { title: 'ğŸ² ì¶œìƒì§€ ê²°ì •', desc: 'ì£¼ì‚¬ìœ„ê°€ ë‹¹ì‹ ì˜ ì¶œìƒì§€ë¥¼ ê²°ì •í•©ë‹ˆë‹¤', roll: 'ì£¼ì‚¬ìœ„ ë˜ì§€ê¸°', rolling: 'ê²°ì • ì¤‘...', accept: 'ì´ í™˜ê²½ì—ì„œ íƒœì–´ë‚˜ê¸°' },
        afterBirth: env => [
            { icon: env.icon, title: env.name, text: `<span class="hl">${env.name}</span>ì—ì„œ íƒœì–´ë‚¬ë‹¤.<br><br><span class="gold">"${env.desc}"</span><br><span class="danger">âš ï¸ ${env.weak}</span>` },
            { icon: 'ğŸ¦ ', title: 'ì²« ë²ˆì§¸ ìƒëª…', text: 'ì•„ì£¼ ì‘ì€ <span class="hl">í•˜ë‚˜ì˜ ì„¸í¬</span>.<br>ì‚´ì•„ë‚¨ìœ¼ë ¤ë©´ <span class="gold">ë¨¹ì–´ì•¼ í•œë‹¤</span>.' },
            { icon: 'âš”ï¸', title: 'ìƒì¡´ì˜ ì‹œì‘', text: '<span class="danger">ë” í° ì¡´ì¬</span>ë“¤ì´ ë‹¹ì‹ ì„ ë…¸ë¦°ë‹¤.<br><span class="hl">ì‘ì€ ê²ƒ</span>ì„ ë¨¹ê³  <span class="gold">ì„±ì¥</span>í•˜ë¼.' }
        ],
        start: 'ëª¨í—˜ ì‹œì‘í•˜ê¸°',
        gameover: 'ì¡ì•„ë¨¹í˜”ë‹¤!',
        gameoverDesc: 'ë” í° ì¡´ì¬ì—ê²Œ í¬ì‹ë‹¹í–ˆìŠµë‹ˆë‹¤.',
        retry: 'ë‹¤ì‹œ íƒœì–´ë‚˜ê¸°',
        home: 'í™ˆìœ¼ë¡œ',
        clear: 'ë‹¤ì„¸í¬ ì§„í™”!',
        clearDesc: 'ë‹¨ì¼ ì„¸í¬ì˜ í•œê³„ë¥¼ ë„˜ì–´ì„°ìŠµë‹ˆë‹¤!',
        nextPhase: 'Phase 2ë¡œ!',
        // Phase 2
        p2Intro: [
            { icon: 'ğŸ”ï¸', title: 'ìœ¡ì§€ë¡œ!', text: 'ë°”ë‹¤ì˜ í•œê³„ë¥¼ ë„˜ì–´<br><span class="hl">ê´‘í™œí•œ ìœ¡ì§€</span>ê°€ í¼ì³ì§„ë‹¤.' },
            { icon: 'ğŸ¦', title: 'ìƒˆë¡œìš´ ë„ì „', text: '<span class="danger">ì¤‘ë ¥</span>ì´ë¼ëŠ” ìƒˆë¡œìš´ ì !<br><span class="gold">ì í”„</span>í•˜ê³  <span class="hl">ì˜¬ë¼ê°€ë¼</span>.' }
        ],
        p2DiceTitle: 'ì í”„ë ¥ ê²°ì •',
        p2DiceDesc: 'ì£¼ì‚¬ìœ„ê°€ ë‹¹ì‹ ì˜ ì í”„ë ¥ì„ ê²°ì •í•©ë‹ˆë‹¤',
        p2Go: 'ë“±ë°˜ ì‹œì‘!',
        p2Start: 'ë“±ë°˜ ì‹œì‘!',
        p2Gameover: 'ì¶”ë½í–ˆë‹¤!',
        p2GameoverDesc: 'ë„ˆë¬´ ì•„ë˜ë¡œ ë–¨ì–´ì¡ŒìŠµë‹ˆë‹¤.',
        p2Clear: 'ìœ¡ì§€ ë„ë‹¬!',
        p2ClearDesc: 'ë“œë””ì–´ ìœ¡ì§€ì— ë„ì°©í–ˆìŠµë‹ˆë‹¤!',
        p2Retry: 'ë‹¤ì‹œ ì‹œì‘',
        p2Restart: 'ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
        goal: 'ëª©í‘œ',
        // ê³µí†µ UI
        height: 'ë†’ì´',
        score: 'ì ìˆ˜',
        parts: 'ì‹ ì²´ íŒŒì¸ ',
        stage2: 'Stage 2: ë„ë§ˆë±€',
        sky: 'í•˜ëŠ˜',
        maxHeight: 'ìµœëŒ€ ë†’ì´',
        none: 'ì—†ìŒ',
        acquired: 'íšë“!',
        confirmHome: 'í™ˆìœ¼ë¡œ ëŒì•„ê°€ì‹œê² ìŠµë‹ˆê¹Œ?'
    },
    en: {
        title: 'AROA',
        subtitle: 'A Road Of Adventure',
        startGame: 'Start Game',
        continueGame: 'Continue',
        settings: 'Settings',
        language: 'Language',
        sound: 'Sound',
        skip: 'Skip â€º',
        next: 'Next',
        intro: [
            { icon: 'ğŸŒŒ', title: 'In the beginning...', text: 'The endless <span class="hl">cosmic abyss</span>...<br>A tiny <span class="gold">spark</span> is about to ignite.' },
            { icon: 'âœ¨', title: 'Birth of Consciousness', text: 'You are <span class="hl">nothing yet</span>.<br>Only the <span class="gold">will to exist</span> flickers.' }
        ],
        dice: { title: 'ğŸ² Birthplace', desc: 'The dice determines where you are born', roll: 'Roll the Dice', rolling: 'Rolling...', accept: 'Accept this fate' },
        afterBirth: env => [
            { icon: env.icon, title: env.name, text: `Born in <span class="hl">${env.name}</span>.<br><br><span class="gold">"${env.desc}"</span><br><span class="danger">âš ï¸ ${env.weak}</span>` },
            { icon: 'ğŸ¦ ', title: 'First Life', text: 'A tiny <span class="hl">single cell</span>.<br>To survive, you must <span class="gold">eat</span>.' },
            { icon: 'âš”ï¸', title: 'Survival Begins', text: '<span class="danger">Bigger creatures</span> hunt you.<br>Eat <span class="hl">smaller ones</span> and <span class="gold">grow</span>.' }
        ],
        start: 'Start Adventure',
        gameover: 'Eaten!',
        gameoverDesc: 'You were consumed by a larger creature.',
        retry: 'Be Reborn',
        home: 'Home',
        clear: 'Multicellular Evolution!',
        clearDesc: 'You have transcended the limits of a single cell!',
        nextPhase: 'To Phase 2!',
        p2Intro: [
            { icon: 'ğŸ”ï¸', title: 'To Land!', text: 'Beyond the sea,<br><span class="hl">vast land</span> awaits.' },
            { icon: 'ğŸ¦', title: 'New Challenge', text: '<span class="danger">Gravity</span> is the new enemy!<br><span class="gold">Jump</span> and <span class="hl">climb</span>.' }
        ],
        p2DiceTitle: 'Jump Power',
        p2DiceDesc: 'The dice determines your jump power',
        p2Go: 'Start Climbing!',
        p2Start: 'Start Climbing!',
        p2Gameover: 'Fell!',
        p2GameoverDesc: 'You fell too far down.',
        p2Clear: 'Land Reached!',
        p2ClearDesc: 'You finally reached the land!',
        p2Retry: 'Retry',
        p2Restart: 'Restart from beginning?',
        goal: 'Goal',
        // Common UI
        height: 'Height',
        score: 'Score',
        parts: 'Body Parts',
        stage2: 'Stage 2: Lizard',
        sky: 'Sky',
        maxHeight: 'Max Height',
        none: 'None',
        acquired: 'Acquired!',
        confirmHome: 'Return to home?'
    },
    ja: {
        title: 'AROA',
        subtitle: 'A Road Of Adventure',
        startGame: 'ã‚²ãƒ¼ãƒ é–‹å§‹',
        continueGame: 'ç¶šãã‹ã‚‰',
        settings: 'è¨­å®š',
        language: 'è¨€èª',
        sound: 'ã‚µã‚¦ãƒ³ãƒ‰',
        skip: 'ã‚¹ã‚­ãƒƒãƒ— â€º',
        next: 'æ¬¡ã¸',
        intro: [
            { icon: 'ğŸŒŒ', title: 'å¤ªåˆã«...', text: 'æœã¦ã—ãªãåºƒãŒã‚‹<span class="hl">å®‡å®™ã®æ·±æ·µ</span>...<br>å°ã•ãª<span class="gold">ç«èŠ±</span>ãŒç¯ã‚ã†ã¨ã—ã¦ã„ã‚‹ã€‚' },
            { icon: 'âœ¨', title: 'æ„è­˜ã®èª•ç”Ÿ', text: 'ã‚ãªãŸã¯ã¾ã <span class="hl">ä½•è€…ã§ã‚‚ãªã„</span>ã€‚<br>ãŸã <span class="gold">å­˜åœ¨ã—ã‚ˆã†ã¨ã™ã‚‹æ„å¿—</span>ã ã‘ãŒç¬ã„ã¦ã„ã‚‹ã€‚' }
        ],
        dice: { title: 'ğŸ² å‡ºç”Ÿåœ°æ±ºå®š', desc: 'ã‚µã‚¤ã‚³ãƒ­ãŒã‚ãªãŸã®å‡ºç”Ÿåœ°ã‚’æ±ºã‚ã¾ã™', roll: 'ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã‚‹', rolling: 'æ±ºå®šä¸­...', accept: 'ã“ã®ç’°å¢ƒã§ç”Ÿã¾ã‚Œã‚‹' },
        afterBirth: env => [
            { icon: env.icon, title: env.name, text: `<span class="hl">${env.name}</span>ã§ç”Ÿã¾ã‚ŒãŸã€‚<br><br><span class="gold">"${env.desc}"</span><br><span class="danger">âš ï¸ ${env.weak}</span>` },
            { icon: 'ğŸ¦ ', title: 'æœ€åˆã®ç”Ÿå‘½', text: 'ã¨ã¦ã‚‚å°ã•ãª<span class="hl">ä¸€ã¤ã®ç´°èƒ</span>ã€‚<br>ç”Ÿãæ®‹ã‚‹ã«ã¯<span class="gold">é£Ÿã¹ãªã‘ã‚Œã°</span>ãªã‚‰ãªã„ã€‚' },
            { icon: 'âš”ï¸', title: 'ç”Ÿå­˜ã®å§‹ã¾ã‚Š', text: '<span class="danger">å¤§ããªå­˜åœ¨</span>ãŒã‚ãªãŸã‚’ç‹™ã£ã¦ã„ã‚‹ã€‚<br><span class="hl">å°ã•ã„ã‚‚ã®</span>ã‚’é£Ÿã¹ã¦<span class="gold">æˆé•·</span>ã—ã‚ˆã†ã€‚' }
        ],
        start: 'å†’é™ºã‚’å§‹ã‚ã‚‹',
        gameover: 'é£Ÿã¹ã‚‰ã‚ŒãŸï¼',
        gameoverDesc: 'ã‚ˆã‚Šå¤§ããªå­˜åœ¨ã«æ•é£Ÿã•ã‚Œã¾ã—ãŸã€‚',
        retry: 'ãƒªãƒˆãƒ©ã‚¤',
        home: 'ãƒ›ãƒ¼ãƒ ',
        clear: 'å¤šç´°èƒé€²åŒ–ï¼',
        clearDesc: 'å˜ç´°èƒã®é™ç•Œã‚’è¶…ãˆã¾ã—ãŸï¼',
        nextPhase: 'Phase 2ã¸ï¼',
        p2Intro: [
            { icon: 'ğŸ”ï¸', title: 'é™¸ã¸ï¼', text: 'æµ·ã‚’è¶…ãˆã¦<br><span class="hl">åºƒå¤§ãªé™¸åœ°</span>ãŒå¾…ã£ã¦ã„ã‚‹ã€‚' },
            { icon: 'ğŸ¦', title: 'æ–°ãŸãªæŒ‘æˆ¦', text: '<span class="danger">é‡åŠ›</span>ã¨ã„ã†æ–°ãŸãªæ•µï¼<br><span class="gold">ã‚¸ãƒ£ãƒ³ãƒ—</span>ã—ã¦<span class="hl">ç™»ã‚Œ</span>ã€‚' }
        ],
        p2Start: 'ç™»æ”€é–‹å§‹ï¼',
        p2Gameover: 'è½ä¸‹ï¼',
        p2GameoverDesc: 'è½ã¡ã™ãã¾ã—ãŸã€‚',
        p2Clear: 'ç©ºã¸ï¼',
        p2ClearDesc: 'é™¸åœ°ã‚’å¾æœã—ã¾ã—ãŸï¼',
        // å…±é€šUI
        height: 'é«˜ã•',
        score: 'ã‚¹ã‚³ã‚¢',
        parts: 'ä½“ãƒ‘ãƒ¼ãƒ„',
        stage2: 'Stage 2: ãƒˆã‚«ã‚²',
        sky: 'ç©º',
        maxHeight: 'æœ€å¤§é«˜ã•',
        none: 'ãªã—',
        acquired: 'ç²å¾—ï¼',
        confirmHome: 'ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ'
    },
    zh: {
        title: 'AROA',
        subtitle: 'A Road Of Adventure',
        startGame: 'å¼€å§‹æ¸¸æˆ',
        continueGame: 'ç»§ç»­',
        settings: 'è®¾ç½®',
        language: 'è¯­è¨€',
        sound: 'å£°éŸ³',
        skip: 'è·³è¿‡ â€º',
        next: 'ä¸‹ä¸€æ­¥',
        intro: [
            { icon: 'ğŸŒŒ', title: 'å¤ªåˆ...', text: 'æ— å°½çš„<span class="hl">å®‡å®™æ·±æ¸Š</span>...<br>ä¸€ä¸ªå¾®å°çš„<span class="gold">ç«èŠ±</span>å³å°†ç‚¹ç‡ƒã€‚' },
            { icon: 'âœ¨', title: 'æ„è¯†è¯ç”Ÿ', text: 'ä½ è¿˜<span class="hl">ä»€ä¹ˆéƒ½ä¸æ˜¯</span>ã€‚<br>åªæœ‰<span class="gold">å­˜åœ¨çš„æ„å¿—</span>åœ¨é—ªçƒã€‚' }
        ],
        dice: { title: 'ğŸ² å‡ºç”Ÿåœ°å†³å®š', desc: 'éª°å­å†³å®šä½ çš„å‡ºç”Ÿåœ°', roll: 'æ·éª°å­', rolling: 'å†³å®šä¸­...', accept: 'æ¥å—è¿™ä¸ªå‘½è¿' },
        afterBirth: env => [
            { icon: env.icon, title: env.name, text: `åœ¨<span class="hl">${env.name}</span>å‡ºç”Ÿäº†ã€‚<br><br><span class="gold">"${env.desc}"</span><br><span class="danger">âš ï¸ ${env.weak}</span>` },
            { icon: 'ğŸ¦ ', title: 'ç¬¬ä¸€ä¸ªç”Ÿå‘½', text: 'ä¸€ä¸ªå¾®å°çš„<span class="hl">å•ç»†èƒ</span>ã€‚<br>è¦ç”Ÿå­˜ï¼Œå°±å¿…é¡»<span class="gold">è¿›é£Ÿ</span>ã€‚' },
            { icon: 'âš”ï¸', title: 'ç”Ÿå­˜å¼€å§‹', text: '<span class="danger">æ›´å¤§çš„å­˜åœ¨</span>åœ¨çŒé£Ÿä½ ã€‚<br>åƒæ‰<span class="hl">å°çš„</span>ï¼Œç„¶å<span class="gold">æˆé•¿</span>ã€‚' }
        ],
        start: 'å¼€å§‹å†’é™©',
        gameover: 'è¢«åƒæ‰äº†ï¼',
        gameoverDesc: 'è¢«æ›´å¤§çš„å­˜åœ¨åå™¬äº†ã€‚',
        retry: 'é‡è¯•',
        home: 'ä¸»é¡µ',
        clear: 'å¤šç»†èƒè¿›åŒ–ï¼',
        clearDesc: 'è¶…è¶Šäº†å•ç»†èƒçš„æé™ï¼',
        nextPhase: 'å‰å¾€Phase 2ï¼',
        p2Intro: [
            { icon: 'ğŸ”ï¸', title: 'å‘é™†åœ°ï¼', text: 'è¶…è¶Šå¤§æµ·<br><span class="hl">å¹¿é˜”çš„é™†åœ°</span>åœ¨ç­‰å¾…ã€‚' },
            { icon: 'ğŸ¦', title: 'æ–°æŒ‘æˆ˜', text: '<span class="danger">é‡åŠ›</span>æ˜¯æ–°çš„æ•Œäººï¼<br><span class="gold">è·³è·ƒ</span>å¹¶<span class="hl">æ”€ç™»</span>ã€‚' }
        ],
        p2Start: 'å¼€å§‹æ”€ç™»ï¼',
        p2Gameover: 'å è½ï¼',
        p2GameoverDesc: 'æ‰å¾—å¤ªæ·±äº†ã€‚',
        p2Clear: 'å‘å¤©ç©ºï¼',
        p2ClearDesc: 'å¾æœäº†é™†åœ°ï¼',
        // é€šç”¨UI
        height: 'é«˜åº¦',
        score: 'åˆ†æ•°',
        parts: 'èº«ä½“éƒ¨ä»¶',
        stage2: 'Stage 2: èœ¥èœ´',
        sky: 'å¤©ç©º',
        maxHeight: 'æœ€å¤§é«˜åº¦',
        none: 'æ— ',
        acquired: 'è·å¾—ï¼',
        confirmHome: 'è¿”å›ä¸»é¡µï¼Ÿ'
    }
};

// ========================================
// Game State
// ========================================
const GameState = {
    currentLang: localStorage.getItem('aroa-lang') || 'ko',
    soundOn: localStorage.getItem('aroa-sound') !== 'false',
    prologueDone: localStorage.getItem('aroa-prologue-done') === 'true',
    envId: localStorage.getItem('aroa-env') || null,
    phase1Clear: localStorage.getItem('aroa-phase1-clear') === 'true',
    phase2Clear: localStorage.getItem('aroa-phase2-clear') === 'true',
    currentPhase: 1,
    score: 0,
    eaten: 0,
    maxSize: CONFIG.INITIAL_SIZE,
    parts: { eye: 0, mouth: 0, arm: 0, leg: 0, tail: 0, antenna: 0, wing: 0, shell: 0, claw: 0, lung: 0 },
    // Phase 2 ì „ìš© ìƒíƒœ
    height: 0,
    maxHeight: 0,
    
    save() {
        localStorage.setItem('aroa-lang', this.currentLang);
        localStorage.setItem('aroa-sound', this.soundOn);
        localStorage.setItem('aroa-prologue-done', this.prologueDone);
        if (this.envId) localStorage.setItem('aroa-env', this.envId);
        localStorage.setItem('aroa-phase1-clear', this.phase1Clear);
        localStorage.setItem('aroa-phase2-clear', this.phase2Clear);
        localStorage.setItem('aroa-parts', JSON.stringify(this.parts));
    },
    
    load() {
        const savedParts = localStorage.getItem('aroa-parts');
        if (savedParts) {
            try {
                const parsed = JSON.parse(savedParts);
                Object.assign(this.parts, parsed);
            } catch(e) {}
        }
    },
    
    reset() {
        this.score = 0;
        this.eaten = 0;
        this.maxSize = CONFIG.INITIAL_SIZE;
    },
    
    resetP2() {
        this.score = 0;
        this.height = 0;
        this.maxHeight = 0;
    },
    
    resetParts() {
        this.parts = { eye: 0, mouth: 0, arm: 0, leg: 0, tail: 0, antenna: 0, wing: 0, shell: 0, claw: 0, lung: 0 };
    },
    
    t(key) {
        return TRANSLATIONS[this.currentLang]?.[key] || TRANSLATIONS.ko[key] || key;
    }
};

// ========================================
// PixiJS App
// ========================================
let pixiApp = null;
let gameLoop = null;

function initPixi(bgColor = 0x020010) {
    if (pixiApp) {
        pixiApp.destroy(true);
    }
    
    pixiApp = new PIXI.Application({
        width: window.innerWidth,
        height: window.innerHeight,
        backgroundColor: bgColor,
        resolution: Math.min(window.devicePixelRatio || 1, 2),
        autoDensity: true
    });
    
    document.getElementById('game-container').innerHTML = '';
    document.getElementById('game-container').appendChild(pixiApp.view);
    
    window.addEventListener('resize', () => {
        if (pixiApp) pixiApp.renderer.resize(window.innerWidth, window.innerHeight);
    });
    
    return pixiApp;
}

function createStarBackground(envColors = null) {
    if (!pixiApp) return;
    
    const colors = envColors ? [
        parseInt(envColors.bg1.replace('#', '0x')),
        parseInt(envColors.bg2.replace('#', '0x'))
    ] : [0x1a0030, 0x000830, 0x100020, 0x001040, 0x200040, 0x0a0025];
    
    // Nebula (ë” ë§ì´, ë” í™”ë ¤í•˜ê²Œ)
    for (let i = 0; i < 8; i++) {
        const nebula = new PIXI.Graphics();
        const color = colors[i % colors.length];
        nebula.beginFill(color, 0.4);
        nebula.drawCircle(0, 0, 100 + Math.random() * 200);
        nebula.endFill();
        nebula.x = Math.random() * pixiApp.screen.width;
        nebula.y = Math.random() * pixiApp.screen.height;
        nebula.filters = [new PIXI.BlurFilter(50)];
        pixiApp.stage.addChild(nebula);
    }
    
    // Stars (ë” ë§ì´, ë‹¤ì–‘í•œ ìƒ‰ìƒ, ë°˜ì§ì„ íš¨ê³¼)
    const starColors = envColors ? 
        [parseInt(envColors.particle.replace('#', '0x'))] : 
        [0xffffff, 0xfff8dc, 0xadd8e6, 0xffb6c1, 0xe6e6fa, 0xffd700];
    
    const stars = [];
    for (let i = 0; i < 200; i++) {
        const star = new PIXI.Graphics();
        const size = Math.random() * 2 + 0.5;
        const color = starColors[Math.floor(Math.random() * starColors.length)];
        const isBright = Math.random() > 0.85;
        
        // ë°ì€ ë³„ì€ ê¸€ë¡œìš° íš¨ê³¼
        if (isBright) {
            star.beginFill(color, 0.2);
            star.drawCircle(0, 0, size * 4);
            star.endFill();
            star.beginFill(color, 0.4);
            star.drawCircle(0, 0, size * 2);
            star.endFill();
        }
        
        star.beginFill(color, 1);
        star.drawCircle(0, 0, size);
        star.endFill();
        
        star.x = Math.random() * pixiApp.screen.width;
        star.y = Math.random() * pixiApp.screen.height;
        star.baseAlpha = 0.3 + Math.random() * 0.7;
        star.alpha = star.baseAlpha;
        star.twinkleSpeed = 1.5 + Math.random() * 3;
        star.twinkleOffset = Math.random() * Math.PI * 2;
        star.isBright = isBright;
        
        pixiApp.stage.addChild(star);
        stars.push(star);
    }
    
    // ë³„ ë°˜ì§ì„ ì• ë‹ˆë©”ì´ì…˜
    let time = 0;
    const twinkleLoop = (delta) => {
        time += delta * 0.02;
        stars.forEach(star => {
            const twinkle = Math.sin(time * star.twinkleSpeed + star.twinkleOffset);
            star.alpha = star.baseAlpha + twinkle * 0.4;
            if (star.isBright) {
                star.scale.set(1 + twinkle * 0.2);
            }
        });
    };
    pixiApp.ticker.add(twinkleLoop);
    
    // ìœ ì„± ìƒì„± í•¨ìˆ˜
    function createShootingStar() {
        const shootingStar = new PIXI.Graphics();
        
        // ìœ ì„± ê¼¬ë¦¬
        for (let i = 0; i < 20; i++) {
            const alpha = 1 - (i / 20);
            shootingStar.beginFill(0xffffff, alpha * 0.6);
            shootingStar.drawCircle(-i * 3, i * 1.2, 2.5 - i * 0.1);
            shootingStar.endFill();
        }
        
        // ìœ ì„± ë¨¸ë¦¬
        shootingStar.beginFill(0xffffff, 1);
        shootingStar.drawCircle(0, 0, 3);
        shootingStar.endFill();
        
        shootingStar.x = Math.random() * pixiApp.screen.width * 0.6;
        shootingStar.y = -30;
        shootingStar.rotation = Math.PI / 4;
        
        pixiApp.stage.addChild(shootingStar);
        
        const speed = 6 + Math.random() * 4;
        const animate = () => {
            shootingStar.x += speed;
            shootingStar.y += speed * 0.4;
            shootingStar.alpha -= 0.01;
            
            if (shootingStar.y > pixiApp.screen.height || shootingStar.alpha <= 0) {
                pixiApp.stage.removeChild(shootingStar);
                pixiApp.ticker.remove(animate);
            }
        };
        pixiApp.ticker.add(animate);
    }
    
    // ìœ ì„± ì£¼ê¸°ì  ìƒì„±
    setInterval(() => {
        if (Math.random() > 0.6) createShootingStar();
    }, 2000);
}

// ========================================
// UI Helpers
// ========================================
const app = document.getElementById('app');

function showEvolution(icon, title, desc, fx) {
    const popup = document.getElementById('evo-popup');
    document.getElementById('evo-icon').textContent = icon;
    document.getElementById('evo-title').textContent = title;
    document.getElementById('evo-desc').textContent = desc;
    document.getElementById('evo-fx').textContent = 'âœ¨ ' + fx;
    popup.classList.add('show');
    setTimeout(() => popup.classList.remove('show'), 2000);
}

// ========================================
// Title Screen
// ========================================
function showTitle() {
    initPixi();
    createStarBackground();
    
    const t = GameState.t.bind(GameState);
    const lang = GameState.currentLang;
    
    // ë‹¤êµ­ì–´ í…ìŠ¤íŠ¸
    const titleTexts = {
        ko: {
            google: 'Googleë¡œ ì‹œì‘í•˜ê¸°',
            guest: 'ê²ŒìŠ¤íŠ¸ë¡œ ì‹œì‘í•˜ê¸°',
            langName: 'í•œêµ­ì–´',
            guestTitle: 'ì ê¹!',
            guestText: 'ê²ŒìŠ¤íŠ¸ ëª¨ë“œëŠ” <strong>ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</strong><br><br>ì•±ì„ ì¢…ë£Œí•˜ë©´ ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘í•´ì•¼ í•´ìš”.<br><br>ê°€ëŠ¥í•˜ë©´ <strong>Google ë¡œê·¸ì¸</strong>ì„ ì¶”ì²œë“œë ¤ìš”! ğŸ™',
            guestToGoogle: 'ğŸ”µ Googleë¡œ ì‹œì‘í•˜ê¸°',
            guestContinue: 'ê·¸ë˜ë„ ê²ŒìŠ¤íŠ¸ë¡œ ì‹œì‘',
            close: 'ë‹«ê¸°'
        },
        en: {
            google: 'Continue with Google',
            guest: 'Continue as Guest',
            langName: 'English',
            guestTitle: 'Wait!',
            guestText: 'Guest mode <strong>does not save progress.</strong><br><br>If you close the app, you\'ll have to start over.<br><br>We recommend <strong>Google login</strong> if possible! ğŸ™',
            guestToGoogle: 'ğŸ”µ Continue with Google',
            guestContinue: 'Continue as Guest anyway',
            close: 'Close'
        }
    };
    const txt = titleTexts[lang] || titleTexts.ko;
    
    app.innerHTML = `
        <div class="title-screen">
            <!-- ë¡œê³  -->
            <div class="logo-section">
                <div class="logo-icon">ğŸš€</div>
                <h1 class="logo-title">AROA</h1>
                <p class="logo-subtitle">A Road Of Adventure</p>
            </div>
            
            <!-- ë¡œê·¸ì¸ ë²„íŠ¼ -->
            <div class="button-section">
                <button class="login-btn btn-google" id="btn-google">
                    <svg class="google-icon" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    <span>${txt.google}</span>
                </button>
                
                <button class="login-btn btn-guest" id="btn-guest">
                    <span>ğŸ‘¤</span>
                    <span>${txt.guest}</span>
                </button>
            </div>
            
            <!-- í•˜ë‹¨ ì„¤ì • -->
            <div class="settings-section">
                <button class="setting-btn" id="btn-language">
                    <span class="icon">ğŸŒ</span>
                    <span>${txt.langName}</span>
                </button>
                <button class="setting-btn" id="btn-sound">
                    <span class="icon">${GameState.soundOn ? 'ğŸ”Š' : 'ğŸ”‡'}</span>
                    <span>${GameState.soundOn ? 'ON' : 'OFF'}</span>
                </button>
            </div>
            
            <!-- ë²„ì „ -->
            <div class="version-info">v1.0.0 | Â© 2025 BOKLUCK</div>
        </div>
        
        <!-- ê²ŒìŠ¤íŠ¸ ê²½ê³  ëª¨ë‹¬ -->
        <div class="guest-modal-overlay" id="guest-modal">
            <div class="guest-modal-content">
                <div class="warning-icon">âš ï¸</div>
                <h2 class="warning-title">${txt.guestTitle}</h2>
                <p class="warning-text">${txt.guestText}</p>
                <div class="warning-buttons">
                    <button class="warning-btn btn-recommend" id="guest-to-google">${txt.guestToGoogle}</button>
                    <button class="warning-btn btn-continue" id="guest-continue">${txt.guestContinue}</button>
                </div>
            </div>
        </div>
        
        <!-- ì–¸ì–´ ì„ íƒ ëª¨ë‹¬ -->
        <div class="lang-modal-overlay" id="lang-modal">
            <div class="lang-modal-content">
                <h2 class="lang-modal-title">ğŸŒ Language</h2>
                <div class="language-list">
                    <button class="language-btn ${lang === 'ko' ? 'active' : ''}" data-lang="ko">
                        <span class="flag">ğŸ‡°ğŸ‡·</span>
                        <span>í•œêµ­ì–´</span>
                    </button>
                    <button class="language-btn ${lang === 'en' ? 'active' : ''}" data-lang="en">
                        <span class="flag">ğŸ‡ºğŸ‡¸</span>
                        <span>English</span>
                    </button>
                </div>
                <button class="lang-modal-close" id="lang-modal-close">${txt.close}</button>
            </div>
        </div>
    `;
    
    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    document.getElementById('btn-google').onclick = () => {
        alert('Google ë¡œê·¸ì¸ (Firebase ì—°ë™ ì˜ˆì •)');
    };
    
    document.getElementById('btn-guest').onclick = () => {
        document.getElementById('guest-modal').classList.add('show');
    };
    
    document.getElementById('guest-to-google').onclick = () => {
        document.getElementById('guest-modal').classList.remove('show');
        alert('Google ë¡œê·¸ì¸ (Firebase ì—°ë™ ì˜ˆì •)');
    };
    
    document.getElementById('guest-continue').onclick = () => {
        document.getElementById('guest-modal').classList.remove('show');
        // ê²ŒìŠ¤íŠ¸ë¡œ ì‹œì‘ - í”„ë¡¤ë¡œê·¸ë¡œ ì´ë™
        GameState.prologueDone = false;
        GameState.envId = null;
        GameState.phase1Clear = false;
        GameState.phase2Clear = false;
        GameState.reset();
        GameState.save();
        showPrologueIntro();
    };
    
    document.getElementById('guest-modal').onclick = (e) => {
        if (e.target.id === 'guest-modal') {
            document.getElementById('guest-modal').classList.remove('show');
        }
    };
    
    document.getElementById('btn-language').onclick = () => {
        document.getElementById('lang-modal').classList.add('show');
    };
    
    document.getElementById('lang-modal-close').onclick = () => {
        document.getElementById('lang-modal').classList.remove('show');
    };
    
    document.getElementById('lang-modal').onclick = (e) => {
        if (e.target.id === 'lang-modal') {
            document.getElementById('lang-modal').classList.remove('show');
        }
    };
    
    document.querySelectorAll('.language-btn').forEach(btn => {
        btn.onclick = () => {
            GameState.currentLang = btn.dataset.lang;
            GameState.save();
            document.getElementById('lang-modal').classList.remove('show');
            showTitle(); // í™”ë©´ ìƒˆë¡œê³ ì¹¨
        };
    });
    
    document.getElementById('btn-sound').onclick = () => {
        GameState.soundOn = !GameState.soundOn;
        GameState.save();
        showTitle(); // í™”ë©´ ìƒˆë¡œê³ ì¹¨
    };
}

// ========================================
// Settings
// ========================================
function showSettings() {
    const t = GameState.t.bind(GameState);
    
    app.innerHTML = `
        <div class="page-center">
            <div class="page-content" style="max-width: 340px;">
                <h2 class="page-title">âš™ï¸ ${t('settings')}</h2>
                
                <div style="background: var(--bg-surface); border-radius: 12px; padding: 16px; margin-bottom: 20px; text-align: left;">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <span>ğŸŒ ${t('language')}</span>
                        <button class="btn btn-sm btn-ghost" id="btn-lang">${GameState.currentLang.toUpperCase()}</button>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0;">
                        <span>ğŸ”Š ${t('sound')}</span>
                        <button class="btn btn-sm btn-ghost" id="btn-sound">${GameState.soundOn ? 'ON' : 'OFF'}</button>
                    </div>
                </div>
                
                <button class="btn btn-primary btn-block" id="btn-back">â† Back</button>
            </div>
        </div>
    `;
    
    document.getElementById('btn-lang').onclick = showLanguageModal;
    document.getElementById('btn-sound').onclick = () => {
        GameState.soundOn = !GameState.soundOn;
        GameState.save();
        showSettings();
    };
    document.getElementById('btn-back').onclick = showTitle;
}

function showLanguageModal() {
    const modal = document.createElement('div');
    modal.className = 'lang-modal show';
    modal.innerHTML = `
        <div class="modal-box">
            <h2 class="page-title">ğŸŒ Language</h2>
            <div class="lang-options">
                <button class="lang-btn ${GameState.currentLang === 'ko' ? 'active' : ''}" data-lang="ko">ğŸ‡°ğŸ‡· í•œêµ­ì–´</button>
                <button class="lang-btn ${GameState.currentLang === 'en' ? 'active' : ''}" data-lang="en">ğŸ‡ºğŸ‡¸ English</button>
                <button class="lang-btn ${GameState.currentLang === 'ja' ? 'active' : ''}" data-lang="ja">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</button>
                <button class="lang-btn ${GameState.currentLang === 'zh' ? 'active' : ''}" data-lang="zh">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    
    modal.querySelectorAll('.lang-btn').forEach(btn => {
        btn.onclick = () => {
            GameState.currentLang = btn.dataset.lang;
            GameState.save();
            modal.remove();
            showSettings();
        };
    });
    
    modal.onclick = e => { if (e.target === modal) modal.remove(); };
}

// ========================================
// Prologue - Intro Story
// ========================================
function showPrologueIntro() {
    initPixi();
    createStarBackground();
    
    const t = GameState.t.bind(GameState);
    const intro = TRANSLATIONS[GameState.currentLang].intro;
    let idx = 0;
    
    function render() {
        const s = intro[idx];
        const isLast = idx === intro.length - 1;
        
        app.innerHTML = `
            <button class="skip-btn" id="skip-btn">${t('skip')}</button>
            <div class="page-center">
                <div class="page-content">
                    <div class="page-icon">${s.icon}</div>
                    <h2 class="page-title">${s.title}</h2>
                    <p class="page-text">${s.text}</p>
                    <div class="dots">
                        ${intro.map((_, i) => `<div class="dot ${i < idx ? 'done' : ''} ${i === idx ? 'active' : ''}"></div>`).join('')}
                    </div>
                    <button class="btn btn-primary btn-block" id="btn-next">${isLast ? 'ğŸ² ' + TRANSLATIONS[GameState.currentLang].dice.title : t('next')}</button>
                </div>
            </div>
        `;
        
        document.getElementById('btn-next').onclick = () => {
            if (isLast) showDice();
            else { idx++; render(); }
        };
        document.getElementById('skip-btn').onclick = () => {
            const roll = Math.floor(Math.random() * 100) + 1;
            const env = getEnvByRoll(roll);
            GameState.envId = env.id;
            GameState.prologueDone = true;
            GameState.save();
            startPhase1();
        };
    }
    
    render();
}

// ========================================
// Prologue - Dice
// ========================================
function showDice() {
    const t = GameState.t.bind(GameState);
    const dice = TRANSLATIONS[GameState.currentLang].dice;
    
    app.innerHTML = `
        <div class="page-center">
            <div class="page-content">
                <h2 class="page-title">${dice.title}</h2>
                <p class="page-text">${dice.desc}</p>
                
                <div class="env-ranges">
                    ${ENVIRONMENTS.map(e => `<div class="env-range"><span>${e.icon}</span><span>${e.range[0]}-${e.range[1]}</span></div>`).join('')}
                </div>
                
                <div class="dice-box" id="dice">ğŸ²</div>
                <div class="dice-result" id="result"></div>
                <button class="btn btn-primary btn-block" id="btn-roll">${dice.roll}</button>
            </div>
        </div>
    `;
    
    const diceEl = document.getElementById('dice');
    const resultEl = document.getElementById('result');
    const btn = document.getElementById('btn-roll');
    
    btn.onclick = () => {
        btn.disabled = true;
        btn.textContent = dice.rolling;
        diceEl.classList.add('rolling');
        
        const anim = setInterval(() => {
            diceEl.textContent = Math.floor(Math.random() * 100) + 1;
        }, 50);
        
        setTimeout(() => {
            clearInterval(anim);
            diceEl.classList.remove('rolling');
            
            const roll = Math.floor(Math.random() * 100) + 1;
            const env = getEnvByRoll(roll);
            
            diceEl.textContent = roll;
            diceEl.style.cssText = 'font-size: 3rem; font-weight: 900; color: var(--primary); text-shadow: 0 0 20px rgba(79, 195, 247, 0.8);';
            
            // Change background
            initPixi(parseInt(env.colors.bg1.replace('#', '0x')));
            createStarBackground(env.colors);
            
            resultEl.innerHTML = `
                <div class="result-icon">${env.icon}</div>
                <div class="result-name">${env.name}</div>
                <div class="result-desc">${env.desc}</div>
                <div class="result-weak">âš ï¸ ${env.weak}</div>
            `;
            
            btn.disabled = false;
            btn.textContent = dice.accept;
            btn.onclick = () => {
                GameState.envId = env.id;
                GameState.save();
                showAfterBirth(env);
            };
        }, 1500);
    };
}

// ========================================
// Prologue - After Birth Story
// ========================================
function showAfterBirth(env) {
    const t = GameState.t.bind(GameState);
    const story = TRANSLATIONS[GameState.currentLang].afterBirth(env);
    let idx = 0;
    
    function render() {
        const s = story[idx];
        const isLast = idx === story.length - 1;
        
        app.innerHTML = `
            <button class="skip-btn" id="skip-btn">${t('skip')}</button>
            <div class="page-center">
                <div class="page-content">
                    <div class="page-icon">${s.icon}</div>
                    <h2 class="page-title">${s.title}</h2>
                    <p class="page-text">${s.text}</p>
                    <div class="dots">
                        ${story.map((_, i) => `<div class="dot ${i < idx ? 'done' : ''} ${i === idx ? 'active' : ''}"></div>`).join('')}
                    </div>
                    <button class="btn btn-primary btn-block" id="btn-next">${isLast ? 'ğŸš€ ' + t('start') : t('next')}</button>
                </div>
            </div>
        `;
        
        document.getElementById('btn-next').onclick = () => {
            if (isLast) {
                GameState.prologueDone = true;
                GameState.save();
                startPhase1();
            } else { idx++; render(); }
        };
        document.getElementById('skip-btn').onclick = () => {
            GameState.prologueDone = true;
            GameState.save();
            startPhase1();
        };
    }
    
    render();
}

// ========================================
// Phase 1 - Cell Survival Game
// ========================================
let player, foods = [], enemies = [];
let joyPos = { x: 0, y: 0 }, joyActive = false, keys = {};
let lastEnemySpawn = 0, dashCooldown = 0, dashing = false;
let gameRunning = false, time = 0;
let currentEnv = null;

function startPhase1() {
    GameState.reset();
    currentEnv = getEnvById(GameState.envId);
    
    initPixi(parseInt(currentEnv.colors.bg1.replace('#', '0x')));
    createStarBackground(currentEnv.colors);
    
    const t = GameState.t.bind(GameState);
    
    app.innerHTML = `
        <div class="hud-top">
            <div class="hud-panel" style="min-width: 130px;">
                <div class="hud-name" id="player-name">${currentEnv.icon} ${currentEnv.name}</div>
                <div class="hud-row"><span>âš¡</span><span class="hud-val" id="h-score">0</span><span class="hud-label">ì ìˆ˜</span></div>
                <div class="hud-row"><span>ğŸ´</span><span class="hud-val" id="h-eaten">0</span><span class="hud-label">ì„­ì·¨</span></div>
                <div class="size-bar">
                    <span style="font-size: 0.65rem;">ğŸ“</span>
                    <div class="size-track"><div class="size-fill" id="h-size" style="width: 15%;"></div></div>
                    <span class="size-num" id="h-sizeN">12</span>
                </div>
            </div>
            <div class="hud-panel parts-panel">
                <div class="parts-title">ğŸ§¬ ì‹ ì²´ íŒŒì¸ </div>
                <div class="parts-grid" id="h-parts"><span style="font-size: 0.65rem; color: #666;">ì—†ìŒ</span></div>
                <div class="progress-section">
                    <div class="progress-label"><span class="progress-left">ë‹¤ìŒ íŒŒì¸ </span><span class="progress-right" id="h-partP">0/15</span></div>
                    <div class="progress-track"><div class="progress-fill evo" id="h-partB" style="width: 0%;"></div></div>
                </div>
            </div>
            <div class="hud-btns">
                <button class="hud-btn" id="btn-skip-phase" title="í…ŒìŠ¤íŠ¸: ë‹¤ìŒ Phase" style="background: linear-gradient(135deg, #ff6b6b, #feca57); font-size: 0.7rem;">â­ï¸</button>
                <button class="hud-btn" id="btn-home" title="í™ˆ">ğŸ </button>
                <button class="hud-btn" id="btn-pause" title="ì¼ì‹œì •ì§€">â¸ï¸</button>
            </div>
        </div>
        <div class="hud-bottom">
            <div class="stage-bar">
                <div class="stage-row">
                    <span class="stage-cur">ğŸ¦  Stage 1: ì„¸í¬</span>
                    <span class="stage-next">ë‹¤ì„¸í¬: <span id="h-stageP">0/2000</span></span>
                </div>
                <div class="progress-track"><div class="progress-fill stage" id="h-stageB" style="width: 0%;"></div></div>
            </div>
        </div>
        <div class="controls">
            <div class="joystick" id="joystick"><div class="joy-base"></div><div class="joy-knob" id="joy-knob"></div></div>
            <button class="action-btn disabled" id="btn-dash" title="ëŒ€ì‹œ">ğŸ’¨</button>
        </div>
        <div class="modal" id="modal-gameover">
            <div class="modal-box">
                <div class="modal-icon">ğŸ’€</div>
                <h2 class="modal-title fail">${t('gameover')}</h2>
                <p class="modal-desc">${t('gameoverDesc')}</p>
                <div class="modal-stats">
                    <div class="stat-row"><span class="stat-label">ì ìˆ˜</span><span class="stat-val" id="go-score">0</span></div>
                    <div class="stat-row"><span class="stat-label">ì„­ì·¨</span><span class="stat-val" id="go-eaten">0</span></div>
                    <div class="stat-row"><span class="stat-label">ìµœëŒ€ í¬ê¸°</span><span class="stat-val" id="go-maxsize">0</span></div>
                </div>
                <div class="modal-btns">
                    <button class="btn btn-primary btn-block" id="btn-retry">ğŸ² ${t('retry')}</button>
                </div>
            </div>
        </div>
        <div class="modal" id="modal-clear">
            <div class="modal-box">
                <div class="modal-icon">ğŸ‰</div>
                <h2 class="modal-title win">${t('clear')}</h2>
                <p class="modal-desc">${t('clearDesc')}</p>
                <div class="modal-stats">
                    <div class="stat-row"><span class="stat-label">ìµœì¢… ì ìˆ˜</span><span class="stat-val" id="cl-score">0</span></div>
                    <div class="stat-row"><span class="stat-label">íšë“ íŒŒì¸ </span><span class="stat-val" id="cl-parts">0</span></div>
                </div>
                <div class="modal-btns">
                    <button class="btn btn-primary btn-block" id="btn-next">ğŸ”ï¸ ${t('nextPhase')}</button>
                </div>
            </div>
        </div>
    `;
    
    // Create game objects
    createPlayer();
    spawnFoods(CONFIG.MAX_FOODS);
    
    setupControls();
    setupGameHUD();
    
    foods = [];
    enemies = [];
    lastEnemySpawn = Date.now();
    time = 0;
    
    spawnFoods(CONFIG.MAX_FOODS);
    
    gameLoop = delta => updateGame(delta);
    pixiApp.ticker.add(gameLoop);
    gameRunning = true;
}

function createPlayer() {
    player = new PIXI.Container();
    player.x = pixiApp.screen.width / 2;
    player.y = pixiApp.screen.height / 2;
    player.size = CONFIG.INITIAL_SIZE;
    player.vx = 0;
    player.vy = 0;
    
    const body = new PIXI.Graphics();
    player.body = body;
    player.addChild(body);
    
    pixiApp.stage.addChild(player);
}

function drawPlayerBody() {
    const gfx = player.body;
    const size = player.size;
    const p = GameState.parts;
    const t = time;
    
    const primary = parseInt(currentEnv.colors.primary.replace('#', '0x'));
    const secondary = parseInt(currentEnv.colors.secondary.replace('#', '0x'));
    
    gfx.clear();
    
    // Tail
    if (p.tail > 0) {
        gfx.lineStyle(Math.max(3, size * 0.08), primary);
        for (let i = 0; i < p.tail; i++) {
            const tw = Math.sin(t * 3 + i) * size * 0.3;
            const oy = (i - (p.tail - 1) / 2) * size * 0.15;
            gfx.moveTo(-size * 0.7, oy);
            gfx.bezierCurveTo(-size * 1.1, tw + oy, -size * 1.4, -tw * 0.4 + oy, -size * 1.7, tw * 0.3 + oy);
        }
        gfx.lineStyle(0);
    }
    
    // Arms
    if (p.arm > 0) {
        gfx.lineStyle(Math.max(2, size * 0.06), primary);
        for (let i = 0; i < p.arm; i++) {
            const baseAngle = (0.2 + i * 0.18) * (i % 2 === 0 ? 1 : -1) * Math.PI;
            const wave = Math.sin(t * 2.5 + i) * 0.15;
            gfx.moveTo(Math.cos(baseAngle) * size * 0.85, Math.sin(baseAngle) * size * 0.85);
            gfx.quadraticCurveTo(Math.cos(baseAngle) * size * 1.3, Math.sin(baseAngle + wave) * size * 1.1, Math.cos(baseAngle) * size * 1.5, Math.sin(baseAngle + wave * 2) * size * 0.85);
        }
        gfx.lineStyle(0);
    }
    
    // Legs
    if (p.leg > 0) {
        gfx.lineStyle(Math.max(2, size * 0.05), secondary);
        for (let i = 0; i < p.leg; i++) {
            const baseAngle = Math.PI * 0.5 + (i - (p.leg - 1) / 2) * 0.22;
            const wave = Math.sin(t * 4 + i) * 0.15;
            gfx.moveTo(Math.cos(baseAngle) * size * 0.7, Math.sin(baseAngle) * size * 0.7);
            gfx.lineTo(Math.cos(baseAngle + wave) * size * 1.3, Math.sin(baseAngle) * size * 1.25);
        }
        gfx.lineStyle(0);
    }
    
    // Antenna
    if (p.antenna > 0) {
        gfx.lineStyle(2, primary);
        for (let i = 0; i < p.antenna; i++) {
            const aa = -Math.PI * 0.35 + i * 0.35;
            const wave = Math.sin(t * 3) * 0.1;
            gfx.moveTo(Math.cos(aa) * size * 0.6, Math.sin(aa) * size * 0.6);
            gfx.quadraticCurveTo(Math.cos(aa) * size * 1.1, Math.sin(aa) * size * 1.0, Math.cos(aa) * size * 1.4, Math.sin(aa + wave) * size * 1.1);
            gfx.lineStyle(0);
            gfx.beginFill(primary);
            gfx.drawCircle(Math.cos(aa) * size * 1.4, Math.sin(aa + wave) * size * 1.1, 4);
            gfx.endFill();
            gfx.lineStyle(2, primary);
        }
        gfx.lineStyle(0);
    }
    
    // Body
    gfx.beginFill(primary, 0.9);
    gfx.moveTo(size, 0);
    for (let i = 0; i < 12; i++) {
        const ang = (i / 12) * Math.PI * 2;
        const wobble = Math.sin(t * 2 + i * 0.8) * 2.5;
        gfx.lineTo(Math.cos(ang) * (size + wobble), Math.sin(ang) * (size + wobble));
    }
    gfx.closePath();
    gfx.endFill();
    
    // Inner
    gfx.beginFill(secondary, 0.4);
    gfx.drawCircle(0, 0, size * 0.7);
    gfx.endFill();
    
    // Highlight
    gfx.beginFill(0xffffff, 0.35);
    gfx.drawCircle(-size * 0.25, -size * 0.25, size * 0.35);
    gfx.endFill();
    
    // Eyes
    const eyeCount = Math.max(1, p.eye);
    for (let i = 0; i < eyeCount; i++) {
        const ex = (i - (eyeCount - 1) / 2) * size * 0.35;
        gfx.beginFill(0xffffff);
        gfx.drawCircle(ex, -size * 0.15, size * 0.22);
        gfx.endFill();
        gfx.beginFill(0x222222);
        gfx.drawCircle(ex + size * 0.04, -size * 0.15, size * 0.11);
        gfx.endFill();
        gfx.beginFill(0xffffff, 0.8);
        gfx.drawCircle(ex - size * 0.05, -size * 0.21, size * 0.05);
        gfx.endFill();
    }
    
    // Mouth
    if (p.mouth > 0) {
        gfx.lineStyle(2.5, secondary);
        gfx.arc(0, size * 0.25, size * 0.13, 0.2, Math.PI - 0.2);
        gfx.lineStyle(0);
    }
}

function spawnFoods(count) {
    for (let i = 0; i < count; i++) {
        if (foods.length >= CONFIG.MAX_FOODS) return;
        
        const food = new PIXI.Container();
        food.size = 4 + Math.random() * 10;
        food.x = Math.random() * pixiApp.screen.width;
        food.y = Math.random() * pixiApp.screen.height;
        food.vx = (Math.random() - 0.5) * 0.5;
        food.vy = (Math.random() - 0.5) * 0.5;
        food.glowPhase = Math.random() * Math.PI * 2;
        
        if (Math.random() > 0.5) {
            const emoji = new PIXI.Text(currentEnv.creatures[Math.floor(Math.random() * currentEnv.creatures.length)], { fontSize: food.size * 2 });
            emoji.anchor.set(0.5);
            food.addChild(emoji);
        } else {
            const gfx = new PIXI.Graphics();
            gfx.beginFill(parseInt(currentEnv.colors.primary.replace('#', '0x')), 0.9);
            gfx.drawCircle(0, 0, food.size);
            gfx.endFill();
            food.addChild(gfx);
        }
        
        foods.push(food);
        pixiApp.stage.addChild(food);
    }
}

function spawnEnemy() {
    if (enemies.length >= CONFIG.MAX_ENEMIES) return;
    
    const enemy = new PIXI.Container();
    const pSize = player.size;
    const smaller = Math.random() < 0.4;
    let size = smaller ? pSize * (0.3 + Math.random() * 0.5) : pSize * (1.2 + Math.random() * 0.8);
    size = Math.max(8, Math.min(size, 100));
    
    enemy.size = size;
    enemy.speed = 0.8 + Math.random() * 1.2;
    enemy.angle = Math.random() * Math.PI * 2;
    enemy.wobble = Math.random();
    
    const side = Math.floor(Math.random() * 4);
    if (side === 0) { enemy.x = -50; enemy.y = Math.random() * pixiApp.screen.height; }
    else if (side === 1) { enemy.x = pixiApp.screen.width + 50; enemy.y = Math.random() * pixiApp.screen.height; }
    else if (side === 2) { enemy.x = Math.random() * pixiApp.screen.width; enemy.y = -50; }
    else { enemy.x = Math.random() * pixiApp.screen.width; enemy.y = pixiApp.screen.height + 50; }
    
    const gfx = new PIXI.Graphics();
    enemy.gfx = gfx;
    enemy.addChild(gfx);
    
    drawEnemy(enemy);
    
    enemies.push(enemy);
    pixiApp.stage.addChild(enemy);
}

function drawEnemy(enemy) {
    const gfx = enemy.gfx;
    const size = enemy.size;
    const t = time + enemy.wobble * 10;
    
    const canEat = enemy.size < player.size;
    
    gfx.clear();
    
    // ë¨¹ì„ ìˆ˜ ìˆëŠ” ì ì—ë§Œ í™”ë ¤í•œ ê¸€ë¡œìš° íš¨ê³¼ (í°ìƒ‰+ê¸ˆìƒ‰ í„ìŠ¤)
    if (canEat) {
        const pulse = Math.sin(t * 4) * 0.3 + 0.7;
        // ì™¸ë¶€ ê¸€ë¡œìš°
        gfx.beginFill(0xffffff, 0.2 * pulse);
        gfx.drawCircle(0, 0, size * 1.6);
        gfx.endFill();
        // ì¤‘ê°„ ê¸€ë¡œìš°
        gfx.beginFill(0xffdd00, 0.3 * pulse);
        gfx.drawCircle(0, 0, size * 1.35);
        gfx.endFill();
        // í…Œë‘ë¦¬ ë§
        gfx.lineStyle(3, 0xffdd00, 0.8 * pulse);
        gfx.drawCircle(0, 0, size * 1.15);
        gfx.lineStyle(0);
    }
    
    // ëª¸ì²´ - ë¨¹ì„ ìˆ˜ ìˆìœ¼ë©´ ë°ì€ ì´ˆë¡, ì•„ë‹ˆë©´ ë¹¨ê°„ìƒ‰
    const bodyColor = canEat ? 0x44ff88 : 0xff4466;
    const shadowColor = canEat ? 0x22aa55 : 0xcc2244;
    
    gfx.beginFill(bodyColor, 0.85);
    for (let i = 0; i < 10; i++) {
        const ang = (i / 10) * Math.PI * 2;
        const wobble = Math.sin(t * 2 + i + enemy.wobble * 5) * size * 0.12;
        const r = size + wobble;
        if (i === 0) gfx.moveTo(Math.cos(ang) * r, Math.sin(ang) * r);
        else gfx.lineTo(Math.cos(ang) * r, Math.sin(ang) * r);
    }
    gfx.closePath();
    gfx.endFill();
    
    // ë‚´ë¶€ ê·¸ë¦¼ì
    gfx.beginFill(shadowColor, 0.4);
    gfx.drawCircle(0, 0, size * 0.6);
    gfx.endFill();
    
    // í•˜ì´ë¼ì´íŠ¸
    gfx.beginFill(0xffffff, 0.3);
    gfx.drawCircle(-size * 0.2, -size * 0.2, size * 0.25);
    gfx.endFill();
    
    // ëˆˆ
    gfx.beginFill(0xffffff);
    gfx.drawCircle(size * 0.15, -size * 0.15, size * 0.2);
    gfx.endFill();
    
    // ë™ê³µ - ë¨¹ì„ ìˆ˜ ìˆìœ¼ë©´ ê²€ì •, ìœ„í—˜í•˜ë©´ ë¹¨ê°•
    gfx.beginFill(canEat ? 0x333333 : 0xff0000);
    gfx.drawCircle(size * 0.2, -size * 0.15, size * 0.1);
    gfx.endFill();
    
    // ìœ„í—˜í•œ ì ì—ëŠ” ê²½ê³  í‘œì‹œ
    if (!canEat) {
        gfx.lineStyle(2, 0xff0000, 0.6);
        gfx.drawCircle(0, 0, size * 1.2);
        gfx.lineStyle(0);
    }
}

function setupControls() {
    const joy = document.getElementById('joystick');
    const knob = document.getElementById('joy-knob');
    
    const handleMove = (clientX, clientY) => {
        const rect = joy.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;
        const maxDist = rect.width / 2 - 25;
        
        let dx = clientX - centerX;
        let dy = clientY - centerY;
        const dist = Math.sqrt(dx * dx + dy * dy);
        
        if (dist > maxDist) { dx = dx / dist * maxDist; dy = dy / dist * maxDist; }
        
        knob.style.transform = `translate(${dx}px, ${dy}px)`;
        joyPos = { x: dx / maxDist, y: dy / maxDist };
    };
    
    const handleEnd = () => {
        joyActive = false;
        joy.classList.remove('active');
        knob.style.transform = '';
        joyPos = { x: 0, y: 0 };
    };
    
    joy.addEventListener('touchstart', e => { e.preventDefault(); joyActive = true; joy.classList.add('active'); handleMove(e.touches[0].clientX, e.touches[0].clientY); }, { passive: false });
    joy.addEventListener('touchmove', e => { e.preventDefault(); if (joyActive) handleMove(e.touches[0].clientX, e.touches[0].clientY); }, { passive: false });
    joy.addEventListener('touchend', handleEnd);
    joy.addEventListener('mousedown', e => { joyActive = true; joy.classList.add('active'); handleMove(e.clientX, e.clientY); });
    window.addEventListener('mousemove', e => { if (joyActive) handleMove(e.clientX, e.clientY); });
    window.addEventListener('mouseup', handleEnd);
    
    window.addEventListener('keydown', e => { keys[e.key.toLowerCase()] = true; if (e.key === ' ') tryDash(); });
    window.addEventListener('keyup', e => { keys[e.key.toLowerCase()] = false; });
    
    document.getElementById('btn-dash').onclick = tryDash;
}

function tryDash() {
    if (GameState.parts.tail === 0 || dashCooldown > 0 || dashing) return;
    
    dashing = true;
    dashCooldown = CONFIG.DASH_COOLDOWN;
    
    const dir = {
        x: joyPos.x || (keys.d || keys.arrowright ? 1 : keys.a || keys.arrowleft ? -1 : 0),
        y: joyPos.y || (keys.s || keys.arrowdown ? 1 : keys.w || keys.arrowup ? -1 : 0)
    };
    const len = Math.sqrt(dir.x * dir.x + dir.y * dir.y) || 1;
    
    player.vx = dir.x / len * CONFIG.DASH_SPEED;
    player.vy = dir.y / len * CONFIG.DASH_SPEED;
    
    setTimeout(() => { dashing = false; }, CONFIG.DASH_DURATION);
}

function setupGameHUD() {
    document.getElementById('btn-home').onclick = () => {
        if (confirm('í™ˆìœ¼ë¡œ ëŒì•„ê°€ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            gameRunning = false;
            if (gameLoop) pixiApp.ticker.remove(gameLoop);
            showTitle();
        }
    };
    
    document.getElementById('btn-pause').onclick = () => {
        gameRunning = !gameRunning;
        document.getElementById('btn-pause').textContent = gameRunning ? 'â¸ï¸' : 'â–¶ï¸';
    };
    
    // í…ŒìŠ¤íŠ¸ìš©: ë‹¤ìŒ Phaseë¡œ ìŠ¤í‚µ
    document.getElementById('btn-skip-phase').onclick = () => {
        gameRunning = false;
        if (gameLoop) pixiApp.ticker.remove(gameLoop);
        GameState.phase1Clear = true;
        GameState.save();
        showPhase2Intro();
    };
    
    // ê²Œì„ì˜¤ë²„ ì‹œ ë‹¤ì‹œ ì‹œì‘ -> ì£¼ì‚¬ìœ„ í™”ë©´ìœ¼ë¡œ (ìƒˆë¡œìš´ ì¶œìƒì§€ ì„ íƒ)
    document.getElementById('btn-retry').onclick = () => {
        document.getElementById('modal-gameover').classList.remove('show');
        if (gameLoop) pixiApp.ticker.remove(gameLoop);
        GameState.reset();
        GameState.envId = null; // ì¶œìƒì§€ ì´ˆê¸°í™”
        showDice(); // ì£¼ì‚¬ìœ„ í™”ë©´ìœ¼ë¡œ ì´ë™
    };
    
    document.getElementById('btn-next').onclick = () => {
        document.getElementById('modal-clear').classList.remove('show');
        if (gameLoop) pixiApp.ticker.remove(gameLoop);
        showPhase2Intro();
    };
}

function updateHUD() {
    document.getElementById('h-score').textContent = GameState.score;
    document.getElementById('h-eaten').textContent = GameState.eaten;
    document.getElementById('h-sizeN').textContent = Math.round(player.size);
    document.getElementById('h-size').style.width = `${(player.size / CONFIG.MAX_SIZE) * 100}%`;
    
    // Phase 1 íŒŒì¸ ë§Œ ì¹´ìš´íŠ¸
    const p1PartKeys = ['eye', 'mouth', 'arm', 'leg', 'tail', 'antenna'];
    const totalP1Parts = p1PartKeys.reduce((sum, k) => sum + GameState.parts[k], 0);
    const partBase = totalP1Parts * CONFIG.GROWTH_THRESHOLD;
    const partProgress = ((GameState.eaten - partBase) / CONFIG.GROWTH_THRESHOLD) * 100;
    document.getElementById('h-partB').style.width = `${Math.min(100, Math.max(0, partProgress))}%`;
    document.getElementById('h-partP').textContent = `${Math.max(0, GameState.eaten - partBase)}/${CONFIG.GROWTH_THRESHOLD}`;
    
    document.getElementById('h-stageB').style.width = `${Math.min(100, (GameState.score / CONFIG.STAGE_THRESHOLD) * 100)}%`;
    document.getElementById('h-stageP').textContent = `${GameState.score}/${CONFIG.STAGE_THRESHOLD}`;
    
    // Phase 1 íŒŒì¸ ë§Œ í‘œì‹œ
    let partsHtml = '';
    p1PartKeys.forEach(k => {
        if (GameState.parts[k] > 0) {
            partsHtml += `<div class="part-badge active"><span>${BODY_PARTS[k].icon}</span><span class="part-cnt">Ã—${GameState.parts[k]}</span></div>`;
        }
    });
    document.getElementById('h-parts').innerHTML = partsHtml || '<span style="font-size: 0.65rem; color: #666;">ì—†ìŒ</span>';
    
    document.getElementById('btn-dash').classList.toggle('disabled', GameState.parts.tail === 0);
}

function checkPartEvolution() {
    const p1PartKeys = ['eye', 'mouth', 'arm', 'leg', 'tail', 'antenna']; // Phase 1 ì „ìš© íŒŒì¸ 
    const totalP1Parts = p1PartKeys.reduce((sum, k) => sum + GameState.parts[k], 0);
    const threshold = (totalP1Parts + 1) * CONFIG.GROWTH_THRESHOLD;
    
    if (GameState.eaten >= threshold) {
        const available = p1PartKeys.filter(k => GameState.parts[k] < BODY_PARTS[k].max);
        if (available.length === 0) return;
        
        const key = available[Math.floor(Math.random() * available.length)];
        GameState.parts[key]++;
        
        const part = BODY_PARTS[key];
        showEvolution(part.icon, `${part.name} íšë“!`, `${part.name} Ã—${GameState.parts[key]}`, part.fx);
    }
}

function updateGame(delta) {
    if (!gameRunning) return;
    
    time += delta * 0.016;
    if (dashCooldown > 0) dashCooldown -= 16;
    
    let ix = joyPos.x, iy = joyPos.y;
    if (keys.w || keys.arrowup) iy = -1;
    if (keys.s || keys.arrowdown) iy = 1;
    if (keys.a || keys.arrowleft) ix = -1;
    if (keys.d || keys.arrowright) ix = 1;
    
    const speed = 3 + GameState.parts.leg * 0.4;
    if (!dashing) { player.vx = ix * speed; player.vy = iy * speed; }
    else { player.vx *= 0.95; player.vy *= 0.95; }
    
    player.x += player.vx;
    player.y += player.vy;
    player.x = Math.max(player.size, Math.min(pixiApp.screen.width - player.size, player.x));
    player.y = Math.max(player.size, Math.min(pixiApp.screen.height - player.size, player.y));
    
    if (Date.now() - lastEnemySpawn > CONFIG.ENEMY_SPAWN_INTERVAL) {
        spawnEnemy();
        lastEnemySpawn = Date.now();
    }
    
    const magnetRange = GameState.parts.arm > 0 ? 60 + GameState.parts.arm * 20 : 0;
    
    for (let i = foods.length - 1; i >= 0; i--) {
        const food = foods[i];
        food.x += food.vx; food.y += food.vy;
        if (food.x < -30) food.x = pixiApp.screen.width + 30;
        if (food.x > pixiApp.screen.width + 30) food.x = -30;
        if (food.y < -30) food.y = pixiApp.screen.height + 30;
        if (food.y > pixiApp.screen.height + 30) food.y = -30;
        
        const dx = player.x - food.x, dy = player.y - food.y;
        const dist = Math.sqrt(dx * dx + dy * dy);
        
        if (magnetRange && dist < magnetRange) { food.x += dx * 0.04; food.y += dy * 0.04; }
        
        if (dist < player.size + food.size * 0.5) {
            player.size = Math.min(CONFIG.MAX_SIZE, player.size + food.size * 0.1);
            GameState.eaten++;
            GameState.score += Math.floor(food.size * 2 * (1 + GameState.parts.mouth * 0.15));
            GameState.maxSize = Math.max(GameState.maxSize, player.size);
            checkPartEvolution();
            pixiApp.stage.removeChild(food);
            foods.splice(i, 1);
            setTimeout(() => spawnFoods(1), 500);
        }
    }
    
    for (let i = enemies.length - 1; i >= 0; i--) {
        const enemy = enemies[i];
        const dx = player.x - enemy.x, dy = player.y - enemy.y;
        const dist = Math.sqrt(dx * dx + dy * dy);
        
        drawEnemy(enemy);
        
        const canEat = enemy.size < player.size;
        if (!canEat) {
            enemy.x += dx / dist * enemy.speed * 0.5;
            enemy.y += dy / dist * enemy.speed * 0.5;
        } else {
            enemy.x -= dx / dist * enemy.speed * 0.3;
            enemy.y -= dy / dist * enemy.speed * 0.3;
        }
        
        enemy.angle += (Math.random() - 0.5) * 0.1;
        enemy.x += Math.cos(enemy.angle) * enemy.speed * 0.3;
        enemy.y += Math.sin(enemy.angle) * enemy.speed * 0.3;
        
        if (enemy.x < -200 || enemy.x > pixiApp.screen.width + 200 || enemy.y < -200 || enemy.y > pixiApp.screen.height + 200) {
            pixiApp.stage.removeChild(enemy);
            enemies.splice(i, 1);
            continue;
        }
        
        if (dist < player.size + enemy.size * 0.6) {
            if (canEat) {
                player.size = Math.min(CONFIG.MAX_SIZE, player.size + enemy.size * 0.15);
                GameState.eaten++;
                GameState.score += Math.floor(enemy.size * 5 * (1 + GameState.parts.mouth * 0.15));
                GameState.maxSize = Math.max(GameState.maxSize, player.size);
                checkPartEvolution();
                pixiApp.stage.removeChild(enemy);
                enemies.splice(i, 1);
            } else {
                gameOver();
                return;
            }
        }
    }
    
    drawPlayerBody();
    updateHUD();
    
    // Phase 1 íŒŒì¸ ë§Œ ì¹´ìš´íŠ¸í•´ì„œ í´ë¦¬ì–´ ì¡°ê±´ ì²´í¬
    const p1PartKeys = ['eye', 'mouth', 'arm', 'leg', 'tail', 'antenna'];
    const totalP1Parts = p1PartKeys.reduce((sum, k) => sum + GameState.parts[k], 0);
    if (GameState.score >= CONFIG.STAGE_THRESHOLD && totalP1Parts >= 5) {
        stageClear();
    }
}

function gameOver() {
    gameRunning = false;
    const t = GameState.t.bind(GameState);
    document.getElementById('go-score').textContent = GameState.score;
    document.getElementById('go-eaten').textContent = GameState.eaten;
    document.getElementById('go-maxsize').textContent = Math.round(GameState.maxSize);
    document.getElementById('modal-gameover').classList.add('show');
}

function stageClear() {
    gameRunning = false;
    GameState.phase1Clear = true;
    GameState.save();
    
    const p1PartKeys = ['eye', 'mouth', 'arm', 'leg', 'tail', 'antenna'];
    const totalP1Parts = p1PartKeys.reduce((sum, k) => sum + GameState.parts[k], 0);
    document.getElementById('cl-score').textContent = GameState.score;
    document.getElementById('cl-parts').textContent = totalP1Parts;
    document.getElementById('modal-clear').classList.add('show');
}

    
    // ë†’ì´ ê³„ì‚°
    curHeight = Math.max(0, Math.floor(-climber.y / 10));
    GameState.height = curHeight;
    if (curHeight > GameState.maxHeight) {
        GameState.maxHeight = curHeight;
    }
    
    // ìƒˆ í”Œë«í¼ ìƒì„±
    const highest = Math.min(...platforms.filter(p => p.type !== 'land').map(p => p.y));
    if (-camY - pixiApp.screen.height < highest + 400) {
        generatePlatforms(highest, highest - pixiApp.screen.height * 2);
    }
    
    // ê²Œì„ì˜¤ë²„ ì²´í¬ (í™”ë©´ ì•„ë˜ë¡œ ë–¨ì–´ì§)
    if (climber.y > -camY + pixiApp.screen.height + 80) {
        climbFail();
        return;
    }
    
    // ë Œë”ë§
    renderClimb();
    
    // HUD ì—…ë°ì´íŠ¸
    document.getElementById('h2-height').textContent = curHeight + 'm';
}

function renderClimb() {
    const w = pixiApp.screen.width;
    const h = pixiApp.screen.height;
    const heightRatio = Math.min(1, curHeight / LAND_HEIGHT);
    const t = p2Time;
    
    // ë°°ê²½ ê·¸ë¼ë°ì´ì…˜ (ë†’ì´ì— ë”°ë¼ ë³€í™”)
    let bgColor;
    if (heightRatio < 0.5) {
        bgColor = lerpColor(
            parseInt(currentEnv.colors.bg1.replace('#', '0x')),
            0x1a3a5e,
            heightRatio * 2
        );
    } else {
        bgColor = lerpColor(
            0x1a3a5e,
            0x87CEEB,
            (heightRatio - 0.5) * 2
        );
    }
    pixiApp.renderer.background.color = bgColor;
    
    // ê¸°ì¡´ ê·¸ë˜í”½ í´ë¦¬ì–´
    pixiApp.stage.removeChildren();
    
    const graphics = new PIXI.Graphics();
    pixiApp.stage.addChild(graphics);
    
    // í”Œë«í¼ ê·¸ë¦¬ê¸°
    for (const p of platforms) {
        if (p.broken) continue;
        const screenY = p.y + camY;
        if (screenY < -40 || screenY > h + 40) continue;
        
        if (p.type === 'land') {
            // ìœ¡ì§€
            graphics.beginFill(0x8B4513);
            graphics.drawRect(p.x, screenY, p.w, p.h);
            graphics.endFill();
            graphics.beginFill(0x228B22);
            graphics.drawRect(p.x, screenY, p.w, 20);
            graphics.endFill();
            // ë‚˜ë¬´ë“¤
            for (let i = 0; i < 6; i++) {
                const tx = 30 + i * (p.w / 6);
                graphics.beginFill(0x654321);
                graphics.drawRect(tx, screenY - 40, 10, 40);
                graphics.endFill();
                graphics.beginFill(0x228B22);
                graphics.drawCircle(tx + 5, screenY - 50, 25);
                graphics.endFill();
            }
        } else if (p.type === 'start') {
            const primary = parseInt(currentEnv.colors.primary.replace('#', '0x'));
            graphics.beginFill(primary, 0.8);
            graphics.drawRoundedRect(p.x, screenY, p.w, p.h, 5);
            graphics.endFill();
        } else if (p.type === 'moving') {
            graphics.beginFill(0x9d4edd);
            graphics.drawRoundedRect(p.x, screenY, p.w, p.h, 5);
            graphics.endFill();
        } else if (p.type === 'breaking') {
            graphics.beginFill(0xef4444);
            graphics.drawRoundedRect(p.x, screenY, p.w, p.h, 5);
            graphics.endFill();
        } else if (p.type === 'bouncy') {
            graphics.beginFill(0x10b981);
            graphics.drawRoundedRect(p.x, screenY, p.w, p.h, 5);
            graphics.endFill();
        } else {
            // ì¼ë°˜ í”Œë«í¼
            const platColor = heightRatio < 0.5 
                ? lerpColor(parseInt(currentEnv.colors.primary.replace('#', '0x')), 0x48cae4, heightRatio * 2)
                : lerpColor(0x48cae4, 0xcaf0f8, (heightRatio - 0.5) * 2);
            graphics.beginFill(platColor);
            graphics.drawRoundedRect(p.x, screenY, p.w, p.h, 5);
            graphics.endFill();
        }
    }
    
    // ì•„ì´í…œ ê·¸ë¦¬ê¸°
    for (const item of climbItems) {
        if (item.collected) continue;
        const screenY = item.y + camY;
        if (screenY < -40 || screenY > h + 40) continue;
        
        const itemText = new PIXI.Text(item.type === 'tornado' ? 'ğŸŒªï¸' : 'â˜ï¸', { fontSize: 28 });
        itemText.anchor.set(0.5);
        itemText.x = item.x;
        itemText.y = screenY + Math.sin(t * 3) * 5;
        itemText.rotation = item.type === 'tornado' ? t * 2 : 0;
        pixiApp.stage.addChild(itemText);
    }
    
    // í”Œë ˆì´ì–´ ê·¸ë¦¬ê¸°
    drawClimber(graphics);
    
    // ì§„í–‰ ë°” (ì˜¤ë¥¸ìª½)
    const barH = h - 120;
    const barX = w - 25;
    const progress = Math.min(1, curHeight / LAND_HEIGHT);
    
    graphics.beginFill(0x000000, 0.25);
    graphics.drawRect(barX - 4, 60, 16, barH);
    graphics.endFill();
    
    graphics.beginFill(0x00f5d4);
    graphics.drawRect(barX - 2, 60 + barH * (1 - progress), 12, barH * progress);
    graphics.endFill();
    
    graphics.beginFill(0x228B22);
    graphics.drawRect(barX - 6, 55, 20, 8);
    graphics.endFill();
}

function drawClimber(graphics) {
    const d = GameState.design;
    const p = GameState.parts;
    const t = p2Time;
    const s = climber.w / 2;
    const screenY = climber.y + camY;
    
    const cx = climber.x + climber.w / 2;
    const cy = screenY + climber.h / 2;
    
    const primary = parseInt(d.primary.replace('#', '0x'));
    const secondary = parseInt(d.secondary.replace('#', '0x'));
    
    // ê¼¬ë¦¬
    if (p.tail > 0) {
        graphics.lineStyle(Math.max(3, s * 0.08), secondary);
        const tailWave = Math.sin(t * 3) * s * 0.3;
        graphics.moveTo(cx - s * 0.8, cy);
        graphics.bezierCurveTo(cx - s * 1.2, cy + tailWave, cx - s * 1.5, cy - tailWave * 0.5, cx - s * 1.8, cy + tailWave * 0.3);
        graphics.lineStyle(0);
    }
    
    // íŒ”
    if (p.arm > 0) {
        graphics.lineStyle(Math.max(2, s * 0.06), primary);
        for (let i = 0; i < Math.min(p.arm, 4); i++) {
            const side = i % 2 === 0 ? 1 : -1;
            const wave = Math.sin(t * 2.5 + i) * 0.15;
            graphics.moveTo(cx + side * s * 0.7, cy);
            graphics.lineTo(cx + side * s * 1.4, cy + wave * s);
        }
        graphics.lineStyle(0);
    }
    
    // ë‹¤ë¦¬
    if (p.leg > 0) {
        graphics.lineStyle(Math.max(2, s * 0.05), secondary);
        const legWave = Math.sin(t * 4) * 0.2;
        for (let i = 0; i < Math.min(p.leg, 4); i++) {
            const baseAngle = Math.PI * 0.5 + (i - 1.5) * 0.25;
            graphics.moveTo(cx + Math.cos(baseAngle) * s * 0.6, cy + Math.sin(baseAngle) * s * 0.6);
            graphics.lineTo(cx + Math.cos(baseAngle + legWave) * s * 1.2, cy + s * 1.0);
        }
        graphics.lineStyle(0);
    }
    
    // ë”ë“¬ì´
    if (p.antenna > 0) {
        graphics.lineStyle(2, primary);
        for (let i = 0; i < Math.min(p.antenna, 2); i++) {
            const aa = -Math.PI * 0.4 + i * 0.4;
            const wave = Math.sin(t * 3) * 0.1;
            graphics.moveTo(cx + Math.cos(aa) * s * 0.5, cy + Math.sin(aa) * s * 0.5);
            graphics.lineTo(cx + Math.cos(aa + wave) * s * 1.3, cy + Math.sin(aa + wave) * s * 1.0);
            graphics.lineStyle(0);
            graphics.beginFill(primary);
            graphics.drawCircle(cx + Math.cos(aa + wave) * s * 1.3, cy + Math.sin(aa + wave) * s * 1.0, 3);
            graphics.endFill();
            graphics.lineStyle(2, primary);
        }
        graphics.lineStyle(0);
    }
    
    // ëª¸í†µ
    graphics.beginFill(primary, 0.9);
    graphics.moveTo(cx + s, cy);
    for (let i = 0; i < 10; i++) {
        const ang = (i / 10) * Math.PI * 2;
        const wobble = Math.sin(t + i) * 2;
        const r = s + wobble;
        graphics.lineTo(cx + Math.cos(ang) * r, cy + Math.sin(ang) * r);
    }
    graphics.closePath();
    graphics.endFill();
    
    // ë‚´ë¶€
    graphics.beginFill(secondary, 0.4);
    graphics.drawCircle(cx, cy, s * 0.65);
    graphics.endFill();
    
    // í•˜ì´ë¼ì´íŠ¸
    graphics.beginFill(0xffffff, 0.35);
    graphics.drawCircle(cx - s * 0.2, cy - s * 0.2, s * 0.25);
    graphics.endFill();
    
    // ëˆˆ
    const eyeCount = Math.max(1, p.eye || 1);
    for (let i = 0; i < eyeCount; i++) {
        const ex = cx + (i - (eyeCount - 1) / 2) * s * 0.35;
        const ey = cy - s * 0.15;
        graphics.beginFill(0xffffff);
        graphics.drawCircle(ex, ey, s * 0.2);
        graphics.endFill();
        graphics.beginFill(0x222222);
        graphics.drawCircle(ex + s * 0.03, ey, s * 0.1);
        graphics.endFill();
    }
    
    // ì…
    if (p.mouth > 0) {
        graphics.lineStyle(2, secondary);
        graphics.arc(cx, cy + s * 0.25, s * 0.12, 0.2, Math.PI - 0.2);
        graphics.lineStyle(0);
    }
}

function lerpColor(c1, c2, t) {
    const r1 = (c1 >> 16) & 0xff, g1 = (c1 >> 8) & 0xff, b1 = c1 & 0xff;
    const r2 = (c2 >> 16) & 0xff, g2 = (c2 >> 8) & 0xff, b2 = c2 & 0xff;
    const r = Math.round(r1 + (r2 - r1) * t);
    const g = Math.round(g1 + (g2 - g1) * t);
    const b = Math.round(b1 + (b2 - b1) * t);
    return (r << 16) | (g << 8) | b;
}

function climbFail() {
    p2GameRunning = false;
    if (gameLoop && pixiApp) pixiApp.ticker.remove(gameLoop);
    
    document.getElementById('p2go-height').textContent = GameState.maxHeight + 'm';
    document.getElementById('modal-p2-gameover').classList.add('show');
}

function climbWin() {
    p2GameRunning = false;
    if (gameLoop && pixiApp) pixiApp.ticker.remove(gameLoop);
    
    GameState.phase2Clear = true;
    GameState.save();
    
    document.getElementById('p2cl-height').textContent = GameState.maxHeight + 'm';
    document.getElementById('modal-p2-clear').classList.add('show');
}

// ========================================
// Initialize
// ========================================
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
        document.getElementById('loading').classList.add('fade-out');
        setTimeout(showTitle, 500);
    }, 800);
});
    </script>
</body>
</html>
