<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BOKLUCK Universe</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üåå</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
    * { box-sizing: border-box; margin: 0; padding: 0; touch-action: none; user-select: none; -webkit-user-select: none; }
    :root {
        --primary: #00f5d4; --secondary: #7b2cbf; --accent: #f72585; --energy: #fee440;
        --success: #10b981; --danger: #ff4d6d; --bg-space: #0a0a1a;
        --bg-card: rgba(20, 20, 40, 0.9); --bg-card-solid: #14142a;
        --border: rgba(0, 245, 212, 0.2); --text: #e0e0ff; --text-muted: #8080a0;
        --gradient-energy: linear-gradient(135deg, #00f5d4 0%, #fee440 100%);
        --gradient-evolution: linear-gradient(135deg, #7b2cbf 0%, #f72585 100%);
    }
    body { background: var(--bg-space); color: var(--text); font-family: 'Noto Sans KR', sans-serif; min-height: 100vh; overflow: hidden; }
    #stars { position: fixed; inset: 0; z-index: -1; }
    .star { position: absolute; background: white; border-radius: 50%; animation: twinkle 3s infinite; }
    @keyframes twinkle { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }
    
    .loading-screen { position: fixed; inset: 0; background: var(--bg-space); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 3000; }
    .loading-screen.hidden { display: none; }
    .loading-spinner { width: 60px; height: 60px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .navbar { position: fixed; top: 0; left: 0; right: 0; height: 60px; background: rgba(10,10,26,0.95); backdrop-filter: blur(20px); border-bottom: 1px solid var(--border); z-index: 1000; display: flex; align-items: center; padding: 0 24px; }
    .nav-logo { font-family: 'Orbitron'; font-size: 22px; font-weight: 900; background: var(--gradient-energy); -webkit-background-clip: text; -webkit-text-fill-color: transparent; cursor: pointer; }
    .nav-right { margin-left: auto; display: flex; align-items: center; gap: 16px; }
    .entropy-badge { display: flex; align-items: center; gap: 10px; background: var(--bg-card); border: 1px solid var(--border); padding: 8px 16px; border-radius: 25px; }
    .entropy-value { font-family: 'Orbitron'; font-size: 16px; font-weight: 700; color: var(--energy); }
    .user-avatar { width: 36px; height: 36px; border-radius: 50%; border: 2px solid var(--primary); cursor: pointer; }
    
    .main-content { padding-top: 80px; min-height: 100vh; overflow-y: auto; }
    .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
    
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 24px; border: none; border-radius: 12px; font-size: 14px; font-weight: 600; cursor: pointer; transition: 0.2s; }
    .btn-primary { background: var(--gradient-evolution); color: white; }
    .btn-energy { background: var(--gradient-energy); color: #1a1a2e; }
    .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
    .btn-block { width: 100%; }

    .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 20px; padding: 24px; margin-bottom: 20px; }
    .entity-visual { width: 180px; height: 180px; margin: 0 auto 16px; }
    .entity-name { font-family: 'Orbitron'; font-size: 18px; font-weight: 700; text-align: center; margin-bottom: 20px; }
    
    /* Í≤åÏûÑ UI */
    #worldCanvas { position: fixed; inset: 0; z-index: 500; display: none; }
    #worldCanvas.active { display: block; }
    
    .mobile-controls { position: fixed; inset: 0; z-index: 600; pointer-events: none; display: none; flex-direction: column; justify-content: space-between; padding: 20px; }
    .mobile-controls.active { display: flex; }
    
    .hud-top { display: flex; justify-content: space-between; align-items: flex-start; pointer-events: auto; }
    .hud-bottom { display: flex; justify-content: space-between; align-items: flex-end; padding-bottom: 30px; pointer-events: none; }
    
    .joystick-zone { width: 120px; height: 120px; background: rgba(255, 255, 255, 0.05); border-radius: 50%; position: relative; pointer-events: auto; border: 1px solid var(--border); }
    .joystick-knob { width: 50px; height: 50px; background: var(--primary); border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); opacity: 0.6; }
    
    .action-btn { width: 70px; height: 70px; border-radius: 50%; background: var(--accent); color: white; font-size: 24px; display: flex; align-items: center; justify-content: center; pointer-events: auto; border: none; opacity: 0.8; }

    .evo-alert { position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%) scale(0); background: rgba(10,10,26,0.95); border: 2px solid var(--secondary); border-radius: 24px; padding: 40px; text-align: center; z-index: 2000; opacity: 0; transition: 0.4s; pointer-events: none; }
    .evo-alert.show { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    .evo-alert-icon { font-size: 60px; margin-bottom: 16px; display: block; }
    .evo-alert-title { font-family: 'Orbitron'; font-size: 24px; color: var(--primary); }

    .hidden { display: none !important; }
    </style>
</head>
<body>
    <div id="stars"></div>
    <div class="loading-screen" id="loadingScreen"><div class="loading-spinner"></div></div>
    
    <div id="app"></div>
    <canvas id="worldCanvas"></canvas>
    
    <div class="mobile-controls" id="mobileControls">
        <div class="hud-top">
            <div class="entropy-badge">‚ö° <span id="hudEntropy">0</span></div>
            <div style="display:flex; gap:8px">
                <button class="btn btn-outline btn-sm" onclick="window.exitWorld()">üè†</button>
                <button class="btn btn-energy btn-sm" id="nextStageBtn" onclick="window.nextStageAction()" style="display:none">üöÄ</button>
            </div>
        </div>
        
        <div class="hud-bottom">
            <div class="joystick-zone" id="joystickZone">
                <div class="joystick-knob" id="joystickKnob"></div>
            </div>
            <button class="action-btn" id="actionBtn" ontouchstart="window.triggerDash()">üöÄ</button>
        </div>
    </div>

    <div class="evo-alert" id="evoAlert">
        <span class="evo-alert-icon" id="evoAlertIcon">üß¨</span>
        <div class="evo-alert-title" id="evoAlertTitle">EVOLUTION</div>
        <div id="evoAlertDesc" style="color:var(--text-muted); margin:10px 0;">Îä•Î†• ÌöçÎìù</div>
    </div>

    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    
    const firebaseConfig = { apiKey: "AIzaSyBwQjuqgWM4YKnqu_gzNbeCg5alrC-jVcQ", authDomain: "myco-737a0.firebaseapp.com", projectId: "myco-737a0", storageBucket: "myco-737a0.firebasestorage.app", messagingSenderId: "942571332540", appId: "1:942571332540:web:be0bb6fbdd32655501c1b9" };
    const fbApp = initializeApp(firebaseConfig);
    const db = getFirestore(fbApp);
    const auth = getAuth(fbApp);
    const googleProvider = new GoogleAuthProvider();
    
    // --- State ---
    const State = {
        user: null,
        game: {
            entropy: 0, stage: 1,
            evolution: { eye: false, arm: false, leg: false, brain: false, wing: false },
            history: [], cellDesign: null
        },
        async sync() { if(this.user) await updateDoc(doc(db, 'users', this.user.uid), { game: this.game }); },
        async load() { 
            if(!this.user) return; 
            const snap = await getDoc(doc(db, 'users', this.user.uid)); 
            if(snap.exists()) { const d = snap.data(); if(d.game) this.game = { ...this.game, ...d.game }; }
        }
    };

    // --- Joystick Logic ---
    const Joystick = { active: false, x: 0, y: 0 };
    function initJoystick() {
        const zone = document.getElementById('joystickZone');
        const knob = document.getElementById('joystickKnob');
        zone.addEventListener('touchstart', (e) => { Joystick.active = true; handleMove(e); });
        zone.addEventListener('touchmove', handleMove);
        zone.addEventListener('touchend', () => { Joystick.active = false; Joystick.x = 0; Joystick.y = 0; knob.style.transform = 'translate(-50%, -50%)'; });
        function handleMove(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = zone.getBoundingClientRect();
            const cx = rect.left + rect.width/2;
            const cy = rect.top + rect.height/2;
            let dx = touch.clientX - cx;
            let dy = touch.clientY - cy;
            const dist = Math.min(Math.hypot(dx, dy), 40);
            const angle = Math.atan2(dy, dx);
            Joystick.x = Math.cos(angle) * (dist / 40);
            Joystick.y = Math.sin(angle) * (dist / 40);
            knob.style.transform = `translate(calc(-50% + ${Math.cos(angle)*dist}px), calc(-50% + ${Math.sin(angle)*dist}px))`;
        }
    }

    // --- Renderers ---
    function render() {
        const app = document.getElementById('app');
        if(State.currentPage === 'login') {
            app.innerHTML = `<div class="login-page"><h1 class="login-logo">BOKLUCK</h1><div class="login-cell"></div><button class="btn btn-google btn-lg" onclick="window.googleLogin()">Google Í≥ÑÏ†ïÏúºÎ°ú ÏãúÏûë</button></div>`;
        } else {
            const g = State.game;
            app.innerHTML = `
                <div class="navbar"><div class="nav-logo">BOKLUCK</div><div class="nav-right"><div class="entropy-badge">‚ö° ${Math.floor(g.entropy)}</div><img class="user-avatar" src="${State.user.photoURL}" onclick="window.logout()"></div></div>
                <div class="main-content container"><div class="card">
                    <div class="entity-visual"><canvas id="dashCanvas" width="180" height="180"></canvas></div>
                    <div class="entity-name">STAGE ${g.stage} ENTITY</div>
                    <button class="btn btn-primary btn-block" onclick="window.startCellWorld()">üåå ÏÑ∏Ìè¨ ÏÑ∏Í≥Ñ ÏßÑÏûÖ</button>
                </div></div>`;
            setTimeout(drawDash, 100);
        }
    }

    function drawDash() {
        const cvs = document.getElementById('dashCanvas'); if(!cvs) return;
        const ctx = cvs.getContext('2d'); let t = 0;
        function loop() { if(!document.getElementById('dashCanvas')) return; t+=0.05; ctx.clearRect(0,0,180,180); drawEntity(ctx, 90, 90, 40, State.game.evolution, t); requestAnimationFrame(loop); }
        loop();
    }

    function drawEntity(ctx, x, y, r, evo, t) {
        ctx.save(); ctx.translate(x,y); ctx.beginPath();
        for(let i=0; i<12; i++){ const a = (i/12)*Math.PI*2; const rad = r + Math.sin(t + i)*3; ctx.lineTo(Math.cos(a)*rad, Math.sin(a)*rad); }
        ctx.closePath(); const g = ctx.createRadialGradient(-10,-10,0,0,0,r); g.addColorStop(0, '#00f5d4'); g.addColorStop(1, '#7b2cbf'); ctx.fillStyle = g; ctx.fill();
        if(evo.eye) { ctx.fillStyle='white'; ctx.beginPath(); ctx.arc(10,-5,10,0,Math.PI*2); ctx.fill(); ctx.fillStyle='black'; ctx.beginPath(); ctx.arc(12,-5,4,0,Math.PI*2); ctx.fill(); }
        ctx.restore();
    }

    // --- Game World ---
    let worldRunning = false;
    window.startCellWorld = () => {
        document.getElementById('app').innerHTML = '';
        const cvs = document.getElementById('worldCanvas'); const ctx = cvs.getContext('2d');
        cvs.width = window.innerWidth; cvs.height = window.innerHeight;
        cvs.classList.add('active'); document.getElementById('mobileControls').classList.add('active');
        worldRunning = true;
        let particles = []; for(let i=0; i<50; i++) particles.push({ x: Math.random()*cvs.width, y: Math.random()*cvs.height, val: 5 });
        let player = { x: cvs.width/2, y: cvs.height/2, size: 30 };
        
        function loop() {
            if(!worldRunning) return;
            ctx.fillStyle = '#0a0a1a'; ctx.fillRect(0,0,cvs.width, cvs.height);
            
            let mx = Joystick.x, my = Joystick.y;
            player.x += mx * 5; player.y += my * 5;
            player.x = Math.max(0, Math.min(cvs.width, player.x));
            player.y = Math.max(0, Math.min(cvs.height, player.y));
            
            particles.forEach((p, i) => {
                const d = Math.hypot(p.x-player.x, p.y-player.y);
                if(d < player.size + 10) {
                    State.game.entropy += p.val;
                    document.getElementById('hudEntropy').textContent = Math.floor(State.game.entropy);
                    particles[i] = { x: Math.random()*cvs.width, y: Math.random()*cvs.height, val: 5 };
                    checkEvolution();
                }
                ctx.fillStyle = '#00f5d4'; ctx.beginPath(); ctx.arc(p.x, p.y, 4, 0, Math.PI*2); ctx.fill();
            });
            
            drawEntity(ctx, player.x, player.y, player.size, State.game.evolution, Date.now()*0.005);
            requestAnimationFrame(loop);
        }
        loop();
    };

    function checkEvolution() {
        const e = State.game.entropy; const ev = State.game.evolution;
        let type = null;
        if(!ev.eye && e >= 100) { ev.eye = true; type = "ÏãúÍ∞Å(Eye)"; }
        else if(!ev.arm && e >= 300) { ev.arm = true; type = "Ï¥âÏàò(Arm)"; }
        
        if(type) {
            const alert = document.getElementById('evoAlert');
            document.getElementById('evoAlertDesc').textContent = `${type} ÏßÑÌôî ÏôÑÎ£å!`;
            alert.classList.add('show');
            setTimeout(() => alert.classList.remove('show'), 3000);
            State.sync();
        }
        if(e >= 800) document.getElementById('nextStageBtn').style.display = 'block';
    }

    window.exitWorld = () => { worldRunning = false; document.getElementById('worldCanvas').classList.remove('active'); document.getElementById('mobileControls').classList.remove('active'); State.sync(); render(); };
    window.googleLogin = async () => { await signInWithPopup(auth, googleProvider); };
    window.logout = () => signOut(auth);

    onAuthStateChanged(auth, async (u) => {
        if(u) { State.user = u; await State.load(); State.currentPage = 'dashboard'; }
        else { State.user = null; State.currentPage = 'login'; }
        document.getElementById('loadingScreen').classList.add('hidden'); render();
    });

    initJoystick();
    createStars();
    </script>
</body>
</html>
