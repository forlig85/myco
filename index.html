<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOKLUCK Universe</title>
    <meta name="description" content="ìš°ì£¼ì—ì„œ ê¹¨ì–´ë‚œ ì˜ì‹, ì‚´ì•„ë‚¨ì•„ ì§„í™”í•˜ë¼">
    <meta name="theme-color" content="#0a0a1a">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸŒŒ</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
    /* ========================================
       CORE.CSS - ê¸°ë³¸ ë³€ìˆ˜ ë° ë¦¬ì…‹
    ======================================== */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    :root {
        /* Colors */
        --primary: #00f5d4;
        --primary-dark: #00b4a0;
        --secondary: #7b2cbf;
        --accent: #f72585;
        --energy: #fee440;
        --success: #10b981;
        --danger: #ff4d6d;
        --warning: #f59e0b;
        
        /* Backgrounds */
        --bg-space: #0a0a1a;
        --bg-card: rgba(20, 20, 40, 0.9);
        --bg-card-solid: #14142a;
        --bg-hover: rgba(30, 30, 60, 0.9);
        --bg-input: rgba(10, 10, 30, 0.8);
        
        /* Borders */
        --border: rgba(0, 245, 212, 0.2);
        --border-bright: rgba(0, 245, 212, 0.5);
        
        /* Text */
        --text: #e0e0ff;
        --text-muted: #8080a0;
        --text-dark: #4a4a6a;
        
        /* Gradients */
        --gradient-cosmic: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f72585 100%);
        --gradient-energy: linear-gradient(135deg, #00f5d4 0%, #fee440 100%);
        --gradient-evolution: linear-gradient(135deg, #7b2cbf 0%, #f72585 100%);
        --gradient-gold: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
        
        /* Spacing */
        --nav-height: 60px;
        --sidebar-width: 280px;
        
        /* Transitions */
        --transition-fast: 0.15s ease;
        --transition-normal: 0.3s ease;
        --transition-slow: 0.5s ease;
    }
    
    body {
        background: var(--bg-space);
        color: var(--text);
        font-family: 'Noto Sans KR', sans-serif;
        min-height: 100vh;
        overflow-x: hidden;
        line-height: 1.6;
    }
    
    /* ìŠ¤í¬ë¡¤ë°” */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg-space); }
    ::-webkit-scrollbar-thumb { background: var(--secondary); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--accent); }
    
    /* í°íŠ¸ */
    .font-display { font-family: 'Orbitron', sans-serif; }
    
    /* ========================================
       SPACE BACKGROUND
    ======================================== */
    #space-bg {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: 
            radial-gradient(ellipse at 20% 80%, rgba(123, 44, 191, 0.15) 0%, transparent 50%),
            radial-gradient(ellipse at 80% 20%, rgba(247, 37, 133, 0.1) 0%, transparent 50%),
            radial-gradient(ellipse at 50% 50%, rgba(0, 245, 212, 0.05) 0%, transparent 70%),
            var(--bg-space);
        z-index: -2;
    }
    
    #stars {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        z-index: -1;
        overflow: hidden;
        pointer-events: none;
    }
    
    .star {
        position: absolute;
        background: white;
        border-radius: 50%;
        animation: twinkle 3s infinite;
    }
    
    @keyframes twinkle {
        0%, 100% { opacity: 0.3; }
        50% { opacity: 1; }
    }
    
    /* ========================================
       SHELL.CSS - ë©”ì¸ ë ˆì´ì•„ì›ƒ
    ======================================== */
    #app {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
    }
    
    /* ë„¤ë¹„ê²Œì´ì…˜ */
    .navbar {
        position: fixed;
        top: 0; left: 0; right: 0;
        height: var(--nav-height);
        background: rgba(10, 10, 26, 0.95);
        backdrop-filter: blur(20px);
        border-bottom: 1px solid var(--border);
        z-index: 1000;
        display: flex;
        align-items: center;
        padding: 0 24px;
    }
    
    .nav-logo {
        font-family: 'Orbitron', sans-serif;
        font-size: 22px;
        font-weight: 900;
        background: var(--gradient-energy);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        cursor: pointer;
        margin-right: 40px;
    }
    
    .nav-links {
        display: flex;
        gap: 8px;
        flex: 1;
    }
    
    .nav-link {
        padding: 10px 18px;
        border-radius: 10px;
        color: var(--text-muted);
        text-decoration: none;
        font-size: 14px;
        font-weight: 500;
        transition: var(--transition-fast);
        display: flex;
        align-items: center;
        gap: 8px;
        position: relative;
    }
    
    .nav-link:hover { color: var(--text); background: var(--bg-hover); }
    .nav-link.active { color: var(--primary); background: rgba(0, 245, 212, 0.1); }
    .nav-link.locked { opacity: 0.4; pointer-events: none; }
    .nav-link .lock-icon { font-size: 12px; }
    
    .nav-right {
        display: flex;
        align-items: center;
        gap: 16px;
    }
    
    /* ì—”íŠ¸ë¡œí”¼ í‘œì‹œ */
    .entropy-badge {
        display: flex;
        align-items: center;
        gap: 10px;
        background: var(--bg-card);
        border: 1px solid var(--border);
        padding: 8px 16px;
        border-radius: 25px;
    }
    
    .entropy-icon {
        width: 24px; height: 24px;
        background: var(--gradient-energy);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        animation: energyPulse 2s infinite;
    }
    
    @keyframes energyPulse {
        0%, 100% { box-shadow: 0 0 8px rgba(254, 228, 64, 0.5); }
        50% { box-shadow: 0 0 20px rgba(254, 228, 64, 0.8); }
    }
    
    .entropy-value {
        font-family: 'Orbitron', sans-serif;
        font-size: 16px;
        font-weight: 700;
        color: var(--energy);
    }
    
    /* ìœ ì € í”„ë¡œí•„ */
    .user-profile {
        display: flex;
        align-items: center;
        gap: 12px;
        cursor: pointer;
        padding: 6px 12px;
        border-radius: 25px;
        transition: var(--transition-fast);
    }
    
    .user-profile:hover { background: var(--bg-hover); }
    
    .user-avatar {
        width: 36px; height: 36px;
        border-radius: 50%;
        border: 2px solid var(--primary);
        object-fit: cover;
    }
    
    .user-name {
        font-size: 14px;
        font-weight: 600;
        max-width: 100px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    /* ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ */
    .main-content {
        flex: 1;
        padding-top: var(--nav-height);
        min-height: 100vh;
    }
    
    .page-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 24px;
    }
    
    /* ê²Œì„ ì „ì²´ í™”ë©´ */
    .fullscreen-game {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        z-index: 500;
    }
    
    /* ========================================
       COMPONENTS.CSS - UI ì»´í¬ë„ŒíŠ¸
    ======================================== */
    
    /* ë²„íŠ¼ */
    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 12px 24px;
        border: none;
        border-radius: 12px;
        font-family: 'Noto Sans KR', sans-serif;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition-fast);
    }
    
    .btn:hover { transform: translateY(-2px); }
    .btn:active { transform: translateY(0); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    
    .btn-primary {
        background: var(--gradient-cosmic);
        color: white;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    .btn-primary:hover { box-shadow: 0 6px 25px rgba(102, 126, 234, 0.5); }
    
    .btn-energy {
        background: var(--gradient-energy);
        color: #1a1a2e;
    }
    
    .btn-outline {
        background: transparent;
        border: 1px solid var(--border);
        color: var(--text);
    }
    .btn-outline:hover { border-color: var(--primary); color: var(--primary); }
    
    .btn-google {
        background: white;
        color: #333;
        padding: 14px 32px;
        font-size: 15px;
    }
    .btn-google img { width: 20px; height: 20px; }
    
    .btn-lg { padding: 16px 40px; font-size: 16px; }
    .btn-sm { padding: 8px 16px; font-size: 13px; }
    .btn-block { width: 100%; }
    
    /* ì¹´ë“œ */
    .card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 20px;
        padding: 24px;
        backdrop-filter: blur(10px);
    }
    
    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--border);
    }
    
    .card-title {
        font-family: 'Orbitron', sans-serif;
        font-size: 16px;
        font-weight: 700;
    }
    
    /* ì§„í–‰ ìƒí™© ë°” */
    .progress-bar {
        height: 8px;
        background: rgba(123, 44, 191, 0.2);
        border-radius: 4px;
        overflow: hidden;
    }
    
    .progress-fill {
        height: 100%;
        background: var(--gradient-evolution);
        border-radius: 4px;
        transition: width 0.5s ease;
        position: relative;
    }
    
    .progress-fill::after {
        content: '';
        position: absolute;
        top: 0; right: 0;
        width: 30px; height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4));
        animation: shimmer 1.5s infinite;
    }
    
    @keyframes shimmer {
        0% { opacity: 0; }
        50% { opacity: 1; }
        100% { opacity: 0; }
    }
    
    /* ìŠ¤í…Œì´ì§€ ì§„í–‰ í‘œì‹œ */
    .stage-progress {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 16px 24px;
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 30px;
    }
    
    .stage-dot {
        width: 32px; height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        background: var(--bg-input);
        border: 2px solid var(--border);
        transition: var(--transition-normal);
    }
    
    .stage-dot.completed {
        background: var(--gradient-energy);
        border-color: var(--energy);
    }
    
    .stage-dot.current {
        background: var(--gradient-evolution);
        border-color: var(--accent);
        animation: currentPulse 2s infinite;
    }
    
    @keyframes currentPulse {
        0%, 100% { box-shadow: 0 0 0 0 rgba(247, 37, 133, 0.4); }
        50% { box-shadow: 0 0 0 8px rgba(247, 37, 133, 0); }
    }
    
    .stage-dot.locked {
        opacity: 0.4;
    }
    
    .stage-line {
        flex: 1;
        height: 2px;
        background: var(--border);
        max-width: 40px;
    }
    
    .stage-line.completed { background: var(--gradient-energy); }
    
    /* í† ìŠ¤íŠ¸ ì•Œë¦¼ */
    .toast-container {
        position: fixed;
        top: 80px;
        right: 24px;
        z-index: 2000;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    
    .toast {
        background: var(--bg-card-solid);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px 20px;
        display: flex;
        align-items: center;
        gap: 12px;
        min-width: 300px;
        animation: slideIn 0.3s ease;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }
    
    .toast.success { border-color: var(--success); }
    .toast.error { border-color: var(--danger); }
    .toast.warning { border-color: var(--warning); }
    
    .toast-icon { font-size: 20px; }
    .toast-message { flex: 1; font-size: 14px; }
    .toast-close {
        background: none;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        font-size: 18px;
    }
    
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    
    /* ëª¨ë‹¬ */
    .modal-overlay {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(8px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1500;
        opacity: 0;
        visibility: hidden;
        transition: var(--transition-normal);
    }
    
    .modal-overlay.active {
        opacity: 1;
        visibility: visible;
    }
    
    .modal {
        background: var(--bg-card-solid);
        border: 1px solid var(--border);
        border-radius: 24px;
        padding: 32px;
        max-width: 480px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        transform: scale(0.9);
        transition: var(--transition-normal);
    }
    
    .modal-overlay.active .modal {
        transform: scale(1);
    }
    
    .modal-close {
        position: absolute;
        top: 16px; right: 16px;
        background: var(--bg-input);
        border: none;
        width: 36px; height: 36px;
        border-radius: 50%;
        color: var(--text-muted);
        cursor: pointer;
        font-size: 18px;
        transition: var(--transition-fast);
    }
    
    .modal-close:hover { background: var(--bg-hover); color: var(--text); }
    
    /* ë¡œë”© */
    .loading-screen {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: var(--bg-space);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 3000;
        transition: opacity 0.5s;
    }
    
    .loading-screen.hidden {
        opacity: 0;
        pointer-events: none;
    }
    
    .loading-spinner {
        width: 60px; height: 60px;
        border: 3px solid var(--border);
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
    }
    
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .loading-text {
        font-family: 'Orbitron', sans-serif;
        font-size: 14px;
        color: var(--text-muted);
        letter-spacing: 2px;
    }
    
    /* ========================================
       LOGIN PAGE
    ======================================== */
    .login-page {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 40px 20px;
        text-align: center;
    }
    
    .login-logo {
        font-family: 'Orbitron', sans-serif;
        font-size: 56px;
        font-weight: 900;
        background: var(--gradient-energy);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 8px;
    }
    
    .login-subtitle {
        font-size: 18px;
        color: var(--text-muted);
        margin-bottom: 40px;
    }
    
    .login-cell {
        width: 150px; height: 150px;
        background: radial-gradient(circle at 30% 30%, var(--primary), var(--secondary));
        border-radius: 50%;
        margin-bottom: 40px;
        box-shadow: 0 0 80px rgba(0, 245, 212, 0.4);
        animation: loginCellPulse 3s ease-in-out infinite;
    }
    
    @keyframes loginCellPulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }
    
    .login-story {
        max-width: 400px;
        font-size: 15px;
        color: var(--text-muted);
        line-height: 1.8;
        margin-bottom: 40px;
    }
    
    .login-story strong {
        color: var(--primary);
    }
    
    .login-divider {
        display: flex;
        align-items: center;
        gap: 16px;
        margin: 24px 0;
        color: var(--text-dark);
        font-size: 13px;
    }
    
    .login-divider::before,
    .login-divider::after {
        content: '';
        flex: 1;
        height: 1px;
        background: var(--border);
    }
    
    /* ========================================
       DASHBOARD PAGE
    ======================================== */
    .dashboard-grid {
        display: grid;
        grid-template-columns: 320px 1fr;
        gap: 24px;
    }
    
    .entity-card {
        position: relative;
        overflow: hidden;
    }
    
    .entity-card::before {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0;
        height: 3px;
        background: var(--gradient-evolution);
    }
    
    .entity-visual {
        width: 180px; height: 180px;
        margin: 0 auto 24px;
        position: relative;
    }
    
    .entity-stage-label {
        font-family: 'Orbitron', sans-serif;
        font-size: 11px;
        color: var(--accent);
        letter-spacing: 2px;
        text-align: center;
        margin-bottom: 8px;
    }
    
    .entity-name {
        font-family: 'Orbitron', sans-serif;
        font-size: 18px;
        font-weight: 700;
        text-align: center;
        margin-bottom: 20px;
    }
    
    .entity-stats {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }
    
    .stat-box {
        background: rgba(0, 245, 212, 0.05);
        border: 1px solid rgba(0, 245, 212, 0.1);
        border-radius: 12px;
        padding: 12px;
        text-align: center;
    }
    
    .stat-value {
        font-family: 'Orbitron', sans-serif;
        font-size: 20px;
        font-weight: 700;
        color: var(--primary);
    }
    
    .stat-label {
        font-size: 11px;
        color: var(--text-muted);
        margin-top: 4px;
    }
    
    /* í€µ ì•¡ì…˜ */
    .quick-actions {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
        margin-bottom: 24px;
    }
    
    .quick-action {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: var(--transition-fast);
    }
    
    .quick-action:hover {
        border-color: var(--primary);
        transform: translateY(-4px);
    }
    
    .quick-action.locked {
        opacity: 0.4;
        cursor: not-allowed;
    }
    
    .quick-action.locked:hover {
        transform: none;
        border-color: var(--border);
    }
    
    .quick-action-icon { font-size: 28px; margin-bottom: 8px; }
    .quick-action-label { font-size: 12px; color: var(--text-muted); }
    
    /* ì—­ì‚¬ì„œ ë¯¸ë¦¬ë³´ê¸° */
    .history-preview {
        flex: 1;
    }
    
    .history-entry {
        background: var(--bg-input);
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 12px;
        border-left: 3px solid var(--secondary);
    }
    
    .history-chapter {
        font-family: 'Orbitron', sans-serif;
        font-size: 11px;
        color: var(--accent);
        margin-bottom: 6px;
    }
    
    .history-title {
        font-weight: 700;
        margin-bottom: 8px;
    }
    
    .history-content {
        font-size: 13px;
        color: var(--text-muted);
        line-height: 1.6;
    }
    
    .history-time {
        font-size: 11px;
        color: var(--text-dark);
        margin-top: 8px;
    }
    
    /* ========================================
       GAME OVERLAY UI
    ======================================== */
    .game-ui {
        position: fixed;
        top: 0; left: 0; right: 0;
        padding: 20px;
        display: flex;
        justify-content: space-between;
        pointer-events: none;
        z-index: 600;
    }
    
    .game-ui > * { pointer-events: auto; }
    
    .game-entropy {
        background: rgba(10, 10, 26, 0.9);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 16px 24px;
        backdrop-filter: blur(10px);
    }
    
    .game-entropy-label {
        font-family: 'Orbitron', sans-serif;
        font-size: 11px;
        color: var(--text-muted);
        letter-spacing: 2px;
    }
    
    .game-entropy-value {
        font-family: 'Orbitron', sans-serif;
        font-size: 32px;
        font-weight: 900;
        background: var(--gradient-energy);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    
    .game-evolution-panel {
        background: rgba(10, 10, 26, 0.9);
        border: 1px solid rgba(123, 44, 191, 0.3);
        border-radius: 16px;
        padding: 16px 20px;
        backdrop-filter: blur(10px);
        min-width: 200px;
    }
    
    .game-evo-title {
        font-family: 'Orbitron', sans-serif;
        font-size: 12px;
        color: var(--secondary);
        margin-bottom: 12px;
    }
    
    .game-evo-item {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 8px;
        opacity: 0.4;
        transition: var(--transition-normal);
    }
    
    .game-evo-item.unlocked { opacity: 1; }
    .game-evo-item.next {
        opacity: 0.7;
        animation: pulse 2s infinite;
    }
    
    .game-evo-icon {
        width: 28px; height: 28px;
        background: rgba(123, 44, 191, 0.2);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
    }
    
    .game-evo-item.unlocked .game-evo-icon {
        background: var(--gradient-evolution);
        box-shadow: 0 0 15px rgba(123, 44, 191, 0.5);
    }
    
    .game-evo-name { font-size: 12px; font-weight: 600; }
    .game-evo-req { font-size: 10px; color: var(--text-muted); }
    
    .game-controls {
        position: fixed;
        bottom: 20px; right: 20px;
        background: rgba(10, 10, 26, 0.9);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px 16px;
        font-size: 11px;
        color: var(--text-dark);
    }
    
    .game-controls div { margin-bottom: 4px; }
    .game-controls .key {
        display: inline-block;
        padding: 2px 8px;
        background: var(--bg-input);
        border-radius: 4px;
        margin-right: 4px;
    }
    
    /* ì§„í™” ì•Œë¦¼ */
    .evolution-alert {
        position: fixed;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%) scale(0);
        background: rgba(10, 10, 26, 0.95);
        border: 2px solid var(--secondary);
        border-radius: 24px;
        padding: 40px 60px;
        text-align: center;
        z-index: 700;
        opacity: 0;
        transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        box-shadow: 0 0 100px rgba(123, 44, 191, 0.5);
    }
    
    .evolution-alert.show {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
    }
    
    .evolution-alert-icon {
        font-size: 64px;
        margin-bottom: 16px;
        animation: bounce 0.6s ease infinite;
    }
    
    @keyframes bounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-10px); }
    }
    
    .evolution-alert-title {
        font-family: 'Orbitron', sans-serif;
        font-size: 24px;
        font-weight: 900;
        background: var(--gradient-energy);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 8px;
    }
    
    .evolution-alert-desc {
        font-size: 14px;
        color: var(--text-muted);
        margin-bottom: 12px;
    }
    
    .evolution-alert-effect {
        padding: 10px 20px;
        background: rgba(0, 245, 212, 0.1);
        border-radius: 20px;
        font-size: 13px;
        color: var(--primary);
    }
    
    /* ========================================
       RESPONSIVE
    ======================================== */
    @media (max-width: 1024px) {
        .dashboard-grid { grid-template-columns: 1fr; }
        .quick-actions { grid-template-columns: repeat(2, 1fr); }
    }
    
    @media (max-width: 768px) {
        .nav-links { display: none; }
        .nav-logo { margin-right: auto; }
        .login-logo { font-size: 40px; }
        .login-cell { width: 100px; height: 100px; }
    }
    
    /* ========================================
       UTILITY CLASSES
    ======================================== */
    .hidden { display: none !important; }
    .text-center { text-align: center; }
    .text-muted { color: var(--text-muted); }
    .mb-8 { margin-bottom: 8px; }
    .mb-16 { margin-bottom: 16px; }
    .mb-24 { margin-bottom: 24px; }
    .mt-16 { margin-top: 16px; }
    .mt-24 { margin-top: 24px; }
    </style>
</head>
<body>
    <!-- ìš°ì£¼ ë°°ê²½ -->
    <div id="space-bg"></div>
    <div id="stars"></div>
    
    <!-- ë¡œë”© í™”ë©´ -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
        <div class="loading-text">INITIALIZING...</div>
    </div>
    
    <!-- ë©”ì¸ ì•± -->
    <div id="app"></div>
    
    <!-- í† ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- ëª¨ë‹¬ ì»¨í…Œì´ë„ˆ -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal" id="modalContent"></div>
    </div>
    
    <!-- ì§„í™” ì•Œë¦¼ -->
    <div class="evolution-alert" id="evolutionAlert">
        <div class="evolution-alert-icon" id="evoAlertIcon">ğŸ‘ï¸</div>
        <div class="evolution-alert-title" id="evoAlertTitle">ì§„í™”!</div>
        <div class="evolution-alert-desc" id="evoAlertDesc">ìƒˆë¡œìš´ ëŠ¥ë ¥ì„ ì–»ì—ˆìŠµë‹ˆë‹¤</div>
        <div class="evolution-alert-effect" id="evoAlertEffect">íš¨ê³¼</div>
    </div>
    
    <!-- ê²Œì„ ìº”ë²„ìŠ¤ (Stage 1) -->
    <canvas id="gameCanvas" class="hidden"></canvas>
    
    <!-- Firebase -->
    <script type="module">
    // ========================================
    // FIREBASE CONFIG
    // ========================================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, collection, addDoc, query, orderBy, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    
    const firebaseConfig = {
        apiKey: "AIzaSyBwQjuqgWM4YKnqu_gzNbeCg5alrC-jVcQ",
        authDomain: "myco-737a0.firebaseapp.com",
        projectId: "myco-737a0",
        storageBucket: "myco-737a0.firebasestorage.app",
        messagingSenderId: "942571332540",
        appId: "1:942571332540:web:be0bb6fbdd32655501c1b9"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const googleProvider = new GoogleAuthProvider();
    
    // ========================================
    // STATE MANAGEMENT
    // ========================================
    const State = {
        user: null,
        userData: null,
        currentPage: 'login',
        isLoading: true,
        
        // ê²Œì„ ìƒíƒœ
        game: {
            entropy: 0,
            stage: 1,
            evolution: {
                eye: false,
                arm: false,
                leg: false,
                brain: false,
                wing: false
            },
            currentPlanet: null,
            territories: [],
            history: []
        },
        
        listeners: [],
        
        subscribe(callback) {
            this.listeners.push(callback);
            return () => {
                this.listeners = this.listeners.filter(l => l !== callback);
            };
        },
        
        notify() {
            this.listeners.forEach(l => l(this));
        },
        
        async update(key, value) {
            if (key.includes('.')) {
                const keys = key.split('.');
                let obj = this;
                for (let i = 0; i < keys.length - 1; i++) {
                    obj = obj[keys[i]];
                }
                obj[keys[keys.length - 1]] = value;
            } else {
                this[key] = value;
            }
            this.notify();
            
            // Firebase ë™ê¸°í™”
            if (this.user && key.startsWith('game.')) {
                await this.syncToFirebase();
            }
        },
        
        async syncToFirebase() {
            if (!this.user) return;
            try {
                await updateDoc(doc(db, 'users', this.user.uid), {
                    game: this.game,
                    updatedAt: serverTimestamp()
                });
            } catch (e) {
                console.error('Sync error:', e);
            }
        },
        
        async loadFromFirebase() {
            if (!this.user) return;
            try {
                const docSnap = await getDoc(doc(db, 'users', this.user.uid));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    this.userData = data;
                    if (data.game) {
                        this.game = { ...this.game, ...data.game };
                    }
                }
            } catch (e) {
                console.error('Load error:', e);
            }
        }
    };
    
    // ========================================
    // ROUTER
    // ========================================
    const Router = {
        routes: {
            'login': renderLoginPage,
            'dashboard': renderDashboard,
            'stage1': renderStage1Game,
            'stage2': renderStage2Game,
            'planet': renderPlanetPage,
            'galaxy': renderGalaxyPage,
            'history': renderHistoryPage,
            'market': renderMarketPage
        },
        
        navigate(page, params = {}) {
            State.currentPage = page;
            State.pageParams = params;
            this.render();
            window.history.pushState({ page, params }, '', `#${page}`);
        },
        
        render() {
            const page = State.currentPage;
            const renderFn = this.routes[page];
            if (renderFn) {
                renderFn(State.pageParams);
            }
        },
        
        init() {
            window.addEventListener('popstate', (e) => {
                if (e.state) {
                    State.currentPage = e.state.page;
                    State.pageParams = e.state.params;
                    this.render();
                }
            });
            
            // í•´ì‹œ ê¸°ë°˜ ë¼ìš°íŒ…
            const hash = window.location.hash.slice(1) || 'login';
            State.currentPage = hash;
        }
    };
    
    // ========================================
    // UI COMPONENTS
    // ========================================
    function createStars() {
        const container = document.getElementById('stars');
        container.innerHTML = '';
        for (let i = 0; i < 150; i++) {
            const star = document.createElement('div');
            star.className = 'star';
            star.style.left = Math.random() * 100 + '%';
            star.style.top = Math.random() * 100 + '%';
            star.style.width = (Math.random() * 2 + 1) + 'px';
            star.style.height = star.style.width;
            star.style.animationDelay = Math.random() * 3 + 's';
            container.appendChild(star);
        }
    }
    
    function showToast(message, type = 'info') {
        const container = document.getElementById('toastContainer');
        const icons = { success: 'âœ…', error: 'âŒ', warning: 'âš ï¸', info: 'â„¹ï¸' };
        
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `
            <span class="toast-icon">${icons[type]}</span>
            <span class="toast-message">${message}</span>
            <button class="toast-close" onclick="this.parentElement.remove()">Ã—</button>
        `;
        container.appendChild(toast);
        
        setTimeout(() => toast.remove(), 4000);
    }
    
    function showEvolutionAlert(icon, title, desc, effect) {
        const alert = document.getElementById('evolutionAlert');
        document.getElementById('evoAlertIcon').textContent = icon;
        document.getElementById('evoAlertTitle').textContent = title;
        document.getElementById('evoAlertDesc').textContent = desc;
        document.getElementById('evoAlertEffect').textContent = effect;
        
        alert.classList.add('show');
        setTimeout(() => alert.classList.remove('show'), 2500);
    }
    
    function hideLoading() {
        document.getElementById('loadingScreen').classList.add('hidden');
    }
    
    function showLoading() {
        document.getElementById('loadingScreen').classList.remove('hidden');
    }
    
    // ========================================
    // NAVBAR COMPONENT
    // ========================================
    function renderNavbar() {
        const stage = State.game.stage;
        
        return `
            <nav class="navbar">
                <div class="nav-logo" onclick="Router.navigate('dashboard')">BOKLUCK</div>
                <div class="nav-links">
                    <a class="nav-link ${State.currentPage === 'dashboard' ? 'active' : ''}" 
                       onclick="Router.navigate('dashboard')">
                        ğŸ  ëŒ€ì‹œë³´ë“œ
                    </a>
                    <a class="nav-link ${stage < 2 ? 'locked' : ''} ${State.currentPage === 'planet' ? 'active' : ''}"
                       onclick="${stage >= 2 ? "Router.navigate('planet')" : ''}">
                        ğŸª í–‰ì„± ${stage < 2 ? '<span class="lock-icon">ğŸ”’</span>' : ''}
                    </a>
                    <a class="nav-link ${stage < 3 ? 'locked' : ''} ${State.currentPage === 'galaxy' ? 'active' : ''}"
                       onclick="${stage >= 3 ? "Router.navigate('galaxy')" : ''}">
                        ğŸŒŒ ì€í•˜ ${stage < 3 ? '<span class="lock-icon">ğŸ”’</span>' : ''}
                    </a>
                    <a class="nav-link ${stage < 2 ? 'locked' : ''} ${State.currentPage === 'market' ? 'active' : ''}"
                       onclick="${stage >= 2 ? "Router.navigate('market')" : ''}">
                        ğŸª ê±°ë˜ì†Œ ${stage < 2 ? '<span class="lock-icon">ğŸ”’</span>' : ''}
                    </a>
                    <a class="nav-link ${State.currentPage === 'history' ? 'active' : ''}"
                       onclick="Router.navigate('history')">
                        ğŸ“œ ì—­ì‚¬ì„œ
                    </a>
                </div>
                <div class="nav-right">
                    <div class="entropy-badge">
                        <div class="entropy-icon">âš¡</div>
                        <span class="entropy-value">${State.game.entropy.toLocaleString()}</span>
                    </div>
                    <div class="user-profile" onclick="toggleUserMenu()">
                        <img class="user-avatar" src="${State.user?.photoURL || 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ‘¤</text></svg>'}" alt="">
                        <span class="user-name">${State.user?.displayName || 'User'}</span>
                    </div>
                </div>
            </nav>
        `;
    }
    
    // ========================================
    // LOGIN PAGE
    // ========================================
    function renderLoginPage() {
        const appEl = document.getElementById('app');
        appEl.innerHTML = `
            <div class="login-page">
                <h1 class="login-logo">BOKLUCK</h1>
                <p class="login-subtitle">Universe</p>
                
                <div class="login-cell"></div>
                
                <p class="login-story">
                    ì–¸ì œì¸ì§€, ì™œì¸ì§€ ì•Œ ìˆ˜ ì—†ë‹¤.<br>
                    ë‚˜ëŠ” ê´‘í™œí•œ ìš°ì£¼ ì–´ë”˜ê°€ì—ì„œ<br>
                    í•˜ë‚˜ì˜ <strong>ì„¸í¬</strong>ë¡œ íƒœì–´ë‚¬ë‹¤.<br><br>
                    ì‚´ì•„ë‚¨ìœ¼ë ¤ë©´ <strong>ì—”íŠ¸ë¡œí”¼</strong>ë¥¼ ëª¨ì•„ì•¼ í•œë‹¤.<br>
                    ì§„í™”í•˜ê³ , í–‰ì„±ì„ ì •ë³µí•˜ë¼.
                </p>
                
                <button class="btn btn-google btn-lg" onclick="handleGoogleLogin()">
                    <img src="https://www.google.com/favicon.ico" alt="Google">
                    Googleë¡œ ì‹œì‘í•˜ê¸°
                </button>
                
                <div class="login-divider">ë˜ëŠ”</div>
                
                <p class="text-muted" style="font-size: 13px;">
                    ê³„ì •ì´ ì—†ì–´ë„ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤
                </p>
            </div>
        `;
    }
    
    // ========================================
    // DASHBOARD PAGE
    // ========================================
    function renderDashboard() {
        const appEl = document.getElementById('app');
        const { stage, entropy, evolution } = State.game;
        
        // ì§„í™” ìƒíƒœ ê³„ì‚°
        const evolutionCount = Object.values(evolution).filter(v => v).length;
        
        appEl.innerHTML = `
            ${renderNavbar()}
            <main class="main-content">
                <div class="page-container">
                    <!-- ìŠ¤í…Œì´ì§€ ì§„í–‰ -->
                    <div class="stage-progress mb-24">
                        <div class="stage-dot ${stage >= 1 ? (stage === 1 ? 'current' : 'completed') : 'locked'}">ğŸ¦ </div>
                        <div class="stage-line ${stage > 1 ? 'completed' : ''}"></div>
                        <div class="stage-dot ${stage >= 2 ? (stage === 2 ? 'current' : 'completed') : 'locked'}">ğŸš€</div>
                        <div class="stage-line ${stage > 2 ? 'completed' : ''}"></div>
                        <div class="stage-dot ${stage >= 3 ? (stage === 3 ? 'current' : 'completed') : 'locked'}">ğŸ•ï¸</div>
                        <div class="stage-line ${stage > 3 ? 'completed' : ''}"></div>
                        <div class="stage-dot ${stage >= 4 ? (stage === 4 ? 'current' : 'completed') : 'locked'}">ğŸ›ï¸</div>
                        <div class="stage-line ${stage > 4 ? 'completed' : ''}"></div>
                        <div class="stage-dot ${stage >= 5 ? 'current' : 'locked'}">âš”ï¸</div>
                    </div>
                    
                    <div class="dashboard-grid">
                        <!-- ì—”í‹°í‹° ì¹´ë“œ -->
                        <div class="card entity-card">
                            <div class="entity-visual" id="entityVisual">
                                <!-- ìº”ë²„ìŠ¤ë¡œ ë Œë”ë§ -->
                            </div>
                            
                            <div class="entity-stage-label">STAGE ${stage} Â· ${getStageLabel(stage)}</div>
                            <div class="entity-name">Entity #${State.user?.uid?.slice(-4) || '0000'}</div>
                            
                            <div class="progress-bar mb-16">
                                <div class="progress-fill" style="width: ${getStageProgress()}%"></div>
                            </div>
                            <p class="text-muted text-center mb-24" style="font-size: 12px;">
                                ${getNextStageText()}
                            </p>
                            
                            <div class="entity-stats">
                                <div class="stat-box">
                                    <div class="stat-value">${evolutionCount}/6</div>
                                    <div class="stat-label">ì§„í™” íŒŒì¸ </div>
                                </div>
                                <div class="stat-box">
                                    <div class="stat-value">${State.game.territories?.length || 0}</div>
                                    <div class="stat-label">ë³´ìœ  ì˜í† </div>
                                </div>
                                <div class="stat-box">
                                    <div class="stat-value">+${calculateTaxIncome()}</div>
                                    <div class="stat-label">ì¼ì¼ ì„¸ê¸ˆ</div>
                                </div>
                                <div class="stat-box">
                                    <div class="stat-value">${getDaysSurvived()}</div>
                                    <div class="stat-label">ìƒì¡´ ì¼ìˆ˜</div>
                                </div>
                            </div>
                            
                            ${stage === 1 ? `
                                <button class="btn btn-primary btn-block mt-24" onclick="Router.navigate('stage1')">
                                    ğŸ® ì„¸í¬ ê²Œì„ ì‹œì‘
                                </button>
                            ` : ''}
                        </div>
                        
                        <!-- ìš°ì¸¡ ì»¨í…ì¸  -->
                        <div class="right-content">
                            <!-- í€µ ì•¡ì…˜ -->
                            <div class="quick-actions">
                                <div class="quick-action ${stage < 1 ? 'locked' : ''}" onclick="${stage >= 1 ? "Router.navigate('stage1')" : ''}">
                                    <div class="quick-action-icon">ğŸ¦ </div>
                                    <div class="quick-action-label">ì„¸í¬ ê²Œì„</div>
                                </div>
                                <div class="quick-action ${stage < 2 ? 'locked' : ''}" onclick="${stage >= 2 ? "Router.navigate('planet')" : ''}">
                                    <div class="quick-action-icon">ğŸª</div>
                                    <div class="quick-action-label">í–‰ì„± íƒí—˜</div>
                                </div>
                                <div class="quick-action ${stage < 3 ? 'locked' : ''}" onclick="${stage >= 3 ? "Router.navigate('galaxy')" : ''}">
                                    <div class="quick-action-icon">ğŸŒŒ</div>
                                    <div class="quick-action-label">ì€í•˜ ì§€ë„</div>
                                </div>
                                <div class="quick-action" onclick="Router.navigate('history')">
                                    <div class="quick-action-icon">ğŸ“œ</div>
                                    <div class="quick-action-label">ì—­ì‚¬ì„œ</div>
                                </div>
                            </div>
                            
                            <!-- ì—­ì‚¬ì„œ ë¯¸ë¦¬ë³´ê¸° -->
                            <div class="card history-preview">
                                <div class="card-header">
                                    <span class="card-title">ğŸ“œ ë‚˜ì˜ ì—­ì‚¬ì„œ</span>
                                    <button class="btn btn-outline btn-sm" onclick="Router.navigate('history')">ì „ì²´ ë³´ê¸°</button>
                                </div>
                                <div id="historyEntries">
                                    ${renderHistoryEntries()}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        `;
        
        // ì—”í‹°í‹° ìº”ë²„ìŠ¤ ë Œë”ë§
        renderEntityCanvas();
    }
    
    function getStageLabel(stage) {
        const labels = ['', 'ì„¸í¬', 'ë‚™í•˜', 'ì •ì°©', 'ë¬¸ëª…', 'ì •ë³µ'];
        return labels[stage] || '';
    }
    
    function getStageProgress() {
        const { stage, entropy, evolution } = State.game;
        if (stage === 1) {
            // ì„¸í¬ ë‹¨ê³„: 800 ì—”íŠ¸ë¡œí”¼ê°€ ëª©í‘œ
            return Math.min((entropy / 800) * 100, 100);
        }
        return 50; // ë‹¤ë¥¸ ìŠ¤í…Œì´ì§€ëŠ” ë³„ë„ ë¡œì§
    }
    
    function getNextStageText() {
        const { stage, entropy } = State.game;
        if (stage === 1) {
            if (entropy < 800) {
                return `ë‹¤ìŒ ë‹¨ê³„ê¹Œì§€ ${800 - entropy} ì—”íŠ¸ë¡œí”¼ í•„ìš”`;
            }
            return 'ğŸ‰ í–‰ì„± ë‚™í•˜ ì¤€ë¹„ ì™„ë£Œ!';
        }
        return '';
    }
    
    function calculateTaxIncome() {
        return State.game.territories?.length * 5 || 0;
    }
    
    function getDaysSurvived() {
        if (!State.userData?.createdAt) return 1;
        const created = State.userData.createdAt.toDate ? State.userData.createdAt.toDate() : new Date(State.userData.createdAt);
        const days = Math.floor((Date.now() - created.getTime()) / (1000 * 60 * 60 * 24));
        return Math.max(days, 1);
    }
    
    function renderHistoryEntries() {
        const history = State.game.history || [];
        
        if (history.length === 0) {
            return `
                <div class="text-center text-muted" style="padding: 40px;">
                    <p style="font-size: 32px; margin-bottom: 12px;">ğŸ“œ</p>
                    <p>ì•„ì§ ê¸°ë¡ëœ ì—­ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                    <p style="font-size: 12px;">ê²Œì„ì„ ì§„í–‰í•˜ë©´ ìë™ìœ¼ë¡œ ê¸°ë¡ë©ë‹ˆë‹¤</p>
                </div>
            `;
        }
        
        return history.slice(-3).reverse().map(entry => `
            <div class="history-entry">
                <div class="history-chapter">ì œ${entry.chapter}ì¥</div>
                <div class="history-title">${entry.title}</div>
                <div class="history-content">${entry.content}</div>
                <div class="history-time">${formatTime(entry.timestamp)}</div>
            </div>
        `).join('');
    }
    
    function formatTime(timestamp) {
        if (!timestamp) return '';
        const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
        return date.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' });
    }
    
    function renderEntityCanvas() {
        const container = document.getElementById('entityVisual');
        if (!container) return;
        
        const canvas = document.createElement('canvas');
        canvas.width = 180;
        canvas.height = 180;
        container.appendChild(canvas);
        
        const ctx = canvas.getContext('2d');
        const { evolution } = State.game;
        
        let time = 0;
        function animate() {
            time += 0.05;
            ctx.clearRect(0, 0, 180, 180);
            
            const cx = 90, cy = 90;
            const baseSize = 35;
            
            // ê¿ˆí‹€ê±°ë¦¬ëŠ” ëª¸ì²´
            ctx.beginPath();
            for (let i = 0; i < 12; i++) {
                const angle = (i / 12) * Math.PI * 2;
                const wobble = Math.sin(time * 2 + i) * 5;
                const r = baseSize + wobble;
                const x = cx + Math.cos(angle) * r;
                const y = cy + Math.sin(angle) * r;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.closePath();
            
            const grad = ctx.createRadialGradient(cx - 15, cy - 15, 0, cx, cy, baseSize + 10);
            grad.addColorStop(0, '#00f5d4');
            grad.addColorStop(0.6, '#7b2cbf');
            grad.addColorStop(1, '#4c1d95');
            ctx.fillStyle = grad;
            ctx.fill();
            
            // ëˆˆ
            if (evolution.eye) {
                ctx.beginPath();
                ctx.arc(cx + 12, cy - 5, 10, 0, Math.PI * 2);
                ctx.fillStyle = 'white';
                ctx.fill();
                ctx.beginPath();
                ctx.arc(cx + 14, cy - 3, 5, 0, Math.PI * 2);
                ctx.fillStyle = '#1a1a2e';
                ctx.fill();
            }
            
            // íŒ”
            if (evolution.arm) {
                ctx.strokeStyle = '#7b2cbf';
                ctx.lineWidth = 6;
                ctx.lineCap = 'round';
                ctx.beginPath();
                ctx.moveTo(cx + 35, cy);
                ctx.quadraticCurveTo(cx + 55, cy + Math.sin(time * 3) * 10, cx + 65, cy + 5);
                ctx.stroke();
            }
            
            // ë‹¤ë¦¬
            if (evolution.leg) {
                const legWobble = Math.sin(time * 4) * 8;
                ctx.strokeStyle = '#5b21b6';
                ctx.lineWidth = 8;
                ctx.beginPath();
                ctx.moveTo(cx - 10, cy + 35);
                ctx.lineTo(cx - 15 + legWobble, cy + 60);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(cx + 10, cy + 35);
                ctx.lineTo(cx + 15 - legWobble, cy + 60);
                ctx.stroke();
            }
            
            // ë‡Œ
            if (evolution.brain) {
                const glow = Math.sin(time * 2) * 0.3 + 0.7;
                ctx.beginPath();
                ctx.arc(cx, cy - 30, 12, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(254, 228, 64, ${glow})`;
                ctx.fill();
            }
            
            // ë‚ ê°œ
            if (evolution.wing) {
                const wingFlap = Math.sin(time * 5) * 0.3;
                ctx.fillStyle = 'rgba(139, 92, 246, 0.6)';
                ctx.save();
                ctx.translate(cx, cy - 10);
                ctx.rotate(wingFlap);
                ctx.beginPath();
                ctx.moveTo(5, 0);
                ctx.quadraticCurveTo(40, -30, 60, -10);
                ctx.quadraticCurveTo(40, 10, 5, 0);
                ctx.fill();
                ctx.restore();
                ctx.save();
                ctx.translate(cx, cy - 10);
                ctx.rotate(-wingFlap);
                ctx.beginPath();
                ctx.moveTo(-5, 0);
                ctx.quadraticCurveTo(-40, -30, -60, -10);
                ctx.quadraticCurveTo(-40, 10, -5, 0);
                ctx.fill();
                ctx.restore();
            }
            
            requestAnimationFrame(animate);
        }
        animate();
    }
    
    // ========================================
    // STAGE 1: CELL GAME
    // ========================================
    function renderStage1Game() {
        const appEl = document.getElementById('app');
        const canvas = document.getElementById('gameCanvas');
        
        appEl.innerHTML = `
            <div class="game-ui">
                <div class="game-entropy">
                    <div class="game-entropy-label">ENTROPY</div>
                    <div class="game-entropy-value" id="gameEntropyDisplay">${State.game.entropy}</div>
                </div>
                
                <div class="game-evolution-panel">
                    <div class="game-evo-title">ğŸ§¬ ì§„í™” ë‹¨ê³„</div>
                    <div class="game-evo-item ${State.game.evolution.eye ? 'unlocked' : (State.game.entropy >= 80 ? 'next' : '')}">
                        <div class="game-evo-icon">ğŸ‘ï¸</div>
                        <div>
                            <div class="game-evo-name">ì‹œê° ê¸°ê´€</div>
                            <div class="game-evo-req">${State.game.evolution.eye ? 'í•´ê¸ˆë¨' : '100 ì—”íŠ¸ë¡œí”¼'}</div>
                        </div>
                    </div>
                    <div class="game-evo-item ${State.game.evolution.arm ? 'unlocked' : (State.game.entropy >= 180 ? 'next' : '')}">
                        <div class="game-evo-icon">ğŸ¦¾</div>
                        <div>
                            <div class="game-evo-name">ìˆ˜ì§‘ íŒ”</div>
                            <div class="game-evo-req">${State.game.evolution.arm ? 'í•´ê¸ˆë¨' : '200 ì—”íŠ¸ë¡œí”¼'}</div>
                        </div>
                    </div>
                    <div class="game-evo-item ${State.game.evolution.leg ? 'unlocked' : (State.game.entropy >= 280 ? 'next' : '')}">
                        <div class="game-evo-icon">ğŸ¦µ</div>
                        <div>
                            <div class="game-evo-name">ì´ë™ ê¸°ê´€</div>
                            <div class="game-evo-req">${State.game.evolution.leg ? 'í•´ê¸ˆë¨' : '300 ì—”íŠ¸ë¡œí”¼'}</div>
                        </div>
                    </div>
                    <div class="game-evo-item ${State.game.evolution.brain ? 'unlocked' : (State.game.entropy >= 480 ? 'next' : '')}">
                        <div class="game-evo-icon">ğŸ§ </div>
                        <div>
                            <div class="game-evo-name">ë‘ë‡Œ</div>
                            <div class="game-evo-req">${State.game.evolution.brain ? 'í•´ê¸ˆë¨' : '500 ì—”íŠ¸ë¡œí”¼'}</div>
                        </div>
                    </div>
                    <div class="game-evo-item ${State.game.evolution.wing ? 'unlocked' : (State.game.entropy >= 780 ? 'next' : '')}">
                        <div class="game-evo-icon">ğŸª½</div>
                        <div>
                            <div class="game-evo-name">ë‚ ê°œ</div>
                            <div class="game-evo-req">${State.game.evolution.wing ? 'í•´ê¸ˆë¨' : '800 ì—”íŠ¸ë¡œí”¼'}</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="game-controls">
                <div><span class="key">W A S D</span> ì´ë™</div>
                <div><span class="key">ë§ˆìš°ìŠ¤</span> ë°©í–¥</div>
                <div><span class="key">SPACE</span> ëŒ€ì‹œ (ë‚ ê°œ)</div>
                <div><span class="key">ESC</span> ë‚˜ê°€ê¸°</div>
            </div>
        `;
        
        canvas.classList.remove('hidden');
        startCellGame(canvas);
    }
    
    function startCellGame(canvas) {
        const ctx = canvas.getContext('2d');
        
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        
        // ê²Œì„ ë³€ìˆ˜
        let gameRunning = true;
        let time = 0;
        
        const player = {
            x: 0, y: 0,
            vx: 0, vy: 0,
            baseSize: 30,
            size: 30,
            speed: 3,
            visionRange: 300,
            collectRange: 50,
            entropyMultiplier: 1,
            wobblePoints: [],
            wobblePhase: 0,
            isDashing: false,
            dashCooldown: 0
        };
        
        // ê¿ˆí‹€ê±°ë¦¼ í¬ì¸íŠ¸
        for (let i = 0; i < 12; i++) {
            player.wobblePoints.push({
                angle: (i / 12) * Math.PI * 2,
                offset: 0,
                speed: 0.5 + Math.random() * 0.5
            });
        }
        
        // ì§„í™” ìƒíƒœ ì ìš©
        function applyEvolution() {
            const evo = State.game.evolution;
            if (evo.eye) player.visionRange = 500;
            if (evo.arm) player.collectRange = 100;
            if (evo.leg) player.speed = 5;
            if (evo.brain) player.entropyMultiplier = 2;
        }
        applyEvolution();
        
        let entropyParticles = [];
        const camera = { x: 0, y: 0 };
        const keys = {};
        let mouseX = canvas.width / 2, mouseY = canvas.height / 2;
        let useMouseControl = false;
        
        // ì…ë ¥
        function handleKeyDown(e) {
            keys[e.key.toLowerCase()] = true;
            useMouseControl = false;
            
            if (e.code === 'Space' && State.game.evolution.wing && player.dashCooldown <= 0) {
                player.isDashing = true;
                player.dashCooldown = 60;
                setTimeout(() => player.isDashing = false, 200);
            }
            
            if (e.key === 'Escape') {
                gameRunning = false;
                canvas.classList.add('hidden');
                Router.navigate('dashboard');
            }
        }
        
        function handleKeyUp(e) {
            keys[e.key.toLowerCase()] = false;
        }
        
        function handleMouseMove(e) {
            mouseX = e.clientX;
            mouseY = e.clientY;
            useMouseControl = true;
        }
        
        document.addEventListener('keydown', handleKeyDown);
        document.addEventListener('keyup', handleKeyUp);
        document.addEventListener('mousemove', handleMouseMove);
        
        // ì—”íŠ¸ë¡œí”¼ ìƒì„±
        function spawnEntropy() {
            const count = State.game.evolution.eye ? 150 : 80;
            while (entropyParticles.length < count) {
                const angle = Math.random() * Math.PI * 2;
                const dist = 200 + Math.random() * (player.visionRange + 500);
                entropyParticles.push({
                    x: player.x + Math.cos(angle) * dist,
                    y: player.y + Math.sin(angle) * dist,
                    size: 5 + Math.random() * 10,
                    value: 1 + Math.floor(Math.random() * 3),
                    pulse: Math.random() * Math.PI * 2,
                    hue: 160 + Math.random() * 60
                });
            }
        }
        
        // ì§„í™” ì²´í¬
        async function checkEvolution() {
            const entropy = State.game.entropy;
            const evo = State.game.evolution;
            
            if (!evo.eye && entropy >= 100) {
                State.game.evolution.eye = true;
                player.visionRange = 500;
                showEvolutionAlert('ğŸ‘ï¸', 'ì‹œê° ê¸°ê´€ ì§„í™”!', 'ëˆˆì´ ìƒê²¨ë‚¬ìŠµë‹ˆë‹¤', 'ì‹œì•¼ ë²”ìœ„ +66%');
                await addHistoryEntry(1, 'ì²« ë²ˆì§¸ ëˆˆ', '100 ì—”íŠ¸ë¡œí”¼ë¥¼ í¡ìˆ˜í•˜ì, ì„¸ìƒì´ ë³´ì´ê¸° ì‹œì‘í–ˆë‹¤. í¬ë¯¸í•˜ë˜ ë¹›ë“¤ì´ ì„ ëª…í•´ì§€ê³ , ë” ë¨¼ ê³³ì˜ ì—ë„ˆì§€ì›ì´ ê°ì§€ë˜ì—ˆë‹¤.');
            }
            
            if (!evo.arm && entropy >= 200) {
                State.game.evolution.arm = true;
                player.collectRange = 100;
                showEvolutionAlert('ğŸ¦¾', 'ìˆ˜ì§‘ íŒ” ì§„í™”!', 'íŒ”ì´ ìƒê²¨ë‚¬ìŠµë‹ˆë‹¤', 'ìˆ˜ì§‘ ë²”ìœ„ +100%');
                await addHistoryEntry(2, 'ì²« ë²ˆì§¸ íŒ”', '200 ì—”íŠ¸ë¡œí”¼ì˜ í˜ìœ¼ë¡œ ì´‰ìˆ˜ê°€ ìë¼ë‚¬ë‹¤. ì´ì œ ë” ë©€ë¦¬ ìˆëŠ” ì—ë„ˆì§€ë„ ëŒì–´ë‹¹ê¸¸ ìˆ˜ ìˆë‹¤.');
            }
            
            if (!evo.leg && entropy >= 300) {
                State.game.evolution.leg = true;
                player.speed = 5;
                showEvolutionAlert('ğŸ¦µ', 'ì´ë™ ê¸°ê´€ ì§„í™”!', 'ë‹¤ë¦¬ê°€ ìƒê²¨ë‚¬ìŠµë‹ˆë‹¤', 'ì´ë™ ì†ë„ +66%');
                await addHistoryEntry(3, 'ì´ë™ì˜ ììœ ', '300 ì—”íŠ¸ë¡œí”¼ê°€ ëª¨ì´ì ë‹¤ë¦¬ê°€ ìƒê²¨ë‚¬ë‹¤. ë” ì´ìƒ ëŠë¦¬ê²Œ ë– ë‹¤ë‹ˆì§€ ì•Šì•„ë„ ëœë‹¤.');
            }
            
            if (!evo.brain && entropy >= 500) {
                State.game.evolution.brain = true;
                player.entropyMultiplier = 2;
                showEvolutionAlert('ğŸ§ ', 'ë‘ë‡Œ ì§„í™”!', 'ì§€ëŠ¥ì´ ë°œë‹¬í–ˆìŠµë‹ˆë‹¤', 'ì—”íŠ¸ë¡œí”¼ íšë“ 2ë°°');
                await addHistoryEntry(4, 'ì§€ì„±ì˜ ë¶ˆê½ƒ', '500 ì—”íŠ¸ë¡œí”¼... ì˜ì‹ì´ í™•ì¥ë˜ì—ˆë‹¤. ë‹¨ìˆœí•œ ìƒì¡´ ë³¸ëŠ¥ì„ ë„˜ì–´, ì‚¬ê³ í•˜ê¸° ì‹œì‘í–ˆë‹¤.');
            }
            
            if (!evo.wing && entropy >= 800) {
                State.game.evolution.wing = true;
                showEvolutionAlert('ğŸª½', 'ë‚ ê°œ ì§„í™”!', 'ë‚ ê°œê°€ ìƒê²¨ë‚¬ìŠµë‹ˆë‹¤', 'SPACEë¡œ ëŒ€ì‹œ ê°€ëŠ¥');
                await addHistoryEntry(5, 'ìš°ì£¼ë¥¼ í–¥í•´', '800 ì—”íŠ¸ë¡œí”¼ì˜ ì •ì ì—ì„œ ë‚ ê°œê°€ í¼ì³ì¡Œë‹¤. ì´ ì¢ì€ ê³µê°„ì„ ë²—ì–´ë‚˜, í–‰ì„±ì„ ì°¾ì•„ ë– ë‚  ì¤€ë¹„ê°€ ë˜ì—ˆë‹¤.');
                
                // ìŠ¤í…Œì´ì§€ 2ë¡œ ì§„í–‰ ê°€ëŠ¥
                showToast('ğŸ‰ ëª¨ë“  ì§„í™” ì™„ë£Œ! ì´ì œ í–‰ì„±ìœ¼ë¡œ ë– ë‚  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'success');
            }
            
            player.size = player.baseSize + (entropy * 0.03);
            if (player.size > 80) player.size = 80;
            
            await State.syncToFirebase();
            updateGameUI();
        }
        
        function updateGameUI() {
            const entropyDisplay = document.getElementById('gameEntropyDisplay');
            if (entropyDisplay) {
                entropyDisplay.textContent = State.game.entropy;
            }
            // ì§„í™” íŒ¨ë„ë„ ì—…ë°ì´íŠ¸...
        }
        
        // í”Œë ˆì´ì–´ ì—…ë°ì´íŠ¸
        function updatePlayer() {
            let moveX = 0, moveY = 0;
            
            if (useMouseControl) {
                const dx = mouseX - canvas.width / 2;
                const dy = mouseY - canvas.height / 2;
                const dist = Math.sqrt(dx * dx + dy * dy);
                if (dist > 20) {
                    moveX = dx / dist;
                    moveY = dy / dist;
                }
            } else {
                if (keys['w'] || keys['arrowup']) moveY = -1;
                if (keys['s'] || keys['arrowdown']) moveY = 1;
                if (keys['a'] || keys['arrowleft']) moveX = -1;
                if (keys['d'] || keys['arrowright']) moveX = 1;
                if (moveX !== 0 && moveY !== 0) {
                    moveX *= 0.707;
                    moveY *= 0.707;
                }
            }
            
            let currentSpeed = player.speed;
            if (player.isDashing) currentSpeed *= 3;
            
            player.vx = moveX * currentSpeed;
            player.vy = moveY * currentSpeed;
            player.x += player.vx;
            player.y += player.vy;
            
            if (player.dashCooldown > 0) player.dashCooldown--;
            
            camera.x += (player.x - camera.x) * 0.1;
            camera.y += (player.y - camera.y) * 0.1;
            
            player.wobblePhase += 0.1;
            player.wobblePoints.forEach((point, i) => {
                const moveFactor = Math.sqrt(player.vx * player.vx + player.vy * player.vy) * 0.5;
                point.offset = Math.sin(player.wobblePhase * point.speed + i) * (5 + moveFactor);
            });
        }
        
        // ì—”íŠ¸ë¡œí”¼ ìˆ˜ì§‘
        function collectEntropy() {
            entropyParticles = entropyParticles.filter(p => {
                const dx = p.x - player.x;
                const dy = p.y - player.y;
                const dist = Math.sqrt(dx * dx + dy * dy);
                
                if (dist < player.collectRange + p.size) {
                    State.game.entropy += p.value * player.entropyMultiplier;
                    checkEvolution();
                    return false;
                }
                
                if (State.game.evolution.arm && dist < player.collectRange * 2) {
                    p.x -= dx * 0.05;
                    p.y -= dy * 0.05;
                }
                
                return true;
            });
        }
        
        // ë°°ê²½ ë Œë”ë§
        function drawBackground() {
            const gradient = ctx.createRadialGradient(
                canvas.width / 2, canvas.height / 2, 0,
                canvas.width / 2, canvas.height / 2, canvas.width
            );
            gradient.addColorStop(0, '#0a0a1a');
            gradient.addColorStop(1, '#050510');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // ë³„
            ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
            for (let i = 0; i < 100; i++) {
                const x = ((i * 137.5 + camera.x * 0.1) % canvas.width + canvas.width) % canvas.width;
                const y = ((i * 73.7 + camera.y * 0.1) % canvas.height + canvas.height) % canvas.height;
                const size = (Math.sin(time * 0.02 + i) + 1) * 1;
                ctx.beginPath();
                ctx.arc(x, y, size, 0, Math.PI * 2);
                ctx.fill();
            }
        }
        
        // ì—”íŠ¸ë¡œí”¼ ë Œë”ë§
        function drawEntropy() {
            entropyParticles.forEach(p => {
                const screenX = canvas.width / 2 + (p.x - camera.x);
                const screenY = canvas.height / 2 + (p.y - camera.y);
                
                const distFromPlayer = Math.sqrt((p.x - player.x) ** 2 + (p.y - player.y) ** 2);
                if (distFromPlayer > player.visionRange) {
                    if (!State.game.evolution.eye) return;
                    ctx.globalAlpha = 0.3;
                } else {
                    ctx.globalAlpha = 1;
                }
                
                p.pulse += 0.05;
                const pulse = Math.sin(p.pulse) * 0.3 + 1;
                const size = p.size * pulse;
                
                const gradient = ctx.createRadialGradient(screenX, screenY, 0, screenX, screenY, size);
                gradient.addColorStop(0, `hsla(${p.hue}, 100%, 70%, 1)`);
                gradient.addColorStop(0.5, `hsla(${p.hue}, 100%, 50%, 0.8)`);
                gradient.addColorStop(1, `hsla(${p.hue}, 100%, 50%, 0)`);
                
                ctx.beginPath();
                ctx.arc(screenX, screenY, size, 0, Math.PI * 2);
                ctx.fillStyle = gradient;
                ctx.fill();
                
                ctx.globalAlpha = 1;
            });
        }
        
        // í”Œë ˆì´ì–´ ë Œë”ë§
        function drawPlayer() {
            const screenX = canvas.width / 2 + (player.x - camera.x);
            const screenY = canvas.height / 2 + (player.y - camera.y);
            
            ctx.save();
            ctx.translate(screenX, screenY);
            
            if (player.isDashing) {
                ctx.shadowColor = '#00f5d4';
                ctx.shadowBlur = 50;
            }
            
            // ëª¸ì²´
            ctx.beginPath();
            player.wobblePoints.forEach((point, i) => {
                const r = player.size + point.offset;
                const x = Math.cos(point.angle) * r;
                const y = Math.sin(point.angle) * r;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.closePath();
            
            const bodyGrad = ctx.createRadialGradient(-player.size * 0.3, -player.size * 0.3, 0, 0, 0, player.size * 1.2);
            bodyGrad.addColorStop(0, '#00f5d4');
            bodyGrad.addColorStop(0.5, '#7b2cbf');
            bodyGrad.addColorStop(1, '#4c1d95');
            ctx.fillStyle = bodyGrad;
            ctx.fill();
            
            // ëˆˆ
            if (State.game.evolution.eye) {
                const eyeX = player.size * 0.3;
                const eyeY = -player.size * 0.1;
                const eyeSize = player.size * 0.25;
                
                ctx.beginPath();
                ctx.arc(eyeX, eyeY, eyeSize, 0, Math.PI * 2);
                ctx.fillStyle = '#fff';
                ctx.fill();
                
                const lookX = player.vx * 2;
                const lookY = player.vy * 2;
                ctx.beginPath();
                ctx.arc(eyeX + lookX, eyeY + lookY, eyeSize * 0.5, 0, Math.PI * 2);
                ctx.fillStyle = '#1a1a2e';
                ctx.fill();
            }
            
            // íŒ”
            if (State.game.evolution.arm) {
                ctx.strokeStyle = '#7b2cbf';
                ctx.lineWidth = player.size * 0.15;
                ctx.lineCap = 'round';
                ctx.beginPath();
                ctx.moveTo(player.size * 0.8, 0);
                ctx.quadraticCurveTo(player.size * 1.3, player.size * 0.2, player.size * 1.5 + Math.sin(time * 0.15) * 5, player.size * 0.1);
                ctx.stroke();
            }
            
            // ë‹¤ë¦¬
            if (State.game.evolution.leg) {
                const legOffset = Math.sin(time * 0.2) * 10;
                ctx.strokeStyle = '#5b21b6';
                ctx.lineWidth = player.size * 0.18;
                ctx.beginPath();
                ctx.moveTo(player.size * 0.3, player.size * 0.8);
                ctx.lineTo(player.size * 0.2 + legOffset, player.size * 1.5);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(-player.size * 0.3, player.size * 0.8);
                ctx.lineTo(-player.size * 0.2 - legOffset, player.size * 1.5);
                ctx.stroke();
            }
            
            // ë‡Œ
            if (State.game.evolution.brain) {
                const glow = Math.sin(time * 0.1) * 0.3 + 0.7;
                ctx.beginPath();
                ctx.arc(0, -player.size * 0.5, player.size * 0.25, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(254, 228, 64, ${glow})`;
                ctx.fill();
            }
            
            // ë‚ ê°œ
            if (State.game.evolution.wing) {
                const wingFlap = Math.sin(time * 0.3) * 0.3;
                ctx.fillStyle = 'rgba(139, 92, 246, 0.6)';
                ctx.save();
                ctx.rotate(wingFlap - 0.5);
                ctx.beginPath();
                ctx.moveTo(player.size * 0.5, -player.size * 0.3);
                ctx.quadraticCurveTo(player.size * 1.5, -player.size * 0.8, player.size * 2, -player.size * 0.2);
                ctx.quadraticCurveTo(player.size * 1.5, 0, player.size * 0.5, -player.size * 0.1);
                ctx.fill();
                ctx.restore();
                ctx.save();
                ctx.scale(-1, 1);
                ctx.rotate(wingFlap - 0.5);
                ctx.beginPath();
                ctx.moveTo(player.size * 0.5, -player.size * 0.3);
                ctx.quadraticCurveTo(player.size * 1.5, -player.size * 0.8, player.size * 2, -player.size * 0.2);
                ctx.quadraticCurveTo(player.size * 1.5, 0, player.size * 0.5, -player.size * 0.1);
                ctx.fill();
                ctx.restore();
            }
            
            ctx.restore();
        }
        
        // ê²Œì„ ë£¨í”„
        function gameLoop() {
            if (!gameRunning) {
                document.removeEventListener('keydown', handleKeyDown);
                document.removeEventListener('keyup', handleKeyUp);
                document.removeEventListener('mousemove', handleMouseMove);
                return;
            }
            
            time++;
            updatePlayer();
            spawnEntropy();
            collectEntropy();
            
            drawBackground();
            drawEntropy();
            drawPlayer();
            
            requestAnimationFrame(gameLoop);
        }
        
        // ì´ˆê¸° ì—”íŠ¸ë¡œí”¼ ìƒì„±
        for (let i = 0; i < 50; i++) {
            const angle = Math.random() * Math.PI * 2;
            const dist = 50 + Math.random() * 250;
            entropyParticles.push({
                x: Math.cos(angle) * dist,
                y: Math.sin(angle) * dist,
                size: 5 + Math.random() * 10,
                value: 1 + Math.floor(Math.random() * 3),
                pulse: Math.random() * Math.PI * 2,
                hue: 160 + Math.random() * 60
            });
        }
        
        gameLoop();
    }
    
    // ========================================
    // HISTORY MANAGEMENT
    // ========================================
    async function addHistoryEntry(chapter, title, content) {
        const entry = {
            chapter,
            title,
            content,
            timestamp: new Date().toISOString()
        };
        
        State.game.history = State.game.history || [];
        State.game.history.push(entry);
        
        await State.syncToFirebase();
    }
    
    // ========================================
    // OTHER PAGES (Placeholder)
    // ========================================
    function renderStage2Game() {
        const appEl = document.getElementById('app');
        appEl.innerHTML = `
            ${renderNavbar()}
            <main class="main-content">
                <div class="page-container text-center" style="padding-top: 100px;">
                    <h1 style="font-size: 48px; margin-bottom: 24px;">ğŸš€</h1>
                    <h2 class="font-display mb-16">í–‰ì„± ë‚™í•˜</h2>
                    <p class="text-muted mb-24">Stage 2: ê°œë°œ ì¤‘...</p>
                    <button class="btn btn-outline" onclick="Router.navigate('dashboard')">ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</button>
                </div>
            </main>
        `;
    }
    
    function renderPlanetPage() {
        const appEl = document.getElementById('app');
        appEl.innerHTML = `
            ${renderNavbar()}
            <main class="main-content">
                <div class="page-container text-center" style="padding-top: 100px;">
                    <h1 style="font-size: 48px; margin-bottom: 24px;">ğŸª</h1>
                    <h2 class="font-display mb-16">í–‰ì„± íƒí—˜</h2>
                    <p class="text-muted mb-24">Stage 2 ì™„ë£Œ í›„ í•´ê¸ˆë©ë‹ˆë‹¤</p>
                    <button class="btn btn-outline" onclick="Router.navigate('dashboard')">ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</button>
                </div>
            </main>
        `;
    }
    
    function renderGalaxyPage() {
        const appEl = document.getElementById('app');
        appEl.innerHTML = `
            ${renderNavbar()}
            <main class="main-content">
                <div class="page-container text-center" style="padding-top: 100px;">
                    <h1 style="font-size: 48px; margin-bottom: 24px;">ğŸŒŒ</h1>
                    <h2 class="font-display mb-16">ì€í•˜ ì§€ë„</h2>
                    <p class="text-muted mb-24">Stage 3 ì™„ë£Œ í›„ í•´ê¸ˆë©ë‹ˆë‹¤</p>
                    <button class="btn btn-outline" onclick="Router.navigate('dashboard')">ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</button>
                </div>
            </main>
        `;
    }
    
    function renderMarketPage() {
        const appEl = document.getElementById('app');
        appEl.innerHTML = `
            ${renderNavbar()}
            <main class="main-content">
                <div class="page-container text-center" style="padding-top: 100px;">
                    <h1 style="font-size: 48px; margin-bottom: 24px;">ğŸª</h1>
                    <h2 class="font-display mb-16">íŒŒì¸  ê±°ë˜ì†Œ</h2>
                    <p class="text-muted mb-24">Stage 2 ì™„ë£Œ í›„ í•´ê¸ˆë©ë‹ˆë‹¤</p>
                    <button class="btn btn-outline" onclick="Router.navigate('dashboard')">ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</button>
                </div>
            </main>
        `;
    }
    
    function renderHistoryPage() {
        const appEl = document.getElementById('app');
        const history = State.game.history || [];
        
        appEl.innerHTML = `
            ${renderNavbar()}
            <main class="main-content">
                <div class="page-container" style="max-width: 800px;">
                    <h1 class="font-display text-center mb-8" style="font-size: 32px;">ğŸ“œ ë‚˜ì˜ ì—­ì‚¬ì„œ</h1>
                    <p class="text-muted text-center mb-24">Entity #${State.user?.uid?.slice(-4) || '0000'}ì˜ ì—¬ì •</p>
                    
                    ${history.length === 0 ? `
                        <div class="card text-center" style="padding: 60px;">
                            <p style="font-size: 48px; margin-bottom: 16px;">ğŸ“œ</p>
                            <p class="mb-8">ì•„ì§ ê¸°ë¡ëœ ì—­ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                            <p class="text-muted" style="font-size: 13px;">ì„¸í¬ ê²Œì„ì„ ì§„í–‰í•˜ë©´ ìë™ìœ¼ë¡œ ê¸°ë¡ë©ë‹ˆë‹¤</p>
                            <button class="btn btn-primary mt-24" onclick="Router.navigate('stage1')">ì„¸í¬ ê²Œì„ ì‹œì‘</button>
                        </div>
                    ` : `
                        <div class="history-timeline">
                            ${history.map(entry => `
                                <div class="card mb-16">
                                    <div class="history-chapter">ì œ${entry.chapter}ì¥</div>
                                    <h3 class="history-title" style="font-size: 18px;">${entry.title}</h3>
                                    <p class="history-content" style="margin-top: 12px; line-height: 1.8;">${entry.content}</p>
                                    <p class="history-time">${formatTime(entry.timestamp)}</p>
                                </div>
                            `).join('')}
                        </div>
                    `}
                </div>
            </main>
        `;
    }
    
    // ========================================
    // AUTH
    // ========================================
    async function handleGoogleLogin() {
        try {
            showLoading();
            const result = await signInWithPopup(auth, googleProvider);
            const user = result.user;
            
            // ìƒˆ ìœ ì €ì¸ì§€ í™•ì¸
            const userDoc = await getDoc(doc(db, 'users', user.uid));
            
            if (!userDoc.exists()) {
                // ìƒˆ ìœ ì € ìƒì„±
                await setDoc(doc(db, 'users', user.uid), {
                    displayName: user.displayName,
                    email: user.email,
                    photoURL: user.photoURL,
                    game: {
                        entropy: 0,
                        stage: 1,
                        evolution: { eye: false, arm: false, leg: false, brain: false, wing: false },
                        currentPlanet: null,
                        territories: [],
                        history: []
                    },
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                });
                
                showToast('ğŸ‰ ìš°ì£¼ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!', 'success');
            }
            
        } catch (error) {
            console.error('Login error:', error);
            showToast('ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + error.message, 'error');
            hideLoading();
        }
    }
    
    window.handleGoogleLogin = handleGoogleLogin;
    
    async function handleLogout() {
        await signOut(auth);
        State.user = null;
        State.userData = null;
        Router.navigate('login');
    }
    
    window.handleLogout = handleLogout;
    
    // ========================================
    // INIT
    // ========================================
    async function init() {
        createStars();
        Router.init();
        
        // ì¸ì¦ ìƒíƒœ ê°ì§€
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                State.user = user;
                await State.loadFromFirebase();
                hideLoading();
                Router.navigate('dashboard');
            } else {
                State.user = null;
                hideLoading();
                Router.navigate('login');
            }
        });
        
        // ì „ì—­ í•¨ìˆ˜ ë“±ë¡
        window.Router = Router;
        window.State = State;
        window.showToast = showToast;
    }
    
    init();
    </script>
</body>
</html>
