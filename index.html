<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOKLUCK Universe</title>
    <meta name="description" content="ìš°ì£¼ì—ì„œ ê¹¨ì–´ë‚œ ì˜ì‹, ì‚´ì•„ë‚¨ì•„ ì§„í™”í•˜ë¼">
    <meta name="theme-color" content="#0a0a1a">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸŒŒ</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    :root {
        --primary: #00f5d4;
        --secondary: #7b2cbf;
        --accent: #f72585;
        --energy: #fee440;
        --success: #10b981;
        --danger: #ff4d6d;
        --bg-space: #0a0a1a;
        --bg-card: rgba(20, 20, 40, 0.9);
        --bg-card-solid: #14142a;
        --bg-hover: rgba(30, 30, 60, 0.9);
        --bg-input: rgba(10, 10, 30, 0.8);
        --border: rgba(0, 245, 212, 0.2);
        --text: #e0e0ff;
        --text-muted: #8080a0;
        --text-dark: #4a4a6a;
        --gradient-cosmic: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f72585 100%);
        --gradient-energy: linear-gradient(135deg, #00f5d4 0%, #fee440 100%);
        --gradient-evolution: linear-gradient(135deg, #7b2cbf 0%, #f72585 100%);
        --nav-height: 60px;
    }
    
    body {
        background: var(--bg-space);
        color: var(--text);
        font-family: 'Noto Sans KR', sans-serif;
        min-height: 100vh;
        overflow-x: hidden;
    }
    
    .font-display { font-family: 'Orbitron', sans-serif; }
    
    #space-bg {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: 
            radial-gradient(ellipse at 20% 80%, rgba(123, 44, 191, 0.15) 0%, transparent 50%),
            radial-gradient(ellipse at 80% 20%, rgba(247, 37, 133, 0.1) 0%, transparent 50%),
            var(--bg-space);
        z-index: -2;
    }
    
    #stars {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        z-index: -1;
        pointer-events: none;
    }
    
    .star {
        position: absolute;
        background: white;
        border-radius: 50%;
        animation: twinkle 3s infinite;
    }
    
    @keyframes twinkle {
        0%, 100% { opacity: 0.3; }
        50% { opacity: 1; }
    }
    
    .loading-screen {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: var(--bg-space);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 3000;
    }
    
    .loading-screen.hidden { display: none; }
    
    .loading-spinner {
        width: 60px; height: 60px;
        border: 3px solid var(--border);
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
    }
    
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .loading-text {
        font-family: 'Orbitron', sans-serif;
        font-size: 14px;
        color: var(--text-muted);
        letter-spacing: 2px;
    }
    
    /* Navbar */
    .navbar {
        position: fixed;
        top: 0; left: 0; right: 0;
        height: var(--nav-height);
        background: rgba(10, 10, 26, 0.95);
        backdrop-filter: blur(20px);
        border-bottom: 1px solid var(--border);
        z-index: 1000;
        display: flex;
        align-items: center;
        padding: 0 24px;
    }
    
    .nav-logo {
        font-family: 'Orbitron', sans-serif;
        font-size: 22px;
        font-weight: 900;
        background: var(--gradient-energy);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        cursor: pointer;
        margin-right: 40px;
    }
    
    .nav-links { display: flex; gap: 8px; flex: 1; }
    
    .nav-link {
        padding: 10px 18px;
        border-radius: 10px;
        color: var(--text-muted);
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: 0.2s;
    }
    
    .nav-link:hover { color: var(--text); background: var(--bg-hover); }
    .nav-link.active { color: var(--primary); background: rgba(0, 245, 212, 0.1); }
    .nav-link.locked { opacity: 0.4; cursor: not-allowed; }
    
    .nav-right { display: flex; align-items: center; gap: 16px; }
    
    .entropy-badge {
        display: flex;
        align-items: center;
        gap: 10px;
        background: var(--bg-card);
        border: 1px solid var(--border);
        padding: 8px 16px;
        border-radius: 25px;
    }
    
    .entropy-icon {
        width: 24px; height: 24px;
        background: var(--gradient-energy);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
    }
    
    .entropy-value {
        font-family: 'Orbitron', sans-serif;
        font-size: 16px;
        font-weight: 700;
        color: var(--energy);
    }
    
    .user-menu { position: relative; }
    
    .user-profile {
        display: flex;
        align-items: center;
        gap: 12px;
        cursor: pointer;
        padding: 6px 12px;
        border-radius: 25px;
    }
    
    .user-profile:hover { background: var(--bg-hover); }
    
    .user-avatar {
        width: 36px; height: 36px;
        border-radius: 50%;
        border: 2px solid var(--primary);
    }
    
    .user-name { font-size: 14px; font-weight: 600; }
    
    .user-dropdown {
        position: absolute;
        top: 100%;
        right: 0;
        margin-top: 8px;
        background: var(--bg-card-solid);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 8px;
        min-width: 160px;
        display: none;
        z-index: 1001;
    }
    
    .user-dropdown.show { display: block; }
    
    .dropdown-item {
        padding: 10px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .dropdown-item:hover { background: var(--bg-hover); }
    .dropdown-item.danger { color: var(--danger); }
    
    .main-content {
        padding-top: var(--nav-height);
        min-height: 100vh;
    }
    
    .page-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 24px;
    }
    
    /* Buttons */
    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 12px 24px;
        border: none;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: 0.2s;
        font-family: inherit;
    }
    
    .btn:hover { transform: translateY(-2px); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    
    .btn-primary { background: var(--gradient-cosmic); color: white; }
    .btn-energy { background: var(--gradient-energy); color: #1a1a2e; }
    .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
    .btn-outline:hover { border-color: var(--primary); color: var(--primary); }
    .btn-danger { background: var(--danger); color: white; }
    .btn-success { background: var(--success); color: white; }
    
    .btn-google {
        background: white;
        color: #333;
        padding: 14px 32px;
        font-size: 15px;
    }
    .btn-google img { width: 20px; height: 20px; }
    
    .btn-lg { padding: 16px 40px; font-size: 16px; }
    .btn-sm { padding: 8px 16px; font-size: 13px; }
    .btn-block { width: 100%; }
    
    /* Input */
    .input {
        width: 100%;
        padding: 12px 16px;
        background: var(--bg-input);
        border: 1px solid var(--border);
        border-radius: 12px;
        color: var(--text);
        font-size: 14px;
        font-family: inherit;
        outline: none;
        transition: 0.2s;
    }
    
    .input:focus { border-color: var(--primary); }
    .input::placeholder { color: var(--text-dark); }
    
    .input-group { margin-bottom: 16px; }
    .input-label { display: block; font-size: 13px; color: var(--text-muted); margin-bottom: 8px; }
    
    /* Cards */
    .card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 20px;
        padding: 24px;
    }
    
    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--border);
    }
    
    .card-title {
        font-family: 'Orbitron', sans-serif;
        font-size: 16px;
        font-weight: 700;
    }
    
    /* Progress */
    .progress-bar {
        height: 8px;
        background: rgba(123, 44, 191, 0.2);
        border-radius: 4px;
        overflow: hidden;
    }
    
    .progress-fill {
        height: 100%;
        background: var(--gradient-evolution);
        border-radius: 4px;
        transition: width 0.3s;
    }
    
    .stage-progress {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 16px 20px;
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 30px;
        overflow-x: auto;
    }
    
    .stage-dot {
        width: 32px; height: 32px;
        min-width: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        background: var(--bg-input);
        border: 2px solid var(--border);
    }
    
    .stage-dot.completed { background: var(--gradient-energy); border-color: var(--energy); }
    .stage-dot.current { background: var(--gradient-evolution); border-color: var(--accent); }
    .stage-dot.locked { opacity: 0.4; }
    
    .stage-line { flex: 1; height: 2px; background: var(--border); min-width: 20px; max-width: 30px; }
    .stage-line.completed { background: var(--gradient-energy); }
    
    /* Modal */
    .modal-overlay {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0, 0, 0, 0.85);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        backdrop-filter: blur(5px);
    }
    
    .modal-overlay.active { display: flex; }
    
    .modal {
        background: var(--bg-card-solid);
        border: 1px solid var(--border);
        border-radius: 24px;
        padding: 32px;
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
    }
    
    .modal-title {
        font-family: 'Orbitron', sans-serif;
        font-size: 20px;
        font-weight: 700;
        margin-bottom: 8px;
        text-align: center;
    }
    
    .modal-desc {
        color: var(--text-muted);
        font-size: 14px;
        margin-bottom: 24px;
        text-align: center;
        line-height: 1.6;
    }
    
    .modal-preview { display: flex; justify-content: center; margin-bottom: 24px; }
    .modal-actions { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }
    
    /* Toast */
    .toast-container {
        position: fixed;
        top: 80px;
        right: 24px;
        z-index: 2000;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    
    .toast {
        background: var(--bg-card-solid);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px 20px;
        display: flex;
        align-items: center;
        gap: 12px;
        min-width: 300px;
        animation: slideIn 0.3s ease;
    }
    
    .toast.success { border-color: var(--success); }
    .toast.error { border-color: var(--danger); }
    
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    
    /* Login */
    .login-page {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 40px 20px;
        text-align: center;
    }
    
    .login-logo {
        font-family: 'Orbitron', sans-serif;
        font-size: 56px;
        font-weight: 900;
        background: var(--gradient-energy);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 8px;
    }
    
    .login-subtitle { font-size: 18px; color: var(--text-muted); margin-bottom: 40px; }
    .login-cell { width: 150px; height: 150px; margin-bottom: 40px; }
    
    .login-story {
        max-width: 400px;
        font-size: 15px;
        color: var(--text-muted);
        line-height: 1.8;
        margin-bottom: 40px;
    }
    
    .login-story strong { color: var(--primary); }
    
    .login-divider {
        display: flex;
        align-items: center;
        gap: 16px;
        margin: 24px 0;
        color: var(--text-dark);
        font-size: 13px;
    }
    
    .login-divider::before, .login-divider::after {
        content: '';
        flex: 1;
        height: 1px;
        background: var(--border);
    }
    
    /* Dashboard */
    .dashboard-grid {
        display: grid;
        grid-template-columns: 320px 1fr;
        gap: 24px;
    }
    
    @media (max-width: 1024px) { .dashboard-grid { grid-template-columns: 1fr; } }
    
    .entity-card { position: relative; overflow: hidden; }
    .entity-card::before {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0;
        height: 3px;
        background: var(--gradient-evolution);
    }
    
    .entity-visual {
        width: 180px; height: 180px;
        margin: 0 auto 16px;
        cursor: pointer;
        position: relative;
    }
    
    .entity-visual:hover::after {
        content: 'âœï¸ ìˆ˜ì •';
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.8);
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
    }
    
    .entity-stage-label {
        font-family: 'Orbitron', sans-serif;
        font-size: 11px;
        color: var(--accent);
        letter-spacing: 2px;
        text-align: center;
        margin-bottom: 8px;
    }
    
    .entity-name {
        font-family: 'Orbitron', sans-serif;
        font-size: 18px;
        font-weight: 700;
        text-align: center;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }
    
    .entity-name .edit-btn {
        background: none;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        font-size: 14px;
        padding: 4px;
        border-radius: 4px;
    }
    
    .entity-name .edit-btn:hover { color: var(--primary); background: var(--bg-hover); }
    
    .entity-id {
        font-size: 12px;
        color: var(--text-dark);
        text-align: center;
        margin-bottom: 20px;
    }
    
    .entity-stats {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }
    
    .stat-box {
        background: rgba(0, 245, 212, 0.05);
        border: 1px solid rgba(0, 245, 212, 0.1);
        border-radius: 12px;
        padding: 12px;
        text-align: center;
    }
    
    .stat-value {
        font-family: 'Orbitron', sans-serif;
        font-size: 20px;
        font-weight: 700;
        color: var(--primary);
    }
    
    .stat-label { font-size: 11px; color: var(--text-muted); margin-top: 4px; }
    
    .quick-actions {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
        margin-bottom: 24px;
    }
    
    @media (max-width: 768px) { .quick-actions { grid-template-columns: repeat(2, 1fr); } }
    
    .quick-action {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: 0.2s;
    }
    
    .quick-action:hover { border-color: var(--primary); transform: translateY(-4px); }
    .quick-action.locked { opacity: 0.4; cursor: not-allowed; }
    .quick-action.locked:hover { transform: none; border-color: var(--border); }
    
    .quick-action-icon { font-size: 28px; margin-bottom: 8px; }
    .quick-action-label { font-size: 12px; color: var(--text-muted); }
    
    /* History */
    .history-entry {
        background: var(--bg-input);
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 12px;
        border-left: 3px solid var(--secondary);
    }
    
    .history-chapter {
        font-family: 'Orbitron', sans-serif;
        font-size: 11px;
        color: var(--accent);
        margin-bottom: 6px;
    }
    
    .history-title { font-weight: 700; margin-bottom: 8px; }
    .history-content { font-size: 13px; color: var(--text-muted); line-height: 1.6; }
    
    /* Cell Customization */
    .cell-customizer {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
        margin-bottom: 24px;
    }
    
    .color-picker-group { display: flex; flex-direction: column; gap: 8px; }
    .color-picker-label { font-size: 12px; color: var(--text-muted); }
    
    .color-picker {
        width: 100%;
        height: 40px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        background: var(--bg-input);
    }
    
    .pattern-selector {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
    }
    
    .pattern-option {
        padding: 10px;
        background: var(--bg-input);
        border: 2px solid var(--border);
        border-radius: 8px;
        cursor: pointer;
        text-align: center;
        font-size: 12px;
        transition: 0.2s;
    }
    
    .pattern-option:hover { border-color: var(--primary); }
    .pattern-option.selected { border-color: var(--primary); background: rgba(0, 245, 212, 0.1); }
    
    .randomize-btn { width: 100%; margin-top: 16px; }
    
    /* World Canvas */
    #worldCanvas {
        position: fixed;
        top: 0; left: 0;
        width: 100vw; height: 100vh;
        z-index: 500;
        display: none;
    }
    
    #worldCanvas.active { display: block; }
    
    /* World UI */
    .world-ui {
        position: fixed;
        top: 0; left: 0; right: 0;
        padding: 20px;
        display: none;
        justify-content: space-between;
        align-items: flex-start;
        z-index: 600;
        pointer-events: none;
    }
    
    .world-ui.active { display: flex; }
    .world-ui > * { pointer-events: auto; }
    
    .world-left { display: flex; flex-direction: column; gap: 12px; }
    
    .world-entropy-box {
        background: rgba(10, 10, 26, 0.9);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 16px 24px;
        backdrop-filter: blur(10px);
    }
    
    .world-entropy-label {
        font-family: 'Orbitron', sans-serif;
        font-size: 11px;
        color: var(--text-muted);
        letter-spacing: 2px;
    }
    
    .world-entropy-value {
        font-family: 'Orbitron', sans-serif;
        font-size: 32px;
        font-weight: 900;
        background: var(--gradient-energy);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    
    .world-nav-buttons { display: flex; gap: 8px; flex-wrap: wrap; }
    
    .world-nav-btn {
        background: rgba(10, 10, 26, 0.9);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 10px 16px;
        color: var(--text);
        font-size: 13px;
        cursor: pointer;
        backdrop-filter: blur(10px);
        display: flex;
        align-items: center;
        gap: 6px;
        transition: 0.2s;
    }
    
    .world-nav-btn:hover { border-color: var(--primary); color: var(--primary); }
    
    .world-nav-btn.next-stage {
        background: var(--gradient-energy);
        color: #1a1a2e;
        border: none;
        font-weight: 700;
    }
    
    .world-nav-btn.next-stage:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .world-info-panel {
        background: rgba(10, 10, 26, 0.9);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 16px 20px;
        backdrop-filter: blur(10px);
        min-width: 200px;
    }
    
    .world-info-title {
        font-family: 'Orbitron', sans-serif;
        font-size: 12px;
        color: var(--secondary);
        margin-bottom: 12px;
    }
    
    .world-controls {
        position: fixed;
        bottom: 20px; right: 20px;
        background: rgba(10, 10, 26, 0.9);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px 16px;
        font-size: 11px;
        color: var(--text-dark);
        z-index: 600;
        display: none;
    }
    
    .world-controls.active { display: block; }
    .world-controls div { margin-bottom: 4px; }
    .world-controls .key {
        display: inline-block;
        padding: 2px 8px;
        background: var(--bg-input);
        border-radius: 4px;
        margin-right: 4px;
    }
    
    /* Encounter Dialog */
    .encounter-dialog {
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(10, 10, 26, 0.95);
        border: 2px solid var(--secondary);
        border-radius: 20px;
        padding: 24px 32px;
        text-align: center;
        z-index: 700;
        min-width: 400px;
        display: none;
    }
    
    .encounter-dialog.active { display: block; }
    
    .encounter-title {
        font-family: 'Orbitron', sans-serif;
        font-size: 16px;
        margin-bottom: 8px;
    }
    
    .encounter-desc {
        font-size: 14px;
        color: var(--text-muted);
        margin-bottom: 16px;
        line-height: 1.6;
    }
    
    .encounter-choices {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
    }
    
    .encounter-choice {
        padding: 12px 16px;
        background: var(--bg-input);
        border: 1px solid var(--border);
        border-radius: 10px;
        cursor: pointer;
        transition: 0.2s;
        font-size: 13px;
    }
    
    .encounter-choice:hover {
        border-color: var(--primary);
        background: rgba(0, 245, 212, 0.1);
    }
    
    .encounter-choice .choice-title { font-weight: 700; margin-bottom: 4px; }
    .encounter-choice .choice-effect { font-size: 11px; color: var(--text-muted); }
    
    /* Signal Puzzle */
    .puzzle-container {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
        margin: 24px 0;
    }
    
    .puzzle-cell {
        aspect-ratio: 1;
        background: var(--bg-input);
        border: 2px solid var(--border);
        border-radius: 8px;
        cursor: pointer;
        transition: 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
    }
    
    .puzzle-cell:hover { border-color: var(--primary); }
    .puzzle-cell.active { background: var(--primary); border-color: var(--primary); }
    .puzzle-cell.correct { background: var(--success); border-color: var(--success); }
    .puzzle-cell.wrong { background: var(--danger); border-color: var(--danger); }
    
    /* Resource Bar */
    .resource-bar {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 12px;
    }
    
    .resource-icon { font-size: 20px; }
    .resource-name { font-size: 13px; flex: 1; }
    .resource-value {
        font-family: 'Orbitron', sans-serif;
        font-size: 14px;
        color: var(--primary);
    }
    
    .resource-progress {
        width: 100px;
        height: 8px;
        background: var(--bg-input);
        border-radius: 4px;
        overflow: hidden;
    }
    
    .resource-progress-fill {
        height: 100%;
        background: var(--gradient-energy);
        transition: width 0.3s;
    }
    
    /* Planet Grid */
    .planet-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
        gap: 4px;
        background: var(--bg-input);
        padding: 16px;
        border-radius: 16px;
        margin-bottom: 24px;
    }
    
    .territory-cell {
        aspect-ratio: 1;
        background: rgba(0, 245, 212, 0.05);
        border: 1px solid var(--border);
        border-radius: 4px;
        cursor: pointer;
        transition: 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
    }
    
    .territory-cell:hover { border-color: var(--primary); background: rgba(0, 245, 212, 0.1); }
    .territory-cell.owned { background: rgba(0, 245, 212, 0.2); border-color: var(--primary); }
    
    /* Evolution Alert */
    .evo-alert {
        position: fixed;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%) scale(0);
        background: rgba(10, 10, 26, 0.95);
        border: 2px solid var(--secondary);
        border-radius: 24px;
        padding: 40px 60px;
        text-align: center;
        z-index: 700;
        opacity: 0;
        transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    
    .evo-alert.show { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    .evo-alert-icon { font-size: 64px; margin-bottom: 16px; }
    
    .evo-alert-title {
        font-family: 'Orbitron', sans-serif;
        font-size: 24px;
        font-weight: 900;
        background: var(--gradient-energy);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 8px;
    }
    
    .evo-alert-desc { font-size: 14px; color: var(--text-muted); margin-bottom: 12px; }
    
    .evo-alert-effect {
        padding: 10px 20px;
        background: rgba(0, 245, 212, 0.1);
        border-radius: 20px;
        font-size: 13px;
        color: var(--primary);
    }
    
    /* Story Overlay */
    .story-overlay {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0, 0, 0, 0.9);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 800;
    }
    
    .story-overlay.active { display: flex; }
    
    .story-content {
        max-width: 600px;
        text-align: center;
        padding: 40px;
    }
    
    .story-icon { font-size: 80px; margin-bottom: 24px; }
    
    .story-title {
        font-family: 'Orbitron', sans-serif;
        font-size: 32px;
        font-weight: 900;
        margin-bottom: 16px;
        background: var(--gradient-energy);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    
    .story-text {
        font-size: 16px;
        line-height: 1.8;
        color: var(--text-muted);
        margin-bottom: 32px;
    }
    
    .story-text strong { color: var(--primary); }
    
    /* Utilities */
    .hidden { display: none !important; }
    .text-center { text-align: center; }
    .text-muted { color: var(--text-muted); }
    .mb-8 { margin-bottom: 8px; }
    .mb-16 { margin-bottom: 16px; }
    .mb-24 { margin-bottom: 24px; }
    .mt-16 { margin-top: 16px; }
    .mt-24 { margin-top: 24px; }
    </style>
</head>
<body>
    <div id="space-bg"></div>
    <div id="stars"></div>
    
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
        <div class="loading-text">INITIALIZING...</div>
    </div>
    
    <div id="app"></div>
    <canvas id="worldCanvas"></canvas>
    
    <!-- World UI Panels -->
    <div class="world-ui" id="worldUI">
        <div class="world-left">
            <div class="world-entropy-box">
                <div class="world-entropy-label" id="worldStatLabel">ENTROPY</div>
                <div class="world-entropy-value" id="worldStatValue">0</div>
            </div>
            <div class="world-nav-buttons" id="worldNavButtons"></div>
        </div>
        <div class="world-info-panel" id="worldInfoPanel"></div>
    </div>
    
    <div class="world-controls" id="worldControls"></div>
    
    <!-- Encounter Dialog -->
    <div class="encounter-dialog" id="encounterDialog">
        <div class="encounter-title" id="encounterTitle">ì¡°ìš°</div>
        <div class="encounter-desc" id="encounterDesc">ì„¤ëª…</div>
        <div class="encounter-choices" id="encounterChoices"></div>
    </div>
    
    <!-- Story Overlay -->
    <div class="story-overlay" id="storyOverlay">
        <div class="story-content">
            <div class="story-icon" id="storyIcon">ğŸŒŒ</div>
            <div class="story-title" id="storyTitle">ì œëª©</div>
            <div class="story-text" id="storyText">ë‚´ìš©</div>
            <button class="btn btn-energy btn-lg" id="storyBtn" onclick="window.closeStory()">ê³„ì†</button>
        </div>
    </div>
    
    <!-- Modals -->
    <div class="modal-overlay" id="editCellModal">
        <div class="modal">
            <h2 class="modal-title">ğŸ§¬ ì„¸í¬ ì»¤ìŠ¤í„°ë§ˆì´ì§•</h2>
            <p class="modal-desc">ë‚˜ë§Œì˜ ì„¸í¬ë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”</p>
            <div class="modal-preview"><canvas id="cellPreview" width="150" height="150"></canvas></div>
            <div class="input-group">
                <label class="input-label">ì„¸í¬ ì´ë¦„</label>
                <input type="text" class="input" id="cellNameInput" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="20">
            </div>
            <div class="cell-customizer">
                <div class="color-picker-group">
                    <label class="color-picker-label">ì£¼ ìƒ‰ìƒ</label>
                    <input type="color" class="color-picker" id="primaryColorPicker" value="#00f5d4">
                </div>
                <div class="color-picker-group">
                    <label class="color-picker-label">ë³´ì¡° ìƒ‰ìƒ</label>
                    <input type="color" class="color-picker" id="secondaryColorPicker" value="#7b2cbf">
                </div>
            </div>
            <div class="input-group">
                <label class="input-label">íŒ¨í„´</label>
                <div class="pattern-selector" id="patternSelector">
                    <div class="pattern-option selected" data-pattern="none">ì—†ìŒ</div>
                    <div class="pattern-option" data-pattern="spots">ì ë°•ì´</div>
                    <div class="pattern-option" data-pattern="stripes">ì¤„ë¬´ëŠ¬</div>
                    <div class="pattern-option" data-pattern="glow">ë°œê´‘</div>
                </div>
            </div>
            <button class="btn btn-outline randomize-btn" onclick="window.randomizeCellDesign()">ğŸ² ëœë¤ ìƒì„±</button>
            <div class="modal-actions mt-24">
                <button class="btn btn-outline" onclick="window.closeEditModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="window.saveCellDesign()">ì €ì¥</button>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="puzzleModal">
        <div class="modal">
            <h2 class="modal-title">ğŸ“¡ ì‹ í˜¸ í•´ë…</h2>
            <p class="modal-desc" id="puzzleDesc">íŒ¨í„´ì„ ë”°ë¼ ìˆœì„œëŒ€ë¡œ í´ë¦­í•˜ì„¸ìš”</p>
            <div class="puzzle-container" id="puzzleContainer"></div>
            <p class="text-muted text-center" id="puzzleStatus">íŒ¨í„´ì„ ê¸°ì–µí•˜ì„¸ìš”...</p>
            <div class="modal-actions mt-24">
                <button class="btn btn-outline" onclick="window.closePuzzleModal()">ë‚˜ì¤‘ì—</button>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="resultModal">
        <div class="modal">
            <div class="modal-preview"><span style="font-size:80px" id="resultIcon">ğŸª</span></div>
            <h2 class="modal-title" id="resultTitle">ê²°ê³¼</h2>
            <p class="modal-desc" id="resultDesc">ì„¤ëª…</p>
            <div class="modal-actions" id="resultActions"></div>
        </div>
    </div>
    
    <div class="toast-container" id="toastContainer"></div>
    
    <div class="evo-alert" id="evoAlert">
        <div class="evo-alert-icon" id="evoAlertIcon">ğŸ‘ï¸</div>
        <div class="evo-alert-title" id="evoAlertTitle">ì§„í™”!</div>
        <div class="evo-alert-desc" id="evoAlertDesc">ìƒˆë¡œìš´ ëŠ¥ë ¥</div>
        <div class="evo-alert-effect" id="evoAlertEffect">íš¨ê³¼</div>
    </div>
    
    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, addDoc, query, where, orderBy, limit, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    
    const firebaseConfig = {
        apiKey: "AIzaSyBwQjuqgWM4YKnqu_gzNbeCg5alrC-jVcQ",
        authDomain: "myco-737a0.firebaseapp.com",
        projectId: "myco-737a0",
        storageBucket: "myco-737a0.firebasestorage.app",
        messagingSenderId: "942571332540",
        appId: "1:942571332540:web:be0bb6fbdd32655501c1b9"
    };
    
    const fbApp = initializeApp(firebaseConfig);
    const db = getFirestore(fbApp);
    const auth = getAuth(fbApp);
    const googleProvider = new GoogleAuthProvider();
    
    // ========================================
    // CONSTANTS
    // ========================================
    const STAGES = {
        CELL: 1,
        DRIFT: 1.5,
        LANDING: 2,
        PLANET: 3,
        SIGNAL: 3.5,
        GALAXY: 4,
        CONQUEST: 5
    };
    
    const STAGE_NAMES = {
        1: 'ì„¸í¬',
        1.5: 'í‘œë¥˜',
        2: 'ë‚™í•˜',
        3: 'ì •ì°©',
        3.5: 'ì‹ í˜¸',
        4: 'ì€í•˜',
        5: 'ì •ë³µ'
    };
    
    const PLANET_NAMES = ['Kepler-22b', 'Proxima-B', 'Trappist-1e', 'Gliese-581g', 'HD-40307g', 'Tau-Ceti-e', 'Wolf-1061c', 'Ross-128b'];
    const PLANET_TYPES = ['ìƒëª…ì²´ ì„œì‹ ê°€ëŠ¥ í–‰ì„±', 'ì–¼ìŒ í–‰ì„±', 'ì‚¬ë§‰ í–‰ì„±', 'í•´ì–‘ í–‰ì„±', 'í™”ì‚° í–‰ì„±', 'ê³ ëŒ€ ë¬¸ëª… í”ì  í–‰ì„±'];
    
    // Cell Design Generator
    function generateCellDesign() {
        const hue1 = Math.floor(Math.random() * 360);
        const hue2 = (hue1 + 60 + Math.floor(Math.random() * 120)) % 360;
        const patterns = ['none', 'spots', 'stripes', 'glow'];
        const adjectives = ['ë¹›ë‚˜ëŠ”', 'ì–´ë‘ ì˜', 'ê³ ëŒ€ì˜', 'ì‹ ë¹„ë¡œìš´', 'ì˜ì›í•œ', 'ìŠí˜€ì§„', 'ê¹¨ì–´ë‚œ', 'ë– ë„ëŠ”'];
        const nouns = ['ì˜ì‹', 'ì„¸í¬', 'ì¡´ì¬', 'ì˜í˜¼', 'íŒŒë™', 'ì—ë„ˆì§€', 'ìƒëª…ì²´', 'íƒí—˜ê°€'];
        
        return {
            name: adjectives[Math.floor(Math.random() * adjectives.length)] + ' ' + nouns[Math.floor(Math.random() * nouns.length)],
            primaryColor: `hsl(${hue1}, 80%, 60%)`,
            secondaryColor: `hsl(${hue2}, 70%, 40%)`,
            pattern: patterns[Math.floor(Math.random() * patterns.length)],
            wobblePoints: 8 + Math.floor(Math.random() * 6),
            wobbleIntensity: 0.5 + Math.random() * 0.5,
            glowIntensity: 0.3 + Math.random() * 0.5
        };
    }
    
    function hslToHex(hsl) {
        const match = hsl.match(/hsl\((\d+),\s*(\d+)%,\s*(\d+)%\)/);
        if (!match) return hsl;
        let h = parseInt(match[1]) / 360, s = parseInt(match[2]) / 100, l = parseInt(match[3]) / 100;
        let r, g, b;
        if (s === 0) { r = g = b = l; }
        else {
            const hue2rgb = (p, q, t) => { if (t < 0) t += 1; if (t > 1) t -= 1; if (t < 1/6) return p + (q - p) * 6 * t; if (t < 1/2) return q; if (t < 2/3) return p + (q - p) * (2/3 - t) * 6; return p; };
            const qq = l < 0.5 ? l * (1 + s) : l + s - l * s;
            const p = 2 * l - qq;
            r = hue2rgb(p, qq, h + 1/3); g = hue2rgb(p, qq, h); b = hue2rgb(p, qq, h - 1/3);
        }
        const toHex = x => { const hex = Math.round(x * 255).toString(16); return hex.length === 1 ? '0' + hex : hex; };
        return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
    }
    
    // State
    const State = {
        user: null,
        userData: null,
        currentPage: 'login',
        game: {
            entropy: 0,
            stage: 1,
            evolution: { eye: false, arm: false, leg: false, brain: false, wing: false },
            currentPlanet: null,
            territories: [],
            history: [],
            cellDesign: null,
            driftProgress: 0,
            mergedCells: 0,
            resources: { metal: 0, energy: 0, fuel: 0 },
            signalDecoded: false,
            shipBuilt: false,
            firstContact: null
        },
        
        async sync() {
            if (!this.user) return;
            try {
                await updateDoc(doc(db, 'users', this.user.uid), { game: this.game, updatedAt: serverTimestamp() });
            } catch (e) { console.error('Sync error:', e); }
        },
        
        async load() {
            if (!this.user) return;
            try {
                const snap = await getDoc(doc(db, 'users', this.user.uid));
                if (snap.exists()) {
                    const data = snap.data();
                    this.userData = data;
                    if (data.game) this.game = { ...this.game, ...data.game };
                }
            } catch (e) { console.error('Load error:', e); }
        }
    };
    
    // Utils
    function createStars() {
        const c = document.getElementById('stars');
        c.innerHTML = '';
        for (let i = 0; i < 150; i++) {
            const s = document.createElement('div');
            s.className = 'star';
            s.style.cssText = `left:${Math.random()*100}%;top:${Math.random()*100}%;width:${Math.random()*2+1}px;height:${s.style.width};animation-delay:${Math.random()*3}s`;
            c.appendChild(s);
        }
    }
    
    function showToast(msg, type = 'info') {
        const c = document.getElementById('toastContainer');
        const icons = { success: 'âœ…', error: 'âŒ', info: 'â„¹ï¸' };
        const t = document.createElement('div');
        t.className = `toast ${type}`;
        t.innerHTML = `<span>${icons[type]}</span><span style="flex:1">${msg}</span>`;
        c.appendChild(t);
        setTimeout(() => t.remove(), 4000);
    }
    
    function showEvoAlert(icon, title, desc, effect) {
        const a = document.getElementById('evoAlert');
        document.getElementById('evoAlertIcon').textContent = icon;
        document.getElementById('evoAlertTitle').textContent = title;
        document.getElementById('evoAlertDesc').textContent = desc;
        document.getElementById('evoAlertEffect').textContent = effect;
        a.classList.add('show');
        setTimeout(() => a.classList.remove('show'), 2500);
    }
    
    function showStory(icon, title, text, btnText, callback) {
        document.getElementById('storyIcon').textContent = icon;
        document.getElementById('storyTitle').textContent = title;
        document.getElementById('storyText').innerHTML = text;
        document.getElementById('storyBtn').textContent = btnText;
        document.getElementById('storyOverlay').classList.add('active');
        window.storyCallback = callback;
    }
    
    function closeStory() {
        document.getElementById('storyOverlay').classList.remove('active');
        if (window.storyCallback) window.storyCallback();
    }
    
    function hideLoading() { document.getElementById('loadingScreen').classList.add('hidden'); }
    function navigate(page) { State.currentPage = page; render(); }
    
    function render() {
        const p = State.currentPage;
        if (p === 'login') renderLogin();
        else if (p === 'dashboard') renderDashboard();
        else if (p === 'cell-world') startCellWorld();
        else if (p === 'drift') startCosmicDrift();
        else if (p === 'landing') startPlanetLanding();
        else if (p === 'planet') renderPlanet();
        else if (p === 'signal') renderSignal();
        else if (p === 'history') renderHistory();
        else renderPlaceholder(p);
    }
    
    // Draw Cell
    function drawCell(ctx, x, y, size, design, evolution, time = 0) {
        const d = design || { primaryColor: '#00f5d4', secondaryColor: '#7b2cbf', pattern: 'none', wobblePoints: 12, wobbleIntensity: 1, glowIntensity: 0.5 };
        const points = d.wobblePoints || 12;
        
        ctx.save();
        ctx.translate(x, y);
        
        if (d.pattern === 'glow' || d.glowIntensity > 0.5) { ctx.shadowColor = d.primaryColor; ctx.shadowBlur = 20 * (d.glowIntensity || 0.5); }
        
        ctx.beginPath();
        for (let i = 0; i < points; i++) {
            const angle = (i / points) * Math.PI * 2;
            const wobble = Math.sin(time * 0.1 + i * 0.5) * 5 * (d.wobbleIntensity || 1);
            const r = size + wobble;
            const px = Math.cos(angle) * r;
            const py = Math.sin(angle) * r;
            i === 0 ? ctx.moveTo(px, py) : ctx.lineTo(px, py);
        }
        ctx.closePath();
        
        const g = ctx.createRadialGradient(-size * 0.3, -size * 0.3, 0, 0, 0, size * 1.2);
        g.addColorStop(0, d.primaryColor);
        g.addColorStop(0.6, d.secondaryColor);
        g.addColorStop(1, d.secondaryColor);
        ctx.fillStyle = g;
        ctx.fill();
        ctx.shadowBlur = 0;
        
        if (d.pattern === 'spots') {
            ctx.fillStyle = 'rgba(255,255,255,0.3)';
            for (let i = 0; i < 5; i++) {
                const angle = (i / 5) * Math.PI * 2 + time * 0.02;
                ctx.beginPath();
                ctx.arc(Math.cos(angle) * size * 0.5, Math.sin(angle) * size * 0.5, size * 0.12, 0, Math.PI * 2);
                ctx.fill();
            }
        } else if (d.pattern === 'stripes') {
            ctx.strokeStyle = 'rgba(255,255,255,0.2)';
            ctx.lineWidth = 3;
            for (let i = -2; i <= 2; i++) {
                ctx.beginPath();
                ctx.moveTo(i * size * 0.3, -size);
                ctx.lineTo(i * size * 0.3, size);
                ctx.stroke();
            }
        }
        
        ctx.beginPath();
        ctx.arc(-size * 0.25, -size * 0.25, size * 0.2, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(255,255,255,0.25)';
        ctx.fill();
        
        if (evolution) {
            if (evolution.eye) {
                ctx.beginPath();
                ctx.arc(size * 0.35, -size * 0.1, size * 0.22, 0, Math.PI * 2);
                ctx.fillStyle = '#fff';
                ctx.fill();
                ctx.beginPath();
                ctx.arc(size * 0.38, -size * 0.08, size * 0.11, 0, Math.PI * 2);
                ctx.fillStyle = '#1a1a2e';
                ctx.fill();
            }
            if (evolution.arm) {
                ctx.strokeStyle = d.secondaryColor;
                ctx.lineWidth = size * 0.12;
                ctx.lineCap = 'round';
                ctx.beginPath();
                ctx.moveTo(size * 0.7, size * 0.1);
                ctx.quadraticCurveTo(size * 1.2, size * 0.3 + Math.sin(time * 0.15) * 8, size * 1.4, size * 0.2);
                ctx.stroke();
            }
            if (evolution.leg) {
                const lw = Math.sin(time * 0.2) * 10;
                ctx.strokeStyle = d.secondaryColor;
                ctx.lineWidth = size * 0.15;
                ctx.beginPath(); ctx.moveTo(size * 0.2, size * 0.7); ctx.lineTo(size * 0.15 + lw, size * 1.3); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(-size * 0.2, size * 0.7); ctx.lineTo(-size * 0.15 - lw, size * 1.3); ctx.stroke();
            }
            if (evolution.brain) {
                ctx.beginPath();
                ctx.arc(0, -size * 0.5, size * 0.2, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(254, 228, 64, ${Math.sin(time * 0.1) * 0.3 + 0.7})`;
                ctx.fill();
            }
            if (evolution.wing) {
                const wf = Math.sin(time * 0.3) * 0.3;
                ctx.fillStyle = `${d.primaryColor}88`;
                ctx.save(); ctx.rotate(wf - 0.4);
                ctx.beginPath(); ctx.moveTo(size * 0.4, -size * 0.2); ctx.quadraticCurveTo(size * 1.3, -size * 0.7, size * 1.8, -size * 0.15); ctx.quadraticCurveTo(size * 1.3, size * 0.1, size * 0.4, -size * 0.05); ctx.fill();
                ctx.restore();
                ctx.save(); ctx.scale(-1, 1); ctx.rotate(wf - 0.4);
                ctx.beginPath(); ctx.moveTo(size * 0.4, -size * 0.2); ctx.quadraticCurveTo(size * 1.3, -size * 0.7, size * 1.8, -size * 0.15); ctx.quadraticCurveTo(size * 1.3, size * 0.1, size * 0.4, -size * 0.05); ctx.fill();
                ctx.restore();
            }
        }
        ctx.restore();
    }
    
    // Navbar
    function navbar() {
        const s = State.game.stage;
        return `
            <nav class="navbar">
                <div class="nav-logo" onclick="window.nav('dashboard')">BOKLUCK</div>
                <div class="nav-links">
                    <div class="nav-link ${State.currentPage==='dashboard'?'active':''}" onclick="window.nav('dashboard')">ğŸ  ëŒ€ì‹œë³´ë“œ</div>
                    <div class="nav-link ${s<3?'locked':''}" onclick="${s>=3?"window.nav('planet')":""}">ğŸª í–‰ì„± ${s<3?'ğŸ”’':''}</div>
                    <div class="nav-link ${s<4?'locked':''}">ğŸŒŒ ì€í•˜ ${s<4?'ğŸ”’':''}</div>
                    <div class="nav-link ${State.currentPage==='history'?'active':''}" onclick="window.nav('history')">ğŸ“œ ì—­ì‚¬ì„œ</div>
                </div>
                <div class="nav-right">
                    <div class="entropy-badge">
                        <div class="entropy-icon">âš¡</div>
                        <span class="entropy-value">${State.game.entropy.toLocaleString()}</span>
                    </div>
                    <div class="user-menu">
                        <div class="user-profile" onclick="toggleUserMenu()">
                            <img class="user-avatar" src="${State.user?.photoURL||'https://via.placeholder.com/36'}">
                            <span class="user-name">${State.user?.displayName||'User'}</span>
                        </div>
                        <div class="user-dropdown" id="userDropdown">
                            <div class="dropdown-item" onclick="window.openEditModal()">ğŸ§¬ ì„¸í¬ ìˆ˜ì •</div>
                            <div class="dropdown-item danger" onclick="window.logout()">ğŸšª ë¡œê·¸ì•„ì›ƒ</div>
                        </div>
                    </div>
                </div>
            </nav>
        `;
    }
    
    function toggleUserMenu() { document.getElementById('userDropdown').classList.toggle('show'); }
    document.addEventListener('click', (e) => { if (!e.target.closest('.user-menu')) { const dd = document.getElementById('userDropdown'); if (dd) dd.classList.remove('show'); } });
    
    // Login
    function renderLogin() {
        document.getElementById('app').innerHTML = `
            <div class="login-page">
                <h1 class="login-logo">BOKLUCK</h1>
                <p class="login-subtitle">Universe</p>
                <div class="login-cell"><canvas id="loginCellCanvas" width="150" height="150"></canvas></div>
                <p class="login-story">
                    ì–¸ì œì¸ì§€, ì™œì¸ì§€ ì•Œ ìˆ˜ ì—†ë‹¤.<br>
                    ë‚˜ëŠ” ê´‘í™œí•œ ìš°ì£¼ ì–´ë”˜ê°€ì—ì„œ<br>
                    í•˜ë‚˜ì˜ <strong>ì„¸í¬</strong>ë¡œ íƒœì–´ë‚¬ë‹¤.<br><br>
                    ì‚´ì•„ë‚¨ìœ¼ë ¤ë©´ <strong>ì—”íŠ¸ë¡œí”¼</strong>ë¥¼ ëª¨ì•„ì•¼ í•œë‹¤.
                </p>
                <button class="btn btn-google btn-lg" onclick="window.googleLogin()">
                    <img src="https://www.google.com/favicon.ico"> Googleë¡œ ì‹œì‘í•˜ê¸°
                </button>
            </div>
        `;
        const canvas = document.getElementById('loginCellCanvas');
        if (canvas) {
            const ctx = canvas.getContext('2d');
            let t = 0;
            const randomDesign = generateCellDesign();
            function animate() {
                if (!document.getElementById('loginCellCanvas')) return;
                t++;
                ctx.clearRect(0, 0, 150, 150);
                drawCell(ctx, 75, 75, 40, randomDesign, null, t);
                requestAnimationFrame(animate);
            }
            animate();
        }
    }
    
    // Dashboard
    function renderDashboard() {
        const { stage, entropy, evolution, history, cellDesign } = State.game;
        const evoCount = Object.values(evolution).filter(v => v).length;
        const design = cellDesign || generateCellDesign();
        
        const stageNum = Math.floor(stage);
        const stageLabels = { 1: 'ì„¸í¬', 2: 'ë‚™í•˜', 3: 'ì •ì°©', 4: 'ì€í•˜', 5: 'ì •ë³µ' };
        
        let nextAction = '';
        if (stage === 1 && entropy < 800) nextAction = `<button class="btn btn-primary btn-block mt-24" onclick="window.nav('cell-world')">ğŸŒŒ ì„¸í¬ ì„¸ê³„ë¡œ ì§„ì…</button>`;
        else if (stage === 1 && entropy >= 800) nextAction = `<button class="btn btn-energy btn-block mt-24" onclick="window.nav('drift')">ğŸŒ  ìš°ì£¼ë¡œ í‘œë¥˜í•˜ê¸°</button>`;
        else if (stage === 1.5) nextAction = `<button class="btn btn-energy btn-block mt-24" onclick="window.nav('drift')">ğŸŒ  ìš°ì£¼ í‘œë¥˜ ê³„ì†</button>`;
        else if (stage === 2) nextAction = `<button class="btn btn-energy btn-block mt-24" onclick="window.nav('landing')">ğŸš€ í–‰ì„± ì°©ë¥™</button>`;
        else if (stage >= 3 && stage < 3.5) nextAction = `<button class="btn btn-primary btn-block mt-24" onclick="window.nav('planet')">ğŸª í–‰ì„± íƒí—˜</button>${!State.game.signalDecoded ? '<button class="btn btn-outline btn-block mt-16" onclick="window.nav(\'signal\')">ğŸ“¡ ì‹ í˜¸ íƒì§€</button>' : ''}`;
        else if (stage === 3.5) nextAction = `<button class="btn btn-energy btn-block mt-24" onclick="window.nav('signal')">ğŸ“¡ ì²« ë²ˆì§¸ ì‹ í˜¸</button>`;
        else if (stage >= 4) nextAction = `<button class="btn btn-primary btn-block mt-24">ğŸŒŒ ì€í•˜ íƒí—˜ (ì¤€ë¹„ì¤‘)</button>`;
        
        document.getElementById('app').innerHTML = `
            ${navbar()}
            <main class="main-content">
                <div class="page-container">
                    <div class="stage-progress mb-24">
                        <div class="stage-dot ${stage>=1?'completed':'locked'}">ğŸ¦ </div>
                        <div class="stage-line ${stage>1?'completed':''}"></div>
                        <div class="stage-dot ${stage>=1.5?(stage===1.5?'current':'completed'):'locked'}">ğŸŒ </div>
                        <div class="stage-line ${stage>1.5?'completed':''}"></div>
                        <div class="stage-dot ${stage>=2?(stage===2?'current':'completed'):'locked'}">ğŸš€</div>
                        <div class="stage-line ${stage>2?'completed':''}"></div>
                        <div class="stage-dot ${stage>=3?(stage<3.5?'current':'completed'):'locked'}">ğŸ•ï¸</div>
                        <div class="stage-line ${stage>3?'completed':''}"></div>
                        <div class="stage-dot ${stage>=3.5?(stage===3.5?'current':'completed'):'locked'}">ğŸ“¡</div>
                        <div class="stage-line ${stage>3.5?'completed':''}"></div>
                        <div class="stage-dot ${stage>=4?(stage===4?'current':'completed'):'locked'}">ğŸŒŒ</div>
                        <div class="stage-line ${stage>4?'completed':''}"></div>
                        <div class="stage-dot ${stage>=5?'current':'locked'}">ğŸ‘‘</div>
                    </div>
                    
                    <div class="dashboard-grid">
                        <div class="card entity-card">
                            <div class="entity-visual" onclick="window.openEditModal()">
                                <canvas id="entityCanvas" width="180" height="180"></canvas>
                            </div>
                            <div class="entity-stage-label">STAGE ${stageNum} Â· ${stageLabels[stageNum] || 'ì§„í–‰ì¤‘'}</div>
                            <div class="entity-name">
                                ${design.name || 'Entity'}
                                <button class="edit-btn" onclick="window.openEditModal()">âœï¸</button>
                            </div>
                            <div class="entity-id">#${State.user?.uid?.slice(-6) || '000000'}</div>
                            <div class="progress-bar mb-16"><div class="progress-fill" style="width:${Math.min(entropy/800*100,100)}%"></div></div>
                            <div class="entity-stats">
                                <div class="stat-box"><div class="stat-value">${evoCount}/5</div><div class="stat-label">ì§„í™”</div></div>
                                <div class="stat-box"><div class="stat-value">${State.game.mergedCells||0}</div><div class="stat-label">í•©ì²´</div></div>
                                <div class="stat-box"><div class="stat-value">${State.game.territories?.length||0}</div><div class="stat-label">ì˜í† </div></div>
                                <div class="stat-box"><div class="stat-value">${Math.floor(State.game.driftProgress||0)}</div><div class="stat-label">í‘œë¥˜</div></div>
                            </div>
                            ${nextAction}
                        </div>
                        
                        <div>
                            <div class="quick-actions">
                                <div class="quick-action" onclick="window.nav('cell-world')"><div class="quick-action-icon">ğŸ¦ </div><div class="quick-action-label">ì„¸í¬ ì„¸ê³„</div></div>
                                <div class="quick-action ${stage<1.5&&entropy<800?'locked':''}" onclick="${stage>=1.5||entropy>=800?"window.nav('drift')":""}"><div class="quick-action-icon">ğŸŒ </div><div class="quick-action-label">ìš°ì£¼ í‘œë¥˜</div></div>
                                <div class="quick-action ${stage<3?'locked':''}" onclick="${stage>=3?"window.nav('planet')":""}"><div class="quick-action-icon">ğŸª</div><div class="quick-action-label">í–‰ì„±</div></div>
                                <div class="quick-action" onclick="window.nav('history')"><div class="quick-action-icon">ğŸ“œ</div><div class="quick-action-label">ì—­ì‚¬ì„œ</div></div>
                            </div>
                            <div class="card">
                                <div class="card-header">
                                    <span class="card-title">ğŸ“œ ë‚˜ì˜ ì—­ì‚¬ì„œ</span>
                                    <button class="btn btn-outline btn-sm" onclick="window.nav('history')">ì „ì²´</button>
                                </div>
                                ${(history||[]).length===0?`
                                    <div class="text-center text-muted" style="padding:40px">
                                        <p style="font-size:32px;margin-bottom:12px">ğŸ“œ</p>
                                        <p>ì•„ì§ ê¸°ë¡ëœ ì—­ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                                    </div>
                                `:(history||[]).slice(-3).reverse().map(e=>`
                                    <div class="history-entry">
                                        <div class="history-chapter">ì œ${e.chapter}ì¥</div>
                                        <div class="history-title">${e.title}</div>
                                        <div class="history-content">${e.content}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        `;
        animateEntityCanvas();
    }
    
    function animateEntityCanvas() {
        const canvas = document.getElementById('entityCanvas');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        let t = 0;
        function draw() {
            if (!document.getElementById('entityCanvas')) return;
            t++;
            ctx.clearRect(0, 0, 180, 180);
            drawCell(ctx, 90, 90, 40, State.game.cellDesign, State.game.evolution, t);
            requestAnimationFrame(draw);
        }
        draw();
    }
    
    // History
    function renderHistory() {
        const h = State.game.history || [];
        document.getElementById('app').innerHTML = `
            ${navbar()}
            <main class="main-content">
                <div class="page-container" style="max-width:800px">
                    <h1 class="font-display text-center mb-8" style="font-size:32px">ğŸ“œ ë‚˜ì˜ ì—­ì‚¬ì„œ</h1>
                    <p class="text-muted text-center mb-24">${State.game.cellDesign?.name || 'Entity'}ì˜ ì—¬ì •</p>
                    ${h.length===0?`
                        <div class="card text-center" style="padding:60px">
                            <p style="font-size:48px;margin-bottom:16px">ğŸ“œ</p>
                            <p class="mb-8">ì•„ì§ ê¸°ë¡ëœ ì—­ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                            <button class="btn btn-primary mt-24" onclick="window.nav('cell-world')">ì„¸í¬ ì„¸ê³„ ì§„ì…</button>
                        </div>
                    `:h.map(e=>`
                        <div class="card mb-16">
                            <div class="history-chapter">ì œ${e.chapter}ì¥</div>
                            <h3 style="font-size:18px;font-weight:700">${e.title}</h3>
                            <p style="margin-top:12px;line-height:1.8;color:var(--text-muted)">${e.content}</p>
                        </div>
                    `).join('')}
                </div>
            </main>
        `;
    }
    
    // Planet Page
    function renderPlanet() {
        const planet = State.game.currentPlanet || { name: 'ë¯¸ì§€ì˜ í–‰ì„±', type: 'íƒí—˜ í•„ìš”' };
        const territories = State.game.territories || [];
        const res = State.game.resources || { metal: 0, energy: 0, fuel: 0 };
        
        document.getElementById('app').innerHTML = `
            ${navbar()}
            <main class="main-content">
                <div class="page-container">
                    <div class="card mb-24" style="display:flex;align-items:center;gap:24px;padding:24px">
                        <span style="font-size:64px">ğŸª</span>
                        <div>
                            <h1 class="font-display" style="font-size:28px">${planet.name}</h1>
                            <p class="text-muted">${planet.type}</p>
                        </div>
                        <div style="margin-left:auto">
                            ${!State.game.signalDecoded ? '<button class="btn btn-outline" onclick="window.nav(\'signal\')">ğŸ“¡ ì´ìƒí•œ ì‹ í˜¸ íƒì§€ë¨</button>' : State.game.firstContact ? '<span class="text-muted">ğŸ“¡ ì²« ì ‘ì´‰ ì™„ë£Œ</span>' : ''}
                        </div>
                    </div>
                    
                    <div class="dashboard-grid">
                        <div>
                            <div class="card mb-24">
                                <div class="card-header">
                                    <span class="card-title">ğŸ—ºï¸ ì˜í†  ì§€ë„</span>
                                    <span class="text-muted" style="font-size:12px">${territories.length}/100</span>
                                </div>
                                <div class="planet-grid" id="planetGrid"></div>
                                <p class="text-muted text-center" style="font-size:12px">í´ë¦­í•˜ì—¬ ì˜í†  êµ¬ë§¤ (10 ì—”íŠ¸ë¡œí”¼)</p>
                            </div>
                            
                            <div class="card">
                                <div class="card-header"><span class="card-title">ğŸ“¦ ìì›</span></div>
                                <div class="resource-bar">
                                    <span class="resource-icon">ğŸ”©</span>
                                    <span class="resource-name">ê¸ˆì†</span>
                                    <span class="resource-value">${res.metal}</span>
                                </div>
                                <div class="resource-bar">
                                    <span class="resource-icon">âš¡</span>
                                    <span class="resource-name">ì—ë„ˆì§€</span>
                                    <span class="resource-value">${res.energy}</span>
                                </div>
                                <div class="resource-bar">
                                    <span class="resource-icon">ğŸ›¢ï¸</span>
                                    <span class="resource-name">ì—°ë£Œ</span>
                                    <span class="resource-value">${res.fuel}</span>
                                </div>
                                <button class="btn btn-outline btn-block mt-16" onclick="window.gatherResources()">ğŸ”¨ ìì› ìˆ˜ì§‘ (+10 ê°)</button>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header"><span class="card-title">ğŸ’¬ í–‰ì„± ê²Œì‹œíŒ</span></div>
                            <div style="display:flex;gap:12px;margin-bottom:16px">
                                <input type="text" class="input" id="postInput" placeholder="ë¬´ìŠ¨ ìƒê°ì„ í•˜ê³  ìˆë‚˜ìš”? (+100 ì—”íŠ¸ë¡œí”¼)">
                                <button class="btn btn-primary" onclick="window.createPost()">ì‘ì„±</button>
                            </div>
                            <div id="postsContainer"><p class="text-muted text-center" style="padding:20px">ì•„ì§ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤</p></div>
                        </div>
                    </div>
                </div>
            </main>
        `;
        renderPlanetGrid();
        loadPosts();
    }
    
    function renderPlanetGrid() {
        const grid = document.getElementById('planetGrid');
        if (!grid) return;
        const territories = State.game.territories || [];
        const ownedSet = new Set(territories.map(t => `${t.x},${t.y}`));
        let html = '';
        for (let y = 0; y < 10; y++) {
            for (let x = 0; x < 10; x++) {
                const isOwned = ownedSet.has(`${x},${y}`);
                html += `<div class="territory-cell ${isOwned ? 'owned' : ''}" onclick="window.clickTerritory(${x}, ${y})">${isOwned ? 'ğŸ ' : ''}</div>`;
            }
        }
        grid.innerHTML = html;
    }
    
    async function clickTerritory(x, y) {
        const territories = State.game.territories || [];
        if (territories.some(t => t.x === x && t.y === y)) { showToast('ì´ë¯¸ ì†Œìœ í•œ ì˜í† ì…ë‹ˆë‹¤', 'info'); return; }
        if (State.game.entropy < 10) { showToast('ì—”íŠ¸ë¡œí”¼ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤ (10 í•„ìš”)', 'error'); return; }
        State.game.entropy -= 10;
        State.game.territories.push({ x, y });
        await State.sync();
        showToast(`ğŸ  ì˜í†  (${x}, ${y}) êµ¬ë§¤ ì™„ë£Œ!`, 'success');
        renderPlanetGrid();
    }
    
    async function gatherResources() {
        State.game.resources = State.game.resources || { metal: 0, energy: 0, fuel: 0 };
        State.game.resources.metal += 10;
        State.game.resources.energy += 10;
        State.game.resources.fuel += 10;
        await State.sync();
        showToast('ğŸ“¦ ìì›ì„ ìˆ˜ì§‘í–ˆìŠµë‹ˆë‹¤!', 'success');
        render();
    }
    
    async function loadPosts() {
        const container = document.getElementById('postsContainer');
        if (!container || !State.game.currentPlanet) return;
        try {
            const q = query(collection(db, 'posts'), where('planetName', '==', State.game.currentPlanet.name), orderBy('createdAt', 'desc'), limit(20));
            const snap = await getDocs(q);
            if (snap.empty) { container.innerHTML = '<p class="text-muted text-center" style="padding:20px">ì•„ì§ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤</p>'; return; }
            container.innerHTML = snap.docs.map(doc => {
                const p = doc.data();
                return `<div style="background:var(--bg-input);border-radius:12px;padding:16px;margin-bottom:12px">
                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
                        <img style="width:32px;height:32px;border-radius:50%" src="${p.authorPhoto || 'https://via.placeholder.com/32'}">
                        <div><div style="font-weight:600;font-size:14px">${p.authorName || 'Unknown'}</div></div>
                    </div>
                    <div style="font-size:14px;line-height:1.6">${p.content}</div>
                </div>`;
            }).join('');
        } catch (e) { console.error(e); }
    }
    
    async function createPost() {
        const input = document.getElementById('postInput');
        const content = input.value.trim();
        if (!content) { showToast('ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”', 'error'); return; }
        try {
            await addDoc(collection(db, 'posts'), {
                planetName: State.game.currentPlanet.name,
                content,
                authorId: State.user.uid,
                authorName: State.game.cellDesign?.name || State.user.displayName,
                authorPhoto: State.user.photoURL,
                createdAt: serverTimestamp()
            });
            State.game.entropy += 100;
            await State.sync();
            input.value = '';
            showToast('ğŸ“ ê²Œì‹œê¸€ ì‘ì„± ì™„ë£Œ! +100 ì—”íŠ¸ë¡œí”¼', 'success');
            loadPosts();
        } catch (e) { console.error(e); showToast('ê²Œì‹œê¸€ ì‘ì„± ì‹¤íŒ¨', 'error'); }
    }
    
    // Signal Page (Stage 3.5)
    function renderSignal() {
        const res = State.game.resources || { metal: 0, energy: 0, fuel: 0 };
        const shipReady = res.metal >= 100 && res.energy >= 100 && res.fuel >= 100;
        
        document.getElementById('app').innerHTML = `
            ${navbar()}
            <main class="main-content">
                <div class="page-container" style="max-width:800px">
                    <h1 class="font-display text-center mb-8" style="font-size:32px">ğŸ“¡ ì²« ë²ˆì§¸ ì‹ í˜¸</h1>
                    <p class="text-muted text-center mb-24">í•˜ëŠ˜ì—ì„œ ì´ìƒí•œ ì‹ í˜¸ê°€ ë“¤ë ¤ì™”ë‹¤...</p>
                    
                    <div class="card mb-24">
                        <div class="card-header"><span class="card-title">1ï¸âƒ£ ì‹ í˜¸ í•´ë…</span></div>
                        ${State.game.signalDecoded ? `
                            <p class="text-center" style="color:var(--success)">âœ… ì‹ í˜¸ í•´ë… ì™„ë£Œ!</p>
                            <p class="text-muted text-center mt-16">ì¢Œí‘œ: X-742, Y-891, Z-0.3</p>
                        ` : `
                            <p class="text-muted text-center mb-16">ì‹ í˜¸ë¥¼ í•´ë…í•˜ë ¤ë©´ í¼ì¦ì„ í’€ì–´ì•¼ í•©ë‹ˆë‹¤</p>
                            <div class="text-center">
                                <button class="btn btn-primary" onclick="window.startPuzzle()">ğŸ§© í¼ì¦ ì‹œì‘</button>
                            </div>
                        `}
                    </div>
                    
                    <div class="card mb-24 ${!State.game.signalDecoded ? 'locked' : ''}" style="${!State.game.signalDecoded ? 'opacity:0.5' : ''}">
                        <div class="card-header"><span class="card-title">2ï¸âƒ£ ìš°ì£¼ì„  ê±´ì¡°</span></div>
                        <p class="text-muted mb-16">ì‹ í˜¸ì˜ ì¶œì²˜ë¡œ ê°€ë ¤ë©´ ìš°ì£¼ì„ ì´ í•„ìš”í•©ë‹ˆë‹¤</p>
                        <div class="resource-bar">
                            <span class="resource-icon">ğŸ”©</span>
                            <span class="resource-name">ê¸ˆì†</span>
                            <div class="resource-progress"><div class="resource-progress-fill" style="width:${Math.min(res.metal, 100)}%"></div></div>
                            <span class="resource-value">${res.metal}/100</span>
                        </div>
                        <div class="resource-bar">
                            <span class="resource-icon">âš¡</span>
                            <span class="resource-name">ì—ë„ˆì§€</span>
                            <div class="resource-progress"><div class="resource-progress-fill" style="width:${Math.min(res.energy, 100)}%"></div></div>
                            <span class="resource-value">${res.energy}/100</span>
                        </div>
                        <div class="resource-bar">
                            <span class="resource-icon">ğŸ›¢ï¸</span>
                            <span class="resource-name">ì—°ë£Œ</span>
                            <div class="resource-progress"><div class="resource-progress-fill" style="width:${Math.min(res.fuel, 100)}%"></div></div>
                            <span class="resource-value">${res.fuel}/100</span>
                        </div>
                        ${shipReady && State.game.signalDecoded ? `<button class="btn btn-energy btn-block mt-16" onclick="window.buildShip()">ğŸš€ ìš°ì£¼ì„  ê±´ì¡°</button>` : `<p class="text-muted text-center mt-16">ìì›ì´ ë¶€ì¡±í•©ë‹ˆë‹¤ (í–‰ì„±ì—ì„œ ìˆ˜ì§‘)</p>`}
                    </div>
                    
                    <div class="card ${!State.game.shipBuilt ? 'locked' : ''}" style="${!State.game.shipBuilt ? 'opacity:0.5' : ''}">
                        <div class="card-header"><span class="card-title">3ï¸âƒ£ ì²« ì ‘ì´‰</span></div>
                        ${State.game.firstContact ? `
                            <p class="text-center" style="color:var(--success)">âœ… ${State.game.firstContact === 'ally' ? 'ë™ë§¹ì„ ë§ºì—ˆìŠµë‹ˆë‹¤!' : State.game.firstContact === 'battle' ? 'ì „íˆ¬ì—ì„œ ìŠ¹ë¦¬í–ˆìŠµë‹ˆë‹¤!' : 'ê´€ì°°ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤!'}</p>
                            <button class="btn btn-primary btn-block mt-16" onclick="window.enterGalaxy()">ğŸŒŒ ì€í•˜ë¡œ ì§„ì¶œ</button>
                        ` : State.game.shipBuilt ? `
                            <p class="text-muted text-center mb-16">ì‹ í˜¸ì˜ ì¶œì²˜ì— ë„ì°©í–ˆìŠµë‹ˆë‹¤. ê³ ëŒ€ ìš°ì£¼ì •ê±°ì¥ì´ ë³´ì…ë‹ˆë‹¤.</p>
                            <div class="modal-actions">
                                <button class="btn btn-success" onclick="window.firstContact('ally')">ğŸ¤ ë™ë§¹</button>
                                <button class="btn btn-danger" onclick="window.firstContact('battle')">âš”ï¸ ì „íˆ¬</button>
                                <button class="btn btn-outline" onclick="window.firstContact('observe')">ğŸ‘ï¸ ê´€ì°°</button>
                            </div>
                        ` : `<p class="text-muted text-center">ìš°ì£¼ì„ ì„ ë¨¼ì € ê±´ì¡°í•˜ì„¸ìš”</p>`}
                    </div>
                    
                    <button class="btn btn-outline btn-block mt-24" onclick="window.nav('planet')">â† í–‰ì„±ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
                </div>
            </main>
        `;
    }
    
    let puzzlePattern = [];
    let playerPattern = [];
    let puzzlePhase = 'watch';
    
    function startPuzzle() {
        document.getElementById('puzzleModal').classList.add('active');
        puzzlePattern = [];
        playerPattern = [];
        for (let i = 0; i < 4; i++) puzzlePattern.push(Math.floor(Math.random() * 16));
        
        let html = '';
        for (let i = 0; i < 16; i++) {
            html += `<div class="puzzle-cell" data-idx="${i}" onclick="window.clickPuzzleCell(${i})"></div>`;
        }
        document.getElementById('puzzleContainer').innerHTML = html;
        document.getElementById('puzzleStatus').textContent = 'íŒ¨í„´ì„ ê¸°ì–µí•˜ì„¸ìš”...';
        puzzlePhase = 'watch';
        
        showPattern(0);
    }
    
    function showPattern(idx) {
        if (idx >= puzzlePattern.length) {
            puzzlePhase = 'input';
            document.getElementById('puzzleStatus').textContent = 'ì´ì œ ë”°ë¼í•˜ì„¸ìš”!';
            return;
        }
        
        setTimeout(() => {
            const cells = document.querySelectorAll('.puzzle-cell');
            cells[puzzlePattern[idx]].classList.add('active');
            setTimeout(() => {
                cells[puzzlePattern[idx]].classList.remove('active');
                showPattern(idx + 1);
            }, 500);
        }, 600);
    }
    
    function clickPuzzleCell(idx) {
        if (puzzlePhase !== 'input') return;
        
        const cells = document.querySelectorAll('.puzzle-cell');
        playerPattern.push(idx);
        
        const currentIdx = playerPattern.length - 1;
        if (playerPattern[currentIdx] === puzzlePattern[currentIdx]) {
            cells[idx].classList.add('correct');
            setTimeout(() => cells[idx].classList.remove('correct'), 300);
            
            if (playerPattern.length === puzzlePattern.length) {
                document.getElementById('puzzleStatus').textContent = 'ğŸ‰ ì„±ê³µ!';
                State.game.signalDecoded = true;
                State.game.stage = 3.5;
                State.game.history.push({
                    chapter: State.game.history.length + 1,
                    title: 'ì‹ í˜¸ì˜ ë¹„ë°€',
                    content: 'ì˜¤ëœ ì‹œê°„ ëì— ì‹ í˜¸ë¥¼ í•´ë…í–ˆë‹¤. ì¢Œí‘œê°€ ë‚˜íƒ€ë‚¬ë‹¤... ëˆ„êµ°ê°€ ìš°ë¦¬ë¥¼ ë¶€ë¥´ê³  ìˆë‹¤.',
                    timestamp: new Date().toISOString()
                });
                State.sync();
                setTimeout(() => {
                    closePuzzleModal();
                    render();
                }, 1000);
            }
        } else {
            cells[idx].classList.add('wrong');
            document.getElementById('puzzleStatus').textContent = 'âŒ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”';
            setTimeout(() => {
                cells[idx].classList.remove('wrong');
                playerPattern = [];
                puzzlePhase = 'watch';
                document.getElementById('puzzleStatus').textContent = 'íŒ¨í„´ì„ ê¸°ì–µí•˜ì„¸ìš”...';
                showPattern(0);
            }, 1000);
        }
    }
    
    function closePuzzleModal() {
        document.getElementById('puzzleModal').classList.remove('active');
    }
    
    async function buildShip() {
        const res = State.game.resources;
        if (res.metal < 100 || res.energy < 100 || res.fuel < 100) return;
        
        res.metal -= 100;
        res.energy -= 100;
        res.fuel -= 100;
        State.game.shipBuilt = true;
        State.game.history.push({
            chapter: State.game.history.length + 1,
            title: 'ìš°ì£¼ì„  ì™„ì„±',
            content: 'ë“œë””ì–´ ìš°ì£¼ì„ ì´ ì™„ì„±ë˜ì—ˆë‹¤. ì‹ í˜¸ì˜ ì¶œì²˜ë¥¼ í–¥í•´ ë– ë‚  ì¤€ë¹„ê°€ ë˜ì—ˆë‹¤.',
            timestamp: new Date().toISOString()
        });
        await State.sync();
        showToast('ğŸš€ ìš°ì£¼ì„  ê±´ì¡° ì™„ë£Œ!', 'success');
        render();
    }
    
    async function firstContact(choice) {
        State.game.firstContact = choice;
        
        let title, content;
        if (choice === 'ally') {
            title = 'ìƒˆë¡œìš´ ë™ë§¹';
            content = 'ê³ ëŒ€ ìš°ì£¼ì •ê±°ì¥ì—ì„œ ì˜¤ë˜ëœ ë¬¸ëª…ì˜ í›„ì†ë“¤ì„ ë§Œë‚¬ë‹¤. ê·¸ë“¤ì€ ìš°ë¦¬ë¥¼ í™˜ì˜í–ˆê³ , ì€í•˜ í•­í•´ì˜ ì§€ì‹ì„ ë‚˜ëˆ„ì–´ì£¼ì—ˆë‹¤.';
            State.game.entropy += 500;
        } else if (choice === 'battle') {
            title = 'ìŠ¹ë¦¬ì˜ ëŒ€ê°€';
            content = 'ì •ê±°ì¥ì˜ ë°©ì–´ ì‹œìŠ¤í…œê³¼ ì¹˜ì—´í•œ ì „íˆ¬ ëì— ìŠ¹ë¦¬í–ˆë‹¤. ê³ ëŒ€ ê¸°ìˆ ì„ íšë“í–ˆì§€ë§Œ, ê·¸ë“¤ì˜ ë¬¸ëª…ì€ ì‚¬ë¼ì¡Œë‹¤.';
            State.game.entropy += 300;
        } else {
            title = 'ì¡°ìš©í•œ ê´€ì°°ì';
            content = 'ë©€ë¦¬ì„œ ì§€ì¼œë³´ê¸°ë§Œ í–ˆë‹¤. ê·¸ë“¤ì€ ìš°ë¦¬ì˜ ì¡´ì¬ë¥¼ ì•Œì•„ì±„ì§€ ëª»í–ˆê³ , ë§ì€ ê²ƒì„ ë°°ìš¸ ìˆ˜ ìˆì—ˆë‹¤.';
            State.game.entropy += 200;
        }
        
        State.game.history.push({ chapter: State.game.history.length + 1, title, content, timestamp: new Date().toISOString() });
        await State.sync();
        showToast(`âœ¨ ì²« ì ‘ì´‰ ì™„ë£Œ! +${choice === 'ally' ? 500 : choice === 'battle' ? 300 : 200} ì—”íŠ¸ë¡œí”¼`, 'success');
        render();
    }
    
    async function enterGalaxy() {
        State.game.stage = 4;
        State.game.history.push({
            chapter: State.game.history.length + 1,
            title: 'ì€í•˜ë¥¼ í–¥í•´',
            content: 'ì²« ì ‘ì´‰ì„ ë§ˆì¹˜ê³ , ë“œë””ì–´ ì€í•˜ë¡œ ë‚˜ì•„ê°ˆ ì¤€ë¹„ê°€ ë˜ì—ˆë‹¤. ìƒˆë¡œìš´ ë³„ë“¤ì´ ê¸°ë‹¤ë¦¬ê³  ìˆë‹¤.',
            timestamp: new Date().toISOString()
        });
        await State.sync();
        showStory('ğŸŒŒ', 'ì€í•˜ ì§„ì¶œ', 'ë‹¹ì‹ ì€ ì´ì œ <strong>ì€í•˜</strong>ë¥¼ íƒí—˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br><br>ìƒˆë¡œìš´ í–‰ì„±ë“¤, ìƒˆë¡œìš´ ë¬¸ëª…ë“¤, ê·¸ë¦¬ê³  ìƒˆë¡œìš´ ë„ì „ì´ ê¸°ë‹¤ë¦½ë‹ˆë‹¤.', 'ì‹œì‘í•˜ê¸°', () => navigate('dashboard'));
    }
    
    // Placeholder
    function renderPlaceholder(p) {
        document.getElementById('app').innerHTML = `
            ${navbar()}
            <main class="main-content">
                <div class="page-container text-center" style="padding-top:100px">
                    <h1 style="font-size:48px;margin-bottom:24px">ğŸ”’</h1>
                    <h2 class="font-display mb-16">${p}</h2>
                    <p class="text-muted mb-24">ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤...</p>
                    <button class="btn btn-outline" onclick="window.nav('dashboard')">ëŒ€ì‹œë³´ë“œë¡œ</button>
                </div>
            </main>
        `;
    }
    
    // ========================================
    // CELL WORLD (Stage 1)
    // ========================================
    let worldRunning = false;
    
    function exitWorld() {
        worldRunning = false;
        document.getElementById('worldCanvas').classList.remove('active');
        document.getElementById('worldUI').classList.remove('active');
        document.getElementById('worldControls').classList.remove('active');
        document.getElementById('encounterDialog').classList.remove('active');
        navigate('dashboard');
    }
    
    function startCellWorld() {
        document.getElementById('app').innerHTML = '';
        const canvas = document.getElementById('worldCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        canvas.classList.add('active');
        
        document.getElementById('worldUI').classList.add('active');
        document.getElementById('worldControls').classList.add('active');
        document.getElementById('worldControls').innerHTML = `
            <div><span class="key">W A S D</span> ì´ë™</div>
            <div><span class="key">ë§ˆìš°ìŠ¤</span> ë°©í–¥</div>
            <div><span class="key">SPACE</span> ëŒ€ì‹œ</div>
            <div><span class="key">ESC</span> í™ˆìœ¼ë¡œ</div>
        `;
        
        document.getElementById('worldStatLabel').textContent = 'ENTROPY';
        document.getElementById('worldNavButtons').innerHTML = `
            <button class="world-nav-btn" onclick="window.exitWorld()">ğŸ  í™ˆ</button>
            <button class="world-nav-btn next-stage" id="nextStageBtn" onclick="window.goToDrift()" disabled>ğŸŒ  ìš°ì£¼ í‘œë¥˜</button>
        `;
        
        worldRunning = true;
        const design = State.game.cellDesign || generateCellDesign();
        
        const player = {
            x: 0, y: 0, vx: 0, vy: 0, baseSize: 30,
            size: 30 + State.game.entropy * 0.03,
            speed: State.game.evolution.leg ? 5 : 3,
            visionRange: State.game.evolution.eye ? 500 : 300,
            collectRange: State.game.evolution.arm ? 100 : 50,
            multiplier: State.game.evolution.brain ? 2 : 1,
            dashing: false, dashCD: 0
        };
        
        let particles = [];
        const camera = { x: 0, y: 0 };
        const keys = {};
        let mouseX = canvas.width / 2, mouseY = canvas.height / 2;
        let useMouse = false, time = 0;
        
        function onKeyDown(e) {
            keys[e.key.toLowerCase()] = true;
            useMouse = false;
            if (e.code === 'Space' && State.game.evolution.wing && player.dashCD <= 0) {
                player.dashing = true;
                player.dashCD = 60;
                setTimeout(() => player.dashing = false, 200);
            }
            if (e.key === 'Escape') exitWorld();
        }
        function onKeyUp(e) { keys[e.key.toLowerCase()] = false; }
        function onMouseMove(e) { mouseX = e.clientX; mouseY = e.clientY; useMouse = true; }
        function onResize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        
        window.addEventListener('keydown', onKeyDown);
        window.addEventListener('keyup', onKeyUp);
        window.addEventListener('mousemove', onMouseMove);
        window.addEventListener('resize', onResize);
        
        function cleanup() {
            window.removeEventListener('keydown', onKeyDown);
            window.removeEventListener('keyup', onKeyUp);
            window.removeEventListener('mousemove', onMouseMove);
            window.removeEventListener('resize', onResize);
        }
        
        function updateEvoPanel() {
            const evo = State.game.evolution;
            const e = State.game.entropy;
            document.getElementById('worldInfoPanel').innerHTML = `
                <div class="world-info-title">ğŸ§¬ ì§„í™” ë‹¨ê³„</div>
                ${[['eye', 'ğŸ‘ï¸', 'ì‹œê°', 100], ['arm', 'ğŸ¦¾', 'íŒ”', 200], ['leg', 'ğŸ¦µ', 'ë‹¤ë¦¬', 300], ['brain', 'ğŸ§ ', 'ë‘ë‡Œ', 500], ['wing', 'ğŸª½', 'ë‚ ê°œ', 800]].map(([k, icon, name, req]) => `
                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;opacity:${evo[k]?1:e>=req*0.8?0.7:0.4}">
                        <div style="width:28px;height:28px;background:${evo[k]?'var(--gradient-evolution)':'rgba(123,44,191,0.2)'};border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px">${icon}</div>
                        <div><div style="font-size:12px;font-weight:600">${name}</div><div style="font-size:10px;color:var(--text-muted)">${evo[k]?'âœ“':req}</div></div>
                    </div>
                `).join('')}
            `;
            document.getElementById('nextStageBtn').disabled = State.game.entropy < 800;
        }
        updateEvoPanel();
        
        function spawn() {
            const count = State.game.evolution.eye ? 150 : 80;
            while (particles.length < count) {
                const a = Math.random() * Math.PI * 2;
                const d = 100 + Math.random() * (player.visionRange + 300);
                particles.push({ x: player.x + Math.cos(a) * d, y: player.y + Math.sin(a) * d, size: 5 + Math.random() * 12, value: 1 + Math.floor(Math.random() * 3), pulse: Math.random() * Math.PI * 2, hue: 160 + Math.random() * 60 });
            }
        }
        
        async function checkEvo() {
            const e = State.game.entropy;
            const evo = State.game.evolution;
            const evos = [['eye', 100, 'ğŸ‘ï¸', 'ì‹œê° ê¸°ê´€ ì§„í™”!', 'ëˆˆì´ ìƒê²¨ë‚¬ìŠµë‹ˆë‹¤', 'ì‹œì•¼ +66%', 'ì²« ë²ˆì§¸ ëˆˆ', '100 ì—”íŠ¸ë¡œí”¼ë¥¼ í¡ìˆ˜í•˜ì, ì„¸ìƒì´ ë³´ì´ê¸° ì‹œì‘í–ˆë‹¤.'],
                ['arm', 200, 'ğŸ¦¾', 'ìˆ˜ì§‘ íŒ” ì§„í™”!', 'íŒ”ì´ ìƒê²¨ë‚¬ìŠµë‹ˆë‹¤', 'ìˆ˜ì§‘ +100%', 'ì²« ë²ˆì§¸ íŒ”', '200 ì—”íŠ¸ë¡œí”¼ì˜ í˜ìœ¼ë¡œ ì´‰ìˆ˜ê°€ ìë¼ë‚¬ë‹¤.'],
                ['leg', 300, 'ğŸ¦µ', 'ì´ë™ ê¸°ê´€ ì§„í™”!', 'ë‹¤ë¦¬ê°€ ìƒê²¨ë‚¬ìŠµë‹ˆë‹¤', 'ì†ë„ +66%', 'ì´ë™ì˜ ììœ ', '300 ì—”íŠ¸ë¡œí”¼ê°€ ëª¨ì´ì ë‹¤ë¦¬ê°€ ìƒê²¨ë‚¬ë‹¤.'],
                ['brain', 500, 'ğŸ§ ', 'ë‘ë‡Œ ì§„í™”!', 'ì§€ëŠ¥ì´ ë°œë‹¬í–ˆìŠµë‹ˆë‹¤', 'íšë“ 2ë°°', 'ì§€ì„±ì˜ ë¶ˆê½ƒ', '500 ì—”íŠ¸ë¡œí”¼... ì˜ì‹ì´ í™•ì¥ë˜ì—ˆë‹¤.'],
                ['wing', 800, 'ğŸª½', 'ë‚ ê°œ ì§„í™”!', 'ë‚ ê°œê°€ ìƒê²¨ë‚¬ìŠµë‹ˆë‹¤', 'SPACE ëŒ€ì‹œ', 'ìš°ì£¼ë¥¼ í–¥í•´', '800 ì—”íŠ¸ë¡œí”¼ì˜ ì •ì ì—ì„œ ë‚ ê°œê°€ í¼ì³ì¡Œë‹¤.']];
            
            for (const [k, req, icon, title, desc, effect, hTitle, hContent] of evos) {
                if (!evo[k] && e >= req) {
                    State.game.evolution[k] = true;
                    if (k === 'eye') player.visionRange = 500;
                    if (k === 'arm') player.collectRange = 100;
                    if (k === 'leg') player.speed = 5;
                    if (k === 'brain') player.multiplier = 2;
                    showEvoAlert(icon, title, desc, effect);
                    State.game.history = State.game.history || [];
                    State.game.history.push({ chapter: State.game.history.length + 1, title: hTitle, content: hContent, timestamp: new Date().toISOString() });
                    updateEvoPanel();
                    if (k === 'wing') showToast('ğŸ‰ ëª¨ë“  ì§„í™” ì™„ë£Œ!', 'success');
                }
            }
            player.size = Math.min(player.baseSize + e * 0.03, 80);
            await State.sync();
        }
        
        function update() {
            let mx = 0, my = 0;
            if (useMouse) {
                const dx = mouseX - canvas.width / 2, dy = mouseY - canvas.height / 2;
                const d = Math.sqrt(dx * dx + dy * dy);
                if (d > 30) { mx = dx / d; my = dy / d; }
            } else {
                if (keys['w'] || keys['arrowup']) my = -1;
                if (keys['s'] || keys['arrowdown']) my = 1;
                if (keys['a'] || keys['arrowleft']) mx = -1;
                if (keys['d'] || keys['arrowright']) mx = 1;
                if (mx && my) { mx *= 0.707; my *= 0.707; }
            }
            let spd = player.speed;
            if (player.dashing) spd *= 3;
            player.vx = mx * spd; player.vy = my * spd;
            player.x += player.vx; player.y += player.vy;
            if (player.dashCD > 0) player.dashCD--;
            camera.x += (player.x - camera.x) * 0.1;
            camera.y += (player.y - camera.y) * 0.1;
        }
        
        function collect() {
            particles = particles.filter(p => {
                const dx = p.x - player.x, dy = p.y - player.y;
                const d = Math.sqrt(dx * dx + dy * dy);
                if (d < player.collectRange + p.size) {
                    State.game.entropy += p.value * player.multiplier;
                    document.getElementById('worldStatValue').textContent = State.game.entropy;
                    checkEvo();
                    return false;
                }
                if (State.game.evolution.arm && d < player.collectRange * 2) { p.x -= dx * 0.05; p.y -= dy * 0.05; }
                return true;
            });
        }
        
        function drawBg() {
            const g = ctx.createRadialGradient(canvas.width/2, canvas.height/2, 0, canvas.width/2, canvas.height/2, canvas.width);
            g.addColorStop(0, '#0a0a1a'); g.addColorStop(1, '#050510');
            ctx.fillStyle = g;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = 'rgba(255,255,255,0.5)';
            for (let i = 0; i < 100; i++) {
                const x = ((i * 137.5 + camera.x * 0.1) % canvas.width + canvas.width) % canvas.width;
                const y = ((i * 73.7 + camera.y * 0.1) % canvas.height + canvas.height) % canvas.height;
                ctx.beginPath();
                ctx.arc(x, y, (Math.sin(time * 0.02 + i) + 1) * 1.2, 0, Math.PI * 2);
                ctx.fill();
            }
        }
        
        function drawParticles() {
            particles.forEach(p => {
                const sx = canvas.width / 2 + (p.x - camera.x);
                const sy = canvas.height / 2 + (p.y - camera.y);
                const d = Math.sqrt((p.x - player.x) ** 2 + (p.y - player.y) ** 2);
                if (d > player.visionRange && !State.game.evolution.eye) return;
                ctx.globalAlpha = d > player.visionRange ? 0.3 : 1;
                p.pulse += 0.05;
                const sz = p.size * (Math.sin(p.pulse) * 0.3 + 1);
                const g = ctx.createRadialGradient(sx, sy, 0, sx, sy, sz);
                g.addColorStop(0, `hsla(${p.hue}, 100%, 70%, 1)`);
                g.addColorStop(0.5, `hsla(${p.hue}, 100%, 50%, 0.8)`);
                g.addColorStop(1, `hsla(${p.hue}, 100%, 50%, 0)`);
                ctx.beginPath(); ctx.arc(sx, sy, sz, 0, Math.PI * 2);
                ctx.fillStyle = g; ctx.fill();
                ctx.globalAlpha = 1;
            });
        }
        
        function drawPlayer() {
            if (player.dashing) { ctx.shadowColor = design.primaryColor; ctx.shadowBlur = 50; }
            drawCell(ctx, canvas.width / 2, canvas.height / 2, player.size, design, State.game.evolution, time);
            ctx.shadowBlur = 0;
        }
        
        function loop() {
            if (!worldRunning) { cleanup(); return; }
            time++;
            update(); spawn(); collect();
            drawBg(); drawParticles(); drawPlayer();
            requestAnimationFrame(loop);
        }
        
        for (let i = 0; i < 60; i++) {
            const a = Math.random() * Math.PI * 2, d = 50 + Math.random() * 300;
            particles.push({ x: Math.cos(a) * d, y: Math.sin(a) * d, size: 5 + Math.random() * 12, value: 1 + Math.floor(Math.random() * 3), pulse: Math.random() * Math.PI * 2, hue: 160 + Math.random() * 60 });
        }
        
        document.getElementById('worldStatValue').textContent = State.game.entropy;
        loop();
    }
    
    function goToDrift() {
        if (State.game.entropy < 800) return;
        if (State.game.stage < 1.5) {
            State.game.stage = 1.5;
            State.game.history.push({ chapter: State.game.history.length + 1, title: 'íƒˆì¶œ', content: 'ì´ ê³µê°„ì„ ë²—ì–´ë‚  ë§Œí¼ ê°•í•´ì¡Œë‹¤. ì´ì œ ë” ë„“ì€ ìš°ì£¼ë¡œ ë‚˜ì•„ê°€ì•¼ í•œë‹¤.', timestamp: new Date().toISOString() });
            State.sync();
        }
        worldRunning = false;
        document.getElementById('worldCanvas').classList.remove('active');
        document.getElementById('worldUI').classList.remove('active');
        document.getElementById('worldControls').classList.remove('active');
        
        showStory('ğŸŒ ', 'ìš°ì£¼ í‘œë¥˜', 'ë‹¹ì‹ ì€ ì´ì œ ì´ ê³µê°„ì„ ë²—ì–´ë‚¬ìŠµë‹ˆë‹¤.<br><br>ê´‘í™œí•œ <strong>ìš°ì£¼</strong>ê°€ í¼ì³ì ¸ ìˆê³ ,<br>ë‹¹ì‹ ì²˜ëŸ¼ <strong>ë– ë„ëŠ” ì˜ì‹</strong>ë“¤ì´ ë³´ì…ë‹ˆë‹¤...', 'í‘œë¥˜ ì‹œì‘', () => navigate('drift'));
    }
    
    // ========================================
    // COSMIC DRIFT (Stage 1.5)
    // ========================================
    function startCosmicDrift() {
        document.getElementById('app').innerHTML = '';
        const canvas = document.getElementById('worldCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        canvas.classList.add('active');
        
        document.getElementById('worldUI').classList.add('active');
        document.getElementById('worldControls').classList.add('active');
        document.getElementById('worldControls').innerHTML = `
            <div><span class="key">W A S D</span> ì´ë™</div>
            <div><span class="key">ESC</span> í™ˆìœ¼ë¡œ</div>
        `;
        
        document.getElementById('worldStatLabel').textContent = 'DISTANCE';
        document.getElementById('worldNavButtons').innerHTML = `
            <button class="world-nav-btn" onclick="window.exitWorld()">ğŸ  í™ˆ</button>
        `;
        
        worldRunning = true;
        const design = State.game.cellDesign || generateCellDesign();
        
        let driftProgress = State.game.driftProgress || 0;
        const targetDistance = 1000;
        
        const player = { x: canvas.width / 2, y: canvas.height / 2, speed: 4 };
        let driftingCells = [];
        let encounterActive = false;
        let currentEncounter = null;
        let time = 0;
        const keys = {};
        
        function onKeyDown(e) { keys[e.key.toLowerCase()] = true; if (e.key === 'Escape') exitWorld(); }
        function onKeyUp(e) { keys[e.key.toLowerCase()] = false; }
        function onResize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        
        window.addEventListener('keydown', onKeyDown);
        window.addEventListener('keyup', onKeyUp);
        window.addEventListener('resize', onResize);
        
        function cleanup() {
            window.removeEventListener('keydown', onKeyDown);
            window.removeEventListener('keyup', onKeyUp);
            window.removeEventListener('resize', onResize);
        }
        
        function updateInfoPanel() {
            const progress = Math.min(driftProgress / targetDistance * 100, 100);
            document.getElementById('worldInfoPanel').innerHTML = `
                <div class="world-info-title">ğŸŒŒ í‘œë¥˜ ìƒíƒœ</div>
                <div style="margin-bottom:12px">
                    <div style="font-size:12px;color:var(--text-muted);margin-bottom:4px">í–‰ì„± ë ˆì´ë”</div>
                    <div class="progress-bar"><div class="progress-fill" style="width:${progress}%"></div></div>
                    <div style="font-size:11px;color:var(--text-dark);margin-top:4px">${Math.floor(driftProgress)} / ${targetDistance}</div>
                </div>
                <div style="font-size:12px;color:var(--text-muted)">í•©ì²´í•œ ì„¸í¬: ${State.game.mergedCells || 0}</div>
            `;
        }
        updateInfoPanel();
        
        function spawnDriftingCell() {
            if (driftingCells.length >= 5 || encounterActive) return;
            const side = Math.floor(Math.random() * 4);
            let x, y;
            if (side === 0) { x = -50; y = Math.random() * canvas.height; }
            else if (side === 1) { x = canvas.width + 50; y = Math.random() * canvas.height; }
            else if (side === 2) { x = Math.random() * canvas.width; y = -50; }
            else { x = Math.random() * canvas.width; y = canvas.height + 50; }
            
            const types = ['friendly', 'hostile', 'neutral', 'mysterious'];
            const type = types[Math.floor(Math.random() * types.length)];
            
            driftingCells.push({
                x, y,
                vx: (Math.random() - 0.5) * 2,
                vy: (Math.random() - 0.5) * 2,
                size: 20 + Math.random() * 20,
                type,
                design: generateCellDesign()
            });
        }
        
        function showEncounter(cell) {
            encounterActive = true;
            currentEncounter = cell;
            
            const titles = { friendly: 'ìš°í˜¸ì ì¸ ì˜ì‹', hostile: 'ì ëŒ€ì ì¸ ì˜ì‹', neutral: 'ì¤‘ë¦½ì ì¸ ì˜ì‹', mysterious: 'ì‹ ë¹„ë¡œìš´ ì˜ì‹' };
            const descs = {
                friendly: 'ì´ ì˜ì‹ì€ ë‹¹ì‹ ì—ê²Œ í˜¸ì˜ë¥¼ ë³´ì´ê³  ìˆìŠµë‹ˆë‹¤.',
                hostile: 'ì´ ì˜ì‹ì€ ë‹¹ì‹ ì„ ê²½ê³„í•˜ê³  ìˆìŠµë‹ˆë‹¤.',
                neutral: 'ì´ ì˜ì‹ì€ ë‹¹ì‹ ì—ê²Œ ê´€ì‹¬ì´ ì—†ì–´ ë³´ì…ë‹ˆë‹¤.',
                mysterious: 'ì´ ì˜ì‹ì—ì„œ ì´ìƒí•œ ì—ë„ˆì§€ê°€ ëŠê»´ì§‘ë‹ˆë‹¤.'
            };
            
            document.getElementById('encounterTitle').textContent = titles[cell.type];
            document.getElementById('encounterDesc').textContent = descs[cell.type];
            
            const choices = [
                { id: 'absorb', title: 'í¡ìˆ˜í•œë‹¤', effect: '+50 ì—”íŠ¸ë¡œí”¼, ê³µê²©ì„±â†‘' },
                { id: 'merge', title: 'í•©ì²´í•œë‹¤', effect: 'ëŠ¥ë ¥ì¹˜ ì¦ê°€ ê°€ëŠ¥' },
                { id: 'ignore', title: 'ë¬´ì‹œí•œë‹¤', effect: 'ì•ˆì „í•˜ê²Œ í†µê³¼' },
                { id: 'talk', title: 'ëŒ€í™”í•œë‹¤', effect: 'ëœë¤ ì´ë²¤íŠ¸' }
            ];
            
            document.getElementById('encounterChoices').innerHTML = choices.map(c => `
                <div class="encounter-choice" onclick="window.makeChoice('${c.id}')">
                    <div class="choice-title">${c.title}</div>
                    <div class="choice-effect">${c.effect}</div>
                </div>
            `).join('');
            
            document.getElementById('encounterDialog').classList.add('active');
        }
        
        async function makeChoice(choice) {
            document.getElementById('encounterDialog').classList.remove('active');
            const cell = currentEncounter;
            
            if (choice === 'absorb') {
                State.game.entropy += 50;
                showToast('âš¡ +50 ì—”íŠ¸ë¡œí”¼ í¡ìˆ˜!', 'success');
            } else if (choice === 'merge') {
                State.game.mergedCells = (State.game.mergedCells || 0) + 1;
                const bonus = Math.random();
                if (bonus < 0.3) { State.game.entropy += 100; showToast('ğŸ§¬ í•©ì²´ ì„±ê³µ! +100 ì—”íŠ¸ë¡œí”¼', 'success'); }
                else if (bonus < 0.6) { showToast('ğŸ§¬ í•©ì²´ ì„±ê³µ! ì´ë™ ì†ë„ ì¦ê°€', 'success'); player.speed += 0.5; }
                else { showToast('ğŸ§¬ í•©ì²´... íš¨ê³¼ ì—†ìŒ', 'info'); }
            } else if (choice === 'ignore') {
                showToast('ë¬´ì‚¬íˆ ì§€ë‚˜ê°”ìŠµë‹ˆë‹¤', 'info');
            } else if (choice === 'talk') {
                const events = [
                    { msg: 'ğŸ’¬ "ë¨¼ ê³³ì—ì„œ ì™”êµ¬ë‚˜... ì¡°ì‹¬í•´ë¼."', entropy: 30 },
                    { msg: 'ğŸ’¬ "í–‰ì„±ì„ ì°¾ê³  ìˆêµ¬ë‚˜? ê³„ì† ê°€ë©´ ìˆë‹¤."', entropy: 20 },
                    { msg: 'ğŸ’¬ "..."  (ì•„ë¬´ ë§ì´ ì—†ë‹¤)', entropy: 0 },
                    { msg: 'âš ï¸ í•¨ì •ì´ì—ˆë‹¤! ì—ë„ˆì§€ë¥¼ ë¹¼ì•—ê²¼ë‹¤.', entropy: -30 }
                ];
                const event = events[Math.floor(Math.random() * events.length)];
                State.game.entropy = Math.max(0, State.game.entropy + event.entropy);
                showToast(event.msg, event.entropy >= 0 ? 'info' : 'error');
            }
            
            driftingCells = driftingCells.filter(c => c !== cell);
            encounterActive = false;
            currentEncounter = null;
            await State.sync();
            updateInfoPanel();
        }
        
        function update() {
            if (encounterActive) return;
            
            let mx = 0, my = 0;
            if (keys['w'] || keys['arrowup']) my = -1;
            if (keys['s'] || keys['arrowdown']) my = 1;
            if (keys['a'] || keys['arrowleft']) mx = -1;
            if (keys['d'] || keys['arrowright']) mx = 1;
            if (mx && my) { mx *= 0.707; my *= 0.707; }
            
            player.x += mx * player.speed;
            player.y += my * player.speed;
            player.x = Math.max(40, Math.min(canvas.width - 40, player.x));
            player.y = Math.max(40, Math.min(canvas.height - 40, player.y));
            
            if (mx !== 0 || my !== 0) {
                driftProgress += 0.5;
                State.game.driftProgress = driftProgress;
                document.getElementById('worldStatValue').textContent = Math.floor(driftProgress) + 'm';
                updateInfoPanel();
            }
            
            if (driftProgress >= targetDistance) {
                worldRunning = false;
                cleanup();
                canvas.classList.remove('active');
                document.getElementById('worldUI').classList.remove('active');
                document.getElementById('worldControls').classList.remove('active');
                
                State.game.stage = 2;
                State.game.history.push({ chapter: State.game.history.length + 1, title: 'í–‰ì„± ë°œê²¬', content: 'ì˜¤ëœ í‘œë¥˜ ëì— ë“œë””ì–´ í–‰ì„±ì´ ë ˆì´ë”ì— ì¡í˜”ë‹¤. ì € í‘¸ë¥¸ ë³„ì—ì„œ ìƒˆë¡œìš´ ì‚¶ì„ ì‹œì‘í•  ìˆ˜ ìˆì„ ê²ƒì´ë‹¤.', timestamp: new Date().toISOString() });
                State.sync();
                
                showStory('ğŸŒ', 'í–‰ì„± ë°œê²¬!', 'ì˜¤ëœ <strong>ìš°ì£¼ í‘œë¥˜</strong> ëì—<br>ë“œë””ì–´ <strong>í–‰ì„±</strong>ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤!<br><br>ì°©ë¥™ì„ ì‹œë„í•´ì•¼ í•©ë‹ˆë‹¤.', 'ì°©ë¥™ ì‹œì‘', () => navigate('landing'));
                return;
            }
            
            // Drifting cells
            if (Math.random() < 0.01) spawnDriftingCell();
            
            driftingCells.forEach(cell => {
                cell.x += cell.vx;
                cell.y += cell.vy;
                
                const dx = player.x - cell.x, dy = player.y - cell.y;
                const d = Math.sqrt(dx * dx + dy * dy);
                
                if (d < 60 && !encounterActive) {
                    showEncounter(cell);
                }
            });
            
            driftingCells = driftingCells.filter(c => c.x > -100 && c.x < canvas.width + 100 && c.y > -100 && c.y < canvas.height + 100);
        }
        
        function drawBg() {
            ctx.fillStyle = '#030308';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Stars moving
            ctx.fillStyle = 'rgba(255,255,255,0.6)';
            for (let i = 0; i < 200; i++) {
                const x = (i * 137.5 + time * 0.5) % canvas.width;
                const y = (i * 73.7) % canvas.height;
                const s = ((i % 3) + 1) * 0.8;
                ctx.beginPath();
                ctx.arc(x, y, s, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // Nebula
            ctx.globalAlpha = 0.1;
            const nebula = ctx.createRadialGradient(canvas.width * 0.3, canvas.height * 0.7, 0, canvas.width * 0.3, canvas.height * 0.7, 400);
            nebula.addColorStop(0, '#7b2cbf');
            nebula.addColorStop(1, 'transparent');
            ctx.fillStyle = nebula;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.globalAlpha = 1;
        }
        
        function drawDriftingCells() {
            driftingCells.forEach(cell => {
                const colors = { friendly: '#4ade80', hostile: '#f87171', neutral: '#a3a3a3', mysterious: '#c084fc' };
                ctx.save();
                ctx.globalAlpha = 0.8;
                const tempDesign = { ...cell.design, primaryColor: colors[cell.type] };
                drawCell(ctx, cell.x, cell.y, cell.size, tempDesign, null, time);
                ctx.restore();
            });
        }
        
        function drawPlayer() {
            drawCell(ctx, player.x, player.y, 35, design, State.game.evolution, time);
        }
        
        function loop() {
            if (!worldRunning) { cleanup(); return; }
            time++;
            update();
            drawBg();
            drawDriftingCells();
            drawPlayer();
            requestAnimationFrame(loop);
        }
        
        document.getElementById('worldStatValue').textContent = Math.floor(driftProgress) + 'm';
        loop();
    }
    
    window.makeChoice = makeChoice;
    
    // ========================================
    // PLANET LANDING (Stage 2)
    // ========================================
    function startPlanetLanding() {
        document.getElementById('app').innerHTML = '';
        const canvas = document.getElementById('worldCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        canvas.classList.add('active');
        
        document.getElementById('worldUI').classList.add('active');
        document.getElementById('worldStatLabel').textContent = 'DISTANCE';
        document.getElementById('worldNavButtons').innerHTML = '<button class="world-nav-btn" onclick="window.exitWorld()">ğŸ  í¬ê¸°</button>';
        document.getElementById('worldInfoPanel').innerHTML = `
            <div class="world-info-title">ğŸ›¡ï¸ ì‹¤ë“œ</div>
            <div class="progress-bar"><div class="progress-fill" id="healthBar" style="width:100%;background:linear-gradient(90deg, var(--danger), var(--accent))"></div></div>
        `;
        document.getElementById('worldControls').classList.remove('active');
        
        worldRunning = true;
        const design = State.game.cellDesign || generateCellDesign();
        const targetPlanet = { name: PLANET_NAMES[Math.floor(Math.random() * PLANET_NAMES.length)], type: PLANET_TYPES[Math.floor(Math.random() * PLANET_TYPES.length)] };
        
        const player = { x: canvas.width / 2, y: 100, size: 30, health: 100, speed: 8 };
        let obstacles = [];
        let distance = 0;
        const targetDistance = 3000;
        let gameOver = false;
        let time = 0;
        const keys = {};
        
        function onKeyDown(e) { keys[e.key.toLowerCase()] = true; if (e.key === 'Escape') { worldRunning = false; exitLanding(); } }
        function onKeyUp(e) { keys[e.key.toLowerCase()] = false; }
        function onResize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        
        window.addEventListener('keydown', onKeyDown);
        window.addEventListener('keyup', onKeyUp);
        window.addEventListener('resize', onResize);
        
        function cleanup() {
            window.removeEventListener('keydown', onKeyDown);
            window.removeEventListener('keyup', onKeyUp);
            window.removeEventListener('resize', onResize);
        }
        
        function exitLanding() {
            cleanup();
            canvas.classList.remove('active');
            document.getElementById('worldUI').classList.remove('active');
            document.getElementById('resultModal').classList.remove('active');
            navigate('dashboard');
        }
        
        function spawnObstacle() {
            const type = Math.random();
            if (type < 0.5) {
                obstacles.push({ type: 'asteroid', x: Math.random() * (canvas.width - 60) + 30, y: canvas.height + 50, size: 20 + Math.random() * 30, speed: 3 + Math.random() * 3, rotation: 0, rotSpeed: (Math.random() - 0.5) * 0.1 });
            } else {
                const width = 100 + Math.random() * 200;
                obstacles.push({ type: 'barrier', x: Math.random() * (canvas.width - width), y: canvas.height + 30, width, height: 20, speed: 4 + Math.random() * 2 });
            }
        }
        
        function update() {
            if (gameOver) return;
            if (keys['a'] || keys['arrowleft']) player.x -= player.speed;
            if (keys['d'] || keys['arrowright']) player.x += player.speed;
            player.x = Math.max(player.size, Math.min(canvas.width - player.size, player.x));
            
            distance += 5;
            document.getElementById('worldStatValue').textContent = `${Math.floor(distance)}m / ${targetDistance}m`;
            
            if (Math.random() < 0.03 + (distance / targetDistance) * 0.02) spawnObstacle();
            
            obstacles = obstacles.filter(o => {
                o.y -= o.speed;
                if (o.rotation !== undefined) o.rotation += o.rotSpeed;
                
                let hit = false;
                if (o.type === 'asteroid') { if (Math.sqrt((player.x - o.x)**2 + (player.y - o.y)**2) < player.size + o.size) hit = true; }
                else if (o.type === 'barrier') { if (player.x > o.x - player.size && player.x < o.x + o.width + player.size && player.y > o.y - player.size && player.y < o.y + o.height + player.size) hit = true; }
                
                if (hit) {
                    player.health -= 20;
                    document.getElementById('healthBar').style.width = player.health + '%';
                    if (player.health <= 0) { gameOver = true; showLandingResult(false, targetPlanet); }
                    return false;
                }
                return o.y > -100;
            });
            
            if (distance >= targetDistance) { gameOver = true; showLandingResult(true, targetPlanet); }
        }
        
        function showLandingResult(success, planet) {
            setTimeout(async () => {
                document.getElementById('resultIcon').textContent = success ? 'ğŸª' : 'ğŸ’¥';
                document.getElementById('resultTitle').textContent = success ? 'ì°©ë¥™ ì„±ê³µ!' : 'ì°©ë¥™ ì‹¤íŒ¨';
                document.getElementById('resultDesc').textContent = success ? `${planet.name}ì— ë¬´ì‚¬íˆ ë„ì°©í–ˆìŠµë‹ˆë‹¤!` : 'ì¥ì• ë¬¼ì— ë¶€ë”ªí˜€ ì¶”ë½í–ˆìŠµë‹ˆë‹¤.';
                
                if (success) {
                    State.game.currentPlanet = planet;
                    State.game.stage = 3;
                    State.game.history.push({ chapter: State.game.history.length + 1, title: 'ìƒˆë¡œìš´ ì„¸ê³„', content: `ì˜¤ëœ ì—¬ì • ëì— ${planet.name}ì— ì°©ë¥™í–ˆë‹¤. ${planet.type}... ì´ê³³ì—ì„œ ìƒˆë¡œìš´ ì‚¶ì´ ì‹œì‘ëœë‹¤.`, timestamp: new Date().toISOString() });
                    await State.sync();
                    document.getElementById('resultActions').innerHTML = '<button class="btn btn-primary" onclick="window.explorePlanet()">ğŸŒ í–‰ì„± íƒí—˜</button>';
                } else {
                    document.getElementById('resultActions').innerHTML = '<button class="btn btn-outline" onclick="window.retryLanding()">ë‹¤ì‹œ ì‹œë„</button><button class="btn btn-primary" onclick="window.goHome()">í™ˆìœ¼ë¡œ</button>';
                }
                
                document.getElementById('resultModal').classList.add('active');
            }, 500);
        }
        
        function drawBg() {
            const g = ctx.createLinearGradient(0, 0, 0, canvas.height);
            g.addColorStop(0, '#050510'); g.addColorStop(0.7, '#0a0a2a'); g.addColorStop(1, '#1a1a4a');
            ctx.fillStyle = g;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = 'rgba(255,255,255,0.6)';
            for (let i = 0; i < 50; i++) {
                const x = (i * 137.5) % canvas.width;
                const y = ((i * 73.7 + distance * 0.5) % canvas.height);
                ctx.beginPath(); ctx.arc(x, y, 1 + Math.random(), 0, Math.PI * 2); ctx.fill();
            }
            
            const progress = Math.min(distance / targetDistance, 1);
            const planetSize = 200 + progress * 300;
            const planetY = canvas.height + 200 - progress * 300;
            const pg = ctx.createRadialGradient(canvas.width/2 - planetSize * 0.2, planetY - planetSize * 0.2, 0, canvas.width/2, planetY, planetSize);
            pg.addColorStop(0, '#4ade80'); pg.addColorStop(0.5, '#22c55e'); pg.addColorStop(1, '#14532d');
            ctx.beginPath(); ctx.arc(canvas.width/2, planetY, planetSize, 0, Math.PI * 2);
            ctx.fillStyle = pg; ctx.fill();
        }
        
        function drawObstacles() {
            obstacles.forEach(o => {
                if (o.type === 'asteroid') {
                    ctx.save(); ctx.translate(o.x, o.y); ctx.rotate(o.rotation);
                    ctx.beginPath();
                    for (let i = 0; i < 8; i++) {
                        const angle = (i / 8) * Math.PI * 2;
                        const r = o.size * (0.8 + Math.sin(i * 2.5) * 0.2);
                        i === 0 ? ctx.moveTo(Math.cos(angle) * r, Math.sin(angle) * r) : ctx.lineTo(Math.cos(angle) * r, Math.sin(angle) * r);
                    }
                    ctx.closePath(); ctx.fillStyle = '#4b5563'; ctx.fill();
                    ctx.restore();
                } else if (o.type === 'barrier') {
                    ctx.fillStyle = 'rgba(239, 68, 68, 0.8)';
                    ctx.shadowColor = '#ef4444'; ctx.shadowBlur = 20;
                    ctx.fillRect(o.x, o.y, o.width, o.height);
                    ctx.shadowBlur = 0;
                }
            });
        }
        
        function drawPlayer() { drawCell(ctx, player.x, player.y, player.size, design, State.game.evolution, time); }
        
        function loop() {
            if (!worldRunning) { cleanup(); return; }
            time++;
            if (!gameOver) update();
            drawBg(); drawObstacles(); drawPlayer();
            requestAnimationFrame(loop);
        }
        
        loop();
    }
    
    function explorePlanet() {
        document.getElementById('resultModal').classList.remove('active');
        worldRunning = false;
        document.getElementById('worldCanvas').classList.remove('active');
        document.getElementById('worldUI').classList.remove('active');
        navigate('planet');
    }
    
    function retryLanding() {
        document.getElementById('resultModal').classList.remove('active');
        startPlanetLanding();
    }
    
    function goHome() {
        document.getElementById('resultModal').classList.remove('active');
        worldRunning = false;
        document.getElementById('worldCanvas').classList.remove('active');
        document.getElementById('worldUI').classList.remove('active');
        navigate('dashboard');
    }
    
    // Edit Cell Modal
    let previewAnimationId = null;
    let tempDesign = null;
    
    function openEditModal() {
        const modal = document.getElementById('editCellModal');
        modal.classList.add('active');
        tempDesign = { ...(State.game.cellDesign || generateCellDesign()) };
        document.getElementById('cellNameInput').value = tempDesign.name || '';
        document.getElementById('primaryColorPicker').value = hslToHex(tempDesign.primaryColor);
        document.getElementById('secondaryColorPicker').value = hslToHex(tempDesign.secondaryColor);
        document.querySelectorAll('.pattern-option').forEach(opt => opt.classList.toggle('selected', opt.dataset.pattern === tempDesign.pattern));
        startPreviewAnimation();
    }
    
    function closeEditModal() {
        document.getElementById('editCellModal').classList.remove('active');
        if (previewAnimationId) cancelAnimationFrame(previewAnimationId);
    }
    
    function startPreviewAnimation() {
        const canvas = document.getElementById('cellPreview');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        let t = 0;
        function animate() {
            t++;
            ctx.clearRect(0, 0, 150, 150);
            drawCell(ctx, 75, 75, 35, tempDesign, State.game.evolution, t);
            previewAnimationId = requestAnimationFrame(animate);
        }
        animate();
    }
    
    function updatePreviewDesign() {
        tempDesign.name = document.getElementById('cellNameInput').value;
        tempDesign.primaryColor = document.getElementById('primaryColorPicker').value;
        tempDesign.secondaryColor = document.getElementById('secondaryColorPicker').value;
    }
    
    document.addEventListener('input', (e) => {
        if (e.target.id === 'cellNameInput' || e.target.id === 'primaryColorPicker' || e.target.id === 'secondaryColorPicker') updatePreviewDesign();
    });
    
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('pattern-option')) {
            document.querySelectorAll('.pattern-option').forEach(opt => opt.classList.remove('selected'));
            e.target.classList.add('selected');
            tempDesign.pattern = e.target.dataset.pattern;
        }
    });
    
    function randomizeCellDesign() {
        tempDesign = generateCellDesign();
        document.getElementById('cellNameInput').value = tempDesign.name;
        document.getElementById('primaryColorPicker').value = hslToHex(tempDesign.primaryColor);
        document.getElementById('secondaryColorPicker').value = hslToHex(tempDesign.secondaryColor);
        document.querySelectorAll('.pattern-option').forEach(opt => opt.classList.toggle('selected', opt.dataset.pattern === tempDesign.pattern));
    }
    
    async function saveCellDesign() {
        updatePreviewDesign();
        State.game.cellDesign = { ...tempDesign };
        await State.sync();
        closeEditModal();
        showToast('âœ¨ ì„¸í¬ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        render();
    }
    
    // Auth
    async function googleLogin() {
        try {
            document.getElementById('loadingScreen').classList.remove('hidden');
            const result = await signInWithPopup(auth, googleProvider);
            const user = result.user;
            const snap = await getDoc(doc(db, 'users', user.uid));
            if (!snap.exists()) {
                const newDesign = generateCellDesign();
                await setDoc(doc(db, 'users', user.uid), {
                    displayName: user.displayName, email: user.email, photoURL: user.photoURL,
                    game: { entropy: 0, stage: 1, evolution: { eye: false, arm: false, leg: false, brain: false, wing: false }, currentPlanet: null, territories: [], history: [], cellDesign: newDesign, driftProgress: 0, mergedCells: 0, resources: { metal: 0, energy: 0, fuel: 0 }, signalDecoded: false, shipBuilt: false, firstContact: null },
                    createdAt: serverTimestamp(), updatedAt: serverTimestamp()
                });
                showToast('ğŸ‰ ìš°ì£¼ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!', 'success');
            }
        } catch (e) { console.error('Login error:', e); showToast('ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + e.message, 'error'); hideLoading(); }
    }
    
    async function logout() { await signOut(auth); State.user = null; navigate('login'); }
    
    // Init
    async function init() {
        createStars();
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                State.user = user;
                await State.load();
                if (!State.game.cellDesign) { State.game.cellDesign = generateCellDesign(); await State.sync(); }
                hideLoading();
                navigate('dashboard');
            } else {
                State.user = null;
                hideLoading();
                navigate('login');
            }
        });
        
        window.nav = navigate;
        window.googleLogin = googleLogin;
        window.logout = logout;
        window.exitWorld = exitWorld;
        window.goToDrift = goToDrift;
        window.openEditModal = openEditModal;
        window.closeEditModal = closeEditModal;
        window.randomizeCellDesign = randomizeCellDesign;
        window.saveCellDesign = saveCellDesign;
        window.clickTerritory = clickTerritory;
        window.gatherResources = gatherResources;
        window.createPost = createPost;
        window.startPuzzle = startPuzzle;
        window.clickPuzzleCell = clickPuzzleCell;
        window.closePuzzleModal = closePuzzleModal;
        window.buildShip = buildShip;
        window.firstContact = firstContact;
        window.enterGalaxy = enterGalaxy;
        window.explorePlanet = explorePlanet;
        window.retryLanding = retryLanding;
        window.goHome = goHome;
        window.closeStory = closeStory;
        window.toggleUserMenu = toggleUserMenu;
    }
    
    init();
    </script>
</body>
</html>
