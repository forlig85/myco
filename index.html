<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOKLUCK COMMUNITY</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;800&display=swap');
        
        body { background-color: #0f172a; color: #f8fafc; font-family: 'Pretendard', sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        
        /* ë””ìì¸ ìš”ì†Œ */
        .card { background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        
        button { cursor: pointer; border: none; border-radius: 8px; font-weight: 600; padding: 12px 20px; transition: 0.2s; font-family: 'Pretendard'; }
        .btn-primary { background: #3b82f6; color: white; width: 100%; font-size: 16px; }
        .btn-primary:hover { background: #2563eb; }
        .btn-market { background: linear-gradient(135deg, #0ea5e9, #6366f1); color: white; width: 100%; font-size: 18px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(14, 165, 233, 0.4); }
        .btn-small { padding: 6px 12px; font-size: 13px; margin-left: 5px; cursor: pointer; border-radius: 4px; border:none; }
        .btn-cheat { background: #ef4444; color: white; width: 100%; margin-bottom: 20px; border: 2px dashed #fca5a5; }
        
        /* í—¤ë” */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 2px solid #3b82f6; padding-bottom: 15px; }
        .logo { font-size: 24px; font-weight: 800; color: #38bdf8; }
        .wallet { background: #0f172a; padding: 8px 16px; border-radius: 20px; border: 1px solid #38bdf8; color: #38bdf8; font-weight: bold; font-size: 14px; }

        /* ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .board-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #334155; cursor: pointer; transition: 0.2s; }
        .board-item:hover { background: #334155; }
        .board-name { font-size: 18px; font-weight: bold; color: #e2e8f0; }
        
        .post-item { padding: 15px; border-bottom: 1px solid #334155; cursor: pointer; }
        .post-item:hover { background: #2d384d; }
        .post-title { font-size: 16px; font-weight: bold; margin-bottom: 5px; color: #fff; }
        .post-meta { font-size: 13px; color: #94a3b8; display: flex; justify-content: space-between; }

        input, textarea { width: 100%; background: #0f172a; border: 1px solid #475569; color: white; padding: 15px; border-radius: 8px; box-sizing: border-box; font-size: 16px; margin-bottom: 10px; font-family: 'Pretendard'; }
        input:focus, textarea:focus { outline: none; border-color: #38bdf8; }
        
        .view-content { white-space: pre-wrap; line-height: 1.6; font-size: 16px; color: #e2e8f0; min-height: 100px; }
        .hidden { display: none; }
        .back-link { color: #94a3b8; cursor: pointer; font-size: 14px; margin-bottom: 10px; display: inline-block; }
    </style>
</head>
<body>
    <header>
        <div class="logo">BOKLUCK</div>
        <div id="walletBadge" class="wallet">ì—°ê²° ì¤‘...</div>
    </header>

    <div id="authSection" class="card" style="text-align: center;">
        <h2>BOKLUCK ì ‘ì†</h2>
        <p style="color:#94a3b8; margin-bottom:20px;">ë¡œê·¸ì¸í•˜ì—¬ ìì‚°ì„ ê´€ë¦¬í•˜ê³  ì˜í† ë¥¼ í™•ì¥í•˜ì„¸ìš”.</p>
        <button id="loginBtn" class="btn-primary">Google ê³„ì •ìœ¼ë¡œ ì‹œì‘í•˜ê¸°</button>
    </div>

    <div id="mainDashboard" class="hidden">
        
        <button class="btn-cheat" onclick="getRich()">ğŸ› ï¸ [í…ŒìŠ¤íŠ¸ìš©] 100,000 BOK ì¶©ì „í•˜ê¸° (í´ë¦­)</button>

        <button class="btn-market" onclick="location.href='market.html'">ğŸ—ºï¸ ë¶€ë™ì‚° ë§ˆì¼“ ì…ì¥ (ì˜í†  í™•ì¥)</button>

        <div id="boardListSection">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3>ğŸ“‚ ì»¤ë®¤ë‹ˆí‹° ê²Œì‹œíŒ</h3>
                <button class="btn-small" style="background:#22c55e; color:white;" onclick="createBoard()">+ ê²Œì‹œíŒ ì†Œìœ ê¶Œ êµ¬ë§¤ (1,000 BOK)</button>
            </div>
            <div class="card" id="boardList">
                <div style="padding:20px; text-align:center; color:#94a3b8;">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
        </div>

        <div id="postListSection" class="hidden">
            <span class="back-link" onclick="showBoardList()">â† ê²Œì‹œíŒ ëª©ë¡</span>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 id="currentBoardName">ê²Œì‹œíŒ</h3>
                <button class="btn-small btn-primary" onclick="showWriteForm()">ğŸ–Šï¸ ê¸€ì“°ê¸° (ë³´ìƒ íšë“)</button>
            </div>
            <div class="card" id="postList"></div>
        </div>

        <div id="writeSection" class="hidden">
            <span class="back-link" onclick="backToPostList()">â† ì·¨ì†Œ</span>
            <div class="card">
                <h3>ğŸ“ ì½˜í…ì¸  ìƒì‚° (ìì‚° íšë“)</h3>
                <p style="font-size:12px; color:#94a3b8; margin-bottom:10px;">ì–‘ì§ˆì˜ ê¸€ì„ ì‘ì„±í•˜ë©´ BOK ìì‚°ì´ ì§€ê¸‰ë©ë‹ˆë‹¤.</p>
                <input type="text" id="title" placeholder="ì œëª©">
                <textarea id="content" rows="8" placeholder="ë‚´ìš© (10ì ì´ìƒ ì‘ì„±)"></textarea>
                <button id="saveBtn" class="btn-primary">ë“±ë¡ ì™„ë£Œ</button>
            </div>
        </div>

        <div id="viewSection" class="hidden">
            <span class="back-link" onclick="backToPostList()">â† ëª©ë¡ìœ¼ë¡œ</span>
            <div class="card">
                <h2 id="viewTitle" style="margin-top:0;">ì œëª©</h2>
                <div style="border-bottom:1px solid #334155; padding-bottom:10px; margin-bottom:20px; color:#94a3b8; font-size:14px; display:flex; justify-content:space-between;">
                    <span id="viewAuthor">ì‘ì„±ì</span>
                    <div id="viewControls"></div>
                </div>
                <div id="viewContent" class="view-content">ë‚´ìš©</div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, setDoc, getDoc, updateDoc, runTransaction, increment, where } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

        // í‚¤ ìë™ ì ìš©ë¨
        const firebaseConfig = {
          apiKey: "AIzaSyBwQjuqgWM4YKnqu_gzNbeCg5alrC-jVcQ",
          authDomain: "myco-737a0.firebaseapp.com",
          projectId: "myco-737a0",
          storageBucket: "myco-737a0.firebasestorage.app",
          messagingSenderId: "942571332540",
          appId: "1:942571332540:web:be0bb6fbdd32655501c1b9"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUser = null;
        let currentBoardId = null;
        let currentPostId = null; 
        let isEditMode = false;

        // UI ì œì–´ í•¨ìˆ˜
        window.showBoardList = () => { hideAll(); document.getElementById("boardListSection").style.display = "block"; }
        window.showPostList = (boardId, boardName) => {
            currentBoardId = boardId;
            document.getElementById("currentBoardName").innerText = boardName;
            hideAll(); document.getElementById("postListSection").style.display = "block";
            loadPosts(boardId);
        }
        window.showWriteForm = () => {
            isEditMode = false;
            document.getElementById("title").value = "";
            document.getElementById("content").value = "";
            document.getElementById("saveBtn").innerText = "ë“±ë¡ ì™„ë£Œ (+100 BOK)";
            hideAll(); document.getElementById("writeSection").style.display = "block";
        }
        window.backToPostList = () => { hideAll(); document.getElementById("postListSection").style.display = "block"; }
        function hideAll() {
            document.getElementById("boardListSection").style.display = "none";
            document.getElementById("postListSection").style.display = "none";
            document.getElementById("writeSection").style.display = "none";
            document.getElementById("viewSection").style.display = "none";
        }

        // ğŸ’° í…ŒìŠ¤íŠ¸ ìê¸ˆ ì¶©ì „ í•¨ìˆ˜ (ì¹˜íŠ¸í‚¤)
        window.getRich = async () => {
            if(!currentUser) return alert("ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.");
            if(!confirm("í…ŒìŠ¤íŠ¸ ìê¸ˆ 100,000 BOKì„ ì¶©ì „í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            
            try {
                await updateDoc(doc(db, "users", currentUser.uid), {
                    coin: increment(100000)
                });
                alert("ì¶©ì „ ì™„ë£Œ! ì´ì œ ë¶€ë™ì‚°ì„ ë§ˆìŒê» ì‡¼í•‘í•˜ì„¸ìš”. ğŸ’¸");
            } catch(e) { alert("ì¶©ì „ ì‹¤íŒ¨: " + e); }
        }

        // ë¡œê·¸ì¸ ë¡œì§
        document.getElementById("loginBtn").addEventListener("click", () => {
            signInWithPopup(auth, new GoogleAuthProvider()).catch(err => alert("ë¡œê·¸ì¸ ì˜¤ë¥˜: " + err.message));
        });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById("authSection").style.display = "none";
                document.getElementById("mainDashboard").style.display = "block";
                document.getElementById("walletBadge").style.display = "block";
                
                onSnapshot(doc(db, "users", user.uid), (d) => {
                    const coin = d.exists() ? d.data().coin : 0;
                    document.getElementById("walletBadge").innerText = `ğŸ’° ë³´ìœ  ìì‚°: ${coin.toLocaleString()} BOK`;
                    if(!d.exists()) setDoc(doc.ref, {name: user.displayName, email: user.email, coin: 500});
                });
                createDefaultBoard();
            } else {
                document.getElementById("authSection").style.display = "block";
                document.getElementById("mainDashboard").style.display = "none";
            }
        });

        // ê²Œì‹œíŒ ëª©ë¡ ë¡œì§
        async function createDefaultBoard() {
             // ì‹œìŠ¤í…œì´ ìë™ìœ¼ë¡œ ì²´í¬
        }
        onSnapshot(query(collection(db, "boards"), orderBy("createdAt", "desc")), (snapshot) => {
            const list = document.getElementById("boardList");
            list.innerHTML = "";
            if(snapshot.empty) {
                setDoc(doc(collection(db, "boards")), { name: "ììœ ê²Œì‹œíŒ", creatorName: "SYSTEM", isDefault: true, createdAt: new Date().toISOString() });
            }
            snapshot.forEach(doc => {
                const b = doc.data();
                const div = document.createElement("div");
                div.className = "board-item";
                div.innerHTML = `<div><div class="board-name">${b.name}</div><div style="font-size:12px; color:#94a3b8;">ì†Œìœ ì: ${b.creatorName}</div></div><div style="color:#64748b;">ì…ì¥ ></div>`;
                div.onclick = () => showPostList(doc.id, b.name);
                list.appendChild(div);
            });
        });

        // ê²Œì‹œíŒ êµ¬ë§¤
        window.createBoard = async () => {
            const name = prompt("ê°œì„¤í•  ê²Œì‹œíŒ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš” (ë¹„ìš©: 1,000 BOK)");
            if(!name) return;
            try {
                await runTransaction(db, async (t) => {
                    const userRef = doc(db, "users", currentUser.uid);
                    const userDoc = await t.get(userRef);
                    if(userDoc.data().coin < 1000) throw "ìì‚°(BOK)ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.";
                    t.update(userRef, { coin: increment(-1000) });
                    const newBoardRef = doc(collection(db, "boards"));
                    t.set(newBoardRef, { name: name, creatorName: currentUser.displayName, creatorUid: currentUser.uid, createdAt: new Date().toISOString() });
                });
                alert("ê²Œì‹œíŒ ê°œì„¤ ì™„ë£Œ!");
            } catch(e) { alert(e); }
        }

        // ê¸€ ëª©ë¡ ë¡œì§
        let unsubscribePosts = null;
        function loadPosts(boardId) {
            if(unsubscribePosts) unsubscribePosts();
            const q = query(collection(db, "posts"), where("boardId", "==", boardId), orderBy("date", "desc"));
            unsubscribePosts = onSnapshot(q, (snapshot) => {
                const list = document.getElementById("postList");
                list.innerHTML = "";
                if(snapshot.empty) list.innerHTML = "<div style='padding:20px; text-align:center; color:#64748b;'>ë“±ë¡ëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>";
                snapshot.forEach(d => {
                    const p = d.data();
                    const div = document.createElement("div");
                    div.className = "post-item";
                    div.innerHTML = `<div class="post-title">${p.title}</div><div class="post-meta"><span>${p.author}</span><span>${new Date(p.date).toLocaleDateString()}</span></div>`;
                    div.onclick = () => viewPost(d.id, p);
                    list.appendChild(div);
                });
            });
        }

        // ê¸€ ìƒì„¸ ë° ìˆ˜ì • ë¡œì§
        function viewPost(postId, postData) {
            currentPostId = postId;
            document.getElementById("viewTitle").innerText = postData.title;
            document.getElementById("viewAuthor").innerText = `${postData.author} | ${new Date(postData.date).toLocaleString()}`;
            document.getElementById("viewContent").innerText = postData.content;
            
            const controls = document.getElementById("viewControls");
            controls.innerHTML = "";
            if(currentUser && postData.uid === currentUser.uid) {
                const editBtn = document.createElement("button");
                editBtn.className = "btn-small";
                editBtn.style.background = "#64748b";
                editBtn.style.color = "white";
                editBtn.innerText = "ìˆ˜ì •í•˜ê¸°";
                editBtn.onclick = () => openEditForm(postData);
                controls.appendChild(editBtn);
            }
            hideAll(); document.getElementById("viewSection").style.display = "block";
        }

        function openEditForm(postData) {
            isEditMode = true;
            document.getElementById("title").value = postData.title;
            document.getElementById("content").value = postData.content;
            document.getElementById("saveBtn").innerText = "ìˆ˜ì • ì™„ë£Œ";
            hideAll(); document.getElementById("writeSection").style.display = "block";
        }

        document.getElementById("saveBtn").addEventListener("click", async () => {
            const title = document.getElementById("title").value.trim();
            const content = document.getElementById("content").value.trim();
            if(content.length < 10) return alert("ë‚´ìš©ì€ 10ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
            if(!title) return alert("ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.");

            const btn = document.getElementById("saveBtn");
            btn.disabled = true;

            try {
                if(isEditMode) {
                    await updateDoc(doc(db, "posts", currentPostId), { title: title, content: content });
                    alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    backToPostList(); 
                } else {
                    await runTransaction(db, async (t) => {
                        const newPostRef = doc(collection(db, "posts"));
                        t.set(newPostRef, { boardId: currentBoardId, title: title, content: content, author: currentUser.displayName, uid: currentUser.uid, reward: 100, date: new Date().toISOString() });
                        t.update(doc(db, "users", currentUser.uid), { coin: increment(100) });
                    });
                    alert("ë“±ë¡ ì™„ë£Œ! (+100 BOK)");
                    backToPostList();
                }
            } catch(e) { alert(e); }
            finally { btn.disabled = false; }
        });
    </script>
</body>
</html>
