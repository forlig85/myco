<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>BOKLUCK Universe</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸŒŒ</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
    *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;touch-action:manipulation}
    :root{--primary:#00f5d4;--secondary:#7b2cbf;--accent:#f72585;--energy:#fee440;--success:#10b981;--danger:#ff4d6d;--legendary:#ffd700;--epic:#a855f7;--rare:#3b82f6;--bg-space:#0a0a1a;--bg-card:rgba(20,20,40,0.9);--bg-card-solid:#14142a;--bg-input:rgba(10,10,30,0.8);--border:rgba(0,245,212,0.2);--text:#e0e0ff;--text-muted:#8080a0;--gradient-cosmic:linear-gradient(135deg,#667eea 0%,#764ba2 50%,#f72585 100%);--gradient-energy:linear-gradient(135deg,#00f5d4 0%,#fee440 100%);--gradient-evolution:linear-gradient(135deg,#7b2cbf 0%,#f72585 100%)}
    body{background:var(--bg-space);color:var(--text);font-family:'Noto Sans KR',sans-serif;min-height:100vh;overflow-x:hidden;user-select:none;-webkit-user-select:none}
    .font-display{font-family:'Orbitron',sans-serif}
    #stars{position:fixed;inset:0;z-index:-1}.star{position:absolute;background:white;border-radius:50%;animation:twinkle 3s infinite}@keyframes twinkle{0%,100%{opacity:.3}50%{opacity:1}}
    .loading-screen{position:fixed;inset:0;background:var(--bg-space);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:3000}.loading-screen.hidden{display:none}.loading-spinner{width:60px;height:60px;border:3px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}
    .navbar{position:fixed;top:0;left:0;right:0;height:56px;background:rgba(10,10,26,.95);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);z-index:1000;display:flex;align-items:center;padding:0 12px}
    .nav-logo{font-family:'Orbitron',sans-serif;font-size:16px;font-weight:900;background:var(--gradient-energy);-webkit-background-clip:text;-webkit-text-fill-color:transparent;cursor:pointer;margin-right:12px}
    .nav-links{display:flex;gap:2px;flex:1;overflow-x:auto;-webkit-overflow-scrolling:touch}.nav-link{padding:8px 10px;border-radius:8px;color:var(--text-muted);font-size:11px;cursor:pointer;white-space:nowrap;min-width:44px;min-height:44px;display:flex;align-items:center;justify-content:center}.nav-link:hover,.nav-link:active{color:var(--text);background:rgba(30,30,60,.9)}.nav-link.active{color:var(--primary);background:rgba(0,245,212,.1)}.nav-link.locked{opacity:.4;pointer-events:none}
    .nav-right{display:flex;align-items:center;gap:8px}.entropy-badge{display:flex;align-items:center;gap:4px;background:var(--bg-card);border:1px solid var(--border);padding:4px 10px;border-radius:16px}.entropy-value{font-family:'Orbitron',sans-serif;font-size:12px;font-weight:700;color:var(--energy)}
    .user-avatar{width:36px;height:36px;border-radius:50%;border:2px solid var(--primary);cursor:pointer;min-width:36px}.user-dropdown{position:absolute;top:56px;right:12px;background:var(--bg-card-solid);border:1px solid var(--border);border-radius:12px;padding:8px;min-width:140px;display:none;z-index:1001}.user-dropdown.show{display:block}.dropdown-item{padding:12px 14px;border-radius:8px;cursor:pointer;font-size:13px;min-height:44px;display:flex;align-items:center}.dropdown-item:hover,.dropdown-item:active{background:rgba(30,30,60,.9)}.dropdown-item.danger{color:var(--danger)}
    .main-content{padding-top:56px;min-height:100vh;padding-bottom:20px}.page-container{max-width:600px;margin:0 auto;padding:12px}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:12px 20px;border:none;border-radius:10px;font-size:13px;font-weight:600;cursor:pointer;transition:.2s;font-family:inherit;min-height:44px}.btn:active{transform:scale(0.96)}.btn:disabled{opacity:.5;pointer-events:none}.btn-primary{background:var(--gradient-cosmic);color:white}.btn-energy{background:var(--gradient-energy);color:#1a1a2e}.btn-outline{background:transparent;border:1px solid var(--border);color:var(--text)}.btn-sm{padding:8px 14px;font-size:12px;min-height:36px}.btn-block{width:100%}
    .input{width:100%;padding:12px 14px;background:var(--bg-input);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:16px;outline:none}.input:focus{border-color:var(--primary)}
    .card{background:var(--bg-card);border:1px solid var(--border);border-radius:16px;padding:14px}.card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid var(--border)}.card-title{font-family:'Orbitron',sans-serif;font-size:12px;font-weight:700}
    .progress-bar{height:6px;background:rgba(123,44,191,.2);border-radius:3px;overflow:hidden}.progress-fill{height:100%;background:var(--gradient-evolution);border-radius:3px;transition:width .3s}
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center;z-index:2000;padding:12px}.modal-overlay.active{display:flex}.modal{background:var(--bg-card-solid);border:1px solid var(--border);border-radius:20px;padding:20px;max-width:400px;width:100%;max-height:85vh;overflow-y:auto;-webkit-overflow-scrolling:touch}.modal-title{font-family:'Orbitron',sans-serif;font-size:16px;font-weight:700;margin-bottom:8px;text-align:center}.modal-desc{color:var(--text-muted);font-size:13px;margin-bottom:16px;text-align:center}.modal-actions{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
    .toast-container{position:fixed;top:64px;left:12px;right:12px;z-index:2000;display:flex;flex-direction:column;gap:8px}.toast{background:var(--bg-card-solid);border:1px solid var(--border);border-radius:10px;padding:10px 14px;display:flex;align-items:center;gap:8px;animation:slideDown .3s ease}.toast.success{border-color:var(--success)}.toast.error{border-color:var(--danger)}.toast.legendary{border-color:var(--legendary)}@keyframes slideDown{from{transform:translateY(-100%);opacity:0}to{transform:translateY(0);opacity:1}}
    .login-page{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px 16px;text-align:center}.login-logo{font-family:'Orbitron',sans-serif;font-size:36px;font-weight:900;background:var(--gradient-energy);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:8px}.login-subtitle{font-size:14px;color:var(--text-muted);margin-bottom:24px}.login-story{max-width:300px;font-size:13px;color:var(--text-muted);line-height:1.7;margin-bottom:24px}.login-story strong{color:var(--primary)}
    .entity-card{position:relative;overflow:hidden}.entity-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--gradient-evolution)}.entity-visual{width:140px;height:140px;margin:0 auto 8px;cursor:pointer}.entity-name{font-family:'Orbitron',sans-serif;font-size:14px;font-weight:700;text-align:center;margin-bottom:12px}.entity-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:6px}.stat-box{background:rgba(0,245,212,.05);border:1px solid rgba(0,245,212,.1);border-radius:8px;padding:8px 4px;text-align:center}.stat-value{font-family:'Orbitron',sans-serif;font-size:14px;font-weight:700;color:var(--primary)}.stat-label{font-size:8px;color:var(--text-muted);margin-top:2px}
    .quick-actions{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:12px}.quick-action{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:14px 8px;text-align:center;cursor:pointer;min-height:70px;display:flex;flex-direction:column;align-items:center;justify-content:center}.quick-action:active{background:rgba(0,245,212,.1)}.quick-action.locked{opacity:.4;pointer-events:none}.quick-action-icon{font-size:24px;margin-bottom:4px}.quick-action-label{font-size:10px;color:var(--text-muted)}.quick-action.highlight{border-color:var(--energy);background:rgba(254,228,64,.1)}
    .daily-reward-banner{background:linear-gradient(135deg,rgba(254,228,64,.2),rgba(247,37,133,.1));border:1px solid var(--energy);border-radius:14px;padding:12px;margin-bottom:12px;display:flex;align-items:center;gap:12px;cursor:pointer;min-height:60px}.daily-icon{font-size:28px}.daily-info{flex:1}.daily-title{font-family:'Orbitron',sans-serif;font-size:11px;font-weight:700;color:var(--energy)}.daily-desc{font-size:10px;color:var(--text-muted)}.daily-streak{display:flex;gap:3px;margin-top:4px}.streak-dot{width:18px;height:18px;border-radius:50%;background:var(--bg-input);border:2px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:7px}.streak-dot.active{background:var(--gradient-energy);border-color:var(--energy);color:#1a1a2e}.streak-dot.current{border-color:var(--accent);animation:pulse 1s infinite}@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
    .collection-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}.collection-item{background:var(--bg-input);border:2px solid var(--border);border-radius:10px;padding:10px 6px;text-align:center}.collection-item.discovered{border-color:var(--primary)}.collection-item.legendary{border-color:var(--legendary)}.collection-item.epic{border-color:var(--epic)}.collection-item.rare{border-color:var(--rare)}.collection-item.undiscovered{opacity:.4}.collection-icon{font-size:24px;margin-bottom:2px}.collection-name{font-size:9px;font-weight:600}.collection-rarity{font-size:7px;color:var(--text-muted)}
    .planet-map{display:grid;grid-template-columns:repeat(10,1fr);gap:2px;background:var(--bg-input);padding:8px;border-radius:12px;margin-bottom:8px}.map-cell{aspect-ratio:1;background:rgba(0,245,212,.05);border:1px solid var(--border);border-radius:3px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:8px;min-height:28px}.map-cell:active{background:rgba(0,245,212,.2)}.map-cell.explored{background:rgba(0,245,212,.2);border-color:var(--primary)}.map-cell.in-range{background:rgba(254,228,64,.15);border-color:var(--energy)}.map-cell.home{background:rgba(254,228,64,.3);border-color:var(--energy)}
    .galaxy-map-container{position:relative;width:100%;height:350px;background:radial-gradient(ellipse at center,#0a0a2a 0%,#050510 100%);border-radius:16px;overflow:hidden}.galaxy-canvas{width:100%;height:100%}.galaxy-legend{position:absolute;bottom:10px;left:10px;background:rgba(10,10,26,.9);border:1px solid var(--border);border-radius:8px;padding:8px;font-size:9px}.legend-item{display:flex;align-items:center;gap:5px;margin-bottom:3px}.legend-dot{width:8px;height:8px;border-radius:50%}.galaxy-info{position:absolute;top:10px;right:10px;background:rgba(10,10,26,.9);border:1px solid var(--border);border-radius:8px;padding:8px;font-size:10px;min-width:110px}
    .tech-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}.tech-item{background:var(--bg-input);border:2px solid var(--border);border-radius:12px;padding:12px 8px;text-align:center;min-height:100px}.tech-item.unlocked{border-color:var(--success);background:rgba(16,185,129,.1)}.tech-item.available{border-color:var(--primary);cursor:pointer}.tech-item.available:active{background:rgba(0,245,212,.1)}.tech-item.locked{opacity:.5}.tech-icon{font-size:24px;margin-bottom:4px}.tech-name{font-weight:700;font-size:11px;margin-bottom:2px}.tech-desc{font-size:9px;color:var(--text-muted);margin-bottom:4px}.tech-cost{font-size:10px;color:var(--energy)}
    .history-entry{background:var(--bg-input);border-radius:10px;padding:12px;margin-bottom:8px;border-left:3px solid var(--secondary)}.history-chapter{font-family:'Orbitron',sans-serif;font-size:9px;color:var(--accent);margin-bottom:3px}.history-title{font-weight:700;font-size:13px;margin-bottom:3px}.history-content{font-size:11px;color:var(--text-muted);line-height:1.4}
    .parts-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:6px;margin-bottom:12px}.part-item{background:var(--bg-input);border:2px solid var(--border);border-radius:10px;padding:10px 4px;text-align:center;cursor:pointer;min-height:70px}.part-item:active{border-color:var(--primary)}.part-item.selected{border-color:var(--primary);background:rgba(0,245,212,.1)}.part-item.locked{opacity:.5;pointer-events:none}.part-icon{font-size:22px;margin-bottom:2px}.part-name{font-size:9px;font-weight:600}.part-style{font-size:7px;color:var(--text-muted)}
    .style-options{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-top:8px}.style-option{padding:10px 4px;background:var(--bg-input);border:2px solid var(--border);border-radius:8px;cursor:pointer;text-align:center;font-size:9px;min-height:60px}.style-option:active{border-color:var(--primary)}.style-option.selected{border-color:var(--primary);background:rgba(0,245,212,.1)}
    #worldCanvas{position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:500;display:none}#worldCanvas.active{display:block}
    .world-ui{position:fixed;top:0;left:0;right:0;padding:10px;display:none;justify-content:space-between;align-items:flex-start;z-index:600;pointer-events:none}.world-ui.active{display:flex}.world-ui>*{pointer-events:auto}.world-left{display:flex;flex-direction:column;gap:6px}.world-entropy-box{background:rgba(10,10,26,.9);border:1px solid var(--border);border-radius:10px;padding:8px 12px;backdrop-filter:blur(10px)}.world-entropy-label{font-family:'Orbitron',sans-serif;font-size:8px;color:var(--text-muted)}.world-entropy-value{font-family:'Orbitron',sans-serif;font-size:20px;font-weight:900;background:var(--gradient-energy);-webkit-background-clip:text;-webkit-text-fill-color:transparent}.world-nav-buttons{display:flex;gap:4px;flex-wrap:wrap}.world-nav-btn{background:rgba(10,10,26,.9);border:1px solid var(--border);border-radius:8px;padding:8px 12px;color:var(--text);font-size:11px;cursor:pointer;backdrop-filter:blur(10px);min-width:44px;min-height:44px;display:flex;align-items:center;justify-content:center}.world-nav-btn:active{border-color:var(--primary);color:var(--primary)}.world-nav-btn.next-stage{background:var(--gradient-energy);color:#1a1a2e;border:none;font-weight:700}.world-nav-btn.next-stage:disabled{opacity:.5;pointer-events:none}.world-info-panel{background:rgba(10,10,26,.9);border:1px solid var(--border);border-radius:10px;padding:10px 12px;backdrop-filter:blur(10px);min-width:140px;max-width:160px}.world-info-title{font-family:'Orbitron',sans-serif;font-size:9px;color:var(--secondary);margin-bottom:6px}
    
    /* ëª¨ë°”ì¼ í„°ì¹˜ ì»¨íŠ¸ë¡¤ */
    .touch-controls{position:fixed;bottom:0;left:0;right:0;height:200px;z-index:650;pointer-events:none;display:none}.touch-controls.active{display:flex;justify-content:space-between;align-items:flex-end;padding:20px}
    .joystick-container{width:120px;height:120px;position:relative;pointer-events:auto}.joystick-base{width:120px;height:120px;background:rgba(0,245,212,.15);border:2px solid rgba(0,245,212,.3);border-radius:50%;position:absolute}.joystick-stick{width:50px;height:50px;background:var(--gradient-energy);border-radius:50%;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);box-shadow:0 0 20px rgba(0,245,212,.5)}
    .action-buttons{display:flex;flex-direction:column;gap:10px;pointer-events:auto}.action-btn{width:60px;height:60px;border-radius:50%;border:2px solid;display:flex;align-items:center;justify-content:center;font-size:24px;background:rgba(10,10,26,.8);backdrop-filter:blur(10px)}.action-btn.dash{border-color:var(--accent);color:var(--accent)}.action-btn.dash:active{background:rgba(247,37,133,.3)}.action-btn.dash.disabled{opacity:.3;pointer-events:none}.action-btn.home{border-color:var(--primary);color:var(--primary)}.action-btn.home:active{background:rgba(0,245,212,.3)}
    
    /* ì°©ë¥™ ê²Œì„ ì¢Œìš° ë²„íŠ¼ */
    .landing-controls{position:fixed;bottom:30px;left:0;right:0;z-index:650;display:none;justify-content:space-between;padding:0 20px;pointer-events:none}.landing-controls.active{display:flex}.landing-btn{width:80px;height:80px;border-radius:50%;background:rgba(0,245,212,.2);border:3px solid var(--primary);display:flex;align-items:center;justify-content:center;font-size:32px;color:var(--primary);pointer-events:auto}.landing-btn:active{background:rgba(0,245,212,.4)}
    
    .encounter-dialog{position:fixed;bottom:220px;left:10px;right:10px;background:rgba(10,10,26,.95);border:2px solid var(--secondary);border-radius:16px;padding:14px;text-align:center;z-index:700;display:none}.encounter-dialog.active{display:block}.encounter-title{font-family:'Orbitron',sans-serif;font-size:14px;margin-bottom:4px}.encounter-desc{font-size:11px;color:var(--text-muted);margin-bottom:10px}.encounter-choices{display:grid;grid-template-columns:1fr 1fr;gap:6px}.encounter-choice{padding:10px 8px;background:var(--bg-input);border:1px solid var(--border);border-radius:8px;cursor:pointer;font-size:11px;min-height:50px}.encounter-choice:active{border-color:var(--primary);background:rgba(0,245,212,.1)}.choice-title{font-weight:700;margin-bottom:2px}.choice-effect{font-size:9px;color:var(--text-muted)}
    .story-overlay{position:fixed;inset:0;background:rgba(0,0,0,.9);display:none;align-items:center;justify-content:center;z-index:800}.story-overlay.active{display:flex}.story-content{max-width:350px;text-align:center;padding:20px}.story-icon{font-size:48px;margin-bottom:12px}.story-title{font-family:'Orbitron',sans-serif;font-size:22px;font-weight:900;margin-bottom:8px;background:var(--gradient-energy);-webkit-background-clip:text;-webkit-text-fill-color:transparent}.story-text{font-size:13px;line-height:1.5;color:var(--text-muted);margin-bottom:16px}.story-text strong{color:var(--primary)}
    .evo-alert{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(0);background:rgba(10,10,26,.95);border:2px solid var(--secondary);border-radius:16px;padding:20px 30px;text-align:center;z-index:700;opacity:0;transition:all .5s cubic-bezier(.34,1.56,.64,1)}.evo-alert.show{transform:translate(-50%,-50%) scale(1);opacity:1}.evo-alert.legendary{border-color:var(--legendary)}.evo-alert-icon{font-size:40px;margin-bottom:8px}.evo-alert-title{font-family:'Orbitron',sans-serif;font-size:16px;font-weight:900;background:var(--gradient-energy);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:4px}.evo-alert-desc{font-size:11px;color:var(--text-muted);margin-bottom:6px}.evo-alert-effect{padding:6px 12px;background:rgba(0,245,212,.1);border-radius:12px;font-size:10px;color:var(--primary)}
    .hidden{display:none!important}.text-center{text-align:center}.text-muted{color:var(--text-muted)}.mb-8{margin-bottom:8px}.mb-12{margin-bottom:12px}.mt-12{margin-top:12px}
    </style>
</head>
<body>
    <div id="stars"></div>
    <div class="loading-screen" id="loadingScreen"><div class="loading-spinner"></div></div>
    <div id="app"></div>
    <canvas id="worldCanvas"></canvas>
    <div class="world-ui" id="worldUI"><div class="world-left"><div class="world-entropy-box"><div class="world-entropy-label" id="worldStatLabel">ENTROPY</div><div class="world-entropy-value" id="worldStatValue">0</div></div><div class="world-nav-buttons" id="worldNavButtons"></div></div><div class="world-info-panel" id="worldInfoPanel"></div></div>
    
    <!-- ëª¨ë°”ì¼ í„°ì¹˜ ì»¨íŠ¸ë¡¤ -->
    <div class="touch-controls" id="touchControls">
        <div class="joystick-container" id="joystickContainer">
            <div class="joystick-base"></div>
            <div class="joystick-stick" id="joystickStick"></div>
        </div>
        <div class="action-buttons">
            <div class="action-btn dash" id="dashBtn">âš¡</div>
            <div class="action-btn home" id="homeBtn">ğŸ </div>
        </div>
    </div>
    
    <!-- ì°©ë¥™ ê²Œì„ ì»¨íŠ¸ë¡¤ -->
    <div class="landing-controls" id="landingControls">
        <div class="landing-btn" id="leftBtn">â—€</div>
        <div class="landing-btn" id="rightBtn">â–¶</div>
    </div>
    
    <div class="encounter-dialog" id="encounterDialog"><div class="encounter-title" id="encounterTitle">ì¡°ìš°</div><div class="encounter-desc" id="encounterDesc">ì„¤ëª…</div><div class="encounter-choices" id="encounterChoices"></div></div>
    <div class="story-overlay" id="storyOverlay"><div class="story-content"><div class="story-icon" id="storyIcon">ğŸŒŒ</div><div class="story-title" id="storyTitle">ì œëª©</div><div class="story-text" id="storyText">ë‚´ìš©</div><button class="btn btn-energy" onclick="window.closeStory()">ê³„ì†</button></div></div>
    <div class="modal-overlay" id="dailyRewardModal"><div class="modal"><h2 class="modal-title">ğŸ ì¼ì¼ ë³´ìƒ</h2><p class="modal-desc" id="dailyRewardDesc">ì—°ì† ì¶œì„!</p><div style="display:flex;justify-content:center;gap:4px;margin-bottom:14px;flex-wrap:wrap" id="dailyRewardDays"></div><div class="modal-actions"><button class="btn btn-energy" onclick="window.claimDailyReward()">ğŸ ë°›ê¸°</button></div></div></div>
    <div class="modal-overlay" id="editCellModal"><div class="modal"><h2 class="modal-title">ğŸ§¬ ì„¸í¬ ì»¤ìŠ¤í…€</h2><p class="modal-desc">íŒŒì¸  ë³€ê²½: <span style="color:var(--energy)">1000âš¡</span>/ê°œ</p><div style="display:flex;justify-content:center;margin-bottom:12px"><canvas id="cellPreview" width="120" height="120"></canvas></div><div style="margin-bottom:10px"><input type="text" class="input" id="cellNameInput" placeholder="ì´ë¦„" maxlength="20"></div><div class="parts-grid" id="partsGrid"></div><div id="styleSelector" style="display:none"><div class="style-options" id="styleOptions"></div></div><div class="modal-actions mt-12"><button class="btn btn-outline btn-sm" onclick="window.closeEditModal()">ì·¨ì†Œ</button><button class="btn btn-outline btn-sm" onclick="window.randomizeCellDesign()">ğŸ²</button><button class="btn btn-primary btn-sm" onclick="window.saveCellDesign()">ì €ì¥</button></div></div></div>
    <div class="modal-overlay" id="collectionModal"><div class="modal"><h2 class="modal-title">ğŸ“š ë„ê°</h2><div style="display:flex;gap:4px;margin-bottom:10px;justify-content:center"><button class="btn btn-sm btn-outline active" onclick="window.showCollection('creatures')" id="tabCreatures">ğŸ¦ </button><button class="btn btn-sm btn-outline" onclick="window.showCollection('artifacts')" id="tabArtifacts">ğŸº</button><button class="btn btn-sm btn-outline" onclick="window.showCollection('planets')" id="tabPlanets">ğŸª</button></div><div class="collection-grid" id="collectionGrid"></div><div style="text-align:center;margin-top:10px"><span id="collectionProgress" style="font-size:11px;color:var(--text-muted)">0/0</span></div><div class="modal-actions mt-12"><button class="btn btn-outline btn-sm" onclick="window.closeCollectionModal()">ë‹«ê¸°</button></div></div></div>
    <div class="modal-overlay" id="exploreModal"><div class="modal"><h2 class="modal-title" id="exploreTitle">ğŸ” íƒí—˜</h2><p class="modal-desc" id="exploreDesc">ë‚´ìš©</p><div class="modal-actions"><button class="btn btn-primary btn-sm" onclick="window.closeExploreModal()">í™•ì¸</button></div></div></div>
    <div class="modal-overlay" id="resultModal"><div class="modal"><div style="text-align:center;margin-bottom:14px"><span style="font-size:48px" id="resultIcon">ğŸª</span></div><h2 class="modal-title" id="resultTitle">ê²°ê³¼</h2><p class="modal-desc" id="resultDesc">ì„¤ëª…</p><div class="modal-actions" id="resultActions"></div></div></div>
    <div class="toast-container" id="toastContainer"></div>
    <div class="evo-alert" id="evoAlert"><div class="evo-alert-icon" id="evoAlertIcon">ğŸ‘ï¸</div><div class="evo-alert-title" id="evoAlertTitle">ì§„í™”!</div><div class="evo-alert-desc" id="evoAlertDesc">ì„¤ëª…</div><div class="evo-alert-effect" id="evoAlertEffect">íš¨ê³¼</div></div>
    <div class="user-dropdown" id="userDropdown"><div class="dropdown-item" onclick="window.openEditModal()">ğŸ§¬ ì»¤ìŠ¤í…€</div><div class="dropdown-item" onclick="window.openCollectionModal()">ğŸ“š ë„ê°</div><div class="dropdown-item danger" onclick="window.logout()">ğŸšª ë¡œê·¸ì•„ì›ƒ</div></div>
    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, query, getDocs, orderBy, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    
    const firebaseConfig = { apiKey: "AIzaSyBwQjuqgWM4YKnqu_gzNbeCg5alrC-jVcQ", authDomain: "myco-737a0.firebaseapp.com", projectId: "myco-737a0", storageBucket: "myco-737a0.firebasestorage.app", messagingSenderId: "942571332540", appId: "1:942571332540:web:be0bb6fbdd32655501c1b9" };
    const fbApp = initializeApp(firebaseConfig);
    const db = getFirestore(fbApp);
    const auth = getAuth(fbApp);
    const googleProvider = new GoogleAuthProvider();
    
    // ëª¨ë°”ì¼ í„°ì¹˜ ì»¨íŠ¸ë¡¤ ìƒíƒœ
    const touchState = { active: false, startX: 0, startY: 0, moveX: 0, moveY: 0, dx: 0, dy: 0 };
    const landingTouch = { left: false, right: false };
    
    const PART_STYLES = {
        eye: [{ id: 'normal', name: 'ê¸°ë³¸', icon: 'ğŸ‘ï¸' }, { id: 'big', name: 'í°ëˆˆ', icon: 'ğŸ‘€' }, { id: 'multiple', name: 'ë³µì•ˆ', icon: 'ğŸ•·ï¸' }, { id: 'glow', name: 'ë°œê´‘', icon: 'âœ¨' }],
        arm: [{ id: 'tentacle', name: 'ì´‰ìˆ˜', icon: 'ğŸ¦‘' }, { id: 'claw', name: 'ì§‘ê²Œ', icon: 'ğŸ¦€' }, { id: 'long', name: 'ê¸´íŒ”', icon: 'ğŸ¦' }, { id: 'multiple', name: 'ë‹¤ì¤‘', icon: 'ğŸ™' }],
        leg: [{ id: 'normal', name: 'ê¸°ë³¸', icon: 'ğŸ¦µ' }, { id: 'tentacle', name: 'ì´‰ìˆ˜', icon: 'ğŸ¦‘' }, { id: 'multiple', name: 'ë‹¤ì¤‘', icon: 'ğŸ•·ï¸' }, { id: 'fin', name: 'ì§€ëŠëŸ¬ë¯¸', icon: 'ğŸ ' }],
        brain: [{ id: 'normal', name: 'ê¸°ë³¸', icon: 'ğŸ§ ' }, { id: 'large', name: 'ëŒ€í˜•', icon: 'ğŸ”®' }, { id: 'antenna', name: 'ì•ˆí…Œë‚˜', icon: 'ğŸ“¡' }, { id: 'halo', name: 'í—¤ì¼ë¡œ', icon: 'ğŸ‘¼' }],
        wing: [{ id: 'normal', name: 'ê¸°ë³¸', icon: 'ğŸª½' }, { id: 'butterfly', name: 'ë‚˜ë¹„', icon: 'ğŸ¦‹' }, { id: 'bat', name: 'ë°•ì¥', icon: 'ğŸ¦‡' }, { id: 'energy', name: 'ì—ë„ˆì§€', icon: 'âš¡' }]
    };
    
    const TECH_TREE = [
        { id: 'fire', name: 'ë¶ˆ', icon: 'ğŸ”¥', cost: 500, requires: [], desc: 'ë¬¸ëª…', exploreBonus: 0 },
        { id: 'tools', name: 'ë„êµ¬', icon: 'ğŸ”§', cost: 800, requires: ['fire'], desc: 'ì œì‘', exploreBonus: 0 },
        { id: 'wheel', name: 'ë°”í€´', icon: 'âš™ï¸', cost: 1000, requires: ['tools'], desc: 'íƒí—˜+1', exploreBonus: 1 },
        { id: 'writing', name: 'ë¬¸ì', icon: 'ğŸ“œ', cost: 1200, requires: ['tools'], desc: 'ê¸°ë¡', exploreBonus: 0 },
        { id: 'compass', name: 'ë‚˜ì¹¨ë°˜', icon: 'ğŸ§­', cost: 1500, requires: ['wheel'], desc: 'íƒí—˜+1', exploreBonus: 1 },
        { id: 'telescope', name: 'ë§ì›ê²½', icon: 'ğŸ”­', cost: 2000, requires: ['writing'], desc: 'ìš°ì£¼ë§µ', exploreBonus: 0 },
        { id: 'rocket', name: 'ë¡œì¼“', icon: 'ğŸš€', cost: 3000, requires: ['compass'], desc: 'íƒí—˜+2', exploreBonus: 2 },
        { id: 'warp', name: 'ì›Œí”„', icon: 'ğŸŒ€', cost: 5000, requires: ['rocket', 'telescope'], desc: 'ì€í•˜', exploreBonus: 0 },
        { id: 'dyson', name: 'ë‹¤ì´ìŠ¨', icon: 'â˜€ï¸', cost: 10000, requires: ['warp'], desc: 'ë¬´í•œ', exploreBonus: 0 }
    ];
    
    const CREATURES = [
        { id: 'amoeba', name: 'ì•„ë©”ë°”', icon: 'ğŸ¦ ', rarity: 'common' },
        { id: 'jellyfish', name: 'í•´íŒŒë¦¬', icon: 'ğŸª¼', rarity: 'common' },
        { id: 'squid', name: 'ì˜¤ì§•ì–´', icon: 'ğŸ¦‘', rarity: 'rare' },
        { id: 'dragon', name: 'ìš°ì£¼ìš©', icon: 'ğŸ‰', rarity: 'epic' },
        { id: 'phoenix', name: 'ë¶ˆì‚¬ì¡°', icon: 'ğŸ”¥', rarity: 'legendary' },
        { id: 'crystal', name: 'í¬ë¦¬ìŠ¤íƒˆ', icon: 'ğŸ’', rarity: 'rare' },
        { id: 'shadow', name: 'ê·¸ë¦¼ì', icon: 'ğŸ‘¤', rarity: 'epic' },
        { id: 'ancient', name: 'ê³ ëŒ€ì', icon: 'ğŸ—¿', rarity: 'legendary' }
    ];
    const ARTIFACTS = [
        { id: 'stone', name: 'ëŒ', icon: 'ğŸª¨', rarity: 'common' },
        { id: 'cube', name: 'íë¸Œ', icon: 'ğŸ“¦', rarity: 'rare' },
        { id: 'orb', name: 'ì˜¤ë¸Œ', icon: 'ğŸ”®', rarity: 'rare' },
        { id: 'crown', name: 'ì™•ê´€', icon: 'ğŸ‘‘', rarity: 'epic' },
        { id: 'key', name: 'ì—´ì‡ ', icon: 'ğŸ—ï¸', rarity: 'legendary' }
    ];
    const PLANETS_COL = [
        { id: 'earth', name: 'ì§€êµ¬í˜•', icon: 'ğŸŒ', rarity: 'common' },
        { id: 'ice', name: 'ì–¼ìŒ', icon: 'ğŸ§Š', rarity: 'common' },
        { id: 'fire', name: 'í™”ì—¼', icon: 'ğŸ”¥', rarity: 'rare' },
        { id: 'crystal', name: 'ìˆ˜ì •', icon: 'ğŸ’', rarity: 'epic' },
        { id: 'void', name: 'ê³µí—ˆ', icon: 'ğŸ•³ï¸', rarity: 'legendary' }
    ];
    const EXPLORE_EVENTS = [
        { type: 'resource', title: 'ìì›!', desc: 'ê´‘ë¬¼', entropy: 100, icon: 'ğŸ’', rarity: 'common' },
        { type: 'resource', title: 'ì—ë„ˆì§€!', desc: 'ê²°ì •', entropy: 150, icon: 'âš¡', rarity: 'common' },
        { type: 'creature', title: 'ìƒëª…ì²´!', desc: 'ìƒˆ ìƒëª…ì²´!', entropy: 50, icon: 'ğŸ¦ ', rarity: 'common', collection: 'creatures' },
        { type: 'creature', title: 'í¬ê·€!', desc: 'í¬ê·€ ìƒëª…ì²´!', entropy: 200, icon: 'ğŸ¦‘', rarity: 'rare', collection: 'creatures' },
        { type: 'creature', title: 'ì „ì„¤!', desc: 'ì „ì„¤ ì¡´ì¬!', entropy: 500, icon: 'ğŸ‰', rarity: 'epic', collection: 'creatures' },
        { type: 'creature', title: 'â˜…ì‹ í™”â˜…', desc: 'ì‹ í™” ì¡´ì¬!', entropy: 1000, icon: 'ğŸ”¥', rarity: 'legendary', collection: 'creatures' },
        { type: 'danger', title: 'ìœ„í—˜!', desc: 'ë…ì„±!', entropy: -50, icon: 'â˜ ï¸', rarity: 'common' },
        { type: 'artifact', title: 'ìœ ë¬¼!', desc: 'ê³ ëŒ€!', entropy: 300, icon: 'ğŸº', rarity: 'rare', collection: 'artifacts' },
        { type: 'artifact', title: 'â˜…ì „ì„¤â˜…', desc: 'ì „ì„¤ ìœ ë¬¼!', entropy: 800, icon: 'ğŸ‘‘', rarity: 'legendary', collection: 'artifacts' },
        { type: 'empty', title: 'í™©ë¬´ì§€', desc: 'ì—†ìŒ', entropy: 10, icon: 'ğŸœï¸', rarity: 'common' },
        { type: 'portal', title: 'ì°¨ì›ë¬¸!', desc: 'ì—ë„ˆì§€!', entropy: 500, icon: 'ğŸŒ€', rarity: 'epic' }
    ];
    const DAILY_REWARDS = [50, 100, 150, 250, 400, 600, 1000];
    const PLANET_NAMES = ['Kepler-22b', 'Proxima-B', 'Trappist-1e', 'Gliese-581g', 'HD-40307g', 'Tau-Ceti-e'];
    const PLANET_TYPES = ['ìƒëª…ì²´', 'ì–¼ìŒ', 'ì‚¬ë§‰', 'í•´ì–‘', 'í™”ì‚°', 'ê³ ëŒ€ë¬¸ëª…'];
    
    const randomPartStyle = part => { const s = PART_STYLES[part]; return s[Math.floor(Math.random() * s.length)].id; };
    const generateCellDesign = () => { const h1 = Math.floor(Math.random() * 360), h2 = (h1 + 60 + Math.floor(Math.random() * 120)) % 360; const patterns = ['none', 'spots', 'stripes', 'glow']; const adj = ['ë¹›ë‚˜ëŠ”', 'ì–´ë‘ ì˜', 'ê³ ëŒ€ì˜', 'ì‹ ë¹„ë¡œìš´', 'ì˜ì›í•œ', 'ê¹¨ì–´ë‚œ', 'ë– ë„ëŠ”']; const noun = ['ì˜ì‹', 'ì„¸í¬', 'ì¡´ì¬', 'ì˜í˜¼', 'íŒŒë™', 'ìƒëª…ì²´', 'íƒí—˜ê°€']; return { name: adj[Math.floor(Math.random() * adj.length)] + ' ' + noun[Math.floor(Math.random() * noun.length)], primaryColor: `hsl(${h1}, 80%, 60%)`, secondaryColor: `hsl(${h2}, 70%, 40%)`, pattern: patterns[Math.floor(Math.random() * patterns.length)], wobblePoints: 8 + Math.floor(Math.random() * 6), wobbleIntensity: 0.5 + Math.random() * 0.5, glowIntensity: 0.3 + Math.random() * 0.5, parts: { eye: randomPartStyle('eye'), arm: randomPartStyle('arm'), leg: randomPartStyle('leg'), brain: randomPartStyle('brain'), wing: randomPartStyle('wing') } }; };
    const mergeCellDesigns = (my, other) => { const m = JSON.parse(JSON.stringify(my)); const parts = Object.keys(PART_STYLES); for (let i = 0; i < 1 + Math.floor(Math.random() * 2); i++) { const p = parts[Math.floor(Math.random() * parts.length)]; if (other.parts && other.parts[p]) m.parts[p] = other.parts[p]; } if (Math.random() > 0.5) m.secondaryColor = other.primaryColor || other.secondaryColor; if (Math.random() > 0.7) m.pattern = other.pattern; return m; };
    
    const State = {
        user: null, userData: null, currentPage: 'login',
        game: { entropy: 0, stage: 1, evolution: { eye: false, arm: false, leg: false, brain: false, wing: false }, currentPlanet: null, explored: [], history: [], cellDesign: null, driftProgress: 0, mergedCells: 0, tech: [], lastOnline: null, dailyStreak: 0, lastDailyReward: null, collection: { creatures: [], artifacts: [], planets: [] }, galaxyPosition: { x: 0, y: 0 } },
        async sync() { if (!this.user) return; try { await updateDoc(doc(db, 'users', this.user.uid), { game: this.game, updatedAt: serverTimestamp() }); } catch (e) { console.error(e); } },
        async load() { if (!this.user) return; try { const snap = await getDoc(doc(db, 'users', this.user.uid)); if (snap.exists()) { const d = snap.data(); this.userData = d; if (d.game) this.game = { ...this.game, ...d.game }; } } catch (e) { console.error(e); } }
    };
    
    const createStars = () => { const c = document.getElementById('stars'); c.innerHTML = ''; for (let i = 0; i < 80; i++) { const s = document.createElement('div'); s.className = 'star'; s.style.cssText = `left:${Math.random()*100}%;top:${Math.random()*100}%;width:${Math.random()*2+1}px;height:${s.style.width};animation-delay:${Math.random()*3}s`; c.appendChild(s); } };
    const showToast = (msg, type = 'info') => { const c = document.getElementById('toastContainer'); const icons = { success: 'âœ…', error: 'âŒ', info: 'â„¹ï¸', legendary: 'â­' }; const t = document.createElement('div'); t.className = `toast ${type}`; t.innerHTML = `<span>${icons[type] || 'â„¹ï¸'}</span><span style="flex:1;font-size:12px">${msg}</span>`; c.appendChild(t); setTimeout(() => t.remove(), 3000); };
    const showEvoAlert = (icon, title, desc, effect, isL = false) => { const a = document.getElementById('evoAlert'); document.getElementById('evoAlertIcon').textContent = icon; document.getElementById('evoAlertTitle').textContent = title; document.getElementById('evoAlertDesc').textContent = desc; document.getElementById('evoAlertEffect').textContent = effect; if (isL) a.classList.add('legendary'); else a.classList.remove('legendary'); a.classList.add('show'); setTimeout(() => a.classList.remove('show'), 2000); };
    const showStory = (icon, title, text, cb) => { document.getElementById('storyIcon').textContent = icon; document.getElementById('storyTitle').textContent = title; document.getElementById('storyText').innerHTML = text; document.getElementById('storyOverlay').classList.add('active'); window.storyCallback = cb; };
    const closeStory = () => { document.getElementById('storyOverlay').classList.remove('active'); if (window.storyCallback) window.storyCallback(); };
    const hideLoading = () => { document.getElementById('loadingScreen').classList.add('hidden'); };
    const navigate = page => { State.currentPage = page; render(); };
    const getExploreRange = () => { const tech = State.game.tech || []; let r = 1; TECH_TREE.forEach(t => { if (tech.includes(t.id) && t.exploreBonus) r += t.exploreBonus; }); return Math.min(r, 5); };
    const calculateOfflineEarnings = () => { const last = State.game.lastOnline; if (!last) return 0; const hours = Math.min((Date.now() - last) / 3600000, 8); const evoCount = Object.values(State.game.evolution).filter(v => v).length; return Math.floor(hours * (10 + evoCount * 5 + (State.game.tech?.length || 0) * 3)); };
    const canClaimDailyReward = () => { const last = State.game.lastDailyReward; if (!last) return true; return new Date().toDateString() !== new Date(last).toDateString(); };
    const getDailyStreak = () => { const last = State.game.lastDailyReward; if (!last) return 0; if (Math.floor((new Date() - new Date(last)) / 86400000) > 1) return 0; return State.game.dailyStreak || 0; };
    const rollExploreEvent = () => { const roll = Math.random(); let events; if (roll < 0.01) events = EXPLORE_EVENTS.filter(e => e.rarity === 'legendary'); else if (roll < 0.05) events = EXPLORE_EVENTS.filter(e => e.rarity === 'epic'); else if (roll < 0.20) events = EXPLORE_EVENTS.filter(e => e.rarity === 'rare'); else events = EXPLORE_EVENTS.filter(e => e.rarity === 'common'); return events[Math.floor(Math.random() * events.length)]; };
    const addToCollection = (type, itemId) => { if (!State.game.collection) State.game.collection = { creatures: [], artifacts: [], planets: [] }; if (!State.game.collection[type]) State.game.collection[type] = []; if (!State.game.collection[type].includes(itemId)) { State.game.collection[type].push(itemId); return true; } return false; };
    const render = () => { const p = State.currentPage; if (p === 'login') renderLogin(); else if (p === 'dashboard') renderDashboard(); else if (p === 'cell-world') startCellWorld(); else if (p === 'drift') startCosmicDrift(); else if (p === 'landing') startPlanetLanding(); else if (p === 'planet') renderPlanet(); else if (p === 'tech') renderTech(); else if (p === 'history') renderHistory(); else if (p === 'galaxy') renderGalaxyMap(); else renderPlaceholder(p); };
    
    const drawCell = (ctx, x, y, size, design, evolution, time = 0) => {
        const d = design || generateCellDesign(); const points = d.wobblePoints || 12; const parts = d.parts || {};
        ctx.save(); ctx.translate(x, y);
        if (d.pattern === 'glow' || d.glowIntensity > 0.5) { ctx.shadowColor = d.primaryColor; ctx.shadowBlur = 15 * (d.glowIntensity || 0.5); }
        ctx.beginPath();
        for (let i = 0; i < points; i++) { const angle = (i / points) * Math.PI * 2; const wobble = Math.sin(time * 0.1 + i * 0.5) * 4 * (d.wobbleIntensity || 1); const r = size + wobble; const px = Math.cos(angle) * r, py = Math.sin(angle) * r; i === 0 ? ctx.moveTo(px, py) : ctx.lineTo(px, py); }
        ctx.closePath();
        const g = ctx.createRadialGradient(-size * 0.3, -size * 0.3, 0, 0, 0, size * 1.2); g.addColorStop(0, d.primaryColor); g.addColorStop(0.6, d.secondaryColor); g.addColorStop(1, d.secondaryColor); ctx.fillStyle = g; ctx.fill(); ctx.shadowBlur = 0;
        if (d.pattern === 'spots') { ctx.fillStyle = 'rgba(255,255,255,0.3)'; for (let i = 0; i < 5; i++) { const angle = (i / 5) * Math.PI * 2 + time * 0.02; ctx.beginPath(); ctx.arc(Math.cos(angle) * size * 0.5, Math.sin(angle) * size * 0.5, size * 0.1, 0, Math.PI * 2); ctx.fill(); } }
        ctx.beginPath(); ctx.arc(-size * 0.25, -size * 0.25, size * 0.18, 0, Math.PI * 2); ctx.fillStyle = 'rgba(255,255,255,0.25)'; ctx.fill();
        if (evolution) {
            if (evolution.eye) { const st = parts.eye || 'normal'; if (st === 'normal' || st === 'big') { const sz = st === 'big' ? 0.32 : 0.2; ctx.beginPath(); ctx.arc(size * 0.35, -size * 0.1, size * sz, 0, Math.PI * 2); ctx.fillStyle = '#fff'; ctx.fill(); ctx.beginPath(); ctx.arc(size * 0.38, -size * 0.08, size * sz * 0.5, 0, Math.PI * 2); ctx.fillStyle = '#1a1a2e'; ctx.fill(); } else if (st === 'multiple') { for (let i = 0; i < 3; i++) { ctx.beginPath(); ctx.arc(size * 0.4, -size * 0.28 + i * size * 0.22, size * 0.1, 0, Math.PI * 2); ctx.fillStyle = '#fff'; ctx.fill(); } } else if (st === 'glow') { ctx.shadowColor = '#0ff'; ctx.shadowBlur = 12; ctx.beginPath(); ctx.arc(size * 0.35, -size * 0.1, size * 0.18, 0, Math.PI * 2); ctx.fillStyle = '#0ff'; ctx.fill(); ctx.shadowBlur = 0; } }
            if (evolution.arm) { const st = parts.arm || 'tentacle'; ctx.strokeStyle = d.secondaryColor; ctx.lineWidth = size * 0.1; ctx.lineCap = 'round'; if (st === 'tentacle') { ctx.beginPath(); ctx.moveTo(size * 0.7, size * 0.1); ctx.quadraticCurveTo(size * 1.1, size * 0.3 + Math.sin(time * 0.15) * 6, size * 1.3, size * 0.2); ctx.stroke(); } else if (st === 'claw') { ctx.beginPath(); ctx.moveTo(size * 0.7, size * 0.1); ctx.lineTo(size * 1.1, size * 0.1); ctx.stroke(); ctx.fillStyle = d.secondaryColor; ctx.beginPath(); ctx.moveTo(size * 1.1, size * 0.1); ctx.lineTo(size * 1.25, -size * 0.08); ctx.lineTo(size * 1.25, size * 0.28); ctx.fill(); } else if (st === 'multiple') { for (let i = 0; i < 3; i++) { ctx.beginPath(); ctx.moveTo(size * 0.65, size * 0.1); ctx.quadraticCurveTo(size * 1, size * (-0.15 + i * 0.25) + Math.sin(time * 0.15 + i) * 4, size * 1.2, size * (-0.15 + i * 0.25)); ctx.stroke(); } } }
            if (evolution.leg) { const st = parts.leg || 'normal'; const lw = Math.sin(time * 0.2) * 8; ctx.strokeStyle = d.secondaryColor; ctx.lineWidth = size * 0.1; if (st === 'normal' || st === 'tentacle') { ctx.beginPath(); ctx.moveTo(size * 0.15, size * 0.65); ctx.lineTo(size * 0.12 + lw, size * 1.2); ctx.stroke(); ctx.beginPath(); ctx.moveTo(-size * 0.15, size * 0.65); ctx.lineTo(-size * 0.12 - lw, size * 1.2); ctx.stroke(); } else if (st === 'multiple') { for (let i = 0; i < 4; i++) { ctx.beginPath(); ctx.moveTo(-size * 0.25 + i * size * 0.17, size * 0.65); ctx.lineTo(-size * 0.25 + i * size * 0.17 + Math.sin(time * 0.2 + i) * 4, size * 1.1); ctx.stroke(); } } else if (st === 'fin') { ctx.fillStyle = d.secondaryColor + '88'; ctx.beginPath(); ctx.moveTo(0, size * 0.55); ctx.quadraticCurveTo(size * 0.4, size * 1.1 + lw * 0.4, 0, size * 1.4); ctx.quadraticCurveTo(-size * 0.4, size * 1.1 - lw * 0.4, 0, size * 0.55); ctx.fill(); } }
            if (evolution.brain) { const st = parts.brain || 'normal'; if (st === 'normal' || st === 'large') { const sz = st === 'large' ? 0.28 : 0.18; ctx.beginPath(); ctx.arc(0, -size * 0.5, size * sz, 0, Math.PI * 2); ctx.fillStyle = `rgba(254,228,64,${Math.sin(time * 0.1) * 0.25 + 0.7})`; ctx.fill(); } else if (st === 'antenna') { ctx.strokeStyle = '#fee440'; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(-size * 0.12, -size * 0.38); ctx.lineTo(-size * 0.2, -size * 0.7); ctx.stroke(); ctx.beginPath(); ctx.moveTo(size * 0.12, -size * 0.38); ctx.lineTo(size * 0.2, -size * 0.7); ctx.stroke(); ctx.fillStyle = '#fee440'; ctx.beginPath(); ctx.arc(-size * 0.2, -size * 0.7, 4, 0, Math.PI * 2); ctx.fill(); ctx.beginPath(); ctx.arc(size * 0.2, -size * 0.7, 4, 0, Math.PI * 2); ctx.fill(); } else if (st === 'halo') { ctx.strokeStyle = `rgba(254,228,64,${Math.sin(time * 0.15) * 0.25 + 0.7})`; ctx.lineWidth = 2; ctx.beginPath(); ctx.ellipse(0, -size * 0.55, size * 0.35, size * 0.12, 0, 0, Math.PI * 2); ctx.stroke(); } }
            if (evolution.wing) { const st = parts.wing || 'normal'; const wf = Math.sin(time * 0.3) * 0.25; ctx.fillStyle = `${d.primaryColor}77`; if (st === 'normal' || st === 'butterfly') { ctx.save(); ctx.rotate(wf - 0.35); ctx.beginPath(); ctx.moveTo(size * 0.35, -size * 0.18); ctx.quadraticCurveTo(size * 1.1, -size * 0.6, size * 1.5, -size * 0.12); ctx.quadraticCurveTo(size * 1.1, size * 0.08, size * 0.35, -size * 0.04); ctx.fill(); ctx.restore(); ctx.save(); ctx.scale(-1, 1); ctx.rotate(wf - 0.35); ctx.beginPath(); ctx.moveTo(size * 0.35, -size * 0.18); ctx.quadraticCurveTo(size * 1.1, -size * 0.6, size * 1.5, -size * 0.12); ctx.quadraticCurveTo(size * 1.1, size * 0.08, size * 0.35, -size * 0.04); ctx.fill(); ctx.restore(); } else if (st === 'bat') { ctx.fillStyle = `${d.secondaryColor}bb`; ctx.save(); ctx.rotate(wf - 0.25); ctx.beginPath(); ctx.moveTo(size * 0.28, -size * 0.08); ctx.lineTo(size * 0.7, -size * 0.5); ctx.lineTo(size * 1, -size * 0.25); ctx.lineTo(size * 1.25, -size * 0.4); ctx.lineTo(size * 1.1, 0); ctx.lineTo(size * 0.28, size * 0.08); ctx.fill(); ctx.restore(); ctx.save(); ctx.scale(-1, 1); ctx.rotate(wf - 0.25); ctx.beginPath(); ctx.moveTo(size * 0.28, -size * 0.08); ctx.lineTo(size * 0.7, -size * 0.5); ctx.lineTo(size * 1, -size * 0.25); ctx.lineTo(size * 1.25, -size * 0.4); ctx.lineTo(size * 1.1, 0); ctx.lineTo(size * 0.28, size * 0.08); ctx.fill(); ctx.restore(); } else if (st === 'energy') { ctx.strokeStyle = `rgba(0,245,212,${Math.sin(time * 0.2) * 0.25 + 0.7})`; ctx.lineWidth = 2; ctx.shadowColor = '#00f5d4'; ctx.shadowBlur = 8; for (let i = 0; i < 3; i++) { ctx.save(); ctx.rotate(wf - 0.35 - i * 0.12); ctx.beginPath(); ctx.moveTo(size * 0.35, -size * 0.08); ctx.lineTo(size * (1 + i * 0.15), -size * (0.25 + i * 0.08)); ctx.stroke(); ctx.restore(); ctx.save(); ctx.scale(-1, 1); ctx.rotate(wf - 0.35 - i * 0.12); ctx.beginPath(); ctx.moveTo(size * 0.35, -size * 0.08); ctx.lineTo(size * (1 + i * 0.15), -size * (0.25 + i * 0.08)); ctx.stroke(); ctx.restore(); } ctx.shadowBlur = 0; } }
        }
        ctx.restore();
    };
    
    // ëª¨ë°”ì¼ ì¡°ì´ìŠ¤í‹± ì´ˆê¸°í™”
    const initJoystick = () => {
        const container = document.getElementById('joystickContainer');
        const stick = document.getElementById('joystickStick');
        const maxDist = 35;
        
        const handleStart = (e) => {
            e.preventDefault();
            const touch = e.touches ? e.touches[0] : e;
            const rect = container.getBoundingClientRect();
            touchState.active = true;
            touchState.startX = rect.left + rect.width / 2;
            touchState.startY = rect.top + rect.height / 2;
        };
        
        const handleMove = (e) => {
            if (!touchState.active) return;
            e.preventDefault();
            const touch = e.touches ? e.touches[0] : e;
            let dx = touch.clientX - touchState.startX;
            let dy = touch.clientY - touchState.startY;
            const dist = Math.sqrt(dx * dx + dy * dy);
            if (dist > maxDist) { dx = dx / dist * maxDist; dy = dy / dist * maxDist; }
            stick.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
            touchState.dx = dx / maxDist;
            touchState.dy = dy / maxDist;
        };
        
        const handleEnd = () => {
            touchState.active = false;
            touchState.dx = 0;
            touchState.dy = 0;
            stick.style.transform = 'translate(-50%, -50%)';
        };
        
        container.addEventListener('touchstart', handleStart, { passive: false });
        container.addEventListener('touchmove', handleMove, { passive: false });
        container.addEventListener('touchend', handleEnd);
        container.addEventListener('touchcancel', handleEnd);
    };
    
    // ì°©ë¥™ ê²Œì„ í„°ì¹˜ ì»¨íŠ¸ë¡¤
    const initLandingControls = () => {
        const leftBtn = document.getElementById('leftBtn');
        const rightBtn = document.getElementById('rightBtn');
        
        leftBtn.addEventListener('touchstart', (e) => { e.preventDefault(); landingTouch.left = true; }, { passive: false });
        leftBtn.addEventListener('touchend', () => { landingTouch.left = false; });
        leftBtn.addEventListener('touchcancel', () => { landingTouch.left = false; });
        
        rightBtn.addEventListener('touchstart', (e) => { e.preventDefault(); landingTouch.right = true; }, { passive: false });
        rightBtn.addEventListener('touchend', () => { landingTouch.right = false; });
        rightBtn.addEventListener('touchcancel', () => { landingTouch.right = false; });
    };
    
    const navbar = () => { const s = State.game.stage; const hasTel = (State.game.tech || []).includes('telescope'); return `<nav class="navbar"><div class="nav-logo" onclick="window.nav('dashboard')">BOKLUCK</div><div class="nav-links"><div class="nav-link ${State.currentPage==='dashboard'?'active':''}" onclick="window.nav('dashboard')">ğŸ </div><div class="nav-link ${s<3?'locked':''}" onclick="${s>=3?"window.nav('planet')":""}">ğŸª</div><div class="nav-link ${s<3?'locked':''}" onclick="${s>=3?"window.nav('tech')":""}">ğŸ”¬</div><div class="nav-link ${!hasTel?'locked':''}" onclick="${hasTel?"window.nav('galaxy')":""}">ğŸŒŒ</div><div class="nav-link" onclick="window.nav('history')">ğŸ“œ</div></div><div class="nav-right"><div class="entropy-badge"><span>âš¡</span><span class="entropy-value">${State.game.entropy.toLocaleString()}</span></div><img class="user-avatar" src="${State.user?.photoURL||'https://via.placeholder.com/32'}" onclick="toggleUserMenu()"></div></nav>`; };
    const toggleUserMenu = () => { document.getElementById('userDropdown').classList.toggle('show'); };
    document.addEventListener('click', e => { if (!e.target.closest('.user-avatar') && !e.target.closest('.user-dropdown')) document.getElementById('userDropdown').classList.remove('show'); });
    
    const renderLogin = () => { document.getElementById('app').innerHTML = `<div class="login-page"><h1 class="login-logo">BOKLUCK</h1><p class="login-subtitle">Universe</p><div style="width:100px;height:100px;margin-bottom:20px"><canvas id="loginCellCanvas" width="100" height="100"></canvas></div><p class="login-story">ê´‘í™œí•œ ìš°ì£¼ ì–´ë”˜ê°€ì—ì„œ<br><strong>ì„¸í¬</strong>ë¡œ íƒœì–´ë‚¬ë‹¤.<br><br><strong>ì—”íŠ¸ë¡œí”¼</strong>ë¥¼ ëª¨ì•„ ìƒì¡´í•˜ë¼.</p><button class="btn btn-energy" onclick="window.googleLogin()">Googleë¡œ ì‹œì‘</button></div>`; const canvas = document.getElementById('loginCellCanvas'); if (canvas) { const ctx = canvas.getContext('2d'); let t = 0; const rd = generateCellDesign(); const animate = () => { if (!document.getElementById('loginCellCanvas')) return; t++; ctx.clearRect(0, 0, 100, 100); drawCell(ctx, 50, 50, 25, rd, { eye: true, arm: true, leg: true, brain: true, wing: true }, t); requestAnimationFrame(animate); }; animate(); } };
    
    const renderDashboard = () => {
        const { stage, evolution, history, cellDesign } = State.game;
        const evoCount = Object.values(evolution).filter(v => v).length;
        const design = cellDesign || generateCellDesign();
        const stageLabels = { 1: 'ì„¸í¬', 2: 'ë‚™í•˜', 3: 'ì •ì°©' };
        const canClaim = canClaimDailyReward();
        const streak = getDailyStreak();
        const collectionCount = (State.game.collection?.creatures?.length || 0) + (State.game.collection?.artifacts?.length || 0) + (State.game.collection?.planets?.length || 0);
        let nextAction = '';
        if (stage === 1 && State.game.entropy < 800) nextAction = `<button class="btn btn-primary btn-block mt-12" onclick="window.nav('cell-world')">ğŸŒŒ ì„¸í¬ ì„¸ê³„</button>`;
        else if (stage === 1 && State.game.entropy >= 800) nextAction = `<button class="btn btn-energy btn-block mt-12" onclick="window.nav('drift')">ğŸŒ  ìš°ì£¼ í‘œë¥˜</button>`;
        else if (stage === 1.5) nextAction = `<button class="btn btn-energy btn-block mt-12" onclick="window.nav('drift')">ğŸŒ  í‘œë¥˜ ê³„ì†</button>`;
        else if (stage === 2) nextAction = `<button class="btn btn-energy btn-block mt-12" onclick="window.nav('landing')">ğŸš€ í–‰ì„± ì°©ë¥™</button>`;
        else if (stage >= 3) nextAction = `<button class="btn btn-primary btn-block mt-12" onclick="window.nav('planet')">ğŸª í–‰ì„± íƒí—˜</button>`;
        
        document.getElementById('app').innerHTML = `${navbar()}<main class="main-content"><div class="page-container">
            ${canClaim ? `<div class="daily-reward-banner" onclick="window.openDailyReward()"><div class="daily-icon">ğŸ</div><div class="daily-info"><div class="daily-title">ì¼ì¼ ë³´ìƒ!</div><div class="daily-desc">${streak + 1}ì¼ì°¨: ${DAILY_REWARDS[Math.min(streak, 6)]}âš¡</div><div class="daily-streak">${[1,2,3,4,5,6,7].map(d => `<div class="streak-dot ${d <= streak ? 'active' : ''} ${d === streak + 1 ? 'current' : ''}">${d}</div>`).join('')}</div></div></div>` : ''}
            <div class="card entity-card mb-12"><div class="entity-visual" onclick="window.openEditModal()"><canvas id="entityCanvas" width="140" height="140"></canvas></div><div style="font-family:'Orbitron',sans-serif;font-size:9px;color:var(--accent);text-align:center;margin-bottom:4px">STAGE ${Math.floor(stage)} Â· ${stageLabels[Math.floor(stage)] || ''}</div><div class="entity-name">${design.name || 'Entity'}</div><div class="entity-stats"><div class="stat-box"><div class="stat-value">${evoCount}/5</div><div class="stat-label">ì§„í™”</div></div><div class="stat-box"><div class="stat-value">${State.game.mergedCells||0}</div><div class="stat-label">í•©ì²´</div></div><div class="stat-box"><div class="stat-value">${(State.game.explored||[]).length}</div><div class="stat-label">íƒí—˜</div></div><div class="stat-box"><div class="stat-value">${collectionCount}</div><div class="stat-label">ìˆ˜ì§‘</div></div></div>${nextAction}</div>
            <div class="quick-actions"><div class="quick-action" onclick="window.nav('cell-world')"><div class="quick-action-icon">ğŸ¦ </div><div class="quick-action-label">ì„¸í¬</div></div><div class="quick-action ${stage<1.5&&State.game.entropy<800?'locked':''}" onclick="${stage>=1.5||State.game.entropy>=800?"window.nav('drift')":""}"><div class="quick-action-icon">ğŸŒ </div><div class="quick-action-label">í‘œë¥˜</div></div><div class="quick-action ${stage<3?'locked':''}" onclick="${stage>=3?"window.nav('planet')":""}"><div class="quick-action-icon">ğŸª</div><div class="quick-action-label">í–‰ì„±</div></div><div class="quick-action highlight" onclick="window.openCollectionModal()"><div class="quick-action-icon">ğŸ“š</div><div class="quick-action-label">ë„ê°</div></div></div>
            <div class="card"><div class="card-header"><span class="card-title">ğŸ“œ ì—­ì‚¬</span><button class="btn btn-outline btn-sm" onclick="window.nav('history')">ì „ì²´</button></div>${(history||[]).length===0?`<div class="text-center text-muted" style="padding:20px;font-size:11px">ğŸ“œ ê¸°ë¡ ì—†ìŒ</div>`:(history||[]).slice(-2).reverse().map(e=>`<div class="history-entry"><div class="history-chapter">ì œ${e.chapter}ì¥</div><div class="history-title">${e.title}</div><div class="history-content">${e.content}</div></div>`).join('')}</div>
        </div></main>`;
        animateEntityCanvas();
    };
    const animateEntityCanvas = () => { const canvas = document.getElementById('entityCanvas'); if (!canvas) return; const ctx = canvas.getContext('2d'); let t = 0; const draw = () => { if (!document.getElementById('entityCanvas')) return; t++; ctx.clearRect(0, 0, 140, 140); drawCell(ctx, 70, 70, 35, State.game.cellDesign, State.game.evolution, t); requestAnimationFrame(draw); }; draw(); };
    
    const openDailyReward = () => { const streak = getDailyStreak(); document.getElementById('dailyRewardDesc').textContent = `${streak + 1}ì¼ì°¨!`; document.getElementById('dailyRewardDays').innerHTML = DAILY_REWARDS.map((r, i) => `<div style="text-align:center;padding:6px;background:${i < streak ? 'var(--gradient-energy)' : i === streak ? 'var(--gradient-evolution)' : 'var(--bg-input)'};border-radius:6px;min-width:32px"><div style="font-size:12px">${i < streak ? 'âœ“' : i === streak ? 'ğŸ' : 'ğŸ”’'}</div><div style="font-size:8px;margin-top:2px">${r}</div></div>`).join(''); document.getElementById('dailyRewardModal').classList.add('active'); };
    const claimDailyReward = async () => { if (!canClaimDailyReward()) return; const streak = getDailyStreak(); const now = new Date(); const last = State.game.lastDailyReward ? new Date(State.game.lastDailyReward) : null; let newStreak = 1; if (last && Math.floor((now - last) / 86400000) === 1) newStreak = streak + 1; if (newStreak > 7) newStreak = 1; const reward = DAILY_REWARDS[Math.min(newStreak - 1, 6)]; State.game.entropy += reward; State.game.dailyStreak = newStreak; State.game.lastDailyReward = now.toISOString(); await State.sync(); document.getElementById('dailyRewardModal').classList.remove('active'); showEvoAlert('ğŸ', `${newStreak}ì¼ì°¨!`, 'ì¶œì„', `+${reward}âš¡`, newStreak >= 7); render(); };
    
    const openCollectionModal = () => { showCollection('creatures'); document.getElementById('collectionModal').classList.add('active'); };
    const closeCollectionModal = () => { document.getElementById('collectionModal').classList.remove('active'); };
    const showCollection = type => { document.querySelectorAll('#collectionModal .btn').forEach(b => b.classList.remove('active')); document.getElementById(`tab${type.charAt(0).toUpperCase() + type.slice(1)}`).classList.add('active'); const data = type === 'creatures' ? CREATURES : type === 'artifacts' ? ARTIFACTS : PLANETS_COL; const collected = State.game.collection?.[type] || []; document.getElementById('collectionGrid').innerHTML = data.map(item => { const discovered = collected.includes(item.id); return `<div class="collection-item ${discovered ? 'discovered' : 'undiscovered'} ${item.rarity}"><div class="collection-icon">${discovered ? item.icon : 'â“'}</div><div class="collection-name">${discovered ? item.name : '???'}</div><div class="collection-rarity">${item.rarity.toUpperCase()}</div></div>`; }).join(''); document.getElementById('collectionProgress').textContent = `${collected.length}/${data.length}`; };
    
    const renderPlanet = () => {
        const planet = State.game.currentPlanet || { name: 'ë¯¸ì§€', type: '???' };
        const explored = State.game.explored || [];
        const range = getExploreRange();
        document.getElementById('app').innerHTML = `${navbar()}<main class="main-content"><div class="page-container">
            <div class="card mb-12" style="display:flex;align-items:center;gap:12px;padding:12px"><span style="font-size:32px">ğŸª</span><div style="flex:1"><h1 class="font-display" style="font-size:16px">${planet.name}</h1><p class="text-muted" style="font-size:10px">${planet.type} | íƒí—˜: ${range}ì¹¸</p></div></div>
            <div class="card mb-12"><div class="card-header"><span class="card-title">ğŸ—ºï¸ ì§€ë„</span><span class="text-muted" style="font-size:9px">${explored.length}/100</span></div><div class="planet-map" id="planetMap"></div></div>
            <div class="card"><div class="card-header"><span class="card-title">ğŸ“œ ìµœê·¼</span></div>${explored.length === 0 ? `<p class="text-muted text-center" style="font-size:10px">ê¸°ë¡ ì—†ìŒ</p>` : explored.slice(-3).reverse().map(e => `<div style="display:flex;align-items:center;gap:6px;padding:6px;background:var(--bg-input);border-radius:6px;margin-bottom:4px;border-left:2px solid var(--${e.rarity === 'legendary' ? 'legendary' : e.rarity === 'epic' ? 'epic' : 'border'})"><span style="font-size:14px">${e.icon}</span><div style="flex:1;font-size:10px">${e.title}</div><span style="color:${e.entropy >= 0 ? 'var(--success)' : 'var(--danger)'};font-size:10px">${e.entropy >= 0 ? '+' : ''}${e.entropy}</span></div>`).join('')}</div>
        </div></main>`;
        renderPlanetMap();
    };
    const renderPlanetMap = () => { const map = document.getElementById('planetMap'); if (!map) return; const explored = State.game.explored || []; const exploredSet = new Set(explored.map(e => `${e.x},${e.y}`)); const range = getExploreRange(); let inRange = new Set(); explored.forEach(e => { for (let dx = -range; dx <= range; dx++) for (let dy = -range; dy <= range; dy++) { const nx = e.x + dx, ny = e.y + dy; if (nx >= 0 && nx < 10 && ny >= 0 && ny < 10) inRange.add(`${nx},${ny}`); } }); for (let dx = -range; dx <= range; dx++) for (let dy = -range; dy <= range; dy++) { const nx = 5 + dx, ny = 5 + dy; if (nx >= 0 && nx < 10 && ny >= 0 && ny < 10) inRange.add(`${nx},${ny}`); } let html = ''; for (let y = 0; y < 10; y++) for (let x = 0; x < 10; x++) { const key = `${x},${y}`; const isEx = exploredSet.has(key); const isHome = x === 5 && y === 5; const isIn = inRange.has(key); let cls = 'map-cell', content = ''; if (isHome) { cls += ' home'; content = 'ğŸ '; } else if (isEx) { cls += ' explored'; content = 'âœ“'; } else if (isIn) cls += ' in-range'; const canEx = isIn && !isEx && !isHome; html += `<div class="${cls}" onclick="${canEx ? `window.exploreCell(${x},${y})` : ''}" style="${!canEx && !isEx && !isHome ? 'opacity:0.3' : ''}">${content}</div>`; } map.innerHTML = html; };
    const exploreCell = async (x, y) => { const cost = 50; if (State.game.entropy < cost) { showToast(`${cost}âš¡ í•„ìš”`, 'error'); return; } State.game.entropy -= cost; const event = rollExploreEvent(); State.game.entropy += event.entropy; const record = { x, y, ...event, timestamp: new Date().toISOString() }; State.game.explored.push(record); let isNew = false; if (event.collection) { const items = event.collection === 'creatures' ? CREATURES : ARTIFACTS; const rItems = items.filter(i => i.rarity === event.rarity); if (rItems.length > 0) isNew = addToCollection(event.collection, rItems[Math.floor(Math.random() * rItems.length)].id); } await State.sync(); const rColors = { legendary: 'var(--legendary)', epic: 'var(--epic)', rare: 'var(--rare)', common: 'var(--text)' }; document.getElementById('exploreTitle').innerHTML = `${event.icon} <span style="color:${rColors[event.rarity]}">${event.title}</span>`; document.getElementById('exploreDesc').innerHTML = `<p style="margin-bottom:8px">${event.desc}</p><p style="color:${event.entropy >= 0 ? 'var(--success)' : 'var(--danger)'}; font-size:16px; font-weight:bold">${event.entropy >= 0 ? '+' : ''}${event.entropy}âš¡</p>${isNew ? `<p style="color:var(--legendary);margin-top:8px">ğŸ†• ìƒˆ ìˆ˜ì§‘í’ˆ!</p>` : ''}`; document.getElementById('exploreModal').classList.add('active'); if (event.rarity === 'legendary') showToast(`â­ ì „ì„¤!`, 'legendary'); render(); };
    const closeExploreModal = () => { document.getElementById('exploreModal').classList.remove('active'); };
    
    const renderGalaxyMap = async () => { let allUsers = []; try { const q = query(collection(db, 'users'), orderBy('game.entropy', 'desc'), limit(30)); const snap = await getDocs(q); snap.forEach(doc => { const d = doc.data(); if (d.game) allUsers.push({ id: doc.id, name: d.game.cellDesign?.name || d.displayName, entropy: d.game.entropy || 0, position: d.game.galaxyPosition || { x: Math.random() * 100, y: Math.random() * 100 }, isMe: doc.id === State.user?.uid }); }); } catch (e) { console.error(e); } document.getElementById('app').innerHTML = `${navbar()}<main class="main-content"><div class="page-container"><h1 class="font-display text-center mb-8" style="font-size:18px">ğŸŒŒ ìš°ì£¼</h1><div class="galaxy-map-container"><canvas class="galaxy-canvas" id="galaxyCanvas"></canvas><div class="galaxy-legend"><div class="legend-item"><div class="legend-dot" style="background:var(--energy)"></div>ë‚˜</div><div class="legend-item"><div class="legend-dot" style="background:var(--primary)"></div>ìœ ì €</div></div><div class="galaxy-info"><div style="font-weight:bold;margin-bottom:4px;font-size:9px">ğŸ† ë­í‚¹</div>${allUsers.slice(0, 5).map((u, i) => `<div style="display:flex;justify-content:space-between;margin-bottom:2px;font-size:9px;${u.isMe ? 'color:var(--energy)' : ''}"><span>${i+1}. ${u.name?.slice(0, 5) || '???'}</span><span>${u.entropy.toLocaleString()}</span></div>`).join('')}</div></div></div></main>`; const canvas = document.getElementById('galaxyCanvas'); if (canvas) { canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight; const ctx = canvas.getContext('2d'); ctx.fillStyle = '#050510'; ctx.fillRect(0, 0, canvas.width, canvas.height); for (let i = 0; i < 100; i++) { ctx.fillStyle = `rgba(255,255,255,${Math.random() * 0.5 + 0.2})`; ctx.beginPath(); ctx.arc(Math.random() * canvas.width, Math.random() * canvas.height, Math.random() * 1.2, 0, Math.PI * 2); ctx.fill(); } allUsers.forEach(user => { const ux = (user.position.x / 100) * canvas.width, uy = (user.position.y / 100) * canvas.height; const sz = user.isMe ? 8 : 4 + Math.min(user.entropy / 1000, 4); ctx.beginPath(); ctx.arc(ux, uy, sz, 0, Math.PI * 2); ctx.fillStyle = user.isMe ? '#fee440' : '#00f5d4'; ctx.fill(); if (user.isMe) { ctx.strokeStyle = '#fee440'; ctx.lineWidth = 2; ctx.beginPath(); ctx.arc(ux, uy, sz + 3, 0, Math.PI * 2); ctx.stroke(); } ctx.fillStyle = user.isMe ? '#fee440' : 'rgba(255,255,255,0.6)'; ctx.font = user.isMe ? 'bold 9px Orbitron' : '8px sans-serif'; ctx.textAlign = 'center'; ctx.fillText(user.name?.slice(0, 6) || '???', ux, uy + sz + 10); }); } };
    
    const renderTech = () => { const unlocked = State.game.tech || []; document.getElementById('app').innerHTML = `${navbar()}<main class="main-content"><div class="page-container"><h1 class="font-display text-center mb-12" style="font-size:18px">ğŸ”¬ ê¸°ìˆ </h1><div class="tech-grid">${TECH_TREE.map(tech => { const isU = unlocked.includes(tech.id); const canU = !isU && tech.requires.every(r => unlocked.includes(r)) && State.game.entropy >= tech.cost; return `<div class="tech-item ${isU ? 'unlocked' : canU ? 'available' : 'locked'}" onclick="${canU ? `window.unlockTech('${tech.id}')` : ''}"><div class="tech-icon">${tech.icon}</div><div class="tech-name">${tech.name}</div><div class="tech-desc">${tech.desc}</div>${isU ? '<div style="color:var(--success);font-size:10px">âœ“</div>' : `<div class="tech-cost">âš¡${tech.cost}</div>`}</div>`; }).join('')}</div></div></main>`; };
    const unlockTech = async techId => { const tech = TECH_TREE.find(t => t.id === techId); if (!tech || State.game.entropy < tech.cost) { showToast('ë¶€ì¡±', 'error'); return; } State.game.entropy -= tech.cost; State.game.tech = State.game.tech || []; State.game.tech.push(techId); State.game.history.push({ chapter: State.game.history.length + 1, title: tech.name, content: tech.desc, timestamp: new Date().toISOString() }); await State.sync(); showEvoAlert(tech.icon, tech.name, tech.desc, tech.exploreBonus ? `íƒí—˜+${tech.exploreBonus}` : 'í•´ê¸ˆ'); render(); };
    
    const renderHistory = () => { const h = State.game.history || []; document.getElementById('app').innerHTML = `${navbar()}<main class="main-content"><div class="page-container"><h1 class="font-display text-center mb-12" style="font-size:18px">ğŸ“œ ì—­ì‚¬</h1>${h.length===0?`<div class="card text-center" style="padding:30px"><p style="font-size:28px;margin-bottom:8px">ğŸ“œ</p><p style="font-size:11px">ê¸°ë¡ ì—†ìŒ</p></div>`:h.map(e=>`<div class="card mb-8"><div class="history-chapter">ì œ${e.chapter}ì¥</div><h3 style="font-size:13px;font-weight:700">${e.title}</h3><p style="margin-top:6px;line-height:1.5;color:var(--text-muted);font-size:11px">${e.content}</p></div>`).join('')}</div></main>`; };
    const renderPlaceholder = p => { document.getElementById('app').innerHTML = `${navbar()}<main class="main-content"><div class="page-container text-center" style="padding-top:50px"><h1 style="font-size:28px;margin-bottom:14px">ğŸ”’</h1><h2 class="font-display mb-12">${p}</h2><button class="btn btn-outline btn-sm" onclick="window.nav('dashboard')">í™ˆ</button></div></main>`; };
    
    let worldRunning = false;
    const exitWorld = () => { worldRunning = false; document.getElementById('worldCanvas').classList.remove('active'); document.getElementById('worldUI').classList.remove('active'); document.getElementById('touchControls').classList.remove('active'); document.getElementById('landingControls').classList.remove('active'); document.getElementById('encounterDialog').classList.remove('active'); navigate('dashboard'); };
    
    const startCellWorld = () => {
        document.getElementById('app').innerHTML = '';
        const canvas = document.getElementById('worldCanvas'); const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        canvas.classList.add('active'); document.getElementById('worldUI').classList.add('active'); document.getElementById('touchControls').classList.add('active');
        document.getElementById('worldStatLabel').textContent = 'ENTROPY';
        document.getElementById('worldNavButtons').innerHTML = `<button class="world-nav-btn next-stage" id="nextStageBtn" onclick="window.goToDrift()" disabled>ğŸŒ  í‘œë¥˜</button>`;
        worldRunning = true;
        const design = State.game.cellDesign || generateCellDesign();
        const player = { x: 0, y: 0, size: 30 + State.game.entropy * 0.02, speed: State.game.evolution.leg ? 5 : 3, collectRange: State.game.evolution.arm ? 100 : 50, multiplier: State.game.evolution.brain ? 2 : 1, dashing: false, dashCD: 0 };
        let particles = []; const camera = { x: 0, y: 0 }; const keys = {}; let time = 0;
        
        // í‚¤ë³´ë“œ ì§€ì› (ë°ìŠ¤í¬í†±)
        const onKeyDown = e => { keys[e.key.toLowerCase()] = true; if (e.code === 'Space' && State.game.evolution.wing && player.dashCD <= 0) { player.dashing = true; player.dashCD = 60; setTimeout(() => player.dashing = false, 200); } if (e.key === 'Escape') exitWorld(); };
        const onKeyUp = e => { keys[e.key.toLowerCase()] = false; };
        window.addEventListener('keydown', onKeyDown); window.addEventListener('keyup', onKeyUp);
        
        // ëŒ€ì‹œ ë²„íŠ¼
        const dashBtn = document.getElementById('dashBtn');
        dashBtn.onclick = () => { if (State.game.evolution.wing && player.dashCD <= 0) { player.dashing = true; player.dashCD = 60; setTimeout(() => player.dashing = false, 200); } };
        document.getElementById('homeBtn').onclick = exitWorld;
        
        const cleanup = () => { window.removeEventListener('keydown', onKeyDown); window.removeEventListener('keyup', onKeyUp); };
        const updateEvoPanel = () => { const evo = State.game.evolution; document.getElementById('worldInfoPanel').innerHTML = `<div class="world-info-title">ğŸ§¬ ì§„í™”</div>${[['eye','ğŸ‘ï¸',100],['arm','ğŸ¦¾',200],['leg','ğŸ¦µ',300],['brain','ğŸ§ ',500],['wing','ğŸª½',800]].map(([k,icon,req])=>`<div style="display:flex;align-items:center;gap:5px;margin-bottom:3px;opacity:${evo[k]?1:0.4}"><span style="font-size:12px">${icon}</span><span style="font-size:9px">${evo[k]?'âœ“':req}</span></div>`).join('')}`; document.getElementById('nextStageBtn').disabled = State.game.entropy < 800; dashBtn.classList.toggle('disabled', !evo.wing); };
        updateEvoPanel();
        const spawn = () => { while (particles.length < 50) { const a = Math.random() * Math.PI * 2, d = 100 + Math.random() * 350; particles.push({ x: player.x + Math.cos(a) * d, y: player.y + Math.sin(a) * d, size: 5 + Math.random() * 10, value: 1 + Math.floor(Math.random() * 3), pulse: Math.random() * Math.PI * 2, hue: 160 + Math.random() * 60 }); } };
        const checkEvo = async () => { const e = State.game.entropy; const evo = State.game.evolution; const evos = [['eye',100,'ğŸ‘ï¸','ì‹œê°!','ì‹œì•¼+'],['arm',200,'ğŸ¦¾','íŒ”!','ìˆ˜ì§‘+'],['leg',300,'ğŸ¦µ','ë‹¤ë¦¬!','ì†ë„+'],['brain',500,'ğŸ§ ','ë‘ë‡Œ!','2ë°°'],['wing',800,'ğŸª½','ë‚ ê°œ!','ëŒ€ì‹œ']]; for (const [k,req,icon,title,effect] of evos) { if (!evo[k] && e >= req) { State.game.evolution[k] = true; if (k === 'arm') player.collectRange = 100; if (k === 'leg') player.speed = 5; if (k === 'brain') player.multiplier = 2; showEvoAlert(icon, title, 'ì§„í™”', effect); State.game.history.push({ chapter: State.game.history.length + 1, title, content: 'ëŠ¥ë ¥', timestamp: new Date().toISOString() }); updateEvoPanel(); } } player.size = Math.min(30 + e * 0.02, 70); await State.sync(); };
        
        const update = () => { 
            // í‚¤ë³´ë“œ + í„°ì¹˜ ì¡°ì´ìŠ¤í‹± ì…ë ¥ í†µí•©
            let mx = touchState.dx, my = touchState.dy;
            if (keys['w'] || keys['arrowup']) my = -1; if (keys['s'] || keys['arrowdown']) my = 1;
            if (keys['a'] || keys['arrowleft']) mx = -1; if (keys['d'] || keys['arrowright']) mx = 1;
            const len = Math.sqrt(mx * mx + my * my); if (len > 1) { mx /= len; my /= len; }
            let spd = player.speed; if (player.dashing) spd *= 3;
            player.x += mx * spd; player.y += my * spd;
            if (player.dashCD > 0) player.dashCD--;
            camera.x += (player.x - camera.x) * 0.1; camera.y += (player.y - camera.y) * 0.1;
        };
        const collect = () => { particles = particles.filter(p => { const dx = p.x - player.x, dy = p.y - player.y; const d = Math.sqrt(dx * dx + dy * dy); if (d < player.collectRange + p.size) { State.game.entropy += p.value * player.multiplier; document.getElementById('worldStatValue').textContent = State.game.entropy; checkEvo(); return false; } if (State.game.evolution.arm && d < player.collectRange * 2) { p.x -= dx * 0.05; p.y -= dy * 0.05; } return true; }); };
        const drawBg = () => { const g = ctx.createRadialGradient(canvas.width/2, canvas.height/2, 0, canvas.width/2, canvas.height/2, canvas.width); g.addColorStop(0, '#0a0a1a'); g.addColorStop(1, '#050510'); ctx.fillStyle = g; ctx.fillRect(0, 0, canvas.width, canvas.height); ctx.fillStyle = 'rgba(255,255,255,0.5)'; for (let i = 0; i < 50; i++) { const x = ((i * 137.5 + camera.x * 0.1) % canvas.width + canvas.width) % canvas.width; const y = ((i * 73.7 + camera.y * 0.1) % canvas.height + canvas.height) % canvas.height; ctx.beginPath(); ctx.arc(x, y, (Math.sin(time * 0.02 + i) + 1) * 0.7, 0, Math.PI * 2); ctx.fill(); } };
        const drawParticles = () => { particles.forEach(p => { const sx = canvas.width / 2 + (p.x - camera.x); const sy = canvas.height / 2 + (p.y - camera.y); p.pulse += 0.05; const sz = p.size * (Math.sin(p.pulse) * 0.3 + 1); const g = ctx.createRadialGradient(sx, sy, 0, sx, sy, sz); g.addColorStop(0, `hsla(${p.hue}, 100%, 70%, 1)`); g.addColorStop(1, `hsla(${p.hue}, 100%, 50%, 0)`); ctx.beginPath(); ctx.arc(sx, sy, sz, 0, Math.PI * 2); ctx.fillStyle = g; ctx.fill(); }); };
        const drawPlayer = () => { if (player.dashing) { ctx.shadowColor = design.primaryColor; ctx.shadowBlur = 40; } drawCell(ctx, canvas.width / 2, canvas.height / 2, player.size, design, State.game.evolution, time); ctx.shadowBlur = 0; };
        const loop = () => { if (!worldRunning) { cleanup(); return; } time++; update(); spawn(); collect(); drawBg(); drawParticles(); drawPlayer(); requestAnimationFrame(loop); };
        for (let i = 0; i < 30; i++) { const a = Math.random() * Math.PI * 2, d = 50 + Math.random() * 250; particles.push({ x: Math.cos(a) * d, y: Math.sin(a) * d, size: 5 + Math.random() * 10, value: 1 + Math.floor(Math.random() * 3), pulse: Math.random() * Math.PI * 2, hue: 160 + Math.random() * 60 }); }
        document.getElementById('worldStatValue').textContent = State.game.entropy;
        loop();
    };
    
    const goToDrift = () => { if (State.game.entropy < 800) return; if (State.game.stage < 1.5) { State.game.stage = 1.5; State.game.history.push({ chapter: State.game.history.length + 1, title: 'íƒˆì¶œ', content: 'ê³µê°„ íƒˆì¶œ', timestamp: new Date().toISOString() }); State.sync(); } worldRunning = false; document.getElementById('worldCanvas').classList.remove('active'); document.getElementById('worldUI').classList.remove('active'); document.getElementById('touchControls').classList.remove('active'); showStory('ğŸŒ ', 'ìš°ì£¼ í‘œë¥˜', '<strong>ìš°ì£¼</strong>ë¡œ ë‚˜ì™”ë‹¤.<br>í¡ìˆ˜í•˜ë©´ í˜•íƒœê°€ ì„ì¸ë‹¤!', () => navigate('drift')); };
    
    const startCosmicDrift = () => {
        document.getElementById('app').innerHTML = '';
        const canvas = document.getElementById('worldCanvas'); const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        canvas.classList.add('active'); document.getElementById('worldUI').classList.add('active'); document.getElementById('touchControls').classList.add('active');
        document.getElementById('worldStatLabel').textContent = 'DISTANCE';
        document.getElementById('worldNavButtons').innerHTML = '';
        worldRunning = true;
        let design = State.game.cellDesign || generateCellDesign();
        let driftProgress = State.game.driftProgress || 0; const targetDistance = 1000;
        const player = { x: canvas.width / 2, y: canvas.height / 2, speed: 4 };
        let driftingCells = []; let encounterActive = false; let currentEncounter = null; let time = 0; const keys = {};
        
        const onKeyDown = e => { keys[e.key.toLowerCase()] = true; if (e.key === 'Escape') exitWorld(); };
        const onKeyUp = e => { keys[e.key.toLowerCase()] = false; };
        window.addEventListener('keydown', onKeyDown); window.addEventListener('keyup', onKeyUp);
        document.getElementById('dashBtn').classList.add('disabled');
        document.getElementById('homeBtn').onclick = exitWorld;
        const cleanup = () => { window.removeEventListener('keydown', onKeyDown); window.removeEventListener('keyup', onKeyUp); };
        
        const updateInfo = () => { const p = Math.min(driftProgress / targetDistance * 100, 100); document.getElementById('worldInfoPanel').innerHTML = `<div class="world-info-title">ğŸŒŒ í‘œë¥˜</div><div class="progress-bar mb-8"><div class="progress-fill" style="width:${p}%"></div></div><div style="font-size:9px;color:var(--text-muted)">${Math.floor(driftProgress)}/${targetDistance}m</div><div style="margin-top:6px;font-size:9px;color:var(--accent)">í•©ì²´: ${State.game.mergedCells || 0}</div>`; };
        updateInfo();
        const spawnCell = () => { if (driftingCells.length >= 4 || encounterActive) return; const side = Math.floor(Math.random() * 4); let x, y; if (side === 0) { x = -40; y = Math.random() * canvas.height; } else if (side === 1) { x = canvas.width + 40; y = Math.random() * canvas.height; } else if (side === 2) { x = Math.random() * canvas.width; y = -40; } else { x = Math.random() * canvas.width; y = canvas.height + 40; } driftingCells.push({ x, y, vx: (Math.random() - 0.5) * 2, vy: (Math.random() - 0.5) * 2, size: 18 + Math.random() * 18, type: ['friendly', 'hostile', 'neutral', 'mysterious'][Math.floor(Math.random() * 4)], design: generateCellDesign() }); };
        const showEncounter = cell => { encounterActive = true; currentEncounter = cell; document.getElementById('encounterTitle').textContent = 'ì¡°ìš°!'; document.getElementById('encounterDesc').textContent = 'ì–´ë–»ê²Œ?'; document.getElementById('encounterChoices').innerHTML = [{id:'absorb',title:'í¡ìˆ˜',effect:'+50âš¡'},{id:'merge',title:'í•©ì²´',effect:'+100âš¡'},{id:'ignore',title:'ë¬´ì‹œ',effect:'í†µê³¼'},{id:'talk',title:'ëŒ€í™”',effect:'ëœë¤'}].map(c=>`<div class="encounter-choice" onclick="window.makeChoice('${c.id}')"><div class="choice-title">${c.title}</div><div class="choice-effect">${c.effect}</div></div>`).join(''); document.getElementById('encounterDialog').classList.add('active'); };
        window.makeChoice = async choice => { document.getElementById('encounterDialog').classList.remove('active'); if (choice === 'absorb') { State.game.cellDesign = mergeCellDesigns(State.game.cellDesign, currentEncounter.design); design = State.game.cellDesign; State.game.entropy += 50; showToast('âš¡ í¡ìˆ˜!', 'success'); } else if (choice === 'merge') { State.game.cellDesign = mergeCellDesigns(State.game.cellDesign, currentEncounter.design); design = State.game.cellDesign; State.game.mergedCells = (State.game.mergedCells || 0) + 1; State.game.entropy += 100; showToast('ğŸ§¬ í•©ì²´!', 'success'); } else if (choice === 'ignore') { showToast('í†µê³¼', 'info'); } else if (choice === 'talk') { const r = Math.random() > 0.5 ? 30 : -30; State.game.entropy = Math.max(0, State.game.entropy + r); showToast(r > 0 ? 'ğŸ’¬ ì •ë³´!' : 'âš ï¸ í•¨ì •!', r > 0 ? 'info' : 'error'); } driftingCells = driftingCells.filter(c => c !== currentEncounter); encounterActive = false; currentEncounter = null; await State.sync(); updateInfo(); };
        
        const update = () => { if (encounterActive) return;
            let mx = touchState.dx, my = touchState.dy;
            if (keys['w'] || keys['arrowup']) my = -1; if (keys['s'] || keys['arrowdown']) my = 1;
            if (keys['a'] || keys['arrowleft']) mx = -1; if (keys['d'] || keys['arrowright']) mx = 1;
            const len = Math.sqrt(mx * mx + my * my); if (len > 1) { mx /= len; my /= len; }
            player.x += mx * player.speed; player.y += my * player.speed;
            player.x = Math.max(35, Math.min(canvas.width - 35, player.x)); player.y = Math.max(35, Math.min(canvas.height - 35, player.y));
            if (mx !== 0 || my !== 0) { driftProgress += 0.4; State.game.driftProgress = driftProgress; document.getElementById('worldStatValue').textContent = Math.floor(driftProgress) + 'm'; updateInfo(); }
            if (driftProgress >= targetDistance) { worldRunning = false; cleanup(); canvas.classList.remove('active'); document.getElementById('worldUI').classList.remove('active'); document.getElementById('touchControls').classList.remove('active'); State.game.stage = 2; State.game.history.push({ chapter: State.game.history.length + 1, title: 'í–‰ì„± ë°œê²¬', content: 'í–‰ì„±!', timestamp: new Date().toISOString() }); State.sync(); showStory('ğŸŒ', 'í–‰ì„±!', '<strong>í–‰ì„±</strong> ê°ì§€!', () => navigate('landing')); return; }
            if (Math.random() < 0.008) spawnCell(); driftingCells.forEach(cell => { cell.x += cell.vx; cell.y += cell.vy; const dx = player.x - cell.x, dy = player.y - cell.y; if (Math.sqrt(dx * dx + dy * dy) < 55 && !encounterActive) showEncounter(cell); }); driftingCells = driftingCells.filter(c => c.x > -80 && c.x < canvas.width + 80 && c.y > -80 && c.y < canvas.height + 80);
        };
        const drawBg = () => { ctx.fillStyle = '#030308'; ctx.fillRect(0, 0, canvas.width, canvas.height); ctx.fillStyle = 'rgba(255,255,255,0.5)'; for (let i = 0; i < 80; i++) { const x = (i * 137.5 + time * 0.4) % canvas.width; const y = (i * 73.7) % canvas.height; ctx.beginPath(); ctx.arc(x, y, ((i % 3) + 1) * 0.4, 0, Math.PI * 2); ctx.fill(); } };
        const drawDriftingCells = () => { driftingCells.forEach(cell => { const colors = { friendly: '#4ade80', hostile: '#f87171', neutral: '#a3a3a3', mysterious: '#c084fc' }; ctx.globalAlpha = 0.8; const tempDesign = { ...cell.design, primaryColor: colors[cell.type] }; drawCell(ctx, cell.x, cell.y, cell.size, tempDesign, { eye: true, arm: true }, time); ctx.globalAlpha = 1; }); };
        const drawPlayer = () => { drawCell(ctx, player.x, player.y, 32, design, State.game.evolution, time); };
        const loop = () => { if (!worldRunning) { cleanup(); return; } time++; update(); drawBg(); drawDriftingCells(); drawPlayer(); requestAnimationFrame(loop); };
        document.getElementById('worldStatValue').textContent = Math.floor(driftProgress) + 'm';
        loop();
    };
    
    const startPlanetLanding = () => {
        document.getElementById('app').innerHTML = '';
        const canvas = document.getElementById('worldCanvas'); const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        canvas.classList.add('active'); document.getElementById('worldUI').classList.add('active'); document.getElementById('landingControls').classList.add('active');
        document.getElementById('worldStatLabel').textContent = 'DISTANCE';
        document.getElementById('worldNavButtons').innerHTML = '<button class="world-nav-btn" onclick="window.exitWorld()">í¬ê¸°</button>';
        document.getElementById('worldInfoPanel').innerHTML = `<div class="world-info-title">ğŸ›¡ï¸ ì‹¤ë“œ</div><div class="progress-bar"><div class="progress-fill" id="healthBar" style="width:100%;background:linear-gradient(90deg, var(--danger), var(--accent))"></div></div>`;
        worldRunning = true;
        const design = State.game.cellDesign || generateCellDesign();
        const targetPlanet = { name: PLANET_NAMES[Math.floor(Math.random() * PLANET_NAMES.length)], type: PLANET_TYPES[Math.floor(Math.random() * PLANET_TYPES.length)] };
        const player = { x: canvas.width / 2, y: 80, size: 28, health: 100, speed: 7 };
        let obstacles = []; let distance = 0; const targetDistance = 2500; let gameOver = false; let time = 0; const keys = {};
        
        const onKeyDown = e => { keys[e.key.toLowerCase()] = true; if (e.key === 'Escape') { worldRunning = false; exitLanding(); } };
        const onKeyUp = e => { keys[e.key.toLowerCase()] = false; };
        window.addEventListener('keydown', onKeyDown); window.addEventListener('keyup', onKeyUp);
        const cleanup = () => { window.removeEventListener('keydown', onKeyDown); window.removeEventListener('keyup', onKeyUp); };
        const exitLanding = () => { cleanup(); canvas.classList.remove('active'); document.getElementById('worldUI').classList.remove('active'); document.getElementById('landingControls').classList.remove('active'); document.getElementById('resultModal').classList.remove('active'); navigate('dashboard'); };
        
        const spawnObstacle = () => { if (Math.random() < 0.5) obstacles.push({ type: 'asteroid', x: Math.random() * (canvas.width - 50) + 25, y: canvas.height + 40, size: 18 + Math.random() * 25, speed: 3 + Math.random() * 2.5, rotation: 0, rotSpeed: (Math.random() - 0.5) * 0.08 }); else { const w = 80 + Math.random() * 150; obstacles.push({ type: 'barrier', x: Math.random() * (canvas.width - w), y: canvas.height + 25, width: w, height: 18, speed: 3.5 + Math.random() * 2 }); } };
        
        const update = () => { if (gameOver) return;
            // í„°ì¹˜ + í‚¤ë³´ë“œ
            if (landingTouch.left || keys['a'] || keys['arrowleft']) player.x -= player.speed;
            if (landingTouch.right || keys['d'] || keys['arrowright']) player.x += player.speed;
            player.x = Math.max(player.size, Math.min(canvas.width - player.size, player.x));
            distance += 4; document.getElementById('worldStatValue').textContent = `${Math.floor(distance)}m`;
            if (Math.random() < 0.025 + (distance / targetDistance) * 0.015) spawnObstacle();
            obstacles = obstacles.filter(o => { o.y -= o.speed; if (o.rotation !== undefined) o.rotation += o.rotSpeed; let hit = false; if (o.type === 'asteroid') { if (Math.sqrt((player.x - o.x)**2 + (player.y - o.y)**2) < player.size + o.size) hit = true; } else if (o.type === 'barrier') { if (player.x > o.x - player.size && player.x < o.x + o.width + player.size && player.y > o.y - player.size && player.y < o.y + o.height + player.size) hit = true; } if (hit) { player.health -= 25; document.getElementById('healthBar').style.width = player.health + '%'; if (player.health <= 0) { gameOver = true; showResult(false, targetPlanet); } return false; } return o.y > -80; });
            if (distance >= targetDistance) { gameOver = true; showResult(true, targetPlanet); }
        };
        
        const showResult = async (success, planet) => { setTimeout(async () => { document.getElementById('resultIcon').textContent = success ? 'ğŸª' : 'ğŸ’¥'; document.getElementById('resultTitle').textContent = success ? 'ì„±ê³µ!' : 'ì‹¤íŒ¨'; document.getElementById('resultDesc').textContent = success ? planet.name : 'ì¶”ë½'; if (success) { State.game.currentPlanet = planet; State.game.stage = 3; State.game.explored = []; State.game.galaxyPosition = { x: Math.random() * 100, y: Math.random() * 100 }; const match = PLANETS_COL.find(p => planet.type.includes(p.name)); if (match) addToCollection('planets', match.id); State.game.history.push({ chapter: State.game.history.length + 1, title: 'ì°©ë¥™', content: planet.name, timestamp: new Date().toISOString() }); await State.sync(); document.getElementById('resultActions').innerHTML = '<button class="btn btn-primary btn-sm" onclick="window.explorePlanet()">ğŸŒ íƒí—˜</button>'; } else { document.getElementById('resultActions').innerHTML = '<button class="btn btn-outline btn-sm" onclick="window.retryLanding()">ì¬ì‹œë„</button><button class="btn btn-primary btn-sm" onclick="window.goHome()">í™ˆ</button>'; } document.getElementById('resultModal').classList.add('active'); }, 400); };
        
        const drawBg = () => { const g = ctx.createLinearGradient(0, 0, 0, canvas.height); g.addColorStop(0, '#050510'); g.addColorStop(1, '#1a1a4a'); ctx.fillStyle = g; ctx.fillRect(0, 0, canvas.width, canvas.height); const prog = Math.min(distance / targetDistance, 1); const planetSize = 180 + prog * 250; const planetY = canvas.height + 180 - prog * 280; const pg = ctx.createRadialGradient(canvas.width/2, planetY, 0, canvas.width/2, planetY, planetSize); pg.addColorStop(0, '#4ade80'); pg.addColorStop(0.5, '#22c55e'); pg.addColorStop(1, '#14532d'); ctx.beginPath(); ctx.arc(canvas.width/2, planetY, planetSize, 0, Math.PI * 2); ctx.fillStyle = pg; ctx.fill(); };
        const drawObstacles = () => { obstacles.forEach(o => { if (o.type === 'asteroid') { ctx.save(); ctx.translate(o.x, o.y); ctx.rotate(o.rotation); ctx.beginPath(); for (let i = 0; i < 7; i++) { const angle = (i / 7) * Math.PI * 2; const r = o.size * (0.8 + Math.sin(i * 2.5) * 0.18); i === 0 ? ctx.moveTo(Math.cos(angle) * r, Math.sin(angle) * r) : ctx.lineTo(Math.cos(angle) * r, Math.sin(angle) * r); } ctx.closePath(); ctx.fillStyle = '#4b5563'; ctx.fill(); ctx.restore(); } else if (o.type === 'barrier') { ctx.fillStyle = 'rgba(239,68,68,0.8)'; ctx.fillRect(o.x, o.y, o.width, o.height); } }); };
        const drawPlayer = () => { drawCell(ctx, player.x, player.y, player.size, design, State.game.evolution, time); };
        const loop = () => { if (!worldRunning) { cleanup(); return; } time++; if (!gameOver) update(); drawBg(); drawObstacles(); drawPlayer(); requestAnimationFrame(loop); };
        loop();
    };
    
    const explorePlanet = () => { document.getElementById('resultModal').classList.remove('active'); worldRunning = false; document.getElementById('worldCanvas').classList.remove('active'); document.getElementById('worldUI').classList.remove('active'); document.getElementById('landingControls').classList.remove('active'); navigate('planet'); };
    const retryLanding = () => { document.getElementById('resultModal').classList.remove('active'); startPlanetLanding(); };
    const goHome = () => { document.getElementById('resultModal').classList.remove('active'); worldRunning = false; document.getElementById('worldCanvas').classList.remove('active'); document.getElementById('worldUI').classList.remove('active'); document.getElementById('landingControls').classList.remove('active'); navigate('dashboard'); };
    
    let previewAnimationId = null; let tempDesign = null; let selectedPart = null; let changedParts = new Set();
    const openEditModal = () => { document.getElementById('editCellModal').classList.add('active'); tempDesign = JSON.parse(JSON.stringify(State.game.cellDesign || generateCellDesign())); changedParts = new Set(); selectedPart = null; document.getElementById('cellNameInput').value = tempDesign.name || ''; renderPartsGrid(); startPreviewAnimation(); };
    const renderPartsGrid = () => { const parts = tempDesign.parts || {}; const evo = State.game.evolution; document.getElementById('partsGrid').innerHTML = Object.entries(PART_STYLES).map(([part, styles]) => { const cs = styles.find(s => s.id === parts[part]) || styles[0]; const isU = evo[part]; const isSel = selectedPart === part; return `<div class="part-item ${isSel ? 'selected' : ''} ${!isU ? 'locked' : ''}" onclick="${isU ? `window.selectPart('${part}')` : ''}"><div class="part-icon">${cs.icon}</div><div class="part-name">${part === 'eye' ? 'ëˆˆ' : part === 'arm' ? 'íŒ”' : part === 'leg' ? 'ë‹¤ë¦¬' : part === 'brain' ? 'ë‡Œ' : 'ë‚ ê°œ'}</div><div class="part-style">${isU ? cs.name : 'ğŸ”’'}</div></div>`; }).join(''); document.getElementById('styleSelector').style.display = selectedPart ? 'block' : 'none'; if (selectedPart) { const styles = PART_STYLES[selectedPart]; const cs = tempDesign.parts[selectedPart]; document.getElementById('styleOptions').innerHTML = styles.map(s => `<div class="style-option ${s.id === cs ? 'selected' : ''}" onclick="window.selectStyle('${s.id}')"><div style="font-size:16px;margin-bottom:2px">${s.icon}</div><div>${s.name}</div></div>`).join(''); } };
    const selectPart = part => { selectedPart = selectedPart === part ? null : part; renderPartsGrid(); };
    const selectStyle = styleId => { if (!selectedPart) return; const orig = (State.game.cellDesign?.parts || {})[selectedPart]; if (styleId !== orig) changedParts.add(selectedPart); else changedParts.delete(selectedPart); tempDesign.parts[selectedPart] = styleId; renderPartsGrid(); };
    const closeEditModal = () => { document.getElementById('editCellModal').classList.remove('active'); if (previewAnimationId) cancelAnimationFrame(previewAnimationId); };
    const startPreviewAnimation = () => { const canvas = document.getElementById('cellPreview'); if (!canvas) return; const ctx = canvas.getContext('2d'); let t = 0; const animate = () => { t++; ctx.clearRect(0, 0, 120, 120); drawCell(ctx, 60, 60, 28, tempDesign, State.game.evolution, t); previewAnimationId = requestAnimationFrame(animate); }; animate(); };
    const randomizeCellDesign = () => { tempDesign = generateCellDesign(); document.getElementById('cellNameInput').value = tempDesign.name; changedParts = new Set(); selectedPart = null; renderPartsGrid(); };
    const saveCellDesign = async () => { const cost = changedParts.size * 1000; if (cost > 0) { if (State.game.entropy < cost) { showToast(`${cost}âš¡ í•„ìš”`, 'error'); return; } if (!confirm(`${cost}âš¡ ì‚¬ìš©?`)) return; State.game.entropy -= cost; } tempDesign.name = document.getElementById('cellNameInput').value || tempDesign.name; State.game.cellDesign = { ...tempDesign }; await State.sync(); closeEditModal(); showToast(`âœ¨ ì €ì¥!`, 'success'); render(); };
    
    const googleLogin = async () => { try { document.getElementById('loadingScreen').classList.remove('hidden'); const result = await signInWithPopup(auth, googleProvider); const user = result.user; const snap = await getDoc(doc(db, 'users', user.uid)); if (!snap.exists()) { const newDesign = generateCellDesign(); await setDoc(doc(db, 'users', user.uid), { displayName: user.displayName, email: user.email, photoURL: user.photoURL, game: { entropy: 0, stage: 1, evolution: { eye: false, arm: false, leg: false, brain: false, wing: false }, currentPlanet: null, explored: [], history: [], cellDesign: newDesign, driftProgress: 0, mergedCells: 0, tech: [], lastOnline: Date.now(), dailyStreak: 0, lastDailyReward: null, collection: { creatures: [], artifacts: [], planets: [] }, galaxyPosition: { x: Math.random() * 100, y: Math.random() * 100 } }, createdAt: serverTimestamp(), updatedAt: serverTimestamp() }); showToast('ğŸ‰ í™˜ì˜!', 'success'); } } catch (e) { console.error(e); showToast('ì‹¤íŒ¨', 'error'); hideLoading(); } };
    const logout = async () => { await signOut(auth); State.user = null; navigate('login'); };
    
    const init = async () => {
        createStars();
        initJoystick();
        initLandingControls();
        
        onAuthStateChanged(auth, async user => {
            if (user) {
                State.user = user; await State.load();
                if (!State.game.cellDesign) State.game.cellDesign = generateCellDesign();
                if (!State.game.collection) State.game.collection = { creatures: [], artifacts: [], planets: [] };
                const offline = calculateOfflineEarnings();
                if (offline > 0) { State.game.entropy += offline; showToast(`ğŸ’¤ +${offline}âš¡`, 'success'); }
                State.game.lastOnline = Date.now();
                await State.sync();
                hideLoading(); navigate('dashboard');
            } else { State.user = null; hideLoading(); navigate('login'); }
        });
        
        window.nav = navigate; window.googleLogin = googleLogin; window.logout = logout; window.exitWorld = exitWorld; window.goToDrift = goToDrift;
        window.openEditModal = openEditModal; window.closeEditModal = closeEditModal; window.randomizeCellDesign = randomizeCellDesign; window.saveCellDesign = saveCellDesign;
        window.selectPart = selectPart; window.selectStyle = selectStyle;
        window.exploreCell = exploreCell; window.closeExploreModal = closeExploreModal;
        window.unlockTech = unlockTech;
        window.explorePlanet = explorePlanet; window.retryLanding = retryLanding; window.goHome = goHome; window.closeStory = closeStory; window.toggleUserMenu = toggleUserMenu;
        window.openDailyReward = openDailyReward; window.claimDailyReward = claimDailyReward;
        window.openCollectionModal = openCollectionModal; window.closeCollectionModal = closeCollectionModal; window.showCollection = showCollection;
    };
    init();
    </script>
</body>
</html>
