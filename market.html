<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOKLUCK ë¶€ë™ì‚° ë§ˆì¼“</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        :root { --primary: #ec4899; --primary-light: #f472b6; --secondary: #8b5cf6; --accent: #f59e0b; --success: #10b981; --danger: #ef4444; --bg-dark: #0a0a0f; --bg-card: #12121a; --bg-card-hover: #1a1a25; --border: #2a2a3a; --text: #f0f0f5; --text-muted: #8888a0; --gradient-primary: linear-gradient(135deg, #ec4899 0%, #8b5cf6 100%); --gradient-gold: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%); }
        body { background-color: var(--bg-dark); background-image: radial-gradient(ellipse at top, rgba(236,72,153,0.1) 0%, transparent 50%); color: var(--text); font-family: 'Noto Sans KR', sans-serif; min-height: 100vh; }
        .navbar { background: var(--bg-card); border-bottom: 1px solid var(--border); padding: 12px 20px; position: sticky; top: 0; z-index: 100; }
        .nav-container { max-width: 900px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 24px; font-weight: 900; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; cursor: pointer; text-decoration: none; }
        .wallet-badge { background: var(--bg-dark); padding: 8px 16px; border-radius: 50px; border: 1px solid var(--border); color: var(--primary); font-weight: 700; font-size: 14px; }
        .container { max-width: 900px; margin: 0 auto; padding: 24px 20px; }
        .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 24px; margin-bottom: 20px; }
        button { cursor: pointer; border: none; border-radius: 10px; font-weight: 600; padding: 12px 20px; transition: all 0.2s; font-family: 'Noto Sans KR', sans-serif; font-size: 14px; }
        button:hover { transform: translateY(-1px); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: var(--gradient-primary); color: white; }
        .btn-gold { background: var(--gradient-gold); color: #1a1a2e; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .btn-block { width: 100%; }
        input, select { width: 100%; background: var(--bg-dark); border: 1px solid var(--border); color: var(--text); padding: 14px 16px; border-radius: 10px; font-size: 15px; font-family: 'Noto Sans KR', sans-serif; margin-bottom: 12px; }
        input:focus, select:focus { outline: none; border-color: var(--primary); }
        label { display: block; font-size: 13px; color: var(--text-muted); margin-bottom: 6px; }
        .back-btn { display: inline-flex; align-items: center; gap: 8px; color: var(--text-muted); text-decoration: none; font-size: 14px; margin-bottom: 20px; }
        .back-btn:hover { color: var(--text); }

        .guide-section { background: var(--bg-card); border: 1px solid var(--border); border-radius: 20px; padding: 24px; margin-bottom: 24px; position: relative; overflow: hidden; }
        .guide-section::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: var(--gradient-primary); }
        .guide-steps { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
        .guide-step { background: rgba(236,72,153,0.08); border: 1px solid rgba(236,72,153,0.2); padding: 16px 12px; border-radius: 12px; text-align: center; }
        .guide-step .step-num { font-size: 24px; margin-bottom: 8px; }
        .guide-step .step-title { font-weight: 700; font-size: 13px; color: var(--primary-light); margin-bottom: 4px; }
        .guide-step .step-desc { font-size: 11px; color: var(--text-muted); }

        .control-panel { background: var(--bg-card); border: 1px solid var(--border); padding: 24px; border-radius: 20px; margin-bottom: 24px; }
        .select-group { display: flex; gap: 12px; margin-bottom: 16px; }
        .price-info { background: rgba(236,72,153,0.08); border: 1px solid rgba(236,72,153,0.2); border-radius: 12px; padding: 16px; display: flex; justify-content: space-around; text-align: center; }
        .price-item .price-label { font-size: 12px; color: var(--text-muted); margin-bottom: 4px; }
        .price-item .price-value { font-size: 16px; font-weight: 700; color: var(--primary-light); }

        .region-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 24px; }
        .region-stat { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 20px; text-align: center; }
        .region-stat-value { font-size: 28px; font-weight: 900; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .region-stat-label { font-size: 12px; color: var(--text-muted); margin-top: 4px; }

        .conquest-status { background: var(--gradient-primary); padding: 20px; border-radius: 16px; margin-bottom: 24px; text-align: center; font-weight: 700; display: none; animation: popIn 0.5s ease; }
        @keyframes popIn { 0% { transform: scale(0.95); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        .map-container { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 20px; padding: 20px; }
        .land-block { aspect-ratio: 1/1; background: var(--bg-card-hover); border-radius: 12px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; border: 2px solid var(--border); transition: all 0.3s; position: relative; overflow: hidden; }
        .land-block:hover { transform: scale(1.08); border-color: var(--primary); z-index: 10; box-shadow: 0 8px 25px rgba(236,72,153,0.3); }
        .land-empty { border-style: dashed; opacity: 0.7; }
        .land-empty:hover { opacity: 1; border-style: solid; }
        .land-text { font-size: 12px; text-align: center; line-height: 1.3; word-break: break-all; padding: 4px; font-weight: 800; text-shadow: 0 2px 4px rgba(0,0,0,0.8); z-index: 2; }
        .land-sub { font-size: 10px; margin-top: 4px; color: rgba(255,255,255,0.85); font-weight: 600; z-index: 2; text-shadow: 0 1px 3px rgba(0,0,0,0.8); }
        .land-owner-badge { position: absolute; top: 4px; right: 4px; font-size: 12px; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 100; backdrop-filter: blur(8px); }
        .modal-content { background: var(--bg-card); padding: 32px; border-radius: 24px; width: 90%; max-width: 380px; border: 1px solid var(--border); position: relative; }
        .modal-content::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: var(--gradient-primary); border-radius: 24px 24px 0 0; }
        .modal-title { font-size: 22px; font-weight: 900; margin-bottom: 8px; text-align: center; }
        .modal-price { text-align: center; margin-bottom: 20px; }
        .modal-price span { background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 24px; font-weight: 900; }
        .value-hint { background: rgba(245,158,11,0.1); border: 1px solid rgba(245,158,11,0.3); color: #fbbf24; padding: 14px; border-radius: 12px; font-size: 13px; margin-bottom: 20px; text-align: center; }
        .modal-btn { width: 100%; padding: 16px; border-radius: 12px; font-weight: 700; cursor: pointer; border: none; margin-top: 8px; font-size: 16px; font-family: 'Noto Sans KR', sans-serif; }
        .btn-confirm { background: var(--gradient-primary); color: white; }
        .btn-cancel { background: var(--bg-card-hover); color: var(--text); border: 1px solid var(--border); }

        footer { margin-top: 60px; padding: 30px 0; border-top: 1px solid var(--border); text-align: center; color: var(--text-muted); font-size: 13px; }
        footer a { color: var(--text-muted); text-decoration: none; margin: 0 12px; }

        @media (max-width: 600px) { .guide-steps { grid-template-columns: repeat(2, 1fr); } .map-container { gap: 6px; padding: 12px; } .land-text { font-size: 10px; } .region-stats { grid-template-columns: 1fr; } .select-group { flex-direction: column; } }

        .land-detail-card { background: var(--bg-dark); border-radius: 16px; padding: 20px; margin-bottom: 20px; }
        .land-detail-header { display: flex; align-items: center; gap: 16px; margin-bottom: 16px; }
        .land-detail-icon { width: 56px; height: 56px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 28px; }
        .land-detail-name { font-size: 20px; font-weight: 900; }
        .land-detail-owner { font-size: 14px; color: var(--text-muted); }
        .land-detail-stats { display: flex; gap: 20px; }
        .detail-stat { flex: 1; text-align: center; padding: 12px; background: rgba(236,72,153,0.1); border-radius: 10px; }
        .detail-stat-label { font-size: 12px; color: var(--text-muted); margin-bottom: 4px; }
        .detail-stat-value { font-size: 16px; font-weight: 700; color: var(--primary-light); }
        .sale-badge { background: var(--gradient-gold); color: #1a1a2e; padding: 8px 16px; border-radius: 20px; font-weight: 700; text-align: center; margin-bottom: 16px; }
        .sale-price { display: flex; justify-content: space-between; align-items: center; background: var(--bg-dark); padding: 16px; border-radius: 12px; margin-bottom: 16px; }
        .sale-price strong { font-size: 24px; color: var(--accent); }
        .offer-info { background: rgba(99,102,241,0.1); border: 1px solid rgba(99,102,241,0.3); color: #818cf8; padding: 16px; border-radius: 12px; margin-bottom: 16px; text-align: center; font-size: 14px; line-height: 1.5; }
        .my-land-info { background: rgba(16,185,129,0.1); border: 1px solid rgba(16,185,129,0.3); color: var(--success); padding: 12px; border-radius: 12px; margin-bottom: 16px; text-align: center; font-weight: 600; }
        .offer-item { display: flex; justify-content: space-between; align-items: center; padding: 16px; background: var(--bg-dark); border-radius: 12px; margin-bottom: 10px; }
        .offer-item-info { flex: 1; }
        .offer-item-name { font-weight: 600; margin-bottom: 4px; }
        .offer-item-price { color: var(--accent); font-weight: 700; }
        .offer-item-actions { display: flex; gap: 8px; }
        .offer-item-actions button { padding: 8px 12px; font-size: 12px; }
        .land-for-sale { border: 2px solid var(--accent) !important; animation: salePulse 2s infinite; }
        @keyframes salePulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(245,158,11,0.4); } 50% { box-shadow: 0 0 15px 5px rgba(245,158,11,0.2); } }
        .offers-badge { position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; width: 20px; height: 20px; border-radius: 50%; font-size: 11px; font-weight: 700; display: flex; align-items: center; justify-content: center; }
        .view-offers-btn { position: fixed; bottom: 20px; right: 20px; background: var(--gradient-primary); color: white; padding: 16px 24px; border-radius: 50px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 20px rgba(236,72,153,0.4); z-index: 50; display: none; }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="logo">BOKLUCK MARKET</a>
            <div class="wallet-badge" id="walletBadge">ğŸ’° ì—°ê²° í•„ìš”</div>
        </div>
    </nav>

    <div class="container">
        <a href="index.html" class="back-btn">â† ë©”ì¸ìœ¼ë¡œ</a>

        <div class="guide-section">
            <h4 style="margin-bottom: 20px; font-size: 18px;">ğŸ® ì´ìš© ê°€ì´ë“œ</h4>
            <div class="guide-steps">
                <div class="guide-step"><div class="step-num">1ï¸âƒ£</div><div class="step-title">ì§€ì—­ ì„ íƒ</div><div class="step-desc">êµ­ê°€ì™€ ë„ì‹œ ì„ íƒ</div></div>
                <div class="guide-step"><div class="step-num">2ï¸âƒ£</div><div class="step-title">ë¹ˆ ë•… í´ë¦­</div><div class="step-desc">ì ì„  = êµ¬ë§¤ ê°€ëŠ¥</div></div>
                <div class="guide-step"><div class="step-num">3ï¸âƒ£</div><div class="step-title">ì»¤ìŠ¤í…€</div><div class="step-desc">ì´ë¦„ & ìƒ‰ìƒ ì„¤ì •</div></div>
                <div class="guide-step"><div class="step-num">4ï¸âƒ£</div><div class="step-title">ëœë¤ ê°€ì¹˜</div><div class="step-desc">1~1,000 BOK!</div></div>
            </div>
        </div>

        <div id="conquestMessage" class="conquest-status">ğŸ‘‘ ì¶•í•˜í•©ë‹ˆë‹¤! ìµœëŒ€ ì†Œìœ ìì…ë‹ˆë‹¤!</div>

        <div class="control-panel">
            <h3 style="margin-bottom: 16px; font-size: 18px;">ğŸ—ºï¸ ì§€ì—­ ì„ íƒ</h3>
            <div class="select-group">
                <select id="countrySelect">
                    <option value="KR">ğŸ‡°ğŸ‡· í•œêµ­</option>
                    <option value="US">ğŸ‡ºğŸ‡¸ ë¯¸êµ­</option>
                    <option value="JP">ğŸ‡¯ğŸ‡µ ì¼ë³¸</option>
                    <option value="CN">ğŸ‡¨ğŸ‡³ ì¤‘êµ­</option>
                    <option value="DE">ğŸ‡©ğŸ‡ª ë…ì¼</option>
                    <option value="FR">ğŸ‡«ğŸ‡· í”„ë‘ìŠ¤</option>
                    <option value="GB">ğŸ‡¬ğŸ‡§ ì˜êµ­</option>
                </select>
                <select id="citySelect"></select>
            </div>
            <div class="price-info">
                <div class="price-item"><div class="price-label">êµ¬ë§¤ ê°€ê²©</div><div class="price-value">300 BOK</div></div>
                <div class="price-item"><div class="price-label">ëœë¤ ê°€ì¹˜</div><div class="price-value">1 ~ 1,000 BOK</div></div>
            </div>
        </div>

        <div class="region-stats">
            <div class="region-stat"><div class="region-stat-value" id="statSold">-</div><div class="region-stat-label">íŒë§¤ëœ ë•…</div></div>
            <div class="region-stat"><div class="region-stat-value" id="statAvailable">-</div><div class="region-stat-label">êµ¬ë§¤ ê°€ëŠ¥</div></div>
            <div class="region-stat"><div class="region-stat-value" id="statMyLands">-</div><div class="region-stat-label">ë‚´ ì†Œìœ </div></div>
        </div>

        <div id="landGrid" class="map-container"></div>
    </div>

    <div id="buyModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-title">ğŸ—ï¸ ë•… êµ¬ë§¤</div>
            <div class="modal-price"><span>300 BOK</span></div>
            <div class="value-hint">ğŸ° êµ¬ë§¤ ì‹œ 1~1,000 BOK ê°€ì¹˜ê°€ ëœë¤ ê²°ì •!</div>
            <label>ë•… ì´ë¦„ (ìµœëŒ€ 10ì)</label>
            <input type="text" id="inputName" placeholder="ì˜ˆ: ë¹„íŠ¸ì½”ì¸ íƒ€ì›Œ" maxlength="10">
            <label>ìƒ‰ìƒ ì„ íƒ</label>
            <input type="color" id="inputColor" value="#ec4899" style="height: 50px; padding: 5px;">
            <button id="confirmBuyBtn" class="modal-btn btn-confirm">êµ¬ë§¤ í™•ì •</button>
            <button id="cancelBuyBtn" class="modal-btn btn-cancel">ì·¨ì†Œ</button>
        </div>
    </div>

    <!-- ì†Œìœ ëœ ë•… ìƒì„¸/ê±°ë˜ ëª¨ë‹¬ -->
    <div id="landDetailModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-title">ğŸ  ë•… ì •ë³´</div>
            
            <div class="land-detail-card">
                <div class="land-detail-header">
                    <div class="land-detail-icon" id="detailIcon">ğŸ </div>
                    <div>
                        <div class="land-detail-name" id="detailName">ë•… ì´ë¦„</div>
                        <div class="land-detail-owner" id="detailOwner">ì†Œìœ ì</div>
                    </div>
                </div>
                <div class="land-detail-stats">
                    <div class="detail-stat">
                        <div class="detail-stat-label">ğŸ’ ê°€ì¹˜</div>
                        <div class="detail-stat-value" id="detailValue">0 BOK</div>
                    </div>
                    <div class="detail-stat">
                        <div class="detail-stat-label">ğŸ“… êµ¬ë§¤ì¼</div>
                        <div class="detail-stat-value" id="detailDate">-</div>
                    </div>
                </div>
            </div>

            <!-- íŒë§¤ ì¤‘ì¸ ê²½ìš° -->
            <div id="forSaleSection" style="display: none;">
                <div class="sale-badge">ğŸ·ï¸ íŒë§¤ ì¤‘</div>
                <div class="sale-price">
                    <span>íŒë§¤ê°€</span>
                    <strong id="salePrice">0 BOK</strong>
                </div>
                <button class="modal-btn btn-confirm" onclick="buyOwnedLand()">ğŸ’° êµ¬ë§¤í•˜ê¸°</button>
            </div>

            <!-- íŒë§¤ ì¤‘ì´ ì•„ë‹Œ ê²½ìš° (êµ¬ë§¤ ì œì•ˆ) -->
            <div id="offerSection" style="display: none;">
                <div class="offer-info">ğŸ’¬ ì´ ë•…ì€ í˜„ì¬ íŒë§¤ ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤.<br>ì†Œìœ ìì—ê²Œ êµ¬ë§¤ ì œì•ˆì„ ë³´ë‚´ë³´ì„¸ìš”!</div>
                <label>ì œì•ˆ ê°€ê²©</label>
                <input type="number" id="offerPrice" placeholder="BOK ë‹¨ìœ„" min="100">
                <button class="modal-btn btn-confirm" onclick="sendOffer()">ğŸ“¨ êµ¬ë§¤ ì œì•ˆ ë³´ë‚´ê¸°</button>
            </div>

            <!-- ë‚´ ë•…ì¸ ê²½ìš° (íŒë§¤ ì„¤ì •) -->
            <div id="myLandSection" style="display: none;">
                <div class="my-land-info">â­ ë‚´ ì†Œìœ  ë•…ì…ë‹ˆë‹¤</div>
                <label>íŒë§¤ ê°€ê²© ì„¤ì • (0 = íŒë§¤ ì•ˆí•¨)</label>
                <input type="number" id="myLandPrice" placeholder="BOK ë‹¨ìœ„" min="0">
                <button class="modal-btn btn-confirm" onclick="setLandForSale()">ğŸ·ï¸ íŒë§¤ ì„¤ì •</button>
                <button class="modal-btn btn-cancel" style="margin-top: 8px;" onclick="cancelSale()">íŒë§¤ ì·¨ì†Œ</button>
            </div>

            <button class="modal-btn btn-cancel" style="margin-top: 12px;" onclick="closeLandDetail()">ë‹«ê¸°</button>
        </div>
    </div>

    <!-- ë°›ì€ ì œì•ˆ ëª©ë¡ ëª¨ë‹¬ -->
    <div id="offersModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-title">ğŸ“¬ ë°›ì€ êµ¬ë§¤ ì œì•ˆ</div>
            <div id="offersList"></div>
            <button class="modal-btn btn-cancel" onclick="closeModal('offersModal')">ë‹«ê¸°</button>
        </div>
    </div>

    <div class="view-offers-btn" id="viewOffersBtn" onclick="openModal('offersModal')">
        ğŸ“¬ ë°›ì€ ì œì•ˆ <span id="offerCount">0</span>
    </div>

    <footer>
        <a href="index.html">ë©”ì¸ìœ¼ë¡œ</a>
        <p style="margin-top: 16px;">Â© 2024 BOKLUCK. ê°€ìƒ ë¶€ë™ì‚°ì˜ ê°€ì¹˜ëŠ” í”Œë«í¼ ë‚´ ì¬ë¯¸ ìš”ì†Œì…ë‹ˆë‹¤.</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, runTransaction, increment, query, where, updateDoc, getDocs, addDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyBwQjuqgWM4YKnqu_gzNbeCg5alrC-jVcQ", authDomain: "myco-737a0.firebaseapp.com", projectId: "myco-737a0", storageBucket: "myco-737a0.firebasestorage.app", messagingSenderId: "942571332540", appId: "1:942571332540:web:be0bb6fbdd32655501c1b9" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUser = null, currentBalance = 0, userData = null;
        let selectedLandData = null, selectedLandId = null;
        const LAND_PRICE = 300, TOTAL_LANDS = 25;
        
        const cities = {
            "KR": ["ì„œìš¸", "ë¶€ì‚°", "ì œì£¼", "ëŒ€ì „", "ê´‘ì£¼"],
            "US": ["ë‰´ìš•", "LA", "í…ì‚¬ìŠ¤", "ì‹œì¹´ê³ ", "ë§ˆì´ì• ë¯¸"],
            "JP": ["ë„ì¿„", "ì˜¤ì‚¬ì¹´", "êµí† ", "í›„ì¿ ì˜¤ì¹´"],
            "CN": ["ë² ì´ì§•", "ìƒí•˜ì´", "ê´‘ì €ìš°", "ì„ ì „"],
            "DE": ["ë² ë¥¼ë¦°", "ë®Œí—¨", "í•¨ë¶€ë¥´í¬"],
            "FR": ["íŒŒë¦¬", "ë§ˆë¥´ì„¸ìœ ", "ë¦¬ì˜¹"],
            "GB": ["ëŸ°ë˜", "ë§¨ì²´ìŠ¤í„°", "ë²„ë°ì—„"]
        };

        const countrySelect = document.getElementById("countrySelect");
        const citySelect = document.getElementById("citySelect");
        const grid = document.getElementById("landGrid");
        let selectedBlockIndex = null, selectedRegionKey = null;

        function updateRegionStats(soldCount, myCount) {
            document.getElementById("statSold").textContent = soldCount;
            document.getElementById("statAvailable").textContent = TOTAL_LANDS - soldCount;
            document.getElementById("statMyLands").textContent = myCount;
        }

        // ë¹ˆ ë•… êµ¬ë§¤ ëª¨ë‹¬
        function openBuyModal(index, regionKey) {
            if(!currentUser) return alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            if(currentBalance < LAND_PRICE) return alert(`BOKì´ ë¶€ì¡±í•©ë‹ˆë‹¤!\ní˜„ì¬: ${currentBalance.toLocaleString()} BOK\ní•„ìš”: ${LAND_PRICE} BOK`);
            selectedBlockIndex = index;
            selectedRegionKey = regionKey;
            document.getElementById("inputName").value = "";
            document.getElementById("inputColor").value = "#ec4899";
            document.getElementById("buyModal").style.display = "flex";
            document.getElementById("inputName").focus();
        }

        // ì†Œìœ ëœ ë•… ìƒì„¸ ëª¨ë‹¬
        window.openLandDetail = function(landId, data) {
            if(!currentUser) return alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            selectedLandId = landId;
            selectedLandData = data;
            
            // ê¸°ë³¸ ì •ë³´ í‘œì‹œ
            document.getElementById("detailIcon").style.background = data.color || "#ec4899";
            document.getElementById("detailIcon").textContent = "ğŸ ";
            document.getElementById("detailName").textContent = data.customName;
            document.getElementById("detailOwner").textContent = `${data.ownerCountry || ''} ${data.ownerName}`;
            document.getElementById("detailValue").textContent = `${data.randomValue || 0} BOK`;
            document.getElementById("detailDate").textContent = data.purchasedAt ? new Date(data.purchasedAt).toLocaleDateString() : '-';
            
            // ì„¹ì…˜ ì´ˆê¸°í™”
            document.getElementById("forSaleSection").style.display = "none";
            document.getElementById("offerSection").style.display = "none";
            document.getElementById("myLandSection").style.display = "none";
            
            const isMine = data.ownerUid === currentUser.uid;
            
            if(isMine) {
                // ë‚´ ë•…
                document.getElementById("myLandSection").style.display = "block";
                document.getElementById("myLandPrice").value = data.salePrice || "";
            } else if(data.forSale && data.salePrice > 0) {
                // íŒë§¤ ì¤‘ì¸ ë•…
                document.getElementById("forSaleSection").style.display = "block";
                document.getElementById("salePrice").textContent = `${data.salePrice.toLocaleString()} BOK`;
            } else {
                // íŒë§¤ ì¤‘ì´ ì•„ë‹Œ ë‚¨ì˜ ë•…
                document.getElementById("offerSection").style.display = "block";
                document.getElementById("offerPrice").value = "";
            }
            
            document.getElementById("landDetailModal").style.display = "flex";
        };

        window.closeLandDetail = function() {
            document.getElementById("landDetailModal").style.display = "none";
        };

        // íŒë§¤ ì¤‘ì¸ ë•… êµ¬ë§¤
        window.buyOwnedLand = async function() {
            if(!selectedLandData || !selectedLandId) return;
            const price = selectedLandData.salePrice;
            
            if(currentBalance < price) return alert("BOKì´ ë¶€ì¡±í•©ë‹ˆë‹¤!");
            if(!confirm(`${selectedLandData.customName}ì„(ë¥¼) ${price.toLocaleString()} BOKì— êµ¬ë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            
            try {
                await runTransaction(db, async (t) => {
                    const landRef = doc(db, "lands", selectedLandId);
                    const landDoc = await t.get(landRef);
                    const land = landDoc.data();
                    
                    if(!land.forSale) throw "ì´ ë•…ì€ ë” ì´ìƒ íŒë§¤ ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤.";
                    
                    // êµ¬ë§¤ì ì°¨ê°
                    t.update(doc(db, "users", currentUser.uid), { 
                        coin: increment(-price), 
                        totalSpent: increment(price),
                        landCount: increment(1)
                    });
                    // íŒë§¤ì ì§€ê¸‰
                    t.update(doc(db, "users", land.ownerUid), { 
                        coin: increment(price), 
                        totalEarned: increment(price),
                        landCount: increment(-1)
                    });
                    // ì†Œìœ ê¶Œ ì´ì „
                    t.update(landRef, {
                        ownerUid: currentUser.uid,
                        ownerName: currentUser.displayName,
                        ownerCountry: userData?.country || '',
                        forSale: false,
                        salePrice: null,
                        purchasedAt: new Date().toISOString()
                    });
                });
                
                alert(`ğŸ‰ êµ¬ë§¤ ì™„ë£Œ! ${selectedLandData.customName}ì˜ ìƒˆ ì£¼ì¸ì´ ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                closeLandDetail();
            } catch(e) { alert("ì˜¤ë¥˜: " + e); }
        };

        // êµ¬ë§¤ ì œì•ˆ ë³´ë‚´ê¸°
        window.sendOffer = async function() {
            if(!selectedLandData || !selectedLandId) return;
            const price = parseInt(document.getElementById("offerPrice").value);
            
            if(!price || price < 100) return alert("100 BOK ì´ìƒ ì œì•ˆí•˜ì„¸ìš”.");
            if(currentBalance < price) return alert("BOKì´ ë¶€ì¡±í•©ë‹ˆë‹¤!");
            
            try {
                await addDoc(collection(db, "landOffers"), {
                    landId: selectedLandId,
                    landName: selectedLandData.customName,
                    landRegion: selectedLandData.region,
                    sellerUid: selectedLandData.ownerUid,
                    sellerName: selectedLandData.ownerName,
                    buyerUid: currentUser.uid,
                    buyerName: currentUser.displayName,
                    buyerCountry: userData?.country || '',
                    offerPrice: price,
                    status: 'pending',
                    createdAt: new Date().toISOString()
                });
                
                alert(`ğŸ“¨ ${price.toLocaleString()} BOK êµ¬ë§¤ ì œì•ˆì„ ë³´ëƒˆìŠµë‹ˆë‹¤!`);
                closeLandDetail();
            } catch(e) { alert("ì˜¤ë¥˜: " + e); }
        };

        // ë‚´ ë•… íŒë§¤ ì„¤ì •
        window.setLandForSale = async function() {
            if(!selectedLandId) return;
            const price = parseInt(document.getElementById("myLandPrice").value);
            
            if(price && price < 100) return alert("100 BOK ì´ìƒìœ¼ë¡œ ì„¤ì •í•˜ì„¸ìš”.");
            
            await updateDoc(doc(db, "lands", selectedLandId), {
                forSale: price > 0,
                salePrice: price || null
            });
            
            if(price > 0) {
                alert(`ğŸ·ï¸ ${price.toLocaleString()} BOKì— íŒë§¤ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!`);
            } else {
                alert("íŒë§¤ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
            closeLandDetail();
        };

        window.cancelSale = async function() {
            if(!selectedLandId) return;
            await updateDoc(doc(db, "lands", selectedLandId), {
                forSale: false,
                salePrice: null
            });
            alert("íŒë§¤ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            closeLandDetail();
        };

        // ì œì•ˆ ìˆ˜ë½
        window.acceptOffer = async function(offerId, offerData) {
            if(!confirm(`${offerData.buyerName}ì˜ ${offerData.offerPrice.toLocaleString()} BOK ì œì•ˆì„ ìˆ˜ë½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            
            try {
                await runTransaction(db, async (t) => {
                    const buyerRef = doc(db, "users", offerData.buyerUid);
                    const buyerDoc = await t.get(buyerRef);
                    
                    if(buyerDoc.data().coin < offerData.offerPrice) throw "êµ¬ë§¤ìì˜ BOKì´ ë¶€ì¡±í•©ë‹ˆë‹¤.";
                    
                    // êµ¬ë§¤ì ì°¨ê°
                    t.update(buyerRef, { 
                        coin: increment(-offerData.offerPrice), 
                        totalSpent: increment(offerData.offerPrice),
                        landCount: increment(1)
                    });
                    // íŒë§¤ì ì§€ê¸‰
                    t.update(doc(db, "users", currentUser.uid), { 
                        coin: increment(offerData.offerPrice), 
                        totalEarned: increment(offerData.offerPrice),
                        landCount: increment(-1)
                    });
                    // ì†Œìœ ê¶Œ ì´ì „
                    t.update(doc(db, "lands", offerData.landId), {
                        ownerUid: offerData.buyerUid,
                        ownerName: offerData.buyerName,
                        ownerCountry: offerData.buyerCountry || '',
                        forSale: false,
                        salePrice: null,
                        purchasedAt: new Date().toISOString()
                    });
                    // ì œì•ˆ ì‚­ì œ
                    t.delete(doc(db, "landOffers", offerId));
                });
                
                alert("ğŸ‰ ê±°ë˜ ì™„ë£Œ!");
                loadOffers();
            } catch(e) { alert("ì˜¤ë¥˜: " + e); }
        };

        // ì œì•ˆ ê±°ì ˆ
        window.rejectOffer = async function(offerId) {
            if(!confirm("ì´ ì œì•ˆì„ ê±°ì ˆí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            await deleteDoc(doc(db, "landOffers", offerId));
            alert("ì œì•ˆì„ ê±°ì ˆí–ˆìŠµë‹ˆë‹¤.");
            loadOffers();
        };

        // ë°›ì€ ì œì•ˆ ë¡œë“œ
        async function loadOffers() {
            if(!currentUser) return;
            const q = query(collection(db, "landOffers"), where("sellerUid", "==", currentUser.uid), where("status", "==", "pending"));
            
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById("offersList");
                const btn = document.getElementById("viewOffersBtn");
                const count = snapshot.size;
                
                document.getElementById("offerCount").textContent = count;
                
                if(count > 0) {
                    btn.style.display = "block";
                } else {
                    btn.style.display = "none";
                }
                
                list.innerHTML = "";
                if(snapshot.empty) {
                    list.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 20px;">ë°›ì€ ì œì•ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }
                
                snapshot.forEach(docSnap => {
                    const o = docSnap.data();
                    list.innerHTML += `
                        <div class="offer-item">
                            <div class="offer-item-info">
                                <div class="offer-item-name">${o.landName} (${o.landRegion})</div>
                                <div style="font-size: 12px; color: var(--text-muted);">${o.buyerCountry || ''} ${o.buyerName}</div>
                                <div class="offer-item-price">${o.offerPrice.toLocaleString()} BOK</div>
                            </div>
                            <div class="offer-item-actions">
                                <button class="modal-btn btn-confirm" style="padding: 8px 12px;" onclick="acceptOffer('${docSnap.id}', ${JSON.stringify(o).replace(/"/g, '&quot;')})">ìˆ˜ë½</button>
                                <button class="modal-btn btn-cancel" style="padding: 8px 12px;" onclick="rejectOffer('${docSnap.id}')">ê±°ì ˆ</button>
                            </div>
                        </div>
                    `;
                });
            });
        }

        document.getElementById("cancelBuyBtn").onclick = () => document.getElementById("buyModal").style.display = "none";
        document.addEventListener("keydown", (e) => { if(e.key === "Escape") { document.getElementById("buyModal").style.display = "none"; closeLandDetail(); } });

        let unsubscribeMap = null;
        function loadMap() {
            const regionKey = `${countrySelect.value}-${citySelect.value}`;
            grid.innerHTML = "";
            for(let i = 0; i < TOTAL_LANDS; i++) {
                const div = document.createElement("div");
                div.className = "land-block land-empty";
                div.id = `block-${i}`;
                div.innerHTML = `<span class="land-text">ë¹ˆ ë•…</span><span class="land-sub">${LAND_PRICE} BOK</span>`;
                div.onclick = () => openBuyModal(i, regionKey);
                grid.appendChild(div);
            }

            if(unsubscribeMap) unsubscribeMap();
            const q = query(collection(db, "lands"), where("region", "==", regionKey));
            
            unsubscribeMap = onSnapshot(q, (snapshot) => {
                let myLandCount = 0, soldCount = 0;
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const el = document.getElementById(`block-${data.index}`);
                    if(!el) return;
                    soldCount++;
                    el.style.backgroundColor = data.color || "#ec4899";
                    el.style.borderColor = "rgba(255,255,255,0.2)";
                    el.style.borderStyle = "solid";
                    el.classList.remove("land-empty");
                    
                    // íŒë§¤ ì¤‘ í‘œì‹œ
                    if(data.forSale && data.salePrice > 0) {
                        el.classList.add("land-for-sale");
                    } else {
                        el.classList.remove("land-for-sale");
                    }
                    
                    const isMine = currentUser && data.ownerUid === currentUser.uid;
                    const ownerFlag = data.ownerCountry || '';
                    const valueText = data.randomValue ? `ğŸ’ ${data.randomValue}` : "?";
                    const saleTag = (data.forSale && data.salePrice > 0) ? `<span style="font-size: 9px;">ğŸ·ï¸${data.salePrice}</span>` : '';
                    
                    if(isMine) {
                        el.innerHTML = `<span class="land-owner-badge">â­</span><span class="land-text">${data.customName}</span><span class="land-sub">${valueText} ${saleTag}</span>`;
                        myLandCount++;
                    } else {
                        el.innerHTML = `<span class="land-owner-badge">${ownerFlag}</span><span class="land-text">${data.customName}</span><span class="land-sub">${data.forSale ? `ğŸ·ï¸${data.salePrice}` : data.ownerName}</span>`;
                    }
                    
                    const newEl = el.cloneNode(true);
                    newEl.onclick = () => openLandDetail(docSnap.id, data);
                    if(data.forSale) newEl.classList.add("land-for-sale");
                    el.parentNode.replaceChild(newEl, el);
                });
                updateRegionStats(soldCount, myLandCount);
                const statusBox = document.getElementById("conquestMessage");
                if(myLandCount >= 13) {
                    statusBox.style.display = "block";
                    statusBox.innerText = `ğŸ‘‘ [${citySelect.value}] ì§€ì—­ ì •ë³µ! (${myLandCount}/${TOTAL_LANDS})`;
                } else { statusBox.style.display = "none"; }
            });
        }

        function updateCityOptions() {
            const list = cities[countrySelect.value];
            citySelect.innerHTML = "";
            list.forEach(c => { const opt = document.createElement("option"); opt.value = c; opt.innerText = c; citySelect.appendChild(opt); });
            loadMap();
        }
        countrySelect.onchange = updateCityOptions;
        citySelect.onchange = loadMap;
        updateCityOptions();

        onAuthStateChanged(auth, (user) => {
            if(user) {
                currentUser = user;
                document.getElementById("walletBadge").innerText = "í™•ì¸ ì¤‘...";
                onSnapshot(doc(db, "users", user.uid), (d) => {
                    if(d.exists()) {
                        userData = d.data();
                        currentBalance = userData.coin || 0;
                        document.getElementById("walletBadge").innerText = `ğŸ’° ${currentBalance.toLocaleString()} BOK`;
                    }
                });
                loadMap();
                loadOffers();
            } else {
                document.getElementById("walletBadge").innerText = "ğŸ’° ë¡œê·¸ì¸ í•„ìš”";
                updateRegionStats(0, 0);
            }
        });

        document.getElementById("confirmBuyBtn").onclick = async () => {
            if(currentBalance < LAND_PRICE) return alert("BOK ë¶€ì¡±!");
            const name = document.getElementById("inputName").value.trim();
            const color = document.getElementById("inputColor").value;
            if(!name) return alert("ë•… ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");
            if(name.length > 10) return alert("10ì ì´ë‚´ë¡œ ì…ë ¥í•˜ì„¸ìš”.");

            const randomValue = Math.floor(Math.random() * 1000) + 1;
            const btn = document.getElementById("confirmBuyBtn");
            btn.innerText = "ì²˜ë¦¬ ì¤‘...";
            btn.disabled = true;

            const isFirstLand = (userData?.landCount || 0) === 0;

            try {
                await runTransaction(db, async (t) => {
                    const landRef = doc(db, "lands", `${selectedRegionKey}-${selectedBlockIndex}`);
                    const landDoc = await t.get(landRef);
                    if(landDoc.exists()) throw "ì´ë¯¸ íŒë§¤ëœ ë•…ì…ë‹ˆë‹¤!";
                    const userRef = doc(db, "users", currentUser.uid);
                    const userDoc = await t.get(userRef);
                    if(userDoc.data().coin < LAND_PRICE) throw "BOK ë¶€ì¡±!";
                    t.update(userRef, { coin: increment(-LAND_PRICE), totalSpent: increment(LAND_PRICE), landCount: increment(1) });
                    t.set(landRef, {
                        region: selectedRegionKey,
                        index: selectedBlockIndex,
                        ownerUid: currentUser.uid,
                        ownerName: currentUser.displayName,
                        ownerCountry: userData?.country || '',
                        customName: name,
                        color: color,
                        randomValue: randomValue,
                        forSale: false,
                        salePrice: null,
                        purchasedAt: new Date().toISOString()
                    });
                });
                
                // ì²« ë•… êµ¬ë§¤ ì‹œ ì´ˆëŒ€ 3ë‹¨ê³„ ë³´ìƒ
                if(isFirstLand && userData?.invitedBy) {
                    try {
                        // ì´ˆëŒ€ìì—ê²Œ 3ë‹¨ê³„ ë³´ìƒ (400 BOK)
                        await updateDoc(doc(db, "users", userData.invitedBy), { 
                            coin: increment(400), 
                            totalEarned: increment(400),
                            inviteRewards: increment(400)
                        });
                        // ì´ˆëŒ€ ê¸°ë¡ ì—…ë°ì´íŠ¸
                        const inviteQuery = query(collection(db, "invites"), where("inviteeUid", "==", currentUser.uid));
                        const inviteSnap = await getDocs(inviteQuery);
                        if(!inviteSnap.empty) {
                            await updateDoc(inviteSnap.docs[0].ref, { stage3: true, stage3At: new Date().toISOString() });
                        }
                    } catch(e) { console.log("ì´ˆëŒ€ ë³´ìƒ ì˜¤ë¥˜:", e); }
                }
                
                document.getElementById("buyModal").style.display = "none";
                let msg = `ğŸ‰ êµ¬ë§¤ ì„±ê³µ!\n\n`;
                if(randomValue >= 800) msg += `ğŸŒŸ ëŒ€ë°•!! ${randomValue} BOK ğŸ’ğŸ’ğŸ’`;
                else if(randomValue >= 500) msg += `ğŸ‘ ì¢‹ì•„ìš”! ${randomValue} BOK ğŸ’`;
                else if(randomValue >= 100) msg += `ğŸ˜Š ê´œì°®ë„¤ìš”! ${randomValue} BOK`;
                else msg += `ğŸ˜… ${randomValue} BOK - ë‹¤ìŒì—” ëŒ€ë°•!`;
                alert(msg);
            } catch(e) { alert("ì‹¤íŒ¨: " + e); }
            finally { btn.innerText = "êµ¬ë§¤ í™•ì •"; btn.disabled = false; }
        };

        window.openModal = (id) => document.getElementById(id).style.display = "flex";
        window.closeModal = (id) => document.getElementById(id).style.display = "none";
    </script>
</body>
</html>
