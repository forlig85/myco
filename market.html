<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOKLUCK REAL ESTATE</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;800&display=swap');
        
        body { background-color: #0f172a; color: #f8fafc; font-family: 'Pretendard', sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        
        /* í—¤ë” ìŠ¤íƒ€ì¼ */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #ec4899; padding-bottom: 15px; }
        .logo { font-size: 24px; font-weight: 800; color: #ec4899; cursor:pointer; }
        
        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        .control-panel { background: #1e293b; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #475569; }
        .select-group { display: flex; gap: 10px; margin-bottom: 15px; }
        select { background: #0f172a; color: white; border: 1px solid #64748b; padding: 10px; border-radius: 8px; flex: 1; font-size: 16px; font-family: 'Pretendard'; }
        
        /* ë§µ ê·¸ë¦¬ë“œ */
        .map-container { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
        .land-block { aspect-ratio: 1/1; background: #334155; border-radius: 4px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; border: 2px solid transparent; transition: 0.2s; }
        .land-block:hover { transform: scale(1.05); border-color: #ec4899; }
        
        /* ë•… ìƒíƒœ ì»¬ëŸ¬ */
        .land-empty { opacity: 0.5; }
        .land-my { background: #0ea5e9; border-color: #38bdf8; color: white; box-shadow: 0 0 10px rgba(14, 165, 233, 0.5); }
        .land-others { background: #475569; color: #cbd5e1; }
        
        .land-text { font-size: 12px; text-align: center; line-height: 1.2; word-break: break-all; padding: 2px; }
        .land-price { font-size: 10px; font-weight: bold; margin-top: 4px; }

        /* ì ë ¹ ìƒíƒœì°½ */
        .conquest-status { background: linear-gradient(90deg, #ec4899, #8b5cf6); padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; font-weight: bold; display: none; }
        
        button.back-btn { background: #334155; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-bottom: 20px; }
        button.back-btn:hover { background: #475569; }

    </style>
</head>
<body>
    <header>
        <div class="logo" onclick="location.href='index.html'">BOKLUCK LAND</div>
        <div id="walletBadge" style="font-weight:bold; color:#ec4899;">Loading...</div>
    </header>

    <button class="back-btn" onclick="location.href='index.html'">â† ê²Œì‹œíŒìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>

    <div id="conquestMessage" class="conquest-status">
        ğŸ‘‘ ì¶•í•˜í•©ë‹ˆë‹¤! ë‹¹ì‹ ì€ í˜„ì¬ ì´ ë„ì‹œì˜ ì‹œì¥(Governor)ì…ë‹ˆë‹¤! (13/25 ì ë ¹)
    </div>

    <div class="control-panel">
        <h3 style="margin-top:0;">ğŸ—ºï¸ ì§€ì—­ ì„ íƒ</h3>
        <div class="select-group">
            <select id="countrySelect">
                <option value="KR">ğŸ‡°ğŸ‡· í•œêµ­ (Korea)</option>
                <option value="US">ğŸ‡ºğŸ‡¸ ë¯¸êµ­ (USA)</option>
                <option value="JP">ğŸ‡¯ğŸ‡µ ì¼ë³¸ (Japan)</option>
            </select>
            <select id="citySelect">
                </select>
        </div>
        <div style="font-size:14px; color:#94a3b8;">
            * ë¹ˆ ë•… ê°€ê²©: <b>300 BOK</b><br>
            * ì ë ¹ ë£°: 25ê°œ ì¤‘ <b>13ê°œ ì´ìƒ</b> ì†Œìœ  ì‹œ 'ì‹œì¥' ë“±ê·¹
        </div>
    </div>

    <div id="landGrid" class="map-container">
        </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, runTransaction, increment, query, where } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyBwQjuqgWM4YKnqu_gzNbeCg5alrC-jVcQ", authDomain: "myco-737a0.firebaseapp.com", projectId: "myco-737a0", storageBucket: "myco-737a0.firebasestorage.app", messagingSenderId: "942571332540", appId: "1:942571332540:web:be0bb6fbdd32655501c1b9" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUser = null;
        let currentBalance = 0;
        const LAND_PRICE = 300;

        // ë„ì‹œ ë°ì´í„°
        const cities = {
            "KR": ["ì„œìš¸ (Seoul)", "ë¶€ì‚° (Busan)", "ì œì£¼ (Jeju)"],
            "US": ["ë‰´ìš• (New York)", "LA (Los Angeles)", "í…ì‚¬ìŠ¤ (Texas)"],
            "JP": ["ë„ì¿„ (Tokyo)", "ì˜¤ì‚¬ì¹´ (Osaka)"]
        };

        // UI ìš”ì†Œ
        const countrySelect = document.getElementById("countrySelect");
        const citySelect = document.getElementById("citySelect");
        const grid = document.getElementById("landGrid");

        // 1. ì…€ë ‰íŠ¸ ë°•ìŠ¤ ë¡œì§
        function updateCityOptions() {
            const country = countrySelect.value;
            const cityList = cities[country];
            citySelect.innerHTML = "";
            cityList.forEach(city => {
                const opt = document.createElement("option");
                opt.value = city.split(' ')[0]; // "ì„œìš¸"ë§Œ ê°’ìœ¼ë¡œ ì‚¬ìš©
                opt.innerText = city;
                citySelect.appendChild(opt);
            });
            loadMap(); // ë„ì‹œ ë°”ë€Œë©´ ë§µ ë¡œë“œ
        }
        countrySelect.addEventListener("change", updateCityOptions);
        citySelect.addEventListener("change", loadMap);
        updateCityOptions(); // ì´ˆê¸° ì‹¤í–‰

        // 2. ì¸ì¦ í™•ì¸
        onAuthStateChanged(auth, (user) => {
            if(user) {
                currentUser = user;
                onSnapshot(doc(db, "users", user.uid), (d) => {
                    if(d.exists()) {
                        currentBalance = d.data().coin;
                        document.getElementById("walletBadge").innerText = `ğŸ’° ${currentBalance.toLocaleString()} BOK`;
                    }
                });
            } else {
                alert("ë¡œê·¸ì¸ í•„ìš”"); location.href='index.html';
            }
        });

        // 3. ë§µ ë¡œë“œ (í•µì‹¬)
        let unsubscribeMap = null;
        function loadMap() {
            const country = countrySelect.value;
            const city = citySelect.value;
            const regionKey = `${country}-${city}`; // ì˜ˆ: KR-ì„œìš¸

            // ê·¸ë¦¬ë“œ ì´ˆê¸°í™”
            grid.innerHTML = "";
            for(let i=0; i<25; i++) {
                const div = document.createElement("div");
                div.className = "land-block land-empty";
                div.id = `block-${i}`;
                div.innerHTML = `<span class="land-text">ë¹ˆ ë•…</span><span class="land-price">${LAND_PRICE}</span>`;
                div.onclick = () => buyLand(i, regionKey);
                grid.appendChild(div);
            }

            // ì‹¤ì‹œê°„ ë°ì´í„° êµ¬ë…
            if(unsubscribeMap) unsubscribeMap();
            const q = query(collection(db, "lands"), where("region", "==", regionKey));
            
            unsubscribeMap = onSnapshot(q, (snapshot) => {
                let myLandCount = 0;

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const idx = data.index;
                    const el = document.getElementById(`block-${idx}`);
                    
                    if(currentUser && data.ownerUid === currentUser.uid) {
                        el.className = "land-block land-my";
                        el.innerHTML = `<span class="land-text">${data.customName}</span><span class="land-price">ë‚´ ë•…</span>`;
                        myLandCount++;
                    } else {
                        el.className = "land-block land-others";
                        el.innerHTML = `<span class="land-text">${data.customName}</span><span class="land-price">${data.ownerName}</span>`;
                    }
                    // ì´ë¯¸ íŒ”ë¦° ë•…ì€ í´ë¦­ ì´ë²¤íŠ¸ ë®ì–´ì“°ê¸° (ê±°ë˜ ê¸°ëŠ¥ì€ ì—¬ê¸°ì„œ ìƒëµí•˜ê³  ë‹¨ìˆœí™”)
                    el.onclick = () => alert(`ì†Œìœ ì: ${data.ownerName}\në•… ì´ë¦„: ${data.customName}`);
                });

                // ì ë ¹(Conquest) ì²´í¬
                const statusBox = document.getElementById("conquestMessage");
                if(myLandCount >= 13) {
                    statusBox.style.display = "block";
                    statusBox.innerText = `ğŸ‘‘ ì¶•í•˜í•©ë‹ˆë‹¤! ë‹¹ì‹ ì€ [${city}]ì˜ ì‹œì¥ì…ë‹ˆë‹¤! (${myLandCount}/25 ì ë ¹)`;
                } else {
                    statusBox.style.display = "none";
                }
            });
        }

        // 4. ë•… êµ¬ë§¤
        async function buyLand(index, regionKey) {
            if(currentBalance < LAND_PRICE) return alert("ì”ì•¡ ë¶€ì¡±!");
            if(!confirm(`${regionKey} ì§€ì—­ì˜ ${index+1}ë²ˆ ë•…ì„ êµ¬ë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            const name = prompt("ë•… ì´ë¦„ì„ ì§€ì–´ì£¼ì„¸ìš”!");
            if(!name) return;

            try {
                await runTransaction(db, async (t) => {
                    const landId = `${regionKey}-${index}`;
                    const landRef = doc(db, "lands", landId);
                    const landDoc = await t.get(landRef);
                    
                    if(landDoc.exists()) throw "ì´ë¯¸ íŒë§¤ëœ ë•…ì…ë‹ˆë‹¤.";
                    
                    const userRef = doc(db, "users", currentUser.uid);
                    const userDoc = await t.get(userRef);
                    if(userDoc.data().coin < LAND_PRICE) throw "ì”ì•¡ ë¶€ì¡±";

                    t.update(userRef, { coin: increment(-LAND_PRICE) });
                    t.set(landRef, {
                        region: regionKey,
                        index: index,
                        ownerUid: currentUser.uid,
                        ownerName: currentUser.displayName,
                        customName: name,
                        purchasedAt: new Date().toISOString()
                    });
                });
                alert("êµ¬ë§¤ ì„±ê³µ! ë•… ì£¼ì¸ì´ ë˜ì…¨ìŠµë‹ˆë‹¤.");
            } catch(e) { alert(e); }
        }
    </script>
</body>
</html>
