<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOKLUCK MARKETPLACE</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&family=Pretendard:wght@400;700&display=swap');
        body { background-color: #050b14; background-image: linear-gradient(rgba(255, 0, 204, 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 0, 204, 0.05) 1px, transparent 1px); background-size: 40px 40px; color: #e0f7fa; font-family: 'Pretendard', sans-serif; max-width: 700px; margin: 0 auto; padding: 20px; }
        .cyber-box { background: rgba(20, 10, 40, 0.9); border: 1px solid #ff00cc; box-shadow: 0 0 15px rgba(255, 0, 204, 0.2); border-radius: 8px; padding: 20px; margin-bottom: 25px; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 2px solid #ff00cc; padding-bottom: 15px; }
        .logo { font-family: 'Rajdhani'; font-size: 28px; font-weight: 700; color: #fff; text-shadow: 0 0 10px #ff00cc; cursor:pointer; }
        .wallet-badge { font-family: 'Rajdhani'; font-size: 18px; color: #ff00cc; border: 1px solid #ff00cc; padding: 5px 15px; border-radius: 20px; background: rgba(255, 0, 204, 0.1); }
        
        /* ê·¸ë¦¬ë“œ ë§µ */
        .map-container { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-top: 20px; }
        .land-block { aspect-ratio: 1/1; border: 1px solid #555; background: rgba(255,255,255,0.05); display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; transition: 0.2s; position: relative; overflow: hidden; }
        .land-block:hover { border-color: #ff00cc; transform: scale(1.05); z-index: 10; box-shadow: 0 0 15px rgba(255,0,204,0.5); }
        
        /* ë•… ìƒíƒœë³„ ìŠ¤íƒ€ì¼ */
        .land-my { border: 2px solid #00f3ff; background: rgba(0, 243, 255, 0.2); } /* ë‚´ ë•… */
        .land-others { border: 1px solid #777; background: rgba(255,255,255,0.1); opacity: 0.8; } /* ë‚¨ì˜ ë•… */
        .land-sale { border: 2px solid #ff0055; background: rgba(255, 0, 85, 0.2); animation: pulse 2s infinite; } /* íŒë§¤ì¤‘ */
        
        @keyframes pulse { 0% {box-shadow: 0 0 0 0 rgba(255,0,85,0.4);} 70% {box-shadow: 0 0 0 10px rgba(255,0,85,0);} 100% {box-shadow: 0 0 0 0 rgba(255,0,85,0);} }

        .land-name { font-size: 11px; font-weight: bold; text-align: center; word-break: keep-all; line-height: 1.2; padding: 2px; }
        .land-tag { font-size: 10px; padding: 2px 4px; border-radius: 4px; margin-top: 4px; font-weight: bold; }
        .tag-sale { background: #ff0055; color: white; }
        .tag-price { color: #ff00cc; font-size: 12px; font-weight: bold; }

        .back-btn { background: #333; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; margin-bottom: 20px; }
        .back-btn:hover { background: #555; }
    </style>
</head>
<body>
    <header>
        <div class="logo" onclick="location.href='index.html'">BOKLUCK <span style="color:#ff00cc;">MARKET</span></div>
        <div id="walletBadge" class="wallet-badge">Loading...</div>
    </header>

    <button class="back-btn" onclick="location.href='index.html'">â¬…ï¸ BACK TO MINING</button>

    <div class="cyber-box">
        <h3 style="margin:0; color:#ff00cc;">ğŸŒ REAL ESTATE EXCHANGE</h3>
        <p style="font-size:13px; color:#aaa; margin-bottom:20px;">
            * ë¹ˆ ë•… ê°€ê²©: <b>300 BOK</b><br>
            * ìœ ì €ê°„ ê±°ë˜: <b>íŒë§¤ìê°€ ì„¤ì •í•œ ê°€ê²©</b> (íŒë§¤ ì‹œ ì¦‰ì‹œ ì…ê¸ˆë¨)
        </p>
        
        <div id="landGrid" class="map-container">
            </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, getDoc, runTransaction, increment } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyBwQjuqgWM4YKnqu_gzNbeCg5alrC-jVcQ", authDomain: "myco-737a0.firebaseapp.com", projectId: "myco-737a0", storageBucket: "myco-737a0.firebasestorage.app", messagingSenderId: "942571332540", appId: "1:942571332540:web:be0bb6fbdd32655501c1b9" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const TOTAL_LANDS = 25;
        const SYSTEM_PRICE = 300;
        let currentUser = null;
        let currentBalance = 0;

        // 1. ë§µ UI ì´ˆê¸°í™”
        const grid = document.getElementById("landGrid");
        for(let i=0; i<TOTAL_LANDS; i++) {
            const div = document.createElement("div");
            div.className = "land-block";
            div.id = `land-${i}`;
            div.innerHTML = `<span class="land-name" style="color:#555;">EMPTY</span><span class="land-tag" style="color:#555;">${SYSTEM_PRICE} BOK</span>`;
            div.onclick = () => handleLandClick(i); // í´ë¦­ ì´ë²¤íŠ¸ ì—°ê²°
            grid.appendChild(div);
        }

        // 2. ì¸ì¦ ë° ì”ì•¡ í™•ì¸
        onAuthStateChanged(auth, (user) => {
            if(user) {
                currentUser = user;
                onSnapshot(doc(db, "users", user.uid), (d) => {
                    if(d.exists()) {
                        currentBalance = d.data().coin;
                        document.getElementById("walletBadge").innerHTML = `ğŸ’° ${currentBalance.toLocaleString()} BOK`;
                    }
                });
            } else {
                alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë©”ì¸í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
                location.href = 'index.html';
            }
        });

        // 3. ì‹¤ì‹œê°„ ë•… ë°ì´í„° ì—°ë™
        onSnapshot(collection(db, "lands"), (snapshot) => {
            snapshot.forEach((doc) => {
                const data = doc.data();
                const el = document.getElementById(doc.id);
                if(!el) return;

                // ë°ì´í„° ì €ì¥ (í´ë¦­ ì‹œ ì°¸ì¡°ìš©)
                el.dataset.ownerUid = data.ownerUid;
                el.dataset.price = data.price || SYSTEM_PRICE;
                el.dataset.status = data.status || 'owned'; // owned, forSale
                el.dataset.customName = data.customName || "ì´ë¦„ ì—†ìŒ";

                // ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
                el.className = "land-block";
                
                // ë‚´ ë•…
                if(currentUser && data.ownerUid === currentUser.uid) {
                    el.classList.add("land-my");
                    let statusHtml = data.status === 'forSale' ? `<span class="land-tag tag-sale">íŒë§¤ì¤‘: ${data.price}</span>` : `<span class="land-tag" style="color:#00f3ff">ë‚´ ë•…</span>`;
                    el.innerHTML = `<span class="land-name">${data.customName}</span>${statusHtml}`;
                } 
                // íŒë§¤ì¤‘ì¸ ë•…
                else if(data.status === 'forSale') {
                    el.classList.add("land-sale");
                    el.innerHTML = `<span class="land-name">${data.customName}</span><span class="land-tag tag-sale">${data.price} BOK</span>`;
                }
                // ê·¸ëƒ¥ ë‚¨ì˜ ë•…
                else {
                    el.classList.add("land-others");
                    el.innerHTML = `<span class="land-name">${data.customName}</span><span class="land-tag">${data.ownerName}</span>`;
                }
            });
        });

        // 4. í´ë¦­ í•¸ë“¤ëŸ¬ (í•µì‹¬ ë¡œì§)
        async function handleLandClick(index) {
            const el = document.getElementById(`land-${index}`);
            const ownerUid = el.dataset.ownerUid;
            const status = el.dataset.status;
            const price = parseInt(el.dataset.price) || SYSTEM_PRICE;
            const landName = el.dataset.customName;

            // [ìƒí™© 1] ë¹ˆ ë•… êµ¬ë§¤ (ì‹œìŠ¤í…œ ê±°ë˜)
            if(!ownerUid) {
                if(currentBalance < SYSTEM_PRICE) return alert("ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");
                if(!confirm(`#${index+1}ë²ˆ ë•…ì„ êµ¬ë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (300 BOK)`)) return;
                
                const customName = prompt("ë•… ì´ë¦„ì„ ì§€ì–´ì£¼ì„¸ìš”! (ì˜ˆ: ê°•ë‚¨ ë³¸ì )");
                if(!customName) return alert("ì´ë¦„ì„ ì§“ì§€ ì•Šì•„ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");

                buyLandTransaction(index, SYSTEM_PRICE, null, customName); // íŒë§¤ì ì—†ìŒ(null)
            }
            // [ìƒí™© 2] ë‚´ ë•… ê´€ë¦¬ (íŒë§¤ ë“±ë¡/ì·¨ì†Œ)
            else if(ownerUid === currentUser.uid) {
                if(status === 'forSale') {
                    if(confirm("íŒë§¤ë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) updateLandStatus(index, 'owned', 0);
                } else {
                    const sellPrice = prompt("íŒë§¤ ê°€ê²©ì„ ì…ë ¥í•˜ì„¸ìš” (BOK)", "1000");
                    if(!sellPrice || isNaN(sellPrice) || sellPrice <= 0) return;
                    updateLandStatus(index, 'forSale', parseInt(sellPrice));
                }
            }
            // [ìƒí™© 3] ë‚¨ì˜ ë•… êµ¬ë§¤ (ìœ ì €ê°„ ê±°ë˜)
            else {
                if(status === 'forSale') {
                    if(currentBalance < price) return alert(`ì”ì•¡ ë¶€ì¡±! ${price} BOKì´ í•„ìš”í•©ë‹ˆë‹¤.`);
                    if(confirm(`"${landName}" ë•…ì„ êµ¬ë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nê°€ê²©: ${price} BOK\n(íŒë§¤ìì—ê²Œ ì¦‰ì‹œ ì…ê¸ˆë©ë‹ˆë‹¤)`)) {
                        buyLandTransaction(index, price, ownerUid, landName); // íŒë§¤ì UID ì „ë‹¬
                    }
                } else {
                    alert(`ğŸ”’ [${landName}]\nì†Œìœ ì: ${el.innerHTML.split('span').pop().replace(/<[^>]*>/g, '')}\níŒë§¤ ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤.`);
                }
            }
        }

        // íŠ¸ëœì­ì…˜: êµ¬ë§¤ (ì‹œìŠ¤í…œ or ìœ ì €)
        async function buyLandTransaction(index, price, sellerUid, newName) {
            const landId = `land-${index}`;
            try {
                await runTransaction(db, async (t) => {
                    const userRef = doc(db, "users", currentUser.uid);
                    const userDoc = await t.get(userRef);
                    if(userDoc.data().coin < price) throw "ì”ì•¡ ë¶€ì¡±";

                    // êµ¬ë§¤ì ëˆ ì°¨ê°
                    t.update(userRef, { coin: increment(-price) });

                    // íŒë§¤ìê°€ ìˆìœ¼ë©´ (ìœ ì € ê±°ë˜) -> íŒë§¤ìì—ê²Œ ëˆ ì…ê¸ˆ
                    if(sellerUid) {
                        const sellerRef = doc(db, "users", sellerUid);
                        t.update(sellerRef, { coin: increment(price) });
                    }

                    // ë•… ëª…ì˜ ë³€ê²½
                    const landRef = doc(db, "lands", landId);
                    // ê¸°ì¡´ ë°ì´í„° ìœ ì§€í•˜ë©´ì„œ ì—…ë°ì´íŠ¸
                    let updateData = {
                        ownerUid: currentUser.uid,
                        ownerName: currentUser.displayName,
                        status: 'owned',
                        purchasedAt: new Date().toISOString()
                    };
                    if(newName) updateData.customName = newName; // ì´ë¦„ ë³€ê²½ ì‹œì—ë§Œ

                    t.set(landRef, updateData, { merge: true });
                });
                alert("ğŸ‰ ê±°ë˜ ì„±ê³µ! ë¶€ë™ì‚° ë“±ê¸°ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            } catch(e) { alert("ê±°ë˜ ì‹¤íŒ¨: " + e); }
        }

        // ë‚´ ë•… ìƒíƒœ ë³€ê²½ (íŒë§¤ì¤‘ <-> ë³´ìœ ì¤‘)
        async function updateLandStatus(index, status, price) {
            try {
                await runTransaction(db, async (t) => {
                    const landRef = doc(db, "lands", `land-${index}`);
                    t.update(landRef, { status: status, price: price });
                });
                alert(status === 'forSale' ? `ë§¤ë¬¼ ë“±ë¡ ì™„ë£Œ! (${price} BOK)` : "íŒë§¤ ì·¨ì†Œ ì™„ë£Œ!");
            } catch(e) { alert("ì˜¤ë¥˜: " + e); }
        }
    </script>
</body>
</html>
