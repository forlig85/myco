<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOKLUCK REAL ESTATE</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;800&display=swap');
        body { background-color: #0f172a; color: #f8fafc; font-family: 'Pretendard', sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #ec4899; padding-bottom: 15px; }
        .logo { font-size: 24px; font-weight: 800; color: #ec4899; cursor:pointer; }
        .map-container { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
        .land-block { aspect-ratio: 1/1; background: #334155; border-radius: 4px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; border: 2px solid transparent; transition: 0.2s; }
        .land-block:hover { transform: scale(1.05); border-color: #ec4899; }
        .land-my { background: #0ea5e9; border-color: #38bdf8; color: white; box-shadow: 0 0 10px rgba(14, 165, 233, 0.5); }
        .land-others { background: #475569; color: #cbd5e1; }
        .land-text { font-size: 12px; text-align: center; line-height: 1.2; word-break: break-all; padding: 2px; }
        .land-price { font-size: 10px; font-weight: bold; margin-top: 4px; }
        .conquest-status { background: linear-gradient(90deg, #ec4899, #8b5cf6); padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; font-weight: bold; display: none; }
        button.back-btn { background: #334155; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-bottom: 20px; }
        select { background: #0f172a; color: white; border: 1px solid #64748b; padding: 10px; border-radius: 8px; font-size: 16px; margin-right: 10px; }
    </style>
</head>
<body>
    <header>
        <div class="logo" onclick="location.href='index.html'">BOKLUCK MARKET</div>
        <div id="walletBadge" style="font-weight:bold; color:#ec4899;">ì§€ê°‘ ì—°ê²° ì¤‘...</div>
    </header>

    <button class="back-btn" onclick="location.href='index.html'">â† ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>

    <div id="conquestMessage" class="conquest-status">
        ğŸ‘‘ ì¶•í•˜í•©ë‹ˆë‹¤! ë‹¹ì‹ ì€ ì´ ì§€ì—­ì˜ [ìµœëŒ€ ì†Œìœ ì]ì…ë‹ˆë‹¤! (13/25 ì ë ¹)
    </div>

    <div style="background: #1e293b; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
        <h3 style="margin-top:0;">ğŸ—ºï¸ ë¶€ë™ì‚° ì§€ì—­ ì„ íƒ</h3>
        <select id="countrySelect">
            <option value="KR">ğŸ‡°ğŸ‡· í•œêµ­</option>
            <option value="US">ğŸ‡ºğŸ‡¸ ë¯¸êµ­</option>
            <option value="JP">ğŸ‡¯ğŸ‡µ ì¼ë³¸</option>
        </select>
        <select id="citySelect"></select>
    </div>

    <div id="landGrid" class="map-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, runTransaction, increment, query, where } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

        // ğŸ”´ ë‹˜ì˜ í‚¤ ì ìš© ì™„ë£Œ (ì´ê²Œ ì—†ì–´ì„œ ì”ì•¡ì´ ì•ˆ ë–´ë˜ ê²ë‹ˆë‹¤)
        const firebaseConfig = {
          apiKey: "AIzaSyBwQjuqgWM4YKnqu_gzNbeCg5alrC-jVcQ",
          authDomain: "myco-737a0.firebaseapp.com",
          projectId: "myco-737a0",
          storageBucket: "myco-737a0.firebasestorage.app",
          messagingSenderId: "942571332540",
          appId: "1:942571332540:web:be0bb6fbdd32655501c1b9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUser = null;
        let currentBalance = 0;
        const LAND_PRICE = 300;

        const cities = {
            "KR": ["ì„œìš¸", "ë¶€ì‚°", "ì œì£¼"],
            "US": ["ë‰´ìš•", "LA", "í…ì‚¬ìŠ¤"],
            "JP": ["ë„ì¿„", "ì˜¤ì‚¬ì¹´"]
        };

        const countrySelect = document.getElementById("countrySelect");
        const citySelect = document.getElementById("citySelect");
        const grid = document.getElementById("landGrid");

        function updateCityOptions() {
            const list = cities[countrySelect.value];
            citySelect.innerHTML = "";
            list.forEach(c => {
                const opt = document.createElement("option");
                opt.value = c; opt.innerText = c;
                citySelect.appendChild(opt);
            });
            loadMap(); 
        }
        countrySelect.addEventListener("change", updateCityOptions);
        citySelect.addEventListener("change", loadMap);
        updateCityOptions(); 

        onAuthStateChanged(auth, (user) => {
            if(user) {
                currentUser = user;
                onSnapshot(doc(db, "users", user.uid), (d) => {
                    if(d.exists()) {
                        currentBalance = d.data().coin;
                        document.getElementById("walletBadge").innerText = `ğŸ’° ìì‚°: ${currentBalance.toLocaleString()} BOK`;
                    }
                });
            } else {
                alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."); location.href='index.html';
            }
        });

        let unsubscribeMap = null;
        function loadMap() {
            const regionKey = `${countrySelect.value}-${citySelect.value}`; 
            grid.innerHTML = "";
            for(let i=0; i<25; i++) {
                const div = document.createElement("div");
                div.className = "land-block land-empty";
                div.id = `block-${i}`;
                div.innerHTML = `<span class="land-text">ë¹ˆ ë•…</span><span class="land-price">${LAND_PRICE} BOK</span>`;
                div.onclick = () => buyLand(i, regionKey);
                grid.appendChild(div);
            }

            if(unsubscribeMap) unsubscribeMap();
            const q = query(collection(db, "lands"), where("region", "==", regionKey));
            
            unsubscribeMap = onSnapshot(q, (snapshot) => {
                let myLandCount = 0;
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const el = document.getElementById(`block-${data.index}`);
                    if(!el) return;

                    if(currentUser && data.ownerUid === currentUser.uid) {
                        el.className = "land-block land-my";
                        el.innerHTML = `<span class="land-text">${data.customName}</span><span class="land-price">ì†Œìœ  ì¤‘</span>`;
                        myLandCount++;
                    } else {
                        el.className = "land-block land-others";
                        el.innerHTML = `<span class="land-text">${data.customName}</span><span class="land-price">${data.ownerName}</span>`;
                    }
                    el.onclick = () => alert(`ì†Œìœ ì: ${data.ownerName}\në•… ì´ë¦„: ${data.customName}`);
                });

                const statusBox = document.getElementById("conquestMessage");
                if(myLandCount >= 13) {
                    statusBox.style.display = "block";
                    statusBox.innerText = `ğŸ‘‘ ì¶•í•˜í•©ë‹ˆë‹¤! ë‹¹ì‹ ì€ [${citySelect.value}]ì˜ ìµœëŒ€ ì†Œìœ ì(13/25)ì…ë‹ˆë‹¤!`;
                } else {
                    statusBox.style.display = "none";
                }
            });
        }

        async function buyLand(index, regionKey) {
            if(!currentUser) return alert("ì§€ê°‘ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.");
            if(currentBalance < LAND_PRICE) return alert(`ìì‚°(BOK)ì´ ë¶€ì¡±í•©ë‹ˆë‹¤! (í˜„ì¬: ${currentBalance})`);
            
            if(!confirm(`${regionKey} ì§€ì—­ì˜ ${index+1}ë²ˆ ìœ„ì¹˜ë¥¼ êµ¬ë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            const name = prompt("ì´ ë•…ì˜ ì´ë¦„ì„ ì§€ì–´ì£¼ì„¸ìš”!");
            if(!name) return;

            try {
                await runTransaction(db, async (t) => {
                    const landRef = doc(db, "lands", `${regionKey}-${index}`);
                    const landDoc = await t.get(landRef);
                    if(landDoc.exists()) throw "ì´ë¯¸ ì†Œìœ ìê°€ ìˆëŠ” ë•…ì…ë‹ˆë‹¤.";
                    
                    const userRef = doc(db, "users", currentUser.uid);
                    const userDoc = await t.get(userRef);
                    if(userDoc.data().coin < LAND_PRICE) throw "ìì‚° ë¶€ì¡±";

                    t.update(userRef, { coin: increment(-LAND_PRICE) });
                    t.set(landRef, { region: regionKey, index: index, ownerUid: currentUser.uid, ownerName: currentUser.displayName, customName: name, purchasedAt: new Date().toISOString() });
                });
                alert("êµ¬ë§¤ ì„±ê³µ! ì˜í† ê°€ í™•ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            } catch(e) { alert(e); }
        }
    </script>
</body>
</html>
