<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOKLUCK REAL ESTATE</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;800&display=swap');
        
        body { background-color: #0f172a; color: #f8fafc; font-family: 'Pretendard', sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        
        /* í—¤ë” ìŠ¤íƒ€ì¼ */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #ec4899; padding-bottom: 15px; }
        .logo { font-size: 24px; font-weight: 800; color: #ec4899; cursor:pointer; }
        
        /* ì§€ê°‘ ì •ë³´ ë° ìˆ˜ë™ ì—°ê²° ë²„íŠ¼ */
        .wallet-wrapper { display: flex; align-items: center; gap: 10px; }
        .wallet-info { font-weight: bold; color: #ec4899; font-size: 16px; }
        
        /* ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ (ë™ê¸°í™” ì¤‘ì¼ ë•Œ) */
        .sync-loader { font-size: 12px; color: #94a3b8; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

        .btn-connect { background: #ec4899; color: white; border: none; padding: 8px 12px; border-radius: 20px; font-weight: bold; cursor: pointer; font-size: 13px; display: none; } /* ê¸°ë³¸ ìˆ¨ê¹€ */

        /* ë’¤ë¡œê°€ê¸° ë²„íŠ¼ */
        button.back-btn { background: #334155; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-bottom: 20px; transition: 0.2s; }
        button.back-btn:hover { background: #475569; }

        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        .control-panel { background: #1e293b; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #475569; }
        .select-group { display: flex; gap: 10px; margin-bottom: 15px; }
        select { background: #0f172a; color: white; border: 1px solid #64748b; padding: 10px; border-radius: 8px; flex: 1; font-size: 16px; font-family: 'Pretendard'; }
        
        /* ë§µ ê·¸ë¦¬ë“œ */
        .map-container { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
        .land-block { aspect-ratio: 1/1; background: #334155; border-radius: 4px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; border: 2px solid transparent; transition: 0.2s; position: relative; }
        .land-block:hover { transform: scale(1.05); border-color: #ec4899; z-index: 10; }
        
        .land-empty { opacity: 0.6; }
        .land-my { background: #0ea5e9; border-color: #38bdf8; color: white; box-shadow: 0 0 15px rgba(14, 165, 233, 0.4); }
        .land-others { background: #475569; color: #cbd5e1; border: 1px solid #64748b; }
        
        .land-text { font-size: 12px; text-align: center; line-height: 1.2; word-break: break-all; padding: 2px; font-weight: 600; }
        .land-sub { font-size: 10px; margin-top: 4px; opacity: 0.8; }

        /* ì ë ¹ ë©”ì‹œì§€ */
        .conquest-status { background: linear-gradient(90deg, #ec4899, #8b5cf6); padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; font-weight: bold; display: none; box-shadow: 0 4px 15px rgba(236, 72, 153, 0.4); }
    </style>
</head>
<body>

    <header>
        <div class="logo" onclick="location.href='index.html'">BOKLUCK MARKET</div>
        <div class="wallet-wrapper">
            <button id="manualLoginBtn" class="btn-connect">ğŸ”‘ ì§€ê°‘ ì—°ê²°í•˜ê¸°</button>
            <div id="walletBadge" class="wallet-info sync-loader">ğŸ”„ ì •ë³´ ë™ê¸°í™” ì¤‘...</div>
        </div>
    </header>

    <button class="back-btn" onclick="location.href='index.html'">â† ë©”ì¸í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>

    <div id="conquestMessage" class="conquest-status">
        ğŸ‘‘ ì¶•í•˜í•©ë‹ˆë‹¤! ë‹¹ì‹ ì€ ì´ ì§€ì—­ì˜ [ìµœëŒ€ ì†Œìœ ì]ì…ë‹ˆë‹¤! (13/25 ì ë ¹)
    </div>

    <div class="control-panel">
        <h3 style="margin-top:0;">ğŸ—ºï¸ ë¶€ë™ì‚° ì§€ì—­ ì„ íƒ</h3>
        <div class="select-group">
            <select id="countrySelect">
                <option value="KR">ğŸ‡°ğŸ‡· í•œêµ­ (Korea)</option>
                <option value="US">ğŸ‡ºğŸ‡¸ ë¯¸êµ­ (USA)</option>
                <option value="JP">ğŸ‡¯ğŸ‡µ ì¼ë³¸ (Japan)</option>
            </select>
            <select id="citySelect"></select>
        </div>
        <div style="font-size:14px; color:#94a3b8;">
            * ë¹ˆ ë•… ê°€ê²©: <b>300 BOK</b><br>
            * ê³¼ë°˜ìˆ˜ ë£°: 25ê°œ ì¤‘ <b>13ê°œ ì´ìƒ</b> ì†Œìœ  ì‹œ 'ìµœëŒ€ ì†Œìœ ì' ë“±ê·¹
        </div>
    </div>

    <div id="landGrid" class="map-container">
        </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, runTransaction, increment, query, where } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

        // í‚¤ ì ìš© ì™„ë£Œ
        const firebaseConfig = {
          apiKey: "AIzaSyBwQjuqgWM4YKnqu_gzNbeCg5alrC-jVcQ",
          authDomain: "myco-737a0.firebaseapp.com",
          projectId: "myco-737a0",
          storageBucket: "myco-737a0.firebasestorage.app",
          messagingSenderId: "942571332540",
          appId: "1:942571332540:web:be0bb6fbdd32655501c1b9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUser = null;
        let currentBalance = 0;
        const LAND_PRICE = 300;

        const cities = {
            "KR": ["ì„œìš¸ (Seoul)", "ë¶€ì‚° (Busan)", "ì œì£¼ (Jeju)"],
            "US": ["ë‰´ìš• (New York)", "LA (Los Angeles)", "í…ì‚¬ìŠ¤ (Texas)"],
            "JP": ["ë„ì¿„ (Tokyo)", "ì˜¤ì‚¬ì¹´ (Osaka)"]
        };

        const countrySelect = document.getElementById("countrySelect");
        const citySelect = document.getElementById("citySelect");
        const grid = document.getElementById("landGrid");
        const walletBadge = document.getElementById("walletBadge");
        const manualLoginBtn = document.getElementById("manualLoginBtn");

        // 1. ìë™ ë¡œê·¸ì¸ ê°ì§€ (í•µì‹¬ ë¡œì§)
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // ë¡œê·¸ì¸ ì„±ê³µ! (ìë™ìœ¼ë¡œ ì—¬ê¸° ì§„ì…í•¨)
                currentUser = user;
                manualLoginBtn.style.display = "none"; // ë²„íŠ¼ ìˆ¨ê¹€
                walletBadge.classList.remove("sync-loader"); // ê¹œë¹¡ì„ íš¨ê³¼ ì œê±°
                walletBadge.innerText = "ğŸ’° ìì‚° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
                
                // ì”ì•¡ ì‹¤ì‹œê°„ ë™ê¸°í™”
                onSnapshot(doc(db, "users", user.uid), (d) => {
                    if (d.exists()) {
                        currentBalance = d.data().coin;
                        walletBadge.innerText = `ğŸ’° ìì‚°: ${currentBalance.toLocaleString()} BOK`;
                    } else {
                        currentBalance = 0;
                        walletBadge.innerText = `ğŸ’° ìì‚°: 0 BOK`;
                    }
                });
            } else {
                // ì§„ì§œ ë¡œê·¸ì•„ì›ƒ ìƒíƒœì¼ ë•Œë§Œ ìˆ˜ë™ ë²„íŠ¼ í‘œì‹œ
                currentUser = null;
                walletBadge.classList.remove("sync-loader");
                walletBadge.innerText = "ì—°ê²° í•„ìš”";
                manualLoginBtn.style.display = "block"; 
            }
        });

        // 2. ìˆ˜ë™ ë¡œê·¸ì¸ ë²„íŠ¼ (í˜¹ì‹œ ëª°ë¼ì„œ ë‚¨ê²¨ë‘ )
        manualLoginBtn.addEventListener("click", () => {
            signInWithPopup(auth, new GoogleAuthProvider()).catch(err => alert("ì—°ê²° ì‹¤íŒ¨: " + err.message));
        });

        // 3. ë§µ ë¡œì§ (ê¸°ì¡´ê³¼ ë™ì¼)
        function updateCityOptions() {
            const list = cities[countrySelect.value];
            citySelect.innerHTML = "";
            list.forEach(c => {
                const opt = document.createElement("option");
                opt.value = c.split(' ')[0]; 
                opt.innerText = c;
                citySelect.appendChild(opt);
            });
            loadMap(); 
        }
        countrySelect.addEventListener("change", updateCityOptions);
        citySelect.addEventListener("change", loadMap);
        updateCityOptions(); 

        let unsubscribeMap = null;
        function loadMap() {
            const regionKey = `${countrySelect.value}-${citySelect.value}`; 
            grid.innerHTML = "";
            for(let i=0; i<25; i++) {
                const div = document.createElement("div");
                div.className = "land-block land-empty";
                div.id = `block-${i}`;
                div.innerHTML = `<span class="land-text">ë¹ˆ ë•…</span><span class="land-sub">${LAND_PRICE} BOK</span>`;
                div.onclick = () => buyLand(i, regionKey);
                grid.appendChild(div);
            }

            if(unsubscribeMap) unsubscribeMap();
            const q = query(collection(db, "lands"), where("region", "==", regionKey));
            
            unsubscribeMap = onSnapshot(q, (snapshot) => {
                let myLandCount = 0;
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const el = document.getElementById(`block-${data.index}`);
                    if(!el) return;

                    if(currentUser && data.ownerUid === currentUser.uid) {
                        el.className = "land-block land-my";
                        el.innerHTML = `<span class="land-text">${data.customName}</span><span class="land-sub">ì†Œìœ  ì¤‘</span>`;
                        myLandCount++;
                    } else {
                        el.className = "land-block land-others";
                        el.innerHTML = `<span class="land-text">${data.customName}</span><span class="land-sub">${data.ownerName}</span>`;
                    }
                    el.onclick = () => alert(`ğŸ”’ [ì†Œìœ ì ì •ë³´]\n\nì´ë¦„: ${data.ownerName}\në•… ì´ë¦„: ${data.customName}`);
                });

                const statusBox = document.getElementById("conquestMessage");
                if(myLandCount >= 13) {
                    statusBox.style.display = "block";
                    statusBox.innerText = `ğŸ‘‘ ì¶•í•˜í•©ë‹ˆë‹¤! ë‹¹ì‹ ì€ [${citySelect.value}]ì˜ ìµœëŒ€ ì†Œìœ ìì…ë‹ˆë‹¤! (${myLandCount}/25)`;
                } else {
                    statusBox.style.display = "none";
                }
            });
        }

        async function buyLand(index, regionKey) {
            if(!currentUser) {
                alert("ì•„ì§ ì§€ê°‘ì´ ë™ê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.");
                return;
            }
            if(currentBalance < LAND_PRICE) return alert(`ìì‚° ë¶€ì¡±! (ë³´ìœ : ${currentBalance} BOK)`);

            if(!confirm(`[${regionKey}] ${index+1}ë²ˆ ë•…ì„ êµ¬ë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            const name = prompt("ë•… ì´ë¦„ ì…ë ¥:");
            if(!name) return;

            try {
                await runTransaction(db, async (t) => {
                    const landRef = doc(db, "lands", `${regionKey}-${index}`);
                    const landDoc = await t.get(landRef);
                    if(landDoc.exists()) throw "ì´ë¯¸ ì†Œìœ ëœ ë•…ì…ë‹ˆë‹¤.";
                    
                    const userRef = doc(db, "users", currentUser.uid);
                    t.update(userRef, { coin: increment(-LAND_PRICE) });
                    t.set(landRef, { region: regionKey, index: index, ownerUid: currentUser.uid, ownerName: currentUser.displayName, customName: name, purchasedAt: new Date().toISOString() });
                });
                alert("êµ¬ë§¤ ì„±ê³µ!");
            } catch(e) { alert(e); }
        }
    </script>
</body>
</html>
