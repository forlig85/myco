<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOKLUCK ë¶€ë™ì‚° ë§ˆì¼“</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        :root { --primary: #ec4899; --primary-light: #f472b6; --secondary: #8b5cf6; --accent: #f59e0b; --success: #10b981; --danger: #ef4444; --bg-dark: #0a0a0f; --bg-card: #12121a; --bg-card-hover: #1a1a25; --border: #2a2a3a; --text: #f0f0f5; --text-muted: #8888a0; --gradient-primary: linear-gradient(135deg, #ec4899 0%, #8b5cf6 100%); --gradient-gold: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%); }
        body { background-color: var(--bg-dark); background-image: radial-gradient(ellipse at top, rgba(236,72,153,0.1) 0%, transparent 50%); color: var(--text); font-family: 'Noto Sans KR', sans-serif; min-height: 100vh; }
        .navbar { background: var(--bg-card); border-bottom: 1px solid var(--border); padding: 12px 20px; position: sticky; top: 0; z-index: 100; }
        .nav-container { max-width: 900px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 24px; font-weight: 900; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; cursor: pointer; text-decoration: none; }
        .wallet-badge { background: var(--bg-dark); padding: 8px 16px; border-radius: 50px; border: 1px solid var(--border); color: var(--primary); font-weight: 700; font-size: 14px; }
        .container { max-width: 900px; margin: 0 auto; padding: 24px 20px; }
        .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 24px; margin-bottom: 20px; }
        button { cursor: pointer; border: none; border-radius: 10px; font-weight: 600; padding: 12px 20px; transition: all 0.2s; font-family: 'Noto Sans KR', sans-serif; font-size: 14px; }
        button:hover { transform: translateY(-1px); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: var(--gradient-primary); color: white; }
        .btn-gold { background: var(--gradient-gold); color: #1a1a2e; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .btn-block { width: 100%; }
        input, select { width: 100%; background: var(--bg-dark); border: 1px solid var(--border); color: var(--text); padding: 14px 16px; border-radius: 10px; font-size: 15px; font-family: 'Noto Sans KR', sans-serif; margin-bottom: 12px; }
        input:focus, select:focus { outline: none; border-color: var(--primary); }
        label { display: block; font-size: 13px; color: var(--text-muted); margin-bottom: 6px; }
        .back-btn { display: inline-flex; align-items: center; gap: 8px; color: var(--text-muted); text-decoration: none; font-size: 14px; margin-bottom: 20px; }
        .back-btn:hover { color: var(--text); }

        .guide-section { background: var(--bg-card); border: 1px solid var(--border); border-radius: 20px; padding: 24px; margin-bottom: 24px; position: relative; overflow: hidden; }
        .guide-section::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: var(--gradient-primary); }
        .guide-steps { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
        .guide-step { background: rgba(236,72,153,0.08); border: 1px solid rgba(236,72,153,0.2); padding: 16px 12px; border-radius: 12px; text-align: center; }
        .guide-step .step-num { font-size: 24px; margin-bottom: 8px; }
        .guide-step .step-title { font-weight: 700; font-size: 13px; color: var(--primary-light); margin-bottom: 4px; }
        .guide-step .step-desc { font-size: 11px; color: var(--text-muted); }

        .control-panel { background: var(--bg-card); border: 1px solid var(--border); padding: 24px; border-radius: 20px; margin-bottom: 24px; }
        .select-group { display: flex; gap: 12px; margin-bottom: 16px; }
        .price-info { background: rgba(236,72,153,0.08); border: 1px solid rgba(236,72,153,0.2); border-radius: 12px; padding: 16px; display: flex; justify-content: space-around; text-align: center; }
        .price-item .price-label { font-size: 12px; color: var(--text-muted); margin-bottom: 4px; }
        .price-item .price-value { font-size: 16px; font-weight: 700; color: var(--primary-light); }

        .region-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 24px; }
        .region-stat { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 20px; text-align: center; }
        .region-stat-value { font-size: 28px; font-weight: 900; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .region-stat-label { font-size: 12px; color: var(--text-muted); margin-top: 4px; }

        .conquest-status { background: var(--gradient-primary); padding: 20px; border-radius: 16px; margin-bottom: 24px; text-align: center; font-weight: 700; display: none; animation: popIn 0.5s ease; }
        @keyframes popIn { 0% { transform: scale(0.95); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        .map-container { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 20px; padding: 20px; }
        .land-block { aspect-ratio: 1/1; background: var(--bg-card-hover); border-radius: 12px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; border: 2px solid var(--border); transition: all 0.3s; position: relative; overflow: hidden; }
        .land-block:hover { transform: scale(1.08); border-color: var(--primary); z-index: 10; box-shadow: 0 8px 25px rgba(236,72,153,0.3); }
        .land-empty { border-style: dashed; opacity: 0.7; }
        .land-empty:hover { opacity: 1; border-style: solid; }
        .land-text { font-size: 12px; text-align: center; line-height: 1.3; word-break: break-all; padding: 4px; font-weight: 800; text-shadow: 0 2px 4px rgba(0,0,0,0.8); z-index: 2; }
        .land-sub { font-size: 10px; margin-top: 4px; color: rgba(255,255,255,0.85); font-weight: 600; z-index: 2; text-shadow: 0 1px 3px rgba(0,0,0,0.8); }
        .land-owner-badge { position: absolute; top: 4px; right: 4px; font-size: 12px; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 100; backdrop-filter: blur(8px); }
        .modal-content { background: var(--bg-card); padding: 32px; border-radius: 24px; width: 90%; max-width: 380px; border: 1px solid var(--border); position: relative; }
        .modal-content::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: var(--gradient-primary); border-radius: 24px 24px 0 0; }
        .modal-title { font-size: 22px; font-weight: 900; margin-bottom: 8px; text-align: center; }
        .modal-price { text-align: center; margin-bottom: 20px; }
        .modal-price span { background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 24px; font-weight: 900; }
        .value-hint { background: rgba(245,158,11,0.1); border: 1px solid rgba(245,158,11,0.3); color: #fbbf24; padding: 14px; border-radius: 12px; font-size: 13px; margin-bottom: 20px; text-align: center; }
        .modal-btn { width: 100%; padding: 16px; border-radius: 12px; font-weight: 700; cursor: pointer; border: none; margin-top: 8px; font-size: 16px; font-family: 'Noto Sans KR', sans-serif; }
        .btn-confirm { background: var(--gradient-primary); color: white; }
        .btn-cancel { background: var(--bg-card-hover); color: var(--text); border: 1px solid var(--border); }

        footer { margin-top: 60px; padding: 30px 0; border-top: 1px solid var(--border); text-align: center; color: var(--text-muted); font-size: 13px; }
        footer a { color: var(--text-muted); text-decoration: none; margin: 0 12px; }

        @media (max-width: 600px) { .guide-steps { grid-template-columns: repeat(2, 1fr); } .map-container { gap: 6px; padding: 12px; } .land-text { font-size: 10px; } .region-stats { grid-template-columns: 1fr; } .select-group { flex-direction: column; } }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="logo">BOKLUCK MARKET</a>
            <div class="wallet-badge" id="walletBadge">ğŸ’° ì—°ê²° í•„ìš”</div>
        </div>
    </nav>

    <div class="container">
        <a href="index.html" class="back-btn">â† ë©”ì¸ìœ¼ë¡œ</a>

        <div class="guide-section">
            <h4 style="margin-bottom: 20px; font-size: 18px;">ğŸ® ì´ìš© ê°€ì´ë“œ</h4>
            <div class="guide-steps">
                <div class="guide-step"><div class="step-num">1ï¸âƒ£</div><div class="step-title">ì§€ì—­ ì„ íƒ</div><div class="step-desc">êµ­ê°€ì™€ ë„ì‹œ ì„ íƒ</div></div>
                <div class="guide-step"><div class="step-num">2ï¸âƒ£</div><div class="step-title">ë¹ˆ ë•… í´ë¦­</div><div class="step-desc">ì ì„  = êµ¬ë§¤ ê°€ëŠ¥</div></div>
                <div class="guide-step"><div class="step-num">3ï¸âƒ£</div><div class="step-title">ì»¤ìŠ¤í…€</div><div class="step-desc">ì´ë¦„ & ìƒ‰ìƒ ì„¤ì •</div></div>
                <div class="guide-step"><div class="step-num">4ï¸âƒ£</div><div class="step-title">ëœë¤ ê°€ì¹˜</div><div class="step-desc">1~1,000 BOK!</div></div>
            </div>
        </div>

        <div id="conquestMessage" class="conquest-status">ğŸ‘‘ ì¶•í•˜í•©ë‹ˆë‹¤! ìµœëŒ€ ì†Œìœ ìì…ë‹ˆë‹¤!</div>

        <div class="control-panel">
            <h3 style="margin-bottom: 16px; font-size: 18px;">ğŸ—ºï¸ ì§€ì—­ ì„ íƒ</h3>
            <div class="select-group">
                <select id="countrySelect">
                    <option value="KR">ğŸ‡°ğŸ‡· í•œêµ­</option>
                    <option value="US">ğŸ‡ºğŸ‡¸ ë¯¸êµ­</option>
                    <option value="JP">ğŸ‡¯ğŸ‡µ ì¼ë³¸</option>
                    <option value="CN">ğŸ‡¨ğŸ‡³ ì¤‘êµ­</option>
                    <option value="DE">ğŸ‡©ğŸ‡ª ë…ì¼</option>
                    <option value="FR">ğŸ‡«ğŸ‡· í”„ë‘ìŠ¤</option>
                    <option value="GB">ğŸ‡¬ğŸ‡§ ì˜êµ­</option>
                </select>
                <select id="citySelect"></select>
            </div>
            <div class="price-info">
                <div class="price-item"><div class="price-label">êµ¬ë§¤ ê°€ê²©</div><div class="price-value">300 BOK</div></div>
                <div class="price-item"><div class="price-label">ëœë¤ ê°€ì¹˜</div><div class="price-value">1 ~ 1,000 BOK</div></div>
            </div>
        </div>

        <div class="region-stats">
            <div class="region-stat"><div class="region-stat-value" id="statSold">-</div><div class="region-stat-label">íŒë§¤ëœ ë•…</div></div>
            <div class="region-stat"><div class="region-stat-value" id="statAvailable">-</div><div class="region-stat-label">êµ¬ë§¤ ê°€ëŠ¥</div></div>
            <div class="region-stat"><div class="region-stat-value" id="statMyLands">-</div><div class="region-stat-label">ë‚´ ì†Œìœ </div></div>
        </div>

        <div id="landGrid" class="map-container"></div>
    </div>

    <div id="buyModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-title">ğŸ—ï¸ ë•… êµ¬ë§¤</div>
            <div class="modal-price"><span>300 BOK</span></div>
            <div class="value-hint">ğŸ° êµ¬ë§¤ ì‹œ 1~1,000 BOK ê°€ì¹˜ê°€ ëœë¤ ê²°ì •!</div>
            <label>ë•… ì´ë¦„ (ìµœëŒ€ 10ì)</label>
            <input type="text" id="inputName" placeholder="ì˜ˆ: ë¹„íŠ¸ì½”ì¸ íƒ€ì›Œ" maxlength="10">
            <label>ìƒ‰ìƒ ì„ íƒ</label>
            <input type="color" id="inputColor" value="#ec4899" style="height: 50px; padding: 5px;">
            <button id="confirmBuyBtn" class="modal-btn btn-confirm">êµ¬ë§¤ í™•ì •</button>
            <button id="cancelBuyBtn" class="modal-btn btn-cancel">ì·¨ì†Œ</button>
        </div>
    </div>

    <footer>
        <a href="index.html">ë©”ì¸ìœ¼ë¡œ</a>
        <p style="margin-top: 16px;">Â© 2024 BOKLUCK. ê°€ìƒ ë¶€ë™ì‚°ì˜ ê°€ì¹˜ëŠ” í”Œë«í¼ ë‚´ ì¬ë¯¸ ìš”ì†Œì…ë‹ˆë‹¤.</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, runTransaction, increment, query, where, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyBwQjuqgWM4YKnqu_gzNbeCg5alrC-jVcQ", authDomain: "myco-737a0.firebaseapp.com", projectId: "myco-737a0", storageBucket: "myco-737a0.firebasestorage.app", messagingSenderId: "942571332540", appId: "1:942571332540:web:be0bb6fbdd32655501c1b9" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUser = null, currentBalance = 0, userData = null;
        const LAND_PRICE = 300, TOTAL_LANDS = 25;
        
        const cities = {
            "KR": ["ì„œìš¸", "ë¶€ì‚°", "ì œì£¼", "ëŒ€ì „", "ê´‘ì£¼"],
            "US": ["ë‰´ìš•", "LA", "í…ì‚¬ìŠ¤", "ì‹œì¹´ê³ ", "ë§ˆì´ì• ë¯¸"],
            "JP": ["ë„ì¿„", "ì˜¤ì‚¬ì¹´", "êµí† ", "í›„ì¿ ì˜¤ì¹´"],
            "CN": ["ë² ì´ì§•", "ìƒí•˜ì´", "ê´‘ì €ìš°", "ì„ ì „"],
            "DE": ["ë² ë¥¼ë¦°", "ë®Œí—¨", "í•¨ë¶€ë¥´í¬"],
            "FR": ["íŒŒë¦¬", "ë§ˆë¥´ì„¸ìœ ", "ë¦¬ì˜¹"],
            "GB": ["ëŸ°ë˜", "ë§¨ì²´ìŠ¤í„°", "ë²„ë°ì—„"]
        };

        const countrySelect = document.getElementById("countrySelect");
        const citySelect = document.getElementById("citySelect");
        const grid = document.getElementById("landGrid");
        let selectedBlockIndex = null, selectedRegionKey = null;

        function updateRegionStats(soldCount, myCount) {
            document.getElementById("statSold").textContent = soldCount;
            document.getElementById("statAvailable").textContent = TOTAL_LANDS - soldCount;
            document.getElementById("statMyLands").textContent = myCount;
        }

        function openBuyModal(index, regionKey) {
            if(!currentUser) return alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            if(currentBalance < LAND_PRICE) return alert(`BOKì´ ë¶€ì¡±í•©ë‹ˆë‹¤!\ní˜„ì¬: ${currentBalance.toLocaleString()} BOK\ní•„ìš”: ${LAND_PRICE} BOK`);
            selectedBlockIndex = index;
            selectedRegionKey = regionKey;
            document.getElementById("inputName").value = "";
            document.getElementById("inputColor").value = "#ec4899";
            document.getElementById("buyModal").style.display = "flex";
            document.getElementById("inputName").focus();
        }

        document.getElementById("cancelBuyBtn").onclick = () => document.getElementById("buyModal").style.display = "none";
        document.addEventListener("keydown", (e) => { if(e.key === "Escape") document.getElementById("buyModal").style.display = "none"; });

        let unsubscribeMap = null;
        function loadMap() {
            const regionKey = `${countrySelect.value}-${citySelect.value}`;
            grid.innerHTML = "";
            for(let i = 0; i < TOTAL_LANDS; i++) {
                const div = document.createElement("div");
                div.className = "land-block land-empty";
                div.id = `block-${i}`;
                div.innerHTML = `<span class="land-text">ë¹ˆ ë•…</span><span class="land-sub">${LAND_PRICE} BOK</span>`;
                div.onclick = () => openBuyModal(i, regionKey);
                grid.appendChild(div);
            }

            if(unsubscribeMap) unsubscribeMap();
            const q = query(collection(db, "lands"), where("region", "==", regionKey));
            
            unsubscribeMap = onSnapshot(q, (snapshot) => {
                let myLandCount = 0, soldCount = 0;
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const el = document.getElementById(`block-${data.index}`);
                    if(!el) return;
                    soldCount++;
                    el.style.backgroundColor = data.color || "#ec4899";
                    el.style.borderColor = "rgba(255,255,255,0.2)";
                    el.style.borderStyle = "solid";
                    el.classList.remove("land-empty");
                    
                    const isMine = currentUser && data.ownerUid === currentUser.uid;
                    const ownerFlag = data.ownerCountry || '';
                    const valueText = data.randomValue ? `ğŸ’ ${data.randomValue}` : "?";
                    
                    if(isMine) {
                        el.innerHTML = `<span class="land-owner-badge">â­</span><span class="land-text">${data.customName}</span><span class="land-sub">${valueText}</span>`;
                        myLandCount++;
                    } else {
                        el.innerHTML = `<span class="land-owner-badge">${ownerFlag}</span><span class="land-text">${data.customName}</span><span class="land-sub">${data.ownerName}</span>`;
                    }
                    
                    const newEl = el.cloneNode(true);
                    newEl.onclick = () => alert(`ğŸ”’ ì†Œìœ  ì •ë³´\n\nğŸ“ ${data.customName}\nğŸ‘¤ ${ownerFlag} ${data.ownerName}\nğŸ’ ${data.randomValue || 0} BOK`);
                    el.parentNode.replaceChild(newEl, el);
                });
                updateRegionStats(soldCount, myLandCount);
                const statusBox = document.getElementById("conquestMessage");
                if(myLandCount >= 13) {
                    statusBox.style.display = "block";
                    statusBox.innerText = `ğŸ‘‘ [${citySelect.value}] ì§€ì—­ ì •ë³µ! (${myLandCount}/${TOTAL_LANDS})`;
                } else { statusBox.style.display = "none"; }
            });
        }

        function updateCityOptions() {
            const list = cities[countrySelect.value];
            citySelect.innerHTML = "";
            list.forEach(c => { const opt = document.createElement("option"); opt.value = c; opt.innerText = c; citySelect.appendChild(opt); });
            loadMap();
        }
        countrySelect.onchange = updateCityOptions;
        citySelect.onchange = loadMap;
        updateCityOptions();

        onAuthStateChanged(auth, (user) => {
            if(user) {
                currentUser = user;
                document.getElementById("walletBadge").innerText = "í™•ì¸ ì¤‘...";
                onSnapshot(doc(db, "users", user.uid), (d) => {
                    if(d.exists()) {
                        userData = d.data();
                        currentBalance = userData.coin || 0;
                        document.getElementById("walletBadge").innerText = `ğŸ’° ${currentBalance.toLocaleString()} BOK`;
                    }
                });
                loadMap();
            } else {
                document.getElementById("walletBadge").innerText = "ğŸ’° ë¡œê·¸ì¸ í•„ìš”";
                updateRegionStats(0, 0);
            }
        });

        document.getElementById("confirmBuyBtn").onclick = async () => {
            if(currentBalance < LAND_PRICE) return alert("BOK ë¶€ì¡±!");
            const name = document.getElementById("inputName").value.trim();
            const color = document.getElementById("inputColor").value;
            if(!name) return alert("ë•… ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");
            if(name.length > 10) return alert("10ì ì´ë‚´ë¡œ ì…ë ¥í•˜ì„¸ìš”.");

            const randomValue = Math.floor(Math.random() * 1000) + 1;
            const btn = document.getElementById("confirmBuyBtn");
            btn.innerText = "ì²˜ë¦¬ ì¤‘...";
            btn.disabled = true;

            try {
                await runTransaction(db, async (t) => {
                    const landRef = doc(db, "lands", `${selectedRegionKey}-${selectedBlockIndex}`);
                    const landDoc = await t.get(landRef);
                    if(landDoc.exists()) throw "ì´ë¯¸ íŒë§¤ëœ ë•…ì…ë‹ˆë‹¤!";
                    const userRef = doc(db, "users", currentUser.uid);
                    const userDoc = await t.get(userRef);
                    if(userDoc.data().coin < LAND_PRICE) throw "BOK ë¶€ì¡±!";
                    t.update(userRef, { coin: increment(-LAND_PRICE), totalSpent: increment(LAND_PRICE), landCount: increment(1) });
                    t.set(landRef, {
                        region: selectedRegionKey,
                        index: selectedBlockIndex,
                        ownerUid: currentUser.uid,
                        ownerName: currentUser.displayName,
                        ownerCountry: userData?.country || '',
                        customName: name,
                        color: color,
                        randomValue: randomValue,
                        purchasedAt: new Date().toISOString()
                    });
                });
                document.getElementById("buyModal").style.display = "none";
                let msg = `ğŸ‰ êµ¬ë§¤ ì„±ê³µ!\n\n`;
                if(randomValue >= 800) msg += `ğŸŒŸ ëŒ€ë°•!! ${randomValue} BOK ğŸ’ğŸ’ğŸ’`;
                else if(randomValue >= 500) msg += `ğŸ‘ ì¢‹ì•„ìš”! ${randomValue} BOK ğŸ’`;
                else if(randomValue >= 100) msg += `ğŸ˜Š ê´œì°®ë„¤ìš”! ${randomValue} BOK`;
                else msg += `ğŸ˜… ${randomValue} BOK - ë‹¤ìŒì—” ëŒ€ë°•!`;
                alert(msg);
            } catch(e) { alert("ì‹¤íŒ¨: " + e); }
            finally { btn.innerText = "êµ¬ë§¤ í™•ì •"; btn.disabled = false; }
        };
    </script>
</body>
</html>
