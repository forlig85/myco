<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOKLUCK REAL ESTATE</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;800&display=swap');
        
        body { background-color: #0f172a; color: #f8fafc; font-family: 'Pretendard', sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        
        /* í—¤ë” ìŠ¤íƒ€ì¼ */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #ec4899; padding-bottom: 15px; }
        .logo { font-size: 24px; font-weight: 800; color: #ec4899; cursor:pointer; }
        .wallet-info { font-weight: bold; color: #ec4899; font-size: 16px; }

        /* ë’¤ë¡œê°€ê¸° ë²„íŠ¼ */
        button.back-btn { background: #334155; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-bottom: 20px; transition: 0.2s; }
        button.back-btn:hover { background: #475569; }

        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        .control-panel { background: #1e293b; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #475569; }
        .select-group { display: flex; gap: 10px; margin-bottom: 15px; }
        select { background: #0f172a; color: white; border: 1px solid #64748b; padding: 10px; border-radius: 8px; flex: 1; font-size: 16px; font-family: 'Pretendard'; }
        
        /* ë§µ ê·¸ë¦¬ë“œ */
        .map-container { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
        .land-block { aspect-ratio: 1/1; background: #334155; border-radius: 4px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; border: 2px solid transparent; transition: 0.2s; position: relative; }
        .land-block:hover { transform: scale(1.05); border-color: #ec4899; z-index: 10; }
        
        /* ë•… ìƒíƒœë³„ ë””ìì¸ */
        .land-empty { opacity: 0.6; }
        .land-my { background: #0ea5e9; border-color: #38bdf8; color: white; box-shadow: 0 0 15px rgba(14, 165, 233, 0.4); }
        .land-others { background: #475569; color: #cbd5e1; border: 1px solid #64748b; }
        
        .land-text { font-size: 12px; text-align: center; line-height: 1.2; word-break: break-all; padding: 2px; font-weight: 600; }
        .land-sub { font-size: 10px; margin-top: 4px; opacity: 0.8; }

        /* ì ë ¹ ë©”ì‹œì§€ */
        .conquest-status { background: linear-gradient(90deg, #ec4899, #8b5cf6); padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; font-weight: bold; display: none; box-shadow: 0 4px 15px rgba(236, 72, 153, 0.4); animation: popIn 0.5s ease; }
        
        @keyframes popIn { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>

    <header>
        <div class="logo" onclick="location.href='index.html'">BOKLUCK MARKET</div>
        <div id="walletBadge" class="wallet-info">ì—°ë™ ì¤‘...</div>
    </header>

    <button class="back-btn" onclick="location.href='index.html'">â† ë©”ì¸í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>

    <div id="conquestMessage" class="conquest-status">
        ğŸ‘‘ ì¶•í•˜í•©ë‹ˆë‹¤! ë‹¹ì‹ ì€ ì´ ì§€ì—­ì˜ [ìµœëŒ€ ì†Œìœ ì]ì…ë‹ˆë‹¤! (13/25 ì ë ¹)
    </div>

    <div class="control-panel">
        <h3 style="margin-top:0;">ğŸ—ºï¸ ë¶€ë™ì‚° ì§€ì—­ ì„ íƒ</h3>
        <div class="select-group">
            <select id="countrySelect">
                <option value="KR">ğŸ‡°ğŸ‡· í•œêµ­ (Korea)</option>
                <option value="US">ğŸ‡ºğŸ‡¸ ë¯¸êµ­ (USA)</option>
                <option value="JP">ğŸ‡¯ğŸ‡µ ì¼ë³¸ (Japan)</option>
            </select>
            <select id="citySelect">
                </select>
        </div>
        <div style="font-size:14px; color:#94a3b8;">
            * ë¹ˆ ë•… ê°€ê²©: <b>300 BOK</b><br>
            * ìµœëŒ€ ì†Œìœ ì ì¡°ê±´: 25ê°œ ì¤‘ <b>13ê°œ ì´ìƒ</b> ì ë ¹ ì‹œ ë‹¬ì„±
        </div>
    </div>

    <div id="landGrid" class="map-container">
        </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, runTransaction, increment, query, where } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

        // ============================================================
        // ğŸš¨ ì‚¬ìš©ì(myco-737a0)ë‹˜ì˜ í‚¤ë¥¼ ì—¬ê¸°ì— ë„£ì—ˆìŠµë‹ˆë‹¤!
        // ============================================================
        const firebaseConfig = {
          apiKey: "AIzaSyBwQjuqgWM4YKnqu_gzNbeCg5alrC-jVcQ",
          authDomain: "myco-737a0.firebaseapp.com",
          projectId: "myco-737a0",
          storageBucket: "myco-737a0.firebasestorage.app",
          messagingSenderId: "942571332540",
          appId: "1:942571332540:web:be0bb6fbdd32655501c1b9"
        };
        // ============================================================

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUser = null;
        let currentBalance = 0;
        const LAND_PRICE = 300; // ë•… ê°€ê²©

        // ë„ì‹œ ëª©ë¡ ë°ì´í„°
        const cities = {
            "KR": ["ì„œìš¸ (Seoul)", "ë¶€ì‚° (Busan)", "ì œì£¼ (Jeju)"],
            "US": ["ë‰´ìš• (New York)", "LA (Los Angeles)", "í…ì‚¬ìŠ¤ (Texas)"],
            "JP": ["ë„ì¿„ (Tokyo)", "ì˜¤ì‚¬ì¹´ (Osaka)"]
        };

        // UI ìš”ì†Œ ì—°ê²°
        const countrySelect = document.getElementById("countrySelect");
        const citySelect = document.getElementById("citySelect");
        const grid = document.getElementById("landGrid");
        const walletBadge = document.getElementById("walletBadge");

        // 1. ë„ì‹œ ì„ íƒì°½ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateCityOptions() {
            const country = countrySelect.value;
            const cityList = cities[country];
            citySelect.innerHTML = "";
            cityList.forEach(c => {
                const opt = document.createElement("option");
                opt.value = c.split(' ')[0]; // "ì„œìš¸"ë§Œ ê°’ìœ¼ë¡œ ì‚¬ìš©
                opt.innerText = c;
                citySelect.appendChild(opt);
            });
            loadMap(); // ë„ì‹œ ë°”ë€Œë©´ ë§µ ìƒˆë¡œê³ ì¹¨
        }
        countrySelect.addEventListener("change", updateCityOptions);
        citySelect.addEventListener("change", loadMap);
        updateCityOptions(); // ì´ˆê¸° ì‹¤í–‰

        // 2. ë¡œê·¸ì¸ ìƒíƒœ ê°ì§€ (ì—¬ê¸°ì„œ ì”ì•¡ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤)
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                // ì‚¬ìš©ì DB ì‹¤ì‹œê°„ ê°ì‹œ (ì”ì•¡ ë³€ë™ ì‹œ ì¦‰ì‹œ ë°˜ì˜)
                onSnapshot(doc(db, "users", user.uid), (d) => {
                    if (d.exists()) {
                        currentBalance = d.data().coin;
                        walletBadge.innerText = `ğŸ’° ìì‚°: ${currentBalance.toLocaleString()} BOK`;
                    } else {
                        // DBì— ìœ ì € ì •ë³´ê°€ ì—†ìœ¼ë©´ 0ì›ìœ¼ë¡œ í‘œì‹œ
                        currentBalance = 0;
                        walletBadge.innerText = `ğŸ’° ìì‚°: 0 BOK`;
                    }
                });
            } else {
                alert("ë¡œê·¸ì¸ì´ í’€ë ¸ìŠµë‹ˆë‹¤. ë©”ì¸ í™”ë©´ì—ì„œ ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
                location.href = 'index.html';
            }
        });

        // 3. ë§µ ë¡œë”© ë¡œì§ (ë¶€ë™ì‚° í˜„í™©íŒ)
        let unsubscribeMap = null;
        function loadMap() {
            const country = countrySelect.value;
            const city = citySelect.value;
            const regionKey = `${country}-${city}`; // ì˜ˆ: KR-ì„œìš¸

            // 1ë‹¨ê³„: ë¹ˆ ë•… 25ê°œ ê¹”ê¸°
            grid.innerHTML = "";
            for(let i=0; i<25; i++) {
                const div = document.createElement("div");
                div.className = "land-block land-empty";
                div.id = `block-${i}`;
                div.innerHTML = `
                    <span class="land-text">ë¹ˆ ë•…</span>
                    <span class="land-sub">${LAND_PRICE} BOK</span>
                `;
                div.onclick = () => buyLand(i, regionKey);
                grid.appendChild(div);
            }

            // 2ë‹¨ê³„: íŒ”ë¦° ë•… ë°ì´í„° ë¶ˆëŸ¬ì™€ì„œ ë®ì–´ì”Œìš°ê¸°
            if(unsubscribeMap) unsubscribeMap();
            const q = query(collection(db, "lands"), where("region", "==", regionKey));
            
            unsubscribeMap = onSnapshot(q, (snapshot) => {
                let myLandCount = 0;

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const idx = data.index;
                    const el = document.getElementById(`block-${idx}`);
                    
                    if(!el) return; // ì—ëŸ¬ ë°©ì§€

                    if(currentUser && data.ownerUid === currentUser.uid) {
                        // ë‚´ ë•…ì¼ ë•Œ
                        el.className = "land-block land-my";
                        el.innerHTML = `
                            <span class="land-text">${data.customName}</span>
                            <span class="land-sub">ì†Œìœ  ì¤‘</span>
                        `;
                        myLandCount++;
                    } else {
                        // ë‚¨ì˜ ë•…ì¼ ë•Œ
                        el.className = "land-block land-others";
                        el.innerHTML = `
                            <span class="land-text">${data.customName}</span>
                            <span class="land-sub">${data.ownerName}</span>
                        `;
                    }
                    // ì´ë¯¸ íŒ”ë¦° ë•… í´ë¦­ ì‹œ ì •ë³´ í‘œì‹œ
                    el.onclick = () => alert(`ğŸ”’ [ì†Œìœ ì ì •ë³´]\n\nì´ë¦„: ${data.ownerName}\në•… ì´ë¦„: ${data.customName}\nêµ¬ë§¤ì¼: ${new Date(data.purchasedAt).toLocaleDateString()}`);
                });

                // 3ë‹¨ê³„: ì ë ¹ ë©”ì‹œì§€ í‘œì‹œ (13ê°œ ì´ìƒ)
                const statusBox = document.getElementById("conquestMessage");
                if(myLandCount >= 13) {
                    statusBox.style.display = "block";
                    statusBox.innerText = `ğŸ‘‘ ì¶•í•˜í•©ë‹ˆë‹¤! ë‹¹ì‹ ì€ [${city}] ì§€ì—­ì˜ ìµœëŒ€ ì†Œìœ ìì…ë‹ˆë‹¤! (${myLandCount}/25)`;
                } else {
                    statusBox.style.display = "none";
                }
            });
        }

        // 4. ë•… êµ¬ë§¤ ë¡œì§ (Transactionìœ¼ë¡œ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬)
        async function buyLand(index, regionKey) {
            if(!currentUser) return alert("ì§€ê°‘ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...");
            if(currentBalance < LAND_PRICE) return alert(`ìì‚°ì´ ë¶€ì¡±í•©ë‹ˆë‹¤!\n\ní•„ìš”: ${LAND_PRICE} BOK\në³´ìœ : ${currentBalance} BOK`);

            if(!confirm(`[${regionKey}] ${index+1}ë²ˆ ë•…ì„ êµ¬ë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            const name = prompt("ì´ ë•…ì˜ ì´ë¦„ì„ ì§€ì–´ì£¼ì„¸ìš”! (ì˜ˆ: ê°•ë‚¨ ë³¸ì )");
            if(!name) return;

            try {
                await runTransaction(db, async (t) => {
                    const landId = `${regionKey}-${index}`;
                    const landRef = doc(db, "lands", landId);
                    const landDoc = await t.get(landRef);
                    
                    if(landDoc.exists()) throw "ì•—! ê·¸ ì‚¬ì´ì— ë‹¤ë¥¸ ì‚¬ëŒì´ êµ¬ë§¤í–ˆìŠµë‹ˆë‹¤.";
                    
                    const userRef = doc(db, "users", currentUser.uid);
                    const userDoc = await t.get(userRef);
                    if(userDoc.data().coin < LAND_PRICE) throw "ìì‚°ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.";

                    // ëˆ ì°¨ê°
                    t.update(userRef, { coin: increment(-LAND_PRICE) });
                    
                    // ë•… ë“±ê¸°
                    t.set(landRef, {
                        region: regionKey,
                        index: index,
                        ownerUid: currentUser.uid,
                        ownerName: currentUser.displayName,
                        customName: name,
                        purchasedAt: new Date().toISOString()
                    });
                });
                alert("ğŸ‰ êµ¬ë§¤ ì„±ê³µ! ì˜í† ê°€ í™•ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            } catch(e) {
                alert("êµ¬ë§¤ ì‹¤íŒ¨: " + e);
            }
        }
    </script>
</body>
</html>
