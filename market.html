<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOKLUCK REAL ESTATE</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;800&display=swap');
        
        body { background-color: #0f172a; color: #f8fafc; font-family: 'Pretendard', sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        
        /* í—¤ë” */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #ec4899; padding-bottom: 15px; }
        .logo { font-size: 24px; font-weight: 800; color: #ec4899; cursor:pointer; }
        
        /* ì§€ê°‘ ì •ë³´ */
        .wallet-wrapper { display: flex; align-items: center; gap: 10px; }
        .wallet-info { font-weight: bold; color: #ec4899; font-size: 16px; }
        .btn-connect { background: #ec4899; color: white; border: none; padding: 8px 12px; border-radius: 20px; font-weight: bold; cursor: pointer; display: none; }
        
        /* ë’¤ë¡œê°€ê¸° */
        button.back-btn { background: #334155; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-bottom: 20px; transition: 0.2s; }
        button.back-btn:hover { background: #475569; }

        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        .control-panel { background: #1e293b; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #475569; }
        .select-group { display: flex; gap: 10px; margin-bottom: 15px; }
        select { background: #0f172a; color: white; border: 1px solid #64748b; padding: 10px; border-radius: 8px; flex: 1; font-size: 16px; font-family: 'Pretendard'; }
        
        /* ğŸ—ºï¸ ë§µ ê·¸ë¦¬ë“œ */
        .map-container { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
        .land-block { aspect-ratio: 1/1; background: #334155; border-radius: 8px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; border: 2px solid transparent; transition: 0.2s; position: relative; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .land-block:hover { transform: scale(1.05); border-color: white; z-index: 10; }
        
        .land-empty { opacity: 0.6; border: 1px dashed #64748b; }
        .land-text { font-size: 13px; text-align: center; line-height: 1.2; word-break: break-all; padding: 4px; font-weight: 800; text-shadow: 0 1px 2px rgba(0,0,0,0.8); z-index: 2; }
        .land-sub { font-size: 11px; margin-top: 4px; color: rgba(255,255,255,0.9); font-weight: 600; z-index: 2; text-shadow: 0 1px 2px rgba(0,0,0,0.8); }

        /* ì ë ¹ ë©”ì‹œì§€ */
        .conquest-status { background: linear-gradient(90deg, #ec4899, #8b5cf6); padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; font-weight: bold; display: none; animation: popIn 0.5s ease; }
        @keyframes popIn { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        /* âœ¨ êµ¬ë§¤ ëª¨ë‹¬ì°½ ìŠ¤íƒ€ì¼ */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 100; backdrop-filter: blur(5px); }
        .modal-content { background: #1e293b; padding: 30px; border-radius: 16px; width: 90%; max-width: 350px; border: 1px solid #ec4899; box-shadow: 0 0 20px rgba(236, 72, 153, 0.3); text-align: center; }
        .modal-title { font-size: 20px; font-weight: bold; margin-bottom: 20px; color: #fff; }
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { display: block; font-size: 12px; color: #94a3b8; margin-bottom: 5px; }
        .modal-input { width: 100%; padding: 10px; background: #0f172a; border: 1px solid #475569; border-radius: 6px; color: white; box-sizing: border-box; }
        .color-picker { width: 100%; height: 40px; cursor: pointer; border: none; border-radius: 6px; }
        
        .modal-btn { width: 100%; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; border: none; margin-top: 10px; font-size: 16px; }
        .btn-confirm { background: #ec4899; color: white; }
        .btn-confirm:hover { background: #db2777; }
        .btn-cancel { background: #334155; color: white; margin-top: 10px; }
        
    </style>
</head>
<body>

    <header>
        <div class="logo" onclick="location.href='index.html'">BOKLUCK MARKET</div>
        <div class="wallet-wrapper">
            <button id="manualLoginBtn" class="btn-connect">ğŸ”‘ ì§€ê°‘ ì—°ê²°í•˜ê¸°</button>
            <div id="walletBadge" class="wallet-info">ì—°ê²° ì¤‘...</div>
        </div>
    </header>

    <button class="back-btn" onclick="location.href='index.html'">â† ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>

    <div id="conquestMessage" class="conquest-status">
        ğŸ‘‘ ì¶•í•˜í•©ë‹ˆë‹¤! ë‹¹ì‹ ì€ ì´ ì§€ì—­ì˜ [ìµœëŒ€ ì†Œìœ ì]ì…ë‹ˆë‹¤! (13/25 ì ë ¹)
    </div>

    <div class="control-panel">
        <h3 style="margin-top:0;">ğŸ—ºï¸ ë¶€ë™ì‚° ì§€ì—­ ì„ íƒ</h3>
        <div class="select-group">
            <select id="countrySelect">
                <option value="KR">ğŸ‡°ğŸ‡· í•œêµ­</option>
                <option value="US">ğŸ‡ºğŸ‡¸ ë¯¸êµ­</option>
                <option value="JP">ğŸ‡¯ğŸ‡µ ì¼ë³¸</option>
            </select>
            <select id="citySelect"></select>
        </div>
        <div style="font-size:14px; color:#94a3b8;">
            * êµ¬ë§¤ ê°€ê²©: <b>300 BOK</b> (ê³ ì •)<br>
            * ğŸ² <b>ëœë¤ ê°€ì¹˜:</b> êµ¬ë§¤ ì‹œ 1~1,000 BOK ì‚¬ì´ì˜ ê°€ì¹˜ê°€ ë§¤ê²¨ì§‘ë‹ˆë‹¤!
        </div>
    </div>

    <div id="landGrid" class="map-container"></div>

    <div id="buyModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-title">ğŸ—ï¸ ë•… êµ¬ë§¤í•˜ê¸°</div>
            <p style="color:#ec4899; font-weight:bold; font-size:18px; margin-bottom:20px;">ê°€ê²©: 300 BOK</p>
            
            <div class="input-group">
                <label>ë•… ì´ë¦„</label>
                <input type="text" id="inputName" class="modal-input" placeholder="ì˜ˆ: ë¹„íŠ¸ì½”ì¸ íƒ€ì›Œ">
            </div>
            
            <div class="input-group">
                <label>ë‚´ ë•… ìƒ‰ìƒ ì„ íƒ</label>
                <input type="color" id="inputColor" class="color-picker" value="#0ea5e9">
            </div>

            <button id="confirmBuyBtn" class="modal-btn btn-confirm">êµ¬ë§¤ í™•ì •</button>
            <button onclick="closeModal()" class="modal-btn btn-cancel">ì·¨ì†Œ</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, runTransaction, increment, query, where } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBwQjuqgWM4YKnqu_gzNbeCg5alrC-jVcQ",
          authDomain: "myco-737a0.firebaseapp.com",
          projectId: "myco-737a0",
          storageBucket: "myco-737a0.firebasestorage.app",
          messagingSenderId: "942571332540",
          appId: "1:942571332540:web:be0bb6fbdd32655501c1b9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUser = null;
        let currentBalance = 0;
        const LAND_PRICE = 300;
        
        // ë„ì‹œ ë°ì´í„°
        const cities = {
            "KR": ["ì„œìš¸", "ë¶€ì‚°", "ì œì£¼"],
            "US": ["ë‰´ìš•", "LA", "í…ì‚¬ìŠ¤"],
            "JP": ["ë„ì¿„", "ì˜¤ì‚¬ì¹´"]
        };

        const countrySelect = document.getElementById("countrySelect");
        const citySelect = document.getElementById("citySelect");
        const grid = document.getElementById("landGrid");
        const walletBadge = document.getElementById("walletBadge");
        const manualLoginBtn = document.getElementById("manualLoginBtn");
        
        // ëª¨ë‹¬ ê´€ë ¨ ìš”ì†Œ
        const buyModal = document.getElementById("buyModal");
        const inputName = document.getElementById("inputName");
        const inputColor = document.getElementById("inputColor");
        let selectedBlockIndex = null;
        let selectedRegionKey = null;

        // --- ë¡œê·¸ì¸ ë° ì´ˆê¸°í™” ---
        manualLoginBtn.addEventListener("click", () => {
            signInWithPopup(auth, new GoogleAuthProvider()).catch(err => alert("ì—°ê²° ì‹¤íŒ¨: " + err.message));
        });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                manualLoginBtn.style.display = "none";
                walletBadge.innerText = "ìì‚° í™•ì¸ ì¤‘...";
                onSnapshot(doc(db, "users", user.uid), (d) => {
                    if (d.exists()) {
                        currentBalance = d.data().coin;
                        walletBadge.innerText = `ğŸ’° ìì‚°: ${currentBalance.toLocaleString()} BOK`;
                    } else {
                        currentBalance = 0;
                        walletBadge.innerText = `ğŸ’° ìì‚°: 0 BOK`;
                    }
                });
            } else {
                currentUser = null;
                walletBadge.innerText = "ì—°ê²° í•„ìš”";
                manualLoginBtn.style.display = "block";
            }
        });

        // --- ë§µ ë¡œì§ ---
        function updateCityOptions() {
            const list = cities[countrySelect.value];
            citySelect.innerHTML = "";
            list.forEach(c => {
                const opt = document.createElement("option");
                opt.value = c.split(' ')[0]; opt.innerText = c;
                citySelect.appendChild(opt);
            });
            loadMap(); 
        }
        countrySelect.addEventListener("change", updateCityOptions);
        citySelect.addEventListener("change", loadMap);
        updateCityOptions(); 

        let unsubscribeMap = null;
        function loadMap() {
            const regionKey = `${countrySelect.value}-${citySelect.value}`; 
            
            // ê·¸ë¦¬ë“œ ì´ˆê¸°í™” (ë¹ˆ ë•… 25ê°œ)
            grid.innerHTML = "";
            for(let i=0; i<25; i++) {
                const div = document.createElement("div");
                div.className = "land-block land-empty";
                div.id = `block-${i}`;
                div.innerHTML = `<span class="land-text">ë¹ˆ ë•…</span><span class="land-sub">${LAND_PRICE} BOK</span>`;
                div.onclick = () => openBuyModal(i, regionKey); // ëª¨ë‹¬ ì—´ê¸°
                grid.appendChild(div);
            }

            if(unsubscribeMap) unsubscribeMap();
            const q = query(collection(db, "lands"), where("region", "==", regionKey));
            
            unsubscribeMap = onSnapshot(q, (snapshot) => {
                let myLandCount = 0;
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const el = document.getElementById(`block-${data.index}`);
                    if(!el) return;

                    // ë•… ìŠ¤íƒ€ì¼ ì ìš© (ìƒ‰ìƒ í¬í•¨)
                    el.style.backgroundColor = data.color || "#334155"; // ì‚¬ìš©ì ì§€ì • ìƒ‰ìƒ
                    el.style.border = "1px solid rgba(255,255,255,0.2)";
                    el.classList.remove("land-empty");

                    // í…ìŠ¤íŠ¸ í‘œì‹œ
                    const valueText = data.randomValue ? `ğŸ’ ê°€ì¹˜: ${data.randomValue}` : "í‰ê°€ ì¤‘";
                    
                    if(currentUser && data.ownerUid === currentUser.uid) {
                        el.innerHTML = `<span class="land-text" style="color:#fff;">${data.customName}</span><span class="land-sub" style="color:#fff;">${valueText}</span>`;
                        myLandCount++;
                    } else {
                        el.innerHTML = `<span class="land-text" style="color:#fff;">${data.customName}</span><span class="land-sub" style="color:#ddd;">${data.ownerName}</span>`;
                    }

                    // ì´ë¯¸ íŒ”ë¦° ë•… í´ë¦­ ì‹œ
                    el.onclick = () => alert(`ğŸ”’ [ì†Œìœ  ì •ë³´]\n\nì´ë¦„: ${data.customName}\nì†Œìœ ì: ${data.ownerName}\nê°ì •ê°€: ${data.randomValue || 0} BOK`);
                });

                // ì ë ¹ ë©”ì‹œì§€
                const statusBox = document.getElementById("conquestMessage");
                if(myLandCount >= 13) {
                    statusBox.style.display = "block";
                    statusBox.innerText = `ğŸ‘‘ ì¶•í•˜í•©ë‹ˆë‹¤! [${citySelect.value}] ì§€ì—­ì˜ ìµœëŒ€ ì†Œìœ ìì…ë‹ˆë‹¤! (${myLandCount}/25)`;
                } else {
                    statusBox.style.display = "none";
                }
            });
        }

        // --- ëª¨ë‹¬ & êµ¬ë§¤ ë¡œì§ ---
        
        // 1. ì „ì—­ í•¨ìˆ˜ë¡œ ë“±ë¡ (HTML onclickì—ì„œ ë¶€ë¥´ê¸° ìœ„í•´)
        window.openBuyModal = (index, regionKey) => {
            if(!currentUser) return alert("ì§€ê°‘ ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            selectedBlockIndex = index;
            selectedRegionKey = regionKey;
            
            inputName.value = "";
            inputColor.value = "#0ea5e9"; // ê¸°ë³¸ íŒŒë‘
            buyModal.style.display = "flex";
        }

        window.closeModal = () => {
            buyModal.style.display = "none";
        }

        // 2. êµ¬ë§¤ í™•ì • ë²„íŠ¼ í´ë¦­
        document.getElementById("confirmBuyBtn").addEventListener("click", async () => {
            if(currentBalance < LAND_PRICE) return alert(`ìì‚° ë¶€ì¡±! (${currentBalance} BOK ë³´ìœ )`);
            const name = inputName.value.trim();
            const color = inputColor.value;
            
            if(!name) return alert("ë•… ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            // ğŸ² ëœë¤ ê°€ì¹˜ ìƒì„± (1 ~ 1000)
            const randomValue = Math.floor(Math.random() * 1000) + 1;

            const btn = document.getElementById("confirmBuyBtn");
            btn.innerText = "ì²˜ë¦¬ ì¤‘...";
            btn.disabled = true;

            try {
                await runTransaction(db, async (t) => {
                    const landRef = doc(db, "lands", `${selectedRegionKey}-${selectedBlockIndex}`);
                    const landDoc = await t.get(landRef);
                    if(landDoc.exists()) throw "ì´ë¯¸ íŒë§¤ëœ ë•…ì…ë‹ˆë‹¤.";
                    
                    const userRef = doc(db, "users", currentUser.uid);
                    t.update(userRef, { coin: increment(-LAND_PRICE) });
                    
                    t.set(landRef, {
                        region: selectedRegionKey,
                        index: selectedBlockIndex,
                        ownerUid: currentUser.uid,
                        ownerName: currentUser.displayName,
                        customName: name,
                        color: color,           // ğŸ¨ ìƒ‰ìƒ ì €ì¥
                        randomValue: randomValue, // ğŸ’ ëœë¤ ê°€ì¹˜ ì €ì¥
                        purchasedAt: new Date().toISOString()
                    });
                });
                
                closeModal();
                alert(`ğŸ‰ êµ¬ë§¤ ì„±ê³µ!\n\nì´ ë•…ì˜ ê°ì •ê°€ëŠ” [ ${randomValue} BOK ] ìœ¼ë¡œ ì±…ì •ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                
            } catch(e) {
                alert("êµ¬ë§¤ ì‹¤íŒ¨: " + e);
            } finally {
                btn.innerText = "êµ¬ë§¤ í™•ì •";
                btn.disabled = false;
            }
        });

    </script>
</body>
</html>
